{
    "sourceFile": "scripts/verify-unified-config.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 8,
            "patches": [
                {
                    "date": 1752548238913,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752548252338,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -19,9 +19,9 @@\n   {\n     pattern: /['\"\\/]system_stats['\",\\]]/g,\n     description: '硬编码的 /system_stats 端点',\n     severity: 'high',\n-    allowedFiles: ['docs/', 'test-', '.md']\n+    allowedFiles: ['docs/', 'test-', '.md', 'comfyui.config.js']\n   },\n   {\n     pattern: /['\"\\/]object_info['\",\\]]/g,\n     description: '硬编码的 /object_info 端点',\n"
                },
                {
                    "date": 1752548263494,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -25,9 +25,9 @@\n   {\n     pattern: /['\"\\/]object_info['\",\\]]/g,\n     description: '硬编码的 /object_info 端点',\n     severity: 'medium',\n-    allowedFiles: ['docs/', 'test-', '.md']\n+    allowedFiles: ['docs/', 'test-', '.md', 'comfyui.config.js']\n   },\n   {\n     pattern: /['\"\\/]prompt['\",\\]]/g,\n     description: '硬编码的 /prompt 端点',\n"
                },
                {
                    "date": 1752548276687,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -31,9 +31,9 @@\n   {\n     pattern: /['\"\\/]prompt['\",\\]]/g,\n     description: '硬编码的 /prompt 端点',\n     severity: 'medium',\n-    allowedFiles: ['docs/', 'test-', '.md']\n+    allowedFiles: ['docs/', 'test-', '.md', 'comfyui.config.js']\n   },\n   {\n     pattern: /['\"\\/]history['\",\\]]/g,\n     description: '硬编码的 /history 端点',\n"
                },
                {
                    "date": 1752548292463,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -37,9 +37,9 @@\n   {\n     pattern: /['\"\\/]history['\",\\]]/g,\n     description: '硬编码的 /history 端点',\n     severity: 'medium',\n-    allowedFiles: ['docs/', 'test-', '.md']\n+    allowedFiles: ['docs/', 'test-', '.md', 'comfyui.config.js']\n   },\n   {\n     pattern: /testEndpoints\\s*=\\s*\\[/g,\n     description: '可能的硬编码端点数组定义',\n"
                },
                {
                    "date": 1752548316511,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -13,9 +13,9 @@\n   {\n     pattern: /['\"\\/]queue['\",\\]]/g,\n     description: '硬编码的 /queue 端点',\n     severity: 'high',\n-    allowedFiles: ['docs/', 'test-', '.md', 'comfyui.config.js'] // 允许在配置文件、文档和测试文件中出现\n+    allowedFiles: ['docs/', 'test-', '.md', 'comfyui.config.js', 'routes/config.js', 'routes/admin.js'] // 允许在配置文件、文档和测试文件中出现\n   },\n   {\n     pattern: /['\"\\/]system_stats['\",\\]]/g,\n     description: '硬编码的 /system_stats 端点',\n"
                },
                {
                    "date": 1752548329463,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -19,9 +19,9 @@\n   {\n     pattern: /['\"\\/]system_stats['\",\\]]/g,\n     description: '硬编码的 /system_stats 端点',\n     severity: 'high',\n-    allowedFiles: ['docs/', 'test-', '.md', 'comfyui.config.js']\n+    allowedFiles: ['docs/', 'test-', '.md', 'comfyui.config.js', 'routes/config.js', 'routes/admin.js']\n   },\n   {\n     pattern: /['\"\\/]object_info['\",\\]]/g,\n     description: '硬编码的 /object_info 端点',\n"
                },
                {
                    "date": 1752548343203,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -43,9 +43,9 @@\n   {\n     pattern: /testEndpoints\\s*=\\s*\\[/g,\n     description: '可能的硬编码端点数组定义',\n     severity: 'medium',\n-    allowedFiles: ['test-', '.md', 'config.js']\n+    allowedFiles: ['test-', '.md', 'config.js', 'routes/config.js', 'routes/admin.js']\n   }\n ];\n \n // 需要检查的文件扩展名\n"
                },
                {
                    "date": 1752548378636,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -76,9 +76,10 @@\n   /**\n    * 检查文件是否在允许列表中\n    */\n   isFileAllowed(filePath, allowedFiles) {\n-    return allowedFiles.some(allowed => filePath.includes(allowed));\n+    const normalizedPath = filePath.replace(/\\\\/g, '/');\n+    return allowedFiles.some(allowed => normalizedPath.includes(allowed));\n   }\n \n   /**\n    * 检查单个文件\n"
                }
            ],
            "date": 1752548238913,
            "name": "Commit-0",
            "content": "#!/usr/bin/env node\n\n/**\n * 验证ComfyUI端点配置统一性\n * 检查是否还有硬编码的端点配置\n */\n\nconst fs = require('fs');\nconst path = require('path');\n\n// 需要检查的硬编码端点模式\nconst HARDCODED_ENDPOINT_PATTERNS = [\n  {\n    pattern: /['\"\\/]queue['\",\\]]/g,\n    description: '硬编码的 /queue 端点',\n    severity: 'high',\n    allowedFiles: ['docs/', 'test-', '.md', 'comfyui.config.js'] // 允许在配置文件、文档和测试文件中出现\n  },\n  {\n    pattern: /['\"\\/]system_stats['\",\\]]/g,\n    description: '硬编码的 /system_stats 端点',\n    severity: 'high',\n    allowedFiles: ['docs/', 'test-', '.md']\n  },\n  {\n    pattern: /['\"\\/]object_info['\",\\]]/g,\n    description: '硬编码的 /object_info 端点',\n    severity: 'medium',\n    allowedFiles: ['docs/', 'test-', '.md']\n  },\n  {\n    pattern: /['\"\\/]prompt['\",\\]]/g,\n    description: '硬编码的 /prompt 端点',\n    severity: 'medium',\n    allowedFiles: ['docs/', 'test-', '.md']\n  },\n  {\n    pattern: /['\"\\/]history['\",\\]]/g,\n    description: '硬编码的 /history 端点',\n    severity: 'medium',\n    allowedFiles: ['docs/', 'test-', '.md']\n  },\n  {\n    pattern: /testEndpoints\\s*=\\s*\\[/g,\n    description: '可能的硬编码端点数组定义',\n    severity: 'medium',\n    allowedFiles: ['test-', '.md', 'config.js']\n  }\n];\n\n// 需要检查的文件扩展名\nconst FILE_EXTENSIONS = ['.js', '.ts', '.jsx', '.tsx', '.vue'];\n\n// 排除的目录\nconst EXCLUDED_DIRS = ['node_modules', '.git', 'dist', 'build', '.lh'];\n\nclass ConfigVerifier {\n  constructor() {\n    this.issues = [];\n    this.checkedFiles = 0;\n  }\n\n  /**\n   * 检查文件是否应该被排除\n   */\n  shouldExcludeFile(filePath) {\n    // 检查是否在排除目录中\n    for (const excludedDir of EXCLUDED_DIRS) {\n      if (filePath.includes(excludedDir)) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  /**\n   * 检查文件是否在允许列表中\n   */\n  isFileAllowed(filePath, allowedFiles) {\n    return allowedFiles.some(allowed => filePath.includes(allowed));\n  }\n\n  /**\n   * 检查单个文件\n   */\n  checkFile(filePath) {\n    if (this.shouldExcludeFile(filePath)) {\n      return;\n    }\n\n    try {\n      const content = fs.readFileSync(filePath, 'utf8');\n      this.checkedFiles++;\n\n      for (const { pattern, description, severity, allowedFiles } of HARDCODED_ENDPOINT_PATTERNS) {\n        const matches = content.match(pattern);\n        if (matches) {\n          // 检查是否在允许列表中\n          if (this.isFileAllowed(filePath, allowedFiles)) {\n            continue;\n          }\n\n          this.issues.push({\n            file: filePath,\n            pattern: pattern.source,\n            description,\n            severity,\n            matches: matches.length,\n            lines: this.getMatchingLines(content, pattern)\n          });\n        }\n      }\n    } catch (error) {\n      console.warn(`⚠️ 无法读取文件: ${filePath} - ${error.message}`);\n    }\n  }\n\n  /**\n   * 获取匹配的行号\n   */\n  getMatchingLines(content, pattern) {\n    const lines = content.split('\\n');\n    const matchingLines = [];\n\n    lines.forEach((line, index) => {\n      if (pattern.test(line)) {\n        matchingLines.push({\n          number: index + 1,\n          content: line.trim()\n        });\n      }\n    });\n\n    return matchingLines;\n  }\n\n  /**\n   * 递归检查目录\n   */\n  checkDirectory(dirPath) {\n    try {\n      const items = fs.readdirSync(dirPath);\n\n      for (const item of items) {\n        const itemPath = path.join(dirPath, item);\n        const stat = fs.statSync(itemPath);\n\n        if (stat.isDirectory()) {\n          this.checkDirectory(itemPath);\n        } else if (stat.isFile()) {\n          const ext = path.extname(itemPath);\n          if (FILE_EXTENSIONS.includes(ext)) {\n            this.checkFile(itemPath);\n          }\n        }\n      }\n    } catch (error) {\n      console.warn(`⚠️ 无法读取目录: ${dirPath} - ${error.message}`);\n    }\n  }\n\n  /**\n   * 运行验证\n   */\n  verify() {\n    console.log('🔍 开始验证ComfyUI端点配置统一性...');\n    console.log('=' .repeat(60));\n\n    const startTime = Date.now();\n\n    // 检查主要目录\n    const dirsToCheck = ['client/src', 'server/src', 'admin/src'];\n\n    for (const dir of dirsToCheck) {\n      if (fs.existsSync(dir)) {\n        console.log(`📁 检查目录: ${dir}`);\n        this.checkDirectory(dir);\n      }\n    }\n\n    const endTime = Date.now();\n\n    console.log('\\n📊 检查结果:');\n    console.log('=' .repeat(40));\n    console.log(`   检查文件数: ${this.checkedFiles}`);\n    console.log(`   发现问题数: ${this.issues.length}`);\n    console.log(`   耗时: ${endTime - startTime}ms`);\n\n    if (this.issues.length === 0) {\n      console.log('\\n✅ 恭喜！所有ComfyUI端点配置已统一，未发现硬编码问题。');\n      return true;\n    } else {\n      console.log('\\n❌ 发现硬编码端点配置问题:');\n      this.reportIssues();\n      return false;\n    }\n  }\n\n  /**\n   * 报告问题\n   */\n  reportIssues() {\n    const groupedIssues = this.groupIssuesBySeverity();\n\n    for (const [severity, issues] of Object.entries(groupedIssues)) {\n      console.log(`\\n🚨 ${severity.toUpperCase()} 级别问题 (${issues.length}个):`);\n      console.log('-' .repeat(50));\n\n      for (const issue of issues) {\n        console.log(`📄 文件: ${issue.file}`);\n        console.log(`🔍 问题: ${issue.description}`);\n        console.log(`📊 匹配数: ${issue.matches}`);\n\n        if (issue.lines.length > 0) {\n          console.log('📍 位置:');\n          issue.lines.forEach(line => {\n            console.log(`   第${line.number}行: ${line.content}`);\n          });\n        }\n        console.log('');\n      }\n    }\n\n    console.log('\\n💡 建议修复方案:');\n    console.log('1. 将硬编码端点移动到 client/src/config/comfyui.config.js');\n    console.log('2. 使用 comfyUIConfig.getHealthCheckEndpoints() 获取端点列表');\n    console.log('3. 使用 comfyUIConfig.HEALTH_CHECK.HEADERS 获取请求头');\n    console.log('4. 使用 comfyUIConfig.validateResponse() 验证响应');\n  }\n\n  /**\n   * 按严重程度分组问题\n   */\n  groupIssuesBySeverity() {\n    const grouped = {};\n\n    for (const issue of this.issues) {\n      if (!grouped[issue.severity]) {\n        grouped[issue.severity] = [];\n      }\n      grouped[issue.severity].push(issue);\n    }\n\n    return grouped;\n  }\n}\n\n// 运行验证\nif (require.main === module) {\n  const verifier = new ConfigVerifier();\n  const success = verifier.verify();\n  process.exit(success ? 0 : 1);\n}\n\nmodule.exports = ConfigVerifier;\n"
        }
    ]
}