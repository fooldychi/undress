{
    "sourceFile": "scripts/port-config-manager.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1752973919763,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752973935300,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -209,12 +209,24 @@\n     }\n   }\n \n   async fixServerApp(port, fixes) {\n-    const appPath = path.join(__dirname, '..', 'server', 'src', 'app.js');\n+    // å°è¯•ä¸¤ä¸ªå¯èƒ½çš„è·¯å¾„\n+    const appPaths = [\n+      path.join(__dirname, '..', 'server', 'src', 'app.js'),\n+      path.join(__dirname, '..', 'server', 'app.js')\n+    ];\n \n-    if (!fs.existsSync(appPath)) {\n-      console.log(`âš ï¸ server/src/app.js ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿®å¤`);\n+    let appPath = null;\n+    for (const p of appPaths) {\n+      if (fs.existsSync(p)) {\n+        appPath = p;\n+        break;\n+      }\n+    }\n+\n+    if (!appPath) {\n+      console.log(`âš ï¸ server/app.js æˆ– server/src/app.js ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿®å¤`);\n       return;\n     }\n \n     let content = fs.readFileSync(appPath, 'utf8');\n"
                },
                {
                    "date": 1752973965545,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -149,9 +149,9 @@\n     // å¦‚æœæ˜¯ adminï¼Œè¿˜éœ€è¦ä¿®å¤ä»£ç†é…ç½®ä¸­çš„æœåŠ¡å™¨ç«¯å£\n     if (service === 'admin') {\n       content = content.replace(\n         /target:\\s*['\"`]http:\\/\\/localhost:\\d+['\"`]/g,\n-        `target: 'http://localhost:${standardPorts.server}'`\n+        `target: 'http://localhost:${this.config.ports.server}'`\n       );\n     }\n \n     if (content !== originalContent) {\n"
                }
            ],
            "date": 1752973919763,
            "name": "Commit-0",
            "content": "#!/usr/bin/env node\n\n/**\n * AIMagic é¡¹ç›®ç«¯å£é…ç½®ç®¡ç†å™¨\n * ç»Ÿä¸€ç®¡ç†å’ŒéªŒè¯æ‰€æœ‰æœåŠ¡çš„ç«¯å£é…ç½®\n */\n\nconst fs = require('fs');\nconst path = require('path');\nconst { execSync } = require('child_process');\n\nclass PortConfigManager {\n  constructor() {\n    this.configPath = path.join(__dirname, '..', 'port-config.json');\n    this.config = this.loadConfig();\n    this.logPath = path.join(__dirname, '..', 'PORT_CONFIG_CHANGELOG.md');\n  }\n\n  loadConfig() {\n    try {\n      const configContent = fs.readFileSync(this.configPath, 'utf8');\n      return JSON.parse(configContent);\n    } catch (error) {\n      console.error('âŒ æ— æ³•åŠ è½½ç«¯å£é…ç½®æ–‡ä»¶:', error.message);\n      process.exit(1);\n    }\n  }\n\n  // æ£€æŸ¥æ‰€æœ‰é…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£è®¾ç½®\n  async checkPortConsistency() {\n    console.log('ğŸ” æ£€æŸ¥ç«¯å£é…ç½®ä¸€è‡´æ€§...\\n');\n\n    const issues = [];\n    const standardPorts = this.config.ports;\n\n    // æ£€æŸ¥é…ç½®æ–‡ä»¶åˆ—è¡¨\n    const configFiles = [\n      {\n        path: 'client/vite.config.js',\n        service: 'client',\n        patterns: [\n          { regex: /port:\\s*(\\d+)/, description: 'Vite dev server port' }\n        ]\n      },\n      {\n        path: 'admin/vite.config.js',\n        service: 'admin',\n        patterns: [\n          { regex: /port:\\s*(\\d+)/, description: 'Vite dev server port' }\n        ]\n      },\n      {\n        path: 'server/.env',\n        service: 'server',\n        patterns: [\n          { regex: /PORT=(\\d+)/, description: 'Server port' },\n          { regex: /SERVER_PORT=(\\d+)/, description: 'Server port variable' }\n        ]\n      },\n      {\n        path: 'server/src/app.js',\n        service: 'server',\n        patterns: [\n          { regex: /PORT.*?(\\d+)/, description: 'App.js port fallback' }\n        ]\n      }\n    ];\n\n    for (const configFile of configFiles) {\n      const filePath = path.join(__dirname, '..', configFile.path);\n\n      if (!fs.existsSync(filePath)) {\n        issues.push({\n          file: configFile.path,\n          issue: 'æ–‡ä»¶ä¸å­˜åœ¨',\n          severity: 'warning'\n        });\n        continue;\n      }\n\n      const content = fs.readFileSync(filePath, 'utf8');\n      const expectedPort = standardPorts[configFile.service];\n\n      for (const pattern of configFile.patterns) {\n        const matches = content.match(pattern.regex);\n        if (matches) {\n          const foundPort = parseInt(matches[1]);\n          if (foundPort !== expectedPort) {\n            issues.push({\n              file: configFile.path,\n              issue: `${pattern.description}: å‘ç°ç«¯å£ ${foundPort}, æœŸæœ› ${expectedPort}`,\n              severity: 'error',\n              foundPort,\n              expectedPort,\n              service: configFile.service\n            });\n          }\n        }\n      }\n    }\n\n    return issues;\n  }\n\n  // ä¿®å¤ç«¯å£é…ç½®\n  async fixPortConfiguration() {\n    console.log('ğŸ”§ å¼€å§‹ä¿®å¤ç«¯å£é…ç½®...\\n');\n\n    const fixes = [];\n    const standardPorts = this.config.ports;\n\n    // ä¿®å¤ client/vite.config.js\n    await this.fixViteConfig('client', standardPorts.client, fixes);\n\n    // ä¿®å¤ admin/vite.config.js\n    await this.fixViteConfig('admin', standardPorts.admin, fixes);\n\n    // ä¿®å¤ server/.env\n    await this.fixServerEnv(standardPorts.server, fixes);\n\n    // ä¿®å¤ server/src/app.js æˆ– server/app.js\n    await this.fixServerApp(standardPorts.server, fixes);\n\n    // è®°å½•ä¿®å¤æ—¥å¿—\n    if (fixes.length > 0) {\n      this.logChanges(fixes);\n    }\n\n    return fixes;\n  }\n\n  async fixViteConfig(service, port, fixes) {\n    const configPath = path.join(__dirname, '..', service, 'vite.config.js');\n\n    if (!fs.existsSync(configPath)) {\n      console.log(`âš ï¸ ${service}/vite.config.js ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿®å¤`);\n      return;\n    }\n\n    let content = fs.readFileSync(configPath, 'utf8');\n    const originalContent = content;\n\n    // ä¿®å¤ç«¯å£é…ç½®\n    content = content.replace(\n      /port:\\s*\\d+/g,\n      `port: ${port}`\n    );\n\n    // å¦‚æœæ˜¯ adminï¼Œè¿˜éœ€è¦ä¿®å¤ä»£ç†é…ç½®ä¸­çš„æœåŠ¡å™¨ç«¯å£\n    if (service === 'admin') {\n      content = content.replace(\n        /target:\\s*['\"`]http:\\/\\/localhost:\\d+['\"`]/g,\n        `target: 'http://localhost:${standardPorts.server}'`\n      );\n    }\n\n    if (content !== originalContent) {\n      fs.writeFileSync(configPath, content);\n      fixes.push({\n        file: `${service}/vite.config.js`,\n        action: `ç«¯å£ä¿®å¤ä¸º ${port}`,\n        timestamp: new Date().toISOString()\n      });\n      console.log(`âœ… ä¿®å¤ ${service}/vite.config.js ç«¯å£ä¸º ${port}`);\n    }\n  }\n\n  async fixServerEnv(port, fixes) {\n    const envPath = path.join(__dirname, '..', 'server', '.env');\n\n    if (!fs.existsSync(envPath)) {\n      // åˆ›å»º .env æ–‡ä»¶\n      const envContent = `PORT=${port}\\nSERVER_PORT=${port}\\n`;\n      fs.writeFileSync(envPath, envContent);\n      fixes.push({\n        file: 'server/.env',\n        action: `åˆ›å»º .env æ–‡ä»¶ï¼Œè®¾ç½®ç«¯å£ä¸º ${port}`,\n        timestamp: new Date().toISOString()\n      });\n      console.log(`âœ… åˆ›å»º server/.envï¼Œç«¯å£è®¾ç½®ä¸º ${port}`);\n      return;\n    }\n\n    let content = fs.readFileSync(envPath, 'utf8');\n    const originalContent = content;\n\n    // ä¿®å¤æˆ–æ·»åŠ  PORT é…ç½®\n    if (content.includes('PORT=')) {\n      content = content.replace(/PORT=\\d+/g, `PORT=${port}`);\n    } else {\n      content += `\\nPORT=${port}`;\n    }\n\n    // ä¿®å¤æˆ–æ·»åŠ  SERVER_PORT é…ç½®\n    if (content.includes('SERVER_PORT=')) {\n      content = content.replace(/SERVER_PORT=\\d+/g, `SERVER_PORT=${port}`);\n    } else {\n      content += `\\nSERVER_PORT=${port}`;\n    }\n\n    if (content !== originalContent) {\n      fs.writeFileSync(envPath, content);\n      fixes.push({\n        file: 'server/.env',\n        action: `ç«¯å£ä¿®å¤ä¸º ${port}`,\n        timestamp: new Date().toISOString()\n      });\n      console.log(`âœ… ä¿®å¤ server/.env ç«¯å£ä¸º ${port}`);\n    }\n  }\n\n  async fixServerApp(port, fixes) {\n    const appPath = path.join(__dirname, '..', 'server', 'src', 'app.js');\n\n    if (!fs.existsSync(appPath)) {\n      console.log(`âš ï¸ server/src/app.js ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿®å¤`);\n      return;\n    }\n\n    let content = fs.readFileSync(appPath, 'utf8');\n    const originalContent = content;\n\n    // ä¿®å¤ç«¯å£é…ç½®çš„é»˜è®¤å€¼\n    content = content.replace(\n      /process\\.env\\.PORT\\s*\\|\\|\\s*\\d+/g,\n      `process.env.PORT || ${port}`\n    );\n\n    if (content !== originalContent) {\n      fs.writeFileSync(appPath, content);\n      fixes.push({\n        file: 'server/src/app.js',\n        action: `ç«¯å£é»˜è®¤å€¼ä¿®å¤ä¸º ${port}`,\n        timestamp: new Date().toISOString()\n      });\n      console.log(`âœ… ä¿®å¤ server/src/app.js ç«¯å£é»˜è®¤å€¼ä¸º ${port}`);\n    }\n  }\n\n  // è®°å½•å˜æ›´æ—¥å¿—\n  logChanges(fixes) {\n    if (fixes.length === 0) return;\n\n    const logEntry = `\n## ç«¯å£é…ç½®ä¿®å¤ - ${new Date().toISOString()}\n\n### ä¿®å¤å†…å®¹:\n${fixes.map(fix => `- **${fix.file}**: ${fix.action}`).join('\\n')}\n\n### æ ‡å‡†ç«¯å£é…ç½®:\n- å®¢æˆ·ç«¯å‰ç«¯: ${this.config.ports.client}\n- åå°ç®¡ç†ç³»ç»Ÿ: ${this.config.ports.admin}\n- åç«¯APIæœåŠ¡: ${this.config.ports.server}\n\n---\n`;\n\n    if (fs.existsSync(this.logPath)) {\n      const existingLog = fs.readFileSync(this.logPath, 'utf8');\n      fs.writeFileSync(this.logPath, logEntry + existingLog);\n    } else {\n      const header = `# AIMagic ç«¯å£é…ç½®å˜æ›´æ—¥å¿—\n\næ­¤æ–‡ä»¶è®°å½•æ‰€æœ‰ç«¯å£é…ç½®çš„å˜æ›´å†å²ã€‚\n\n`;\n      fs.writeFileSync(this.logPath, header + logEntry);\n    }\n  }\n\n  // éªŒè¯ç«¯å£æ˜¯å¦è¢«å ç”¨\n  async checkPortAvailability() {\n    console.log('ğŸ” æ£€æŸ¥ç«¯å£å¯ç”¨æ€§...\\n');\n\n    const ports = Object.values(this.config.ports);\n    const results = [];\n\n    for (const port of ports) {\n      try {\n        // åœ¨ Windows ä¸Šæ£€æŸ¥ç«¯å£å ç”¨\n        const command = process.platform === 'win32'\n          ? `netstat -ano | findstr :${port}`\n          : `lsof -i :${port}`;\n\n        const output = execSync(command, { encoding: 'utf8', stdio: 'pipe' });\n\n        if (output.trim()) {\n          results.push({\n            port,\n            status: 'occupied',\n            details: output.trim()\n          });\n        } else {\n          results.push({\n            port,\n            status: 'available'\n          });\n        }\n      } catch (error) {\n        // å‘½ä»¤æ‰§è¡Œå¤±è´¥é€šå¸¸æ„å‘³ç€ç«¯å£æœªè¢«å ç”¨\n        results.push({\n          port,\n          status: 'available'\n        });\n      }\n    }\n\n    return results;\n  }\n\n  // ç”Ÿæˆç«¯å£é…ç½®æŠ¥å‘Š\n  async generateReport() {\n    console.log('ğŸ“Š ç”Ÿæˆç«¯å£é…ç½®æŠ¥å‘Š...\\n');\n\n    const issues = await this.checkPortConsistency();\n    const availability = await this.checkPortAvailability();\n\n    const report = {\n      timestamp: new Date().toISOString(),\n      standardPorts: this.config.ports,\n      issues,\n      portAvailability: availability,\n      summary: {\n        totalIssues: issues.length,\n        errorCount: issues.filter(i => i.severity === 'error').length,\n        warningCount: issues.filter(i => i.severity === 'warning').length,\n        portsOccupied: availability.filter(p => p.status === 'occupied').length\n      }\n    };\n\n    return report;\n  }\n}\n\n// CLI æ¥å£\nasync function main() {\n  const manager = new PortConfigManager();\n  const command = process.argv[2];\n\n  switch (command) {\n    case 'check':\n      const issues = await manager.checkPortConsistency();\n      if (issues.length === 0) {\n        console.log('âœ… æ‰€æœ‰ç«¯å£é…ç½®ä¸€è‡´ï¼');\n      } else {\n        console.log('âŒ å‘ç°ç«¯å£é…ç½®é—®é¢˜:');\n        issues.forEach(issue => {\n          const icon = issue.severity === 'error' ? 'âŒ' : 'âš ï¸';\n          console.log(`${icon} ${issue.file}: ${issue.issue}`);\n        });\n        process.exit(1);\n      }\n      break;\n\n    case 'fix':\n      const fixes = await manager.fixPortConfiguration();\n      if (fixes.length === 0) {\n        console.log('âœ… ç«¯å£é…ç½®å·²ç»æ­£ç¡®ï¼Œæ— éœ€ä¿®å¤');\n      } else {\n        console.log(`âœ… å®Œæˆ ${fixes.length} é¡¹ç«¯å£é…ç½®ä¿®å¤`);\n      }\n      break;\n\n    case 'report':\n      const report = await manager.generateReport();\n      console.log(JSON.stringify(report, null, 2));\n      break;\n\n    case 'availability':\n      const availability = await manager.checkPortAvailability();\n      availability.forEach(result => {\n        const icon = result.status === 'available' ? 'âœ…' : 'âŒ';\n        console.log(`${icon} ç«¯å£ ${result.port}: ${result.status}`);\n        if (result.details) {\n          console.log(`   ${result.details}`);\n        }\n      });\n      break;\n\n    default:\n      console.log(`\nAIMagic ç«¯å£é…ç½®ç®¡ç†å™¨\n\nç”¨æ³•:\n  node scripts/port-config-manager.js <command>\n\nå‘½ä»¤:\n  check        æ£€æŸ¥ç«¯å£é…ç½®ä¸€è‡´æ€§\n  fix          ä¿®å¤ç«¯å£é…ç½®é—®é¢˜\n  report       ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š\n  availability æ£€æŸ¥ç«¯å£å¯ç”¨æ€§\n\nç¤ºä¾‹:\n  node scripts/port-config-manager.js check\n  node scripts/port-config-manager.js fix\n      `);\n  }\n}\n\nif (require.main === module) {\n  main().catch(console.error);\n}\n\nmodule.exports = PortConfigManager;\n"
        }
    ]
}