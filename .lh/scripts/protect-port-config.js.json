{
    "sourceFile": "scripts/protect-port-config.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1752408289136,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1752408289136,
            "name": "Commit-0",
            "content": "#!/usr/bin/env node\n\n/**\n * ç«¯å£é…ç½®ä¿æŠ¤å·¥å…·\n * é˜²æ­¢ç«¯å£ç®¡ç†è„šæœ¬è¢«æ„å¤–ä¿®æ”¹ï¼Œç¡®ä¿é…ç½®ä¸€è‡´æ€§\n */\n\nconst fs = require('fs');\nconst path = require('path');\nconst crypto = require('crypto');\n\nclass PortConfigProtector {\n  constructor() {\n    this.projectRoot = path.join(__dirname, '..');\n    this.protectedFiles = [\n      'port-config.json',\n      'scripts/port-manager.js',\n      'scripts/start-with-port-management.js',\n      'start-managed.js',\n      'start-managed.bat',\n      'start-managed.sh'\n    ];\n    this.checksumFile = path.join(__dirname, '.port-config-checksums.json');\n  }\n\n  /**\n   * è®¡ç®—æ–‡ä»¶çš„MD5æ ¡éªŒå’Œ\n   */\n  calculateChecksum(filePath) {\n    try {\n      const content = fs.readFileSync(filePath, 'utf8');\n      return crypto.createHash('md5').update(content).digest('hex');\n    } catch (error) {\n      return null;\n    }\n  }\n\n  /**\n   * ç”Ÿæˆæ‰€æœ‰ä¿æŠ¤æ–‡ä»¶çš„æ ¡éªŒå’Œ\n   */\n  generateChecksums() {\n    const checksums = {};\n\n    for (const file of this.protectedFiles) {\n      const filePath = path.join(this.projectRoot, file);\n      const checksum = this.calculateChecksum(filePath);\n\n      if (checksum) {\n        checksums[file] = {\n          checksum,\n          lastModified: fs.statSync(filePath).mtime.toISOString()\n        };\n      }\n    }\n\n    fs.writeFileSync(this.checksumFile, JSON.stringify(checksums, null, 2));\n    console.log('âœ… ç«¯å£é…ç½®æ–‡ä»¶æ ¡éªŒå’Œå·²ç”Ÿæˆ');\n    return checksums;\n  }\n\n  /**\n   * éªŒè¯æ–‡ä»¶å®Œæ•´æ€§\n   */\n  verifyIntegrity() {\n    if (!fs.existsSync(this.checksumFile)) {\n      console.log('âš ï¸ æ ¡éªŒå’Œæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ­£åœ¨ç”Ÿæˆ...');\n      return this.generateChecksums();\n    }\n\n    const savedChecksums = JSON.parse(fs.readFileSync(this.checksumFile, 'utf8'));\n    const issues = [];\n\n    for (const file of this.protectedFiles) {\n      const filePath = path.join(this.projectRoot, file);\n      const currentChecksum = this.calculateChecksum(filePath);\n      const savedData = savedChecksums[file];\n\n      if (!savedData) {\n        issues.push({\n          file,\n          issue: 'missing_baseline',\n          message: 'ç¼ºå°‘åŸºçº¿æ ¡éªŒå’Œ'\n        });\n        continue;\n      }\n\n      if (!currentChecksum) {\n        issues.push({\n          file,\n          issue: 'file_missing',\n          message: 'æ–‡ä»¶ä¸å­˜åœ¨'\n        });\n        continue;\n      }\n\n      if (currentChecksum !== savedData.checksum) {\n        issues.push({\n          file,\n          issue: 'modified',\n          message: 'æ–‡ä»¶å·²è¢«ä¿®æ”¹',\n          expected: savedData.checksum,\n          actual: currentChecksum\n        });\n      }\n    }\n\n    return issues;\n  }\n\n  /**\n   * æ˜¾ç¤ºå®Œæ•´æ€§æ£€æŸ¥æŠ¥å‘Š\n   */\n  showIntegrityReport() {\n    console.log('ğŸ” ç«¯å£é…ç½®æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥');\n    console.log('='.repeat(50));\n\n    const issues = this.verifyIntegrity();\n\n    if (!Array.isArray(issues) || issues.length === 0) {\n      console.log('âœ… æ‰€æœ‰ç«¯å£é…ç½®æ–‡ä»¶å®Œæ•´æ€§æ­£å¸¸');\n      return true;\n    }\n\n    console.log('âŒ å‘ç°ä»¥ä¸‹é—®é¢˜:');\n    issues.forEach(issue => {\n      console.log(`\\nğŸ“ æ–‡ä»¶: ${issue.file}`);\n      console.log(`ğŸš¨ é—®é¢˜: ${issue.message}`);\n      if (issue.expected && issue.actual) {\n        console.log(`   æœŸæœ›æ ¡éªŒå’Œ: ${issue.expected}`);\n        console.log(`   å®é™…æ ¡éªŒå’Œ: ${issue.actual}`);\n      }\n    });\n\n    console.log('\\nğŸ’¡ å»ºè®®:');\n    console.log('1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«æ„å¤–ä¿®æ”¹');\n    console.log('2. å¦‚æœä¿®æ”¹æ˜¯é¢„æœŸçš„ï¼Œè¿è¡Œ: node scripts/protect-port-config.js update');\n    console.log('3. å¦‚æœéœ€è¦æ¢å¤ï¼Œè¯·ä»ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿæ¢å¤æ–‡ä»¶');\n\n    return false;\n  }\n\n  /**\n   * æ›´æ–°æ ¡éªŒå’ŒåŸºçº¿\n   */\n  updateBaseline() {\n    console.log('ğŸ”„ æ›´æ–°ç«¯å£é…ç½®æ–‡ä»¶æ ¡éªŒå’ŒåŸºçº¿...');\n    this.generateChecksums();\n    console.log('âœ… æ ¡éªŒå’ŒåŸºçº¿å·²æ›´æ–°');\n  }\n\n  /**\n   * æ£€æŸ¥ç¡¬ç¼–ç ç«¯å£\n   */\n  checkHardcodedPorts() {\n    console.log('ğŸ” æ£€æŸ¥ç¡¬ç¼–ç ç«¯å£...');\n\n    const hardcodedPatterns = [\n      {\n        pattern: /localhost:3001(?![0-9])/g,\n        description: 'ç¡¬ç¼–ç çš„å®¢æˆ·ç«¯ç«¯å£ 3001'\n      },\n      {\n        pattern: /localhost:3002(?![0-9])/g,\n        description: 'ç¡¬ç¼–ç çš„ç«¯å£ 3002'\n      },\n      {\n        pattern: /localhost:3003(?![0-9])/g,\n        description: 'ç¡¬ç¼–ç çš„åå°ç®¡ç†ç«¯å£ 3003'\n      },\n      {\n        pattern: /localhost:3006(?![0-9])/g,\n        description: 'ç¡¬ç¼–ç çš„æ—§åç«¯ç«¯å£ 3006'\n      },\n      {\n        pattern: /localhost:3007(?![0-9])/g,\n        description: 'ç¡¬ç¼–ç çš„åç«¯ç«¯å£ 3007'\n      },\n      {\n        pattern: /localhost:3009(?![0-9])/g,\n        description: 'ç¡¬ç¼–ç çš„ç«¯å£ 3009'\n      }\n    ];\n\n    const filesToCheck = [\n      'client/src/services/api.js',\n      'admin/src/utils/request.js',\n      'client/vite.config.js',\n      'admin/vite.config.js',\n      'server/src/app.js'\n    ];\n\n    const issues = [];\n\n    for (const file of filesToCheck) {\n      const filePath = path.join(this.projectRoot, file);\n\n      if (!fs.existsSync(filePath)) {\n        continue;\n      }\n\n      const content = fs.readFileSync(filePath, 'utf8');\n\n      for (const { pattern, description } of hardcodedPatterns) {\n        const matches = content.match(pattern);\n        if (matches) {\n          const lines = content.split('\\n');\n          const lineNumbers = [];\n\n          lines.forEach((line, index) => {\n            if (pattern.test(line)) {\n              lineNumbers.push(index + 1);\n            }\n          });\n\n          issues.push({\n            file,\n            description,\n            matches: matches.length,\n            lines: lineNumbers\n          });\n        }\n      }\n    }\n\n    if (issues.length === 0) {\n      console.log('âœ… æœªå‘ç°ç¡¬ç¼–ç ç«¯å£é—®é¢˜');\n      return true;\n    }\n\n    console.log('âŒ å‘ç°ç¡¬ç¼–ç ç«¯å£é—®é¢˜:');\n    issues.forEach(issue => {\n      console.log(`\\nğŸ“ æ–‡ä»¶: ${issue.file}`);\n      console.log(`ğŸš¨ é—®é¢˜: ${issue.description}`);\n      console.log(`ğŸ“ è¡Œå·: ${issue.lines.join(', ')}`);\n      console.log(`ğŸ”¢ åŒ¹é…æ•°: ${issue.matches}`);\n    });\n\n    console.log('\\nğŸ’¡ å»ºè®®:');\n    console.log('1. ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶æ›¿ä»£ç¡¬ç¼–ç ç«¯å£');\n    console.log('2. åœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨ä»£ç†é…ç½®');\n    console.log('3. è¿è¡Œ: node scripts/protect-port-config.js fix è‡ªåŠ¨ä¿®å¤');\n\n    return false;\n  }\n\n  /**\n   * è‡ªåŠ¨ä¿®å¤ç¡¬ç¼–ç ç«¯å£é—®é¢˜\n   */\n  fixHardcodedPorts() {\n    console.log('ğŸ”§ è‡ªåŠ¨ä¿®å¤ç¡¬ç¼–ç ç«¯å£é—®é¢˜...');\n\n    // ä¿®å¤ client/src/services/api.js\n    const apiFilePath = path.join(this.projectRoot, 'client/src/services/api.js');\n    if (fs.existsSync(apiFilePath)) {\n      let content = fs.readFileSync(apiFilePath, 'utf8');\n\n      // æ›¿æ¢ç¡¬ç¼–ç çš„ localhost:3007\n      const oldPattern = \"BASE_URL: import.meta.env.DEV ? '' : 'http://localhost:3007'\";\n      const newPattern = \"BASE_URL: import.meta.env.DEV ? '' : `http://localhost:${import.meta.env.VITE_SERVER_PORT || 3007}`\";\n\n      if (content.includes(oldPattern)) {\n        content = content.replace(oldPattern, newPattern);\n        fs.writeFileSync(apiFilePath, content);\n        console.log('âœ… ä¿®å¤äº† client/src/services/api.js ä¸­çš„ç¡¬ç¼–ç ç«¯å£');\n      }\n    }\n\n    console.log('âœ… ç¡¬ç¼–ç ç«¯å£ä¿®å¤å®Œæˆ');\n  }\n\n  /**\n   * æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯\n   */\n  showHelp() {\n    console.log('ğŸ›¡ï¸ ç«¯å£é…ç½®ä¿æŠ¤å·¥å…·');\n    console.log('');\n    console.log('ç”¨æ³•:');\n    console.log('  node scripts/protect-port-config.js <å‘½ä»¤>');\n    console.log('');\n    console.log('å‘½ä»¤:');\n    console.log('  check      æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§å’Œç¡¬ç¼–ç ç«¯å£');\n    console.log('  verify     éªŒè¯æ–‡ä»¶å®Œæ•´æ€§');\n    console.log('  update     æ›´æ–°æ ¡éªŒå’ŒåŸºçº¿');\n    console.log('  hardcode   æ£€æŸ¥ç¡¬ç¼–ç ç«¯å£');\n    console.log('  fix        è‡ªåŠ¨ä¿®å¤ç¡¬ç¼–ç ç«¯å£');\n    console.log('  help       æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯');\n    console.log('');\n    console.log('ç¤ºä¾‹:');\n    console.log('  node scripts/protect-port-config.js check');\n    console.log('  node scripts/protect-port-config.js fix');\n  }\n}\n\n// ä¸»å‡½æ•°\nasync function main() {\n  const protector = new PortConfigProtector();\n  const command = process.argv[2] || 'check';\n\n  switch (command) {\n    case 'check':\n      const integrityOk = protector.showIntegrityReport();\n      const hardcodeOk = protector.checkHardcodedPorts();\n      process.exit(integrityOk && hardcodeOk ? 0 : 1);\n      break;\n\n    case 'verify':\n      const ok = protector.showIntegrityReport();\n      process.exit(ok ? 0 : 1);\n      break;\n\n    case 'update':\n      protector.updateBaseline();\n      break;\n\n    case 'hardcode':\n      const hardcodeResult = protector.checkHardcodedPorts();\n      process.exit(hardcodeResult ? 0 : 1);\n      break;\n\n    case 'fix':\n      protector.fixHardcodedPorts();\n      break;\n\n    case 'help':\n    default:\n      protector.showHelp();\n      break;\n  }\n}\n\n// å¦‚æœç›´æ¥è¿è¡Œæ­¤è„šæœ¬\nif (require.main === module) {\n  main().catch(console.error);\n}\n\nmodule.exports = PortConfigProtector;\n"
        }
    ]
}