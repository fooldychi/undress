{
    "sourceFile": "scripts/port-manager.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1752407728036,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1752407728036,
            "name": "Commit-0",
            "content": "#!/usr/bin/env node\n\n/**\n * AIMagic é¡¹ç›®ç«¯å£ç®¡ç†å·¥å…·\n * ç»Ÿä¸€ç®¡ç†é¡¹ç›®ç«¯å£ï¼Œé˜²æ­¢ç«¯å£å†²çªï¼Œå¼ºåˆ¶ä½¿ç”¨æŒ‡å®šç«¯å£\n */\n\nconst fs = require('fs');\nconst path = require('path');\nconst { spawn, exec } = require('child_process');\nconst os = require('os');\n\nclass PortManager {\n  constructor() {\n    this.configPath = path.join(__dirname, '../port-config.json');\n    this.config = this.loadConfig();\n    this.platform = os.platform();\n  }\n\n  /**\n   * åŠ è½½ç«¯å£é…ç½®\n   */\n  loadConfig() {\n    try {\n      const configData = fs.readFileSync(this.configPath, 'utf8');\n      return JSON.parse(configData);\n    } catch (error) {\n      console.error('âŒ æ— æ³•åŠ è½½ç«¯å£é…ç½®æ–‡ä»¶:', error.message);\n      process.exit(1);\n    }\n  }\n\n  /**\n   * æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨\n   */\n  async checkPortInUse(port) {\n    return new Promise((resolve) => {\n      const command = this.platform === 'win32'\n        ? `netstat -ano | findstr :${port}`\n        : `lsof -i :${port}`;\n\n      exec(command, (error, stdout) => {\n        if (error) {\n          resolve(false); // ç«¯å£æœªè¢«å ç”¨\n        } else {\n          resolve(stdout.trim().length > 0); // æœ‰è¾“å‡ºè¯´æ˜ç«¯å£è¢«å ç”¨\n        }\n      });\n    });\n  }\n\n  /**\n   * è·å–å ç”¨ç«¯å£çš„è¿›ç¨‹ID\n   */\n  async getPortProcessId(port) {\n    return new Promise((resolve) => {\n      const command = this.platform === 'win32'\n        ? `netstat -ano | findstr :${port}`\n        : `lsof -ti :${port}`;\n\n      exec(command, (error, stdout) => {\n        if (error || !stdout.trim()) {\n          resolve(null);\n          return;\n        }\n\n        if (this.platform === 'win32') {\n          // Windows: è§£ænetstatè¾“å‡ºè·å–PID\n          const lines = stdout.trim().split('\\n');\n          for (const line of lines) {\n            const parts = line.trim().split(/\\s+/);\n            if (parts.length >= 5) {\n              const pid = parts[parts.length - 1];\n              if (pid && !isNaN(pid)) {\n                resolve(parseInt(pid));\n                return;\n              }\n            }\n          }\n          resolve(null);\n        } else {\n          // Unix/Linux/Mac: lsofç›´æ¥è¿”å›PID\n          const pid = parseInt(stdout.trim().split('\\n')[0]);\n          resolve(isNaN(pid) ? null : pid);\n        }\n      });\n    });\n  }\n\n  /**\n   * ç»ˆæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹\n   */\n  async killProcess(pid) {\n    return new Promise((resolve) => {\n      const command = this.platform === 'win32'\n        ? `taskkill /PID ${pid} /F`\n        : `kill -9 ${pid}`;\n\n      exec(command, (error) => {\n        resolve(!error);\n      });\n    });\n  }\n\n  /**\n   * æ£€æŸ¥å¹¶å¤„ç†ç«¯å£å†²çª\n   */\n  async handlePortConflict(serviceName, port) {\n    const isInUse = await this.checkPortInUse(port);\n\n    if (!isInUse) {\n      console.log(`âœ… ç«¯å£ ${port} (${serviceName}) å¯ç”¨`);\n      return true;\n    }\n\n    console.log(`âš ï¸ ç«¯å£ ${port} (${serviceName}) è¢«å ç”¨`);\n\n    if (!this.config.rules.killConflictingProcesses) {\n      console.log(`âŒ ç«¯å£å†²çªå¤„ç†å·²ç¦ç”¨ï¼Œè¯·æ‰‹åŠ¨å¤„ç†ç«¯å£ ${port} çš„å†²çª`);\n      return false;\n    }\n\n    const pid = await this.getPortProcessId(port);\n    if (!pid) {\n      console.log(`âŒ æ— æ³•è·å–å ç”¨ç«¯å£ ${port} çš„è¿›ç¨‹ID`);\n      return false;\n    }\n\n    console.log(`ğŸ”„ æ­£åœ¨ç»ˆæ­¢è¿›ç¨‹ ${pid} (å ç”¨ç«¯å£ ${port})...`);\n    const killed = await this.killProcess(pid);\n\n    if (killed) {\n      console.log(`âœ… æˆåŠŸç»ˆæ­¢è¿›ç¨‹ ${pid}ï¼Œç«¯å£ ${port} ç°åœ¨å¯ç”¨`);\n      // ç­‰å¾…ä¸€ç§’ç¡®ä¿ç«¯å£é‡Šæ”¾\n      await new Promise(resolve => setTimeout(resolve, 1000));\n      return true;\n    } else {\n      console.log(`âŒ æ— æ³•ç»ˆæ­¢è¿›ç¨‹ ${pid}`);\n      return false;\n    }\n  }\n\n  /**\n   * éªŒè¯æ‰€æœ‰ç«¯å£\n   */\n  async validateAllPorts() {\n    console.log('ğŸ” æ£€æŸ¥ç«¯å£é…ç½®...\\n');\n\n    const results = {};\n\n    for (const [serviceName, serviceConfig] of Object.entries(this.config.services)) {\n      const port = serviceConfig.port;\n      console.log(`ğŸ“ æ£€æŸ¥ ${serviceConfig.name} (ç«¯å£ ${port})...`);\n\n      const available = await this.handlePortConflict(serviceName, port);\n      results[serviceName] = {\n        port,\n        available,\n        config: serviceConfig\n      };\n\n      console.log('');\n    }\n\n    return results;\n  }\n\n  /**\n   * å¯åŠ¨æœåŠ¡\n   */\n  async startService(serviceName) {\n    const serviceConfig = this.config.services[serviceName];\n    if (!serviceConfig) {\n      console.error(`âŒ æœªæ‰¾åˆ°æœåŠ¡é…ç½®: ${serviceName}`);\n      return false;\n    }\n\n    console.log(`ğŸš€ å¯åŠ¨ ${serviceConfig.name}...`);\n\n    // æ£€æŸ¥ç«¯å£\n    const available = await this.handlePortConflict(serviceName, serviceConfig.port);\n    if (!available) {\n      console.error(`âŒ ç«¯å£ ${serviceConfig.port} ä¸å¯ç”¨ï¼Œæ— æ³•å¯åŠ¨ ${serviceConfig.name}`);\n      return false;\n    }\n\n    // å¯åŠ¨æœåŠ¡\n    const cwd = path.join(__dirname, '..', serviceConfig.directory);\n    const [command, ...args] = serviceConfig.startCommand.split(' ');\n\n    console.log(`ğŸ“‚ å·¥ä½œç›®å½•: ${cwd}`);\n    console.log(`âš¡ æ‰§è¡Œå‘½ä»¤: ${serviceConfig.startCommand}`);\n    console.log(`ğŸŒ è®¿é—®åœ°å€: ${serviceConfig.url}\\n`);\n\n    const child = spawn(command, args, {\n      cwd,\n      stdio: 'inherit',\n      shell: true\n    });\n\n    child.on('error', (error) => {\n      console.error(`âŒ å¯åŠ¨ ${serviceConfig.name} å¤±è´¥:`, error.message);\n    });\n\n    return child;\n  }\n\n  /**\n   * æ˜¾ç¤ºç«¯å£çŠ¶æ€æŠ¥å‘Š\n   */\n  async showPortStatus() {\n    console.log('ğŸ“Š AIMagic é¡¹ç›®ç«¯å£çŠ¶æ€æŠ¥å‘Š');\n    console.log('='.repeat(50));\n    console.log('');\n\n    for (const [serviceName, serviceConfig] of Object.entries(this.config.services)) {\n      const port = serviceConfig.port;\n      const isInUse = await this.checkPortInUse(port);\n      const status = isInUse ? 'ğŸ”´ å ç”¨' : 'ğŸŸ¢ å¯ç”¨';\n\n      console.log(`${serviceConfig.name}:`);\n      console.log(`  ç«¯å£: ${port}`);\n      console.log(`  çŠ¶æ€: ${status}`);\n      console.log(`  è®¿é—®: ${serviceConfig.url}`);\n      console.log('');\n    }\n  }\n\n  /**\n   * æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯\n   */\n  showHelp() {\n    console.log('ğŸ› ï¸ AIMagic ç«¯å£ç®¡ç†å·¥å…·');\n    console.log('');\n    console.log('ç”¨æ³•:');\n    console.log('  node scripts/port-manager.js <å‘½ä»¤> [é€‰é¡¹]');\n    console.log('');\n    console.log('å‘½ä»¤:');\n    console.log('  check          æ£€æŸ¥æ‰€æœ‰ç«¯å£çŠ¶æ€');\n    console.log('  validate       éªŒè¯å¹¶å¤„ç†ç«¯å£å†²çª');\n    console.log('  start <æœåŠ¡>   å¯åŠ¨æŒ‡å®šæœåŠ¡ (client|admin|server)');\n    console.log('  status         æ˜¾ç¤ºç«¯å£çŠ¶æ€æŠ¥å‘Š');\n    console.log('  help           æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯');\n    console.log('');\n    console.log('ç¤ºä¾‹:');\n    console.log('  node scripts/port-manager.js validate');\n    console.log('  node scripts/port-manager.js start server');\n    console.log('  node scripts/port-manager.js status');\n  }\n}\n\n// ä¸»å‡½æ•°\nasync function main() {\n  const manager = new PortManager();\n  const command = process.argv[2];\n  const service = process.argv[3];\n\n  switch (command) {\n    case 'check':\n    case 'validate':\n      await manager.validateAllPorts();\n      break;\n\n    case 'start':\n      if (!service) {\n        console.error('âŒ è¯·æŒ‡å®šè¦å¯åŠ¨çš„æœåŠ¡: client, admin, æˆ– server');\n        process.exit(1);\n      }\n      await manager.startService(service);\n      break;\n\n    case 'status':\n      await manager.showPortStatus();\n      break;\n\n    case 'help':\n    default:\n      manager.showHelp();\n      break;\n  }\n}\n\n// å¦‚æœç›´æ¥è¿è¡Œæ­¤è„šæœ¬\nif (require.main === module) {\n  main().catch(console.error);\n}\n\nmodule.exports = PortManager;\n"
        }
    ]
}