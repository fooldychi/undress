{
    "sourceFile": "fixed-queue-test.html",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1752516529901,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752516557314,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -223,24 +223,53 @@\n                 // æµ‹è¯•æ–°ç«¯ç‚¹\n                 const newResult = await testNewEndpoint(server);\n                 const newColumn = document.createElement('div');\n                 newColumn.className = 'test-column';\n-                newColumn.innerHTML = `\n+\n+                let newContent = `\n                     <h4>âœ… æ–°ç«¯ç‚¹ (/api/queue)</h4>\n                     <div class=\"result ${newResult.success ? 'success' : 'error'}\">\n                         ${newResult.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\n                     </div>\n-                    ${newResult.status ? `<div>çŠ¶æ€ç : ${newResult.status}</div>` : ''}\n-                    ${newResult.responseTime ? `<div>å“åº”æ—¶é—´: ${newResult.responseTime}ms</div>` : ''}\n-                    ${newResult.queueInfo ? `\n-                        <div>é˜Ÿåˆ—ä¿¡æ¯:</div>\n+                    ${newResult.status ? `<div><strong>çŠ¶æ€ç :</strong> ${newResult.status}</div>` : ''}\n+                    ${newResult.responseTime ? `<div><strong>å“åº”æ—¶é—´:</strong> ${newResult.responseTime}ms</div>` : ''}\n+                `;\n+\n+                if (newResult.queueInfo) {\n+                    newContent += `\n+                        <div><strong>ğŸ“Š é˜Ÿåˆ—è¯¦æƒ…:</strong></div>\n                         <div>- è¿è¡Œä¸­: ${newResult.queueInfo.running}</div>\n                         <div>- ç­‰å¾…ä¸­: ${newResult.queueInfo.pending}</div>\n                         <div>- æ€»è®¡: ${newResult.queueInfo.total}</div>\n-                    ` : ''}\n-                    ${newResult.error ? `<div>é”™è¯¯: ${newResult.error}</div>` : ''}\n-                `;\n+                    `;\n \n+                    // é˜Ÿåˆ—çŠ¶æ€æŒ‡ç¤º\n+                    if (newResult.queueInfo.total === 0) {\n+                        newContent += `<div style=\"color: green;\">ğŸŸ¢ æœåŠ¡å™¨ç©ºé—²</div>`;\n+                    } else if (newResult.queueInfo.running > 0) {\n+                        newContent += `<div style=\"color: orange;\">ğŸŸ¡ æœåŠ¡å™¨ç¹å¿™</div>`;\n+                    } else {\n+                        newContent += `<div style=\"color: red;\">ğŸ”´ é˜Ÿåˆ—æ»¡è½½</div>`;\n+                    }\n+                }\n+\n+                if (newResult.data) {\n+                    newContent += `\n+                        <div><strong>ğŸ“„ æ•°æ®ç»“æ„:</strong></div>\n+                        <div>- æ•°æ®é”®: ${Object.keys(newResult.data).join(', ')}</div>\n+                        <details>\n+                            <summary>æŸ¥çœ‹åŸå§‹æ•°æ®</summary>\n+                            <pre style=\"font-size: 10px; max-height: 150px; overflow-y: auto;\">${JSON.stringify(newResult.data, null, 2)}</pre>\n+                        </details>\n+                    `;\n+                }\n+\n+                if (newResult.error) {\n+                    newContent += `<div style=\"color: red;\"><strong>é”™è¯¯:</strong> ${newResult.error}</div>`;\n+                }\n+\n+                newColumn.innerHTML = newContent;\n+\n                 comparisonDiv.appendChild(oldColumn);\n                 comparisonDiv.appendChild(newColumn);\n                 resultsElement.appendChild(comparisonDiv);\n \n"
                }
            ],
            "date": 1752516529901,
            "name": "Commit-0",
            "content": "<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>ä¿®å¤åçš„é˜Ÿåˆ—æµ‹è¯•</title>\n    <style>\n        body {\n            font-family: Arial, sans-serif;\n            max-width: 800px;\n            margin: 0 auto;\n            padding: 20px;\n            background-color: #f5f5f5;\n        }\n        .container {\n            background: white;\n            padding: 20px;\n            border-radius: 8px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n        }\n        .result {\n            margin: 15px 0;\n            padding: 15px;\n            border-radius: 5px;\n            font-family: monospace;\n        }\n        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }\n        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }\n        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }\n        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }\n        button {\n            background: #007bff;\n            color: white;\n            border: none;\n            padding: 10px 20px;\n            border-radius: 5px;\n            cursor: pointer;\n            margin: 5px;\n        }\n        button:hover { background: #0056b3; }\n        pre {\n            background: #f8f9fa;\n            padding: 10px;\n            border-radius: 3px;\n            overflow-x: auto;\n            font-size: 12px;\n            max-height: 200px;\n            overflow-y: auto;\n        }\n        .comparison {\n            display: grid;\n            grid-template-columns: 1fr 1fr;\n            gap: 20px;\n            margin: 20px 0;\n        }\n        .test-column {\n            padding: 15px;\n            border: 1px solid #ddd;\n            border-radius: 5px;\n            background: #f9f9f9;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h1>ğŸ”§ ä¿®å¤åçš„é˜Ÿåˆ—æµ‹è¯•</h1>\n        <p>åŸºäºæ‚¨æä¾›çš„è¯·æ±‚ä¿¡æ¯ä¿®å¤åçš„æµ‹è¯•ã€‚</p>\n\n        <div>\n            <button onclick=\"testBothEndpoints()\">å¯¹æ¯”æµ‹è¯•æ–°æ—§ç«¯ç‚¹</button>\n            <button onclick=\"testNewEndpoint()\">ä»…æµ‹è¯•æ–°ç«¯ç‚¹</button>\n            <button onclick=\"clearResults()\">æ¸…é™¤ç»“æœ</button>\n        </div>\n\n        <div id=\"results\"></div>\n    </div>\n\n    <script>\n        const servers = [\n            'https://l9s75ay3rp-8188.cnb.run',\n            'https://0rv00xh2vg-8188.cnb.run'\n        ];\n\n        let resultsElement = document.getElementById('results');\n\n        function addResult(message, type = 'info') {\n            const div = document.createElement('div');\n            div.className = `result ${type}`;\n            div.innerHTML = message;\n            resultsElement.appendChild(div);\n        }\n\n        function clearResults() {\n            resultsElement.innerHTML = '';\n        }\n\n        // æ—§çš„è¯·æ±‚æ–¹å¼ï¼ˆä¹‹å‰å¤±è´¥çš„ï¼‰\n        async function testOldEndpoint(serverUrl) {\n            try {\n                const controller = new AbortController();\n                const timeoutId = setTimeout(() => controller.abort(), 10000);\n\n                const startTime = Date.now();\n                const response = await fetch(`${serverUrl}/queue`, {\n                    method: 'GET',\n                    signal: controller.signal,\n                    headers: {\n                        'Accept': 'application/json',\n                        'Cache-Control': 'no-cache'\n                    }\n                });\n\n                clearTimeout(timeoutId);\n                const endTime = Date.now();\n\n                if (response.ok) {\n                    const data = await response.json();\n                    return {\n                        success: true,\n                        status: response.status,\n                        responseTime: endTime - startTime,\n                        data: data\n                    };\n                } else {\n                    return {\n                        success: false,\n                        status: response.status,\n                        error: `HTTP ${response.status}`\n                    };\n                }\n\n            } catch (error) {\n                return {\n                    success: false,\n                    error: error.message\n                };\n            }\n        }\n\n        // æ–°çš„è¯·æ±‚æ–¹å¼ï¼ˆåŸºäºæ‚¨çš„è¯·æ±‚ä¿¡æ¯ï¼‰\n        async function testNewEndpoint(serverUrl) {\n            try {\n                const controller = new AbortController();\n                const timeoutId = setTimeout(() => controller.abort(), 10000);\n\n                const startTime = Date.now();\n                const response = await fetch(`${serverUrl}/api/queue`, {\n                    method: 'GET',\n                    signal: controller.signal,\n                    headers: {\n                        'Accept': '*/*',\n                        'Cache-Control': 'max-age=0',\n                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36',\n                        'comfy-user': 'test-client'\n                    }\n                });\n\n                clearTimeout(timeoutId);\n                const endTime = Date.now();\n\n                if (response.ok) {\n                    const data = await response.json();\n\n                    // è§£æé˜Ÿåˆ—æ•°æ®\n                    let running = 0, pending = 0;\n                    if (data.queue_running !== undefined && data.queue_pending !== undefined) {\n                        running = Array.isArray(data.queue_running) ? data.queue_running.length : data.queue_running;\n                        pending = Array.isArray(data.queue_pending) ? data.queue_pending.length : data.queue_pending;\n                    }\n\n                    return {\n                        success: true,\n                        status: response.status,\n                        responseTime: endTime - startTime,\n                        data: data,\n                        queueInfo: {\n                            running: running,\n                            pending: pending,\n                            total: running + pending\n                        }\n                    };\n                } else {\n                    return {\n                        success: false,\n                        status: response.status,\n                        error: `HTTP ${response.status}`\n                    };\n                }\n\n            } catch (error) {\n                return {\n                    success: false,\n                    error: error.message\n                };\n            }\n        }\n\n        window.testBothEndpoints = async function() {\n            clearResults();\n            addResult('ğŸ” å¯¹æ¯”æµ‹è¯•æ–°æ—§ç«¯ç‚¹...', 'info');\n\n            for (const server of servers) {\n                addResult(`\\nğŸ–¥ï¸ æµ‹è¯•æœåŠ¡å™¨: ${server}`, 'info');\n\n                // åˆ›å»ºå¯¹æ¯”è¡¨æ ¼\n                const comparisonDiv = document.createElement('div');\n                comparisonDiv.className = 'comparison';\n\n                // æµ‹è¯•æ—§ç«¯ç‚¹\n                const oldResult = await testOldEndpoint(server);\n                const oldColumn = document.createElement('div');\n                oldColumn.className = 'test-column';\n                oldColumn.innerHTML = `\n                    <h4>âŒ æ—§ç«¯ç‚¹ (/queue)</h4>\n                    <div class=\"result ${oldResult.success ? 'success' : 'error'}\">\n                        ${oldResult.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\n                    </div>\n                    ${oldResult.status ? `<div>çŠ¶æ€ç : ${oldResult.status}</div>` : ''}\n                    ${oldResult.responseTime ? `<div>å“åº”æ—¶é—´: ${oldResult.responseTime}ms</div>` : ''}\n                    ${oldResult.error ? `<div>é”™è¯¯: ${oldResult.error}</div>` : ''}\n                `;\n\n                // æµ‹è¯•æ–°ç«¯ç‚¹\n                const newResult = await testNewEndpoint(server);\n                const newColumn = document.createElement('div');\n                newColumn.className = 'test-column';\n                newColumn.innerHTML = `\n                    <h4>âœ… æ–°ç«¯ç‚¹ (/api/queue)</h4>\n                    <div class=\"result ${newResult.success ? 'success' : 'error'}\">\n                        ${newResult.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\n                    </div>\n                    ${newResult.status ? `<div>çŠ¶æ€ç : ${newResult.status}</div>` : ''}\n                    ${newResult.responseTime ? `<div>å“åº”æ—¶é—´: ${newResult.responseTime}ms</div>` : ''}\n                    ${newResult.queueInfo ? `\n                        <div>é˜Ÿåˆ—ä¿¡æ¯:</div>\n                        <div>- è¿è¡Œä¸­: ${newResult.queueInfo.running}</div>\n                        <div>- ç­‰å¾…ä¸­: ${newResult.queueInfo.pending}</div>\n                        <div>- æ€»è®¡: ${newResult.queueInfo.total}</div>\n                    ` : ''}\n                    ${newResult.error ? `<div>é”™è¯¯: ${newResult.error}</div>` : ''}\n                `;\n\n                comparisonDiv.appendChild(oldColumn);\n                comparisonDiv.appendChild(newColumn);\n                resultsElement.appendChild(comparisonDiv);\n\n                // æ˜¾ç¤ºåŸå§‹æ•°æ®\n                if (newResult.success && newResult.data) {\n                    addResult(`ğŸ“„ é˜Ÿåˆ—æ•°æ® (å‰500å­—ç¬¦):\\n<pre>${JSON.stringify(newResult.data, null, 2).substring(0, 500)}...</pre>`, 'info');\n                }\n            }\n\n            addResult('âœ… å¯¹æ¯”æµ‹è¯•å®Œæˆ', 'success');\n        };\n\n        window.testNewEndpoint = async function() {\n            clearResults();\n            addResult('ğŸš€ æµ‹è¯•æ–°ç«¯ç‚¹ (/api/queue)...', 'info');\n\n            for (const server of servers) {\n                addResult(`ğŸ” æµ‹è¯•æœåŠ¡å™¨: ${server}`, 'info');\n\n                const result = await testNewEndpoint(server);\n\n                if (result.success) {\n                    addResult(`âœ… è¿æ¥æˆåŠŸ (${result.responseTime}ms)`, 'success');\n\n                    // è¯¦ç»†çš„é˜Ÿåˆ—ä¿¡æ¯åˆ†æ\n                    if (result.queueInfo) {\n                        let queueDetails = `ğŸ“Š é˜Ÿåˆ—è¯¦ç»†ä¿¡æ¯:\\n`;\n                        queueDetails += `- è¿è¡Œä¸­ä»»åŠ¡: ${result.queueInfo.running}\\n`;\n                        queueDetails += `- ç­‰å¾…ä¸­ä»»åŠ¡: ${result.queueInfo.pending}\\n`;\n                        queueDetails += `- æ€»ä»»åŠ¡æ•°: ${result.queueInfo.total}\\n`;\n\n                        if (result.queueInfo.total === 0) {\n                            queueDetails += `- çŠ¶æ€: ğŸŸ¢ æœåŠ¡å™¨ç©ºé—²ï¼Œæ— ä»»åŠ¡é˜Ÿåˆ—\\n`;\n                        } else if (result.queueInfo.running > 0) {\n                            queueDetails += `- çŠ¶æ€: ğŸŸ¡ æœåŠ¡å™¨ç¹å¿™ï¼Œæ­£åœ¨å¤„ç† ${result.queueInfo.running} ä¸ªä»»åŠ¡\\n`;\n                        } else {\n                            queueDetails += `- çŠ¶æ€: ğŸ”´ æœåŠ¡å™¨é˜Ÿåˆ—æ»¡ï¼Œ${result.queueInfo.pending} ä¸ªä»»åŠ¡ç­‰å¾…ä¸­\\n`;\n                        }\n\n                        addResult(queueDetails, 'success');\n                    }\n\n                    // è¯¦ç»†çš„åŸå§‹æ•°æ®åˆ†æ\n                    if (result.data) {\n                        let dataAnalysis = `ğŸ“„ åŸå§‹æ•°æ®åˆ†æ:\\n`;\n                        dataAnalysis += `- æ•°æ®ç±»å‹: ${typeof result.data}\\n`;\n                        dataAnalysis += `- æ•°æ®é”®: ${Object.keys(result.data).join(', ')}\\n`;\n\n                        // åˆ†æé˜Ÿåˆ—ç»“æ„\n                        if (result.data.queue_running !== undefined) {\n                            const runningType = Array.isArray(result.data.queue_running) ? 'array' : typeof result.data.queue_running;\n                            dataAnalysis += `- queue_running ç±»å‹: ${runningType}\\n`;\n                            if (Array.isArray(result.data.queue_running)) {\n                                dataAnalysis += `- queue_running é•¿åº¦: ${result.data.queue_running.length}\\n`;\n                                if (result.data.queue_running.length > 0) {\n                                    dataAnalysis += `- è¿è¡Œä¸­ä»»åŠ¡ç¤ºä¾‹: ${JSON.stringify(result.data.queue_running[0]).substring(0, 100)}...\\n`;\n                                }\n                            }\n                        }\n\n                        if (result.data.queue_pending !== undefined) {\n                            const pendingType = Array.isArray(result.data.queue_pending) ? 'array' : typeof result.data.queue_pending;\n                            dataAnalysis += `- queue_pending ç±»å‹: ${pendingType}\\n`;\n                            if (Array.isArray(result.data.queue_pending)) {\n                                dataAnalysis += `- queue_pending é•¿åº¦: ${result.data.queue_pending.length}\\n`;\n                                if (result.data.queue_pending.length > 0) {\n                                    dataAnalysis += `- ç­‰å¾…ä¸­ä»»åŠ¡ç¤ºä¾‹: ${JSON.stringify(result.data.queue_pending[0]).substring(0, 100)}...\\n`;\n                                }\n                            }\n                        }\n\n                        addResult(dataAnalysis, 'info');\n\n                        // å®Œæ•´çš„åŸå§‹æ•°æ®\n                        addResult(`ğŸ“„ å®Œæ•´åŸå§‹æ•°æ®:\\n<pre>${JSON.stringify(result.data, null, 2)}</pre>`, 'info');\n                    }\n                } else {\n                    addResult(`âŒ è¿æ¥å¤±è´¥: ${result.error}`, 'error');\n\n                    // è¯¦ç»†çš„é”™è¯¯åˆ†æ\n                    if (result.error) {\n                        let errorAnalysis = `ğŸ” é”™è¯¯è¯¦ç»†åˆ†æ:\\n`;\n                        if (result.error.includes('Failed to fetch')) {\n                            errorAnalysis += `- é”™è¯¯ç±»å‹: ç½‘ç»œè¿æ¥å¤±è´¥\\n`;\n                            errorAnalysis += `- å¯èƒ½åŸå› : æœåŠ¡å™¨ä¸å¯è¾¾ã€DNSè§£æå¤±è´¥ã€SSLè¯ä¹¦é—®é¢˜\\n`;\n                        } else if (result.error.includes('CORS')) {\n                            errorAnalysis += `- é”™è¯¯ç±»å‹: è·¨åŸŸè¯·æ±‚è¢«é˜»æ­¢\\n`;\n                            errorAnalysis += `- å¯èƒ½åŸå› : æœåŠ¡å™¨æœªé…ç½®CORSå¤´\\n`;\n                        } else if (result.error.includes('timeout')) {\n                            errorAnalysis += `- é”™è¯¯ç±»å‹: è¯·æ±‚è¶…æ—¶\\n`;\n                            errorAnalysis += `- å¯èƒ½åŸå› : æœåŠ¡å™¨å“åº”è¿‡æ…¢\\n`;\n                        } else {\n                            errorAnalysis += `- é”™è¯¯ç±»å‹: æœªçŸ¥é”™è¯¯\\n`;\n                            errorAnalysis += `- é”™è¯¯ä¿¡æ¯: ${result.error}\\n`;\n                        }\n                        addResult(errorAnalysis, 'warning');\n                    }\n                }\n\n                addResult('', 'info'); // åˆ†éš”çº¿\n            }\n\n            addResult('âœ… æµ‹è¯•å®Œæˆ', 'success');\n        };\n\n        window.clearResults = clearResults;\n\n        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•æ–°ç«¯ç‚¹\n        window.addEventListener('load', () => {\n            addResult('ğŸ“‹ ä¿®å¤åçš„é˜Ÿåˆ—æµ‹è¯•å·²å‡†å¤‡å°±ç»ª', 'info');\n            addResult('ğŸ’¡ åŸºäºæ‚¨æä¾›çš„è¯·æ±‚ä¿¡æ¯è¿›è¡Œä¿®å¤:', 'info');\n            addResult('- ç«¯ç‚¹è·¯å¾„: /queue â†’ /api/queue', 'info');\n            addResult('- æ·»åŠ  comfy-user è¯·æ±‚å¤´', 'info');\n            addResult('- ä½¿ç”¨æ­£ç¡®çš„ User-Agent', 'info');\n            setTimeout(() => {\n                testNewEndpoint();\n            }, 2000);\n        });\n    </script>\n</body>\n</html>\n"
        }
    ]
}