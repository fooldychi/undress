{
    "sourceFile": "admin/src/views/Config.vue",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1752325471997,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752325524355,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -121,23 +121,196 @@\n   </div>\n </template>\n \n <script setup>\n-import { reactive } from 'vue'\n-import { ElMessage } from 'element-plus'\n+import { ref, reactive, onMounted } from 'vue'\n+import { ElMessage, ElMessageBox } from 'element-plus'\n+import { Check, Connection } from '@element-plus/icons-vue'\n+import { getSystemConfig, saveSystemConfig } from '@/api/config'\n \n+const loading = ref(false)\n+const saving = ref(false)\n+const testing = ref(false)\n+const configForm = ref(null)\n+const connectionStatus = ref(null)\n+\n+// é…ç½®æ•°æ®\n const config = reactive({\n-  systemName: 'iComfy AIå›¾åƒå¤„ç†å¹³å°',\n-  systemDesc: 'ä¸“ä¸šçš„AIå›¾åƒå¤„ç†æœåŠ¡å¹³å°',\n-  defaultPoints: 100,\n-  faceSwapEnabled: true,\n-  clothingSwapEnabled: true,\n-  textToImageEnabled: true\n+  serverUrl: '',\n+  backupServers: '',\n+  requestTimeout: 30000,\n+  healthCheckTimeout: 10000,\n+  autoSwitch: true,\n+  clientId: '',\n+  maxRetries: 3\n })\n \n-const saveConfig = () => {\n-  ElMessage.success('é…ç½®ä¿å­˜æˆåŠŸ')\n+// è¡¨å•éªŒè¯è§„åˆ™\n+const rules = {\n+  serverUrl: [\n+    { required: true, message: 'è¯·è¾“å…¥ä¸»æœåŠ¡å™¨åœ°å€', trigger: 'blur' },\n+    {\n+      pattern: /^https?:\\/\\/.+/,\n+      message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„URLåœ°å€',\n+      trigger: 'blur'\n+    }\n+  ],\n+  requestTimeout: [\n+    { required: true, message: 'è¯·è®¾ç½®è¯·æ±‚è¶…æ—¶æ—¶é—´', trigger: 'blur' },\n+    {\n+      type: 'number',\n+      min: 5000,\n+      max: 600000,\n+      message: 'è¯·æ±‚è¶…æ—¶æ—¶é—´åº”åœ¨5000-600000æ¯«ç§’ä¹‹é—´',\n+      trigger: 'blur'\n+    }\n+  ],\n+  healthCheckTimeout: [\n+    { required: true, message: 'è¯·è®¾ç½®å¥åº·æ£€æŸ¥è¶…æ—¶æ—¶é—´', trigger: 'blur' },\n+    {\n+      type: 'number',\n+      min: 1000,\n+      max: 30000,\n+      message: 'å¥åº·æ£€æŸ¥è¶…æ—¶æ—¶é—´åº”åœ¨1000-30000æ¯«ç§’ä¹‹é—´',\n+      trigger: 'blur'\n+    }\n+  ]\n }\n+\n+// åŠ è½½é…ç½®\n+const loadConfig = async () => {\n+  loading.value = true\n+  try {\n+    const response = await getSystemConfig()\n+    if (response.success && response.data) {\n+      const configData = response.data\n+\n+      // æ˜ å°„é…ç½®æ•°æ®åˆ°è¡¨å•\n+      config.serverUrl = configData['comfyui.server_url'] || ''\n+      config.backupServers = configData['comfyui.backup_servers'] || ''\n+      config.requestTimeout = parseInt(configData['comfyui.request_timeout']) || 30000\n+      config.healthCheckTimeout = parseInt(configData['comfyui.health_check_timeout']) || 10000\n+      config.autoSwitch = configData['comfyui.auto_switch'] === 'true' || configData['comfyui.auto_switch'] === true\n+      config.clientId = configData['comfyui.client_id'] || ''\n+      config.maxRetries = parseInt(configData['comfyui.max_retries']) || 3\n+\n+      ElMessage.success('é…ç½®åŠ è½½æˆåŠŸ')\n+    }\n+  } catch (error) {\n+    console.error('åŠ è½½é…ç½®å¤±è´¥:', error)\n+    ElMessage.error('åŠ è½½é…ç½®å¤±è´¥')\n+  } finally {\n+    loading.value = false\n+  }\n+}\n+\n+// ä¿å­˜é…ç½®\n+const saveConfig = async () => {\n+  if (!configForm.value) return\n+\n+  try {\n+    await configForm.value.validate()\n+  } catch (error) {\n+    ElMessage.warning('è¯·æ£€æŸ¥è¡¨å•è¾“å…¥')\n+    return\n+  }\n+\n+  saving.value = true\n+  try {\n+    // æ„å»ºé…ç½®æ•°æ®\n+    const configs = [\n+      {\n+        config_key: 'comfyui.server_url',\n+        config_value: config.serverUrl,\n+        config_type: 'string',\n+        config_group: 'comfyui'\n+      },\n+      {\n+        config_key: 'comfyui.backup_servers',\n+        config_value: config.backupServers,\n+        config_type: 'string',\n+        config_group: 'comfyui'\n+      },\n+      {\n+        config_key: 'comfyui.request_timeout',\n+        config_value: config.requestTimeout.toString(),\n+        config_type: 'number',\n+        config_group: 'comfyui'\n+      },\n+      {\n+        config_key: 'comfyui.health_check_timeout',\n+        config_value: config.healthCheckTimeout.toString(),\n+        config_type: 'number',\n+        config_group: 'comfyui'\n+      },\n+      {\n+        config_key: 'comfyui.auto_switch',\n+        config_value: config.autoSwitch.toString(),\n+        config_type: 'boolean',\n+        config_group: 'comfyui'\n+      },\n+      {\n+        config_key: 'comfyui.client_id',\n+        config_value: config.clientId,\n+        config_type: 'string',\n+        config_group: 'comfyui'\n+      },\n+      {\n+        config_key: 'comfyui.max_retries',\n+        config_value: config.maxRetries.toString(),\n+        config_type: 'number',\n+        config_group: 'comfyui'\n+      }\n+    ]\n+\n+    const response = await saveSystemConfig(configs)\n+    if (response.success) {\n+      ElMessage.success('é…ç½®ä¿å­˜æˆåŠŸ')\n+      connectionStatus.value = null // é‡ç½®è¿æ¥çŠ¶æ€\n+    } else {\n+      ElMessage.error(response.message || 'é…ç½®ä¿å­˜å¤±è´¥')\n+    }\n+  } catch (error) {\n+    console.error('ä¿å­˜é…ç½®å¤±è´¥:', error)\n+    ElMessage.error('ä¿å­˜é…ç½®å¤±è´¥')\n+  } finally {\n+    saving.value = false\n+  }\n+}\n+\n+// æµ‹è¯•è¿æ¥\n+const testConnection = async () => {\n+  if (!config.serverUrl) {\n+    ElMessage.warning('è¯·å…ˆè¾“å…¥ä¸»æœåŠ¡å™¨åœ°å€')\n+    return\n+  }\n+\n+  testing.value = true\n+  connectionStatus.value = { type: 'warning', text: 'æµ‹è¯•ä¸­...' }\n+\n+  try {\n+    // æ¨¡æ‹Ÿæµ‹è¯•è¿æ¥ï¼ˆå®é™…åº”è¯¥è°ƒç”¨åç«¯APIï¼‰\n+    await new Promise(resolve => setTimeout(resolve, 2000))\n+\n+    // è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„æµ‹è¯•è¿æ¥API\n+    // const response = await testComfyUIConnection(config.serverUrl)\n+\n+    // æ¨¡æ‹ŸæˆåŠŸç»“æœ\n+    connectionStatus.value = { type: 'success', text: 'è¿æ¥æ­£å¸¸' }\n+    ElMessage.success('ComfyUIæœåŠ¡å™¨è¿æ¥æµ‹è¯•æˆåŠŸ')\n+  } catch (error) {\n+    console.error('è¿æ¥æµ‹è¯•å¤±è´¥:', error)\n+    connectionStatus.value = { type: 'danger', text: 'è¿æ¥å¤±è´¥' }\n+    ElMessage.error('ComfyUIæœåŠ¡å™¨è¿æ¥æµ‹è¯•å¤±è´¥')\n+  } finally {\n+    testing.value = false\n+  }\n+}\n+\n+// é¡µé¢åŠ è½½æ—¶è·å–é…ç½®\n+onMounted(() => {\n+  loadConfig()\n+})\n </script>\n \n <style scoped>\n .config-page {\n"
                },
                {
                    "date": 1752325551808,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -315,8 +315,9 @@\n <style scoped>\n .config-page {\n   max-width: 1200px;\n   margin: 0 auto;\n+  padding: 20px;\n }\n \n .page-header {\n   display: flex;\n@@ -324,11 +325,50 @@\n   align-items: center;\n   margin-bottom: 20px;\n }\n \n+.header-actions {\n+  display: flex;\n+  gap: 12px;\n+}\n+\n .page-title {\n   font-size: 24px;\n   font-weight: 600;\n   color: #303133;\n   margin: 0;\n }\n+\n+.card-header {\n+  display: flex;\n+  justify-content: space-between;\n+  align-items: center;\n+  width: 100%;\n+}\n+\n+.form-tip {\n+  font-size: 12px;\n+  color: #909399;\n+  margin-top: 4px;\n+  line-height: 1.4;\n+}\n+\n+:deep(.el-form-item__label) {\n+  font-weight: 500;\n+}\n+\n+:deep(.el-input-group__prepend) {\n+  background-color: #f5f7fa;\n+  color: #909399;\n+  border-color: #dcdfe6;\n+}\n+\n+:deep(.el-divider__text) {\n+  font-weight: 500;\n+  color: #606266;\n+}\n+\n+.el-card {\n+  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);\n+  border-radius: 8px;\n+}\n </style>\n"
                },
                {
                    "date": 1752325660995,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -124,9 +124,9 @@\n <script setup>\n import { ref, reactive, onMounted } from 'vue'\n import { ElMessage, ElMessageBox } from 'element-plus'\n import { Check, Connection } from '@element-plus/icons-vue'\n-import { getSystemConfig, saveSystemConfig } from '@/api/config'\n+import { getSystemConfig, saveSystemConfig, testComfyUIConnection } from '@/api/config'\n \n const loading = ref(false)\n const saving = ref(false)\n const testing = ref(false)\n"
                },
                {
                    "date": 1752325684460,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -287,17 +287,17 @@\n   testing.value = true\n   connectionStatus.value = { type: 'warning', text: 'æµ‹è¯•ä¸­...' }\n \n   try {\n-    // æ¨¡æ‹Ÿæµ‹è¯•è¿æ¥ï¼ˆå®é™…åº”è¯¥è°ƒç”¨åç«¯APIï¼‰\n-    await new Promise(resolve => setTimeout(resolve, 2000))\n+    const response = await testComfyUIConnection(config.serverUrl, config.healthCheckTimeout)\n \n-    // è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„æµ‹è¯•è¿æ¥API\n-    // const response = await testComfyUIConnection(config.serverUrl)\n-\n-    // æ¨¡æ‹ŸæˆåŠŸç»“æœ\n-    connectionStatus.value = { type: 'success', text: 'è¿æ¥æ­£å¸¸' }\n-    ElMessage.success('ComfyUIæœåŠ¡å™¨è¿æ¥æµ‹è¯•æˆåŠŸ')\n+    if (response.success) {\n+      connectionStatus.value = { type: 'success', text: 'è¿æ¥æ­£å¸¸' }\n+      ElMessage.success(response.message || 'ComfyUIæœåŠ¡å™¨è¿æ¥æµ‹è¯•æˆåŠŸ')\n+    } else {\n+      connectionStatus.value = { type: 'danger', text: 'è¿æ¥å¤±è´¥' }\n+      ElMessage.error(response.message || 'ComfyUIæœåŠ¡å™¨è¿æ¥æµ‹è¯•å¤±è´¥')\n+    }\n   } catch (error) {\n     console.error('è¿æ¥æµ‹è¯•å¤±è´¥:', error)\n     connectionStatus.value = { type: 'danger', text: 'è¿æ¥å¤±è´¥' }\n     ElMessage.error('ComfyUIæœåŠ¡å™¨è¿æ¥æµ‹è¯•å¤±è´¥')\n"
                }
            ],
            "date": 1752325471997,
            "name": "Commit-0",
            "content": "<template>\n  <div class=\"config-page\">\n    <div class=\"page-header\">\n      <h1 class=\"page-title\">ç³»ç»Ÿé…ç½®</h1>\n      <div class=\"header-actions\">\n        <el-button @click=\"testConnection\" :loading=\"testing\">\n          <el-icon><Connection /></el-icon>\n          æµ‹è¯•è¿æ¥\n        </el-button>\n        <el-button type=\"primary\" @click=\"saveConfig\" :loading=\"saving\">\n          <el-icon><Check /></el-icon>\n          ä¿å­˜é…ç½®\n        </el-button>\n      </div>\n    </div>\n\n    <el-card>\n      <template #header>\n        <div class=\"card-header\">\n          <span>ğŸ–¥ï¸ ComfyUIæœåŠ¡å™¨é…ç½®</span>\n          <el-tag v-if=\"connectionStatus\" :type=\"connectionStatus.type\" size=\"small\">\n            {{ connectionStatus.text }}\n          </el-tag>\n        </div>\n      </template>\n\n      <el-form\n        :model=\"config\"\n        :rules=\"rules\"\n        ref=\"configForm\"\n        label-width=\"180px\"\n        v-loading=\"loading\"\n      >\n        <el-row :gutter=\"20\">\n          <el-col :span=\"12\">\n            <el-form-item label=\"ä¸»æœåŠ¡å™¨åœ°å€\" prop=\"serverUrl\" required>\n              <el-input\n                v-model=\"config.serverUrl\"\n                placeholder=\"https://your-comfyui-server.com\"\n                clearable\n              >\n                <template #prepend>HTTPS://</template>\n              </el-input>\n              <div class=\"form-tip\">ComfyUIä¸»æœåŠ¡å™¨çš„å®Œæ•´åœ°å€</div>\n            </el-form-item>\n\n            <el-form-item label=\"å¤‡ç”¨æœåŠ¡å™¨åœ°å€\" prop=\"backupServers\">\n              <el-input\n                v-model=\"config.backupServers\"\n                type=\"textarea\"\n                :rows=\"3\"\n                placeholder=\"https://backup1.example.com&#10;https://backup2.example.com\"\n                clearable\n              />\n              <div class=\"form-tip\">æ¯è¡Œä¸€ä¸ªå¤‡ç”¨æœåŠ¡å™¨åœ°å€ï¼Œä¸»æœåŠ¡å™¨ä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢</div>\n            </el-form-item>\n          </el-col>\n\n          <el-col :span=\"12\">\n            <el-form-item label=\"è¯·æ±‚è¶…æ—¶æ—¶é—´\" prop=\"requestTimeout\" required>\n              <el-input-number\n                v-model=\"config.requestTimeout\"\n                :min=\"5000\"\n                :max=\"600000\"\n                :step=\"1000\"\n                style=\"width: 100%\"\n              />\n              <div class=\"form-tip\">å•ä½ï¼šæ¯«ç§’ï¼Œå»ºè®®è®¾ç½®ä¸º30000-300000</div>\n            </el-form-item>\n\n            <el-form-item label=\"å¥åº·æ£€æŸ¥è¶…æ—¶æ—¶é—´\" prop=\"healthCheckTimeout\" required>\n              <el-input-number\n                v-model=\"config.healthCheckTimeout\"\n                :min=\"1000\"\n                :max=\"30000\"\n                :step=\"1000\"\n                style=\"width: 100%\"\n              />\n              <div class=\"form-tip\">å•ä½ï¼šæ¯«ç§’ï¼Œå»ºè®®è®¾ç½®ä¸º5000-15000</div>\n            </el-form-item>\n\n            <el-form-item label=\"è‡ªåŠ¨åˆ‡æ¢å¤‡ç”¨æœåŠ¡å™¨\">\n              <el-switch\n                v-model=\"config.autoSwitch\"\n                active-text=\"å¯ç”¨\"\n                inactive-text=\"ç¦ç”¨\"\n              />\n              <div class=\"form-tip\">ä¸»æœåŠ¡å™¨æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡å™¨</div>\n            </el-form-item>\n          </el-col>\n        </el-row>\n\n        <el-divider content-position=\"left\">é«˜çº§è®¾ç½®</el-divider>\n\n        <el-row :gutter=\"20\">\n          <el-col :span=\"12\">\n            <el-form-item label=\"å®¢æˆ·ç«¯ID\" prop=\"clientId\">\n              <el-input\n                v-model=\"config.clientId\"\n                placeholder=\"your-comfyui-client-id\"\n                clearable\n              />\n              <div class=\"form-tip\">ComfyUIå®¢æˆ·ç«¯æ ‡è¯†ç¬¦ï¼ˆå¯é€‰ï¼‰</div>\n            </el-form-item>\n          </el-col>\n\n          <el-col :span=\"12\">\n            <el-form-item label=\"æœ€å¤§é‡è¯•æ¬¡æ•°\" prop=\"maxRetries\">\n              <el-input-number\n                v-model=\"config.maxRetries\"\n                :min=\"0\"\n                :max=\"10\"\n                style=\"width: 100%\"\n              />\n              <div class=\"form-tip\">è¯·æ±‚å¤±è´¥æ—¶çš„æœ€å¤§é‡è¯•æ¬¡æ•°</div>\n            </el-form-item>\n          </el-col>\n        </el-row>\n      </el-form>\n    </el-card>\n  </div>\n</template>\n\n<script setup>\nimport { reactive } from 'vue'\nimport { ElMessage } from 'element-plus'\n\nconst config = reactive({\n  systemName: 'iComfy AIå›¾åƒå¤„ç†å¹³å°',\n  systemDesc: 'ä¸“ä¸šçš„AIå›¾åƒå¤„ç†æœåŠ¡å¹³å°',\n  defaultPoints: 100,\n  faceSwapEnabled: true,\n  clothingSwapEnabled: true,\n  textToImageEnabled: true\n})\n\nconst saveConfig = () => {\n  ElMessage.success('é…ç½®ä¿å­˜æˆåŠŸ')\n}\n</script>\n\n<style scoped>\n.config-page {\n  max-width: 1200px;\n  margin: 0 auto;\n}\n\n.page-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-bottom: 20px;\n}\n\n.page-title {\n  font-size: 24px;\n  font-weight: 600;\n  color: #303133;\n  margin: 0;\n}\n</style>\n"
        }
    ]
}