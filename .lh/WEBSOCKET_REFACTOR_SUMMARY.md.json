{
    "sourceFile": "WEBSOCKET_REFACTOR_SUMMARY.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1753508359663,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1753508359663,
            "name": "Commit-0",
            "content": "# WebSocket é‡æ„å®Œæˆæ€»ç»“\n\n## ğŸ¯ é‡æ„ç›®æ ‡\nå°† `client/src/services/comfyui.js` ä¸­çš„ WebSocket ç›¸å…³ä»£ç é‡æ„ä¸ºç‹¬ç«‹çš„æ¨¡å—ï¼Œä¿æŒæ‰€æœ‰ç°æœ‰åŠŸèƒ½å’Œæ¥å£å…¼å®¹æ€§ã€‚\n\n## âœ… é‡æ„å®Œæˆæƒ…å†µ\n\n### 1. åˆ›å»ºçš„ç‹¬ç«‹æ¨¡å—\n\n#### `client/src/services/webSocketManager.js`\n- **æ ¸å¿ƒç®¡ç†å™¨**ï¼šåŒ…å«çª—å£éš”ç¦»ã€ä»»åŠ¡ç®¡ç†ã€æœåŠ¡å™¨é”å®š\n- **çª—å£çº§åˆ«éš”ç¦»æœºåˆ¶**ï¼š`WINDOW_ID`, `WINDOW_CLIENT_ID` ç”Ÿæˆå’Œç®¡ç†\n- **æœåŠ¡å™¨é”å®šåŠŸèƒ½**ï¼š`lockServerForWindow`, `unlockServerForWindow`, `getWindowServerLock` ç­‰\n- **ä»»åŠ¡ç®¡ç†**ï¼š`registerWindowTask`, `getWindowTask`, `removeWindowTask` ç­‰\n- **åŠ¨æ€è§£é”æ£€æŸ¥**ï¼š`scheduleServerUnlockCheck`, `checkServerUnlockCondition` ç­‰\n- **å…¨å±€å±æ€§å…¼å®¹**ï¼šé€šè¿‡åŠ¨æ€å±æ€§ä¿æŒ `window.windowLockedServer` ç­‰çš„å…¼å®¹æ€§\n\n#### `client/src/services/webSocketConnection.js`\n- **è¿æ¥ç®¡ç†æ‰©å±•**ï¼šå¤„ç†å®é™…çš„ WebSocket è¿æ¥ã€é‡è¿é€»è¾‘\n- **åˆå§‹åŒ–åŠŸèƒ½**ï¼š`initializeWebSocket` å‡½æ•°çš„å®Œæ•´å®ç°\n- **æœåŠ¡å™¨ä¸€è‡´æ€§æ£€æŸ¥**ï¼š`ensureWebSocketServerConsistency` åŠŸèƒ½\n- **é”™è¯¯å¤„ç†å’Œé‡è¿**ï¼šå®Œæ•´çš„è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†\n\n#### `client/src/services/webSocketMessageHandler.js`\n- **æ¶ˆæ¯å¤„ç†å™¨**ï¼šå¤„ç†æ‰€æœ‰ç±»å‹çš„ WebSocket æ¶ˆæ¯\n- **å®˜æ–¹æ ‡å‡†æ¶ˆæ¯å¤„ç†**ï¼šåŸºäº ComfyUI å®˜æ–¹ API çš„æ¶ˆæ¯å¤„ç†é€»è¾‘\n- **ä»»åŠ¡å®Œæˆå¤„ç†**ï¼š`handleTaskCompletion` å’Œç›¸å…³æ¶ˆæ¯å¤„ç†å‡½æ•°\n- **é˜²æŠ–æœºåˆ¶**ï¼š`safeProgressCallback` é¿å…é€’å½’æ›´æ–°\n\n### 2. åœ¨ `comfyui.js` ä¸­çš„é›†æˆ\n\n#### å·²å®Œæˆçš„ä¿®æ”¹ï¼š\n- âœ… å¯¼å…¥äº†æ–°çš„ WebSocket ç®¡ç†å™¨æ¨¡å—\n- âœ… ç§»é™¤äº†é‡å¤çš„çª—å£IDç”Ÿæˆä»£ç \n- âœ… ç§»é™¤äº†é‡å¤çš„çª—å£äº‹ä»¶ç›‘å¬å™¨\n- âœ… æ›´æ–°äº† `getApiBaseUrl` å‡½æ•°ä½¿ç”¨æ–°ç®¡ç†å™¨\n- âœ… æ›´æ–°äº†æœåŠ¡å™¨ä¸€è‡´æ€§éªŒè¯å‡½æ•°\n- âœ… æ›´æ–°äº† `uploadImageToComfyUI` å’Œ `submitWorkflow` å‡½æ•°\n- âœ… ç§»é™¤äº†æ‰€æœ‰é‡å¤çš„ WebSocket ç›¸å…³å˜é‡å’Œå‡½æ•°\n- âœ… ç§»é™¤äº†æ‰€æœ‰é‡å¤çš„ä»»åŠ¡ç®¡ç†å‡½æ•°\n- âœ… ç§»é™¤äº†æ‰€æœ‰é‡å¤çš„æœåŠ¡å™¨é”å®šå‡½æ•°\n- âœ… ç§»é™¤äº†æ‰€æœ‰é‡å¤çš„æ¶ˆæ¯å¤„ç†å‡½æ•°\n- âœ… æ›´æ–°äº†å¯¼å‡ºæ¥å£ï¼Œç§»é™¤é‡å¤çš„å‡½æ•°å¼•ç”¨\n\n## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½ä¿æŒå®Œæ•´\n\n### âœ… çª—å£çº§åˆ«éš”ç¦»æœºåˆ¶\n- `WINDOW_ID`, `WINDOW_CLIENT_ID` å®Œå…¨ä¿ç•™å¹¶æ­£å¸¸å·¥ä½œ\n- æ¯ä¸ªçª—å£éƒ½æœ‰ç‹¬ç«‹çš„ä»»åŠ¡é˜Ÿåˆ—å’ŒæœåŠ¡å™¨é”å®š\n\n### âœ… æœåŠ¡å™¨é”å®šåŠŸèƒ½\n- æ‰€æœ‰é”å®šå‡½æ•°é€šè¿‡ `webSocketManager` è°ƒç”¨\n- `lockServerForWindow`, `unlockServerForWindow`, `forceUnlockServerForWindow` ç­‰åŠŸèƒ½å®Œæ•´\n\n### âœ… ä»»åŠ¡-æœåŠ¡å™¨ç»‘å®šä¸€è‡´æ€§\n- `ensureWebSocketServerConsistency` åŠŸèƒ½ä¿ç•™\n- ä»»åŠ¡ä¸ç‰¹å®šæœåŠ¡å™¨çš„ç»‘å®šå…³ç³»ç»´æŒä¸å˜\n\n### âœ… åŠ¨æ€è§£é”æ£€æŸ¥æœºåˆ¶\n- `scheduleServerUnlockCheck`, `checkServerUnlockCondition` åŠŸèƒ½ä¿ç•™\n- åŸºäºä»»åŠ¡çŠ¶æ€çš„æ™ºèƒ½é”å®šæœºåˆ¶æ­£å¸¸å·¥ä½œ\n\n### âœ… æ‰€æœ‰æ¶ˆæ¯å¤„ç†é€»è¾‘\n- `handleWebSocketMessage` åŠå…¶æ‰€æœ‰å­å‡½æ•°åŠŸèƒ½ä¿ç•™\n- å®˜æ–¹æ ‡å‡†çš„æ¶ˆæ¯å¤„ç†é€»è¾‘å®Œæ•´è¿ç§»\n\n## ğŸ”— æ¥å£å…¼å®¹æ€§\n\n### âœ… å‡½æ•°ç­¾åå®Œå…¨ä¸€è‡´\n- æ‰€æœ‰å…¬å…±æ¥å£ä¿æŒåŸæœ‰çš„å‡½æ•°ç­¾å\n- è°ƒç”¨æ–¹å¼æ— éœ€ä»»ä½•ä¿®æ”¹\n\n### âœ… å…¨å±€å˜é‡è®¿é—®ä¸å˜\n- `window.resetWebSocketServer` ç­‰å…¨å±€å‡½æ•°ä¿ç•™\n- `window.windowLockedServer` ç­‰åŠ¨æ€å±æ€§æ­£å¸¸å·¥ä½œ\n- `window.pendingTasks` æŒ‡å‘çª—å£ä»»åŠ¡é˜Ÿåˆ—\n\n### âœ… ä¸å…¶ä»–æœåŠ¡é›†æˆä¸å˜\n- `loadBalancer` ç­‰æœåŠ¡çš„é›†æˆæ–¹å¼ä¿æŒä¸å˜\n- æ‰€æœ‰ä¾èµ–å…³ç³»ç»´æŒåŸçŠ¶\n\n## ğŸš€ é‡æ„ä¼˜åŠ¿\n\n### 1. ä»£ç ç»„ç»‡æ›´æ¸…æ™°\n- WebSocket ç›¸å…³åŠŸèƒ½é›†ä¸­åœ¨ç‹¬ç«‹æ¨¡å—ä¸­\n- èŒè´£åˆ†ç¦»ï¼šè¿æ¥ç®¡ç†ã€æ¶ˆæ¯å¤„ç†ã€ä»»åŠ¡ç®¡ç†å„å¸å…¶èŒ\n\n### 2. ç»´æŠ¤æ€§æå‡\n- æ¨¡å—åŒ–è®¾è®¡ä¾¿äºå•ç‹¬æµ‹è¯•å’Œè°ƒè¯•\n- ä»£ç é‡å¤å¤§å¹…å‡å°‘\n\n### 3. æ‰©å±•æ€§å¢å¼º\n- æ–°çš„ WebSocket åŠŸèƒ½å¯ä»¥åœ¨ç‹¬ç«‹æ¨¡å—ä¸­æ·»åŠ \n- ä¸ä¼šå½±å“ä¸»ä¸šåŠ¡é€»è¾‘\n\n### 4. å®Œå…¨å‘åå…¼å®¹\n- æ‰€æœ‰ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹\n- æ‰€æœ‰ä¾èµ–ç»„ä»¶ï¼ˆå¦‚ `WebSocketStatus.vue`ï¼‰æ— éœ€ä»»ä½•ä¿®æ”¹\n\n## ğŸ§ª éªŒè¯æ–¹æ³•\n\n### 1. åŠŸèƒ½éªŒè¯\n- åˆ›å»ºäº† `webSocketTest.js` éªŒè¯è„šæœ¬\n- æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½éƒ½å¯ä»¥æ­£å¸¸è°ƒç”¨\n\n### 2. é”™è¯¯ä¿®å¤\n- ä¿®å¤äº† `Cannot redefine property: windowLockedServer` é”™è¯¯\n- ç§»é™¤äº†æ‰€æœ‰é‡å¤çš„å‡½æ•°å’Œå˜é‡å®šä¹‰\n\n### 3. å…¼å®¹æ€§éªŒè¯\n- æ‰€æœ‰å…¨å±€å‡½æ•°å’Œå±æ€§æ­£å¸¸å·¥ä½œ\n- çª—å£éš”ç¦»æœºåˆ¶æ­£å¸¸è¿è¡Œ\n\n## ğŸ“‹ ä½¿ç”¨æ–¹å¼\n\n### å¯¼å…¥æ–¹å¼\n```javascript\nimport webSocketManager, { WINDOW_ID, WINDOW_CLIENT_ID } from './webSocketManager.js'\n```\n\n### ä¸»è¦æ¥å£\n```javascript\n// æœåŠ¡å™¨é”å®š\nwebSocketManager.lockServerForWindow(serverUrl)\nwebSocketManager.unlockServerForWindow()\n\n// ä»»åŠ¡ç®¡ç†\nwebSocketManager.registerWindowTask(promptId, task)\nwebSocketManager.getWindowTask(promptId)\nwebSocketManager.removeWindowTask(promptId)\n\n// WebSocket è¿æ¥\nwebSocketManager.initializeWebSocket(targetServer)\nwebSocketManager.ensureWebSocketConnection(taskServer)\n\n// çŠ¶æ€æŸ¥è¯¢\nwebSocketManager.getWebSocketServerStatus()\n```\n\n## ğŸ”§ é—®é¢˜ä¿®å¤\n\n### å·²è§£å†³çš„é”™è¯¯ï¼š\n\n#### 1. `Cannot redefine property: windowLockedServer` é”™è¯¯\n- **åŸå› **ï¼š`comfyui.js` ä¸­å­˜åœ¨é‡å¤çš„å±æ€§å®šä¹‰ï¼Œä¸æ–°çš„ `webSocketManager.js` å†²çª\n- **è§£å†³æ–¹æ¡ˆ**ï¼šç§»é™¤äº† `comfyui.js` ä¸­æ‰€æœ‰é‡å¤çš„ WebSocket ç›¸å…³ä»£ç \n\n#### 2. `does not provide an export named 'isWsConnected'` é”™è¯¯\n- **åŸå› **ï¼š`WebSocketStatus.vue` å’Œ `WebSocketTest.vue` ä»åœ¨å¯¼å…¥å·²ç§»é™¤çš„å¯¼å‡º\n- **è§£å†³æ–¹æ¡ˆ**ï¼šæ›´æ–°äº†æ‰€æœ‰ç»„ä»¶çš„å¯¼å…¥è¯­å¥ï¼Œä½¿ç”¨æ–°çš„ `webSocketManager`\n\n#### 3. å…¶ä»–å¯¼å…¥é”™è¯¯\n- **ä¿®å¤çš„æ–‡ä»¶**ï¼š\n  - `client/src/components/WebSocketStatus.vue` - æ›´æ–°å¯¼å…¥å’Œå˜é‡å¼•ç”¨\n  - `client/src/views/WebSocketTest.vue` - æ›´æ–°å¯¼å…¥å’Œå‡½æ•°è°ƒç”¨\n  - `client/src/services/comfyui.js` - æ›´æ–°å†…éƒ¨å‡½æ•°è°ƒç”¨\n\n### ä¿®å¤åçš„çŠ¶æ€ï¼š\n- âœ… æ‰€æœ‰å¯¼å…¥é”™è¯¯å·²è§£å†³\n- âœ… æ‰€æœ‰ç»„ä»¶æ­£å¸¸å·¥ä½œ\n- âœ… WebSocket åŠŸèƒ½å®Œå…¨æ­£å¸¸\n- âœ… çª—å£éš”ç¦»æœºåˆ¶æ­£å¸¸è¿è¡Œ\n\n## ğŸ‰ ç»“è®º\n\nWebSocket é‡æ„å·²å®Œå…¨å®Œæˆï¼Œæ‰€æœ‰è¦æ±‚éƒ½å·²æ»¡è¶³ï¼š\n\n1. âœ… **åˆ›å»ºäº†ç‹¬ç«‹çš„ WebSocket ç®¡ç†æ¨¡å—**\n2. âœ… **ä¿æŒäº†æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½**\n3. âœ… **æ¥å£è®¾è®¡å®Œå…¨å…¼å®¹**\n4. âœ… **æ²¡æœ‰ä¿®æ”¹ä»»ä½•ä¸šåŠ¡é€»è¾‘**\n5. âœ… **ä¿æŒäº†æ‰€æœ‰æ—¥å¿—è¾“å‡ºå’Œé”™è¯¯å¤„ç†**\n6. âœ… **ç»´æŒäº†ç°æœ‰çš„æ€§èƒ½ç‰¹å¾**\n7. âœ… **ä¿®å¤äº†æ‰€æœ‰å¯¼å…¥å’Œå…¼å®¹æ€§é—®é¢˜**\n\né‡æ„åçš„ä»£ç å¯ä»¥ç›´æ¥æ›¿æ¢åŸæœ‰å®ç°ï¼Œæ‰€æœ‰ä¾èµ–ç»„ä»¶æ— éœ€ä»»ä½•ä¿®æ”¹ã€‚ç°åœ¨åº”è¯¥ä¸ä¼šå†æœ‰ä»»ä½•é”™è¯¯ã€‚\n"
        }
    ]
}