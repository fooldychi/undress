{
    "sourceFile": "client/src/utils/progressStageManager.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 5,
            "patches": [
                {
                    "date": 1753532700663,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1753532716402,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -84,8 +84,9 @@\n           currentNode: 0,\n           totalNodes: 0,\n           percentage: 0\n         }\n+        this.executedNodes.clear()\n       }\n \n       this._notifyCallbacks()\n     }\n"
                },
                {
                    "date": 1753532735623,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -109,24 +109,39 @@\n     this._notifyCallbacks()\n   }\n \n   /**\n+   * è®¾ç½®å·¥ä½œæµèŠ‚ç‚¹åˆ—è¡¨\n+   * @param {Array} nodeIds - æ‰€æœ‰èŠ‚ç‚¹IDåˆ—è¡¨\n+   */\n+  setWorkflowNodes(nodeIds) {\n+    this.allNodeIds = [...nodeIds]\n+    this.workflowProgress.totalNodes = nodeIds.length\n+    console.log(`ğŸ“Š è®¾ç½®å·¥ä½œæµèŠ‚ç‚¹åˆ—è¡¨: ${nodeIds.length}ä¸ªèŠ‚ç‚¹`, nodeIds)\n+  }\n+\n+  /**\n    * ä»èŠ‚ç‚¹IDè§£æè¿›åº¦ï¼ˆComfyUIèŠ‚ç‚¹æ‰§è¡Œæ¶ˆæ¯ï¼‰\n    * @param {string} nodeId - èŠ‚ç‚¹ID\n-   * @param {number} totalNodes - æ€»èŠ‚ç‚¹æ•°ï¼ˆå¯é€‰ï¼Œå¦‚æœå·²çŸ¥ï¼‰\n    */\n-  updateFromNodeExecution(nodeId, totalNodes = null) {\n-    // å°è¯•ä»èŠ‚ç‚¹IDä¸­æå–æ•°å­—ä½œä¸ºå½“å‰èŠ‚ç‚¹\n-    const nodeNumber = parseInt(nodeId) || 0\n+  updateFromNodeExecution(nodeId) {\n+    if (!nodeId) return\n \n-    if (totalNodes !== null) {\n-      this.updateWorkflowProgress(nodeNumber, totalNodes)\n+    // è®°å½•å·²æ‰§è¡Œçš„èŠ‚ç‚¹\n+    this.executedNodes.add(nodeId)\n+\n+    // è®¡ç®—å½“å‰è¿›åº¦\n+    const currentNode = this.executedNodes.size\n+    const totalNodes = this.workflowProgress.totalNodes || this.allNodeIds.length\n+\n+    if (totalNodes > 0) {\n+      this.updateWorkflowProgress(currentNode, totalNodes)\n     } else {\n       // å¦‚æœä¸çŸ¥é“æ€»èŠ‚ç‚¹æ•°ï¼Œåªæ›´æ–°å½“å‰èŠ‚ç‚¹\n       this.currentStage = PROGRESS_STAGES.PROCESSING\n-      this.workflowProgress.currentNode = nodeNumber\n+      this.workflowProgress.currentNode = currentNode\n \n-      console.log(`ğŸ“Š å·¥ä½œæµæ‰§è¡ŒèŠ‚ç‚¹: ${nodeId}`)\n+      console.log(`ğŸ“Š å·¥ä½œæµæ‰§è¡ŒèŠ‚ç‚¹: ${nodeId} (å·²æ‰§è¡Œ: ${currentNode})`)\n       this._notifyCallbacks()\n     }\n   }\n \n"
                },
                {
                    "date": 1753532751054,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -182,8 +182,10 @@\n       currentNode: 0,\n       totalNodes: 0,\n       percentage: 0\n     }\n+    this.executedNodes.clear()\n+    this.allNodeIds = []\n     console.log('ğŸ”„ è¿›åº¦çŠ¶æ€å·²é‡ç½®')\n   }\n \n   /**\n"
                },
                {
                    "date": 1753532767567,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -217,27 +217,36 @@\n   return new ProgressStageManager()\n }\n \n /**\n- * è§£æComfyUIå·¥ä½œæµJSONï¼Œè·å–æ€»èŠ‚ç‚¹æ•°\n+ * è§£æComfyUIå·¥ä½œæµJSONï¼Œè·å–æ‰€æœ‰èŠ‚ç‚¹ID\n  * @param {Object} workflow - å·¥ä½œæµJSONå¯¹è±¡\n- * @returns {number} æ€»èŠ‚ç‚¹æ•°\n+ * @returns {Array} èŠ‚ç‚¹IDåˆ—è¡¨\n  */\n-export function getWorkflowTotalNodes(workflow) {\n+export function getWorkflowNodeIds(workflow) {\n   if (!workflow || typeof workflow !== 'object') {\n-    return 0\n+    return []\n   }\n \n   // ComfyUIå·¥ä½œæµçš„èŠ‚ç‚¹å­˜å‚¨åœ¨æ ¹çº§åˆ«ï¼Œæ¯ä¸ªé”®æ˜¯èŠ‚ç‚¹ID\n   const nodeIds = Object.keys(workflow).filter(key => {\n     const node = workflow[key]\n     return node && typeof node === 'object' && node.class_type\n   })\n \n-  return nodeIds.length\n+  return nodeIds\n }\n \n /**\n+ * è§£æComfyUIå·¥ä½œæµJSONï¼Œè·å–æ€»èŠ‚ç‚¹æ•°\n+ * @param {Object} workflow - å·¥ä½œæµJSONå¯¹è±¡\n+ * @returns {number} æ€»èŠ‚ç‚¹æ•°\n+ */\n+export function getWorkflowTotalNodes(workflow) {\n+  return getWorkflowNodeIds(workflow).length\n+}\n+\n+/**\n  * ä»èŠ‚ç‚¹IDæå–æ•°å­—\n  * @param {string} nodeId - èŠ‚ç‚¹ID\n  * @returns {number} æå–çš„æ•°å­—ï¼Œå¦‚æœæ— æ³•æå–åˆ™è¿”å›0\n  */\n"
                },
                {
                    "date": 1753556136642,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -59,15 +59,18 @@\n    * è§¦å‘æ‰€æœ‰å›è°ƒ\n    */\n   _notifyCallbacks() {\n     const message = this.getCurrentMessage()\n-    this.callbacks.forEach(callback => {\n-      try {\n-        callback(this.currentStage, message, { ...this.workflowProgress })\n-      } catch (error) {\n-        console.error('è¿›åº¦å›è°ƒæ‰§è¡Œé”™è¯¯:', error)\n-      }\n-    })\n+    // ä½¿ç”¨ setTimeout é¿å…é€’å½’æ›´æ–°\n+    setTimeout(() => {\n+      this.callbacks.forEach(callback => {\n+        try {\n+          callback(this.currentStage, message, { ...this.workflowProgress })\n+        } catch (error) {\n+          console.error('è¿›åº¦å›è°ƒæ‰§è¡Œé”™è¯¯:', error)\n+        }\n+      })\n+    }, 0)\n   }\n \n   /**\n    * è®¾ç½®å½“å‰é˜¶æ®µ\n"
                }
            ],
            "date": 1753532700663,
            "name": "Commit-0",
            "content": "/**\n * å›¾ç‰‡å¤„ç†è¿›åº¦é˜¶æ®µç®¡ç†å™¨\n * å®ç°åŸºäºå®é™…é˜¶æ®µçš„è¿›åº¦æ˜¾ç¤ºï¼Œè€Œä¸æ˜¯è¯¯å¯¼æ€§çš„ç™¾åˆ†æ¯”\n */\n\n// è¿›åº¦é˜¶æ®µå®šä¹‰\nexport const PROGRESS_STAGES = {\n  UPLOADING: 'uploading',\n  SUBMITTING: 'submitting',\n  QUEUING: 'queuing',\n  PROCESSING: 'processing',\n  COMPLETED: 'completed',\n  ERROR: 'error'\n}\n\n// é˜¶æ®µæ˜¾ç¤ºæ–‡æœ¬æ˜ å°„\nexport const STAGE_TEXTS = {\n  [PROGRESS_STAGES.UPLOADING]: 'å›¾ç‰‡ä¸Šä¼ ä¸­...',\n  [PROGRESS_STAGES.SUBMITTING]: 'æäº¤ä»»åŠ¡ä¸­...',\n  [PROGRESS_STAGES.QUEUING]: 'é˜Ÿåˆ—ä¸­...',\n  [PROGRESS_STAGES.PROCESSING]: 'å·¥ä½œæµæ‰§è¡Œä¸­...',\n  [PROGRESS_STAGES.COMPLETED]: 'å¤„ç†å®Œæˆ',\n  [PROGRESS_STAGES.ERROR]: 'å¤„ç†å¤±è´¥'\n}\n\n/**\n * è¿›åº¦é˜¶æ®µç®¡ç†å™¨ç±»\n */\nexport class ProgressStageManager {\n  constructor() {\n    this.currentStage = null\n    this.workflowProgress = {\n      currentNode: 0,\n      totalNodes: 0,\n      percentage: 0\n    }\n    this.callbacks = new Set()\n    this.executedNodes = new Set() // è®°å½•å·²æ‰§è¡Œçš„èŠ‚ç‚¹ID\n    this.allNodeIds = [] // å­˜å‚¨æ‰€æœ‰èŠ‚ç‚¹IDåˆ—è¡¨\n  }\n\n  /**\n   * æ·»åŠ è¿›åº¦å›è°ƒ\n   * @param {Function} callback - å›è°ƒå‡½æ•° (stage, message, workflowProgress) => void\n   */\n  addCallback(callback) {\n    this.callbacks.add(callback)\n  }\n\n  /**\n   * ç§»é™¤è¿›åº¦å›è°ƒ\n   * @param {Function} callback - å›è°ƒå‡½æ•°\n   */\n  removeCallback(callback) {\n    this.callbacks.delete(callback)\n  }\n\n  /**\n   * è§¦å‘æ‰€æœ‰å›è°ƒ\n   */\n  _notifyCallbacks() {\n    const message = this.getCurrentMessage()\n    this.callbacks.forEach(callback => {\n      try {\n        callback(this.currentStage, message, { ...this.workflowProgress })\n      } catch (error) {\n        console.error('è¿›åº¦å›è°ƒæ‰§è¡Œé”™è¯¯:', error)\n      }\n    })\n  }\n\n  /**\n   * è®¾ç½®å½“å‰é˜¶æ®µ\n   * @param {string} stage - é˜¶æ®µæ ‡è¯†\n   */\n  setStage(stage) {\n    if (this.currentStage !== stage) {\n      this.currentStage = stage\n      console.log(`ğŸ”„ è¿›åº¦é˜¶æ®µæ›´æ–°: ${stage}`)\n\n      // é‡ç½®å·¥ä½œæµè¿›åº¦ï¼ˆé™¤éæ˜¯å¤„ç†é˜¶æ®µï¼‰\n      if (stage !== PROGRESS_STAGES.PROCESSING) {\n        this.workflowProgress = {\n          currentNode: 0,\n          totalNodes: 0,\n          percentage: 0\n        }\n      }\n\n      this._notifyCallbacks()\n    }\n  }\n\n  /**\n   * æ›´æ–°å·¥ä½œæµæ‰§è¡Œè¿›åº¦\n   * @param {number} currentNode - å½“å‰èŠ‚ç‚¹æ•°\n   * @param {number} totalNodes - æ€»èŠ‚ç‚¹æ•°\n   */\n  updateWorkflowProgress(currentNode, totalNodes) {\n    this.currentStage = PROGRESS_STAGES.PROCESSING\n    this.workflowProgress = {\n      currentNode: Math.max(0, currentNode),\n      totalNodes: Math.max(0, totalNodes),\n      percentage: totalNodes > 0 ? Math.round((currentNode / totalNodes) * 100) : 0\n    }\n\n    console.log(`ğŸ“Š å·¥ä½œæµè¿›åº¦: ${currentNode}/${totalNodes} (${this.workflowProgress.percentage}%)`)\n    this._notifyCallbacks()\n  }\n\n  /**\n   * ä»èŠ‚ç‚¹IDè§£æè¿›åº¦ï¼ˆComfyUIèŠ‚ç‚¹æ‰§è¡Œæ¶ˆæ¯ï¼‰\n   * @param {string} nodeId - èŠ‚ç‚¹ID\n   * @param {number} totalNodes - æ€»èŠ‚ç‚¹æ•°ï¼ˆå¯é€‰ï¼Œå¦‚æœå·²çŸ¥ï¼‰\n   */\n  updateFromNodeExecution(nodeId, totalNodes = null) {\n    // å°è¯•ä»èŠ‚ç‚¹IDä¸­æå–æ•°å­—ä½œä¸ºå½“å‰èŠ‚ç‚¹\n    const nodeNumber = parseInt(nodeId) || 0\n\n    if (totalNodes !== null) {\n      this.updateWorkflowProgress(nodeNumber, totalNodes)\n    } else {\n      // å¦‚æœä¸çŸ¥é“æ€»èŠ‚ç‚¹æ•°ï¼Œåªæ›´æ–°å½“å‰èŠ‚ç‚¹\n      this.currentStage = PROGRESS_STAGES.PROCESSING\n      this.workflowProgress.currentNode = nodeNumber\n\n      console.log(`ğŸ“Š å·¥ä½œæµæ‰§è¡ŒèŠ‚ç‚¹: ${nodeId}`)\n      this._notifyCallbacks()\n    }\n  }\n\n  /**\n   * è·å–å½“å‰æ˜¾ç¤ºæ¶ˆæ¯\n   * @returns {string} æ˜¾ç¤ºæ¶ˆæ¯\n   */\n  getCurrentMessage() {\n    if (this.currentStage === PROGRESS_STAGES.PROCESSING && this.workflowProgress.totalNodes > 0) {\n      // å·¥ä½œæµæ‰§è¡Œé˜¶æ®µæ˜¾ç¤ºè¯¦ç»†è¿›åº¦\n      const { currentNode, totalNodes, percentage } = this.workflowProgress\n      return `${percentage}%ï¼ˆ${currentNode}/${totalNodes}ï¼‰`\n    } else {\n      // å…¶ä»–é˜¶æ®µæ˜¾ç¤ºé˜¶æ®µæ–‡æœ¬\n      return STAGE_TEXTS[this.currentStage] || 'å¤„ç†ä¸­...'\n    }\n  }\n\n  /**\n   * è·å–å½“å‰çŠ¶æ€\n   * @returns {Object} å½“å‰çŠ¶æ€å¯¹è±¡\n   */\n  getCurrentState() {\n    return {\n      stage: this.currentStage,\n      message: this.getCurrentMessage(),\n      workflowProgress: { ...this.workflowProgress },\n      isWorkflowStage: this.currentStage === PROGRESS_STAGES.PROCESSING && this.workflowProgress.totalNodes > 0\n    }\n  }\n\n  /**\n   * é‡ç½®è¿›åº¦çŠ¶æ€\n   */\n  reset() {\n    this.currentStage = null\n    this.workflowProgress = {\n      currentNode: 0,\n      totalNodes: 0,\n      percentage: 0\n    }\n    console.log('ğŸ”„ è¿›åº¦çŠ¶æ€å·²é‡ç½®')\n  }\n\n  /**\n   * è®¾ç½®é”™è¯¯çŠ¶æ€\n   * @param {string} errorMessage - é”™è¯¯æ¶ˆæ¯\n   */\n  setError(errorMessage = 'å¤„ç†å¤±è´¥') {\n    this.currentStage = PROGRESS_STAGES.ERROR\n    this.errorMessage = errorMessage\n    console.log(`âŒ è¿›åº¦é”™è¯¯: ${errorMessage}`)\n    this._notifyCallbacks()\n  }\n\n  /**\n   * è®¾ç½®å®ŒæˆçŠ¶æ€\n   */\n  setCompleted() {\n    this.currentStage = PROGRESS_STAGES.COMPLETED\n    console.log('âœ… è¿›åº¦å®Œæˆ')\n    this._notifyCallbacks()\n  }\n}\n\n/**\n * åˆ›å»ºè¿›åº¦é˜¶æ®µç®¡ç†å™¨å®ä¾‹\n * @returns {ProgressStageManager} ç®¡ç†å™¨å®ä¾‹\n */\nexport function createProgressStageManager() {\n  return new ProgressStageManager()\n}\n\n/**\n * è§£æComfyUIå·¥ä½œæµJSONï¼Œè·å–æ€»èŠ‚ç‚¹æ•°\n * @param {Object} workflow - å·¥ä½œæµJSONå¯¹è±¡\n * @returns {number} æ€»èŠ‚ç‚¹æ•°\n */\nexport function getWorkflowTotalNodes(workflow) {\n  if (!workflow || typeof workflow !== 'object') {\n    return 0\n  }\n\n  // ComfyUIå·¥ä½œæµçš„èŠ‚ç‚¹å­˜å‚¨åœ¨æ ¹çº§åˆ«ï¼Œæ¯ä¸ªé”®æ˜¯èŠ‚ç‚¹ID\n  const nodeIds = Object.keys(workflow).filter(key => {\n    const node = workflow[key]\n    return node && typeof node === 'object' && node.class_type\n  })\n\n  return nodeIds.length\n}\n\n/**\n * ä»èŠ‚ç‚¹IDæå–æ•°å­—\n * @param {string} nodeId - èŠ‚ç‚¹ID\n * @returns {number} æå–çš„æ•°å­—ï¼Œå¦‚æœæ— æ³•æå–åˆ™è¿”å›0\n */\nexport function extractNodeNumber(nodeId) {\n  if (!nodeId) return 0\n\n  // å°è¯•ç›´æ¥è½¬æ¢ä¸ºæ•°å­—\n  const directNumber = parseInt(nodeId)\n  if (!isNaN(directNumber)) {\n    return directNumber\n  }\n\n  // å°è¯•ä»å­—ç¬¦ä¸²ä¸­æå–æ•°å­—\n  const match = nodeId.toString().match(/\\d+/)\n  return match ? parseInt(match[0]) : 0\n}\n"
        }
    ]
}