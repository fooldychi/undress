{
    "sourceFile": "client/src/utils/testSimpleLoadBalancer.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 5,
            "patches": [
                {
                    "date": 1752518951792,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752518971386,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -152,9 +152,9 @@\n     const normalServer = await loadBalancer.getOptimalServer()\n     console.log(`âœ… æ­£å¸¸æƒ…å†µä¸‹é€‰æ‹©: ${normalServer}`)\n \n     // 2. è·å–æœåŠ¡å™¨åˆ—è¡¨\n-    const servers = await loadBalancer.getLatestServerList()\n+    const servers = await loadBalancer.getServerList()\n     console.log(`ğŸ“‹ å½“å‰æœ‰ ${servers.length} ä¸ªé…ç½®çš„æœåŠ¡å™¨`)\n \n     // 3. æ¨¡æ‹Ÿç¬¬ä¸€ä¸ªæœåŠ¡å™¨æ•…éšœï¼ˆé€šè¿‡ä½¿ç”¨é”™è¯¯çš„URLï¼‰\n     if (servers.length > 1) {\n"
                },
                {
                    "date": 1752549420444,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,31 +15,30 @@\n     console.log('\\nğŸ“‹ æµ‹è¯•1: åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨')\n     await loadBalancer.initialize()\n     console.log('âœ… åˆå§‹åŒ–æˆåŠŸ')\n \n-    // 2. æµ‹è¯•è·å–æœåŠ¡å™¨åˆ—è¡¨\n-    console.log('\\nğŸ“‹ æµ‹è¯•2: è·å–æœåŠ¡å™¨åˆ—è¡¨')\n-    const servers = await loadBalancer.getServerList()\n-    console.log(`âœ… è·å–åˆ° ${servers.length} ä¸ªæœåŠ¡å™¨:`)\n-    servers.forEach((server, index) => {\n-      console.log(`   ${index + 1}. ${server.url} (${server.type}, ä¼˜å…ˆçº§: ${server.priority})`)\n+    // 2. æµ‹è¯•åŠ è½½æœåŠ¡å™¨åˆ—è¡¨\n+    console.log('\\nğŸ“‹ æµ‹è¯•2: åŠ è½½æœåŠ¡å™¨åˆ—è¡¨')\n+    await loadBalancer.loadServerList()\n+    console.log(`âœ… æœåŠ¡å™¨åˆ—è¡¨åŠ è½½å®Œæˆï¼Œå…± ${loadBalancer.serverList.length} ä¸ªæœåŠ¡å™¨:`)\n+    loadBalancer.serverList.forEach((server, index) => {\n+      console.log(`   ${index + 1}. ${server.url} (${server.type})`)\n     })\n \n-    // 3. æµ‹è¯•ç›´æ¥è¿æ¥\n-    console.log('\\nğŸ“‹ æµ‹è¯•3: æµ‹è¯•ç›´æ¥è¿æ¥')\n-    if (servers.length > 0) {\n-      const server = servers[0]\n-      const health = await loadBalancer.testDirectConnection(server.url)\n-      console.log(`âœ… æœåŠ¡å™¨ ${server.url} è¿æ¥çŠ¶æ€:`, health)\n-    }\n+    // 3. æµ‹è¯•å¥åº·æ£€æŸ¥\n+    console.log('\\nğŸ“‹ æµ‹è¯•3: æ‰§è¡Œå¥åº·æ£€æŸ¥')\n+    await loadBalancer.refreshHealthStatus()\n+    console.log('âœ… å¥åº·æ£€æŸ¥å®Œæˆ')\n+    loadBalancer.serverList.forEach((server, index) => {\n+      const status = server.healthy === true ? 'âœ… å¥åº·' :\n+                    server.healthy === false ? 'âŒ å¼‚å¸¸' : 'â³ æœªçŸ¥'\n+      console.log(`   ${index + 1}. ${server.url}: ${status}`)\n+    })\n \n-    // 4. æµ‹è¯•é˜Ÿåˆ—ä¿¡æ¯è·å–\n-    console.log('\\nğŸ“‹ æµ‹è¯•4: è·å–æœåŠ¡å™¨é˜Ÿåˆ—ä¿¡æ¯')\n-    if (servers.length > 0) {\n-      const server = servers[0]\n-      const queue = await loadBalancer.getQueueInfo(server.url)\n-      console.log(`âœ… æœåŠ¡å™¨ ${server.url} é˜Ÿåˆ—ä¿¡æ¯:`, queue)\n-    }\n+    // 4. æµ‹è¯•è·å–æœ€ä¼˜æœåŠ¡å™¨\n+    console.log('\\nğŸ“‹ æµ‹è¯•4: è·å–æœ€ä¼˜æœåŠ¡å™¨')\n+    const optimalServer = await loadBalancer.getOptimalServer()\n+    console.log(`âœ… æœ€ä¼˜æœåŠ¡å™¨: ${optimalServer}`)\n \n     // 5. æµ‹è¯•æœåŠ¡å™¨é€‰æ‹©\n     console.log('\\nğŸ“‹ æµ‹è¯•5: é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨')\n     for (let i = 0; i < 3; i++) {\n"
                },
                {
                    "date": 1752549462080,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -151,28 +151,28 @@\n     const normalServer = await loadBalancer.getOptimalServer()\n     console.log(`âœ… æ­£å¸¸æƒ…å†µä¸‹é€‰æ‹©: ${normalServer}`)\n \n     // 2. è·å–æœåŠ¡å™¨åˆ—è¡¨\n-    const servers = await loadBalancer.getServerList()\n+    await loadBalancer.loadServerList()\n+    const servers = loadBalancer.serverList\n     console.log(`ğŸ“‹ å½“å‰æœ‰ ${servers.length} ä¸ªé…ç½®çš„æœåŠ¡å™¨`)\n \n-    // 3. æ¨¡æ‹Ÿç¬¬ä¸€ä¸ªæœåŠ¡å™¨æ•…éšœï¼ˆé€šè¿‡ä½¿ç”¨é”™è¯¯çš„URLï¼‰\n+    // 3. æ¨¡æ‹Ÿç¬¬ä¸€ä¸ªæœåŠ¡å™¨æ•…éšœ\n     if (servers.length > 1) {\n       console.log('\\nğŸ“‹ æ­¥éª¤2: æ¨¡æ‹ŸæœåŠ¡å™¨æ•…éšœ')\n \n-      // ä¸´æ—¶ä¿®æ”¹ç¬¬ä¸€ä¸ªæœåŠ¡å™¨çš„URLä¸ºæ— æ•ˆåœ°å€\n-      const originalUrl = servers[0].url\n-      servers[0].url = 'http://invalid-server.com'\n+      // è®°å½•ç¬¬ä¸€ä¸ªæœåŠ¡å™¨æ•…éšœ\n+      const firstServer = servers[0]\n+      await loadBalancer.recordFailure(firstServer.url, 'simulated')\n+      console.log(`âš ï¸ æ¨¡æ‹ŸæœåŠ¡å™¨æ•…éšœ: ${firstServer.url}`)\n \n-      console.log(`âš ï¸ æ¨¡æ‹ŸæœåŠ¡å™¨æ•…éšœ: ${originalUrl} -> ${servers[0].url}`)\n-\n       // é‡æ–°é€‰æ‹©æœåŠ¡å™¨\n       const fallbackServer = await loadBalancer.getOptimalServer()\n       console.log(`âœ… æ•…éšœè½¬ç§»åé€‰æ‹©: ${fallbackServer}`)\n \n-      // æ¢å¤åŸå§‹URL\n-      servers[0].url = originalUrl\n-      console.log(`ğŸ”„ æ¢å¤æœåŠ¡å™¨: ${originalUrl}`)\n+      // åˆ·æ–°å¥åº·çŠ¶æ€ä»¥æ¢å¤\n+      console.log('ğŸ”„ åˆ·æ–°å¥åº·çŠ¶æ€...')\n+      await loadBalancer.refreshHealthStatus()\n     } else {\n       console.log('âš ï¸ åªæœ‰ä¸€ä¸ªæœåŠ¡å™¨ï¼Œæ— æ³•æµ‹è¯•æ•…éšœè½¬ç§»')\n     }\n \n"
                },
                {
                    "date": 1752551477832,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -25,14 +25,21 @@\n     })\n \n     // 3. æµ‹è¯•å¥åº·æ£€æŸ¥\n     console.log('\\nğŸ“‹ æµ‹è¯•3: æ‰§è¡Œå¥åº·æ£€æŸ¥')\n+    loadBalancer.setVerboseLogging(true) // å¯ç”¨è¯¦ç»†æ—¥å¿—\n     await loadBalancer.refreshHealthStatus()\n+    loadBalancer.setVerboseLogging(false) // å…³é—­è¯¦ç»†æ—¥å¿—\n     console.log('âœ… å¥åº·æ£€æŸ¥å®Œæˆ')\n+\n+    // æ˜¾ç¤ºæœåŠ¡å™¨çŠ¶æ€å’Œé˜Ÿåˆ—ä¿¡æ¯\n     loadBalancer.serverList.forEach((server, index) => {\n       const status = server.healthy === true ? 'âœ… å¥åº·' :\n                     server.healthy === false ? 'âŒ å¼‚å¸¸' : 'â³ æœªçŸ¥'\n-      console.log(`   ${index + 1}. ${server.url}: ${status}`)\n+      const queueText = server.queueInfo.total > 0\n+        ? `é˜Ÿåˆ—: ${server.queueInfo.running}è¿è¡Œ/${server.queueInfo.pending}ç­‰å¾…`\n+        : 'é˜Ÿåˆ—: ç©ºé—²'\n+      console.log(`   ${index + 1}. ${server.url}: ${status} | ${queueText}`)\n     })\n \n     // 4. æµ‹è¯•è·å–æœ€ä¼˜æœåŠ¡å™¨\n     console.log('\\nğŸ“‹ æµ‹è¯•4: è·å–æœ€ä¼˜æœåŠ¡å™¨')\n"
                },
                {
                    "date": 1752551498115,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -45,8 +45,19 @@\n     console.log('\\nğŸ“‹ æµ‹è¯•4: è·å–æœ€ä¼˜æœåŠ¡å™¨')\n     const optimalServer = await loadBalancer.getOptimalServer()\n     console.log(`âœ… æœ€ä¼˜æœåŠ¡å™¨: ${optimalServer}`)\n \n+    // æ˜¾ç¤ºé€‰æ‹©åŸå› \n+    const healthyServers = loadBalancer.serverList.filter(s => s.healthy === true)\n+    if (healthyServers.length > 1) {\n+      console.log('ğŸ“Š è´Ÿè½½å‡è¡¡é€‰æ‹©ä¾æ®:')\n+      healthyServers.forEach(server => {\n+        const isSelected = server.url === optimalServer\n+        const marker = isSelected ? 'ğŸ‘‰' : '  '\n+        console.log(`${marker} ${server.type}: é˜Ÿåˆ—${server.queueInfo.total}`)\n+      })\n+    }\n+\n     // 5. æµ‹è¯•æœåŠ¡å™¨é€‰æ‹©\n     console.log('\\nğŸ“‹ æµ‹è¯•5: é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨')\n     for (let i = 0; i < 3; i++) {\n       const selectedServer = await loadBalancer.getOptimalServer()\n"
                }
            ],
            "date": 1752518951792,
            "name": "Commit-0",
            "content": "/**\n * æç®€è´Ÿè½½å‡è¡¡å™¨æµ‹è¯•å·¥å…·\n */\n\nimport loadBalancer from '../services/loadBalancer.js'\n\n/**\n * æµ‹è¯•è´Ÿè½½å‡è¡¡å™¨çš„åŸºæœ¬åŠŸèƒ½\n */\nexport async function testSimpleLoadBalancer() {\n  console.log('ğŸ§ª å¼€å§‹æµ‹è¯•æç®€è´Ÿè½½å‡è¡¡å™¨...')\n\n  try {\n    // 1. æµ‹è¯•åˆå§‹åŒ–\n    console.log('\\nğŸ“‹ æµ‹è¯•1: åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨')\n    await loadBalancer.initialize()\n    console.log('âœ… åˆå§‹åŒ–æˆåŠŸ')\n\n    // 2. æµ‹è¯•è·å–æœåŠ¡å™¨åˆ—è¡¨\n    console.log('\\nğŸ“‹ æµ‹è¯•2: è·å–æœåŠ¡å™¨åˆ—è¡¨')\n    const servers = await loadBalancer.getServerList()\n    console.log(`âœ… è·å–åˆ° ${servers.length} ä¸ªæœåŠ¡å™¨:`)\n    servers.forEach((server, index) => {\n      console.log(`   ${index + 1}. ${server.url} (${server.type}, ä¼˜å…ˆçº§: ${server.priority})`)\n    })\n\n    // 3. æµ‹è¯•ç›´æ¥è¿æ¥\n    console.log('\\nğŸ“‹ æµ‹è¯•3: æµ‹è¯•ç›´æ¥è¿æ¥')\n    if (servers.length > 0) {\n      const server = servers[0]\n      const health = await loadBalancer.testDirectConnection(server.url)\n      console.log(`âœ… æœåŠ¡å™¨ ${server.url} è¿æ¥çŠ¶æ€:`, health)\n    }\n\n    // 4. æµ‹è¯•é˜Ÿåˆ—ä¿¡æ¯è·å–\n    console.log('\\nğŸ“‹ æµ‹è¯•4: è·å–æœåŠ¡å™¨é˜Ÿåˆ—ä¿¡æ¯')\n    if (servers.length > 0) {\n      const server = servers[0]\n      const queue = await loadBalancer.getQueueInfo(server.url)\n      console.log(`âœ… æœåŠ¡å™¨ ${server.url} é˜Ÿåˆ—ä¿¡æ¯:`, queue)\n    }\n\n    // 5. æµ‹è¯•æœåŠ¡å™¨é€‰æ‹©\n    console.log('\\nğŸ“‹ æµ‹è¯•5: é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨')\n    for (let i = 0; i < 3; i++) {\n      const selectedServer = await loadBalancer.getOptimalServer()\n      console.log(`   ç¬¬${i + 1}æ¬¡é€‰æ‹©: ${selectedServer}`)\n\n      // ç­‰å¾…1ç§’\n      await new Promise(resolve => setTimeout(resolve, 1000))\n    }\n\n    console.log('\\nâœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼')\n\n  } catch (error) {\n    console.error('âŒ æµ‹è¯•å¤±è´¥:', error)\n  }\n}\n\n/**\n * æµ‹è¯•å¤šæ¬¡æœåŠ¡å™¨é€‰æ‹©ï¼ŒéªŒè¯è´Ÿè½½å‡è¡¡æ•ˆæœ\n */\nexport async function testLoadBalancing(times = 10) {\n  console.log(`ğŸ§ª å¼€å§‹æµ‹è¯•è´Ÿè½½å‡è¡¡æ•ˆæœ (${times}æ¬¡é€‰æ‹©)...`)\n\n  const selections = new Map()\n\n  try {\n    for (let i = 0; i < times; i++) {\n      const server = await loadBalancer.getOptimalServer()\n      const count = selections.get(server) || 0\n      selections.set(server, count + 1)\n\n      console.log(`ç¬¬${i + 1}æ¬¡é€‰æ‹©: ${server}`)\n\n      // çŸ­æš‚å»¶è¿Ÿ\n      await new Promise(resolve => setTimeout(resolve, 500))\n    }\n\n    console.log('\\nğŸ“Š è´Ÿè½½å‡è¡¡ç»“æœç»Ÿè®¡:')\n    for (const [server, count] of selections.entries()) {\n      const percentage = ((count / times) * 100).toFixed(1)\n      console.log(`   ${server}: ${count}æ¬¡ (${percentage}%)`)\n    }\n\n  } catch (error) {\n    console.error('âŒ è´Ÿè½½å‡è¡¡æµ‹è¯•å¤±è´¥:', error)\n  }\n}\n\n/**\n * æ¨¡æ‹Ÿç”¨æˆ·ç”Ÿå›¾è¯·æ±‚çš„æœåŠ¡å™¨é€‰æ‹©\n */\nexport async function simulateUserRequests(userCount = 5) {\n  console.log(`ğŸ§ª æ¨¡æ‹Ÿ ${userCount} ä¸ªç”¨æˆ·åŒæ—¶å‘èµ·ç”Ÿå›¾è¯·æ±‚...`)\n\n  const promises = []\n\n  for (let i = 0; i < userCount; i++) {\n    const promise = (async () => {\n      const userId = `ç”¨æˆ·${i + 1}`\n      console.log(`ğŸ‘¤ ${userId} å¼€å§‹é€‰æ‹©æœåŠ¡å™¨...`)\n\n      try {\n        const server = await loadBalancer.getOptimalServer()\n        console.log(`ğŸ‘¤ ${userId} é€‰æ‹©äº†æœåŠ¡å™¨: ${server}`)\n        return { userId, server, success: true }\n      } catch (error) {\n        console.error(`ğŸ‘¤ ${userId} é€‰æ‹©æœåŠ¡å™¨å¤±è´¥:`, error)\n        return { userId, error: error.message, success: false }\n      }\n    })()\n\n    promises.push(promise)\n  }\n\n  try {\n    const results = await Promise.all(promises)\n\n    console.log('\\nğŸ“Š ç”¨æˆ·è¯·æ±‚ç»“æœç»Ÿè®¡:')\n    const serverCounts = new Map()\n    let successCount = 0\n\n    results.forEach(result => {\n      if (result.success) {\n        successCount++\n        const count = serverCounts.get(result.server) || 0\n        serverCounts.set(result.server, count + 1)\n      }\n    })\n\n    console.log(`âœ… æˆåŠŸ: ${successCount}/${userCount}`)\n    console.log('ğŸ“Š æœåŠ¡å™¨åˆ†é…:')\n    for (const [server, count] of serverCounts.entries()) {\n      console.log(`   ${server}: ${count}ä¸ªç”¨æˆ·`)\n    }\n\n  } catch (error) {\n    console.error('âŒ ç”¨æˆ·è¯·æ±‚æ¨¡æ‹Ÿå¤±è´¥:', error)\n  }\n}\n\n/**\n * æµ‹è¯•æœåŠ¡å™¨æ•…éšœæ¢å¤\n */\nexport async function testServerFailover() {\n  console.log('ğŸ§ª æµ‹è¯•æœåŠ¡å™¨æ•…éšœæ¢å¤...')\n\n  try {\n    // 1. æ­£å¸¸é€‰æ‹©æœåŠ¡å™¨\n    console.log('\\nğŸ“‹ æ­¥éª¤1: æ­£å¸¸é€‰æ‹©æœåŠ¡å™¨')\n    const normalServer = await loadBalancer.getOptimalServer()\n    console.log(`âœ… æ­£å¸¸æƒ…å†µä¸‹é€‰æ‹©: ${normalServer}`)\n\n    // 2. è·å–æœåŠ¡å™¨åˆ—è¡¨\n    const servers = await loadBalancer.getLatestServerList()\n    console.log(`ğŸ“‹ å½“å‰æœ‰ ${servers.length} ä¸ªé…ç½®çš„æœåŠ¡å™¨`)\n\n    // 3. æ¨¡æ‹Ÿç¬¬ä¸€ä¸ªæœåŠ¡å™¨æ•…éšœï¼ˆé€šè¿‡ä½¿ç”¨é”™è¯¯çš„URLï¼‰\n    if (servers.length > 1) {\n      console.log('\\nğŸ“‹ æ­¥éª¤2: æ¨¡æ‹ŸæœåŠ¡å™¨æ•…éšœ')\n\n      // ä¸´æ—¶ä¿®æ”¹ç¬¬ä¸€ä¸ªæœåŠ¡å™¨çš„URLä¸ºæ— æ•ˆåœ°å€\n      const originalUrl = servers[0].url\n      servers[0].url = 'http://invalid-server.com'\n\n      console.log(`âš ï¸ æ¨¡æ‹ŸæœåŠ¡å™¨æ•…éšœ: ${originalUrl} -> ${servers[0].url}`)\n\n      // é‡æ–°é€‰æ‹©æœåŠ¡å™¨\n      const fallbackServer = await loadBalancer.getOptimalServer()\n      console.log(`âœ… æ•…éšœè½¬ç§»åé€‰æ‹©: ${fallbackServer}`)\n\n      // æ¢å¤åŸå§‹URL\n      servers[0].url = originalUrl\n      console.log(`ğŸ”„ æ¢å¤æœåŠ¡å™¨: ${originalUrl}`)\n    } else {\n      console.log('âš ï¸ åªæœ‰ä¸€ä¸ªæœåŠ¡å™¨ï¼Œæ— æ³•æµ‹è¯•æ•…éšœè½¬ç§»')\n    }\n\n  } catch (error) {\n    console.error('âŒ æœåŠ¡å™¨æ•…éšœæ¢å¤æµ‹è¯•å¤±è´¥:', error)\n  }\n}\n\n// æ·»åŠ å…¨å±€æµ‹è¯•æ–¹æ³•\nif (typeof window !== 'undefined') {\n  window.testSimpleLoadBalancer = testSimpleLoadBalancer\n  window.testLoadBalancing = testLoadBalancing\n  window.simulateUserRequests = simulateUserRequests\n  window.testServerFailover = testServerFailover\n\n  console.log('ğŸ”§ æç®€è´Ÿè½½å‡è¡¡å™¨æµ‹è¯•å·¥å…·å·²åŠ è½½')\n  console.log('å¯ç”¨çš„æµ‹è¯•æ–¹æ³•:')\n  console.log('  - window.testSimpleLoadBalancer() - åŸºæœ¬åŠŸèƒ½æµ‹è¯•')\n  console.log('  - window.testLoadBalancing(10) - è´Ÿè½½å‡è¡¡æ•ˆæœæµ‹è¯•')\n  console.log('  - window.simulateUserRequests(5) - æ¨¡æ‹Ÿç”¨æˆ·è¯·æ±‚')\n  console.log('  - window.testServerFailover() - æœåŠ¡å™¨æ•…éšœæ¢å¤æµ‹è¯•')\n}\n\nexport default {\n  testSimpleLoadBalancer,\n  testLoadBalancing,\n  simulateUserRequests,\n  testServerFailover\n}\n"
        }
    ]
}