{
    "sourceFile": "client/src/utils/levelCardPointsManager.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1752288021271,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752288511571,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -19,18 +19,11 @@\n   }\n \n   // è·å–ç§¯åˆ†çŠ¶æ€\n   async getPointsStatus() {\n+    // é¦–å…ˆæ£€æŸ¥ç™»å½•çŠ¶æ€\n     if (!this.isLoggedIn()) {\n-      return {\n-        current: 0,\n-        total_points: 0,\n-        cards_count: 0,\n-        cards_breakdown: [],\n-        canGenerate: false,\n-        generationCost: 20,\n-        isLoggedIn: false\n-      }\n+      return this.getDefaultStatus()\n     }\n \n     try {\n       // å¦‚æœç¼“å­˜è¿˜æœ‰æ•ˆï¼Œç›´æ¥è¿”å›ç¼“å­˜æ•°æ®\n"
                },
                {
                    "date": 1752288528460,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -80,17 +80,18 @@\n   }\n \n   // è·å–é»˜è®¤çŠ¶æ€\n   getDefaultStatus() {\n+    const loggedIn = this.isLoggedIn()\n     return {\n       current: 0,\n       total_points: 0,\n       purchased_points: 0,\n       cards_count: 0,\n       cards_breakdown: [],\n       canGenerate: false,\n       generationCost: 20,\n-      isLoggedIn: this.isLoggedIn(),\n+      isLoggedIn: loggedIn,\n       dailyRemaining: 0,\n       dailyFreePoints: 0,\n       totalUsedToday: 0,\n       experienceCardPoints: 0\n"
                },
                {
                    "date": 1752334538178,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -98,18 +98,25 @@\n     }\n   }\n \n   // æ¶ˆè€—ç§¯åˆ†\n-  async consumePoints(amount, description = 'ç”Ÿæˆå›¾ç‰‡') {\n+  async consumePoints(amount, description = 'ç”Ÿæˆå›¾ç‰‡', mediaUrl = null) {\n     if (!this.isLoggedIn()) {\n       throw new Error('è¯·å…ˆç™»å½•')\n     }\n \n     try {\n+      console.log(`ğŸ’° å¼€å§‹æ¶ˆè€—ç§¯åˆ†: ${amount}ç‚¹, æè¿°: ${description}`)\n+      if (mediaUrl) {\n+        console.log(`ğŸ¬ å…³è”åª’ä½“URL: ${mediaUrl}`)\n+      }\n+\n       // è°ƒç”¨åç«¯APIæ¶ˆè€—ç§¯åˆ†\n-      const response = await pointsApi.consumePoints(amount, description)\n+      const response = await pointsApi.consumePoints(amount, description, mediaUrl)\n \n       if (response.success) {\n+        console.log(`âœ… ç§¯åˆ†æ¶ˆè€—æˆåŠŸ: æ¶ˆè€—${amount}ç‚¹, å‰©ä½™${response.data.remaining_points}ç‚¹`)\n+\n         // æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶ä¸‹æ¬¡è·å–æœ€æ–°æ•°æ®\n         this.pointsInfo = null\n         this.lastUpdateTime = 0\n \n"
                },
                {
                    "date": 1752342614789,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -141,8 +141,15 @@\n     this.lastUpdateTime = 0\n     return await this.getPointsStatus()\n   }\n \n+  // å¼ºåˆ¶æ¸…é™¤ç¼“å­˜\n+  clearCache() {\n+    this.pointsInfo = null\n+    this.lastUpdateTime = 0\n+    console.log('ğŸ—‘ï¸ ç§¯åˆ†ç¼“å­˜å·²æ¸…é™¤')\n+  }\n+\n   // ç»‘å®šç­‰çº§å¡\n   async bindLevelCard(cardNumber, cardPassword) {\n     if (!this.isLoggedIn()) {\n       throw new Error('è¯·å…ˆç™»å½•')\n"
                }
            ],
            "date": 1752288021271,
            "name": "Commit-0",
            "content": "/**\n * ç­‰çº§å¡ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ\n * åŸºäºåç«¯APIçš„ç§¯åˆ†ç®¡ç†ï¼Œæ›¿ä»£åŸæœ‰çš„æœ¬åœ°ç§¯åˆ†ç³»ç»Ÿ\n */\n\nimport { pointsApi, levelCardApi } from '../services/api.js'\nimport { authApi } from '../services/api.js'\n\nclass LevelCardPointsManager {\n  constructor() {\n    this.pointsInfo = null\n    this.lastUpdateTime = 0\n    this.updateInterval = 30000 // 30ç§’æ›´æ–°ä¸€æ¬¡\n  }\n\n  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•\n  isLoggedIn() {\n    return authApi.isLoggedIn()\n  }\n\n  // è·å–ç§¯åˆ†çŠ¶æ€\n  async getPointsStatus() {\n    if (!this.isLoggedIn()) {\n      return {\n        current: 0,\n        total_points: 0,\n        cards_count: 0,\n        cards_breakdown: [],\n        canGenerate: false,\n        generationCost: 20,\n        isLoggedIn: false\n      }\n    }\n\n    try {\n      // å¦‚æœç¼“å­˜è¿˜æœ‰æ•ˆï¼Œç›´æ¥è¿”å›ç¼“å­˜æ•°æ®\n      const now = Date.now()\n      if (this.pointsInfo && (now - this.lastUpdateTime) < this.updateInterval) {\n        return this.formatPointsStatus(this.pointsInfo)\n      }\n\n      // ä»APIè·å–æœ€æ–°ç§¯åˆ†ä¿¡æ¯\n      const response = await pointsApi.getUserPoints()\n\n      if (response.success) {\n        this.pointsInfo = response.data\n        this.lastUpdateTime = now\n        return this.formatPointsStatus(this.pointsInfo)\n      } else {\n        console.error('è·å–ç§¯åˆ†ä¿¡æ¯å¤±è´¥:', response.message)\n        // å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼Œè¿”å›æœªç™»å½•çŠ¶æ€\n        if (response.message && response.message.includes('ä»¤ç‰Œ')) {\n          return this.getDefaultStatus()\n        }\n        return this.getDefaultStatus()\n      }\n    } catch (error) {\n      console.error('è·å–ç§¯åˆ†çŠ¶æ€å¤±è´¥:', error)\n      // å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼Œè¿”å›æœªç™»å½•çŠ¶æ€\n      if (error.message && (error.message.includes('ä»¤ç‰Œ') || error.message.includes('401'))) {\n        return this.getDefaultStatus()\n      }\n      return this.getDefaultStatus()\n    }\n  }\n\n  // æ ¼å¼åŒ–ç§¯åˆ†çŠ¶æ€\n  formatPointsStatus(pointsInfo) {\n    const totalPoints = pointsInfo.total_points || 0\n    const generationCost = 20 // æ¯æ¬¡ç”Ÿæˆæ¶ˆè€—20ç§¯åˆ†\n\n    return {\n      current: totalPoints,\n      total_points: totalPoints,\n      purchased_points: pointsInfo.purchased_points || 0,\n      cards_count: pointsInfo.cards_count || 0,\n      cards_breakdown: pointsInfo.cards_breakdown || [],\n      canGenerate: totalPoints >= generationCost,\n      generationCost: generationCost,\n      isLoggedIn: true,\n      // å…¼å®¹åŸæœ‰å­—æ®µ\n      dailyRemaining: 0, // ç­‰çº§å¡ç³»ç»Ÿæ²¡æœ‰æ¯æ—¥å…è´¹æ¦‚å¿µ\n      dailyFreePoints: 0,\n      totalUsedToday: 0,\n      experienceCardPoints: 0\n    }\n  }\n\n  // è·å–é»˜è®¤çŠ¶æ€\n  getDefaultStatus() {\n    return {\n      current: 0,\n      total_points: 0,\n      purchased_points: 0,\n      cards_count: 0,\n      cards_breakdown: [],\n      canGenerate: false,\n      generationCost: 20,\n      isLoggedIn: this.isLoggedIn(),\n      dailyRemaining: 0,\n      dailyFreePoints: 0,\n      totalUsedToday: 0,\n      experienceCardPoints: 0\n    }\n  }\n\n  // æ¶ˆè€—ç§¯åˆ†\n  async consumePoints(amount, description = 'ç”Ÿæˆå›¾ç‰‡') {\n    if (!this.isLoggedIn()) {\n      throw new Error('è¯·å…ˆç™»å½•')\n    }\n\n    try {\n      // è°ƒç”¨åç«¯APIæ¶ˆè€—ç§¯åˆ†\n      const response = await pointsApi.consumePoints(amount, description)\n\n      if (response.success) {\n        // æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶ä¸‹æ¬¡è·å–æœ€æ–°æ•°æ®\n        this.pointsInfo = null\n        this.lastUpdateTime = 0\n\n        return {\n          success: true,\n          message: 'ç§¯åˆ†æ¶ˆè€—æˆåŠŸ',\n          consumed: amount,\n          remaining: response.data.remaining_points || 0\n        }\n      } else {\n        throw new Error(response.message || 'ç§¯åˆ†ä¸è¶³')\n      }\n    } catch (error) {\n      console.error('æ¶ˆè€—ç§¯åˆ†å¤±è´¥:', error)\n      throw error\n    }\n  }\n\n  // åˆ·æ–°ç§¯åˆ†ä¿¡æ¯\n  async refreshPoints() {\n    this.pointsInfo = null\n    this.lastUpdateTime = 0\n    return await this.getPointsStatus()\n  }\n\n  // ç»‘å®šç­‰çº§å¡\n  async bindLevelCard(cardNumber, cardPassword) {\n    if (!this.isLoggedIn()) {\n      throw new Error('è¯·å…ˆç™»å½•')\n    }\n\n    try {\n      const response = await levelCardApi.bindCard(cardNumber, cardPassword)\n\n      if (response.success) {\n        // æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶åˆ·æ–°ç§¯åˆ†ä¿¡æ¯\n        this.pointsInfo = null\n        this.lastUpdateTime = 0\n\n        return {\n          success: true,\n          message: response.message,\n          data: response.data\n        }\n      } else {\n        throw new Error(response.message || 'ç»‘å®šå¤±è´¥')\n      }\n    } catch (error) {\n      console.error('ç»‘å®šç­‰çº§å¡å¤±è´¥:', error)\n      throw error\n    }\n  }\n\n  // è·å–ç­‰çº§å¡ç±»å‹\n  async getCardTypes() {\n    try {\n      const response = await levelCardApi.getCardTypes()\n\n      if (response.success) {\n        return response.data.cardTypes || []\n      } else {\n        console.error('è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥:', response.message)\n        return []\n      }\n    } catch (error) {\n      console.error('è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥:', error)\n      return []\n    }\n  }\n\n  // è·å–ç”¨æˆ·çš„ç­‰çº§å¡åˆ—è¡¨\n  async getMyCards() {\n    if (!this.isLoggedIn()) {\n      return []\n    }\n\n    try {\n      const response = await levelCardApi.getMyCards()\n\n      if (response.success) {\n        return response.data.cards || []\n      } else {\n        console.error('è·å–æˆ‘çš„ç­‰çº§å¡å¤±è´¥:', response.message)\n        return []\n      }\n    } catch (error) {\n      console.error('è·å–æˆ‘çš„ç­‰çº§å¡å¤±è´¥:', error)\n      return []\n    }\n  }\n\n  // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç”Ÿæˆ\n  async canGenerate() {\n    const status = await this.getPointsStatus()\n    return status.canGenerate\n  }\n\n  // è·å–ç”Ÿæˆæˆæœ¬\n  getGenerationCost() {\n    return 20 // å›ºå®š20ç§¯åˆ†\n  }\n\n  // å…¼å®¹åŸæœ‰æ¥å£ - æ·»åŠ ä½“éªŒå¡ç‚¹æ•°ï¼ˆç°åœ¨é€šè¿‡ç­‰çº§å¡ç³»ç»Ÿï¼‰\n  addExperienceCardPoints() {\n    // è¿™ä¸ªæ–¹æ³•åœ¨ç­‰çº§å¡ç³»ç»Ÿä¸­ä¸å†ä½¿ç”¨\n    // ç§¯åˆ†é€šè¿‡ç»‘å®šç­‰çº§å¡è·å¾—\n    return {\n      success: false,\n      message: 'è¯·ä½¿ç”¨ç­‰çº§å¡ç»‘å®šåŠŸèƒ½',\n      added: 0\n    }\n  }\n\n  // å…¼å®¹åŸæœ‰æ¥å£ - è·å–è´­ä¹°å†å²\n  getPurchaseHistory() {\n    // ç­‰çº§å¡ç³»ç»Ÿä¸­ï¼Œè´­ä¹°å†å²é€šè¿‡APIè·å–\n    return []\n  }\n\n  // å…¼å®¹åŸæœ‰æ¥å£ - è·å–ç»Ÿè®¡ä¿¡æ¯\n  getStatistics() {\n    return {\n      totalPurchased: 0,\n      totalUsed: 0,\n      totalCards: 0\n    }\n  }\n}\n\n// åˆ›å»ºå•ä¾‹å®ä¾‹\nconst levelCardPointsManager = new LevelCardPointsManager()\n\nexport default levelCardPointsManager\n"
        }
    ]
}