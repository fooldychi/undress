{
    "sourceFile": "client/src/services/configService.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 11,
            "patches": [
                {
                    "date": 1752330171943,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752330187186,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -89,9 +89,15 @@\n       )\n \n       if (Object.keys(filteredConfig).length > 0) {\n         console.log('ğŸ”„ åŒæ­¥ComfyUIé…ç½®åˆ°æœ¬åœ°:', filteredConfig)\n+\n+        // æ›´æ–°æœ¬åœ°ComfyUIé…ç½®\n         await updateComfyUIConfig(filteredConfig)\n+\n+        // åŒæ—¶æ›´æ–°APIé…ç½®\n+        updateAPIConfig(filteredConfig)\n+\n         console.log('âœ… ComfyUIé…ç½®åŒæ­¥å®Œæˆ')\n         return filteredConfig\n       } else {\n         console.warn('âš ï¸ æœåŠ¡ç«¯æœªæä¾›æœ‰æ•ˆçš„ComfyUIé…ç½®')\n"
                },
                {
                    "date": 1752330425122,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,9 +16,9 @@\n   async fetchServerConfig() {\n     try {\n       console.log('ğŸ”„ ä»æœåŠ¡ç«¯è·å–é…ç½®...')\n \n-      const response = await fetch('/api/public-config', {\n+      const response = await fetch('/api/config', {\n         method: 'GET',\n         headers: {\n           'Content-Type': 'application/json'\n         }\n"
                },
                {
                    "date": 1752436710637,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -115,17 +115,15 @@\n   async getAIPointsConfig() {\n     try {\n       const config = await this.getConfig()\n       return {\n-        textToImage: config['ai.text_to_image_points'] || 20,\n         faceSwap: config['ai.face_swap_points'] || 20,\n         undress: config['ai.undress_points'] || 20\n       }\n     } catch (error) {\n       console.error('âŒ è·å–AIç§¯åˆ†é…ç½®å¤±è´¥:', error)\n       // è¿”å›é»˜è®¤å€¼\n       return {\n-        textToImage: 20,\n         faceSwap: 20,\n         undress: 20\n       }\n     }\n"
                },
                {
                    "date": 1752514961584,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -44,8 +44,27 @@\n     }\n   }\n \n   /**\n+   * è·å–é»˜è®¤é…ç½®ï¼ˆå½“æœåŠ¡ç«¯ä¸å¯ç”¨æ—¶ä½¿ç”¨ï¼‰\n+   */\n+  getDefaultConfig() {\n+    return {\n+      'comfyui.server_url': 'https://l9s75ay3rp-8188.cnb.run',\n+      'comfyui.backup_servers': 'https://0rv00xh2vg-8188.cnb.run',\n+      'comfyui.client_id': 'abc1373d4ad648a3a81d0587fbe5534b',\n+      'comfyui.timeout': 300000,\n+      'comfyui.health_check_timeout': 10000,\n+      'comfyui.auto_switch': true,\n+      'comfyui.retry_attempts': 3,\n+      'comfyui.switch_threshold': 2,\n+      'ai.text_to_image_points': 20,\n+      'ai.face_swap_points': 20,\n+      'ai.undress_points': 20\n+    }\n+  }\n+\n+  /**\n    * è·å–é…ç½®ï¼ˆå¸¦ç¼“å­˜ï¼‰\n    */\n   async getConfig(forceRefresh = false) {\n     const now = Date.now()\n@@ -59,14 +78,22 @@\n     try {\n       // ä»æœåŠ¡ç«¯è·å–æœ€æ–°é…ç½®\n       return await this.fetchServerConfig()\n     } catch (error) {\n+      console.warn('âš ï¸ æ— æ³•ä»æœåŠ¡ç«¯è·å–é…ç½®:', error.message)\n+\n       // å¦‚æœè·å–å¤±è´¥ï¼Œè¿”å›ç¼“å­˜çš„é…ç½®ï¼ˆå¦‚æœæœ‰ï¼‰\n       if (this.configCache) {\n         console.warn('âš ï¸ ä½¿ç”¨ç¼“å­˜é…ç½®ä½œä¸ºå¤‡ç”¨')\n         return this.configCache\n       }\n-      throw error\n+\n+      // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨é»˜è®¤é…ç½®\n+      console.warn('âš ï¸ ä½¿ç”¨é»˜è®¤é…ç½®ä½œä¸ºå¤‡ç”¨')\n+      const defaultConfig = this.getDefaultConfig()\n+      this.configCache = defaultConfig\n+      this.lastFetchTime = now\n+      return defaultConfig\n     }\n   }\n \n   /**\n"
                },
                {
                    "date": 1752552249470,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -187,8 +187,32 @@\n     console.log('ğŸ—‘ï¸ é…ç½®ç¼“å­˜å·²æ¸…é™¤')\n   }\n \n   /**\n+   * å¼ºåˆ¶åˆ·æ–°é…ç½®å¹¶æ¸…é™¤æ‰€æœ‰ç›¸å…³ç¼“å­˜\n+   */\n+  async forceRefresh() {\n+    console.log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°é…ç½®å’ŒæœåŠ¡å™¨åˆ—è¡¨...')\n+\n+    // æ¸…é™¤é…ç½®ç¼“å­˜\n+    this.clearCache()\n+\n+    // é‡æ–°è·å–é…ç½®\n+    const config = await this.getConfig(true)\n+\n+    // é€šçŸ¥è´Ÿè½½å‡è¡¡å™¨é‡æ–°åŠ è½½æœåŠ¡å™¨åˆ—è¡¨\n+    try {\n+      const { default: loadBalancer } = await import('./loadBalancer.js')\n+      await loadBalancer.loadServerList()\n+      console.log('âœ… è´Ÿè½½å‡è¡¡å™¨æœåŠ¡å™¨åˆ—è¡¨å·²åˆ·æ–°')\n+    } catch (error) {\n+      console.warn('âš ï¸ åˆ·æ–°è´Ÿè½½å‡è¡¡å™¨å¤±è´¥:', error)\n+    }\n+\n+    return config\n+  }\n+\n+  /**\n    * åˆå§‹åŒ–é…ç½®æœåŠ¡\n    */\n   async initialize() {\n     try {\n"
                },
                {
                    "date": 1752552330982,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -211,8 +211,32 @@\n     return config\n   }\n \n   /**\n+   * å¼ºåˆ¶åˆ·æ–°é…ç½®å¹¶æ¸…é™¤æ‰€æœ‰ç›¸å…³ç¼“å­˜\n+   */\n+  async forceRefresh() {\n+    console.log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°é…ç½®å’ŒæœåŠ¡å™¨åˆ—è¡¨...')\n+\n+    // æ¸…é™¤é…ç½®ç¼“å­˜\n+    this.clearCache()\n+\n+    // é‡æ–°è·å–é…ç½®\n+    const config = await this.getConfig(true)\n+\n+    // é€šçŸ¥è´Ÿè½½å‡è¡¡å™¨é‡æ–°åŠ è½½æœåŠ¡å™¨åˆ—è¡¨\n+    try {\n+      const { default: loadBalancer } = await import('./loadBalancer.js')\n+      await loadBalancer.loadServerList()\n+      console.log('âœ… è´Ÿè½½å‡è¡¡å™¨æœåŠ¡å™¨åˆ—è¡¨å·²åˆ·æ–°')\n+    } catch (error) {\n+      console.warn('âš ï¸ åˆ·æ–°è´Ÿè½½å‡è¡¡å™¨å¤±è´¥:', error)\n+    }\n+\n+    return config\n+  }\n+\n+  /**\n    * åˆå§‹åŒ–é…ç½®æœåŠ¡\n    */\n   async initialize() {\n     try {\n"
                },
                {
                    "date": 1752552527955,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -187,56 +187,8 @@\n     console.log('ğŸ—‘ï¸ é…ç½®ç¼“å­˜å·²æ¸…é™¤')\n   }\n \n   /**\n-   * å¼ºåˆ¶åˆ·æ–°é…ç½®å¹¶æ¸…é™¤æ‰€æœ‰ç›¸å…³ç¼“å­˜\n-   */\n-  async forceRefresh() {\n-    console.log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°é…ç½®å’ŒæœåŠ¡å™¨åˆ—è¡¨...')\n-\n-    // æ¸…é™¤é…ç½®ç¼“å­˜\n-    this.clearCache()\n-\n-    // é‡æ–°è·å–é…ç½®\n-    const config = await this.getConfig(true)\n-\n-    // é€šçŸ¥è´Ÿè½½å‡è¡¡å™¨é‡æ–°åŠ è½½æœåŠ¡å™¨åˆ—è¡¨\n-    try {\n-      const { default: loadBalancer } = await import('./loadBalancer.js')\n-      await loadBalancer.loadServerList()\n-      console.log('âœ… è´Ÿè½½å‡è¡¡å™¨æœåŠ¡å™¨åˆ—è¡¨å·²åˆ·æ–°')\n-    } catch (error) {\n-      console.warn('âš ï¸ åˆ·æ–°è´Ÿè½½å‡è¡¡å™¨å¤±è´¥:', error)\n-    }\n-\n-    return config\n-  }\n-\n-  /**\n-   * å¼ºåˆ¶åˆ·æ–°é…ç½®å¹¶æ¸…é™¤æ‰€æœ‰ç›¸å…³ç¼“å­˜\n-   */\n-  async forceRefresh() {\n-    console.log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°é…ç½®å’ŒæœåŠ¡å™¨åˆ—è¡¨...')\n-\n-    // æ¸…é™¤é…ç½®ç¼“å­˜\n-    this.clearCache()\n-\n-    // é‡æ–°è·å–é…ç½®\n-    const config = await this.getConfig(true)\n-\n-    // é€šçŸ¥è´Ÿè½½å‡è¡¡å™¨é‡æ–°åŠ è½½æœåŠ¡å™¨åˆ—è¡¨\n-    try {\n-      const { default: loadBalancer } = await import('./loadBalancer.js')\n-      await loadBalancer.loadServerList()\n-      console.log('âœ… è´Ÿè½½å‡è¡¡å™¨æœåŠ¡å™¨åˆ—è¡¨å·²åˆ·æ–°')\n-    } catch (error) {\n-      console.warn('âš ï¸ åˆ·æ–°è´Ÿè½½å‡è¡¡å™¨å¤±è´¥:', error)\n-    }\n-\n-    return config\n-  }\n-\n-  /**\n    * åˆå§‹åŒ–é…ç½®æœåŠ¡\n    */\n   async initialize() {\n     try {\n"
                },
                {
                    "date": 1752811577361,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -210,5 +210,9 @@\n \n // åˆ›å»ºå•ä¾‹å®ä¾‹\n const configService = new ConfigService()\n \n+// å¯¼å‡ºä¾¿æ·å‡½æ•°\n+export const getPublicConfig = () => configService.getConfig()\n+export const getConfig = () => configService.getConfig()\n+\n export default configService\n"
                },
                {
                    "date": 1753719385673,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,218 +1,222 @@\n-// é…ç½®æœåŠ¡ - ä»æœåŠ¡ç«¯APIè·å–é…ç½®æ•°æ®\n-import { updateComfyUIConfig, getCurrentConfig } from './comfyui.js'\n-import { updateAPIConfig } from './api.js'\n-\n-// é…ç½®æœåŠ¡ç±»\n-class ConfigService {\n-  constructor() {\n-    this.configCache = null\n-    this.lastFetchTime = 0\n-    this.cacheTimeout = 5 * 60 * 1000 // 5åˆ†é’Ÿç¼“å­˜\n-  }\n-\n-  /**\n-   * ä»æœåŠ¡ç«¯è·å–å…¬å¼€é…ç½®\n-   */\n-  async fetchServerConfig() {\n-    try {\n-      console.log('ğŸ”„ ä»æœåŠ¡ç«¯è·å–é…ç½®...')\n-\n-      const response = await fetch('/api/config', {\n-        method: 'GET',\n-        headers: {\n-          'Content-Type': 'application/json'\n-        }\n-      })\n-\n-      if (!response.ok) {\n-        throw new Error(`HTTP ${response.status}: ${response.statusText}`)\n-      }\n-\n-      const result = await response.json()\n-\n-      if (result.success && result.data) {\n-        console.log('âœ… æœåŠ¡ç«¯é…ç½®è·å–æˆåŠŸ:', result.data)\n-        this.configCache = result.data\n-        this.lastFetchTime = Date.now()\n-        return result.data\n-      } else {\n-        throw new Error(result.message || 'è·å–é…ç½®å¤±è´¥')\n-      }\n-    } catch (error) {\n-      console.error('âŒ è·å–æœåŠ¡ç«¯é…ç½®å¤±è´¥:', error)\n-      throw error\n-    }\n-  }\n-\n-  /**\n-   * è·å–é»˜è®¤é…ç½®ï¼ˆå½“æœåŠ¡ç«¯ä¸å¯ç”¨æ—¶ä½¿ç”¨ï¼‰\n-   */\n-  getDefaultConfig() {\n-    return {\n-      'comfyui.server_url': 'https://l9s75ay3rp-8188.cnb.run',\n-      'comfyui.backup_servers': 'https://0rv00xh2vg-8188.cnb.run',\n-      'comfyui.client_id': 'abc1373d4ad648a3a81d0587fbe5534b',\n-      'comfyui.timeout': 300000,\n-      'comfyui.health_check_timeout': 10000,\n-      'comfyui.auto_switch': true,\n-      'comfyui.retry_attempts': 3,\n-      'comfyui.switch_threshold': 2,\n-      'ai.text_to_image_points': 20,\n-      'ai.face_swap_points': 20,\n-      'ai.undress_points': 20\n-    }\n-  }\n-\n-  /**\n-   * è·å–é…ç½®ï¼ˆå¸¦ç¼“å­˜ï¼‰\n-   */\n-  async getConfig(forceRefresh = false) {\n-    const now = Date.now()\n-\n-    // å¦‚æœæœ‰ç¼“å­˜ä¸”æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›ç¼“å­˜\n-    if (!forceRefresh && this.configCache && (now - this.lastFetchTime) < this.cacheTimeout) {\n-      console.log('ğŸ“‹ ä½¿ç”¨ç¼“å­˜çš„é…ç½®')\n-      return this.configCache\n-    }\n-\n-    try {\n-      // ä»æœåŠ¡ç«¯è·å–æœ€æ–°é…ç½®\n-      return await this.fetchServerConfig()\n-    } catch (error) {\n-      console.warn('âš ï¸ æ— æ³•ä»æœåŠ¡ç«¯è·å–é…ç½®:', error.message)\n-\n-      // å¦‚æœè·å–å¤±è´¥ï¼Œè¿”å›ç¼“å­˜çš„é…ç½®ï¼ˆå¦‚æœæœ‰ï¼‰\n-      if (this.configCache) {\n-        console.warn('âš ï¸ ä½¿ç”¨ç¼“å­˜é…ç½®ä½œä¸ºå¤‡ç”¨')\n-        return this.configCache\n-      }\n-\n-      // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨é»˜è®¤é…ç½®\n-      console.warn('âš ï¸ ä½¿ç”¨é»˜è®¤é…ç½®ä½œä¸ºå¤‡ç”¨')\n-      const defaultConfig = this.getDefaultConfig()\n-      this.configCache = defaultConfig\n-      this.lastFetchTime = now\n-      return defaultConfig\n-    }\n-  }\n-\n-  /**\n-   * åŒæ­¥ComfyUIé…ç½®åˆ°æœ¬åœ°\n-   */\n-  async syncComfyUIConfig() {\n-    try {\n-      const serverConfig = await this.getConfig()\n-\n-      // æå–ComfyUIç›¸å…³é…ç½®\n-      const comfyuiConfig = {\n-        COMFYUI_SERVER_URL: serverConfig['comfyui.server_url'],\n-        CLIENT_ID: serverConfig['comfyui.client_id'],\n-        TIMEOUT: serverConfig['comfyui.timeout'] || 300000\n-      }\n-\n-      // è¿‡æ»¤æ‰ç©ºå€¼\n-      const filteredConfig = Object.fromEntries(\n-        Object.entries(comfyuiConfig).filter(([key, value]) => value != null && value !== '')\n-      )\n-\n-      if (Object.keys(filteredConfig).length > 0) {\n-        console.log('ğŸ”„ åŒæ­¥ComfyUIé…ç½®åˆ°æœ¬åœ°:', filteredConfig)\n-\n-        // æ›´æ–°æœ¬åœ°ComfyUIé…ç½®\n-        await updateComfyUIConfig(filteredConfig)\n-\n-        // åŒæ—¶æ›´æ–°APIé…ç½®\n-        updateAPIConfig(filteredConfig)\n-\n-        console.log('âœ… ComfyUIé…ç½®åŒæ­¥å®Œæˆ')\n-        return filteredConfig\n-      } else {\n-        console.warn('âš ï¸ æœåŠ¡ç«¯æœªæä¾›æœ‰æ•ˆçš„ComfyUIé…ç½®')\n-        return null\n-      }\n-    } catch (error) {\n-      console.error('âŒ åŒæ­¥ComfyUIé…ç½®å¤±è´¥:', error)\n-      throw error\n-    }\n-  }\n-\n-  /**\n-   * è·å–AIåŠŸèƒ½ç§¯åˆ†é…ç½®\n-   */\n-  async getAIPointsConfig() {\n-    try {\n-      const config = await this.getConfig()\n-      return {\n-        faceSwap: config['ai.face_swap_points'] || 20,\n-        undress: config['ai.undress_points'] || 20\n-      }\n-    } catch (error) {\n-      console.error('âŒ è·å–AIç§¯åˆ†é…ç½®å¤±è´¥:', error)\n-      // è¿”å›é»˜è®¤å€¼\n-      return {\n-        faceSwap: 20,\n-        undress: 20\n-      }\n-    }\n-  }\n-\n-  /**\n-   * è·å–å‰ç«¯é…ç½®\n-   */\n-  async getFrontendConfig() {\n-    try {\n-      const config = await this.getConfig()\n-      return {\n-        title: config['frontend.title'] || 'AI Magic - AIå›¾åƒå¤„ç†å¹³å°',\n-        apiBaseUrl: config['frontend.api_base_url'],\n-        version: config['frontend.version'] || '1.0.0'\n-      }\n-    } catch (error) {\n-      console.error('âŒ è·å–å‰ç«¯é…ç½®å¤±è´¥:', error)\n-      // è¿”å›é»˜è®¤å€¼\n-      return {\n-        title: 'AI Magic - AIå›¾åƒå¤„ç†å¹³å°',\n-        apiBaseUrl: '',\n-        version: '1.0.0'\n-      }\n-    }\n-  }\n-\n-  /**\n-   * æ¸…é™¤é…ç½®ç¼“å­˜\n-   */\n-  clearCache() {\n-    this.configCache = null\n-    this.lastFetchTime = 0\n-    console.log('ğŸ—‘ï¸ é…ç½®ç¼“å­˜å·²æ¸…é™¤')\n-  }\n-\n-  /**\n-   * åˆå§‹åŒ–é…ç½®æœåŠ¡\n-   */\n-  async initialize() {\n-    try {\n-      console.log('ğŸš€ åˆå§‹åŒ–é…ç½®æœåŠ¡...')\n-\n-      // è·å–æœåŠ¡ç«¯é…ç½®\n-      await this.getConfig()\n-\n-      // åŒæ­¥ComfyUIé…ç½®\n-      await this.syncComfyUIConfig()\n-\n-      console.log('âœ… é…ç½®æœåŠ¡åˆå§‹åŒ–å®Œæˆ')\n-    } catch (error) {\n-      console.error('âŒ é…ç½®æœåŠ¡åˆå§‹åŒ–å¤±è´¥:', error)\n-      // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸åº”ç”¨ç»§ç»­è¿è¡Œ\n-    }\n-  }\n-}\n-\n-// åˆ›å»ºå•ä¾‹å®ä¾‹\n-const configService = new ConfigService()\n-\n-// å¯¼å‡ºä¾¿æ·å‡½æ•°\n-export const getPublicConfig = () => configService.getConfig()\n-export const getConfig = () => configService.getConfig()\n-\n-export default configService\n+// é…ç½®æœåŠ¡ - ä»æœåŠ¡ç«¯APIè·å–é…ç½®æ•°æ®\r\n+import { updateComfyUIConfig, getCurrentConfig } from './comfyui.js'\r\n+import { updateAPIConfig } from './api.js'\r\n+\r\n+// é…ç½®æœåŠ¡ç±»\r\n+class ConfigService {\r\n+  constructor() {\r\n+    this.configCache = null\r\n+    this.lastFetchTime = 0\r\n+    this.cacheTimeout = 5 * 60 * 1000 // 5åˆ†é’Ÿç¼“å­˜\r\n+  }\r\n+\r\n+  /**\r\n+   * ä»æœåŠ¡ç«¯è·å–å…¬å¼€é…ç½®\r\n+   */\r\n+  async fetchServerConfig() {\r\n+    try {\r\n+      console.log('ğŸ”„ ä»æœåŠ¡ç«¯è·å–é…ç½®...')\r\n+\r\n+      // æ„å»ºæ­£ç¡®çš„API URL\r\n+      const baseUrl = import.meta.env.MODE === 'development' ? '' : (import.meta.env.VITE_API_BASE_URL || 'http://114.132.50.71:3007').replace('/api', '')\r\n+      const apiUrl = `${baseUrl}/api/public-config`\r\n+\r\n+      const response = await fetch(apiUrl, {\r\n+        method: 'GET',\r\n+        headers: {\r\n+          'Content-Type': 'application/json'\r\n+        }\r\n+      })\r\n+\r\n+      if (!response.ok) {\r\n+        throw new Error(`HTTP ${response.status}: ${response.statusText}`)\r\n+      }\r\n+\r\n+      const result = await response.json()\r\n+\r\n+      if (result.success && result.data) {\r\n+        console.log('âœ… æœåŠ¡ç«¯é…ç½®è·å–æˆåŠŸ:', result.data)\r\n+        this.configCache = result.data\r\n+        this.lastFetchTime = Date.now()\r\n+        return result.data\r\n+      } else {\r\n+        throw new Error(result.message || 'è·å–é…ç½®å¤±è´¥')\r\n+      }\r\n+    } catch (error) {\r\n+      console.error('âŒ è·å–æœåŠ¡ç«¯é…ç½®å¤±è´¥:', error)\r\n+      throw error\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * è·å–é»˜è®¤é…ç½®ï¼ˆå½“æœåŠ¡ç«¯ä¸å¯ç”¨æ—¶ä½¿ç”¨ï¼‰\r\n+   */\r\n+  getDefaultConfig() {\r\n+    return {\r\n+      'comfyui.server_url': 'https://l9s75ay3rp-8188.cnb.run',\r\n+      'comfyui.backup_servers': 'https://0rv00xh2vg-8188.cnb.run',\r\n+      'comfyui.client_id': 'abc1373d4ad648a3a81d0587fbe5534b',\r\n+      'comfyui.timeout': 300000,\r\n+      'comfyui.health_check_timeout': 10000,\r\n+      'comfyui.auto_switch': true,\r\n+      'comfyui.retry_attempts': 3,\r\n+      'comfyui.switch_threshold': 2,\r\n+      'ai.text_to_image_points': 20,\r\n+      'ai.face_swap_points': 20,\r\n+      'ai.undress_points': 20\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * è·å–é…ç½®ï¼ˆå¸¦ç¼“å­˜ï¼‰\r\n+   */\r\n+  async getConfig(forceRefresh = false) {\r\n+    const now = Date.now()\r\n+\r\n+    // å¦‚æœæœ‰ç¼“å­˜ä¸”æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›ç¼“å­˜\r\n+    if (!forceRefresh && this.configCache && (now - this.lastFetchTime) < this.cacheTimeout) {\r\n+      console.log('ğŸ“‹ ä½¿ç”¨ç¼“å­˜çš„é…ç½®')\r\n+      return this.configCache\r\n+    }\r\n+\r\n+    try {\r\n+      // ä»æœåŠ¡ç«¯è·å–æœ€æ–°é…ç½®\r\n+      return await this.fetchServerConfig()\r\n+    } catch (error) {\r\n+      console.warn('âš ï¸ æ— æ³•ä»æœåŠ¡ç«¯è·å–é…ç½®:', error.message)\r\n+\r\n+      // å¦‚æœè·å–å¤±è´¥ï¼Œè¿”å›ç¼“å­˜çš„é…ç½®ï¼ˆå¦‚æœæœ‰ï¼‰\r\n+      if (this.configCache) {\r\n+        console.warn('âš ï¸ ä½¿ç”¨ç¼“å­˜é…ç½®ä½œä¸ºå¤‡ç”¨')\r\n+        return this.configCache\r\n+      }\r\n+\r\n+      // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨é»˜è®¤é…ç½®\r\n+      console.warn('âš ï¸ ä½¿ç”¨é»˜è®¤é…ç½®ä½œä¸ºå¤‡ç”¨')\r\n+      const defaultConfig = this.getDefaultConfig()\r\n+      this.configCache = defaultConfig\r\n+      this.lastFetchTime = now\r\n+      return defaultConfig\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * åŒæ­¥ComfyUIé…ç½®åˆ°æœ¬åœ°\r\n+   */\r\n+  async syncComfyUIConfig() {\r\n+    try {\r\n+      const serverConfig = await this.getConfig()\r\n+\r\n+      // æå–ComfyUIç›¸å…³é…ç½®\r\n+      const comfyuiConfig = {\r\n+        COMFYUI_SERVER_URL: serverConfig['comfyui.server_url'],\r\n+        CLIENT_ID: serverConfig['comfyui.client_id'],\r\n+        TIMEOUT: serverConfig['comfyui.timeout'] || 300000\r\n+      }\r\n+\r\n+      // è¿‡æ»¤æ‰ç©ºå€¼\r\n+      const filteredConfig = Object.fromEntries(\r\n+        Object.entries(comfyuiConfig).filter(([key, value]) => value != null && value !== '')\r\n+      )\r\n+\r\n+      if (Object.keys(filteredConfig).length > 0) {\r\n+        console.log('ğŸ”„ åŒæ­¥ComfyUIé…ç½®åˆ°æœ¬åœ°:', filteredConfig)\r\n+\r\n+        // æ›´æ–°æœ¬åœ°ComfyUIé…ç½®\r\n+        await updateComfyUIConfig(filteredConfig)\r\n+\r\n+        // åŒæ—¶æ›´æ–°APIé…ç½®\r\n+        updateAPIConfig(filteredConfig)\r\n+\r\n+        console.log('âœ… ComfyUIé…ç½®åŒæ­¥å®Œæˆ')\r\n+        return filteredConfig\r\n+      } else {\r\n+        console.warn('âš ï¸ æœåŠ¡ç«¯æœªæä¾›æœ‰æ•ˆçš„ComfyUIé…ç½®')\r\n+        return null\r\n+      }\r\n+    } catch (error) {\r\n+      console.error('âŒ åŒæ­¥ComfyUIé…ç½®å¤±è´¥:', error)\r\n+      throw error\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * è·å–AIåŠŸèƒ½ç§¯åˆ†é…ç½®\r\n+   */\r\n+  async getAIPointsConfig() {\r\n+    try {\r\n+      const config = await this.getConfig()\r\n+      return {\r\n+        faceSwap: config['ai.face_swap_points'] || 20,\r\n+        undress: config['ai.undress_points'] || 20\r\n+      }\r\n+    } catch (error) {\r\n+      console.error('âŒ è·å–AIç§¯åˆ†é…ç½®å¤±è´¥:', error)\r\n+      // è¿”å›é»˜è®¤å€¼\r\n+      return {\r\n+        faceSwap: 20,\r\n+        undress: 20\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * è·å–å‰ç«¯é…ç½®\r\n+   */\r\n+  async getFrontendConfig() {\r\n+    try {\r\n+      const config = await this.getConfig()\r\n+      return {\r\n+        title: config['frontend.title'] || 'AI Magic - AIå›¾åƒå¤„ç†å¹³å°',\r\n+        apiBaseUrl: config['frontend.api_base_url'],\r\n+        version: config['frontend.version'] || '1.0.0'\r\n+      }\r\n+    } catch (error) {\r\n+      console.error('âŒ è·å–å‰ç«¯é…ç½®å¤±è´¥:', error)\r\n+      // è¿”å›é»˜è®¤å€¼\r\n+      return {\r\n+        title: 'AI Magic - AIå›¾åƒå¤„ç†å¹³å°',\r\n+        apiBaseUrl: '',\r\n+        version: '1.0.0'\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * æ¸…é™¤é…ç½®ç¼“å­˜\r\n+   */\r\n+  clearCache() {\r\n+    this.configCache = null\r\n+    this.lastFetchTime = 0\r\n+    console.log('ğŸ—‘ï¸ é…ç½®ç¼“å­˜å·²æ¸…é™¤')\r\n+  }\r\n+\r\n+  /**\r\n+   * åˆå§‹åŒ–é…ç½®æœåŠ¡\r\n+   */\r\n+  async initialize() {\r\n+    try {\r\n+      console.log('ğŸš€ åˆå§‹åŒ–é…ç½®æœåŠ¡...')\r\n+\r\n+      // è·å–æœåŠ¡ç«¯é…ç½®\r\n+      await this.getConfig()\r\n+\r\n+      // åŒæ­¥ComfyUIé…ç½®\r\n+      await this.syncComfyUIConfig()\r\n+\r\n+      console.log('âœ… é…ç½®æœåŠ¡åˆå§‹åŒ–å®Œæˆ')\r\n+    } catch (error) {\r\n+      console.error('âŒ é…ç½®æœåŠ¡åˆå§‹åŒ–å¤±è´¥:', error)\r\n+      // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸åº”ç”¨ç»§ç»­è¿è¡Œ\r\n+    }\r\n+  }\r\n+}\r\n+\r\n+// åˆ›å»ºå•ä¾‹å®ä¾‹\r\n+const configService = new ConfigService()\r\n+\r\n+// å¯¼å‡ºä¾¿æ·å‡½æ•°\r\n+export const getPublicConfig = () => configService.getConfig()\r\n+export const getConfig = () => configService.getConfig()\r\n+\r\n+export default configService\r\n"
                },
                {
                    "date": 1753720307273,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,8 @@\n // é…ç½®æœåŠ¡ - ä»æœåŠ¡ç«¯APIè·å–é…ç½®æ•°æ®\r\n import { updateComfyUIConfig, getCurrentConfig } from './comfyui.js'\r\n import { updateAPIConfig } from './api.js'\r\n+import { buildAPIURL, apiRequest, API_ENDPOINTS } from '../utils/apiConfig.js'\r\n \r\n // é…ç½®æœåŠ¡ç±»\r\n class ConfigService {\r\n   constructor() {\r\n"
                },
                {
                    "date": 1753720321990,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -17,25 +17,11 @@\n   async fetchServerConfig() {\r\n     try {\r\n       console.log('ğŸ”„ ä»æœåŠ¡ç«¯è·å–é…ç½®...')\r\n \r\n-      // æ„å»ºæ­£ç¡®çš„API URL\r\n-      const baseUrl = import.meta.env.MODE === 'development' ? '' : (import.meta.env.VITE_API_BASE_URL || 'http://114.132.50.71:3007').replace('/api', '')\r\n-      const apiUrl = `${baseUrl}/api/public-config`\r\n+      // ä½¿ç”¨ç»Ÿä¸€çš„APIé…ç½®\r\n+      const result = await apiRequest(API_ENDPOINTS.PUBLIC_CONFIG)\r\n \r\n-      const response = await fetch(apiUrl, {\r\n-        method: 'GET',\r\n-        headers: {\r\n-          'Content-Type': 'application/json'\r\n-        }\r\n-      })\r\n-\r\n-      if (!response.ok) {\r\n-        throw new Error(`HTTP ${response.status}: ${response.statusText}`)\r\n-      }\r\n-\r\n-      const result = await response.json()\r\n-\r\n       if (result.success && result.data) {\r\n         console.log('âœ… æœåŠ¡ç«¯é…ç½®è·å–æˆåŠŸ:', result.data)\r\n         this.configCache = result.data\r\n         this.lastFetchTime = Date.now()\r\n"
                }
            ],
            "date": 1752330171943,
            "name": "Commit-0",
            "content": "// é…ç½®æœåŠ¡ - ä»æœåŠ¡ç«¯APIè·å–é…ç½®æ•°æ®\nimport { updateComfyUIConfig, getCurrentConfig } from './comfyui.js'\nimport { updateAPIConfig } from './api.js'\n\n// é…ç½®æœåŠ¡ç±»\nclass ConfigService {\n  constructor() {\n    this.configCache = null\n    this.lastFetchTime = 0\n    this.cacheTimeout = 5 * 60 * 1000 // 5åˆ†é’Ÿç¼“å­˜\n  }\n\n  /**\n   * ä»æœåŠ¡ç«¯è·å–å…¬å¼€é…ç½®\n   */\n  async fetchServerConfig() {\n    try {\n      console.log('ğŸ”„ ä»æœåŠ¡ç«¯è·å–é…ç½®...')\n\n      const response = await fetch('/api/public-config', {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      })\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`)\n      }\n\n      const result = await response.json()\n\n      if (result.success && result.data) {\n        console.log('âœ… æœåŠ¡ç«¯é…ç½®è·å–æˆåŠŸ:', result.data)\n        this.configCache = result.data\n        this.lastFetchTime = Date.now()\n        return result.data\n      } else {\n        throw new Error(result.message || 'è·å–é…ç½®å¤±è´¥')\n      }\n    } catch (error) {\n      console.error('âŒ è·å–æœåŠ¡ç«¯é…ç½®å¤±è´¥:', error)\n      throw error\n    }\n  }\n\n  /**\n   * è·å–é…ç½®ï¼ˆå¸¦ç¼“å­˜ï¼‰\n   */\n  async getConfig(forceRefresh = false) {\n    const now = Date.now()\n\n    // å¦‚æœæœ‰ç¼“å­˜ä¸”æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›ç¼“å­˜\n    if (!forceRefresh && this.configCache && (now - this.lastFetchTime) < this.cacheTimeout) {\n      console.log('ğŸ“‹ ä½¿ç”¨ç¼“å­˜çš„é…ç½®')\n      return this.configCache\n    }\n\n    try {\n      // ä»æœåŠ¡ç«¯è·å–æœ€æ–°é…ç½®\n      return await this.fetchServerConfig()\n    } catch (error) {\n      // å¦‚æœè·å–å¤±è´¥ï¼Œè¿”å›ç¼“å­˜çš„é…ç½®ï¼ˆå¦‚æœæœ‰ï¼‰\n      if (this.configCache) {\n        console.warn('âš ï¸ ä½¿ç”¨ç¼“å­˜é…ç½®ä½œä¸ºå¤‡ç”¨')\n        return this.configCache\n      }\n      throw error\n    }\n  }\n\n  /**\n   * åŒæ­¥ComfyUIé…ç½®åˆ°æœ¬åœ°\n   */\n  async syncComfyUIConfig() {\n    try {\n      const serverConfig = await this.getConfig()\n\n      // æå–ComfyUIç›¸å…³é…ç½®\n      const comfyuiConfig = {\n        COMFYUI_SERVER_URL: serverConfig['comfyui.server_url'],\n        CLIENT_ID: serverConfig['comfyui.client_id'],\n        TIMEOUT: serverConfig['comfyui.timeout'] || 300000\n      }\n\n      // è¿‡æ»¤æ‰ç©ºå€¼\n      const filteredConfig = Object.fromEntries(\n        Object.entries(comfyuiConfig).filter(([key, value]) => value != null && value !== '')\n      )\n\n      if (Object.keys(filteredConfig).length > 0) {\n        console.log('ğŸ”„ åŒæ­¥ComfyUIé…ç½®åˆ°æœ¬åœ°:', filteredConfig)\n        await updateComfyUIConfig(filteredConfig)\n        console.log('âœ… ComfyUIé…ç½®åŒæ­¥å®Œæˆ')\n        return filteredConfig\n      } else {\n        console.warn('âš ï¸ æœåŠ¡ç«¯æœªæä¾›æœ‰æ•ˆçš„ComfyUIé…ç½®')\n        return null\n      }\n    } catch (error) {\n      console.error('âŒ åŒæ­¥ComfyUIé…ç½®å¤±è´¥:', error)\n      throw error\n    }\n  }\n\n  /**\n   * è·å–AIåŠŸèƒ½ç§¯åˆ†é…ç½®\n   */\n  async getAIPointsConfig() {\n    try {\n      const config = await this.getConfig()\n      return {\n        textToImage: config['ai.text_to_image_points'] || 20,\n        faceSwap: config['ai.face_swap_points'] || 20,\n        undress: config['ai.undress_points'] || 20\n      }\n    } catch (error) {\n      console.error('âŒ è·å–AIç§¯åˆ†é…ç½®å¤±è´¥:', error)\n      // è¿”å›é»˜è®¤å€¼\n      return {\n        textToImage: 20,\n        faceSwap: 20,\n        undress: 20\n      }\n    }\n  }\n\n  /**\n   * è·å–å‰ç«¯é…ç½®\n   */\n  async getFrontendConfig() {\n    try {\n      const config = await this.getConfig()\n      return {\n        title: config['frontend.title'] || 'AI Magic - AIå›¾åƒå¤„ç†å¹³å°',\n        apiBaseUrl: config['frontend.api_base_url'],\n        version: config['frontend.version'] || '1.0.0'\n      }\n    } catch (error) {\n      console.error('âŒ è·å–å‰ç«¯é…ç½®å¤±è´¥:', error)\n      // è¿”å›é»˜è®¤å€¼\n      return {\n        title: 'AI Magic - AIå›¾åƒå¤„ç†å¹³å°',\n        apiBaseUrl: '',\n        version: '1.0.0'\n      }\n    }\n  }\n\n  /**\n   * æ¸…é™¤é…ç½®ç¼“å­˜\n   */\n  clearCache() {\n    this.configCache = null\n    this.lastFetchTime = 0\n    console.log('ğŸ—‘ï¸ é…ç½®ç¼“å­˜å·²æ¸…é™¤')\n  }\n\n  /**\n   * åˆå§‹åŒ–é…ç½®æœåŠ¡\n   */\n  async initialize() {\n    try {\n      console.log('ğŸš€ åˆå§‹åŒ–é…ç½®æœåŠ¡...')\n\n      // è·å–æœåŠ¡ç«¯é…ç½®\n      await this.getConfig()\n\n      // åŒæ­¥ComfyUIé…ç½®\n      await this.syncComfyUIConfig()\n\n      console.log('âœ… é…ç½®æœåŠ¡åˆå§‹åŒ–å®Œæˆ')\n    } catch (error) {\n      console.error('âŒ é…ç½®æœåŠ¡åˆå§‹åŒ–å¤±è´¥:', error)\n      // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸åº”ç”¨ç»§ç»­è¿è¡Œ\n    }\n  }\n}\n\n// åˆ›å»ºå•ä¾‹å®ä¾‹\nconst configService = new ConfigService()\n\nexport default configService\n"
        }
    ]
}