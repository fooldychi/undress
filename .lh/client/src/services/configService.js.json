{
    "sourceFile": "client/src/services/configService.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1752330171943,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752330187186,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -89,9 +89,15 @@\n       )\n \n       if (Object.keys(filteredConfig).length > 0) {\n         console.log('ğŸ”„ åŒæ­¥ComfyUIé…ç½®åˆ°æœ¬åœ°:', filteredConfig)\n+\n+        // æ›´æ–°æœ¬åœ°ComfyUIé…ç½®\n         await updateComfyUIConfig(filteredConfig)\n+\n+        // åŒæ—¶æ›´æ–°APIé…ç½®\n+        updateAPIConfig(filteredConfig)\n+\n         console.log('âœ… ComfyUIé…ç½®åŒæ­¥å®Œæˆ')\n         return filteredConfig\n       } else {\n         console.warn('âš ï¸ æœåŠ¡ç«¯æœªæä¾›æœ‰æ•ˆçš„ComfyUIé…ç½®')\n"
                },
                {
                    "date": 1752330425122,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,9 +16,9 @@\n   async fetchServerConfig() {\n     try {\n       console.log('ğŸ”„ ä»æœåŠ¡ç«¯è·å–é…ç½®...')\n \n-      const response = await fetch('/api/public-config', {\n+      const response = await fetch('/api/config', {\n         method: 'GET',\n         headers: {\n           'Content-Type': 'application/json'\n         }\n"
                }
            ],
            "date": 1752330171943,
            "name": "Commit-0",
            "content": "// é…ç½®æœåŠ¡ - ä»æœåŠ¡ç«¯APIè·å–é…ç½®æ•°æ®\nimport { updateComfyUIConfig, getCurrentConfig } from './comfyui.js'\nimport { updateAPIConfig } from './api.js'\n\n// é…ç½®æœåŠ¡ç±»\nclass ConfigService {\n  constructor() {\n    this.configCache = null\n    this.lastFetchTime = 0\n    this.cacheTimeout = 5 * 60 * 1000 // 5åˆ†é’Ÿç¼“å­˜\n  }\n\n  /**\n   * ä»æœåŠ¡ç«¯è·å–å…¬å¼€é…ç½®\n   */\n  async fetchServerConfig() {\n    try {\n      console.log('ğŸ”„ ä»æœåŠ¡ç«¯è·å–é…ç½®...')\n\n      const response = await fetch('/api/public-config', {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      })\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`)\n      }\n\n      const result = await response.json()\n\n      if (result.success && result.data) {\n        console.log('âœ… æœåŠ¡ç«¯é…ç½®è·å–æˆåŠŸ:', result.data)\n        this.configCache = result.data\n        this.lastFetchTime = Date.now()\n        return result.data\n      } else {\n        throw new Error(result.message || 'è·å–é…ç½®å¤±è´¥')\n      }\n    } catch (error) {\n      console.error('âŒ è·å–æœåŠ¡ç«¯é…ç½®å¤±è´¥:', error)\n      throw error\n    }\n  }\n\n  /**\n   * è·å–é…ç½®ï¼ˆå¸¦ç¼“å­˜ï¼‰\n   */\n  async getConfig(forceRefresh = false) {\n    const now = Date.now()\n\n    // å¦‚æœæœ‰ç¼“å­˜ä¸”æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›ç¼“å­˜\n    if (!forceRefresh && this.configCache && (now - this.lastFetchTime) < this.cacheTimeout) {\n      console.log('ğŸ“‹ ä½¿ç”¨ç¼“å­˜çš„é…ç½®')\n      return this.configCache\n    }\n\n    try {\n      // ä»æœåŠ¡ç«¯è·å–æœ€æ–°é…ç½®\n      return await this.fetchServerConfig()\n    } catch (error) {\n      // å¦‚æœè·å–å¤±è´¥ï¼Œè¿”å›ç¼“å­˜çš„é…ç½®ï¼ˆå¦‚æœæœ‰ï¼‰\n      if (this.configCache) {\n        console.warn('âš ï¸ ä½¿ç”¨ç¼“å­˜é…ç½®ä½œä¸ºå¤‡ç”¨')\n        return this.configCache\n      }\n      throw error\n    }\n  }\n\n  /**\n   * åŒæ­¥ComfyUIé…ç½®åˆ°æœ¬åœ°\n   */\n  async syncComfyUIConfig() {\n    try {\n      const serverConfig = await this.getConfig()\n\n      // æå–ComfyUIç›¸å…³é…ç½®\n      const comfyuiConfig = {\n        COMFYUI_SERVER_URL: serverConfig['comfyui.server_url'],\n        CLIENT_ID: serverConfig['comfyui.client_id'],\n        TIMEOUT: serverConfig['comfyui.timeout'] || 300000\n      }\n\n      // è¿‡æ»¤æ‰ç©ºå€¼\n      const filteredConfig = Object.fromEntries(\n        Object.entries(comfyuiConfig).filter(([key, value]) => value != null && value !== '')\n      )\n\n      if (Object.keys(filteredConfig).length > 0) {\n        console.log('ğŸ”„ åŒæ­¥ComfyUIé…ç½®åˆ°æœ¬åœ°:', filteredConfig)\n        await updateComfyUIConfig(filteredConfig)\n        console.log('âœ… ComfyUIé…ç½®åŒæ­¥å®Œæˆ')\n        return filteredConfig\n      } else {\n        console.warn('âš ï¸ æœåŠ¡ç«¯æœªæä¾›æœ‰æ•ˆçš„ComfyUIé…ç½®')\n        return null\n      }\n    } catch (error) {\n      console.error('âŒ åŒæ­¥ComfyUIé…ç½®å¤±è´¥:', error)\n      throw error\n    }\n  }\n\n  /**\n   * è·å–AIåŠŸèƒ½ç§¯åˆ†é…ç½®\n   */\n  async getAIPointsConfig() {\n    try {\n      const config = await this.getConfig()\n      return {\n        textToImage: config['ai.text_to_image_points'] || 20,\n        faceSwap: config['ai.face_swap_points'] || 20,\n        undress: config['ai.undress_points'] || 20\n      }\n    } catch (error) {\n      console.error('âŒ è·å–AIç§¯åˆ†é…ç½®å¤±è´¥:', error)\n      // è¿”å›é»˜è®¤å€¼\n      return {\n        textToImage: 20,\n        faceSwap: 20,\n        undress: 20\n      }\n    }\n  }\n\n  /**\n   * è·å–å‰ç«¯é…ç½®\n   */\n  async getFrontendConfig() {\n    try {\n      const config = await this.getConfig()\n      return {\n        title: config['frontend.title'] || 'AI Magic - AIå›¾åƒå¤„ç†å¹³å°',\n        apiBaseUrl: config['frontend.api_base_url'],\n        version: config['frontend.version'] || '1.0.0'\n      }\n    } catch (error) {\n      console.error('âŒ è·å–å‰ç«¯é…ç½®å¤±è´¥:', error)\n      // è¿”å›é»˜è®¤å€¼\n      return {\n        title: 'AI Magic - AIå›¾åƒå¤„ç†å¹³å°',\n        apiBaseUrl: '',\n        version: '1.0.0'\n      }\n    }\n  }\n\n  /**\n   * æ¸…é™¤é…ç½®ç¼“å­˜\n   */\n  clearCache() {\n    this.configCache = null\n    this.lastFetchTime = 0\n    console.log('ğŸ—‘ï¸ é…ç½®ç¼“å­˜å·²æ¸…é™¤')\n  }\n\n  /**\n   * åˆå§‹åŒ–é…ç½®æœåŠ¡\n   */\n  async initialize() {\n    try {\n      console.log('ğŸš€ åˆå§‹åŒ–é…ç½®æœåŠ¡...')\n\n      // è·å–æœåŠ¡ç«¯é…ç½®\n      await this.getConfig()\n\n      // åŒæ­¥ComfyUIé…ç½®\n      await this.syncComfyUIConfig()\n\n      console.log('âœ… é…ç½®æœåŠ¡åˆå§‹åŒ–å®Œæˆ')\n    } catch (error) {\n      console.error('âŒ é…ç½®æœåŠ¡åˆå§‹åŒ–å¤±è´¥:', error)\n      // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸åº”ç”¨ç»§ç»­è¿è¡Œ\n    }\n  }\n}\n\n// åˆ›å»ºå•ä¾‹å®ä¾‹\nconst configService = new ConfigService()\n\nexport default configService\n"
        }
    ]
}