{
    "sourceFile": "client/src/services/ComfyUIWebSocketAdapter.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1753463668651,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1753463707565,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -445,4 +445,189 @@\n \n     // æ›´æ–°è¿›åº¦\n     this.safeProgressCallback(promptId, `ç¼“å­˜å‘½ä¸­ ${data.nodes.length} ä¸ªèŠ‚ç‚¹`, 25)\n   }\n+\n+  /**\n+   * ğŸ”§ å¤„ç†æ‰§è¡Œé”™è¯¯æ¶ˆæ¯\n+   */\n+  handleExecutionError(message) {\n+    const data = message.data\n+    if (!data || !data.prompt_id) {\n+      return\n+    }\n+\n+    const promptId = data.prompt_id\n+    const task = this.getTask(promptId)\n+    if (!task) {\n+      console.log(`ğŸ” [${webSocketManager.windowId}] å¿½ç•¥å…¶ä»–çª—å£çš„æ‰§è¡Œé”™è¯¯æ¶ˆæ¯: ${promptId}`)\n+      return\n+    }\n+\n+    console.error(`âŒ [${webSocketManager.windowId}] ä»»åŠ¡æ‰§è¡Œé”™è¯¯: ${promptId}`, data)\n+\n+    // æ›´æ–°ä»»åŠ¡çŠ¶æ€\n+    this.updateTaskStatus(promptId, TASK_STATUS.ERROR, {\n+      errorTime: Date.now(),\n+      errorData: data\n+    })\n+\n+    // æ¸…ç†ä»»åŠ¡\n+    this.removeTask(promptId)\n+\n+    // è°ƒç”¨é”™è¯¯å›è°ƒ\n+    if (task.onError) {\n+      const error = new Error(`æ‰§è¡Œé”™è¯¯: ${data.exception_message || 'æœªçŸ¥é”™è¯¯'}`)\n+      error.details = data\n+      task.onError(error)\n+    }\n+  }\n+\n+  /**\n+   * ğŸ”§ å¤„ç†æ‰§è¡Œä¸­æ–­æ¶ˆæ¯\n+   */\n+  handleExecutionInterrupted(message) {\n+    const data = message.data\n+    if (!data || !data.prompt_id) {\n+      return\n+    }\n+\n+    const promptId = data.prompt_id\n+    const task = this.getTask(promptId)\n+    if (!task) {\n+      console.log(`ğŸ” [${webSocketManager.windowId}] å¿½ç•¥å…¶ä»–çª—å£çš„æ‰§è¡Œä¸­æ–­æ¶ˆæ¯: ${promptId}`)\n+      return\n+    }\n+\n+    console.warn(`âš ï¸ [${webSocketManager.windowId}] ä»»åŠ¡è¢«ä¸­æ–­: ${promptId}`)\n+\n+    // æ›´æ–°ä»»åŠ¡çŠ¶æ€\n+    this.updateTaskStatus(promptId, TASK_STATUS.INTERRUPTED, {\n+      interruptTime: Date.now()\n+    })\n+\n+    // æ¸…ç†ä»»åŠ¡\n+    this.removeTask(promptId)\n+\n+    // è°ƒç”¨é”™è¯¯å›è°ƒ\n+    if (task.onError) {\n+      task.onError(new Error('ä»»åŠ¡æ‰§è¡Œè¢«ä¸­æ–­'))\n+    }\n+  }\n+\n+  /**\n+   * ğŸ”§ å¤„ç†ä»»åŠ¡å®Œæˆ\n+   */\n+  async handleTaskCompletion(promptId) {\n+    const task = this.getTask(promptId)\n+    if (!task) {\n+      console.warn(`âš ï¸ [${webSocketManager.windowId}] ä»»åŠ¡æœªæ‰¾åˆ°æˆ–ä¸å±äºå½“å‰çª—å£: ${promptId}`)\n+      return\n+    }\n+\n+    console.log(`ğŸš€ [${webSocketManager.windowId}] å¼€å§‹å¤„ç†ä»»åŠ¡å®Œæˆ: ${promptId}`)\n+\n+    try {\n+      // æ›´æ–°è¿›åº¦åˆ°98%ï¼Œè¡¨ç¤ºæ­£åœ¨è·å–ç»“æœ\n+      this.safeProgressCallback(promptId, 'æ­£åœ¨è·å–å¤„ç†ç»“æœ...', 98)\n+\n+      // è§¦å‘å®Œæˆå›è°ƒ\n+      const handlers = this.taskHandlers.get(promptId)\n+      if (handlers && handlers.onComplete) {\n+        // ç«‹å³æ›´æ–°è¿›åº¦åˆ°100%\n+        this.safeProgressCallback(promptId, 'å¤„ç†å®Œæˆ', 100)\n+\n+        // æ¸…ç†ä»»åŠ¡\n+        this.removeTask(promptId)\n+\n+        // æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n+        this.checkServerUnlockCondition()\n+\n+        console.log(`ğŸ‰ [${webSocketManager.windowId}] è°ƒç”¨å®Œæˆå›è°ƒ: ${promptId}`)\n+\n+        // ä½¿ç”¨setTimeoutç¡®ä¿å›è°ƒç«‹å³æ‰§è¡Œ\n+        setTimeout(() => {\n+          handlers.onComplete({ promptId })\n+        }, 0)\n+      }\n+\n+    } catch (error) {\n+      console.error(`âŒ [${webSocketManager.windowId}] ä»»åŠ¡å®Œæˆå¤„ç†å¤±è´¥: ${promptId}`, error)\n+\n+      // æ¸…ç†ä»»åŠ¡\n+      this.removeTask(promptId)\n+\n+      // è°ƒç”¨é”™è¯¯å›è°ƒ\n+      if (task.onError) {\n+        task.onError(error)\n+      }\n+    }\n+  }\n+\n+  /**\n+   * ğŸ”§ æ£€æŸ¥æœåŠ¡å™¨è§£é”æ¡ä»¶\n+   */\n+  checkServerUnlockCondition() {\n+    if (this.tasks.size === 0) {\n+      console.log(`ğŸ”“ [${webSocketManager.windowId}] æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼Œè‡ªåŠ¨è§£é”æœåŠ¡å™¨`)\n+      webSocketManager.unlockServer()\n+      return true\n+    } else {\n+      console.log(`ğŸ”’ [${webSocketManager.windowId}] ä»æœ‰ ${this.tasks.size} ä¸ªå¾…å¤„ç†ä»»åŠ¡ï¼Œä¿æŒæœåŠ¡å™¨é”å®š`)\n+\n+      // åˆ—å‡ºå¾…å¤„ç†ä»»åŠ¡\n+      const taskIds = Array.from(this.tasks.keys())\n+      console.log(`ğŸ“‹ [${webSocketManager.windowId}] å¾…å¤„ç†ä»»åŠ¡: [${taskIds.join(', ')}]`)\n+\n+      return false\n+    }\n+  }\n+\n+  /**\n+   * ğŸ”§ è·å–WebSocketçŠ¶æ€\n+   */\n+  getWebSocketStatus() {\n+    const wsStatus = webSocketManager.getStatus()\n+    return {\n+      ...wsStatus,\n+      taskCount: this.tasks.size,\n+      tasks: Array.from(this.tasks.keys())\n+    }\n+  }\n+\n+  /**\n+   * ğŸ”§ æ–­å¼€è¿æ¥\n+   */\n+  disconnect() {\n+    webSocketManager.disconnect()\n+    this.tasks.clear()\n+    this.taskHandlers.clear()\n+    this.progressCallbackDebounce.clear()\n+    console.log(`ğŸ”Œ [${webSocketManager.windowId}] ComfyUIé€‚é…å™¨å·²æ–­å¼€è¿æ¥`)\n+  }\n+\n+  /**\n+   * ğŸ”§ è°ƒè¯•ä¿¡æ¯\n+   */\n+  debug() {\n+    const wsStatus = this.getWebSocketStatus()\n+    console.log(`ğŸ” [${webSocketManager.windowId}] ===== ComfyUIé€‚é…å™¨çŠ¶æ€ =====`)\n+    console.log(`ğŸ“Š ä»»åŠ¡æ•°é‡: ${wsStatus.taskCount}`)\n+    console.log(`ğŸ“‹ ä»»åŠ¡åˆ—è¡¨: [${wsStatus.tasks.join(', ')}]`)\n+    console.log(`ğŸ”— WebSocketçŠ¶æ€: ${wsStatus.state}`)\n+    console.log(`ğŸ”’ é”å®šæœåŠ¡å™¨: ${wsStatus.lockedServer || 'æ— '}`)\n+    console.log(`ğŸ” [${webSocketManager.windowId}] ===== çŠ¶æ€ä¿¡æ¯ç»“æŸ =====`)\n+\n+    return wsStatus\n+  }\n+}\n+\n+// åˆ›å»ºå…¨å±€å®ä¾‹\n+const comfyUIAdapter = new ComfyUIWebSocketAdapter()\n+\n+// æš´éœ²è°ƒè¯•å‡½æ•°åˆ°å…¨å±€\n+if (typeof window !== 'undefined') {\n+  window.comfyUIAdapter = comfyUIAdapter\n+  window.debugComfyUIAdapter = () => comfyUIAdapter.debug()\n+}\n+\n+export default comfyUIAdapter\n"
                }
            ],
            "date": 1753463668651,
            "name": "Commit-0",
            "content": "/**\n * ğŸ”¥ ComfyUI WebSocketé€‚é…å™¨\n *\n * å°†ç‹¬ç«‹çš„WebSocketç®¡ç†å™¨é€‚é…åˆ°ComfyUIæœåŠ¡\n *\n * æ ¸å¿ƒåŠŸèƒ½ï¼š\n * 1. å°†WebSocketæ¶ˆæ¯é€‚é…ä¸ºComfyUIä¸šåŠ¡é€»è¾‘\n * 2. ç®¡ç†ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸå’ŒçŠ¶æ€\n * 3. æä¾›å‘åå…¼å®¹çš„APIæ¥å£\n * 4. å¤„ç†å¤šçª—å£ä»»åŠ¡éš”ç¦»\n *\n * æ¶æ„ä¼˜åŠ¿ï¼š\n * - ä¸šåŠ¡é€»è¾‘ä¸WebSocketç®¡ç†è§£è€¦\n * - ä¿æŒåŸæœ‰APIæ¥å£ä¸å˜\n * - æ”¯æŒä»»åŠ¡çŠ¶æ€ç®¡ç†å’Œè¿›åº¦å›è°ƒ\n * - æä¾›å®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶\n */\n\nimport webSocketManager from './WebSocketManager.js'\n\n// ä»»åŠ¡çŠ¶æ€æšä¸¾\nexport const TASK_STATUS = {\n  WAITING: 'waiting',\n  EXECUTING: 'executing',\n  COMPLETED: 'completed',\n  ERROR: 'error',\n  INTERRUPTED: 'interrupted'\n}\n\nclass ComfyUIWebSocketAdapter {\n  constructor() {\n    // ä»»åŠ¡ç®¡ç†ï¼ˆçª—å£çº§åˆ«ï¼‰\n    this.tasks = new Map() // promptId -> task\n    this.taskHandlers = new Map() // promptId -> handlers\n\n    // è¿›åº¦å›è°ƒé˜²æŠ–\n    this.progressCallbackDebounce = new Map()\n\n    // è®¾ç½®äº‹ä»¶å¤„ç†å™¨\n    this.setupEventHandlers()\n\n    console.log(`ğŸ”§ [${webSocketManager.windowId}] ComfyUI WebSocketé€‚é…å™¨åˆå§‹åŒ–å®Œæˆ`)\n  }\n\n  /**\n   * ğŸ”§ è®¾ç½®äº‹ä»¶å¤„ç†å™¨\n   */\n  setupEventHandlers() {\n    // ç›‘å¬WebSocketè¿æ¥äº‹ä»¶\n    webSocketManager.on('connected', this.handleConnected.bind(this))\n    webSocketManager.on('disconnected', this.handleDisconnected.bind(this))\n    webSocketManager.on('error', this.handleError.bind(this))\n\n    // ç›‘å¬WebSocketæ¶ˆæ¯\n    webSocketManager.on('message', this.handleMessage.bind(this))\n\n    // ç›‘å¬ç‰¹å®šæ¶ˆæ¯ç±»å‹\n    webSocketManager.on('message:executing', this.handleExecuting.bind(this))\n    webSocketManager.on('message:executed', this.handleExecuted.bind(this))\n    webSocketManager.on('message:progress', this.handleProgress.bind(this))\n    webSocketManager.on('message:status', this.handleStatus.bind(this))\n    webSocketManager.on('message:execution_start', this.handleExecutionStart.bind(this))\n    webSocketManager.on('message:execution_error', this.handleExecutionError.bind(this))\n    webSocketManager.on('message:execution_interrupted', this.handleExecutionInterrupted.bind(this))\n    webSocketManager.on('message:execution_cached', this.handleExecutionCached.bind(this))\n\n    console.log(`ğŸ“¡ [${webSocketManager.windowId}] WebSocketäº‹ä»¶å¤„ç†å™¨å·²è®¾ç½®`)\n  }\n\n  /**\n   * ğŸ”§ ç¡®ä¿WebSocketè¿æ¥\n   */\n  async ensureConnection(serverUrl = null) {\n    try {\n      const connected = await webSocketManager.ensureConnection(serverUrl)\n\n      if (connected) {\n        console.log(`âœ… [${webSocketManager.windowId}] WebSocketè¿æ¥ç¡®ä¿æˆåŠŸ`)\n      } else {\n        console.warn(`âš ï¸ [${webSocketManager.windowId}] WebSocketè¿æ¥å¤±è´¥ï¼Œä½†ä¸é˜»æ­¢æ“ä½œ`)\n      }\n\n      return connected\n    } catch (error) {\n      console.warn(`âš ï¸ [${webSocketManager.windowId}] WebSocketè¿æ¥å¼‚å¸¸:`, error.message)\n      return false\n    }\n  }\n\n  /**\n   * ğŸ”§ æ³¨å†Œä»»åŠ¡\n   */\n  registerTask(promptId, task) {\n    // ç¡®ä¿ä»»åŠ¡å±äºå½“å‰çª—å£\n    task.windowId = webSocketManager.windowId\n    task.clientId = webSocketManager.clientId\n    task.registeredAt = Date.now()\n    task.status = task.status || TASK_STATUS.WAITING\n\n    this.tasks.set(promptId, task)\n\n    console.log(`ğŸ“ [${webSocketManager.windowId}] æ³¨å†Œä»»åŠ¡: ${promptId}`)\n    console.log(`ğŸ“Š [${webSocketManager.windowId}] å½“å‰ä»»åŠ¡æ•°: ${this.tasks.size}`)\n\n    return task\n  }\n\n  /**\n   * ğŸ”§ è·å–ä»»åŠ¡\n   */\n  getTask(promptId) {\n    const task = this.tasks.get(promptId)\n\n    // éªŒè¯ä»»åŠ¡æ˜¯å¦å±äºå½“å‰çª—å£\n    if (task && task.windowId !== webSocketManager.windowId) {\n      console.warn(`âš ï¸ [${webSocketManager.windowId}] ä»»åŠ¡ ${promptId} ä¸å±äºå½“å‰çª—å£`)\n      return null\n    }\n\n    return task\n  }\n\n  /**\n   * ğŸ”§ ç§»é™¤ä»»åŠ¡\n   */\n  removeTask(promptId) {\n    const task = this.getTask(promptId)\n    if (task) {\n      this.tasks.delete(promptId)\n      this.taskHandlers.delete(promptId)\n      this.progressCallbackDebounce.delete(promptId)\n\n      console.log(`ğŸ§¹ [${webSocketManager.windowId}] ç§»é™¤ä»»åŠ¡: ${promptId}`)\n      console.log(`ğŸ“Š [${webSocketManager.windowId}] å‰©ä½™ä»»åŠ¡æ•°: ${this.tasks.size}`)\n\n      return true\n    }\n    return false\n  }\n\n  /**\n   * ğŸ”§ æ³¨å†Œä»»åŠ¡å¤„ç†å™¨\n   */\n  registerTaskHandler(promptId, handlers) {\n    this.taskHandlers.set(promptId, handlers)\n    console.log(`ğŸ“¡ [${webSocketManager.windowId}] æ³¨å†Œä»»åŠ¡å¤„ç†å™¨: ${promptId}`)\n  }\n\n  /**\n   * ğŸ”§ ç§»é™¤ä»»åŠ¡å¤„ç†å™¨\n   */\n  unregisterTaskHandler(promptId) {\n    this.taskHandlers.delete(promptId)\n    console.log(`ğŸ“¡ [${webSocketManager.windowId}] ç§»é™¤ä»»åŠ¡å¤„ç†å™¨: ${promptId}`)\n  }\n\n  /**\n   * ğŸ”§ æ›´æ–°ä»»åŠ¡çŠ¶æ€\n   */\n  updateTaskStatus(promptId, newStatus, additionalData = {}) {\n    const task = this.getTask(promptId)\n    if (!task) {\n      console.warn(`âš ï¸ [${webSocketManager.windowId}] å°è¯•æ›´æ–°ä¸å­˜åœ¨çš„ä»»åŠ¡çŠ¶æ€: ${promptId}`)\n      return false\n    }\n\n    const oldStatus = task.status\n    task.status = newStatus\n    task.lastStatusUpdate = Date.now()\n\n    // åˆå¹¶é¢å¤–æ•°æ®\n    Object.assign(task, additionalData)\n\n    console.log(`ğŸ”„ [${webSocketManager.windowId}] ä»»åŠ¡çŠ¶æ€å˜æ›´: ${promptId} ${oldStatus} â†’ ${newStatus}`)\n\n    return true\n  }\n\n  /**\n   * ğŸ”§ å®‰å…¨çš„è¿›åº¦å›è°ƒ\n   */\n  safeProgressCallback(promptId, message, percent) {\n    const task = this.getTask(promptId)\n    if (!task || !task.onProgress) return\n\n    // é˜²æŠ–ï¼šåŒä¸€ä»»åŠ¡çš„è¿›åº¦å›è°ƒé—´éš”è‡³å°‘100ms\n    const lastCallTime = this.progressCallbackDebounce.get(promptId) || 0\n    const now = Date.now()\n\n    if (now - lastCallTime < 100) {\n      console.log(`ğŸš« [${webSocketManager.windowId}] è¿›åº¦å›è°ƒé˜²æŠ–: ${promptId} (${percent}%)`)\n      return\n    }\n\n    this.progressCallbackDebounce.set(promptId, now)\n\n    try {\n      // ä½¿ç”¨queueMicrotaské¿å…é€’å½’æ›´æ–°\n      queueMicrotask(() => {\n        try {\n          task.onProgress(message, percent)\n        } catch (callbackError) {\n          console.error(`âŒ [${webSocketManager.windowId}] è¿›åº¦å›è°ƒæ‰§è¡Œå¤±è´¥: ${promptId}`, callbackError)\n\n          // å¦‚æœæ˜¯é€’å½’æ›´æ–°é”™è¯¯ï¼Œåœæ­¢åç»­å›è°ƒ\n          if (callbackError.message?.includes('Maximum recursive updates')) {\n            console.error(`ğŸ”¥ [${webSocketManager.windowId}] æ£€æµ‹åˆ°é€’å½’æ›´æ–°ï¼Œç¦ç”¨è¿›åº¦å›è°ƒ: ${promptId}`)\n            task.onProgress = null\n          }\n        }\n      })\n    } catch (error) {\n      console.error(`âŒ [${webSocketManager.windowId}] å®‰å…¨è¿›åº¦å›è°ƒå¤±è´¥: ${promptId}`, error)\n    }\n  }\n\n  /**\n   * ğŸ”§ å¤„ç†WebSocketè¿æ¥æˆåŠŸ\n   */\n  handleConnected(data) {\n    console.log(`âœ… [${webSocketManager.windowId}] WebSocketè¿æ¥æˆåŠŸ: ${data.server}`)\n  }\n\n  /**\n   * ğŸ”§ å¤„ç†WebSocketæ–­å¼€è¿æ¥\n   */\n  handleDisconnected(data) {\n    console.log(`ğŸ”Œ [${webSocketManager.windowId}] WebSocketè¿æ¥æ–­å¼€`)\n\n    // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿æŒæœåŠ¡å™¨é”å®šï¼ˆæœ‰å¾…å¤„ç†ä»»åŠ¡æ—¶ï¼‰\n    if (this.tasks.size > 0) {\n      console.log(`ğŸ”’ [${webSocketManager.windowId}] æœ‰ ${this.tasks.size} ä¸ªå¾…å¤„ç†ä»»åŠ¡ï¼Œä¿æŒæœåŠ¡å™¨é”å®š`)\n    } else {\n      console.log(`ğŸ”“ [${webSocketManager.windowId}] æ²¡æœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œå¯ä»¥è§£é”æœåŠ¡å™¨`)\n      webSocketManager.unlockServer()\n    }\n  }\n\n  /**\n   * ğŸ”§ å¤„ç†WebSocketé”™è¯¯\n   */\n  handleError(data) {\n    console.error(`âŒ [${webSocketManager.windowId}] WebSocketé”™è¯¯:`, data.error)\n  }\n\n  /**\n   * ğŸ”§ å¤„ç†WebSocketæ¶ˆæ¯\n   */\n  handleMessage(message) {\n    // é™é»˜å¤„ç†crystools.monitoræ¶ˆæ¯ï¼Œé¿å…å¹²æ‰°æ­£å¸¸æ¶ˆæ¯å¤„ç†\n    if (message.type === 'crystools.monitor') {\n      return\n    }\n\n    // è·¨æœåŠ¡å™¨æ¶ˆæ¯è¿‡æ»¤ï¼šåªå¤„ç†å±äºå½“å‰çª—å£çš„æ¶ˆæ¯\n    if (message.data && message.data.prompt_id) {\n      const task = this.getTask(message.data.prompt_id)\n      if (!task) {\n        // æ¶ˆæ¯ä¸å±äºå½“å‰çª—å£ï¼Œå¿½ç•¥ï¼ˆé¿å…è·¨æœåŠ¡å™¨å¹²æ‰°ï¼‰\n        console.log(`ğŸ” [${webSocketManager.windowId}] å¿½ç•¥å…¶ä»–çª—å£/æœåŠ¡å™¨çš„æ¶ˆæ¯: ${message.type} (prompt_id: ${message.data.prompt_id})`)\n        return\n      }\n\n      // è®°å½•æ¶ˆæ¯å¤„ç†æ—¥å¿—ï¼ˆç”¨äºè·¨æœåŠ¡å™¨è°ƒè¯•ï¼‰\n      console.log(`ğŸ“¨ [${webSocketManager.windowId}] å¤„ç†æ¶ˆæ¯: ${message.type} (prompt_id: ${message.data.prompt_id})`)\n    }\n  }\n\n  /**\n   * ğŸ”§ å¤„ç†æœåŠ¡å™¨çŠ¶æ€æ¶ˆæ¯\n   */\n  handleStatus(message) {\n    const data = message.data\n    if (!data || !data.status) {\n      return\n    }\n\n    const execInfo = data.status.exec_info\n    if (!execInfo) {\n      return\n    }\n\n    const queueRemaining = execInfo.queue_remaining || 0\n    console.log(`ğŸ“Š [${webSocketManager.windowId}] æœåŠ¡å™¨é˜Ÿåˆ—çŠ¶æ€: ${queueRemaining} ä¸ªä»»åŠ¡ç­‰å¾…`)\n\n    // åªæ›´æ–°å±äºå½“å‰çª—å£çš„ç­‰å¾…ä¸­ä»»åŠ¡çŠ¶æ€\n    this.tasks.forEach((task, promptId) => {\n      if (task.windowId === webSocketManager.windowId && task.status === TASK_STATUS.WAITING) {\n        if (queueRemaining > 1) {\n          this.safeProgressCallback(promptId, `é˜Ÿåˆ—ä¸­è¿˜æœ‰ ${queueRemaining} ä¸ªä»»åŠ¡ç­‰å¾…`, 8)\n        } else if (queueRemaining === 1) {\n          this.safeProgressCallback(promptId, 'é˜Ÿåˆ—ä¸­è¿˜æœ‰ 1 ä¸ªä»»åŠ¡ç­‰å¾…', 10)\n        } else {\n          this.safeProgressCallback(promptId, 'å³å°†å¼€å§‹å¤„ç†...', 12)\n        }\n      }\n    })\n  }\n\n  /**\n   * ğŸ”§ å¤„ç†ä»»åŠ¡å¼€å§‹æ‰§è¡Œæ¶ˆæ¯\n   */\n  handleExecutionStart(message) {\n    const data = message.data\n    if (!data || !data.prompt_id) {\n      return\n    }\n\n    const promptId = data.prompt_id\n    const task = this.getTask(promptId)\n    if (!task) {\n      console.log(`ğŸ” [${webSocketManager.windowId}] å¿½ç•¥å…¶ä»–çª—å£çš„æ‰§è¡Œå¼€å§‹æ¶ˆæ¯: ${promptId}`)\n      return\n    }\n\n    console.log(`ğŸš€ [${webSocketManager.windowId}] ä»»åŠ¡å¼€å§‹æ‰§è¡Œ: ${promptId}`)\n\n    // æ›´æ–°ä»»åŠ¡çŠ¶æ€\n    this.updateTaskStatus(promptId, TASK_STATUS.EXECUTING, {\n      executionStartTime: Date.now(),\n      currentNode: null,\n      completedNodes: []\n    })\n\n    // æ›´æ–°è¿›åº¦\n    this.safeProgressCallback(promptId, 'ä»»åŠ¡å¼€å§‹æ‰§è¡Œ...', 15)\n  }\n\n  /**\n   * ğŸ”§ å¤„ç†èŠ‚ç‚¹æ‰§è¡ŒçŠ¶æ€æ¶ˆæ¯\n   */\n  handleExecuting(message) {\n    const data = message.data\n    if (!data || !data.prompt_id) {\n      return\n    }\n\n    const promptId = data.prompt_id\n    const task = this.getTask(promptId)\n    if (!task) {\n      console.log(`ğŸ” [${webSocketManager.windowId}] å¿½ç•¥å…¶ä»–çª—å£çš„æ‰§è¡ŒçŠ¶æ€æ¶ˆæ¯: ${promptId}`)\n      return\n    }\n\n    // å®˜æ–¹æ ‡å‡†åŒé‡æ¡ä»¶æ£€æµ‹ï¼šdata.node === null && data.prompt_id === promptId\n    if (data.node === null && data.prompt_id === promptId) {\n      console.log(`ğŸ¯ [${webSocketManager.windowId}] ä»»åŠ¡æ‰§è¡Œå®Œæˆ: ${promptId}`)\n\n      // æ›´æ–°ä»»åŠ¡çŠ¶æ€\n      this.updateTaskStatus(promptId, TASK_STATUS.COMPLETED, {\n        completionTime: Date.now()\n      })\n\n      // ç«‹å³å¤„ç†ä»»åŠ¡å®Œæˆ\n      this.handleTaskCompletion(promptId)\n\n    } else if (data.node !== null) {\n      // æ­£åœ¨æ‰§è¡ŒæŸä¸ªèŠ‚ç‚¹\n      console.log(`âš™ï¸ [${webSocketManager.windowId}] æ‰§è¡ŒèŠ‚ç‚¹: ${data.node} (ä»»åŠ¡: ${promptId})`)\n\n      // æ›´æ–°å½“å‰æ‰§è¡ŒèŠ‚ç‚¹\n      if (task.status === TASK_STATUS.EXECUTING) {\n        task.currentNode = data.node\n        this.safeProgressCallback(promptId, `æ­£åœ¨æ‰§è¡Œ: ${data.node}`, 40)\n      }\n    }\n  }\n\n  /**\n   * ğŸ”§ å¤„ç†èŠ‚ç‚¹æ‰§è¡Œå®Œæˆæ¶ˆæ¯\n   */\n  handleExecuted(message) {\n    const data = message.data\n    if (!data || !data.prompt_id || !data.node) {\n      return\n    }\n\n    const promptId = data.prompt_id\n    const task = this.getTask(promptId)\n    if (!task || task.status !== TASK_STATUS.EXECUTING) {\n      if (!task) {\n        console.log(`ğŸ” [${webSocketManager.windowId}] å¿½ç•¥å…¶ä»–çª—å£çš„èŠ‚ç‚¹å®Œæˆæ¶ˆæ¯: ${promptId}`)\n      }\n      return\n    }\n\n    console.log(`âœ… [${webSocketManager.windowId}] èŠ‚ç‚¹å®Œæˆ: ${data.node} (ä»»åŠ¡: ${promptId})`)\n\n    // è®°å½•å®Œæˆçš„èŠ‚ç‚¹\n    if (!task.completedNodes) {\n      task.completedNodes = []\n    }\n    task.completedNodes.push(data.node)\n\n    // æ›´æ–°è¿›åº¦\n    this.safeProgressCallback(promptId, `èŠ‚ç‚¹ ${data.node} å®Œæˆ`, 60)\n  }\n\n  /**\n   * ğŸ”§ å¤„ç†èŠ‚ç‚¹æ‰§è¡Œè¿›åº¦æ¶ˆæ¯\n   */\n  handleProgress(message) {\n    const data = message.data\n    if (!data || !data.prompt_id) {\n      return\n    }\n\n    const promptId = data.prompt_id\n    const task = this.getTask(promptId)\n    if (!task || task.status !== TASK_STATUS.EXECUTING) {\n      if (!task) {\n        console.log(`ğŸ” [${webSocketManager.windowId}] å¿½ç•¥å…¶ä»–çª—å£çš„è¿›åº¦æ¶ˆæ¯: ${promptId}`)\n      }\n      return\n    }\n\n    if (data.value !== undefined && data.max !== undefined) {\n      const progress = Math.round((data.value / data.max) * 100)\n      const overallProgress = 40 + (progress * 0.5) // 40-90%åŒºé—´\n\n      console.log(`ğŸ“ˆ [${webSocketManager.windowId}] è¿›åº¦æ›´æ–°: ${promptId} - ${data.value}/${data.max} (${progress}%)`)\n\n      // æ›´æ–°è¿›åº¦\n      this.safeProgressCallback(promptId, `å¤„ç†è¿›åº¦: ${data.value}/${data.max}`, overallProgress)\n    }\n  }\n\n  /**\n   * ğŸ”§ å¤„ç†èŠ‚ç‚¹ç¼“å­˜å‘½ä¸­æ¶ˆæ¯\n   */\n  handleExecutionCached(message) {\n    const data = message.data\n    if (!data || !data.prompt_id || !data.nodes) {\n      return\n    }\n\n    const promptId = data.prompt_id\n    const task = this.getTask(promptId)\n    if (!task) {\n      console.log(`ğŸ” [${webSocketManager.windowId}] å¿½ç•¥å…¶ä»–çª—å£çš„ç¼“å­˜å‘½ä¸­æ¶ˆæ¯: ${promptId}`)\n      return\n    }\n\n    console.log(`âš¡ [${webSocketManager.windowId}] ç¼“å­˜å‘½ä¸­: ${promptId}, èŠ‚ç‚¹: [${data.nodes.join(', ')}]`)\n\n    // æ›´æ–°è¿›åº¦\n    this.safeProgressCallback(promptId, `ç¼“å­˜å‘½ä¸­ ${data.nodes.length} ä¸ªèŠ‚ç‚¹`, 25)\n  }\n"
        }
    ]
}