{
    "sourceFile": "client/src/services/comfyui-refactored.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1752945644077,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1752945644077,
            "name": "Commit-0",
            "content": "// ComfyUIæœåŠ¡ - é‡æž„ç‰ˆæœ¬ï¼ŒåŸºäºŽæœåŠ¡ç«¯WebSocketç®¡ç†\nimport SimpleWebSocketClient from './SimpleWebSocketClient.js'\nimport undressWorkflow from '../workflows/undress.json'\nimport faceSwapWorkflow from '../workflows/faceswap2.0.json'\nimport comfyUIConfig from '../config/comfyui.config.js'\nimport pointsManager from '../utils/pointsManager.js'\nimport levelCardPointsManager from '../utils/levelCardPointsManager.js'\nimport { showNotification } from '../utils/notification.js'\n\n// å…¨å±€WebSocketå®¢æˆ·ç«¯å®žä¾‹\nlet wsClient = null;\n\n// é…ç½®\nconst config = {\n  SERVER_URL: window.location.origin, // ä½¿ç”¨å½“å‰æœåŠ¡å™¨\n  TIMEOUT: 600000 // 10åˆ†é’Ÿè¶…æ—¶\n};\n\n/**\n * åˆå§‹åŒ–WebSocketå®¢æˆ·ç«¯\n */\nasync function initializeWebSocketClient() {\n  if (wsClient && wsClient.isConnected()) {\n    return wsClient;\n  }\n\n  try {\n    wsClient = new SimpleWebSocketClient();\n    await wsClient.connect(config.SERVER_URL);\n\n    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨\n    setupEventListeners();\n\n    console.log('âœ… WebSocketå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');\n    return wsClient;\n  } catch (error) {\n    console.error('âŒ WebSocketå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', error);\n    throw error;\n  }\n}\n\n/**\n * è®¾ç½®äº‹ä»¶ç›‘å¬å™¨\n */\nfunction setupEventListeners() {\n  if (!wsClient) return;\n\n  // è¿žæŽ¥çŠ¶æ€äº‹ä»¶\n  wsClient.on('status_broadcast', (data) => {\n    console.log('ðŸ“Š æœåŠ¡å™¨çŠ¶æ€æ›´æ–°:', data);\n  });\n\n  // ä»»åŠ¡æ‰§è¡Œäº‹ä»¶\n  wsClient.on('executing', (data) => {\n    console.log(`ðŸŽ¯ ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€: ${data.prompt_id}, node: ${data.node}`);\n  });\n\n  // è¿›åº¦äº‹ä»¶\n  wsClient.on('progress', (data) => {\n    console.log(`ðŸ“Š ä»»åŠ¡è¿›åº¦: ${data.prompt_id}, ${data.progress}%`);\n  });\n\n  // äºŒè¿›åˆ¶æ¶ˆæ¯ï¼ˆé¢„è§ˆå›¾åƒï¼‰\n  wsClient.on('binary_message', (data) => {\n    console.log('ðŸ–¼ï¸ æ”¶åˆ°é¢„è§ˆå›¾åƒæ•°æ®');\n  });\n}\n\n/**\n * å¤„ç†æ¢è¡£ä»»åŠ¡ - é‡æž„ç‰ˆæœ¬\n */\nexport async function processUndressImage(imageFile, options = {}) {\n  const {\n    onProgress = () => {},\n    strength = 0.8,\n    steps = 20,\n    cfg = 7\n  } = options;\n\n  try {\n    console.log('ðŸš€ å¼€å§‹æ¢è¡£å¤„ç† (é‡æž„ç‰ˆæœ¬)');\n\n    // åˆå§‹åŒ–WebSocketè¿žæŽ¥\n    onProgress('æ­£åœ¨è¿žæŽ¥æœåŠ¡å™¨...', 5);\n    await initializeWebSocketClient();\n\n    // ä¸Šä¼ å›¾ç‰‡\n    onProgress('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...', 10);\n    const uploadedImage = await uploadImageToServer(imageFile);\n    console.log('ðŸ“¤ å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', uploadedImage);\n\n    // å‡†å¤‡å·¥ä½œæµ\n    onProgress('æ­£åœ¨å‡†å¤‡å·¥ä½œæµ...', 20);\n    const workflow = prepareUndressWorkflow(uploadedImage, { strength, steps, cfg });\n\n    // æäº¤ä»»åŠ¡\n    onProgress('æ­£åœ¨æäº¤ä»»åŠ¡...', 30);\n    const submitResult = await wsClient.submitTask(workflow);\n    const promptId = submitResult.promptId;\n    console.log(`âœ… ä»»åŠ¡æäº¤æˆåŠŸ: ${promptId}`);\n\n    // ç­‰å¾…ä»»åŠ¡å®Œæˆ\n    onProgress('æ­£åœ¨å¤„ç†å›¾ç‰‡...', 40);\n    const results = await wsClient.waitForTaskCompletion(promptId, (status, progress) => {\n      const adjustedProgress = Math.min(90, Math.max(40, 40 + (progress * 0.5)));\n      onProgress(status, adjustedProgress);\n    });\n\n    // èŽ·å–ç»“æžœå›¾ç‰‡URL\n    onProgress('æ­£åœ¨èŽ·å–ç»“æžœ...', 95);\n    const resultImageUrl = extractImageUrl(results);\n\n    if (!resultImageUrl) {\n      throw new Error('æœªèƒ½èŽ·å–å¤„ç†ç»“æžœ');\n    }\n\n    console.log('ðŸŽ‰ æ¢è¡£å¤„ç†å®Œæˆ:', resultImageUrl);\n    onProgress('å¤„ç†å®Œæˆ', 100);\n\n    // æ¶ˆè€—ç§¯åˆ†\n    await consumePoints('undress');\n\n    return resultImageUrl;\n\n  } catch (error) {\n    console.error('âŒ æ¢è¡£å¤„ç†å¤±è´¥:', error);\n    showNotification('æ¢è¡£å¤„ç†å¤±è´¥: ' + error.message, 'error');\n    throw error;\n  }\n}\n\n/**\n * å¤„ç†æ¢è„¸ä»»åŠ¡ - é‡æž„ç‰ˆæœ¬\n */\nexport async function processFaceSwapImage(sourceImageFile, targetImageFile, options = {}) {\n  const {\n    onProgress = () => {},\n    strength = 0.8\n  } = options;\n\n  try {\n    console.log('ðŸš€ å¼€å§‹æ¢è„¸å¤„ç† (é‡æž„ç‰ˆæœ¬)');\n\n    // åˆå§‹åŒ–WebSocketè¿žæŽ¥\n    onProgress('æ­£åœ¨è¿žæŽ¥æœåŠ¡å™¨...', 5);\n    await initializeWebSocketClient();\n\n    // ä¸Šä¼ å›¾ç‰‡\n    onProgress('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...', 10);\n    const [sourceImage, targetImage] = await Promise.all([\n      uploadImageToServer(sourceImageFile),\n      uploadImageToServer(targetImageFile)\n    ]);\n    console.log('ðŸ“¤ å›¾ç‰‡ä¸Šä¼ æˆåŠŸ');\n\n    // å‡†å¤‡å·¥ä½œæµ\n    onProgress('æ­£åœ¨å‡†å¤‡å·¥ä½œæµ...', 20);\n    const workflow = prepareFaceSwapWorkflow(sourceImage, targetImage, { strength });\n\n    // æäº¤ä»»åŠ¡\n    onProgress('æ­£åœ¨æäº¤ä»»åŠ¡...', 30);\n    const submitResult = await wsClient.submitTask(workflow);\n    const promptId = submitResult.promptId;\n    console.log(`âœ… ä»»åŠ¡æäº¤æˆåŠŸ: ${promptId}`);\n\n    // ç­‰å¾…ä»»åŠ¡å®Œæˆ\n    onProgress('æ­£åœ¨å¤„ç†å›¾ç‰‡...', 40);\n    const results = await wsClient.waitForTaskCompletion(promptId, (status, progress) => {\n      const adjustedProgress = Math.min(90, Math.max(40, 40 + (progress * 0.5)));\n      onProgress(status, adjustedProgress);\n    });\n\n    // èŽ·å–ç»“æžœå›¾ç‰‡URL\n    onProgress('æ­£åœ¨èŽ·å–ç»“æžœ...', 95);\n    const resultImageUrl = extractImageUrl(results);\n\n    if (!resultImageUrl) {\n      throw new Error('æœªèƒ½èŽ·å–å¤„ç†ç»“æžœ');\n    }\n\n    console.log('ðŸŽ‰ æ¢è„¸å¤„ç†å®Œæˆ:', resultImageUrl);\n    onProgress('å¤„ç†å®Œæˆ', 100);\n\n    // æ¶ˆè€—ç§¯åˆ†\n    await consumePoints('faceswap');\n\n    return resultImageUrl;\n\n  } catch (error) {\n    console.error('âŒ æ¢è„¸å¤„ç†å¤±è´¥:', error);\n    showNotification('æ¢è„¸å¤„ç†å¤±è´¥: ' + error.message, 'error');\n    throw error;\n  }\n}\n\n/**\n * ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨\n */\nasync function uploadImageToServer(imageFile) {\n  const formData = new FormData();\n  formData.append('image', imageFile);\n  formData.append('type', 'input');\n\n  const response = await fetch('/api/images/upload', {\n    method: 'POST',\n    body: formData\n  });\n\n  if (!response.ok) {\n    throw new Error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${response.statusText}`);\n  }\n\n  const result = await response.json();\n  return result.data;\n}\n\n/**\n * å‡†å¤‡æ¢è¡£å·¥ä½œæµ\n */\nfunction prepareUndressWorkflow(uploadedImage, options) {\n  const workflow = JSON.parse(JSON.stringify(undressWorkflow));\n\n  // è®¾ç½®è¾“å…¥å›¾ç‰‡\n  if (workflow['10'] && workflow['10'].inputs) {\n    workflow['10'].inputs.image = uploadedImage.filename;\n  }\n\n  // è®¾ç½®å‚æ•°\n  if (workflow['3'] && workflow['3'].inputs) {\n    workflow['3'].inputs.denoise = options.strength;\n    workflow['3'].inputs.steps = options.steps;\n    workflow['3'].inputs.cfg = options.cfg;\n  }\n\n  return workflow;\n}\n\n/**\n * å‡†å¤‡æ¢è„¸å·¥ä½œæµ\n */\nfunction prepareFaceSwapWorkflow(sourceImage, targetImage, options) {\n  const workflow = JSON.parse(JSON.stringify(faceSwapWorkflow));\n\n  // è®¾ç½®è¾“å…¥å›¾ç‰‡\n  if (workflow['source_image'] && workflow['source_image'].inputs) {\n    workflow['source_image'].inputs.image = sourceImage.filename;\n  }\n\n  if (workflow['target_image'] && workflow['target_image'].inputs) {\n    workflow['target_image'].inputs.image = targetImage.filename;\n  }\n\n  // è®¾ç½®å‚æ•°\n  if (workflow['faceswap'] && workflow['faceswap'].inputs) {\n    workflow['faceswap'].inputs.strength = options.strength;\n  }\n\n  return workflow;\n}\n\n/**\n * ä»Žç»“æžœä¸­æå–å›¾ç‰‡URL\n */\nfunction extractImageUrl(results) {\n  // æŸ¥æ‰¾è¾“å‡ºèŠ‚ç‚¹çš„å›¾ç‰‡\n  for (const nodeId in results) {\n    const nodeOutput = results[nodeId];\n    if (nodeOutput && nodeOutput.length > 0 && nodeOutput[0].url) {\n      return nodeOutput[0].url;\n    }\n  }\n  return null;\n}\n\n/**\n * æ¶ˆè€—ç§¯åˆ†\n */\nasync function consumePoints(type) {\n  try {\n    const pointsToConsume = type === 'undress' ? 10 : 15;\n\n    // ä¼˜å…ˆä»Žç­‰çº§å¡æ‰£é™¤\n    const levelCardResult = await levelCardPointsManager.consumePoints(pointsToConsume);\n    if (levelCardResult.success) {\n      console.log(`âœ… ä»Žç­‰çº§å¡æ¶ˆè€— ${pointsToConsume} ç§¯åˆ†`);\n      return;\n    }\n\n    // ä»Žæ™®é€šç§¯åˆ†æ‰£é™¤\n    const pointsResult = await pointsManager.consumePoints(pointsToConsume);\n    if (pointsResult.success) {\n      console.log(`âœ… ä»Žæ™®é€šç§¯åˆ†æ¶ˆè€— ${pointsToConsume} ç§¯åˆ†`);\n      return;\n    }\n\n    throw new Error('ç§¯åˆ†ä¸è¶³');\n  } catch (error) {\n    console.error('âŒ æ¶ˆè€—ç§¯åˆ†å¤±è´¥:', error);\n    throw error;\n  }\n}\n\n/**\n * èŽ·å–WebSocketå®¢æˆ·ç«¯çŠ¶æ€\n */\nexport function getWebSocketStatus() {\n  return {\n    connected: wsClient ? wsClient.isConnected() : false,\n    clientId: wsClient ? wsClient.clientId : null\n  };\n}\n\n/**\n * å…³é—­WebSocketè¿žæŽ¥\n */\nexport function closeWebSocketConnection() {\n  if (wsClient) {\n    wsClient.close();\n    wsClient = null;\n  }\n}\n\n// é¡µé¢å¸è½½æ—¶å…³é—­è¿žæŽ¥\nwindow.addEventListener('beforeunload', () => {\n  closeWebSocketConnection();\n});\n\n// å¯¼å‡ºæ‰€æœ‰å…¬å…±å‡½æ•°\nexport {\n  initializeWebSocketClient,\n  processUndressImage,\n  processFaceSwapImage,\n  getWebSocketStatus,\n  closeWebSocketConnection\n};\n"
        }
    ]
}