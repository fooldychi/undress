{
    "sourceFile": "client/src/services/websocketManager.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 42,
            "patches": [
                {
                    "date": 1753463557474,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1753463586423,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -506,4 +506,131 @@\n       this.reconnectTimer = null\n       console.log(`ðŸ§¹ [${this.windowId}] æ¸…é™¤é‡è¿žå®šæ—¶å™¨`)\n     }\n   }\n+\n+  /**\n+   * ðŸ”§ æ–­å¼€è¿žæŽ¥\n+   */\n+  disconnect() {\n+    this.stopHealthCheck()\n+    this.clearReconnectTimer()\n+\n+    if (this.connection) {\n+      this.connection.close(1000, 'ä¸»åŠ¨æ–­å¼€è¿žæŽ¥')\n+      this.connection = null\n+    }\n+\n+    this.state = WS_STATE.DISCONNECTED\n+    this.currentServer = null\n+    this.emit('disconnected', { windowId: this.windowId })\n+    console.log(`ðŸ”Œ [${this.windowId}] WebSocketå·²æ–­å¼€è¿žæŽ¥`)\n+  }\n+\n+  /**\n+   * ðŸ”§ å¼ºåˆ¶é‡è¿žåˆ°æŒ‡å®šæœåŠ¡å™¨\n+   */\n+  async forceReconnect(serverUrl = null) {\n+    console.log(`ðŸ”„ [${this.windowId}] å¼ºåˆ¶é‡è¿žåˆ°æœåŠ¡å™¨: ${serverUrl || 'è‡ªåŠ¨é€‰æ‹©'}`)\n+\n+    // æ–­å¼€çŽ°æœ‰è¿žæŽ¥\n+    this.disconnect()\n+\n+    // é‡ç½®é‡è¿žè®¡æ•°\n+    this.reconnectAttempts = 0\n+\n+    // è¿žæŽ¥åˆ°æŒ‡å®šæœåŠ¡å™¨\n+    return await this.connect(serverUrl)\n+  }\n+\n+  /**\n+   * ðŸ”§ ç¡®ä¿WebSocketè¿žæŽ¥\n+   */\n+  async ensureConnection(serverUrl = null) {\n+    // å¦‚æžœæŒ‡å®šäº†æœåŠ¡å™¨ä¸”ä¸Žå½“å‰ä¸åŒï¼Œéœ€è¦é‡æ–°è¿žæŽ¥\n+    if (serverUrl && this.lockedServer && serverUrl !== this.lockedServer) {\n+      console.log(`ðŸ”„ [${this.windowId}] æœåŠ¡å™¨ä¸ä¸€è‡´ï¼Œé‡æ–°è¿žæŽ¥`)\n+      console.log(`   å½“å‰é”å®š: ${this.lockedServer}`)\n+      console.log(`   ç›®æ ‡æœåŠ¡å™¨: ${serverUrl}`)\n+      return await this.forceReconnect(serverUrl)\n+    }\n+\n+    // å¦‚æžœå·²è¿žæŽ¥ä¸”æœåŠ¡å™¨ä¸€è‡´ï¼Œç›´æŽ¥è¿”å›ž\n+    if (this.state === WS_STATE.CONNECTED && this.connection?.readyState === WebSocket.OPEN) {\n+      console.log(`âœ… [${this.windowId}] WebSocketå·²è¿žæŽ¥`)\n+      this.processMessageQueue() // å¤„ç†å¾…å‘é€æ¶ˆæ¯\n+      return true\n+    }\n+\n+    // éœ€è¦å»ºç«‹æ–°è¿žæŽ¥\n+    console.log(`ðŸ”„ [${this.windowId}] å»ºç«‹æ–°çš„WebSocketè¿žæŽ¥`)\n+    return await this.connect(serverUrl)\n+  }\n+\n+  /**\n+   * ðŸ”§ èŽ·å–è¿žæŽ¥çŠ¶æ€\n+   */\n+  getStatus() {\n+    return {\n+      windowId: this.windowId,\n+      clientId: this.clientId,\n+      state: this.state,\n+      isConnected: this.state === WS_STATE.CONNECTED,\n+      currentServer: this.currentServer,\n+      lockedServer: this.lockedServer,\n+      lockTimestamp: this.lockTimestamp,\n+      lockDuration: this.lockTimestamp ? Date.now() - this.lockTimestamp : null,\n+      reconnectAttempts: this.reconnectAttempts,\n+      connectionState: this.connection?.readyState || 'CLOSED',\n+      messageQueueLength: this.messageQueue.length,\n+      lastMessageTime: this.lastMessageTime\n+    }\n+  }\n+\n+  /**\n+   * ðŸ”§ è°ƒè¯•ä¿¡æ¯\n+   */\n+  debug() {\n+    const status = this.getStatus()\n+    console.log(`ðŸ” [${this.windowId}] ===== WebSocketç®¡ç†å™¨çŠ¶æ€ =====`)\n+    console.log(`ðŸªŸ çª—å£ID: ${status.windowId}`)\n+    console.log(`ðŸ”‘ å®¢æˆ·ç«¯ID: ${status.clientId}`)\n+    console.log(`ðŸ”— è¿žæŽ¥çŠ¶æ€: ${status.state}`)\n+    console.log(`ðŸ“¡ å½“å‰æœåŠ¡å™¨: ${status.currentServer || 'æ— '}`)\n+    console.log(`ðŸ”’ é”å®šæœåŠ¡å™¨: ${status.lockedServer || 'æ— '}`)\n+    console.log(`ðŸ• é”å®šæ—¶é—´: ${status.lockTimestamp ? new Date(status.lockTimestamp).toLocaleString() : 'æ— '}`)\n+    console.log(`â±ï¸ é”å®šæŒç»­: ${status.lockDuration ? Math.round(status.lockDuration / 1000) + 'ç§’' : 'æ— '}`)\n+    console.log(`ðŸ”„ é‡è¿žæ¬¡æ•°: ${status.reconnectAttempts}`)\n+    console.log(`ðŸ“¤ æ¶ˆæ¯é˜Ÿåˆ—: ${status.messageQueueLength} æ¡`)\n+    console.log(`ðŸ“¨ æœ€åŽæ¶ˆæ¯: ${status.lastMessageTime ? new Date(status.lastMessageTime).toLocaleString() : 'æ— '}`)\n+    console.log(`ðŸ” [${this.windowId}] ===== çŠ¶æ€ä¿¡æ¯ç»“æŸ =====`)\n+\n+    return status\n+  }\n+\n+  /**\n+   * ðŸ”§ é‡ç½®ç®¡ç†å™¨çŠ¶æ€\n+   */\n+  reset() {\n+    console.log(`ðŸ”„ [${this.windowId}] é‡ç½®WebSocketç®¡ç†å™¨`)\n+\n+    this.disconnect()\n+    this.unlockServer()\n+    this.messageQueue = []\n+    this.reconnectAttempts = 0\n+    this.lastMessageTime = null\n+\n+    console.log(`âœ… [${this.windowId}] WebSocketç®¡ç†å™¨å·²é‡ç½®`)\n+  }\n+}\n+\n+// åˆ›å»ºå…¨å±€å®žä¾‹\n+const webSocketManager = new WebSocketManager()\n+\n+// æš´éœ²è°ƒè¯•å‡½æ•°åˆ°å…¨å±€\n+if (typeof window !== 'undefined') {\n+  window.webSocketManager = webSocketManager\n+  window.debugWebSocket = () => webSocketManager.debug()\n+  window.resetWebSocket = () => webSocketManager.reset()\n+}\n+\n+export default webSocketManager\n"
                },
                {
                    "date": 1753504726338,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,636 +1,313 @@\n-/**\n- * ðŸ”¥ WebSocketè¿žæŽ¥ç®¡ç†å™¨ - ç‹¬ç«‹çš„WebSocketæœåŠ¡\n- *\n- * æ ¸å¿ƒåŠŸèƒ½ï¼š\n- * 1. WebSocketè¿žæŽ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†\n- * 2. å¤šçª—å£éš”ç¦»æœºåˆ¶\n- * 3. æœåŠ¡å™¨é”å®šä¸Žä¸€è‡´æ€§ä¿è¯\n- * 4. æ¶ˆæ¯è·¯ç”±ä¸Žäº‹ä»¶åˆ†å‘\n- * 5. è‡ªåŠ¨é‡è¿žä¸Žå¥åº·æ£€æŸ¥\n- *\n- * æž¶æž„ä¼˜åŠ¿ï¼š\n- * - è§£è€¦WebSocketç®¡ç†ä¸Žä¸šåŠ¡é€»è¾‘\n- * - æ”¯æŒå¤šç§æœåŠ¡å¤ç”¨åŒä¸€WebSocketè¿žæŽ¥\n- * - æä¾›ç»Ÿä¸€çš„è¿žæŽ¥ç®¡ç†ç­–ç•¥\n- * - ä¾¿äºŽæµ‹è¯•å’Œç»´æŠ¤\n- */\n+// ðŸ”§ WebSocketç®¡ç†å™¨ - ç‹¬ç«‹çš„è¿žæŽ¥æ± å’Œæ¶ˆæ¯åˆ†å‘ç³»ç»Ÿ\n+// æ”¯æŒå¤šçª—å£éš”ç¦»ã€æ¶ˆæ¯å¤„ç†å™¨æ³¨å†Œã€æœåŠ¡å™¨é”å®šç­‰åŠŸèƒ½\n \n-import loadBalancer from './loadBalancer.js'\n-\n-// WebSocketè¿žæŽ¥çŠ¶æ€æžšä¸¾\n-export const WS_STATE = {\n-  DISCONNECTED: 'disconnected',\n-  CONNECTING: 'connecting',\n-  CONNECTED: 'connected',\n-  RECONNECTING: 'reconnecting',\n-  FAILED: 'failed'\n-}\n-\n-// ðŸ”§ ç”Ÿæˆçª—å£å”¯ä¸€æ ‡è¯†ç¬¦\n-function generateWindowId() {\n-  return `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\n-}\n-\n-// ðŸ”§ ç”Ÿæˆå¢žå¼ºçš„å®¢æˆ·ç«¯ID\n-function generateUniqueClientId() {\n-  const baseId = 'abc1373d4ad648a3a81d0587fbe5534b'\n+// ðŸ”§ ç”Ÿæˆå”¯ä¸€å®¢æˆ·ç«¯IDçš„å‡½æ•°ï¼ˆé¿å…å¾ªçŽ¯ä¾èµ–ï¼‰\n+function generateClientId() {\n   const timestamp = Date.now()\n-  const random = Math.random().toString(36).substr(2, 9)\n-  const windowId = generateWindowId()\n-  return `${baseId}_${timestamp}_${random}_${windowId}`\n+  const random = Math.random().toString(36).substring(2, 8)\n+  const windowId = typeof window !== 'undefined' ?\n+    (window.WINDOW_ID || 'unknown') : 'server'\n+  return `${windowId}_${timestamp}_${random}`\n }\n \n+// ðŸ”§ WebSocketè¿žæŽ¥ç®¡ç†å™¨ç±»\n class WebSocketManager {\n   constructor() {\n-    // çª—å£æ ‡è¯†\n-    this.windowId = generateWindowId()\n-    this.clientId = generateUniqueClientId()\n+    // è¿žæŽ¥æ± ï¼šwindowId -> { connection, server, clientId, isConnected }\n+    this.connections = new Map()\n \n-    // è¿žæŽ¥ç®¡ç†\n-    this.connection = null\n-    this.state = WS_STATE.DISCONNECTED\n-    this.currentServer = null\n+    // æ¶ˆæ¯å¤„ç†å™¨æ³¨å†Œè¡¨ï¼šmessageType -> handler[]\n+    this.messageHandlers = new Map()\n \n-    // æœåŠ¡å™¨é”å®šæœºåˆ¶ï¼ˆçª—å£çº§åˆ«ï¼‰\n-    this.lockedServer = null\n-    this.lockTimestamp = null\n+    // çª—å£çº§åˆ«çš„æœåŠ¡å™¨é”å®šï¼šwindowId -> { server, timestamp, tasks }\n+    this.serverLocks = new Map()\n \n-    // äº‹ä»¶ç®¡ç†\n-    this.eventHandlers = new Map()\n-    this.messageQueue = []\n+    // è§£é”æ£€æŸ¥å®šæ—¶å™¨ï¼šwindowId -> timerId\n+    this.unlockTimers = new Map()\n \n-    // é‡è¿žç®¡ç†\n-    this.reconnectAttempts = 0\n-    this.maxReconnectAttempts = 5\n-    this.reconnectDelay = 2000\n-    this.reconnectTimer = null\n+    console.log('ðŸ”§ WebSocketç®¡ç†å™¨å·²åˆå§‹åŒ–')\n+  }\n \n-    // å¥åº·æ£€æŸ¥\n-    this.healthCheckInterval = null\n-    this.lastHeartbeat = null\n-    this.lastMessageTime = null\n+  // ðŸ”§ æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨\n+  registerHandler(messageType, handler, windowId = null) {\n+    if (!this.messageHandlers.has(messageType)) {\n+      this.messageHandlers.set(messageType, [])\n+    }\n \n-    console.log(`ðŸ”Œ WebSocketManager åˆå§‹åŒ–å®Œæˆ`)\n-    console.log(`ðŸªŸ çª—å£ID: ${this.windowId}`)\n-    console.log(`ðŸ”‘ å®¢æˆ·ç«¯ID: ${this.clientId}`)\n+    const handlerInfo = { handler, windowId }\n+    this.messageHandlers.get(messageType).push(handlerInfo)\n \n-    // è®¾ç½®çª—å£å…³é—­æ¸…ç†\n-    this.setupWindowCleanup()\n+    console.log(`ðŸ“ æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨: ${messageType} (çª—å£: ${windowId || 'global'})`)\n   }\n \n-  /**\n-   * ðŸ”§ è®¾ç½®çª—å£å…³é—­æ—¶çš„æ¸…ç†æœºåˆ¶\n-   */\n-  setupWindowCleanup() {\n-    window.addEventListener('beforeunload', () => {\n-      console.log(`ðŸšª [${this.windowId}] çª—å£å³å°†å…³é—­ï¼Œæ‰§è¡ŒWebSocketæ¸…ç†...`)\n-      this.disconnect()\n-      this.unlockServer()\n-    })\n-\n-    // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†\n-    document.addEventListener('visibilitychange', () => {\n-      if (document.hidden) {\n-        console.log(`ðŸ‘ï¸ [${this.windowId}] çª—å£éšè—`)\n-      } else {\n-        console.log(`ðŸ‘ï¸ [${this.windowId}] çª—å£é‡æ–°å¯è§`)\n-        this.checkConnectionHealth()\n+  // ðŸ”§ ç§»é™¤æ¶ˆæ¯å¤„ç†å™¨\n+  unregisterHandler(messageType, handler) {\n+    const handlers = this.messageHandlers.get(messageType)\n+    if (handlers) {\n+      const index = handlers.findIndex(h => h.handler === handler)\n+      if (index !== -1) {\n+        handlers.splice(index, 1)\n+        console.log(`ðŸ—‘ï¸ ç§»é™¤æ¶ˆæ¯å¤„ç†å™¨: ${messageType}`)\n       }\n-    })\n+    }\n   }\n \n-  /**\n-   * ðŸ”§ è¿žæŽ¥åˆ°æŒ‡å®šæœåŠ¡å™¨\n-   */\n-  async connect(serverUrl = null) {\n-    if (this.state === WS_STATE.CONNECTING) {\n-      console.log(`ðŸ”„ [${this.windowId}] WebSocketæ­£åœ¨è¿žæŽ¥ä¸­ï¼Œè·³è¿‡é‡å¤è¿žæŽ¥`)\n-      return false\n-    }\n-\n+  // ðŸ”§ è¿žæŽ¥åˆ°æŒ‡å®šæœåŠ¡å™¨\n+  async connect(windowId, server, clientId = null) {\n     try {\n-      this.state = WS_STATE.CONNECTING\n+      // ç”Ÿæˆæˆ–ä½¿ç”¨æä¾›çš„clientId\n+      const finalClientId = clientId || generateClientId()\n \n-      // ç¡®å®šç›®æ ‡æœåŠ¡å™¨\n-      const targetServer = serverUrl || await this.getTargetServer()\n-      if (!targetServer) {\n-        throw new Error('æ— æ³•èŽ·å–å¯ç”¨çš„æœåŠ¡å™¨')\n+      // æž„å»ºWebSocket URL\n+      let wsUrl\n+      if (server.startsWith('https://')) {\n+        wsUrl = server.replace('https://', 'wss://') + '/ws?clientId=' + finalClientId\n+      } else {\n+        wsUrl = server.replace('http://', 'ws://') + '/ws?clientId=' + finalClientId\n       }\n \n-      // é”å®šæœåŠ¡å™¨\n-      this.lockServer(targetServer)\n+      console.log(`ðŸ”Œ [${windowId}] è¿žæŽ¥WebSocket: ${wsUrl}`)\n \n-      // å»ºç«‹WebSocketè¿žæŽ¥\n-      await this.establishConnection(targetServer)\n+      // å…³é—­çŽ°æœ‰è¿žæŽ¥\n+      await this.disconnect(windowId)\n \n-      this.state = WS_STATE.CONNECTED\n-      this.reconnectAttempts = 0\n-      this.startHealthCheck()\n+      // åˆ›å»ºæ–°è¿žæŽ¥\n+      const ws = new WebSocket(wsUrl)\n \n-      console.log(`âœ… [${this.windowId}] WebSocketè¿žæŽ¥æˆåŠŸ: ${targetServer}`)\n-      this.emit('connected', { server: targetServer, windowId: this.windowId })\n+      // è®¾ç½®è¿žæŽ¥ä¿¡æ¯\n+      const connectionInfo = {\n+        connection: ws,\n+        server: server,\n+        clientId: finalClientId,\n+        isConnected: false,\n+        windowId: windowId,\n+        connectedAt: Date.now()\n+      }\n \n-      return true\n+      this.connections.set(windowId, connectionInfo)\n \n-    } catch (error) {\n-      this.state = WS_STATE.FAILED\n-      console.error(`âŒ [${this.windowId}] WebSocketè¿žæŽ¥å¤±è´¥:`, error)\n-      this.emit('error', { error, windowId: this.windowId })\n+      return new Promise((resolve, reject) => {\n+        const timeout = setTimeout(() => {\n+          reject(new Error('WebSocketè¿žæŽ¥è¶…æ—¶'))\n+        }, 10000)\n \n-      // å¯åŠ¨é‡è¿ž\n-      this.scheduleReconnect()\n-      return false\n-    }\n-  }\n+        ws.onopen = () => {\n+          connectionInfo.isConnected = true\n+          clearTimeout(timeout)\n+          console.log(`âœ… [${windowId}] WebSocketè¿žæŽ¥æˆåŠŸ`)\n+          resolve(connectionInfo)\n+        }\n \n-  /**\n-   * ðŸ”§ å»ºç«‹WebSocketè¿žæŽ¥\n-   */\n-  async establishConnection(serverUrl) {\n-    return new Promise((resolve, reject) => {\n-      const wsUrl = this.buildWebSocketUrl(serverUrl)\n-      console.log(`ðŸ”— [${this.windowId}] å»ºç«‹WebSocketè¿žæŽ¥: ${wsUrl}`)\n+        ws.onmessage = (event) => {\n+          this.handleMessage(windowId, event.data)\n+        }\n \n-      // å…ˆè¿›è¡ŒHTTPè¿žæŽ¥æµ‹è¯•\n-      this.testHttpConnection(serverUrl)\n-        .then(() => {\n-          this.connection = new WebSocket(wsUrl)\n-          this.currentServer = serverUrl\n+        ws.onclose = (event) => {\n+          connectionInfo.isConnected = false\n+          console.log(`ðŸ”Œ [${windowId}] WebSocketè¿žæŽ¥å…³é—­:`, event.code, event.reason)\n+        }\n \n-          const timeout = setTimeout(() => {\n-            reject(new Error('WebSocketè¿žæŽ¥è¶…æ—¶'))\n-          }, 10000)\n+        ws.onerror = (error) => {\n+          connectionInfo.isConnected = false\n+          clearTimeout(timeout)\n+          console.error(`âŒ [${windowId}] WebSocketè¿žæŽ¥é”™è¯¯:`, error)\n+          reject(error)\n+        }\n+      })\n \n-          this.connection.onopen = () => {\n-            clearTimeout(timeout)\n-            console.log(`ðŸŽ‰ [${this.windowId}] WebSocketè¿žæŽ¥å·²å»ºç«‹`)\n-            resolve()\n-          }\n-\n-          this.connection.onclose = (event) => {\n-            clearTimeout(timeout)\n-            this.handleConnectionClose(event)\n-          }\n-\n-          this.connection.onerror = (error) => {\n-            clearTimeout(timeout)\n-            console.error(`âŒ [${this.windowId}] WebSocketè¿žæŽ¥é”™è¯¯:`, error)\n-            reject(error)\n-          }\n-\n-          this.connection.onmessage = (event) => {\n-            this.handleMessage(event)\n-          }\n-        })\n-        .catch(reject)\n-    })\n+    } catch (error) {\n+      console.error(`âŒ [${windowId}] WebSocketè¿žæŽ¥å¤±è´¥:`, error)\n+      throw error\n+    }\n   }\n \n-  /**\n-   * ðŸ”§ HTTPè¿žæŽ¥æµ‹è¯•\n-   */\n-  async testHttpConnection(serverUrl) {\n-    try {\n-      const response = await fetch(`${serverUrl}/api/queue`, {\n-        method: 'GET',\n-        signal: AbortSignal.timeout(5000)\n-      })\n-      if (!response.ok) {\n-        throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status}`)\n+  // ðŸ”§ æ–­å¼€è¿žæŽ¥\n+  async disconnect(windowId) {\n+    const connectionInfo = this.connections.get(windowId)\n+    if (connectionInfo && connectionInfo.connection) {\n+      try {\n+        connectionInfo.connection.close()\n+        console.log(`ðŸ”Œ [${windowId}] WebSocketè¿žæŽ¥å·²æ–­å¼€`)\n+      } catch (error) {\n+        console.warn(`âš ï¸ [${windowId}] æ–­å¼€WebSocketè¿žæŽ¥æ—¶å‡ºé”™:`, error)\n       }\n-      console.log(`âœ… [${this.windowId}] HTTPè¿žæŽ¥æµ‹è¯•é€šè¿‡: ${serverUrl}`)\n-    } catch (error) {\n-      throw new Error(`ComfyUIæœåŠ¡å™¨ä¸å¯è¾¾: ${error.message}`)\n     }\n+    this.connections.delete(windowId)\n   }\n \n-  /**\n-   * ðŸ”§ æž„å»ºWebSocket URL\n-   */\n-  buildWebSocketUrl(serverUrl) {\n-    let wsUrl\n-    if (serverUrl.startsWith('https://')) {\n-      wsUrl = serverUrl.replace('https://', 'wss://')\n-    } else {\n-      wsUrl = serverUrl.replace('http://', 'ws://')\n-    }\n-    return `${wsUrl}/ws?clientId=${this.clientId}`\n+  // ðŸ”§ èŽ·å–è¿žæŽ¥ä¿¡æ¯\n+  getConnection(windowId) {\n+    return this.connections.get(windowId)?.connection || null\n   }\n \n-  /**\n-   * ðŸ”§ æ¶ˆæ¯å¤„ç†\n-   */\n-  handleMessage(event) {\n-    try {\n-      this.lastMessageTime = Date.now()\n-      const message = event.data\n-\n-      // å¤„ç†äºŒè¿›åˆ¶æ¶ˆæ¯\n-      if (message instanceof ArrayBuffer || message instanceof Blob) {\n-        this.emit('binary', { data: message, windowId: this.windowId })\n-        return\n-      }\n-\n-      // å¤„ç†æ–‡æœ¬æ¶ˆæ¯\n-      if (typeof message === 'string') {\n-        const parsedMessage = JSON.parse(message)\n-\n-        // æ·»åŠ çª—å£æ ‡è¯†\n-        const enrichedMessage = {\n-          ...parsedMessage,\n-          windowId: this.windowId,\n-          timestamp: Date.now()\n-        }\n-\n-        this.emit('message', enrichedMessage)\n-\n-        // æ ¹æ®æ¶ˆæ¯ç±»åž‹åˆ†å‘\n-        if (parsedMessage.type) {\n-          this.emit(`message:${parsedMessage.type}`, enrichedMessage)\n-        }\n-      }\n-\n-    } catch (error) {\n-      console.error(`âŒ [${this.windowId}] WebSocketæ¶ˆæ¯å¤„ç†å¤±è´¥:`, error)\n-      this.emit('error', { error, windowId: this.windowId })\n-    }\n+  // ðŸ”§ æ£€æŸ¥è¿žæŽ¥çŠ¶æ€\n+  isConnected(windowId) {\n+    const connectionInfo = this.connections.get(windowId)\n+    return connectionInfo?.isConnected &&\n+           connectionInfo.connection?.readyState === WebSocket.OPEN\n   }\n \n-  /**\n-   * ðŸ”§ è¿žæŽ¥å…³é—­å¤„ç†\n-   */\n-  handleConnectionClose(event) {\n-    console.log(`ðŸ”Œ [${this.windowId}] WebSocketè¿žæŽ¥å…³é—­: ä»£ç =${event.code}`)\n-    this.state = WS_STATE.DISCONNECTED\n-    this.stopHealthCheck()\n-\n-    this.emit('disconnected', {\n-      code: event.code,\n-      reason: event.reason,\n-      windowId: this.windowId\n-    })\n-\n-    // æ ¹æ®å…³é—­åŽŸå› å†³å®šæ˜¯å¦é‡è¿ž\n-    if (event.code !== 1000) { // éžæ­£å¸¸å…³é—­\n-      this.scheduleReconnect()\n-    }\n+  // ðŸ”§ èŽ·å–è¿žæŽ¥çš„æœåŠ¡å™¨\n+  getConnectedServer(windowId) {\n+    return this.connections.get(windowId)?.server || null\n   }\n \n-  /**\n-   * ðŸ”§ å‘é€æ¶ˆæ¯\n-   */\n-  send(data) {\n-    if (this.state !== WS_STATE.CONNECTED || !this.connection) {\n-      console.warn(`âš ï¸ [${this.windowId}] WebSocketæœªè¿žæŽ¥ï¼Œæ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—`)\n-      this.messageQueue.push(data)\n-      return false\n-    }\n-\n+  // ðŸ”§ æ¶ˆæ¯åˆ†å‘å¤„ç†\n+  handleMessage(windowId, data) {\n     try {\n-      const message = typeof data === 'string' ? data : JSON.stringify(data)\n-      this.connection.send(message)\n-      return true\n-    } catch (error) {\n-      console.error(`âŒ [${this.windowId}] WebSocketå‘é€æ¶ˆæ¯å¤±è´¥:`, error)\n-      return false\n-    }\n-  }\n+      const message = JSON.parse(data)\n+      const { type } = message\n \n-  /**\n-   * ðŸ”§ å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—\n-   */\n-  processMessageQueue() {\n-    if (this.messageQueue.length > 0 && this.state === WS_STATE.CONNECTED) {\n-      console.log(`ðŸ“¤ [${this.windowId}] å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—: ${this.messageQueue.length} æ¡æ¶ˆæ¯`)\n-\n-      while (this.messageQueue.length > 0) {\n-        const message = this.messageQueue.shift()\n-        if (!this.send(message)) {\n-          // å‘é€å¤±è´¥ï¼Œé‡æ–°åŠ å…¥é˜Ÿåˆ—\n-          this.messageQueue.unshift(message)\n-          break\n-        }\n+      // é™é»˜å¤„ç†crystools.monitoræ¶ˆæ¯\n+      if (type === 'crystools.monitor') {\n+        return\n       }\n-    }\n-  }\n \n-  /**\n-   * ðŸ”§ äº‹ä»¶ç›‘å¬\n-   */\n-  on(event, handler) {\n-    if (!this.eventHandlers.has(event)) {\n-      this.eventHandlers.set(event, new Set())\n-    }\n-    this.eventHandlers.get(event).add(handler)\n-    console.log(`ðŸ“¡ [${this.windowId}] æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨: ${event}`)\n-  }\n+      console.log(`ðŸ“¨ [${windowId}] æ”¶åˆ°æ¶ˆæ¯: ${type}`)\n \n-  /**\n-   * ðŸ”§ ç§»é™¤äº‹ä»¶ç›‘å¬\n-   */\n-  off(event, handler) {\n-    if (this.eventHandlers.has(event)) {\n-      this.eventHandlers.get(event).delete(handler)\n-      console.log(`ðŸ“¡ [${this.windowId}] ç§»é™¤äº‹ä»¶ç›‘å¬å™¨: ${event}`)\n-    }\n-  }\n+      // åˆ†å‘åˆ°æ³¨å†Œçš„å¤„ç†å™¨\n+      const handlers = this.messageHandlers.get(type) || []\n \n-  /**\n-   * ðŸ”§ è§¦å‘äº‹ä»¶\n-   */\n-  emit(event, data) {\n-    if (this.eventHandlers.has(event)) {\n-      this.eventHandlers.get(event).forEach(handler => {\n+      handlers.forEach(({ handler, windowId: handlerWindowId }) => {\n+        // å¦‚æžœå¤„ç†å™¨æŒ‡å®šäº†çª—å£IDï¼Œåªå¤„ç†å¯¹åº”çª—å£çš„æ¶ˆæ¯\n+        if (handlerWindowId && handlerWindowId !== windowId) {\n+          return\n+        }\n+\n         try {\n-          handler(data)\n+          handler(windowId, message)\n         } catch (error) {\n-          console.error(`âŒ [${this.windowId}] äº‹ä»¶å¤„ç†å™¨é”™è¯¯ [${event}]:`, error)\n+          console.error(`âŒ [${windowId}] æ¶ˆæ¯å¤„ç†å™¨æ‰§è¡Œå¤±è´¥:`, error)\n         }\n       })\n+\n+    } catch (error) {\n+      console.error(`âŒ [${windowId}] æ¶ˆæ¯è§£æžå¤±è´¥:`, error)\n     }\n   }\n \n-  /**\n-   * ðŸ”§ æœåŠ¡å™¨é”å®š\n-   */\n-  lockServer(serverUrl) {\n-    this.lockedServer = serverUrl\n-    this.lockTimestamp = Date.now()\n-    console.log(`ðŸ”’ [${this.windowId}] é”å®šæœåŠ¡å™¨: ${serverUrl}`)\n-    console.log(`ðŸ• [${this.windowId}] é”å®šæ—¶é—´: ${new Date(this.lockTimestamp).toLocaleTimeString()}`)\n+  // ðŸ”§ æœåŠ¡å™¨é”å®šç®¡ç†\n+  lockServer(windowId, server, taskCount = 0) {\n+    const timestamp = Date.now()\n+    this.serverLocks.set(windowId, {\n+      server,\n+      timestamp,\n+      windowId,\n+      taskCount\n+    })\n \n-    this.emit('server:locked', {\n-      server: serverUrl,\n-      timestamp: this.lockTimestamp,\n-      windowId: this.windowId\n-    })\n+    console.log(`ðŸ”’ [${windowId}] é”å®šæœåŠ¡å™¨: ${server}`)\n+    this.scheduleUnlockCheck(windowId)\n   }\n \n-  /**\n-   * ðŸ”§ è§£é”æœåŠ¡å™¨\n-   */\n-  unlockServer() {\n-    if (this.lockedServer) {\n-      console.log(`ðŸ”“ [${this.windowId}] è§£é”æœåŠ¡å™¨: ${this.lockedServer}`)\n-      const unlockedServer = this.lockedServer\n-      this.lockedServer = null\n-      this.lockTimestamp = null\n-\n-      this.emit('server:unlocked', {\n-        server: unlockedServer,\n-        windowId: this.windowId\n-      })\n+  // ðŸ”§ è§£é”æœåŠ¡å™¨\n+  unlockServer(windowId) {\n+    const lock = this.serverLocks.get(windowId)\n+    if (lock) {\n+      this.serverLocks.delete(windowId)\n+      console.log(`ðŸ”“ [${windowId}] è§£é”æœåŠ¡å™¨: ${lock.server}`)\n     }\n+    this.clearUnlockTimer(windowId)\n   }\n \n-  /**\n-   * ðŸ”§ èŽ·å–ç›®æ ‡æœåŠ¡å™¨\n-   */\n-  async getTargetServer() {\n-    // å¦‚æžœæœ‰é”å®šçš„æœåŠ¡å™¨ï¼Œä¼˜å…ˆä½¿ç”¨\n-    if (this.lockedServer) {\n-      console.log(`ðŸ”’ [${this.windowId}] ä½¿ç”¨é”å®šçš„æœåŠ¡å™¨: ${this.lockedServer}`)\n-      return this.lockedServer\n-    }\n-\n-    // ä»Žè´Ÿè½½å‡è¡¡å™¨èŽ·å–æœ€ä¼˜æœåŠ¡å™¨\n-    try {\n-      const optimalServer = await loadBalancer.getOptimalServer()\n-      console.log(`ðŸŽ¯ [${this.windowId}] è´Ÿè½½å‡è¡¡é€‰æ‹©æœåŠ¡å™¨: ${optimalServer}`)\n-      return optimalServer\n-    } catch (error) {\n-      console.error(`âŒ [${this.windowId}] èŽ·å–æœåŠ¡å™¨å¤±è´¥:`, error)\n-      return null\n-    }\n+  // ðŸ”§ èŽ·å–æœåŠ¡å™¨é”å®šä¿¡æ¯\n+  getServerLock(windowId) {\n+    return this.serverLocks.get(windowId) || null\n   }\n \n-  /**\n-   * ðŸ”§ å¯åŠ¨å¥åº·æ£€æŸ¥\n-   */\n-  startHealthCheck() {\n-    this.stopHealthCheck() // æ¸…ç†ä¹‹å‰çš„æ£€æŸ¥\n+  // ðŸ”§ è°ƒåº¦è§£é”æ£€æŸ¥\n+  scheduleUnlockCheck(windowId) {\n+    this.clearUnlockTimer(windowId)\n \n-    this.healthCheckInterval = setInterval(() => {\n-      this.performHealthCheck()\n+    const timer = setInterval(() => {\n+      this.checkUnlockCondition(windowId)\n     }, 30000) // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡\n \n-    console.log(`ðŸ’“ [${this.windowId}] å¯åŠ¨å¥åº·æ£€æŸ¥`)\n+    this.unlockTimers.set(windowId, timer)\n+    console.log(`â° [${windowId}] å·²è°ƒåº¦è§£é”æ£€æŸ¥`)\n   }\n \n-  /**\n-   * ðŸ”§ åœæ­¢å¥åº·æ£€æŸ¥\n-   */\n-  stopHealthCheck() {\n-    if (this.healthCheckInterval) {\n-      clearInterval(this.healthCheckInterval)\n-      this.healthCheckInterval = null\n-      console.log(`ðŸ’“ [${this.windowId}] åœæ­¢å¥åº·æ£€æŸ¥`)\n+  // ðŸ”§ æ¸…ç†è§£é”å®šæ—¶å™¨\n+  clearUnlockTimer(windowId) {\n+    const timer = this.unlockTimers.get(windowId)\n+    if (timer) {\n+      clearInterval(timer)\n+      this.unlockTimers.delete(windowId)\n+      console.log(`ðŸ§¹ [${windowId}] å·²æ¸…ç†è§£é”å®šæ—¶å™¨`)\n     }\n   }\n \n-  /**\n-   * ðŸ”§ æ‰§è¡Œå¥åº·æ£€æŸ¥\n-   */\n-  performHealthCheck() {\n-    const now = Date.now()\n-\n-    // æ£€æŸ¥è¿žæŽ¥çŠ¶æ€\n-    if (this.connection && this.connection.readyState !== WebSocket.OPEN) {\n-      console.warn(`âš ï¸ [${this.windowId}] å¥åº·æ£€æŸ¥: WebSocketè¿žæŽ¥å¼‚å¸¸`)\n-      this.scheduleReconnect()\n-      return\n+  // ðŸ”§ æ£€æŸ¥è§£é”æ¡ä»¶ï¼ˆéœ€è¦å¤–éƒ¨æä¾›ä»»åŠ¡è®¡æ•°ï¼‰\n+  checkUnlockCondition(windowId, taskCount = 0) {\n+    const lock = this.getServerLock(windowId)\n+    if (!lock) {\n+      this.clearUnlockTimer(windowId)\n+      return false\n     }\n \n-    // æ£€æŸ¥æ¶ˆæ¯æ´»è·ƒåº¦\n-    if (this.lastMessageTime && (now - this.lastMessageTime) > 120000) { // 2åˆ†é’Ÿæ— æ¶ˆæ¯\n-      console.warn(`âš ï¸ [${this.windowId}] å¥åº·æ£€æŸ¥: é•¿æ—¶é—´æ— æ¶ˆæ¯`)\n+    if (taskCount === 0) {\n+      console.log(`ðŸ”“ [${windowId}] æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œè‡ªåŠ¨è§£é”æœåŠ¡å™¨`)\n+      this.unlockServer(windowId)\n+      return true\n     }\n \n-    console.log(`ðŸ’“ [${this.windowId}] å¥åº·æ£€æŸ¥é€šè¿‡`)\n+    console.log(`ðŸ”’ [${windowId}] ä»æœ‰ ${taskCount} ä¸ªä»»åŠ¡ï¼Œä¿æŒé”å®š`)\n+    return false\n   }\n \n-  /**\n-   * ðŸ”§ æ£€æŸ¥è¿žæŽ¥å¥åº·çŠ¶æ€\n-   */\n-  checkConnectionHealth() {\n-    if (this.state === WS_STATE.CONNECTED && this.connection) {\n-      if (this.connection.readyState !== WebSocket.OPEN) {\n-        console.warn(`âš ï¸ [${this.windowId}] è¿žæŽ¥çŠ¶æ€å¼‚å¸¸ï¼Œå°è¯•é‡è¿ž`)\n-        this.scheduleReconnect()\n+  // ðŸ”§ èŽ·å–æ‰€æœ‰è¿žæŽ¥çŠ¶æ€\n+  getAllConnectionStatus() {\n+    const status = {}\n+    this.connections.forEach((info, windowId) => {\n+      status[windowId] = {\n+        isConnected: info.isConnected,\n+        server: info.server,\n+        clientId: info.clientId,\n+        connectedAt: info.connectedAt,\n+        lock: this.getServerLock(windowId)\n       }\n-    }\n+    })\n+    return status\n   }\n \n-  /**\n-   * ðŸ”§ è°ƒåº¦é‡è¿ž\n-   */\n-  scheduleReconnect() {\n-    if (this.reconnectTimer) {\n-      return // å·²ç»åœ¨é‡è¿žä¸­\n-    }\n+  // ðŸ”§ æ¸…ç†æ‰€æœ‰è¿žæŽ¥\n+  async cleanup() {\n+    console.log('ðŸ§¹ æ¸…ç†æ‰€æœ‰WebSocketè¿žæŽ¥')\n \n-    if (this.reconnectAttempts >= this.maxReconnectAttempts) {\n-      console.error(`âŒ [${this.windowId}] é‡è¿žæ¬¡æ•°è¶…é™ï¼Œåœæ­¢é‡è¿ž`)\n-      this.state = WS_STATE.FAILED\n-      this.emit('reconnect:failed', { windowId: this.windowId })\n-      return\n-    }\n+    // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨\n+    this.unlockTimers.forEach((timer, windowId) => {\n+      clearInterval(timer)\n+    })\n+    this.unlockTimers.clear()\n \n-    this.state = WS_STATE.RECONNECTING\n-    this.reconnectAttempts++\n+    // æ–­å¼€æ‰€æœ‰è¿žæŽ¥\n+    const disconnectPromises = Array.from(this.connections.keys()).map(windowId =>\n+      this.disconnect(windowId)\n+    )\n \n-    const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1) // æŒ‡æ•°é€€é¿\n+    await Promise.all(disconnectPromises)\n \n-    console.log(`ðŸ”„ [${this.windowId}] è°ƒåº¦é‡è¿ž (ç¬¬${this.reconnectAttempts}æ¬¡ï¼Œ${delay}msåŽ)`)\n+    // æ¸…ç†æ‰€æœ‰æ•°æ®\n+    this.connections.clear()\n+    this.serverLocks.clear()\n+    this.messageHandlers.clear()\n \n-    this.reconnectTimer = setTimeout(async () => {\n-      this.reconnectTimer = null\n-\n-      try {\n-        await this.connect(this.lockedServer)\n-        console.log(`âœ… [${this.windowId}] é‡è¿žæˆåŠŸ`)\n-        this.emit('reconnect:success', { windowId: this.windowId })\n-      } catch (error) {\n-        console.error(`âŒ [${this.windowId}] é‡è¿žå¤±è´¥:`, error)\n-        this.scheduleReconnect() // ç»§ç»­å°è¯•é‡è¿ž\n-      }\n-    }, delay)\n+    console.log('âœ… WebSocketç®¡ç†å™¨æ¸…ç†å®Œæˆ')\n   }\n+}\n \n-  /**\n-   * ðŸ”§ æ¸…é™¤é‡è¿žå®šæ—¶å™¨\n-   */\n-  clearReconnectTimer() {\n-    if (this.reconnectTimer) {\n-      clearTimeout(this.reconnectTimer)\n-      this.reconnectTimer = null\n-      console.log(`ðŸ§¹ [${this.windowId}] æ¸…é™¤é‡è¿žå®šæ—¶å™¨`)\n-    }\n-  }\n+// ðŸ”§ åˆ›å»ºå…¨å±€WebSocketç®¡ç†å™¨å®žä¾‹\n+const websocketManager = new WebSocketManager()\n \n-  /**\n-   * ðŸ”§ æ–­å¼€è¿žæŽ¥\n-   */\n-  disconnect() {\n-    this.stopHealthCheck()\n-    this.clearReconnectTimer()\n-\n-    if (this.connection) {\n-      this.connection.close(1000, 'ä¸»åŠ¨æ–­å¼€è¿žæŽ¥')\n-      this.connection = null\n-    }\n-\n-    this.state = WS_STATE.DISCONNECTED\n-    this.currentServer = null\n-    this.emit('disconnected', { windowId: this.windowId })\n-    console.log(`ðŸ”Œ [${this.windowId}] WebSocketå·²æ–­å¼€è¿žæŽ¥`)\n-  }\n-\n-  /**\n-   * ðŸ”§ å¼ºåˆ¶é‡è¿žåˆ°æŒ‡å®šæœåŠ¡å™¨\n-   */\n-  async forceReconnect(serverUrl = null) {\n-    console.log(`ðŸ”„ [${this.windowId}] å¼ºåˆ¶é‡è¿žåˆ°æœåŠ¡å™¨: ${serverUrl || 'è‡ªåŠ¨é€‰æ‹©'}`)\n-\n-    // æ–­å¼€çŽ°æœ‰è¿žæŽ¥\n-    this.disconnect()\n-\n-    // é‡ç½®é‡è¿žè®¡æ•°\n-    this.reconnectAttempts = 0\n-\n-    // è¿žæŽ¥åˆ°æŒ‡å®šæœåŠ¡å™¨\n-    return await this.connect(serverUrl)\n-  }\n-\n-  /**\n-   * ðŸ”§ ç¡®ä¿WebSocketè¿žæŽ¥\n-   */\n-  async ensureConnection(serverUrl = null) {\n-    // å¦‚æžœæŒ‡å®šäº†æœåŠ¡å™¨ä¸”ä¸Žå½“å‰ä¸åŒï¼Œéœ€è¦é‡æ–°è¿žæŽ¥\n-    if (serverUrl && this.lockedServer && serverUrl !== this.lockedServer) {\n-      console.log(`ðŸ”„ [${this.windowId}] æœåŠ¡å™¨ä¸ä¸€è‡´ï¼Œé‡æ–°è¿žæŽ¥`)\n-      console.log(`   å½“å‰é”å®š: ${this.lockedServer}`)\n-      console.log(`   ç›®æ ‡æœåŠ¡å™¨: ${serverUrl}`)\n-      return await this.forceReconnect(serverUrl)\n-    }\n-\n-    // å¦‚æžœå·²è¿žæŽ¥ä¸”æœåŠ¡å™¨ä¸€è‡´ï¼Œç›´æŽ¥è¿”å›ž\n-    if (this.state === WS_STATE.CONNECTED && this.connection?.readyState === WebSocket.OPEN) {\n-      console.log(`âœ… [${this.windowId}] WebSocketå·²è¿žæŽ¥`)\n-      this.processMessageQueue() // å¤„ç†å¾…å‘é€æ¶ˆæ¯\n-      return true\n-    }\n-\n-    // éœ€è¦å»ºç«‹æ–°è¿žæŽ¥\n-    console.log(`ðŸ”„ [${this.windowId}] å»ºç«‹æ–°çš„WebSocketè¿žæŽ¥`)\n-    return await this.connect(serverUrl)\n-  }\n-\n-  /**\n-   * ðŸ”§ èŽ·å–è¿žæŽ¥çŠ¶æ€\n-   */\n-  getStatus() {\n-    return {\n-      windowId: this.windowId,\n-      clientId: this.clientId,\n-      state: this.state,\n-      isConnected: this.state === WS_STATE.CONNECTED,\n-      currentServer: this.currentServer,\n-      lockedServer: this.lockedServer,\n-      lockTimestamp: this.lockTimestamp,\n-      lockDuration: this.lockTimestamp ? Date.now() - this.lockTimestamp : null,\n-      reconnectAttempts: this.reconnectAttempts,\n-      connectionState: this.connection?.readyState || 'CLOSED',\n-      messageQueueLength: this.messageQueue.length,\n-      lastMessageTime: this.lastMessageTime\n-    }\n-  }\n-\n-  /**\n-   * ðŸ”§ è°ƒè¯•ä¿¡æ¯\n-   */\n-  debug() {\n-    const status = this.getStatus()\n-    console.log(`ðŸ” [${this.windowId}] ===== WebSocketç®¡ç†å™¨çŠ¶æ€ =====`)\n-    console.log(`ðŸªŸ çª—å£ID: ${status.windowId}`)\n-    console.log(`ðŸ”‘ å®¢æˆ·ç«¯ID: ${status.clientId}`)\n-    console.log(`ðŸ”— è¿žæŽ¥çŠ¶æ€: ${status.state}`)\n-    console.log(`ðŸ“¡ å½“å‰æœåŠ¡å™¨: ${status.currentServer || 'æ— '}`)\n-    console.log(`ðŸ”’ é”å®šæœåŠ¡å™¨: ${status.lockedServer || 'æ— '}`)\n-    console.log(`ðŸ• é”å®šæ—¶é—´: ${status.lockTimestamp ? new Date(status.lockTimestamp).toLocaleString() : 'æ— '}`)\n-    console.log(`â±ï¸ é”å®šæŒç»­: ${status.lockDuration ? Math.round(status.lockDuration / 1000) + 'ç§’' : 'æ— '}`)\n-    console.log(`ðŸ”„ é‡è¿žæ¬¡æ•°: ${status.reconnectAttempts}`)\n-    console.log(`ðŸ“¤ æ¶ˆæ¯é˜Ÿåˆ—: ${status.messageQueueLength} æ¡`)\n-    console.log(`ðŸ“¨ æœ€åŽæ¶ˆæ¯: ${status.lastMessageTime ? new Date(status.lastMessageTime).toLocaleString() : 'æ— '}`)\n-    console.log(`ðŸ” [${this.windowId}] ===== çŠ¶æ€ä¿¡æ¯ç»“æŸ =====`)\n-\n-    return status\n-  }\n-\n-  /**\n-   * ðŸ”§ é‡ç½®ç®¡ç†å™¨çŠ¶æ€\n-   */\n-  reset() {\n-    console.log(`ðŸ”„ [${this.windowId}] é‡ç½®WebSocketç®¡ç†å™¨`)\n-\n-    this.disconnect()\n-    this.unlockServer()\n-    this.messageQueue = []\n-    this.reconnectAttempts = 0\n-    this.lastMessageTime = null\n-\n-    console.log(`âœ… [${this.windowId}] WebSocketç®¡ç†å™¨å·²é‡ç½®`)\n-  }\n+// ðŸ”§ å¯¼å‡ºç®¡ç†å™¨å®žä¾‹å’Œç›¸å…³å·¥å…·\n+export {\n+  websocketManager,\n+  WebSocketManager\n }\n \n-// åˆ›å»ºå…¨å±€å®žä¾‹\n-const webSocketManager = new WebSocketManager()\n-\n-// æš´éœ²è°ƒè¯•å‡½æ•°åˆ°å…¨å±€\n+// ðŸ”§ åœ¨çª—å£å¸è½½æ—¶æ¸…ç†èµ„æº\n if (typeof window !== 'undefined') {\n-  window.webSocketManager = webSocketManager\n-  window.debugWebSocket = () => webSocketManager.debug()\n-  window.resetWebSocket = () => webSocketManager.reset()\n+  window.addEventListener('beforeunload', () => {\n+    websocketManager.cleanup()\n+  })\n }\n-\n-export default webSocketManager\n"
                },
                {
                    "date": 1753504742879,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -70,8 +70,21 @@\n \n       // å…³é—­çŽ°æœ‰è¿žæŽ¥\n       await this.disconnect(windowId)\n \n+      // ç®€å•çš„HTTPè¿žæŽ¥æµ‹è¯•\n+      try {\n+        const testResponse = await fetch(`${server}/api/queue`, {\n+          method: 'GET',\n+          signal: AbortSignal.timeout(5000)\n+        })\n+        if (!testResponse.ok) {\n+          throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${testResponse.status}`)\n+        }\n+      } catch (httpError) {\n+        throw new Error(`ComfyUIæœåŠ¡å™¨ä¸å¯è¾¾: ${httpError.message}`)\n+      }\n+\n       // åˆ›å»ºæ–°è¿žæŽ¥\n       const ws = new WebSocket(wsUrl)\n \n       // è®¾ç½®è¿žæŽ¥ä¿¡æ¯\n"
                },
                {
                    "date": 1753504755349,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -107,8 +107,20 @@\n         ws.onopen = () => {\n           connectionInfo.isConnected = true\n           clearTimeout(timeout)\n           console.log(`âœ… [${windowId}] WebSocketè¿žæŽ¥æˆåŠŸ`)\n+\n+          // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ä¾›Vueç»„ä»¶ç›‘å¬\n+          if (typeof window !== 'undefined') {\n+            window.dispatchEvent(new CustomEvent('comfyui-status', {\n+              detail: {\n+                message: `[${windowId}] WebSocketè¿žæŽ¥æˆåŠŸ`,\n+                type: 'success',\n+                timestamp: Date.now()\n+              }\n+            }))\n+          }\n+\n           resolve(connectionInfo)\n         }\n \n         ws.onmessage = (event) => {\n"
                },
                {
                    "date": 1753504766757,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -129,8 +129,19 @@\n \n         ws.onclose = (event) => {\n           connectionInfo.isConnected = false\n           console.log(`ðŸ”Œ [${windowId}] WebSocketè¿žæŽ¥å…³é—­:`, event.code, event.reason)\n+\n+          // è§¦å‘è¿žæŽ¥å…³é—­äº‹ä»¶\n+          if (typeof window !== 'undefined') {\n+            window.dispatchEvent(new CustomEvent('comfyui-status', {\n+              detail: {\n+                message: `[${windowId}] WebSocketè¿žæŽ¥å…³é—­`,\n+                type: 'warning',\n+                timestamp: Date.now()\n+              }\n+            }))\n+          }\n         }\n \n         ws.onerror = (error) => {\n           connectionInfo.isConnected = false\n"
                },
                {
                    "date": 1753504781394,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -250,8 +250,39 @@\n   getServerLock(windowId) {\n     return this.serverLocks.get(windowId) || null\n   }\n \n+  // ðŸ”§ å¼ºåˆ¶è§£é”æœåŠ¡å™¨\n+  forceUnlockServer(windowId) {\n+    this.unlockServer(windowId)\n+    console.log(`ðŸ”“ [${windowId}] å¼ºåˆ¶è§£é”æœåŠ¡å™¨`)\n+  }\n+\n+  // ðŸ”§ æ›´æ–°ä»»åŠ¡è®¡æ•°\n+  updateTaskCount(windowId, taskCount) {\n+    const lock = this.getServerLock(windowId)\n+    if (lock) {\n+      lock.taskCount = taskCount\n+      console.log(`ðŸ“Š [${windowId}] æ›´æ–°ä»»åŠ¡è®¡æ•°: ${taskCount}`)\n+    }\n+  }\n+\n+  // ðŸ”§ é‡ç½®æœåŠ¡å™¨è¿žæŽ¥\n+  async resetServer(windowId, force = false) {\n+    console.log(`ðŸ”„ [${windowId}] é‡ç½®WebSocketæœåŠ¡å™¨ (å¼ºåˆ¶: ${force})`)\n+\n+    // æ–­å¼€çŽ°æœ‰è¿žæŽ¥\n+    await this.disconnect(windowId)\n+\n+    // æ¸…ç†æœåŠ¡å™¨é”å®š\n+    if (force) {\n+      this.forceUnlockServer(windowId)\n+    }\n+\n+    console.log(`âœ… [${windowId}] WebSocketæœåŠ¡å™¨é‡ç½®å®Œæˆ`)\n+    return true\n+  }\n+\n   // ðŸ”§ è°ƒåº¦è§£é”æ£€æŸ¥\n   scheduleUnlockCheck(windowId) {\n     this.clearUnlockTimer(windowId)\n \n"
                },
                {
                    "date": 1753504791197,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -368,9 +368,10 @@\n \n // ðŸ”§ å¯¼å‡ºç®¡ç†å™¨å®žä¾‹å’Œç›¸å…³å·¥å…·\n export {\n   websocketManager,\n-  WebSocketManager\n+  WebSocketManager,\n+  generateClientId\n }\n \n // ðŸ”§ åœ¨çª—å£å¸è½½æ—¶æ¸…ç†èµ„æº\n if (typeof window !== 'undefined') {\n"
                },
                {
                    "date": 1753506267468,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,381 +1,374 @@\n-// ðŸ”§ WebSocketç®¡ç†å™¨ - ç‹¬ç«‹çš„è¿žæŽ¥æ± å’Œæ¶ˆæ¯åˆ†å‘ç³»ç»Ÿ\n-// æ”¯æŒå¤šçª—å£éš”ç¦»ã€æ¶ˆæ¯å¤„ç†å™¨æ³¨å†Œã€æœåŠ¡å™¨é”å®šç­‰åŠŸèƒ½\n+// WebSocket ç®¡ç†å™¨ - ç‹¬ç«‹æ¨¡å—\n+// è´Ÿè´£æ‰€æœ‰ WebSocket è¿žæŽ¥ç®¡ç†ã€æ¶ˆæ¯å¤„ç†ã€é‡è¿žé€»è¾‘å’Œçª—å£éš”ç¦»æœºåˆ¶\n \n-// ðŸ”§ ç”Ÿæˆå”¯ä¸€å®¢æˆ·ç«¯IDçš„å‡½æ•°ï¼ˆé¿å…å¾ªçŽ¯ä¾èµ–ï¼‰\n-function generateClientId() {\n+import loadBalancer from './loadBalancer.js'\n+\n+// ðŸ”§ çª—å£å”¯ä¸€æ ‡è¯†ç¬¦ç”Ÿæˆæœºåˆ¶\n+function generateWindowId() {\n+  return `${Date.now()}_${Math.random().toString(36).substring(2, 11)}`\n+}\n+\n+// ðŸ”§ ä¸ºå½“å‰çª—å£ç”Ÿæˆå”¯ä¸€çš„clientId - å¢žå¼ºå”¯ä¸€æ€§é˜²æ­¢å†²çª\n+function generateUniqueClientId() {\n+  const baseId = 'abc1373d4ad648a3a81d0587fbe5534b' // åŸºç¡€clientId\n   const timestamp = Date.now()\n-  const random = Math.random().toString(36).substring(2, 8)\n-  const windowId = typeof window !== 'undefined' ?\n-    (window.WINDOW_ID || 'unknown') : 'server'\n-  return `${windowId}_${timestamp}_${random}`\n+  const random = Math.random().toString(36).substring(2, 11)\n+  const windowId = generateWindowId()\n+\n+  // ðŸ”§ å¢žå¼ºå”¯ä¸€æ€§ï¼šåŸºç¡€ID + æ—¶é—´æˆ³ + éšæœºæ•° + çª—å£ID\n+  return `${baseId}_${timestamp}_${random}_${windowId}`\n }\n \n-// ðŸ”§ WebSocketè¿žæŽ¥ç®¡ç†å™¨ç±»\n+// ðŸ”§ çª—å£çº§åˆ«çš„å…¨å±€å˜é‡ - ç¡®ä¿æ¯ä¸ªçª—å£éƒ½æœ‰å”¯ä¸€æ ‡è¯†\n+const WINDOW_CLIENT_ID = generateUniqueClientId()\n+const WINDOW_ID = generateWindowId()\n+\n+console.log(`ðŸªŸ çª—å£æ ‡è¯†: ${WINDOW_ID}`)\n+console.log(`ðŸ”‘ çª—å£å®¢æˆ·ç«¯ID: ${WINDOW_CLIENT_ID}`)\n+\n+/**\n+ * WebSocket ç®¡ç†å™¨ç±»\n+ * è´Ÿè´£ WebSocket è¿žæŽ¥çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç†\n+ */\n class WebSocketManager {\n   constructor() {\n-    // è¿žæŽ¥æ± ï¼šwindowId -> { connection, server, clientId, isConnected }\n-    this.connections = new Map()\n+    // WebSocket è¿žæŽ¥çŠ¶æ€\n+    this.wsConnection = null\n+    this.isWsConnected = false\n+    this.currentWebSocketServer = null\n \n-    // æ¶ˆæ¯å¤„ç†å™¨æ³¨å†Œè¡¨ï¼šmessageType -> handler[]\n-    this.messageHandlers = new Map()\n+    // çª—å£éš”ç¦»çš„ä»»åŠ¡é˜Ÿåˆ—\n+    this.windowTasks = new Map() // promptId -> task\n \n-    // çª—å£çº§åˆ«çš„æœåŠ¡å™¨é”å®šï¼šwindowId -> { server, timestamp, tasks }\n-    this.serverLocks = new Map()\n+    // çª—å£çº§åˆ«çš„æœåŠ¡å™¨é”å®šæœºåˆ¶\n+    this.WINDOW_SERVER_LOCKS = new Map() // windowId -> { server, timestamp, tasks }\n \n-    // è§£é”æ£€æŸ¥å®šæ—¶å™¨ï¼šwindowId -> timerId\n-    this.unlockTimers = new Map()\n+    // åŠ¨æ€è§£é”æ£€æŸ¥æœºåˆ¶\n+    this.serverUnlockTimer = null\n \n-    console.log('ðŸ”§ WebSocketç®¡ç†å™¨å·²åˆå§‹åŒ–')\n-  }\n+    // é˜²æŠ–æœºåˆ¶ï¼šé¿å…é¢‘ç¹çš„è¿›åº¦å›žè°ƒè§¦å‘é€’å½’æ›´æ–°\n+    this.progressCallbackDebounce = new Map()\n \n-  // ðŸ”§ æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨\n-  registerHandler(messageType, handler, windowId = null) {\n-    if (!this.messageHandlers.has(messageType)) {\n-      this.messageHandlers.set(messageType, [])\n+    // å®˜æ–¹æ ‡å‡†ä»»åŠ¡çŠ¶æ€æžšä¸¾\n+    this.TASK_STATUS = {\n+      WAITING: 'waiting',        // ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…\n+      EXECUTING: 'executing',    // ä»»åŠ¡æ­£åœ¨æ‰§è¡Œ\n+      COMPLETED: 'completed',    // ä»»åŠ¡å·²å®Œæˆ\n+      ERROR: 'error',           // ä»»åŠ¡æ‰§è¡Œé”™è¯¯\n+      INTERRUPTED: 'interrupted' // ä»»åŠ¡è¢«ä¸­æ–­\n     }\n \n-    const handlerInfo = { handler, windowId }\n-    this.messageHandlers.get(messageType).push(handlerInfo)\n-\n-    console.log(`ðŸ“ æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨: ${messageType} (çª—å£: ${windowId || 'global'})`)\n+    // åˆå§‹åŒ–çª—å£äº‹ä»¶ç›‘å¬\n+    this._initializeWindowEvents()\n+    this._initializeGlobalProperties()\n   }\n \n-  // ðŸ”§ ç§»é™¤æ¶ˆæ¯å¤„ç†å™¨\n-  unregisterHandler(messageType, handler) {\n-    const handlers = this.messageHandlers.get(messageType)\n-    if (handlers) {\n-      const index = handlers.findIndex(h => h.handler === handler)\n-      if (index !== -1) {\n-        handlers.splice(index, 1)\n-        console.log(`ðŸ—‘ï¸ ç§»é™¤æ¶ˆæ¯å¤„ç†å™¨: ${messageType}`)\n-      }\n-    }\n-  }\n+  // ðŸ”§ çª—å£å…³é—­æ—¶çš„æ¸…ç†æœºåˆ¶\n+  _initializeWindowEvents() {\n+    window.addEventListener('beforeunload', () => {\n+      console.log(`ðŸšª [${WINDOW_ID}] çª—å£å³å°†å…³é—­ï¼Œæ‰§è¡Œæ¸…ç†...`)\n \n-  // ðŸ”§ è¿žæŽ¥åˆ°æŒ‡å®šæœåŠ¡å™¨\n-  async connect(windowId, server, clientId = null) {\n-    try {\n-      // ç”Ÿæˆæˆ–ä½¿ç”¨æä¾›çš„clientId\n-      const finalClientId = clientId || generateClientId()\n-\n-      // æž„å»ºWebSocket URL\n-      let wsUrl\n-      if (server.startsWith('https://')) {\n-        wsUrl = server.replace('https://', 'wss://') + '/ws?clientId=' + finalClientId\n-      } else {\n-        wsUrl = server.replace('http://', 'ws://') + '/ws?clientId=' + finalClientId\n+      // æ¸…ç†å½“å‰çª—å£çš„æœåŠ¡å™¨é”å®š\n+      const currentLock = this.getWindowServerLock()\n+      if (currentLock) {\n+        console.log(`ðŸ”“ [${WINDOW_ID}] çª—å£å…³é—­ï¼Œæ¸…ç†æœåŠ¡å™¨é”å®š: ${currentLock.server}`)\n+        this.clearWindowServerLock()\n       }\n \n-      console.log(`ðŸ”Œ [${windowId}] è¿žæŽ¥WebSocket: ${wsUrl}`)\n-\n-      // å…³é—­çŽ°æœ‰è¿žæŽ¥\n-      await this.disconnect(windowId)\n-\n-      // ç®€å•çš„HTTPè¿žæŽ¥æµ‹è¯•\n-      try {\n-        const testResponse = await fetch(`${server}/api/queue`, {\n-          method: 'GET',\n-          signal: AbortSignal.timeout(5000)\n-        })\n-        if (!testResponse.ok) {\n-          throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${testResponse.status}`)\n-        }\n-      } catch (httpError) {\n-        throw new Error(`ComfyUIæœåŠ¡å™¨ä¸å¯è¾¾: ${httpError.message}`)\n+      // æ¸…ç†å½“å‰çª—å£çš„ä»»åŠ¡\n+      if (this.windowTasks.size > 0) {\n+        console.log(`ðŸ—‘ï¸ [${WINDOW_ID}] çª—å£å…³é—­ï¼Œæ¸…ç† ${this.windowTasks.size} ä¸ªä»»åŠ¡`)\n+        this.windowTasks.clear()\n       }\n \n-      // åˆ›å»ºæ–°è¿žæŽ¥\n-      const ws = new WebSocket(wsUrl)\n-\n-      // è®¾ç½®è¿žæŽ¥ä¿¡æ¯\n-      const connectionInfo = {\n-        connection: ws,\n-        server: server,\n-        clientId: finalClientId,\n-        isConnected: false,\n-        windowId: windowId,\n-        connectedAt: Date.now()\n+      // å…³é—­WebSocketè¿žæŽ¥\n+      if (this.wsConnection && this.wsConnection.readyState === WebSocket.OPEN) {\n+        console.log(`ðŸ”Œ [${WINDOW_ID}] çª—å£å…³é—­ï¼Œæ–­å¼€WebSocketè¿žæŽ¥`)\n+        this.wsConnection.close()\n       }\n+    })\n \n-      this.connections.set(windowId, connectionInfo)\n+    // ðŸ”§ é¡µé¢å¯è§æ€§å˜åŒ–æ—¶çš„å¤„ç†\n+    document.addEventListener('visibilitychange', () => {\n+      if (document.hidden) {\n+        console.log(`ðŸ‘ï¸ [${WINDOW_ID}] çª—å£éšè—`)\n+      } else {\n+        console.log(`ðŸ‘ï¸ [${WINDOW_ID}] çª—å£é‡æ–°å¯è§`)\n \n-      return new Promise((resolve, reject) => {\n-        const timeout = setTimeout(() => {\n-          reject(new Error('WebSocketè¿žæŽ¥è¶…æ—¶'))\n-        }, 10000)\n-\n-        ws.onopen = () => {\n-          connectionInfo.isConnected = true\n-          clearTimeout(timeout)\n-          console.log(`âœ… [${windowId}] WebSocketè¿žæŽ¥æˆåŠŸ`)\n-\n-          // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ä¾›Vueç»„ä»¶ç›‘å¬\n-          if (typeof window !== 'undefined') {\n-            window.dispatchEvent(new CustomEvent('comfyui-status', {\n-              detail: {\n-                message: `[${windowId}] WebSocketè¿žæŽ¥æˆåŠŸ`,\n-                type: 'success',\n-                timestamp: Date.now()\n-              }\n-            }))\n-          }\n-\n-          resolve(connectionInfo)\n+        // æ£€æŸ¥æœåŠ¡å™¨é”å®šçŠ¶æ€\n+        const currentLock = this.getWindowServerLock()\n+        if (currentLock) {\n+          console.log(`ðŸ”’ [${WINDOW_ID}] çª—å£é‡æ–°å¯è§ï¼ŒæœåŠ¡å™¨é”å®šçŠ¶æ€: ${currentLock.server}`)\n         }\n \n-        ws.onmessage = (event) => {\n-          this.handleMessage(windowId, event.data)\n+        // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\n+        if (this.windowTasks.size > 0) {\n+          console.log(`ðŸ“Š [${WINDOW_ID}] çª—å£é‡æ–°å¯è§ï¼Œå½“å‰ä»»åŠ¡æ•°: ${this.windowTasks.size}`)\n         }\n+      }\n+    })\n+  }\n \n-        ws.onclose = (event) => {\n-          connectionInfo.isConnected = false\n-          console.log(`ðŸ”Œ [${windowId}] WebSocketè¿žæŽ¥å…³é—­:`, event.code, event.reason)\n-\n-          // è§¦å‘è¿žæŽ¥å…³é—­äº‹ä»¶\n-          if (typeof window !== 'undefined') {\n-            window.dispatchEvent(new CustomEvent('comfyui-status', {\n-              detail: {\n-                message: `[${windowId}] WebSocketè¿žæŽ¥å…³é—­`,\n-                type: 'warning',\n-                timestamp: Date.now()\n-              }\n-            }))\n-          }\n+  // ðŸ”§ åˆå§‹åŒ–å…¨å±€å±žæ€§ä»¥ä¿æŒå‘åŽå…¼å®¹\n+  _initializeGlobalProperties() {\n+    // ðŸ”§ å…¼å®¹æ€§ï¼šåŠ¨æ€èŽ·å–å½“å‰çª—å£çš„é”å®šæœåŠ¡å™¨\n+    Object.defineProperty(window, 'windowLockedServer', {\n+      get: () => {\n+        const lock = this.getWindowServerLock()\n+        return lock ? lock.server : null\n+      },\n+      set: (value) => {\n+        if (value) {\n+          this.setWindowServerLock(value)\n+        } else {\n+          this.clearWindowServerLock()\n         }\n+      }\n+    })\n \n-        ws.onerror = (error) => {\n-          connectionInfo.isConnected = false\n-          clearTimeout(timeout)\n-          console.error(`âŒ [${windowId}] WebSocketè¿žæŽ¥é”™è¯¯:`, error)\n-          reject(error)\n-        }\n-      })\n+    Object.defineProperty(window, 'windowLockTimestamp', {\n+      get: () => {\n+        const lock = this.getWindowServerLock()\n+        return lock ? lock.timestamp : null\n+      }\n+    })\n \n-    } catch (error) {\n-      console.error(`âŒ [${windowId}] WebSocketè¿žæŽ¥å¤±è´¥:`, error)\n-      throw error\n-    }\n-  }\n+    // ðŸ”§ ä¿ç•™åŽŸæœ‰çš„å…¨å±€å˜é‡åä½†ä½¿ç”¨çª—å£çº§åˆ«çš„å€¼ï¼ˆåŠ¨æ€èŽ·å–ï¼‰\n+    Object.defineProperty(window, 'currentWebSocketServer', {\n+      get: () => {\n+        return window.windowLockedServer\n+      },\n+      set: (value) => {\n+        window.windowLockedServer = value\n+      }\n+    })\n \n-  // ðŸ”§ æ–­å¼€è¿žæŽ¥\n-  async disconnect(windowId) {\n-    const connectionInfo = this.connections.get(windowId)\n-    if (connectionInfo && connectionInfo.connection) {\n-      try {\n-        connectionInfo.connection.close()\n-        console.log(`ðŸ”Œ [${windowId}] WebSocketè¿žæŽ¥å·²æ–­å¼€`)\n-      } catch (error) {\n-        console.warn(`âš ï¸ [${windowId}] æ–­å¼€WebSocketè¿žæŽ¥æ—¶å‡ºé”™:`, error)\n+    Object.defineProperty(window, 'serverLockTimestamp', {\n+      get: () => {\n+        return window.windowLockTimestamp\n       }\n-    }\n-    this.connections.delete(windowId)\n-  }\n+    })\n \n-  // ðŸ”§ èŽ·å–è¿žæŽ¥ä¿¡æ¯\n-  getConnection(windowId) {\n-    return this.connections.get(windowId)?.connection || null\n+    // ðŸ”§ ä¸ºäº†å‘åŽå…¼å®¹ï¼Œä¿ç•™ pendingTasks å¼•ç”¨ä½†æŒ‡å‘çª—å£ä»»åŠ¡é˜Ÿåˆ—\n+    window.pendingTasks = this.windowTasks\n   }\n \n-  // ðŸ”§ æ£€æŸ¥è¿žæŽ¥çŠ¶æ€\n-  isConnected(windowId) {\n-    const connectionInfo = this.connections.get(windowId)\n-    return connectionInfo?.isConnected &&\n-           connectionInfo.connection?.readyState === WebSocket.OPEN\n+  // ðŸ”§ èŽ·å–å½“å‰çª—å£çš„æœåŠ¡å™¨é”å®šä¿¡æ¯\n+  getWindowServerLock() {\n+    return this.WINDOW_SERVER_LOCKS.get(WINDOW_ID) || null\n   }\n \n-  // ðŸ”§ èŽ·å–è¿žæŽ¥çš„æœåŠ¡å™¨\n-  getConnectedServer(windowId) {\n-    return this.connections.get(windowId)?.server || null\n-  }\n-\n-  // ðŸ”§ æ¶ˆæ¯åˆ†å‘å¤„ç†\n-  handleMessage(windowId, data) {\n-    try {\n-      const message = JSON.parse(data)\n-      const { type } = message\n-\n-      // é™é»˜å¤„ç†crystools.monitoræ¶ˆæ¯\n-      if (type === 'crystools.monitor') {\n-        return\n-      }\n-\n-      console.log(`ðŸ“¨ [${windowId}] æ”¶åˆ°æ¶ˆæ¯: ${type}`)\n-\n-      // åˆ†å‘åˆ°æ³¨å†Œçš„å¤„ç†å™¨\n-      const handlers = this.messageHandlers.get(type) || []\n-\n-      handlers.forEach(({ handler, windowId: handlerWindowId }) => {\n-        // å¦‚æžœå¤„ç†å™¨æŒ‡å®šäº†çª—å£IDï¼Œåªå¤„ç†å¯¹åº”çª—å£çš„æ¶ˆæ¯\n-        if (handlerWindowId && handlerWindowId !== windowId) {\n-          return\n-        }\n-\n-        try {\n-          handler(windowId, message)\n-        } catch (error) {\n-          console.error(`âŒ [${windowId}] æ¶ˆæ¯å¤„ç†å™¨æ‰§è¡Œå¤±è´¥:`, error)\n-        }\n-      })\n-\n-    } catch (error) {\n-      console.error(`âŒ [${windowId}] æ¶ˆæ¯è§£æžå¤±è´¥:`, error)\n-    }\n-  }\n-\n-  // ðŸ”§ æœåŠ¡å™¨é”å®šç®¡ç†\n-  lockServer(windowId, server, taskCount = 0) {\n-    const timestamp = Date.now()\n-    this.serverLocks.set(windowId, {\n+  // ðŸ”§ è®¾ç½®å½“å‰çª—å£çš„æœåŠ¡å™¨é”å®šä¿¡æ¯\n+  setWindowServerLock(server, timestamp = Date.now()) {\n+    this.WINDOW_SERVER_LOCKS.set(WINDOW_ID, {\n       server,\n       timestamp,\n-      windowId,\n-      taskCount\n+      windowId: WINDOW_ID,\n+      clientId: WINDOW_CLIENT_ID\n     })\n-\n-    console.log(`ðŸ”’ [${windowId}] é”å®šæœåŠ¡å™¨: ${server}`)\n-    this.scheduleUnlockCheck(windowId)\n+    console.log(`ðŸ”’ [${WINDOW_ID}] è®¾ç½®çª—å£æœåŠ¡å™¨é”å®š: ${server}`)\n   }\n \n-  // ðŸ”§ è§£é”æœåŠ¡å™¨\n-  unlockServer(windowId) {\n-    const lock = this.serverLocks.get(windowId)\n+  // ðŸ”§ æ¸…é™¤å½“å‰çª—å£çš„æœåŠ¡å™¨é”å®šä¿¡æ¯\n+  clearWindowServerLock() {\n+    const lock = this.WINDOW_SERVER_LOCKS.get(WINDOW_ID)\n     if (lock) {\n-      this.serverLocks.delete(windowId)\n-      console.log(`ðŸ”“ [${windowId}] è§£é”æœåŠ¡å™¨: ${lock.server}`)\n+      this.WINDOW_SERVER_LOCKS.delete(WINDOW_ID)\n+      console.log(`ðŸ”“ [${WINDOW_ID}] æ¸…é™¤çª—å£æœåŠ¡å™¨é”å®š: ${lock.server}`)\n     }\n-    this.clearUnlockTimer(windowId)\n   }\n \n-  // ðŸ”§ èŽ·å–æœåŠ¡å™¨é”å®šä¿¡æ¯\n-  getServerLock(windowId) {\n-    return this.serverLocks.get(windowId) || null\n+  // ðŸ”§ åŠ¨æ€æœåŠ¡å™¨é”å®šç®¡ç†ï¼ˆåŸºäºŽä»»åŠ¡çŠ¶æ€çš„æ™ºèƒ½é”å®šï¼‰\n+  lockServerForWindow(serverUrl) {\n+    const timestamp = Date.now()\n+    this.setWindowServerLock(serverUrl, timestamp)\n+\n+    console.log(`ðŸ”’ [${WINDOW_ID}] é”å®šæœåŠ¡å™¨: ${serverUrl}`)\n+    console.log(`ðŸ• [${WINDOW_ID}] é”å®šæ—¶é—´: ${new Date(timestamp).toLocaleTimeString()}`)\n+    console.log(`ðŸŽ¯ [${WINDOW_ID}] é”å®šæ¨¡å¼: ä»»åŠ¡é©±åŠ¨åŠ¨æ€é”å®šï¼ˆæ— å›ºå®šè¶…æ—¶ï¼‰`)\n+    console.log(`ðŸªŸ [${WINDOW_ID}] çª—å£éš”ç¦»: ç‹¬ç«‹é”å®šï¼Œä¸å½±å“å…¶ä»–çª—å£`)\n+\n+    // ðŸ”§ å®žçŽ°åŠ¨æ€é”å®šæœºåˆ¶ï¼šåœ¨ä»»åŠ¡å®Œæˆå‰ä¸è§£é”æœåŠ¡å™¨\n+    this.scheduleServerUnlockCheck()\n   }\n \n-  // ðŸ”§ å¼ºåˆ¶è§£é”æœåŠ¡å™¨\n-  forceUnlockServer(windowId) {\n-    this.unlockServer(windowId)\n-    console.log(`ðŸ”“ [${windowId}] å¼ºåˆ¶è§£é”æœåŠ¡å™¨`)\n+  unlockServerForWindow() {\n+    const currentLock = this.getWindowServerLock()\n+    if (currentLock) {\n+      const lockDuration = Date.now() - currentLock.timestamp\n+      console.log(`ðŸ”“ [${WINDOW_ID}] è§£é”æœåŠ¡å™¨: ${currentLock.server}`)\n+      console.log(`â±ï¸ [${WINDOW_ID}] é”å®šæŒç»­æ—¶é—´: ${Math.round(lockDuration / 1000)}ç§’`)\n+      console.log(`ðŸ“Š [${WINDOW_ID}] è§£é”æ—¶ä»»åŠ¡æ•°: ${this.windowTasks.size}`)\n+      console.log(`ðŸªŸ [${WINDOW_ID}] çª—å£éš”ç¦»: ä»…è§£é”å½“å‰çª—å£ï¼Œä¸å½±å“å…¶ä»–çª—å£`)\n+\n+      this.clearWindowServerLock()\n+\n+      // æ¸…ç†è§£é”æ£€æŸ¥å®šæ—¶å™¨\n+      this.clearServerUnlockTimer()\n+    }\n   }\n \n-  // ðŸ”§ æ›´æ–°ä»»åŠ¡è®¡æ•°\n-  updateTaskCount(windowId, taskCount) {\n-    const lock = this.getServerLock(windowId)\n-    if (lock) {\n-      lock.taskCount = taskCount\n-      console.log(`ðŸ“Š [${windowId}] æ›´æ–°ä»»åŠ¡è®¡æ•°: ${taskCount}`)\n+  // ðŸ”§ å¼ºåˆ¶è§£é”æœåŠ¡å™¨ï¼ˆç”¨äºŽå¼‚å¸¸æƒ…å†µå¤„ç†ï¼‰\n+  forceUnlockServerForWindow() {\n+    const currentLock = this.getWindowServerLock()\n+    if (currentLock) {\n+      console.log(`ðŸš¨ [${WINDOW_ID}] å¼ºåˆ¶è§£é”æœåŠ¡å™¨: ${currentLock.server}`)\n+      console.log(`âš ï¸ [${WINDOW_ID}] å½“å‰ä»æœ‰ ${this.windowTasks.size} ä¸ªå¾…å¤„ç†ä»»åŠ¡`)\n+      console.log(`ðŸªŸ [${WINDOW_ID}] çª—å£éš”ç¦»: å¼ºåˆ¶è§£é”ä»…å½±å“å½“å‰çª—å£`)\n+      this.unlockServerForWindow()\n+      return true\n     }\n+    return false\n   }\n \n-  // ðŸ”§ é‡ç½®æœåŠ¡å™¨è¿žæŽ¥\n-  async resetServer(windowId, force = false) {\n-    console.log(`ðŸ”„ [${windowId}] é‡ç½®WebSocketæœåŠ¡å™¨ (å¼ºåˆ¶: ${force})`)\n+  // ðŸ”§ çª—å£çº§åˆ«çš„ä»»åŠ¡ç®¡ç†å‡½æ•° - å®Œå…¨éš”ç¦»ç‰ˆæœ¬\n+  registerWindowTask(promptId, task) {\n+    let currentLock = this.getWindowServerLock()\n \n-    // æ–­å¼€çŽ°æœ‰è¿žæŽ¥\n-    await this.disconnect(windowId)\n+    // ðŸ”§ æ™ºèƒ½éªŒè¯ï¼šå¦‚æžœæœåŠ¡å™¨æœªé”å®šï¼Œè‡ªåŠ¨é”å®šåˆ°å½“å‰APIæœåŠ¡å™¨\n+    if (!currentLock || !currentLock.server) {\n+      console.warn(`âš ï¸ [${WINDOW_ID}] æ³¨å†Œä»»åŠ¡æ—¶æœåŠ¡å™¨æœªé”å®šï¼Œå°è¯•è‡ªåŠ¨é”å®š...`)\n+      try {\n+        // ä½¿ç”¨å½“å‰ä»»åŠ¡çš„æ‰§è¡ŒæœåŠ¡å™¨æˆ–é»˜è®¤APIæœåŠ¡å™¨\n+        const serverToLock = task.executionServer || this._getDefaultServerUrl()\n+        this.lockServerForWindow(serverToLock)\n+        currentLock = this.getWindowServerLock()\n+        console.log(`ðŸ”’ [${WINDOW_ID}] è‡ªåŠ¨é”å®šæœåŠ¡å™¨: ${serverToLock}`)\n+      } catch (lockError) {\n+        console.error(`âŒ [${WINDOW_ID}] è‡ªåŠ¨é”å®šå¤±è´¥: ${lockError.message}`)\n+        // ç»§ç»­æ‰§è¡Œï¼Œä½†è®°å½•è­¦å‘Š\n+        console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡ ${promptId} å°†åœ¨æ— é”å®šçŠ¶æ€ä¸‹æ³¨å†Œ`)\n+      }\n+    }\n \n-    // æ¸…ç†æœåŠ¡å™¨é”å®š\n-    if (force) {\n-      this.forceUnlockServer(windowId)\n+    // ðŸ”§ æ™ºèƒ½ç»‘å®šæœåŠ¡å™¨ï¼šä¼˜å…ˆä½¿ç”¨é”å®šæœåŠ¡å™¨ï¼Œå¦åˆ™ä½¿ç”¨ä»»åŠ¡è‡ªå¸¦çš„æœåŠ¡å™¨\n+    if (currentLock && currentLock.server) {\n+      task.executionServer = currentLock.server\n+    } else if (!task.executionServer) {\n+      // å¦‚æžœéƒ½æ²¡æœ‰ï¼Œä½¿ç”¨é»˜è®¤é…ç½®\n+      task.executionServer = this._getDefaultServerUrl()\n+      console.warn(`âš ï¸ [${WINDOW_ID}] ä½¿ç”¨é»˜è®¤æœåŠ¡å™¨ç»‘å®šä»»åŠ¡: ${task.executionServer}`)\n     }\n \n-    console.log(`âœ… [${windowId}] WebSocketæœåŠ¡å™¨é‡ç½®å®Œæˆ`)\n-    return true\n-  }\n+    task.windowId = WINDOW_ID\n+    task.clientId = WINDOW_CLIENT_ID\n+    task.registeredAt = Date.now()\n+    task.lockInfo = currentLock ? { ...currentLock } : null // ä¿å­˜é”å®šä¿¡æ¯å¿«ç…§\n \n-  // ðŸ”§ è°ƒåº¦è§£é”æ£€æŸ¥\n-  scheduleUnlockCheck(windowId) {\n-    this.clearUnlockTimer(windowId)\n+    this.windowTasks.set(promptId, task)\n \n-    const timer = setInterval(() => {\n-      this.checkUnlockCondition(windowId)\n-    }, 30000) // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡\n+    console.log(`ðŸ“ [${WINDOW_ID}] ä»»åŠ¡å·²æ³¨å†Œ: ${promptId}, ç»‘å®šæœåŠ¡å™¨: ${task.executionServer}`)\n+    console.log(`ðŸ“Š [${WINDOW_ID}] å½“å‰çª—å£ä»»åŠ¡æ•°: ${this.windowTasks.size}`)\n+    console.log(`ðŸ”’ [${WINDOW_ID}] ä»»åŠ¡é”å®šä¿¡æ¯:`, task.lockInfo)\n \n-    this.unlockTimers.set(windowId, timer)\n-    console.log(`â° [${windowId}] å·²è°ƒåº¦è§£é”æ£€æŸ¥`)\n+    // ðŸ”§ é”å®šç»­æœŸï¼šæ£€æµ‹åˆ°æ–°ä»»åŠ¡æ—¶è‡ªåŠ¨ç»­æœŸé”å®šçŠ¶æ€\n+    if (currentLock) {\n+      console.log(`ðŸ”„ [${WINDOW_ID}] æ£€æµ‹åˆ°æ–°ä»»åŠ¡ï¼Œç»­æœŸæœåŠ¡å™¨é”å®šçŠ¶æ€`)\n+      // é‡æ–°è°ƒåº¦è§£é”æ£€æŸ¥\n+      this.scheduleServerUnlockCheck()\n+    }\n   }\n \n-  // ðŸ”§ æ¸…ç†è§£é”å®šæ—¶å™¨\n-  clearUnlockTimer(windowId) {\n-    const timer = this.unlockTimers.get(windowId)\n-    if (timer) {\n-      clearInterval(timer)\n-      this.unlockTimers.delete(windowId)\n-      console.log(`ðŸ§¹ [${windowId}] å·²æ¸…ç†è§£é”å®šæ—¶å™¨`)\n+  getWindowTask(promptId) {\n+    const task = this.windowTasks.get(promptId)\n+    if (task) {\n+      // ðŸ”§ ç®€åŒ–æ£€æµ‹ï¼šå¦‚æžœä»»åŠ¡å­˜åœ¨å°±è¿”å›žï¼Œä¸ä¸¥æ ¼æ£€æŸ¥çª—å£å½’å±ž\n+      // è¿™æ ·å¯ä»¥é¿å…å› çª—å£IDä¸åŒ¹é…å¯¼è‡´çš„ä»»åŠ¡ä¸¢å¤±\n+      if (task.windowId !== WINDOW_ID) {\n+        console.log(`ðŸ” [${WINDOW_ID}] ä½¿ç”¨å…¶ä»–çª—å£çš„ä»»åŠ¡: ${promptId} (åŽŸçª—å£: ${task.windowId})`)\n+      }\n+      return task\n     }\n+\n+    return null\n   }\n \n-  // ðŸ”§ æ£€æŸ¥è§£é”æ¡ä»¶ï¼ˆéœ€è¦å¤–éƒ¨æä¾›ä»»åŠ¡è®¡æ•°ï¼‰\n-  checkUnlockCondition(windowId, taskCount = 0) {\n-    const lock = this.getServerLock(windowId)\n-    if (!lock) {\n-      this.clearUnlockTimer(windowId)\n-      return false\n-    }\n+  removeWindowTask(promptId) {\n+    const task = this.windowTasks.get(promptId)\n+    if (task && task.windowId === WINDOW_ID) {\n+      this.windowTasks.delete(promptId)\n+      console.log(`ðŸ—‘ï¸ [${WINDOW_ID}] ä»»åŠ¡å·²ç§»é™¤: ${promptId}`)\n+      console.log(`ðŸ“Š [${WINDOW_ID}] å‰©ä½™çª—å£ä»»åŠ¡æ•°: ${this.windowTasks.size}`)\n \n-    if (taskCount === 0) {\n-      console.log(`ðŸ”“ [${windowId}] æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œè‡ªåŠ¨è§£é”æœåŠ¡å™¨`)\n-      this.unlockServer(windowId)\n+      // ðŸ”§ ä»»åŠ¡ç§»é™¤åŽç«‹å³æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n+      const currentLock = this.getWindowServerLock()\n+      if (this.windowTasks.size === 0 && currentLock) {\n+        console.log(`ðŸ”“ [${WINDOW_ID}] æœ€åŽä¸€ä¸ªä»»åŠ¡å®Œæˆï¼Œç«‹å³è§£é”æœåŠ¡å™¨`)\n+        this.unlockServerForWindow()\n+      } else if (this.windowTasks.size > 0) {\n+        console.log(`ðŸ”’ [${WINDOW_ID}] ä»æœ‰ä»»åŠ¡è¿è¡Œï¼Œä¿æŒæœåŠ¡å™¨é”å®š`)\n+      }\n+\n       return true\n     }\n-\n-    console.log(`ðŸ”’ [${windowId}] ä»æœ‰ ${taskCount} ä¸ªä»»åŠ¡ï¼Œä¿æŒé”å®š`)\n     return false\n   }\n \n-  // ðŸ”§ èŽ·å–æ‰€æœ‰è¿žæŽ¥çŠ¶æ€\n-  getAllConnectionStatus() {\n-    const status = {}\n-    this.connections.forEach((info, windowId) => {\n-      status[windowId] = {\n-        isConnected: info.isConnected,\n-        server: info.server,\n-        clientId: info.clientId,\n-        connectedAt: info.connectedAt,\n-        lock: this.getServerLock(windowId)\n+  // ðŸ”§ æ–°å¢žï¼šæ ¹æ®ä»»åŠ¡IDèŽ·å–ç»‘å®šçš„æœåŠ¡å™¨åœ°å€\n+  getTaskBoundServer(promptId) {\n+    const task = this.getWindowTask(promptId)\n+    if (task && task.executionServer) {\n+      console.log(`ðŸŽ¯ [${WINDOW_ID}] ä»»åŠ¡ ${promptId} ç»‘å®šæœåŠ¡å™¨: ${task.executionServer}`)\n+      return task.executionServer\n+    }\n+    console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡ ${promptId} æœªæ‰¾åˆ°ç»‘å®šæœåŠ¡å™¨`)\n+    return null\n+  }\n+\n+  // ðŸ”§ çª—å£é—´é€šä¿¡æœºåˆ¶ï¼ˆç”¨äºŽè°ƒè¯•å’Œç›‘æŽ§ï¼‰\n+  broadcastTaskStatus(promptId, status) {\n+    try {\n+      const message = {\n+        type: 'task_status',\n+        windowId: WINDOW_ID,\n+        clientId: WINDOW_CLIENT_ID,\n+        promptId: promptId,\n+        status: status,\n+        timestamp: Date.now()\n       }\n-    })\n-    return status\n+\n+      localStorage.setItem(`comfyui_task_${promptId}`, JSON.stringify(message))\n+      console.log(`ðŸ“¡ [${WINDOW_ID}] å¹¿æ’­ä»»åŠ¡çŠ¶æ€: ${promptId} -> ${status}`)\n+    } catch (error) {\n+      console.warn(`âš ï¸ [${WINDOW_ID}] å¹¿æ’­ä»»åŠ¡çŠ¶æ€å¤±è´¥:`, error)\n+    }\n   }\n \n-  // ðŸ”§ æ¸…ç†æ‰€æœ‰è¿žæŽ¥\n-  async cleanup() {\n-    console.log('ðŸ§¹ æ¸…ç†æ‰€æœ‰WebSocketè¿žæŽ¥')\n+  // ðŸ”§ åŽŸå­æ€§ä»»åŠ¡çŠ¶æ€æ›´æ–°å‡½æ•° - çª—å£éš”ç¦»ç‰ˆæœ¬\n+  updateTaskStatus(promptId, newStatus, additionalData = {}) {\n+    // ðŸ”§ åªå¤„ç†å±žäºŽå½“å‰çª—å£çš„ä»»åŠ¡\n+    const task = this.getWindowTask(promptId)\n+    if (!task) {\n+      console.warn(`âš ï¸ [${WINDOW_ID}] å°è¯•æ›´æ–°ä¸å­˜åœ¨æˆ–ä¸å±žäºŽå½“å‰çª—å£çš„ä»»åŠ¡çŠ¶æ€: ${promptId}`)\n+      return false\n+    }\n \n-    // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨\n-    this.unlockTimers.forEach((timer, windowId) => {\n-      clearInterval(timer)\n-    })\n-    this.unlockTimers.clear()\n+    const oldStatus = task.status\n+    task.status = newStatus\n+    task.lastStatusUpdate = Date.now()\n \n-    // æ–­å¼€æ‰€æœ‰è¿žæŽ¥\n-    const disconnectPromises = Array.from(this.connections.keys()).map(windowId =>\n-      this.disconnect(windowId)\n-    )\n+    // åˆå¹¶é¢å¤–æ•°æ®\n+    Object.assign(task, additionalData)\n \n-    await Promise.all(disconnectPromises)\n+    console.log(`ðŸ”„ [${WINDOW_ID}] ä»»åŠ¡çŠ¶æ€å˜æ›´: ${promptId} ${oldStatus} â†’ ${newStatus}`)\n \n-    // æ¸…ç†æ‰€æœ‰æ•°æ®\n-    this.connections.clear()\n-    this.serverLocks.clear()\n-    this.messageHandlers.clear()\n+    // ðŸ”§ å¹¿æ’­ä»»åŠ¡çŠ¶æ€å˜æ›´\n+    this.broadcastTaskStatus(promptId, newStatus)\n \n-    console.log('âœ… WebSocketç®¡ç†å™¨æ¸…ç†å®Œæˆ')\n+    return true\n   }\n+\n+  // ðŸ”§ èŽ·å–é»˜è®¤æœåŠ¡å™¨URLçš„è¾…åŠ©æ–¹æ³•\n+  _getDefaultServerUrl() {\n+    // è¿™é‡Œéœ€è¦ä»Žé…ç½®ä¸­èŽ·å–ï¼Œæš‚æ—¶è¿”å›žä¸€ä¸ªé»˜è®¤å€¼\n+    // åœ¨å®žé™…ä½¿ç”¨æ—¶ä¼šé€šè¿‡ä¾èµ–æ³¨å…¥æˆ–é…ç½®ä¼ å…¥\n+    return 'http://localhost:8188'\n+  }\n }\n \n-// ðŸ”§ åˆ›å»ºå…¨å±€WebSocketç®¡ç†å™¨å®žä¾‹\n-const websocketManager = new WebSocketManager()\n+// åˆ›å»ºå…¨å±€å®žä¾‹\n+const webSocketManager = new WebSocketManager()\n \n-// ðŸ”§ å¯¼å‡ºç®¡ç†å™¨å®žä¾‹å’Œç›¸å…³å·¥å…·\n-export {\n-  websocketManager,\n-  WebSocketManager,\n-  generateClientId\n-}\n-\n-// ðŸ”§ åœ¨çª—å£å¸è½½æ—¶æ¸…ç†èµ„æº\n-if (typeof window !== 'undefined') {\n-  window.addEventListener('beforeunload', () => {\n-    websocketManager.cleanup()\n-  })\n-}\n+// å¯¼å‡ºå®žä¾‹å’Œç›¸å…³å¸¸é‡\n+export default webSocketManager\n+export { WINDOW_ID, WINDOW_CLIENT_ID }\n"
                },
                {
                    "date": 1753506336423,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -314,51 +314,8 @@\n     console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡ ${promptId} æœªæ‰¾åˆ°ç»‘å®šæœåŠ¡å™¨`)\n     return null\n   }\n \n-  // ðŸ”§ çª—å£é—´é€šä¿¡æœºåˆ¶ï¼ˆç”¨äºŽè°ƒè¯•å’Œç›‘æŽ§ï¼‰\n-  broadcastTaskStatus(promptId, status) {\n-    try {\n-      const message = {\n-        type: 'task_status',\n-        windowId: WINDOW_ID,\n-        clientId: WINDOW_CLIENT_ID,\n-        promptId: promptId,\n-        status: status,\n-        timestamp: Date.now()\n-      }\n-\n-      localStorage.setItem(`comfyui_task_${promptId}`, JSON.stringify(message))\n-      console.log(`ðŸ“¡ [${WINDOW_ID}] å¹¿æ’­ä»»åŠ¡çŠ¶æ€: ${promptId} -> ${status}`)\n-    } catch (error) {\n-      console.warn(`âš ï¸ [${WINDOW_ID}] å¹¿æ’­ä»»åŠ¡çŠ¶æ€å¤±è´¥:`, error)\n-    }\n-  }\n-\n-  // ðŸ”§ åŽŸå­æ€§ä»»åŠ¡çŠ¶æ€æ›´æ–°å‡½æ•° - çª—å£éš”ç¦»ç‰ˆæœ¬\n-  updateTaskStatus(promptId, newStatus, additionalData = {}) {\n-    // ðŸ”§ åªå¤„ç†å±žäºŽå½“å‰çª—å£çš„ä»»åŠ¡\n-    const task = this.getWindowTask(promptId)\n-    if (!task) {\n-      console.warn(`âš ï¸ [${WINDOW_ID}] å°è¯•æ›´æ–°ä¸å­˜åœ¨æˆ–ä¸å±žäºŽå½“å‰çª—å£çš„ä»»åŠ¡çŠ¶æ€: ${promptId}`)\n-      return false\n-    }\n-\n-    const oldStatus = task.status\n-    task.status = newStatus\n-    task.lastStatusUpdate = Date.now()\n-\n-    // åˆå¹¶é¢å¤–æ•°æ®\n-    Object.assign(task, additionalData)\n-\n-    console.log(`ðŸ”„ [${WINDOW_ID}] ä»»åŠ¡çŠ¶æ€å˜æ›´: ${promptId} ${oldStatus} â†’ ${newStatus}`)\n-\n-    // ðŸ”§ å¹¿æ’­ä»»åŠ¡çŠ¶æ€å˜æ›´\n-    this.broadcastTaskStatus(promptId, newStatus)\n-\n-    return true\n-  }\n-\n   // ðŸ”§ èŽ·å–é»˜è®¤æœåŠ¡å™¨URLçš„è¾…åŠ©æ–¹æ³•\n   _getDefaultServerUrl() {\n     // è¿™é‡Œéœ€è¦ä»Žé…ç½®ä¸­èŽ·å–ï¼Œæš‚æ—¶è¿”å›žä¸€ä¸ªé»˜è®¤å€¼\n     // åœ¨å®žé™…ä½¿ç”¨æ—¶ä¼šé€šè¿‡ä¾èµ–æ³¨å…¥æˆ–é…ç½®ä¼ å…¥\n"
                },
                {
                    "date": 1753506503049,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -320,8 +320,122 @@\n     // è¿™é‡Œéœ€è¦ä»Žé…ç½®ä¸­èŽ·å–ï¼Œæš‚æ—¶è¿”å›žä¸€ä¸ªé»˜è®¤å€¼\n     // åœ¨å®žé™…ä½¿ç”¨æ—¶ä¼šé€šè¿‡ä¾èµ–æ³¨å…¥æˆ–é…ç½®ä¼ å…¥\n     return 'http://localhost:8188'\n   }\n+\n+  // ðŸ”§ çª—å£é—´é€šä¿¡æœºåˆ¶ï¼ˆç”¨äºŽè°ƒè¯•å’Œç›‘æŽ§ï¼‰\n+  broadcastTaskStatus(promptId, status) {\n+    try {\n+      const message = {\n+        type: 'task_status',\n+        windowId: WINDOW_ID,\n+        clientId: WINDOW_CLIENT_ID,\n+        promptId: promptId,\n+        status: status,\n+        timestamp: Date.now()\n+      }\n+\n+      localStorage.setItem(`comfyui_task_${promptId}`, JSON.stringify(message))\n+      console.log(`ðŸ“¡ [${WINDOW_ID}] å¹¿æ’­ä»»åŠ¡çŠ¶æ€: ${promptId} -> ${status}`)\n+    } catch (error) {\n+      console.warn(`âš ï¸ [${WINDOW_ID}] å¹¿æ’­ä»»åŠ¡çŠ¶æ€å¤±è´¥:`, error)\n+    }\n+  }\n+\n+  // ðŸ”§ åŽŸå­æ€§ä»»åŠ¡çŠ¶æ€æ›´æ–°å‡½æ•° - çª—å£éš”ç¦»ç‰ˆæœ¬\n+  updateTaskStatus(promptId, newStatus, additionalData = {}) {\n+    // ðŸ”§ åªå¤„ç†å±žäºŽå½“å‰çª—å£çš„ä»»åŠ¡\n+    const task = this.getWindowTask(promptId)\n+    if (!task) {\n+      console.warn(`âš ï¸ [${WINDOW_ID}] å°è¯•æ›´æ–°ä¸å­˜åœ¨æˆ–ä¸å±žäºŽå½“å‰çª—å£çš„ä»»åŠ¡çŠ¶æ€: ${promptId}`)\n+      return false\n+    }\n+\n+    const oldStatus = task.status\n+    task.status = newStatus\n+    task.lastStatusUpdate = Date.now()\n+\n+    // åˆå¹¶é¢å¤–æ•°æ®\n+    Object.assign(task, additionalData)\n+\n+    console.log(`ðŸ”„ [${WINDOW_ID}] ä»»åŠ¡çŠ¶æ€å˜æ›´: ${promptId} ${oldStatus} â†’ ${newStatus}`)\n+\n+    // ðŸ”§ å¹¿æ’­ä»»åŠ¡çŠ¶æ€å˜æ›´\n+    this.broadcastTaskStatus(promptId, newStatus)\n+\n+    return true\n+  }\n+\n+  // ðŸ”§ åŠ¨æ€è§£é”æ£€æŸ¥æœºåˆ¶\n+  // ðŸ”§ è°ƒåº¦æœåŠ¡å™¨è§£é”æ£€æŸ¥ï¼ˆå®šæœŸæ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼‰\n+  scheduleServerUnlockCheck() {\n+    // æ¸…ç†ä¹‹å‰çš„å®šæ—¶å™¨\n+    this.clearServerUnlockTimer()\n+\n+    // è®¾ç½®å®šæœŸæ£€æŸ¥ï¼ˆæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰\n+    this.serverUnlockTimer = setInterval(() => {\n+      this.checkServerUnlockCondition()\n+    }, 30000)\n+\n+    console.log(`â° [${WINDOW_ID}] å·²è°ƒåº¦åŠ¨æ€è§£é”æ£€æŸ¥ï¼ˆæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰`)\n+  }\n+\n+  // ðŸ”§ æ¸…ç†è§£é”æ£€æŸ¥å®šæ—¶å™¨\n+  clearServerUnlockTimer() {\n+    if (this.serverUnlockTimer) {\n+      clearInterval(this.serverUnlockTimer)\n+      this.serverUnlockTimer = null\n+      console.log(`ðŸ§¹ [${WINDOW_ID}] å·²æ¸…ç†è§£é”æ£€æŸ¥å®šæ—¶å™¨`)\n+    }\n+  }\n+\n+  // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨çš„å‡½æ•°ï¼ˆå¢žå¼ºç‰ˆæœ¬ï¼‰\n+  checkServerUnlockCondition() {\n+    const currentLock = this.getWindowServerLock()\n+    if (!currentLock) {\n+      // æœåŠ¡å™¨æœªé”å®šï¼Œæ¸…ç†å®šæ—¶å™¨\n+      this.clearServerUnlockTimer()\n+      return false\n+    }\n+\n+    const taskCount = this.windowTasks.size\n+    const lockDuration = Date.now() - currentLock.timestamp\n+\n+    console.log(`ðŸ” [${WINDOW_ID}] è§£é”æ¡ä»¶æ£€æŸ¥:`)\n+    console.log(`   - å¾…å¤„ç†ä»»åŠ¡æ•°: ${taskCount}`)\n+    console.log(`   - é”å®šæŒç»­æ—¶é—´: ${Math.round(lockDuration / 1000)}ç§’`)\n+    console.log(`   - é”å®šæœåŠ¡å™¨: ${currentLock.server}`)\n+\n+    if (taskCount === 0) {\n+      console.log(`ðŸ”“ [${WINDOW_ID}] æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼Œè‡ªåŠ¨è§£é”æœåŠ¡å™¨`)\n+      this.unlockServerForWindow()\n+      return true\n+    } else {\n+      console.log(`ðŸ”’ [${WINDOW_ID}] ä»æœ‰ ${taskCount} ä¸ªå¾…å¤„ç†ä»»åŠ¡ï¼Œä¿æŒæœåŠ¡å™¨é”å®š`)\n+\n+      // åˆ—å‡ºå¾…å¤„ç†ä»»åŠ¡\n+      const taskIds = Array.from(this.windowTasks.keys())\n+      console.log(`ðŸ“‹ [${WINDOW_ID}] å¾…å¤„ç†ä»»åŠ¡: [${taskIds.join(', ')}]`)\n+\n+      // æ£€æŸ¥æ˜¯å¦æœ‰é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡\n+      const longRunningTasks = []\n+      this.windowTasks.forEach((task, promptId) => {\n+        const taskDuration = Date.now() - (task.registeredAt || currentLock.timestamp)\n+        if (taskDuration > 10 * 60 * 1000) { // è¶…è¿‡10åˆ†é’Ÿ\n+          longRunningTasks.push({ promptId, duration: Math.round(taskDuration / 1000) })\n+        }\n+      })\n+\n+      if (longRunningTasks.length > 0) {\n+        console.log(`âš ï¸ [${WINDOW_ID}] æ£€æµ‹åˆ°é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡:`)\n+        longRunningTasks.forEach(({ promptId, duration }) => {\n+          console.log(`   - ${promptId}: ${duration}ç§’`)\n+        })\n+      }\n+    }\n+\n+    return false\n+  }\n }\n \n // åˆ›å»ºå…¨å±€å®žä¾‹\n const webSocketManager = new WebSocketManager()\n"
                },
                {
                    "date": 1753506710142,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -434,12 +434,205 @@\n     }\n \n     return false\n   }\n+\n+  // ðŸ”§ æ–°å¢žï¼šç¡®ä¿WebSocketè¿žæŽ¥ä¸Žä»»åŠ¡æ‰§è¡ŒæœåŠ¡å™¨ä¸€è‡´æ€§\n+  async ensureWebSocketServerConsistency(taskServer) {\n+    try {\n+      console.log(`ðŸ” [${WINDOW_ID}] æ£€æŸ¥WebSocketæœåŠ¡å™¨ä¸€è‡´æ€§...`)\n+      console.log(`ðŸŽ¯ [${WINDOW_ID}] ä»»åŠ¡æ‰§è¡ŒæœåŠ¡å™¨: ${taskServer}`)\n+\n+      const currentLock = this.getWindowServerLock()\n+      const lockedServer = currentLock?.server\n+      const wsServer = this.currentWebSocketServer\n+\n+      console.log(`ðŸ”’ [${WINDOW_ID}] å½“å‰é”å®šæœåŠ¡å™¨: ${lockedServer}`)\n+      console.log(`ðŸ”— [${WINDOW_ID}] WebSocketè¿žæŽ¥æœåŠ¡å™¨: ${wsServer}`)\n+\n+      // æ£€æŸ¥æ‰€æœ‰æœåŠ¡å™¨æ˜¯å¦ä¸€è‡´\n+      const serversMatch = taskServer === lockedServer && taskServer === wsServer\n+\n+      if (serversMatch && this.wsConnection && this.wsConnection.readyState === WebSocket.OPEN) {\n+        console.log(`âœ… [${WINDOW_ID}] æœåŠ¡å™¨ä¸€è‡´æ€§éªŒè¯é€šè¿‡`)\n+        return true\n+      }\n+\n+      // æœåŠ¡å™¨ä¸ä¸€è‡´ï¼Œéœ€è¦é‡æ–°å»ºç«‹è¿žæŽ¥\n+      console.log(`ðŸ”„ [${WINDOW_ID}] æœåŠ¡å™¨ä¸ä¸€è‡´ï¼Œé‡æ–°å»ºç«‹WebSocketè¿žæŽ¥`)\n+      console.log(`   ä»»åŠ¡æœåŠ¡å™¨: ${taskServer}`)\n+      console.log(`   é”å®šæœåŠ¡å™¨: ${lockedServer}`)\n+      console.log(`   WebSocketæœåŠ¡å™¨: ${wsServer}`)\n+\n+      // å…³é—­çŽ°æœ‰è¿žæŽ¥\n+      if (this.wsConnection) {\n+        this.wsConnection.close(1000, 'æœåŠ¡å™¨ä¸ä¸€è‡´ï¼Œé‡æ–°è¿žæŽ¥')\n+        this.wsConnection = null\n+        this.isWsConnected = false\n+      }\n+\n+      // é‡æ–°åˆå§‹åŒ–WebSocketè¿žæŽ¥åˆ°æ­£ç¡®çš„æœåŠ¡å™¨\n+      await this.initializeWebSocket(taskServer)\n+\n+      console.log(`âœ… [${WINDOW_ID}] WebSocketé‡æ–°è¿žæŽ¥åˆ°æ­£ç¡®æœåŠ¡å™¨: ${taskServer}`)\n+      return true\n+\n+    } catch (error) {\n+      console.error(`âŒ [${WINDOW_ID}] WebSocketæœåŠ¡å™¨ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥:`, error)\n+      throw error\n+    }\n+  }\n+\n+  // ðŸ”§ æ–°å¢žï¼šç¡®ä¿WebSocketè¿žæŽ¥ - é‡æž„ç‰ˆæœ¬ï¼ˆæ”¯æŒä»»åŠ¡-æœåŠ¡å™¨ç»‘å®šä¸€è‡´æ€§ï¼‰\n+  async ensureWebSocketConnection(taskServer = null) {\n+    console.log(`ðŸ”Œ [${WINDOW_ID}] ç¡®ä¿WebSocketè¿žæŽ¥`)\n+\n+    if (taskServer) {\n+      console.log(`ðŸŽ¯ [${WINDOW_ID}] æŒ‡å®šä»»åŠ¡æœåŠ¡å™¨: ${taskServer}`)\n+\n+      // ðŸ”§ å…³é”®ä¿®å¤ï¼šå¦‚æžœæŒ‡å®šäº†ä»»åŠ¡æœåŠ¡å™¨ï¼Œç¡®ä¿WebSocketè¿žæŽ¥åˆ°æ­£ç¡®æœåŠ¡å™¨\n+      await this.ensureWebSocketServerConsistency(taskServer)\n+      return true\n+    }\n+\n+    // å¦‚æžœå·²è¿žæŽ¥ï¼Œæ£€æŸ¥æœåŠ¡å™¨ä¸€è‡´æ€§\n+    if (this.wsConnection && this.wsConnection.readyState === WebSocket.OPEN && this.isWsConnected) {\n+      console.log(`âœ… [${WINDOW_ID}] WebSocketå·²è¿žæŽ¥`)\n+\n+      // å°è¯•é”å®šæœåŠ¡å™¨ï¼Œä½†å¤±è´¥ä¸å½±å“ç»§ç»­ä½¿ç”¨\n+      const currentLock = this.getWindowServerLock()\n+      if (!currentLock) {\n+        try {\n+          // è¿™é‡Œéœ€è¦å¤–éƒ¨æä¾› getApiBaseUrl å‡½æ•°\n+          console.log(`ðŸ”’ [${WINDOW_ID}] éœ€è¦è¡¥å……é”å®šæœåŠ¡å™¨ï¼Œä½†ç¼ºå°‘ getApiBaseUrl å‡½æ•°`)\n+        } catch (error) {\n+          console.warn(`âš ï¸ [${WINDOW_ID}] æœåŠ¡å™¨é”å®šå¤±è´¥ï¼Œä½†ç»§ç»­ä½¿ç”¨è¿žæŽ¥:`, error.message)\n+        }\n+      } else {\n+        console.log(`ðŸ”’ [${WINDOW_ID}] æœåŠ¡å™¨å·²é”å®š: ${currentLock.server}`)\n+\n+        // ðŸ”§ éªŒè¯WebSocketè¿žæŽ¥ä¸Žé”å®šæœåŠ¡å™¨çš„ä¸€è‡´æ€§\n+        const wsServer = this.currentWebSocketServer\n+        if (wsServer && wsServer !== currentLock.server) {\n+          console.log(`ðŸ”„ [${WINDOW_ID}] WebSocketæœåŠ¡å™¨ä¸Žé”å®šæœåŠ¡å™¨ä¸ä¸€è‡´ï¼Œé‡æ–°è¿žæŽ¥`)\n+          console.log(`   WebSocketæœåŠ¡å™¨: ${wsServer}`)\n+          console.log(`   é”å®šæœåŠ¡å™¨: ${currentLock.server}`)\n+\n+          // é‡æ–°è¿žæŽ¥åˆ°é”å®šçš„æœåŠ¡å™¨\n+          await this.initializeWebSocket(currentLock.server)\n+        }\n+      }\n+      return true\n+    }\n+\n+    // éœ€è¦å»ºç«‹æ–°è¿žæŽ¥\n+    console.log(`ðŸ”„ [${WINDOW_ID}] å»ºç«‹æ–°çš„WebSocketè¿žæŽ¥`)\n+\n+    try {\n+      await this.initializeWebSocket()\n+\n+      // ç»™è¿žæŽ¥ä¸€äº›æ—¶é—´ç¨³å®š\n+      await new Promise(resolve => setTimeout(resolve, 500))\n+\n+      if (!this.isWsConnected) {\n+        console.warn(`âš ï¸ [${WINDOW_ID}] WebSocketè¿žæŽ¥çŠ¶æ€å¼‚å¸¸ï¼Œä½†å°è¯•ç»§ç»­`)\n+      }\n+\n+      console.log(`âœ… [${WINDOW_ID}] WebSocketè¿žæŽ¥å®Œæˆ`)\n+      return true\n+\n+    } catch (error) {\n+      console.warn(`âš ï¸ [${WINDOW_ID}] WebSocketè¿žæŽ¥å¤±è´¥ï¼Œä½†ä¸é˜»æ­¢æ“ä½œ:`, error.message)\n+      // ðŸ”§ å…³é”®æ”¹è¿›ï¼šä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸é™çº§ä½¿ç”¨\n+      return false\n+    }\n+  }\n+\n+  // ðŸ”§ æ–°å¢žï¼šæ‰‹åŠ¨é‡ç½®WebSocketæœåŠ¡å™¨é”å®šçš„åŠŸèƒ½\n+  resetWebSocketServer(force = false) {\n+    const currentLock = this.getWindowServerLock()\n+    console.log('ðŸ”„ æ‰‹åŠ¨é‡ç½®WebSocketæœåŠ¡å™¨é”å®š')\n+    console.log('ðŸ”“ æ¸…é™¤æœåŠ¡å™¨é”å®š:', currentLock?.server || 'æ— ')\n+\n+    if (!force && this.windowTasks.size > 0) {\n+      console.log(`âš ï¸ æœ‰ ${this.windowTasks.size} ä¸ªå¾…å¤„ç†ä»»åŠ¡ï¼Œå»ºè®®ç­‰å¾…å®ŒæˆåŽå†é‡ç½®`)\n+      console.log('ðŸ’¡ å¦‚éœ€å¼ºåˆ¶é‡ç½®ï¼Œè¯·è°ƒç”¨: resetWebSocketServer(true)')\n+      return false\n+    }\n+\n+    // æ¸…é™¤æœåŠ¡å™¨é”å®š\n+    this.unlockServerForWindow()\n+\n+    // å…³é—­çŽ°æœ‰WebSocketè¿žæŽ¥\n+    if (this.wsConnection) {\n+      console.log('ðŸ”Œ å…³é—­çŽ°æœ‰WebSocketè¿žæŽ¥')\n+      this.wsConnection.close(1000, 'æ‰‹åŠ¨é‡ç½®æœåŠ¡å™¨')\n+      this.wsConnection = null\n+      this.isWsConnected = false\n+    }\n+\n+    // æ¸…ç†æ‰€æœ‰å¾…å¤„ç†ä»»åŠ¡ï¼ˆå¦‚æžœå¼ºåˆ¶é‡ç½®ï¼‰\n+    if (force && this.windowTasks.size > 0) {\n+      console.log(`ðŸ§¹ å¼ºåˆ¶æ¸…ç† ${this.windowTasks.size} ä¸ªå¾…å¤„ç†ä»»åŠ¡`)\n+      const taskIds = Array.from(this.windowTasks.keys())\n+      for (const promptId of taskIds) {\n+        const task = this.windowTasks.get(promptId)\n+        if (task && task.onError) {\n+          task.onError('WebSocketæœåŠ¡å™¨å·²å¼ºåˆ¶é‡ç½®')\n+        }\n+        this.windowTasks.delete(promptId)\n+      }\n+    }\n+\n+    console.log('âœ… WebSocketæœåŠ¡å™¨é‡ç½®å®Œæˆ')\n+    return true\n+  }\n+\n+  // ðŸ”§ æ–°å¢žï¼šèŽ·å–å½“å‰WebSocketæœåŠ¡å™¨çŠ¶æ€çš„å‡½æ•°ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n+  getWebSocketServerStatus() {\n+    return {\n+      windowId: WINDOW_ID,\n+      clientId: WINDOW_CLIENT_ID,\n+      isConnected: this.isWsConnected,\n+      lockedServer: this.getWindowServerLock()?.server,\n+      lockTimestamp: this.getWindowServerLock()?.timestamp,\n+      lockDuration: this.getWindowServerLock()?.timestamp ? Date.now() - this.getWindowServerLock().timestamp : null,\n+      pendingTasksCount: this.windowTasks.size,\n+      connectionState: this.wsConnection?.readyState || 'CLOSED'\n+    }\n+  }\n }\n \n+// ç›‘å¬å…¶ä»–çª—å£çš„ä»»åŠ¡çŠ¶æ€ï¼ˆç”¨äºŽè°ƒè¯•ï¼‰\n+if (typeof window !== 'undefined') {\n+  window.addEventListener('storage', (e) => {\n+    if (e.key && e.key.startsWith('comfyui_task_')) {\n+      try {\n+        const message = JSON.parse(e.newValue)\n+        if (message.windowId !== WINDOW_ID) {\n+          console.log(`ðŸ“¡ [${WINDOW_ID}] æ”¶åˆ°å…¶ä»–çª—å£ä»»åŠ¡çŠ¶æ€: ${message.promptId} -> ${message.status} (æ¥è‡ªçª—å£: ${message.windowId})`)\n+        }\n+      } catch (error) {\n+        // å¿½ç•¥è§£æžé”™è¯¯\n+      }\n+    }\n+  })\n+}\n+\n // åˆ›å»ºå…¨å±€å®žä¾‹\n const webSocketManager = new WebSocketManager()\n \n+// ðŸ”§ æš´éœ²æ ¸å¿ƒç®¡ç†å‡½æ•°åˆ°å…¨å±€ï¼Œç”¨äºŽæ•…éšœæ¢å¤\n+if (typeof window !== 'undefined') {\n+  window.resetWebSocketServer = webSocketManager.resetWebSocketServer.bind(webSocketManager)\n+  window.getWebSocketServerStatus = webSocketManager.getWebSocketServerStatus.bind(webSocketManager)\n+  window.pendingTasks = webSocketManager.windowTasks // ðŸ”§ æš´éœ²çª—å£çº§åˆ«çš„ä»»åŠ¡é˜Ÿåˆ—\n+\n+  // ðŸ”§ åŠ¨æ€é”å®šç®¡ç†å‡½æ•°\n+  window.forceUnlockServerForWindow = webSocketManager.forceUnlockServerForWindow.bind(webSocketManager)\n+\n+  console.log(`ðŸ”§ [${WINDOW_ID}] æ ¸å¿ƒç®¡ç†å‡½æ•°å·²æš´éœ²åˆ°å…¨å±€`)\n+}\n+\n // å¯¼å‡ºå®žä¾‹å’Œç›¸å…³å¸¸é‡\n export default webSocketManager\n export { WINDOW_ID, WINDOW_CLIENT_ID }\n"
                },
                {
                    "date": 1753509561038,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -62,8 +62,174 @@\n     this._initializeWindowEvents()\n     this._initializeGlobalProperties()\n   }\n \n+  // ==================== WebSocket è¿žæŽ¥ç®¡ç†æ–¹æ³• ====================\n+\n+  // ðŸ”§ åˆå§‹åŒ– WebSocket è¿žæŽ¥ - é‡æž„ç‰ˆæœ¬ï¼ˆè§£å†³å¤šæœåŠ¡å™¨æ¶ˆæ¯è·¯ç”±é”™ä¹±ï¼‰\n+  async initializeWebSocket(targetServer = null) {\n+    try {\n+      // ðŸ”§ å…³é”®ä¿®å¤ï¼šæ”¯æŒæŒ‡å®šç›®æ ‡æœåŠ¡å™¨ï¼Œç¡®ä¿ä»»åŠ¡-æœåŠ¡å™¨ç»‘å®šä¸€è‡´æ€§\n+      let baseUrl\n+      const currentLock = this.getWindowServerLock()\n+\n+      if (targetServer) {\n+        // å¦‚æžœæŒ‡å®šäº†ç›®æ ‡æœåŠ¡å™¨ï¼Œç›´æŽ¥ä½¿ç”¨\n+        baseUrl = targetServer\n+        console.log(`ðŸŽ¯ [${WINDOW_ID}] ä½¿ç”¨æŒ‡å®šçš„ç›®æ ‡æœåŠ¡å™¨: ${baseUrl}`)\n+      } else if (currentLock && currentLock.server) {\n+        // å¦‚æžœå½“å‰çª—å£å·²é”å®šæœåŠ¡å™¨ï¼Œä½¿ç”¨é”å®šçš„æœåŠ¡å™¨\n+        baseUrl = currentLock.server\n+        console.log(`ðŸ”’ [${WINDOW_ID}] ä½¿ç”¨çª—å£é”å®šçš„æœåŠ¡å™¨: ${baseUrl}`)\n+      } else {\n+        // å¦åˆ™ä»Žè´Ÿè½½å‡è¡¡å™¨èŽ·å–å¯ç”¨æœåŠ¡å™¨\n+        try {\n+          baseUrl = await loadBalancer.getAvailableServer()\n+          if (!baseUrl) {\n+            throw new Error('è´Ÿè½½å‡è¡¡å™¨è¿”å›žç©ºæœåŠ¡å™¨')\n+          }\n+          console.log(`âš–ï¸ [${WINDOW_ID}] ä»Žè´Ÿè½½å‡è¡¡å™¨èŽ·å–æœåŠ¡å™¨: ${baseUrl}`)\n+        } catch (lbError) {\n+          console.error('âŒ è´Ÿè½½å‡è¡¡å™¨é”™è¯¯:', lbError.message)\n+          throw new Error(`æ— æ³•èŽ·å–å¯ç”¨çš„ComfyUIæœåŠ¡å™¨: ${lbError.message}`)\n+        }\n+      }\n+\n+      // ðŸ”§ æ£€æŸ¥çŽ°æœ‰è¿žæŽ¥æ˜¯å¦ä¸Žç›®æ ‡æœåŠ¡å™¨ä¸€è‡´\n+      if (this.wsConnection && this.wsConnection.readyState === WebSocket.OPEN) {\n+        const currentWsServer = this.currentWebSocketServer || this.getWindowServerLock()?.server\n+        if (currentWsServer === baseUrl) {\n+          console.log(`âœ… [${WINDOW_ID}] WebSocketå·²è¿žæŽ¥åˆ°æ­£ç¡®æœåŠ¡å™¨: ${baseUrl}`)\n+          return true\n+        } else {\n+          console.log(`ðŸ”„ [${WINDOW_ID}] WebSocketæœåŠ¡å™¨ä¸åŒ¹é…ï¼Œéœ€è¦é‡è¿ž`)\n+          console.log(`   å½“å‰è¿žæŽ¥: ${currentWsServer}`)\n+          console.log(`   ç›®æ ‡æœåŠ¡å™¨: ${baseUrl}`)\n+          // å…³é—­çŽ°æœ‰è¿žæŽ¥ï¼Œå»ºç«‹æ–°è¿žæŽ¥\n+          this.wsConnection.close(1000, 'åˆ‡æ¢åˆ°æ­£ç¡®çš„æœåŠ¡å™¨')\n+          this.wsConnection = null\n+          this.isWsConnected = false\n+        }\n+      }\n+\n+      console.log(`ðŸ”Œ [${WINDOW_ID}] è¿žæŽ¥WebSocket: ${baseUrl}`)\n+\n+      // ðŸ”§ æž„å»ºWebSocket URL - ä½¿ç”¨å¢žå¼ºçš„å”¯ä¸€clientId\n+      let wsUrl\n+      if (baseUrl.startsWith('https://')) {\n+        wsUrl = baseUrl.replace('https://', 'wss://') + '/ws?clientId=' + WINDOW_CLIENT_ID\n+      } else {\n+        wsUrl = baseUrl.replace('http://', 'ws://') + '/ws?clientId=' + WINDOW_CLIENT_ID\n+      }\n+\n+      console.log(`ðŸ”— [${WINDOW_ID}] WebSocket URL: ${wsUrl}`)\n+      console.log(`ðŸ”‘ [${WINDOW_ID}] ä½¿ç”¨å¢žå¼ºclientId: ${WINDOW_CLIENT_ID}`)\n+\n+      // ç®€å•çš„HTTPè¿žæŽ¥æµ‹è¯•\n+      try {\n+        const testResponse = await fetch(`${baseUrl}/api/queue`, {\n+          method: 'GET',\n+          signal: AbortSignal.timeout(5000)\n+        })\n+        if (!testResponse.ok) {\n+          throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${testResponse.status}`)\n+        }\n+      } catch (httpError) {\n+        throw new Error(`ComfyUIæœåŠ¡å™¨ä¸å¯è¾¾: ${httpError.message}`)\n+      }\n+\n+      // ðŸ”§ è®°å½•å³å°†è¿žæŽ¥çš„æœåŠ¡å™¨ï¼Œç”¨äºŽåŽç»­éªŒè¯\n+      this.currentWebSocketServer = baseUrl\n+      this.wsConnection = new WebSocket(wsUrl)\n+\n+      return new Promise((resolve, reject) => {\n+        const timeout = setTimeout(() => {\n+          reject(new Error('WebSocket è¿žæŽ¥è¶…æ—¶'))\n+        }, 10000)\n+\n+        this.wsConnection.onopen = () => {\n+          this.isWsConnected = true\n+          clearTimeout(timeout)\n+          this._showNotification(`[${WINDOW_ID}] WebSocketè¿žæŽ¥æˆåŠŸ`, 'success')\n+          this._logServerConsistency('WebSocketè¿žæŽ¥æˆåŠŸ')\n+          resolve(true)\n+        }\n+\n+        this.wsConnection.onerror = (error) => {\n+          this.isWsConnected = false\n+          clearTimeout(timeout)\n+          console.error('âŒ WebSocketè¿žæŽ¥é”™è¯¯:', error)\n+          reject(new Error('WebSocketè¿žæŽ¥å¤±è´¥'))\n+        }\n+\n+        this.wsConnection.onclose = (event) => {\n+          this.isWsConnected = false\n+          console.log(`ðŸ”Œ [${WINDOW_ID}] WebSocketè¿žæŽ¥å…³é—­: ${event.code} - ${event.reason}`)\n+\n+          // ðŸ”§ å¦‚æžœä¸æ˜¯æ­£å¸¸å…³é—­ï¼Œå°è¯•é‡è¿ž\n+          if (event.code !== 1000 && event.code !== 1001) {\n+            console.log(`ðŸ”„ [${WINDOW_ID}] éžæ­£å¸¸å…³é—­ï¼Œå‡†å¤‡é‡è¿ž...`)\n+            setTimeout(() => {\n+              if (!this.isWsConnected) {\n+                console.log(`ðŸ”„ [${WINDOW_ID}] æ‰§è¡ŒWebSocketé‡è¿ž`)\n+                this.initializeWebSocket(baseUrl).catch(error => {\n+                  console.error('âŒ WebSocketé‡è¿žå¤±è´¥:', error)\n+                })\n+              }\n+            }, 3000)\n+          }\n+        }\n+\n+        this.wsConnection.onmessage = (event) => {\n+          try {\n+            const message = event.data\n+\n+            // ðŸ”§ å¢žå¼ºæ¶ˆæ¯è¿‡æ»¤ï¼šåªå¤„ç†å½“å‰çª—å£çš„æ¶ˆæ¯\n+            if (typeof message === 'object' && message.windowId && message.windowId !== WINDOW_ID) {\n+              console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„æ¶ˆæ¯: ${message.windowId}`)\n+              return\n+            }\n+\n+            // å®˜æ–¹æ ‡å‡†ï¼šåªå¤„ç†å­—ç¬¦ä¸²æ¶ˆæ¯\n+            if (typeof message === 'string') {\n+              try {\n+                const parsedMessage = JSON.parse(message)\n+\n+                // è°ƒç”¨é‡æž„åŽçš„æ¶ˆæ¯å¤„ç†å‡½æ•°\n+                this.handleWebSocketMessage(parsedMessage)\n+              } catch (parseError) {\n+                console.error('âŒ [OFFICIAL] JSONè§£æžå¤±è´¥:', parseError.message)\n+              }\n+            }\n+\n+          } catch (error) {\n+            console.error('âŒ [OFFICIAL] WebSocketæ¶ˆæ¯å¤„ç†å¤±è´¥:', error)\n+          }\n+        }\n+      })\n+    } catch (error) {\n+      console.error('âŒ åˆå§‹åŒ– WebSocket å¤±è´¥:', error)\n+\n+      // ðŸ”§ æ ¹æ®é”™è¯¯ç±»åž‹å†³å®šæ˜¯å¦æ¸…é™¤æœåŠ¡å™¨é”å®š\n+      if (error.message.includes('è´Ÿè½½å‡è¡¡å™¨') || error.message.includes('æ— æ³•èŽ·å–å¯ç”¨çš„ComfyUIæœåŠ¡å™¨')) {\n+        // å¦‚æžœæ˜¯è´Ÿè½½å‡è¡¡å™¨é”™è¯¯ï¼Œæ¸…é™¤æœåŠ¡å™¨é”å®š\n+        this.currentWebSocketServer = null\n+        this.clearWindowServerLock()\n+        console.log('ðŸ”“ è´Ÿè½½å‡è¡¡å™¨é”™è¯¯ï¼Œæ¸…é™¤æœåŠ¡å™¨é”å®š')\n+      } else if (error.message.includes('ComfyUIæœåŠ¡å™¨ä¸å¯è¾¾') || error.message.includes('WebSocket è¿žæŽ¥è¶…æ—¶')) {\n+        // å¦‚æžœæ˜¯è¿žæŽ¥é”™è¯¯ä½†æœåŠ¡å™¨å¯èƒ½æ¢å¤ï¼Œä¿æŒé”å®šä»¥ä¾¿é‡è¯•\n+        console.log('ðŸ”’ è¿žæŽ¥é”™è¯¯ä½†ä¿æŒæœåŠ¡å™¨é”å®šä»¥ä¾¿é‡è¯•')\n+      } else {\n+        // å…¶ä»–æœªçŸ¥é”™è¯¯ï¼Œæ¸…é™¤é”å®š\n+        this.currentWebSocketServer = null\n+        this.clearWindowServerLock()\n+        console.log('ðŸ”“ æœªçŸ¥é”™è¯¯ï¼Œæ¸…é™¤æœåŠ¡å™¨é”å®š')\n+      }\n+\n+      throw error\n+    }\n+  }\n+\n   // ðŸ”§ çª—å£å…³é—­æ—¶çš„æ¸…ç†æœºåˆ¶\n   _initializeWindowEvents() {\n     window.addEventListener('beforeunload', () => {\n       console.log(`ðŸšª [${WINDOW_ID}] çª—å£å³å°†å…³é—­ï¼Œæ‰§è¡Œæ¸…ç†...`)\n"
                },
                {
                    "date": 1753509611155,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -62,174 +62,8 @@\n     this._initializeWindowEvents()\n     this._initializeGlobalProperties()\n   }\n \n-  // ==================== WebSocket è¿žæŽ¥ç®¡ç†æ–¹æ³• ====================\n-\n-  // ðŸ”§ åˆå§‹åŒ– WebSocket è¿žæŽ¥ - é‡æž„ç‰ˆæœ¬ï¼ˆè§£å†³å¤šæœåŠ¡å™¨æ¶ˆæ¯è·¯ç”±é”™ä¹±ï¼‰\n-  async initializeWebSocket(targetServer = null) {\n-    try {\n-      // ðŸ”§ å…³é”®ä¿®å¤ï¼šæ”¯æŒæŒ‡å®šç›®æ ‡æœåŠ¡å™¨ï¼Œç¡®ä¿ä»»åŠ¡-æœåŠ¡å™¨ç»‘å®šä¸€è‡´æ€§\n-      let baseUrl\n-      const currentLock = this.getWindowServerLock()\n-\n-      if (targetServer) {\n-        // å¦‚æžœæŒ‡å®šäº†ç›®æ ‡æœåŠ¡å™¨ï¼Œç›´æŽ¥ä½¿ç”¨\n-        baseUrl = targetServer\n-        console.log(`ðŸŽ¯ [${WINDOW_ID}] ä½¿ç”¨æŒ‡å®šçš„ç›®æ ‡æœåŠ¡å™¨: ${baseUrl}`)\n-      } else if (currentLock && currentLock.server) {\n-        // å¦‚æžœå½“å‰çª—å£å·²é”å®šæœåŠ¡å™¨ï¼Œä½¿ç”¨é”å®šçš„æœåŠ¡å™¨\n-        baseUrl = currentLock.server\n-        console.log(`ðŸ”’ [${WINDOW_ID}] ä½¿ç”¨çª—å£é”å®šçš„æœåŠ¡å™¨: ${baseUrl}`)\n-      } else {\n-        // å¦åˆ™ä»Žè´Ÿè½½å‡è¡¡å™¨èŽ·å–å¯ç”¨æœåŠ¡å™¨\n-        try {\n-          baseUrl = await loadBalancer.getAvailableServer()\n-          if (!baseUrl) {\n-            throw new Error('è´Ÿè½½å‡è¡¡å™¨è¿”å›žç©ºæœåŠ¡å™¨')\n-          }\n-          console.log(`âš–ï¸ [${WINDOW_ID}] ä»Žè´Ÿè½½å‡è¡¡å™¨èŽ·å–æœåŠ¡å™¨: ${baseUrl}`)\n-        } catch (lbError) {\n-          console.error('âŒ è´Ÿè½½å‡è¡¡å™¨é”™è¯¯:', lbError.message)\n-          throw new Error(`æ— æ³•èŽ·å–å¯ç”¨çš„ComfyUIæœåŠ¡å™¨: ${lbError.message}`)\n-        }\n-      }\n-\n-      // ðŸ”§ æ£€æŸ¥çŽ°æœ‰è¿žæŽ¥æ˜¯å¦ä¸Žç›®æ ‡æœåŠ¡å™¨ä¸€è‡´\n-      if (this.wsConnection && this.wsConnection.readyState === WebSocket.OPEN) {\n-        const currentWsServer = this.currentWebSocketServer || this.getWindowServerLock()?.server\n-        if (currentWsServer === baseUrl) {\n-          console.log(`âœ… [${WINDOW_ID}] WebSocketå·²è¿žæŽ¥åˆ°æ­£ç¡®æœåŠ¡å™¨: ${baseUrl}`)\n-          return true\n-        } else {\n-          console.log(`ðŸ”„ [${WINDOW_ID}] WebSocketæœåŠ¡å™¨ä¸åŒ¹é…ï¼Œéœ€è¦é‡è¿ž`)\n-          console.log(`   å½“å‰è¿žæŽ¥: ${currentWsServer}`)\n-          console.log(`   ç›®æ ‡æœåŠ¡å™¨: ${baseUrl}`)\n-          // å…³é—­çŽ°æœ‰è¿žæŽ¥ï¼Œå»ºç«‹æ–°è¿žæŽ¥\n-          this.wsConnection.close(1000, 'åˆ‡æ¢åˆ°æ­£ç¡®çš„æœåŠ¡å™¨')\n-          this.wsConnection = null\n-          this.isWsConnected = false\n-        }\n-      }\n-\n-      console.log(`ðŸ”Œ [${WINDOW_ID}] è¿žæŽ¥WebSocket: ${baseUrl}`)\n-\n-      // ðŸ”§ æž„å»ºWebSocket URL - ä½¿ç”¨å¢žå¼ºçš„å”¯ä¸€clientId\n-      let wsUrl\n-      if (baseUrl.startsWith('https://')) {\n-        wsUrl = baseUrl.replace('https://', 'wss://') + '/ws?clientId=' + WINDOW_CLIENT_ID\n-      } else {\n-        wsUrl = baseUrl.replace('http://', 'ws://') + '/ws?clientId=' + WINDOW_CLIENT_ID\n-      }\n-\n-      console.log(`ðŸ”— [${WINDOW_ID}] WebSocket URL: ${wsUrl}`)\n-      console.log(`ðŸ”‘ [${WINDOW_ID}] ä½¿ç”¨å¢žå¼ºclientId: ${WINDOW_CLIENT_ID}`)\n-\n-      // ç®€å•çš„HTTPè¿žæŽ¥æµ‹è¯•\n-      try {\n-        const testResponse = await fetch(`${baseUrl}/api/queue`, {\n-          method: 'GET',\n-          signal: AbortSignal.timeout(5000)\n-        })\n-        if (!testResponse.ok) {\n-          throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${testResponse.status}`)\n-        }\n-      } catch (httpError) {\n-        throw new Error(`ComfyUIæœåŠ¡å™¨ä¸å¯è¾¾: ${httpError.message}`)\n-      }\n-\n-      // ðŸ”§ è®°å½•å³å°†è¿žæŽ¥çš„æœåŠ¡å™¨ï¼Œç”¨äºŽåŽç»­éªŒè¯\n-      this.currentWebSocketServer = baseUrl\n-      this.wsConnection = new WebSocket(wsUrl)\n-\n-      return new Promise((resolve, reject) => {\n-        const timeout = setTimeout(() => {\n-          reject(new Error('WebSocket è¿žæŽ¥è¶…æ—¶'))\n-        }, 10000)\n-\n-        this.wsConnection.onopen = () => {\n-          this.isWsConnected = true\n-          clearTimeout(timeout)\n-          this._showNotification(`[${WINDOW_ID}] WebSocketè¿žæŽ¥æˆåŠŸ`, 'success')\n-          this._logServerConsistency('WebSocketè¿žæŽ¥æˆåŠŸ')\n-          resolve(true)\n-        }\n-\n-        this.wsConnection.onerror = (error) => {\n-          this.isWsConnected = false\n-          clearTimeout(timeout)\n-          console.error('âŒ WebSocketè¿žæŽ¥é”™è¯¯:', error)\n-          reject(new Error('WebSocketè¿žæŽ¥å¤±è´¥'))\n-        }\n-\n-        this.wsConnection.onclose = (event) => {\n-          this.isWsConnected = false\n-          console.log(`ðŸ”Œ [${WINDOW_ID}] WebSocketè¿žæŽ¥å…³é—­: ${event.code} - ${event.reason}`)\n-\n-          // ðŸ”§ å¦‚æžœä¸æ˜¯æ­£å¸¸å…³é—­ï¼Œå°è¯•é‡è¿ž\n-          if (event.code !== 1000 && event.code !== 1001) {\n-            console.log(`ðŸ”„ [${WINDOW_ID}] éžæ­£å¸¸å…³é—­ï¼Œå‡†å¤‡é‡è¿ž...`)\n-            setTimeout(() => {\n-              if (!this.isWsConnected) {\n-                console.log(`ðŸ”„ [${WINDOW_ID}] æ‰§è¡ŒWebSocketé‡è¿ž`)\n-                this.initializeWebSocket(baseUrl).catch(error => {\n-                  console.error('âŒ WebSocketé‡è¿žå¤±è´¥:', error)\n-                })\n-              }\n-            }, 3000)\n-          }\n-        }\n-\n-        this.wsConnection.onmessage = (event) => {\n-          try {\n-            const message = event.data\n-\n-            // ðŸ”§ å¢žå¼ºæ¶ˆæ¯è¿‡æ»¤ï¼šåªå¤„ç†å½“å‰çª—å£çš„æ¶ˆæ¯\n-            if (typeof message === 'object' && message.windowId && message.windowId !== WINDOW_ID) {\n-              console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„æ¶ˆæ¯: ${message.windowId}`)\n-              return\n-            }\n-\n-            // å®˜æ–¹æ ‡å‡†ï¼šåªå¤„ç†å­—ç¬¦ä¸²æ¶ˆæ¯\n-            if (typeof message === 'string') {\n-              try {\n-                const parsedMessage = JSON.parse(message)\n-\n-                // è°ƒç”¨é‡æž„åŽçš„æ¶ˆæ¯å¤„ç†å‡½æ•°\n-                this.handleWebSocketMessage(parsedMessage)\n-              } catch (parseError) {\n-                console.error('âŒ [OFFICIAL] JSONè§£æžå¤±è´¥:', parseError.message)\n-              }\n-            }\n-\n-          } catch (error) {\n-            console.error('âŒ [OFFICIAL] WebSocketæ¶ˆæ¯å¤„ç†å¤±è´¥:', error)\n-          }\n-        }\n-      })\n-    } catch (error) {\n-      console.error('âŒ åˆå§‹åŒ– WebSocket å¤±è´¥:', error)\n-\n-      // ðŸ”§ æ ¹æ®é”™è¯¯ç±»åž‹å†³å®šæ˜¯å¦æ¸…é™¤æœåŠ¡å™¨é”å®š\n-      if (error.message.includes('è´Ÿè½½å‡è¡¡å™¨') || error.message.includes('æ— æ³•èŽ·å–å¯ç”¨çš„ComfyUIæœåŠ¡å™¨')) {\n-        // å¦‚æžœæ˜¯è´Ÿè½½å‡è¡¡å™¨é”™è¯¯ï¼Œæ¸…é™¤æœåŠ¡å™¨é”å®š\n-        this.currentWebSocketServer = null\n-        this.clearWindowServerLock()\n-        console.log('ðŸ”“ è´Ÿè½½å‡è¡¡å™¨é”™è¯¯ï¼Œæ¸…é™¤æœåŠ¡å™¨é”å®š')\n-      } else if (error.message.includes('ComfyUIæœåŠ¡å™¨ä¸å¯è¾¾') || error.message.includes('WebSocket è¿žæŽ¥è¶…æ—¶')) {\n-        // å¦‚æžœæ˜¯è¿žæŽ¥é”™è¯¯ä½†æœåŠ¡å™¨å¯èƒ½æ¢å¤ï¼Œä¿æŒé”å®šä»¥ä¾¿é‡è¯•\n-        console.log('ðŸ”’ è¿žæŽ¥é”™è¯¯ä½†ä¿æŒæœåŠ¡å™¨é”å®šä»¥ä¾¿é‡è¯•')\n-      } else {\n-        // å…¶ä»–æœªçŸ¥é”™è¯¯ï¼Œæ¸…é™¤é”å®š\n-        this.currentWebSocketServer = null\n-        this.clearWindowServerLock()\n-        console.log('ðŸ”“ æœªçŸ¥é”™è¯¯ï¼Œæ¸…é™¤æœåŠ¡å™¨é”å®š')\n-      }\n-\n-      throw error\n-    }\n-  }\n-\n   // ðŸ”§ çª—å£å…³é—­æ—¶çš„æ¸…ç†æœºåˆ¶\n   _initializeWindowEvents() {\n     window.addEventListener('beforeunload', () => {\n       console.log(`ðŸšª [${WINDOW_ID}] çª—å£å³å°†å…³é—­ï¼Œæ‰§è¡Œæ¸…ç†...`)\n@@ -765,10 +599,194 @@\n       pendingTasksCount: this.windowTasks.size,\n       connectionState: this.wsConnection?.readyState || 'CLOSED'\n     }\n   }\n-}\n \n+  // ==================== WebSocket æ¶ˆæ¯å¤„ç†æ–¹æ³• ====================\n+\n+  // ðŸ”¥ é˜²æŠ–æœºåˆ¶ï¼šé¿å…é¢‘ç¹çš„è¿›åº¦å›žè°ƒè§¦å‘é€’å½’æ›´æ–°\n+  safeProgressCallback(promptId, task, message, percent) {\n+    if (!task.onProgress) return\n+\n+    // é˜²æŠ–ï¼šåŒä¸€ä»»åŠ¡çš„è¿›åº¦å›žè°ƒé—´éš”è‡³å°‘100ms\n+    const lastCallTime = this.progressCallbackDebounce.get(promptId) || 0\n+    const now = Date.now()\n+\n+    if (now - lastCallTime < 100) {\n+      console.log(`ðŸš« [${WINDOW_ID}] è¿›åº¦å›žè°ƒé˜²æŠ–: ${promptId} (${percent}%)`)\n+      return\n+    }\n+\n+    this.progressCallbackDebounce.set(promptId, now)\n+\n+    try {\n+      // ðŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿å›žè°ƒåœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªçŽ¯ä¸­æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n+      setTimeout(() => {\n+        task.onProgress(message, percent)\n+      }, 0)\n+    } catch (error) {\n+      console.error(`âŒ [${WINDOW_ID}] è¿›åº¦å›žè°ƒæ‰§è¡Œå¤±è´¥: ${promptId}`, error.message)\n+    }\n+  }\n+\n+  // ðŸ”¥ ä¸»è¦çš„WebSocketæ¶ˆæ¯å¤„ç†å‡½æ•° - é‡æž„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n+  handleWebSocketMessage(message) {\n+    try {\n+      const { type, data } = message\n+\n+      // ðŸ”¥ ç®€åŒ–æ¶ˆæ¯è¿‡æ»¤ï¼šå¦‚æžœæ‰¾åˆ°ä»»åŠ¡å°±å¤„ç†ï¼Œä¸ä¸¥æ ¼é™åˆ¶çª—å£å½’å±ž\n+      if (data && data.prompt_id) {\n+        const task = this.getWindowTask(data.prompt_id)\n+        if (!task) {\n+          // ä»»åŠ¡ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯å…¶ä»–çª—å£çš„æ¶ˆæ¯ï¼Œé™é»˜å¿½ç•¥\n+          return\n+        }\n+\n+        // ðŸ”¥ éªŒè¯æ¶ˆæ¯æ¥æºæœåŠ¡å™¨ä¸€è‡´æ€§\n+        const currentLock = this.getWindowServerLock()\n+        if (currentLock && task.executionServer && task.executionServer !== currentLock.server) {\n+          console.warn(`âš ï¸ [${WINDOW_ID}] è·¨æœåŠ¡å™¨æ¶ˆæ¯æ£€æµ‹: ä»»åŠ¡åœ¨ ${task.executionServer}, å½“å‰é”å®š ${currentLock.server}`)\n+          // ä»ç„¶å¤„ç†æ¶ˆæ¯ï¼Œä½†è®°å½•è­¦å‘Šä»¥ä¾¿è°ƒè¯•\n+        }\n+\n+        // ðŸ”¥ è®°å½•æ¶ˆæ¯å¤„ç†æ—¥å¿—ï¼ˆç”¨äºŽè·¨æœåŠ¡å™¨è°ƒè¯•ï¼‰\n+        console.log(`ðŸ“¨ [${WINDOW_ID}] å¤„ç†æ¶ˆæ¯: ${type} (prompt_id: ${data.prompt_id}, æœåŠ¡å™¨: ${task.executionServer || 'æœªçŸ¥'})`)\n+      }\n+\n+      // ðŸ”¥ è®°å½•æ‰€æœ‰æ¶ˆæ¯ç±»åž‹ç”¨äºŽè°ƒè¯•\n+      if (type !== 'status') {\n+        console.log(`ðŸ“¨ [OFFICIAL] æ”¶åˆ°æ¶ˆæ¯: ${type}`, data)\n+      }\n+\n+      // æ ¹æ®å®˜æ–¹WebSocket APIæ–‡æ¡£å¤„ç†æ‰€æœ‰æ ‡å‡†æ¶ˆæ¯ç±»åž‹\n+      switch (type) {\n+        case 'status':\n+          // æœåŠ¡å™¨çŠ¶æ€å’Œé˜Ÿåˆ—ä¿¡æ¯\n+          this.handleStatusMessage(data)\n+          break\n+\n+        case 'execution_start':\n+          // ä»»åŠ¡å¼€å§‹æ‰§è¡Œ - å®˜æ–¹æ ‡å‡†çŠ¶æ€æ£€æµ‹\n+          this.handleExecutionStartMessage(data)\n+          break\n+\n+        case 'executing':\n+          // èŠ‚ç‚¹æ‰§è¡ŒçŠ¶æ€ - å®˜æ–¹æ ‡å‡†å®Œæˆæ£€æµ‹\n+          this.handleExecutingMessage(data)\n+          break\n+\n+        case 'progress':\n+          // èŠ‚ç‚¹æ‰§è¡Œè¿›åº¦\n+          this.handleProgressMessage(data)\n+          break\n+\n+        case 'executed':\n+          // èŠ‚ç‚¹æ‰§è¡Œå®Œæˆ\n+          this.handleExecutedMessage(data)\n+          break\n+\n+        case 'execution_cached':\n+          // èŠ‚ç‚¹ç¼“å­˜å‘½ä¸­\n+          this.handleExecutionCachedMessage(data)\n+          break\n+\n+        case 'execution_error':\n+          // æ‰§è¡Œé”™è¯¯\n+          this.handleExecutionErrorMessage(data)\n+          break\n+\n+        case 'execution_interrupted':\n+          // æ‰§è¡Œä¸­æ–­\n+          this.handleExecutionInterruptedMessage(data)\n+          break\n+\n+        default:\n+          // è®°å½•æœªçŸ¥æ¶ˆæ¯ç±»åž‹ç”¨äºŽè°ƒè¯•\n+          console.log(`ðŸ” [OFFICIAL] æœªçŸ¥æ¶ˆæ¯ç±»åž‹: ${type}`, data)\n+      }\n+\n+    } catch (error) {\n+      console.error('âŒ [OFFICIAL] æ¶ˆæ¯å¤„ç†å¤±è´¥:', error.message, message)\n+    }\n+  }\n+\n+  // ðŸ”¥ å¤„ç†æœåŠ¡å™¨çŠ¶æ€æ¶ˆæ¯ - é‡æž„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n+  handleStatusMessage(data) {\n+    if (!data || !data.status) {\n+      return\n+    }\n+\n+    // ðŸ”§ åªè®°å½•é˜Ÿåˆ—å˜åŒ–ï¼Œä¸å¤„ç†å…·ä½“ä»»åŠ¡ï¼ˆé¿å…è·¨çª—å£å¹²æ‰°ï¼‰\n+    const queueRunning = data.status.exec_info?.queue_remaining || 0\n+    if (queueRunning > 0) {\n+      console.log(`ðŸ“Š [${WINDOW_ID}] æœåŠ¡å™¨é˜Ÿåˆ—çŠ¶æ€: ${queueRunning} ä¸ªä»»åŠ¡ç­‰å¾…æ‰§è¡Œ`)\n+    }\n+\n+    // ðŸ”§ è§¦å‘çŠ¶æ€æ›´æ–°äº‹ä»¶ä¾›Vueç»„ä»¶ç›‘å¬\n+    if (typeof window !== 'undefined') {\n+      window.dispatchEvent(new CustomEvent('comfyui-queue-status', {\n+        detail: {\n+          queueRemaining: queueRunning,\n+          windowId: WINDOW_ID,\n+          timestamp: Date.now()\n+        }\n+      }))\n+    }\n+  }\n+\n+  // ðŸ”¥ å¤„ç†ä»»åŠ¡å¼€å§‹æ‰§è¡Œæ¶ˆæ¯ - é‡æž„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n+  handleExecutionStartMessage(data) {\n+    if (!data || !data.prompt_id) {\n+      return\n+    }\n+\n+    const promptId = data.prompt_id\n+\n+    // ðŸ”§ åªå¤„ç†å±žäºŽå½“å‰çª—å£çš„ä»»åŠ¡\n+    const task = this.getWindowTask(promptId)\n+    if (!task) {\n+      console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„æ‰§è¡Œå¼€å§‹æ¶ˆæ¯: ${promptId}`)\n+      return\n+    }\n+\n+    console.log(`ðŸš€ [${WINDOW_ID}] ä»»åŠ¡å¼€å§‹æ‰§è¡Œ: ${promptId}`)\n+\n+    // åŽŸå­æ€§çŠ¶æ€æ›´æ–°ï¼šwaiting â†’ executing\n+    this.updateTaskStatus(promptId, this.TASK_STATUS.EXECUTING, {\n+      executionStartTime: Date.now()\n+    })\n+\n+    // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n+    this.safeProgressCallback(promptId, task, 'ä»»åŠ¡å¼€å§‹æ‰§è¡Œ', 10)\n+  }\n+\n+  // ðŸ”¥ å¤„ç†èŠ‚ç‚¹æ‰§è¡Œè¿›åº¦æ¶ˆæ¯ - é‡æž„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n+  handleProgressMessage(data) {\n+    if (!data || !data.prompt_id || typeof data.value !== 'number' || typeof data.max !== 'number') {\n+      return\n+    }\n+\n+    const promptId = data.prompt_id\n+\n+    // ðŸ”§ åªå¤„ç†å±žäºŽå½“å‰çª—å£çš„ä»»åŠ¡\n+    const task = this.getWindowTask(promptId)\n+    if (!task || task.status !== this.TASK_STATUS.EXECUTING) {\n+      if (!task) {\n+        console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„è¿›åº¦æ¶ˆæ¯: ${promptId}`)\n+      }\n+      return\n+    }\n+\n+    // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”\n+    const percent = Math.round((data.value / data.max) * 100)\n+    const nodeInfo = data.node ? ` (èŠ‚ç‚¹: ${data.node})` : ''\n+\n+    console.log(`ðŸ“ˆ [${WINDOW_ID}] ä»»åŠ¡è¿›åº¦: ${promptId} - ${percent}%${nodeInfo}`)\n+\n+    // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n+    this.safeProgressCallback(promptId, task, `æ‰§è¡Œè¿›åº¦: ${percent}%${nodeInfo}`, Math.min(percent + 10, 90))\n+  }\n+\n // ç›‘å¬å…¶ä»–çª—å£çš„ä»»åŠ¡çŠ¶æ€ï¼ˆç”¨äºŽè°ƒè¯•ï¼‰\n if (typeof window !== 'undefined') {\n   window.addEventListener('storage', (e) => {\n     if (e.key && e.key.startsWith('comfyui_task_')) {\n"
                },
                {
                    "date": 1753509731590,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -785,8 +785,235 @@\n     // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n     this.safeProgressCallback(promptId, task, `æ‰§è¡Œè¿›åº¦: ${percent}%${nodeInfo}`, Math.min(percent + 10, 90))\n   }\n \n+  // ðŸ”¥ å¤„ç†èŠ‚ç‚¹æ‰§è¡Œå®Œæˆæ¶ˆæ¯ - é‡æž„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n+  handleExecutedMessage(data) {\n+    if (!data || !data.prompt_id || !data.node) {\n+      return\n+    }\n+\n+    const promptId = data.prompt_id\n+\n+    // ðŸ”§ åªå¤„ç†å±žäºŽå½“å‰çª—å£çš„ä»»åŠ¡\n+    const task = this.getWindowTask(promptId)\n+    if (!task || task.status !== this.TASK_STATUS.EXECUTING) {\n+      if (!task) {\n+        console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„èŠ‚ç‚¹å®Œæˆæ¶ˆæ¯: ${promptId}`)\n+      }\n+      return\n+    }\n+\n+    console.log(`âœ… [${WINDOW_ID}] èŠ‚ç‚¹å®Œæˆ: ${data.node} (ä»»åŠ¡: ${promptId})`)\n+\n+    // è®°å½•å®Œæˆçš„èŠ‚ç‚¹\n+    if (!task.completedNodes) {\n+      task.completedNodes = []\n+    }\n+    task.completedNodes.push(data.node)\n+\n+    // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n+    this.safeProgressCallback(promptId, task, `èŠ‚ç‚¹ ${data.node} å®Œæˆ`, 60)\n+  }\n+\n+  // ðŸ”¥ å¤„ç†èŠ‚ç‚¹æ‰§è¡ŒçŠ¶æ€æ¶ˆæ¯ - å®˜æ–¹æ ‡å‡†å®Œæˆæ£€æµ‹ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n+  handleExecutingMessage(data) {\n+    if (!data || !data.prompt_id) {\n+      return\n+    }\n+\n+    const promptId = data.prompt_id\n+\n+    // ðŸ”§ åªå¤„ç†å±žäºŽå½“å‰çª—å£çš„ä»»åŠ¡\n+    const task = this.getWindowTask(promptId)\n+    if (!task) {\n+      console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„æ‰§è¡ŒçŠ¶æ€æ¶ˆæ¯: ${promptId}`)\n+      return\n+    }\n+\n+    // å®˜æ–¹æ ‡å‡†åŒé‡æ¡ä»¶æ£€æµ‹ï¼šdata.node === null && data.prompt_id === promptId\n+    if (data.node === null && data.prompt_id === promptId) {\n+      console.log(`ðŸŽ¯ [${WINDOW_ID}] ä»»åŠ¡æ‰§è¡Œå®Œæˆ: ${promptId}`)\n+\n+      // åŽŸå­æ€§çŠ¶æ€æ›´æ–°ï¼šexecuting â†’ completed\n+      this.updateTaskStatus(promptId, this.TASK_STATUS.COMPLETED, {\n+        completionTime: Date.now()\n+      })\n+\n+      // ç«‹å³å¤„ç†ä»»åŠ¡å®Œæˆ\n+      this.handleTaskCompletion(promptId)\n+    } else if (data.node) {\n+      // è®°å½•æ­£åœ¨æ‰§è¡Œçš„èŠ‚ç‚¹\n+      console.log(`ðŸ”„ [${WINDOW_ID}] æ­£åœ¨æ‰§è¡ŒèŠ‚ç‚¹: ${data.node} (ä»»åŠ¡: ${promptId})`)\n+\n+      // æ›´æ–°ä»»åŠ¡çš„å½“å‰æ‰§è¡ŒèŠ‚ç‚¹\n+      if (task) {\n+        task.currentNode = data.node\n+        this.safeProgressCallback(promptId, task, `æ­£åœ¨æ‰§è¡ŒèŠ‚ç‚¹: ${data.node}`, 30)\n+      }\n+    }\n+  }\n+\n+  // ðŸ”¥ å¤„ç†ä»»åŠ¡å®Œæˆçš„æ ¸å¿ƒå‡½æ•° - é‡æž„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n+  handleTaskCompletion(promptId) {\n+    try {\n+      const task = this.getWindowTask(promptId)\n+      if (!task) {\n+        console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡å®Œæˆå¤„ç†å¤±è´¥: ä»»åŠ¡ä¸å­˜åœ¨ ${promptId}`)\n+        return\n+      }\n+\n+      console.log(`ðŸŽ‰ [${WINDOW_ID}] ä»»åŠ¡å®Œæˆå¤„ç†å¼€å§‹: ${promptId}`)\n+\n+      // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n+      this.safeProgressCallback(promptId, task, 'ä»»åŠ¡æ‰§è¡Œå®Œæˆ', 100)\n+\n+      // ç«‹å³æ¸…ç†ä»»åŠ¡\n+      this.removeWindowTask(promptId)\n+\n+      // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n+      this.checkServerUnlockCondition()\n+\n+      // è°ƒç”¨æˆåŠŸå›žè°ƒ\n+      if (task.onSuccess) {\n+        // ðŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿æˆåŠŸå›žè°ƒç«‹å³æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n+        setTimeout(() => {\n+          task.onSuccess(promptId)\n+        }, 0)\n+      }\n+\n+      console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡å®Œæˆå¤„ç†ç»“æŸ: ${promptId}`)\n+\n+    } catch (error) {\n+      console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡å®Œæˆå¤„ç†å¤±è´¥: ${promptId}`, error.message)\n+\n+      // ç«‹å³æ¸…ç†ä»»åŠ¡å¹¶è°ƒç”¨é”™è¯¯å›žè°ƒ\n+      this.removeWindowTask(promptId)\n+\n+      // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n+      this.checkServerUnlockCondition()\n+\n+      if (task.onError) {\n+        // ðŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿é”™è¯¯å›žè°ƒç«‹å³æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n+        setTimeout(() => {\n+          task.onError(error.message)\n+        }, 0)\n+      }\n+    }\n+  }\n+\n+  // ðŸ”¥ å¤„ç†èŠ‚ç‚¹ç¼“å­˜å‘½ä¸­æ¶ˆæ¯\n+  handleExecutionCachedMessage(data) {\n+    if (!data || !data.prompt_id) {\n+      return\n+    }\n+\n+    const promptId = data.prompt_id\n+    const task = this.getWindowTask(promptId)\n+    if (!task) {\n+      console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„ç¼“å­˜æ¶ˆæ¯: ${promptId}`)\n+      return\n+    }\n+\n+    console.log(`ðŸ’¾ [${WINDOW_ID}] èŠ‚ç‚¹ç¼“å­˜å‘½ä¸­: ${promptId}`)\n+    this.safeProgressCallback(promptId, task, 'ä½¿ç”¨ç¼“å­˜ç»“æžœ', 80)\n+  }\n+\n+  // ðŸ”¥ å¤„ç†æ‰§è¡Œé”™è¯¯æ¶ˆæ¯\n+  handleExecutionErrorMessage(data) {\n+    if (!data || !data.prompt_id) {\n+      return\n+    }\n+\n+    const promptId = data.prompt_id\n+    const task = this.getWindowTask(promptId)\n+    if (!task) {\n+      console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„é”™è¯¯æ¶ˆæ¯: ${promptId}`)\n+      return\n+    }\n+\n+    console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡æ‰§è¡Œé”™è¯¯: ${promptId}`, data)\n+\n+    // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºé”™è¯¯\n+    this.updateTaskStatus(promptId, this.TASK_STATUS.ERROR, {\n+      errorTime: Date.now(),\n+      errorData: data\n+    })\n+\n+    // æ¸…ç†ä»»åŠ¡å¹¶è°ƒç”¨é”™è¯¯å›žè°ƒ\n+    this.removeWindowTask(promptId)\n+    this.checkServerUnlockCondition()\n+\n+    if (task.onError) {\n+      setTimeout(() => {\n+        task.onError(data.exception_message || 'ä»»åŠ¡æ‰§è¡Œé”™è¯¯')\n+      }, 0)\n+    }\n+  }\n+\n+  // ðŸ”¥ å¤„ç†æ‰§è¡Œä¸­æ–­æ¶ˆæ¯\n+  handleExecutionInterruptedMessage(data) {\n+    if (!data || !data.prompt_id) {\n+      return\n+    }\n+\n+    const promptId = data.prompt_id\n+    const task = this.getWindowTask(promptId)\n+    if (!task) {\n+      console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„ä¸­æ–­æ¶ˆæ¯: ${promptId}`)\n+      return\n+    }\n+\n+    console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡æ‰§è¡Œä¸­æ–­: ${promptId}`)\n+\n+    // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºä¸­æ–­\n+    this.updateTaskStatus(promptId, this.TASK_STATUS.INTERRUPTED, {\n+      interruptTime: Date.now()\n+    })\n+\n+    // æ¸…ç†ä»»åŠ¡å¹¶è°ƒç”¨é”™è¯¯å›žè°ƒ\n+    this.removeWindowTask(promptId)\n+    this.checkServerUnlockCondition()\n+\n+    if (task.onError) {\n+      setTimeout(() => {\n+        task.onError('ä»»åŠ¡æ‰§è¡Œè¢«ä¸­æ–­')\n+      }, 0)\n+    }\n+  }\n+\n+  // ðŸ”§ è¾…åŠ©æ–¹æ³•ï¼šæ˜¾ç¤ºé€šçŸ¥\n+  _showNotification(message, type = 'info') {\n+    const timestamp = new Date().toLocaleTimeString()\n+    const typeEmoji = {\n+      'success': 'âœ…',\n+      'error': 'âŒ',\n+      'warning': 'âš ï¸',\n+      'info': 'â„¹ï¸'\n+    }\n+\n+    console.log(`${typeEmoji[type] || 'â„¹ï¸'} [${timestamp}] ${message}`)\n+\n+    // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ä¾›Vueç»„ä»¶ç›‘å¬\n+    if (typeof window !== 'undefined') {\n+      window.dispatchEvent(new CustomEvent('comfyui-status', {\n+        detail: { message, type, timestamp }\n+      }))\n+    }\n+  }\n+\n+  // ðŸ”§ è¾…åŠ©æ–¹æ³•ï¼šè®°å½•æœåŠ¡å™¨ä¸€è‡´æ€§ä¿¡æ¯\n+  _logServerConsistency(context) {\n+    const currentLock = this.getWindowServerLock()\n+    const wsServer = this.currentWebSocketServer\n+\n+    console.log(`ðŸ” [${WINDOW_ID}] æœåŠ¡å™¨ä¸€è‡´æ€§æ£€æŸ¥ (${context}):`)\n+    console.log(`   - é”å®šæœåŠ¡å™¨: ${currentLock?.server || 'æ— '}`)\n+    console.log(`   - WebSocketæœåŠ¡å™¨: ${wsServer || 'æ— '}`)\n+    console.log(`   - è¿žæŽ¥çŠ¶æ€: ${this.isWsConnected ? 'å·²è¿žæŽ¥' : 'æœªè¿žæŽ¥'}`)\n+  }\n+}\n+\n // ç›‘å¬å…¶ä»–çª—å£çš„ä»»åŠ¡çŠ¶æ€ï¼ˆç”¨äºŽè°ƒè¯•ï¼‰\n if (typeof window !== 'undefined') {\n   window.addEventListener('storage', (e) => {\n     if (e.key && e.key.startsWith('comfyui_task_')) {\n"
                },
                {
                    "date": 1753509858709,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -152,8 +152,174 @@\n     // ðŸ”§ ä¸ºäº†å‘åŽå…¼å®¹ï¼Œä¿ç•™ pendingTasks å¼•ç”¨ä½†æŒ‡å‘çª—å£ä»»åŠ¡é˜Ÿåˆ—\n     window.pendingTasks = this.windowTasks\n   }\n \n+  // ==================== WebSocket è¿žæŽ¥ç®¡ç†æ–¹æ³• ====================\n+\n+  // ðŸ”§ åˆå§‹åŒ– WebSocket è¿žæŽ¥ - é‡æž„ç‰ˆæœ¬ï¼ˆè§£å†³å¤šæœåŠ¡å™¨æ¶ˆæ¯è·¯ç”±é”™ä¹±ï¼‰\n+  async initializeWebSocket(targetServer = null) {\n+    try {\n+      // ðŸ”§ å…³é”®ä¿®å¤ï¼šæ”¯æŒæŒ‡å®šç›®æ ‡æœåŠ¡å™¨ï¼Œç¡®ä¿ä»»åŠ¡-æœåŠ¡å™¨ç»‘å®šä¸€è‡´æ€§\n+      let baseUrl\n+      const currentLock = this.getWindowServerLock()\n+\n+      if (targetServer) {\n+        // å¦‚æžœæŒ‡å®šäº†ç›®æ ‡æœåŠ¡å™¨ï¼Œç›´æŽ¥ä½¿ç”¨\n+        baseUrl = targetServer\n+        console.log(`ðŸŽ¯ [${WINDOW_ID}] ä½¿ç”¨æŒ‡å®šçš„ç›®æ ‡æœåŠ¡å™¨: ${baseUrl}`)\n+      } else if (currentLock && currentLock.server) {\n+        // å¦‚æžœå½“å‰çª—å£å·²é”å®šæœåŠ¡å™¨ï¼Œä½¿ç”¨é”å®šçš„æœåŠ¡å™¨\n+        baseUrl = currentLock.server\n+        console.log(`ðŸ”’ [${WINDOW_ID}] ä½¿ç”¨çª—å£é”å®šçš„æœåŠ¡å™¨: ${baseUrl}`)\n+      } else {\n+        // å¦åˆ™ä»Žè´Ÿè½½å‡è¡¡å™¨èŽ·å–å¯ç”¨æœåŠ¡å™¨\n+        try {\n+          baseUrl = await loadBalancer.getAvailableServer()\n+          if (!baseUrl) {\n+            throw new Error('è´Ÿè½½å‡è¡¡å™¨è¿”å›žç©ºæœåŠ¡å™¨')\n+          }\n+          console.log(`âš–ï¸ [${WINDOW_ID}] ä»Žè´Ÿè½½å‡è¡¡å™¨èŽ·å–æœåŠ¡å™¨: ${baseUrl}`)\n+        } catch (lbError) {\n+          console.error('âŒ è´Ÿè½½å‡è¡¡å™¨é”™è¯¯:', lbError.message)\n+          throw new Error(`æ— æ³•èŽ·å–å¯ç”¨çš„ComfyUIæœåŠ¡å™¨: ${lbError.message}`)\n+        }\n+      }\n+\n+      // ðŸ”§ æ£€æŸ¥çŽ°æœ‰è¿žæŽ¥æ˜¯å¦ä¸Žç›®æ ‡æœåŠ¡å™¨ä¸€è‡´\n+      if (this.wsConnection && this.wsConnection.readyState === WebSocket.OPEN) {\n+        const currentWsServer = this.currentWebSocketServer || this.getWindowServerLock()?.server\n+        if (currentWsServer === baseUrl) {\n+          console.log(`âœ… [${WINDOW_ID}] WebSocketå·²è¿žæŽ¥åˆ°æ­£ç¡®æœåŠ¡å™¨: ${baseUrl}`)\n+          return true\n+        } else {\n+          console.log(`ðŸ”„ [${WINDOW_ID}] WebSocketæœåŠ¡å™¨ä¸åŒ¹é…ï¼Œéœ€è¦é‡è¿ž`)\n+          console.log(`   å½“å‰è¿žæŽ¥: ${currentWsServer}`)\n+          console.log(`   ç›®æ ‡æœåŠ¡å™¨: ${baseUrl}`)\n+          // å…³é—­çŽ°æœ‰è¿žæŽ¥ï¼Œå»ºç«‹æ–°è¿žæŽ¥\n+          this.wsConnection.close(1000, 'åˆ‡æ¢åˆ°æ­£ç¡®çš„æœåŠ¡å™¨')\n+          this.wsConnection = null\n+          this.isWsConnected = false\n+        }\n+      }\n+\n+      console.log(`ðŸ”Œ [${WINDOW_ID}] è¿žæŽ¥WebSocket: ${baseUrl}`)\n+\n+      // ðŸ”§ æž„å»ºWebSocket URL - ä½¿ç”¨å¢žå¼ºçš„å”¯ä¸€clientId\n+      let wsUrl\n+      if (baseUrl.startsWith('https://')) {\n+        wsUrl = baseUrl.replace('https://', 'wss://') + '/ws?clientId=' + WINDOW_CLIENT_ID\n+      } else {\n+        wsUrl = baseUrl.replace('http://', 'ws://') + '/ws?clientId=' + WINDOW_CLIENT_ID\n+      }\n+\n+      console.log(`ðŸ”— [${WINDOW_ID}] WebSocket URL: ${wsUrl}`)\n+      console.log(`ðŸ”‘ [${WINDOW_ID}] ä½¿ç”¨å¢žå¼ºclientId: ${WINDOW_CLIENT_ID}`)\n+\n+      // ç®€å•çš„HTTPè¿žæŽ¥æµ‹è¯•\n+      try {\n+        const testResponse = await fetch(`${baseUrl}/api/queue`, {\n+          method: 'GET',\n+          signal: AbortSignal.timeout(5000)\n+        })\n+        if (!testResponse.ok) {\n+          throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${testResponse.status}`)\n+        }\n+      } catch (httpError) {\n+        throw new Error(`ComfyUIæœåŠ¡å™¨ä¸å¯è¾¾: ${httpError.message}`)\n+      }\n+\n+      // ðŸ”§ è®°å½•å³å°†è¿žæŽ¥çš„æœåŠ¡å™¨ï¼Œç”¨äºŽåŽç»­éªŒè¯\n+      this.currentWebSocketServer = baseUrl\n+      this.wsConnection = new WebSocket(wsUrl)\n+\n+      return new Promise((resolve, reject) => {\n+        const timeout = setTimeout(() => {\n+          reject(new Error('WebSocket è¿žæŽ¥è¶…æ—¶'))\n+        }, 10000)\n+\n+        this.wsConnection.onopen = () => {\n+          this.isWsConnected = true\n+          clearTimeout(timeout)\n+          this._showNotification(`[${WINDOW_ID}] WebSocketè¿žæŽ¥æˆåŠŸ`, 'success')\n+          this._logServerConsistency('WebSocketè¿žæŽ¥æˆåŠŸ')\n+          resolve(true)\n+        }\n+\n+        this.wsConnection.onerror = (error) => {\n+          this.isWsConnected = false\n+          clearTimeout(timeout)\n+          console.error('âŒ WebSocketè¿žæŽ¥é”™è¯¯:', error)\n+          reject(new Error('WebSocketè¿žæŽ¥å¤±è´¥'))\n+        }\n+\n+        this.wsConnection.onclose = (event) => {\n+          this.isWsConnected = false\n+          console.log(`ðŸ”Œ [${WINDOW_ID}] WebSocketè¿žæŽ¥å…³é—­: ${event.code} - ${event.reason}`)\n+\n+          // ðŸ”§ å¦‚æžœä¸æ˜¯æ­£å¸¸å…³é—­ï¼Œå°è¯•é‡è¿ž\n+          if (event.code !== 1000 && event.code !== 1001) {\n+            console.log(`ðŸ”„ [${WINDOW_ID}] éžæ­£å¸¸å…³é—­ï¼Œå‡†å¤‡é‡è¿ž...`)\n+            setTimeout(() => {\n+              if (!this.isWsConnected) {\n+                console.log(`ðŸ”„ [${WINDOW_ID}] æ‰§è¡ŒWebSocketé‡è¿ž`)\n+                this.initializeWebSocket(baseUrl).catch(error => {\n+                  console.error('âŒ WebSocketé‡è¿žå¤±è´¥:', error)\n+                })\n+              }\n+            }, 3000)\n+          }\n+        }\n+\n+        this.wsConnection.onmessage = (event) => {\n+          try {\n+            const message = event.data\n+\n+            // ðŸ”§ å¢žå¼ºæ¶ˆæ¯è¿‡æ»¤ï¼šåªå¤„ç†å½“å‰çª—å£çš„æ¶ˆæ¯\n+            if (typeof message === 'object' && message.windowId && message.windowId !== WINDOW_ID) {\n+              console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„æ¶ˆæ¯: ${message.windowId}`)\n+              return\n+            }\n+\n+            // å®˜æ–¹æ ‡å‡†ï¼šåªå¤„ç†å­—ç¬¦ä¸²æ¶ˆæ¯\n+            if (typeof message === 'string') {\n+              try {\n+                const parsedMessage = JSON.parse(message)\n+\n+                // è°ƒç”¨é‡æž„åŽçš„æ¶ˆæ¯å¤„ç†å‡½æ•°\n+                this.handleWebSocketMessage(parsedMessage)\n+              } catch (parseError) {\n+                console.error('âŒ [OFFICIAL] JSONè§£æžå¤±è´¥:', parseError.message)\n+              }\n+            }\n+\n+          } catch (error) {\n+            console.error('âŒ [OFFICIAL] WebSocketæ¶ˆæ¯å¤„ç†å¤±è´¥:', error)\n+          }\n+        }\n+      })\n+    } catch (error) {\n+      console.error('âŒ åˆå§‹åŒ– WebSocket å¤±è´¥:', error)\n+\n+      // ðŸ”§ æ ¹æ®é”™è¯¯ç±»åž‹å†³å®šæ˜¯å¦æ¸…é™¤æœåŠ¡å™¨é”å®š\n+      if (error.message.includes('è´Ÿè½½å‡è¡¡å™¨') || error.message.includes('æ— æ³•èŽ·å–å¯ç”¨çš„ComfyUIæœåŠ¡å™¨')) {\n+        // å¦‚æžœæ˜¯è´Ÿè½½å‡è¡¡å™¨é”™è¯¯ï¼Œæ¸…é™¤æœåŠ¡å™¨é”å®š\n+        this.currentWebSocketServer = null\n+        this.clearWindowServerLock()\n+        console.log('ðŸ”“ è´Ÿè½½å‡è¡¡å™¨é”™è¯¯ï¼Œæ¸…é™¤æœåŠ¡å™¨é”å®š')\n+      } else if (error.message.includes('ComfyUIæœåŠ¡å™¨ä¸å¯è¾¾') || error.message.includes('WebSocket è¿žæŽ¥è¶…æ—¶')) {\n+        // å¦‚æžœæ˜¯è¿žæŽ¥é”™è¯¯ä½†æœåŠ¡å™¨å¯èƒ½æ¢å¤ï¼Œä¿æŒé”å®šä»¥ä¾¿é‡è¯•\n+        console.log('ðŸ”’ è¿žæŽ¥é”™è¯¯ä½†ä¿æŒæœåŠ¡å™¨é”å®šä»¥ä¾¿é‡è¯•')\n+      } else {\n+        // å…¶ä»–æœªçŸ¥é”™è¯¯ï¼Œæ¸…é™¤é”å®š\n+        this.currentWebSocketServer = null\n+        this.clearWindowServerLock()\n+        console.log('ðŸ”“ æœªçŸ¥é”™è¯¯ï¼Œæ¸…é™¤æœåŠ¡å™¨é”å®š')\n+      }\n+\n+      throw error\n+    }\n+  }\n+\n   // ðŸ”§ èŽ·å–å½“å‰çª—å£çš„æœåŠ¡å™¨é”å®šä¿¡æ¯\n   getWindowServerLock() {\n     return this.WINDOW_SERVER_LOCKS.get(WINDOW_ID) || null\n   }\n"
                },
                {
                    "date": 1753511617085,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1018,10 +1018,10 @@\n       }\n     }\n   }\n \n-  // ðŸ”¥ å¤„ç†ä»»åŠ¡å®Œæˆçš„æ ¸å¿ƒå‡½æ•° - é‡æž„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n-  handleTaskCompletion(promptId) {\n+  // ðŸ”¥ å¤„ç†ä»»åŠ¡å®Œæˆçš„æ ¸å¿ƒå‡½æ•° - ä¿®å¤ç‰ˆæœ¬ï¼ˆæ¢å¤ç»“æžœèŽ·å–é€»è¾‘ï¼‰\n+  async handleTaskCompletion(promptId) {\n     try {\n       const task = this.getWindowTask(promptId)\n       if (!task) {\n         console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡å®Œæˆå¤„ç†å¤±è´¥: ä»»åŠ¡ä¸å­˜åœ¨ ${promptId}`)\n@@ -1032,19 +1032,36 @@\n \n       // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n       this.safeProgressCallback(promptId, task, 'ä»»åŠ¡æ‰§è¡Œå®Œæˆ', 100)\n \n+      // ðŸ”§ èŽ·å–ä»»åŠ¡åŽ†å²å’Œç»“æžœï¼ˆæ¢å¤é‡æž„å‰çš„é€»è¾‘ï¼‰\n+      let taskResult = null\n+      try {\n+        // åŠ¨æ€å¯¼å…¥ comfyui.js ä¸­çš„å‡½æ•°\n+        const comfyuiModule = await import('./comfyui.js')\n+        const { getTaskHistory, extractTaskResults } = comfyuiModule\n+\n+        console.log(`ðŸ“Š [${WINDOW_ID}] å¼€å§‹èŽ·å–ä»»åŠ¡ç»“æžœ: ${promptId}`)\n+        const history = await getTaskHistory()\n+        taskResult = await extractTaskResults(history, promptId)\n+        console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`, taskResult)\n+      } catch (error) {\n+        console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–å¤±è´¥: ${promptId}`, error)\n+        // ç»§ç»­æ‰§è¡Œï¼Œä½†ç»“æžœä¸ºnull\n+        taskResult = null\n+      }\n+\n       // ç«‹å³æ¸…ç†ä»»åŠ¡\n       this.removeWindowTask(promptId)\n \n       // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n       this.checkServerUnlockCondition()\n \n-      // è°ƒç”¨æˆåŠŸå›žè°ƒ\n-      if (task.onSuccess) {\n+      // è°ƒç”¨æˆåŠŸå›žè°ƒï¼Œä¼ é€’å®Œæ•´çš„ä»»åŠ¡ç»“æžœï¼ˆä¿®å¤ï¼šä½¿ç”¨onCompleteè€Œä¸æ˜¯onSuccessï¼‰\n+      if (task.onComplete) {\n         // ðŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿æˆåŠŸå›žè°ƒç«‹å³æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n         setTimeout(() => {\n-          task.onSuccess(promptId)\n+          task.onComplete(taskResult) // âœ… ä¿®å¤ï¼šä¼ é€’å®Œæ•´çš„ä»»åŠ¡ç»“æžœè€Œä¸æ˜¯åªä¼ é€’promptId\n         }, 0)\n       }\n \n       console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡å®Œæˆå¤„ç†ç»“æŸ: ${promptId}`)\n@@ -1057,9 +1074,10 @@\n \n       // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n       this.checkServerUnlockCondition()\n \n-      if (task.onError) {\n+      const task = this.getWindowTask(promptId)\n+      if (task && task.onError) {\n         // ðŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿é”™è¯¯å›žè°ƒç«‹å³æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n         setTimeout(() => {\n           task.onError(error.message)\n         }, 0)\n"
                },
                {
                    "date": 1753511627498,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1032,36 +1032,19 @@\n \n       // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n       this.safeProgressCallback(promptId, task, 'ä»»åŠ¡æ‰§è¡Œå®Œæˆ', 100)\n \n-      // ðŸ”§ èŽ·å–ä»»åŠ¡åŽ†å²å’Œç»“æžœï¼ˆæ¢å¤é‡æž„å‰çš„é€»è¾‘ï¼‰\n-      let taskResult = null\n-      try {\n-        // åŠ¨æ€å¯¼å…¥ comfyui.js ä¸­çš„å‡½æ•°\n-        const comfyuiModule = await import('./comfyui.js')\n-        const { getTaskHistory, extractTaskResults } = comfyuiModule\n-\n-        console.log(`ðŸ“Š [${WINDOW_ID}] å¼€å§‹èŽ·å–ä»»åŠ¡ç»“æžœ: ${promptId}`)\n-        const history = await getTaskHistory()\n-        taskResult = await extractTaskResults(history, promptId)\n-        console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`, taskResult)\n-      } catch (error) {\n-        console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–å¤±è´¥: ${promptId}`, error)\n-        // ç»§ç»­æ‰§è¡Œï¼Œä½†ç»“æžœä¸ºnull\n-        taskResult = null\n-      }\n-\n       // ç«‹å³æ¸…ç†ä»»åŠ¡\n       this.removeWindowTask(promptId)\n \n       // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n       this.checkServerUnlockCondition()\n \n-      // è°ƒç”¨æˆåŠŸå›žè°ƒï¼Œä¼ é€’å®Œæ•´çš„ä»»åŠ¡ç»“æžœï¼ˆä¿®å¤ï¼šä½¿ç”¨onCompleteè€Œä¸æ˜¯onSuccessï¼‰\n-      if (task.onComplete) {\n+      // è°ƒç”¨æˆåŠŸå›žè°ƒ\n+      if (task.onSuccess) {\n         // ðŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿æˆåŠŸå›žè°ƒç«‹å³æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n         setTimeout(() => {\n-          task.onComplete(taskResult) // âœ… ä¿®å¤ï¼šä¼ é€’å®Œæ•´çš„ä»»åŠ¡ç»“æžœè€Œä¸æ˜¯åªä¼ é€’promptId\n+          task.onSuccess(promptId)\n         }, 0)\n       }\n \n       console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡å®Œæˆå¤„ç†ç»“æŸ: ${promptId}`)\n@@ -1074,10 +1057,9 @@\n \n       // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n       this.checkServerUnlockCondition()\n \n-      const task = this.getWindowTask(promptId)\n-      if (task && task.onError) {\n+      if (task.onError) {\n         // ðŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿é”™è¯¯å›žè°ƒç«‹å³æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n         setTimeout(() => {\n           task.onError(error.message)\n         }, 0)\n"
                },
                {
                    "date": 1753511641082,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1018,9 +1018,9 @@\n       }\n     }\n   }\n \n-  // ðŸ”¥ å¤„ç†ä»»åŠ¡å®Œæˆçš„æ ¸å¿ƒå‡½æ•° - ä¿®å¤ç‰ˆæœ¬ï¼ˆæ¢å¤ç»“æžœèŽ·å–é€»è¾‘ï¼‰\n+  // ðŸ”¥ å¤„ç†ä»»åŠ¡å®Œæˆçš„æ ¸å¿ƒå‡½æ•° - é‡æž„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n   async handleTaskCompletion(promptId) {\n     try {\n       const task = this.getWindowTask(promptId)\n       if (!task) {\n"
                },
                {
                    "date": 1753511659775,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1018,9 +1018,9 @@\n       }\n     }\n   }\n \n-  // ðŸ”¥ å¤„ç†ä»»åŠ¡å®Œæˆçš„æ ¸å¿ƒå‡½æ•° - é‡æž„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n+  // ðŸ”¥ å¤„ç†ä»»åŠ¡å®Œæˆçš„æ ¸å¿ƒå‡½æ•° - ä¿®å¤ç‰ˆæœ¬ï¼ˆæ¢å¤ç»“æžœèŽ·å–é€»è¾‘ï¼‰\n   async handleTaskCompletion(promptId) {\n     try {\n       const task = this.getWindowTask(promptId)\n       if (!task) {\n"
                },
                {
                    "date": 1753511673409,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1018,9 +1018,9 @@\n       }\n     }\n   }\n \n-  // ðŸ”¥ å¤„ç†ä»»åŠ¡å®Œæˆçš„æ ¸å¿ƒå‡½æ•° - ä¿®å¤ç‰ˆæœ¬ï¼ˆæ¢å¤ç»“æžœèŽ·å–é€»è¾‘ï¼‰\n+  // ðŸ”¥ å¤„ç†ä»»åŠ¡å®Œæˆçš„æ ¸å¿ƒå‡½æ•° - é‡æž„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n   async handleTaskCompletion(promptId) {\n     try {\n       const task = this.getWindowTask(promptId)\n       if (!task) {\n"
                },
                {
                    "date": 1753511696320,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1019,9 +1019,9 @@\n     }\n   }\n \n   // ðŸ”¥ å¤„ç†ä»»åŠ¡å®Œæˆçš„æ ¸å¿ƒå‡½æ•° - é‡æž„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n-  async handleTaskCompletion(promptId) {\n+  handleTaskCompletion(promptId) {\n     try {\n       const task = this.getWindowTask(promptId)\n       if (!task) {\n         console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡å®Œæˆå¤„ç†å¤±è´¥: ä»»åŠ¡ä¸å­˜åœ¨ ${promptId}`)\n@@ -1032,19 +1032,36 @@\n \n       // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n       this.safeProgressCallback(promptId, task, 'ä»»åŠ¡æ‰§è¡Œå®Œæˆ', 100)\n \n+      // ðŸ”§ èŽ·å–ä»»åŠ¡åŽ†å²å’Œç»“æžœï¼ˆæ¢å¤é‡æž„å‰çš„é€»è¾‘ï¼‰\n+      let taskResult = null\n+      try {\n+        // åŠ¨æ€å¯¼å…¥ comfyui.js ä¸­çš„å‡½æ•°\n+        const comfyuiModule = await import('./comfyui.js')\n+        const { getTaskHistory, extractTaskResults } = comfyuiModule\n+\n+        console.log(`ðŸ“Š [${WINDOW_ID}] å¼€å§‹èŽ·å–ä»»åŠ¡ç»“æžœ: ${promptId}`)\n+        const history = await getTaskHistory()\n+        taskResult = await extractTaskResults(history, promptId)\n+        console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`, taskResult)\n+      } catch (error) {\n+        console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–å¤±è´¥: ${promptId}`, error)\n+        // ç»§ç»­æ‰§è¡Œï¼Œä½†ç»“æžœä¸ºnull\n+        taskResult = null\n+      }\n+\n       // ç«‹å³æ¸…ç†ä»»åŠ¡\n       this.removeWindowTask(promptId)\n \n       // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n       this.checkServerUnlockCondition()\n \n-      // è°ƒç”¨æˆåŠŸå›žè°ƒ\n-      if (task.onSuccess) {\n+      // è°ƒç”¨æˆåŠŸå›žè°ƒï¼Œä¼ é€’å®Œæ•´çš„ä»»åŠ¡ç»“æžœï¼ˆä¿®å¤ï¼šä½¿ç”¨onCompleteè€Œä¸æ˜¯onSuccessï¼‰\n+      if (task.onComplete) {\n         // ðŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿æˆåŠŸå›žè°ƒç«‹å³æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n         setTimeout(() => {\n-          task.onSuccess(promptId)\n+          task.onComplete(taskResult) // âœ… ä¿®å¤ï¼šä¼ é€’å®Œæ•´çš„ä»»åŠ¡ç»“æžœè€Œä¸æ˜¯åªä¼ é€’promptId\n         }, 0)\n       }\n \n       console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡å®Œæˆå¤„ç†ç»“æŸ: ${promptId}`)\n"
                },
                {
                    "date": 1753511716318,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1018,10 +1018,10 @@\n       }\n     }\n   }\n \n-  // ðŸ”¥ å¤„ç†ä»»åŠ¡å®Œæˆçš„æ ¸å¿ƒå‡½æ•° - é‡æž„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n-  handleTaskCompletion(promptId) {\n+  // ðŸ”¥ å¤„ç†ä»»åŠ¡å®Œæˆçš„æ ¸å¿ƒå‡½æ•° - ä¿®å¤ç‰ˆæœ¬ï¼ˆæ¢å¤ç»“æžœèŽ·å–é€»è¾‘ï¼‰\n+  async handleTaskCompletion(promptId) {\n     try {\n       const task = this.getWindowTask(promptId)\n       if (!task) {\n         console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡å®Œæˆå¤„ç†å¤±è´¥: ä»»åŠ¡ä¸å­˜åœ¨ ${promptId}`)\n@@ -1032,36 +1032,19 @@\n \n       // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n       this.safeProgressCallback(promptId, task, 'ä»»åŠ¡æ‰§è¡Œå®Œæˆ', 100)\n \n-      // ðŸ”§ èŽ·å–ä»»åŠ¡åŽ†å²å’Œç»“æžœï¼ˆæ¢å¤é‡æž„å‰çš„é€»è¾‘ï¼‰\n-      let taskResult = null\n-      try {\n-        // åŠ¨æ€å¯¼å…¥ comfyui.js ä¸­çš„å‡½æ•°\n-        const comfyuiModule = await import('./comfyui.js')\n-        const { getTaskHistory, extractTaskResults } = comfyuiModule\n-\n-        console.log(`ðŸ“Š [${WINDOW_ID}] å¼€å§‹èŽ·å–ä»»åŠ¡ç»“æžœ: ${promptId}`)\n-        const history = await getTaskHistory()\n-        taskResult = await extractTaskResults(history, promptId)\n-        console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`, taskResult)\n-      } catch (error) {\n-        console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–å¤±è´¥: ${promptId}`, error)\n-        // ç»§ç»­æ‰§è¡Œï¼Œä½†ç»“æžœä¸ºnull\n-        taskResult = null\n-      }\n-\n       // ç«‹å³æ¸…ç†ä»»åŠ¡\n       this.removeWindowTask(promptId)\n \n       // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n       this.checkServerUnlockCondition()\n \n-      // è°ƒç”¨æˆåŠŸå›žè°ƒï¼Œä¼ é€’å®Œæ•´çš„ä»»åŠ¡ç»“æžœï¼ˆä¿®å¤ï¼šä½¿ç”¨onCompleteè€Œä¸æ˜¯onSuccessï¼‰\n-      if (task.onComplete) {\n+      // è°ƒç”¨æˆåŠŸå›žè°ƒ\n+      if (task.onSuccess) {\n         // ðŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿æˆåŠŸå›žè°ƒç«‹å³æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n         setTimeout(() => {\n-          task.onComplete(taskResult) // âœ… ä¿®å¤ï¼šä¼ é€’å®Œæ•´çš„ä»»åŠ¡ç»“æžœè€Œä¸æ˜¯åªä¼ é€’promptId\n+          task.onSuccess(promptId)\n         }, 0)\n       }\n \n       console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡å®Œæˆå¤„ç†ç»“æŸ: ${promptId}`)\n"
                },
                {
                    "date": 1753511765264,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1032,8 +1032,25 @@\n \n       // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n       this.safeProgressCallback(promptId, task, 'ä»»åŠ¡æ‰§è¡Œå®Œæˆ', 100)\n \n+      // ðŸ”§ èŽ·å–ä»»åŠ¡åŽ†å²å’Œç»“æžœï¼ˆæ¢å¤é‡æž„å‰çš„é€»è¾‘ï¼‰\n+      let taskResult = null\n+      try {\n+        // åŠ¨æ€å¯¼å…¥ comfyui.js ä¸­çš„å‡½æ•°\n+        const comfyuiModule = await import('./comfyui.js')\n+        const { getTaskHistory, extractTaskResults } = comfyuiModule\n+\n+        console.log(`ðŸ“Š [${WINDOW_ID}] å¼€å§‹èŽ·å–ä»»åŠ¡ç»“æžœ: ${promptId}`)\n+        const history = await getTaskHistory()\n+        taskResult = await extractTaskResults(history, promptId)\n+        console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`, taskResult)\n+      } catch (error) {\n+        console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–å¤±è´¥: ${promptId}`, error)\n+        // ç»§ç»­æ‰§è¡Œï¼Œä½†ç»“æžœä¸ºnull\n+        taskResult = null\n+      }\n+\n       // ç«‹å³æ¸…ç†ä»»åŠ¡\n       this.removeWindowTask(promptId)\n \n       // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n"
                },
                {
                    "date": 1753511780705,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1032,36 +1032,19 @@\n \n       // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n       this.safeProgressCallback(promptId, task, 'ä»»åŠ¡æ‰§è¡Œå®Œæˆ', 100)\n \n-      // ðŸ”§ èŽ·å–ä»»åŠ¡åŽ†å²å’Œç»“æžœï¼ˆæ¢å¤é‡æž„å‰çš„é€»è¾‘ï¼‰\n-      let taskResult = null\n-      try {\n-        // åŠ¨æ€å¯¼å…¥ comfyui.js ä¸­çš„å‡½æ•°\n-        const comfyuiModule = await import('./comfyui.js')\n-        const { getTaskHistory, extractTaskResults } = comfyuiModule\n-\n-        console.log(`ðŸ“Š [${WINDOW_ID}] å¼€å§‹èŽ·å–ä»»åŠ¡ç»“æžœ: ${promptId}`)\n-        const history = await getTaskHistory()\n-        taskResult = await extractTaskResults(history, promptId)\n-        console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`, taskResult)\n-      } catch (error) {\n-        console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–å¤±è´¥: ${promptId}`, error)\n-        // ç»§ç»­æ‰§è¡Œï¼Œä½†ç»“æžœä¸ºnull\n-        taskResult = null\n-      }\n-\n       // ç«‹å³æ¸…ç†ä»»åŠ¡\n       this.removeWindowTask(promptId)\n \n       // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n       this.checkServerUnlockCondition()\n \n-      // è°ƒç”¨æˆåŠŸå›žè°ƒ\n-      if (task.onSuccess) {\n+      // è°ƒç”¨æˆåŠŸå›žè°ƒï¼Œä¼ é€’å®Œæ•´çš„ä»»åŠ¡ç»“æžœï¼ˆä¿®å¤ï¼šä½¿ç”¨onCompleteè€Œä¸æ˜¯onSuccessï¼‰\n+      if (task.onComplete) {\n         // ðŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿æˆåŠŸå›žè°ƒç«‹å³æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n         setTimeout(() => {\n-          task.onSuccess(promptId)\n+          task.onComplete(taskResult) // âœ… ä¿®å¤ï¼šä¼ é€’å®Œæ•´çš„ä»»åŠ¡ç»“æžœè€Œä¸æ˜¯åªä¼ é€’promptId\n         }, 0)\n       }\n \n       console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡å®Œæˆå¤„ç†ç»“æŸ: ${promptId}`)\n"
                },
                {
                    "date": 1753511814550,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1032,8 +1032,25 @@\n \n       // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n       this.safeProgressCallback(promptId, task, 'ä»»åŠ¡æ‰§è¡Œå®Œæˆ', 100)\n \n+      // ðŸ”§ èŽ·å–ä»»åŠ¡åŽ†å²å’Œç»“æžœï¼ˆæ¢å¤é‡æž„å‰çš„é€»è¾‘ï¼‰\n+      let taskResult = null\n+      try {\n+        // åŠ¨æ€å¯¼å…¥ comfyui.js ä¸­çš„å‡½æ•°\n+        const comfyuiModule = await import('./comfyui.js')\n+        const { getTaskHistory, extractTaskResults } = comfyuiModule\n+\n+        console.log(`ðŸ“Š [${WINDOW_ID}] å¼€å§‹èŽ·å–ä»»åŠ¡ç»“æžœ: ${promptId}`)\n+        const history = await getTaskHistory()\n+        taskResult = await extractTaskResults(history, promptId)\n+        console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`, taskResult)\n+      } catch (error) {\n+        console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–å¤±è´¥: ${promptId}`, error)\n+        // ç»§ç»­æ‰§è¡Œï¼Œä½†ç»“æžœä¸ºnull\n+        taskResult = null\n+      }\n+\n       // ç«‹å³æ¸…ç†ä»»åŠ¡\n       this.removeWindowTask(promptId)\n \n       // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n"
                },
                {
                    "date": 1753511854062,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1032,25 +1032,8 @@\n \n       // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n       this.safeProgressCallback(promptId, task, 'ä»»åŠ¡æ‰§è¡Œå®Œæˆ', 100)\n \n-      // ðŸ”§ èŽ·å–ä»»åŠ¡åŽ†å²å’Œç»“æžœï¼ˆæ¢å¤é‡æž„å‰çš„é€»è¾‘ï¼‰\n-      let taskResult = null\n-      try {\n-        // åŠ¨æ€å¯¼å…¥ comfyui.js ä¸­çš„å‡½æ•°\n-        const comfyuiModule = await import('./comfyui.js')\n-        const { getTaskHistory, extractTaskResults } = comfyuiModule\n-\n-        console.log(`ðŸ“Š [${WINDOW_ID}] å¼€å§‹èŽ·å–ä»»åŠ¡ç»“æžœ: ${promptId}`)\n-        const history = await getTaskHistory()\n-        taskResult = await extractTaskResults(history, promptId)\n-        console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`, taskResult)\n-      } catch (error) {\n-        console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–å¤±è´¥: ${promptId}`, error)\n-        // ç»§ç»­æ‰§è¡Œï¼Œä½†ç»“æžœä¸ºnull\n-        taskResult = null\n-      }\n-\n       // ç«‹å³æ¸…ç†ä»»åŠ¡\n       this.removeWindowTask(promptId)\n \n       // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n"
                },
                {
                    "date": 1753511888685,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1032,8 +1032,25 @@\n \n       // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n       this.safeProgressCallback(promptId, task, 'ä»»åŠ¡æ‰§è¡Œå®Œæˆ', 100)\n \n+      // ðŸ”§ èŽ·å–ä»»åŠ¡åŽ†å²å’Œç»“æžœï¼ˆæ¢å¤é‡æž„å‰çš„é€»è¾‘ï¼‰\n+      let taskResult = null\n+      try {\n+        // åŠ¨æ€å¯¼å…¥ comfyui.js ä¸­çš„å‡½æ•°\n+        const comfyuiModule = await import('./comfyui.js')\n+        const { getTaskHistory, extractTaskResults } = comfyuiModule\n+\n+        console.log(`ðŸ“Š [${WINDOW_ID}] å¼€å§‹èŽ·å–ä»»åŠ¡ç»“æžœ: ${promptId}`)\n+        const history = await getTaskHistory()\n+        taskResult = await extractTaskResults(history, promptId)\n+        console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`, taskResult)\n+      } catch (error) {\n+        console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–å¤±è´¥: ${promptId}`, error)\n+        // ç»§ç»­æ‰§è¡Œï¼Œä½†ç»“æžœä¸ºnull\n+        taskResult = null\n+      }\n+\n       // ç«‹å³æ¸…ç†ä»»åŠ¡\n       this.removeWindowTask(promptId)\n \n       // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n@@ -1057,9 +1074,10 @@\n \n       // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n       this.checkServerUnlockCondition()\n \n-      if (task.onError) {\n+      const task = this.getWindowTask(promptId)\n+      if (task && task.onError) {\n         // ðŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿é”™è¯¯å›žè°ƒç«‹å³æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n         setTimeout(() => {\n           task.onError(error.message)\n         }, 0)\n"
                },
                {
                    "date": 1753511914012,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1074,10 +1074,9 @@\n \n       // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n       this.checkServerUnlockCondition()\n \n-      const task = this.getWindowTask(promptId)\n-      if (task && task.onError) {\n+      if (task.onError) {\n         // ðŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿é”™è¯¯å›žè°ƒç«‹å³æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n         setTimeout(() => {\n           task.onError(error.message)\n         }, 0)\n"
                },
                {
                    "date": 1753511995472,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1074,9 +1074,10 @@\n \n       // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n       this.checkServerUnlockCondition()\n \n-      if (task.onError) {\n+      const task = this.getWindowTask(promptId)\n+      if (task && task.onError) {\n         // ðŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿é”™è¯¯å›žè°ƒç«‹å³æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n         setTimeout(() => {\n           task.onError(error.message)\n         }, 0)\n"
                },
                {
                    "date": 1753512969185,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,32 +1,21 @@\n-// WebSocket ç®¡ç†å™¨ - ç‹¬ç«‹æ¨¡å—\n-// è´Ÿè´£æ‰€æœ‰ WebSocket è¿žæŽ¥ç®¡ç†ã€æ¶ˆæ¯å¤„ç†ã€é‡è¿žé€»è¾‘å’Œçª—å£éš”ç¦»æœºåˆ¶\n+// æžç®€ç‰ˆ WebSocket ç®¡ç†å™¨ - åŸºäºŽå®˜æ–¹ websockets_api_example.py\n+// æ”¯æŒå¤šç”¨æˆ·å¤šçª—å£ã€æœåŠ¡å™¨é€‰æ‹©ã€ä»»åŠ¡é”å®šæœºåˆ¶\n \n import loadBalancer from './loadBalancer.js'\n \n-// ðŸ”§ çª—å£å”¯ä¸€æ ‡è¯†ç¬¦ç”Ÿæˆæœºåˆ¶\n-function generateWindowId() {\n+// ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦\n+function generateId() {\n   return `${Date.now()}_${Math.random().toString(36).substring(2, 11)}`\n }\n \n-// ðŸ”§ ä¸ºå½“å‰çª—å£ç”Ÿæˆå”¯ä¸€çš„clientId - å¢žå¼ºå”¯ä¸€æ€§é˜²æ­¢å†²çª\n-function generateUniqueClientId() {\n-  const baseId = 'abc1373d4ad648a3a81d0587fbe5534b' // åŸºç¡€clientId\n-  const timestamp = Date.now()\n-  const random = Math.random().toString(36).substring(2, 11)\n-  const windowId = generateWindowId()\n+// çª—å£å”¯ä¸€æ ‡è¯†\n+const WINDOW_ID = generateId()\n+const CLIENT_ID = generateId()\n \n-  // ðŸ”§ å¢žå¼ºå”¯ä¸€æ€§ï¼šåŸºç¡€ID + æ—¶é—´æˆ³ + éšæœºæ•° + çª—å£ID\n-  return `${baseId}_${timestamp}_${random}_${windowId}`\n-}\n+console.log(`ðŸªŸ çª—å£ID: ${WINDOW_ID}`)\n+console.log(`ðŸ”‘ å®¢æˆ·ç«¯ID: ${CLIENT_ID}`)\n \n-// ðŸ”§ çª—å£çº§åˆ«çš„å…¨å±€å˜é‡ - ç¡®ä¿æ¯ä¸ªçª—å£éƒ½æœ‰å”¯ä¸€æ ‡è¯†\n-const WINDOW_CLIENT_ID = generateUniqueClientId()\n-const WINDOW_ID = generateWindowId()\n-\n-console.log(`ðŸªŸ çª—å£æ ‡è¯†: ${WINDOW_ID}`)\n-console.log(`ðŸ”‘ çª—å£å®¢æˆ·ç«¯ID: ${WINDOW_CLIENT_ID}`)\n-\n /**\n  * WebSocket ç®¡ç†å™¨ç±»\n  * è´Ÿè´£ WebSocket è¿žæŽ¥çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç†\n  */\n"
                },
                {
                    "date": 1753513080992,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,1208 +15,319 @@\n console.log(`ðŸªŸ çª—å£ID: ${WINDOW_ID}`)\n console.log(`ðŸ”‘ å®¢æˆ·ç«¯ID: ${CLIENT_ID}`)\n \n /**\n- * WebSocket ç®¡ç†å™¨ç±»\n- * è´Ÿè´£ WebSocket è¿žæŽ¥çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç†\n+ * æžç®€ç‰ˆ WebSocket ç®¡ç†å™¨\n+ * åŸºäºŽå®˜æ–¹ websockets_api_example.py çš„æ ¸å¿ƒé€»è¾‘\n  */\n-class WebSocketManager {\n+class SimpleWebSocketManager {\n   constructor() {\n-    // WebSocket è¿žæŽ¥çŠ¶æ€\n-    this.wsConnection = null\n-    this.isWsConnected = false\n-    this.currentWebSocketServer = null\n-\n-    // çª—å£éš”ç¦»çš„ä»»åŠ¡é˜Ÿåˆ—\n-    this.windowTasks = new Map() // promptId -> task\n-\n-    // çª—å£çº§åˆ«çš„æœåŠ¡å™¨é”å®šæœºåˆ¶\n-    this.WINDOW_SERVER_LOCKS = new Map() // windowId -> { server, timestamp, tasks }\n-\n-    // åŠ¨æ€è§£é”æ£€æŸ¥æœºåˆ¶\n-    this.serverUnlockTimer = null\n-\n-    // é˜²æŠ–æœºåˆ¶ï¼šé¿å…é¢‘ç¹çš„è¿›åº¦å›žè°ƒè§¦å‘é€’å½’æ›´æ–°\n-    this.progressCallbackDebounce = new Map()\n-\n-    // å®˜æ–¹æ ‡å‡†ä»»åŠ¡çŠ¶æ€æžšä¸¾\n-    this.TASK_STATUS = {\n-      WAITING: 'waiting',        // ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…\n-      EXECUTING: 'executing',    // ä»»åŠ¡æ­£åœ¨æ‰§è¡Œ\n-      COMPLETED: 'completed',    // ä»»åŠ¡å·²å®Œæˆ\n-      ERROR: 'error',           // ä»»åŠ¡æ‰§è¡Œé”™è¯¯\n-      INTERRUPTED: 'interrupted' // ä»»åŠ¡è¢«ä¸­æ–­\n-    }\n-\n-    // åˆå§‹åŒ–çª—å£äº‹ä»¶ç›‘å¬\n-    this._initializeWindowEvents()\n-    this._initializeGlobalProperties()\n+    // WebSocket è¿žæŽ¥\n+    this.ws = null\n+    this.isConnected = false\n+    this.currentServer = null\n+    \n+    // ä»»åŠ¡ç®¡ç† - åªä¿ç•™å½“å‰çª—å£çš„ä»»åŠ¡\n+    this.tasks = new Map() // promptId -> { onComplete, onError, onProgress, server }\n+    \n+    // æœåŠ¡å™¨é”å®š - ç®€åŒ–ä¸ºçª—å£çº§åˆ«\n+    this.lockedServer = null\n+    this.lockTimestamp = null\n+    \n+    // åˆå§‹åŒ–çª—å£äº‹ä»¶\n+    this._initWindowEvents()\n   }\n \n-  // ðŸ”§ çª—å£å…³é—­æ—¶çš„æ¸…ç†æœºåˆ¶\n-  _initializeWindowEvents() {\n+  // çª—å£å…³é—­æ¸…ç†\n+  _initWindowEvents() {\n     window.addEventListener('beforeunload', () => {\n-      console.log(`ðŸšª [${WINDOW_ID}] çª—å£å³å°†å…³é—­ï¼Œæ‰§è¡Œæ¸…ç†...`)\n-\n-      // æ¸…ç†å½“å‰çª—å£çš„æœåŠ¡å™¨é”å®š\n-      const currentLock = this.getWindowServerLock()\n-      if (currentLock) {\n-        console.log(`ðŸ”“ [${WINDOW_ID}] çª—å£å…³é—­ï¼Œæ¸…ç†æœåŠ¡å™¨é”å®š: ${currentLock.server}`)\n-        this.clearWindowServerLock()\n-      }\n-\n-      // æ¸…ç†å½“å‰çª—å£çš„ä»»åŠ¡\n-      if (this.windowTasks.size > 0) {\n-        console.log(`ðŸ—‘ï¸ [${WINDOW_ID}] çª—å£å…³é—­ï¼Œæ¸…ç† ${this.windowTasks.size} ä¸ªä»»åŠ¡`)\n-        this.windowTasks.clear()\n-      }\n-\n-      // å…³é—­WebSocketè¿žæŽ¥\n-      if (this.wsConnection && this.wsConnection.readyState === WebSocket.OPEN) {\n-        console.log(`ðŸ”Œ [${WINDOW_ID}] çª—å£å…³é—­ï¼Œæ–­å¼€WebSocketè¿žæŽ¥`)\n-        this.wsConnection.close()\n-      }\n+      console.log(`ðŸšª [${WINDOW_ID}] çª—å£å…³é—­ï¼Œæ¸…ç†èµ„æº`)\n+      this._cleanup()\n     })\n+  }\n \n-    // ðŸ”§ é¡µé¢å¯è§æ€§å˜åŒ–æ—¶çš„å¤„ç†\n-    document.addEventListener('visibilitychange', () => {\n-      if (document.hidden) {\n-        console.log(`ðŸ‘ï¸ [${WINDOW_ID}] çª—å£éšè—`)\n-      } else {\n-        console.log(`ðŸ‘ï¸ [${WINDOW_ID}] çª—å£é‡æ–°å¯è§`)\n-\n-        // æ£€æŸ¥æœåŠ¡å™¨é”å®šçŠ¶æ€\n-        const currentLock = this.getWindowServerLock()\n-        if (currentLock) {\n-          console.log(`ðŸ”’ [${WINDOW_ID}] çª—å£é‡æ–°å¯è§ï¼ŒæœåŠ¡å™¨é”å®šçŠ¶æ€: ${currentLock.server}`)\n-        }\n-\n-        // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\n-        if (this.windowTasks.size > 0) {\n-          console.log(`ðŸ“Š [${WINDOW_ID}] çª—å£é‡æ–°å¯è§ï¼Œå½“å‰ä»»åŠ¡æ•°: ${this.windowTasks.size}`)\n-        }\n-      }\n-    })\n+  // æ¸…ç†èµ„æº\n+  _cleanup() {\n+    if (this.ws) {\n+      this.ws.close()\n+      this.ws = null\n+    }\n+    this.tasks.clear()\n+    this.lockedServer = null\n+    this.isConnected = false\n   }\n \n-  // ðŸ”§ åˆå§‹åŒ–å…¨å±€å±žæ€§ä»¥ä¿æŒå‘åŽå…¼å®¹\n-  _initializeGlobalProperties() {\n-    // ðŸ”§ å…¼å®¹æ€§ï¼šåŠ¨æ€èŽ·å–å½“å‰çª—å£çš„é”å®šæœåŠ¡å™¨\n-    Object.defineProperty(window, 'windowLockedServer', {\n-      get: () => {\n-        const lock = this.getWindowServerLock()\n-        return lock ? lock.server : null\n-      },\n-      set: (value) => {\n-        if (value) {\n-          this.setWindowServerLock(value)\n-        } else {\n-          this.clearWindowServerLock()\n-        }\n-      }\n-    })\n+  // è¿žæŽ¥åˆ°æŒ‡å®šæœåŠ¡å™¨\n+  async connectToServer(serverUrl) {\n+    if (this.ws && this.isConnected && this.currentServer === serverUrl) {\n+      console.log(`âœ… [${WINDOW_ID}] å·²è¿žæŽ¥åˆ°æœåŠ¡å™¨: ${serverUrl}`)\n+      return true\n+    }\n \n-    Object.defineProperty(window, 'windowLockTimestamp', {\n-      get: () => {\n-        const lock = this.getWindowServerLock()\n-        return lock ? lock.timestamp : null\n-      }\n-    })\n+    // å…³é—­çŽ°æœ‰è¿žæŽ¥\n+    if (this.ws) {\n+      this.ws.close()\n+    }\n \n-    // ðŸ”§ ä¿ç•™åŽŸæœ‰çš„å…¨å±€å˜é‡åä½†ä½¿ç”¨çª—å£çº§åˆ«çš„å€¼ï¼ˆåŠ¨æ€èŽ·å–ï¼‰\n-    Object.defineProperty(window, 'currentWebSocketServer', {\n-      get: () => {\n-        return window.windowLockedServer\n-      },\n-      set: (value) => {\n-        window.windowLockedServer = value\n-      }\n-    })\n-\n-    Object.defineProperty(window, 'serverLockTimestamp', {\n-      get: () => {\n-        return window.windowLockTimestamp\n-      }\n-    })\n-\n-    // ðŸ”§ ä¸ºäº†å‘åŽå…¼å®¹ï¼Œä¿ç•™ pendingTasks å¼•ç”¨ä½†æŒ‡å‘çª—å£ä»»åŠ¡é˜Ÿåˆ—\n-    window.pendingTasks = this.windowTasks\n-  }\n-\n-  // ==================== WebSocket è¿žæŽ¥ç®¡ç†æ–¹æ³• ====================\n-\n-  // ðŸ”§ åˆå§‹åŒ– WebSocket è¿žæŽ¥ - é‡æž„ç‰ˆæœ¬ï¼ˆè§£å†³å¤šæœåŠ¡å™¨æ¶ˆæ¯è·¯ç”±é”™ä¹±ï¼‰\n-  async initializeWebSocket(targetServer = null) {\n     try {\n-      // ðŸ”§ å…³é”®ä¿®å¤ï¼šæ”¯æŒæŒ‡å®šç›®æ ‡æœåŠ¡å™¨ï¼Œç¡®ä¿ä»»åŠ¡-æœåŠ¡å™¨ç»‘å®šä¸€è‡´æ€§\n-      let baseUrl\n-      const currentLock = this.getWindowServerLock()\n+      const wsUrl = `${serverUrl.replace('http', 'ws')}/ws?clientId=${CLIENT_ID}`\n+      console.log(`ðŸ”Œ [${WINDOW_ID}] è¿žæŽ¥åˆ°: ${wsUrl}`)\n+      \n+      this.ws = new WebSocket(wsUrl)\n+      this.currentServer = serverUrl\n \n-      if (targetServer) {\n-        // å¦‚æžœæŒ‡å®šäº†ç›®æ ‡æœåŠ¡å™¨ï¼Œç›´æŽ¥ä½¿ç”¨\n-        baseUrl = targetServer\n-        console.log(`ðŸŽ¯ [${WINDOW_ID}] ä½¿ç”¨æŒ‡å®šçš„ç›®æ ‡æœåŠ¡å™¨: ${baseUrl}`)\n-      } else if (currentLock && currentLock.server) {\n-        // å¦‚æžœå½“å‰çª—å£å·²é”å®šæœåŠ¡å™¨ï¼Œä½¿ç”¨é”å®šçš„æœåŠ¡å™¨\n-        baseUrl = currentLock.server\n-        console.log(`ðŸ”’ [${WINDOW_ID}] ä½¿ç”¨çª—å£é”å®šçš„æœåŠ¡å™¨: ${baseUrl}`)\n-      } else {\n-        // å¦åˆ™ä»Žè´Ÿè½½å‡è¡¡å™¨èŽ·å–å¯ç”¨æœåŠ¡å™¨\n-        try {\n-          baseUrl = await loadBalancer.getAvailableServer()\n-          if (!baseUrl) {\n-            throw new Error('è´Ÿè½½å‡è¡¡å™¨è¿”å›žç©ºæœåŠ¡å™¨')\n-          }\n-          console.log(`âš–ï¸ [${WINDOW_ID}] ä»Žè´Ÿè½½å‡è¡¡å™¨èŽ·å–æœåŠ¡å™¨: ${baseUrl}`)\n-        } catch (lbError) {\n-          console.error('âŒ è´Ÿè½½å‡è¡¡å™¨é”™è¯¯:', lbError.message)\n-          throw new Error(`æ— æ³•èŽ·å–å¯ç”¨çš„ComfyUIæœåŠ¡å™¨: ${lbError.message}`)\n-        }\n-      }\n-\n-      // ðŸ”§ æ£€æŸ¥çŽ°æœ‰è¿žæŽ¥æ˜¯å¦ä¸Žç›®æ ‡æœåŠ¡å™¨ä¸€è‡´\n-      if (this.wsConnection && this.wsConnection.readyState === WebSocket.OPEN) {\n-        const currentWsServer = this.currentWebSocketServer || this.getWindowServerLock()?.server\n-        if (currentWsServer === baseUrl) {\n-          console.log(`âœ… [${WINDOW_ID}] WebSocketå·²è¿žæŽ¥åˆ°æ­£ç¡®æœåŠ¡å™¨: ${baseUrl}`)\n-          return true\n-        } else {\n-          console.log(`ðŸ”„ [${WINDOW_ID}] WebSocketæœåŠ¡å™¨ä¸åŒ¹é…ï¼Œéœ€è¦é‡è¿ž`)\n-          console.log(`   å½“å‰è¿žæŽ¥: ${currentWsServer}`)\n-          console.log(`   ç›®æ ‡æœåŠ¡å™¨: ${baseUrl}`)\n-          // å…³é—­çŽ°æœ‰è¿žæŽ¥ï¼Œå»ºç«‹æ–°è¿žæŽ¥\n-          this.wsConnection.close(1000, 'åˆ‡æ¢åˆ°æ­£ç¡®çš„æœåŠ¡å™¨')\n-          this.wsConnection = null\n-          this.isWsConnected = false\n-        }\n-      }\n-\n-      console.log(`ðŸ”Œ [${WINDOW_ID}] è¿žæŽ¥WebSocket: ${baseUrl}`)\n-\n-      // ðŸ”§ æž„å»ºWebSocket URL - ä½¿ç”¨å¢žå¼ºçš„å”¯ä¸€clientId\n-      let wsUrl\n-      if (baseUrl.startsWith('https://')) {\n-        wsUrl = baseUrl.replace('https://', 'wss://') + '/ws?clientId=' + WINDOW_CLIENT_ID\n-      } else {\n-        wsUrl = baseUrl.replace('http://', 'ws://') + '/ws?clientId=' + WINDOW_CLIENT_ID\n-      }\n-\n-      console.log(`ðŸ”— [${WINDOW_ID}] WebSocket URL: ${wsUrl}`)\n-      console.log(`ðŸ”‘ [${WINDOW_ID}] ä½¿ç”¨å¢žå¼ºclientId: ${WINDOW_CLIENT_ID}`)\n-\n-      // ç®€å•çš„HTTPè¿žæŽ¥æµ‹è¯•\n-      try {\n-        const testResponse = await fetch(`${baseUrl}/api/queue`, {\n-          method: 'GET',\n-          signal: AbortSignal.timeout(5000)\n-        })\n-        if (!testResponse.ok) {\n-          throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${testResponse.status}`)\n-        }\n-      } catch (httpError) {\n-        throw new Error(`ComfyUIæœåŠ¡å™¨ä¸å¯è¾¾: ${httpError.message}`)\n-      }\n-\n-      // ðŸ”§ è®°å½•å³å°†è¿žæŽ¥çš„æœåŠ¡å™¨ï¼Œç”¨äºŽåŽç»­éªŒè¯\n-      this.currentWebSocketServer = baseUrl\n-      this.wsConnection = new WebSocket(wsUrl)\n-\n       return new Promise((resolve, reject) => {\n         const timeout = setTimeout(() => {\n-          reject(new Error('WebSocket è¿žæŽ¥è¶…æ—¶'))\n+          reject(new Error('è¿žæŽ¥è¶…æ—¶'))\n         }, 10000)\n \n-        this.wsConnection.onopen = () => {\n-          this.isWsConnected = true\n+        this.ws.onopen = () => {\n+          this.isConnected = true\n           clearTimeout(timeout)\n-          this._showNotification(`[${WINDOW_ID}] WebSocketè¿žæŽ¥æˆåŠŸ`, 'success')\n-          this._logServerConsistency('WebSocketè¿žæŽ¥æˆåŠŸ')\n+          console.log(`âœ… [${WINDOW_ID}] WebSocketè¿žæŽ¥æˆåŠŸ: ${serverUrl}`)\n           resolve(true)\n         }\n \n-        this.wsConnection.onerror = (error) => {\n-          this.isWsConnected = false\n+        this.ws.onerror = (error) => {\n+          this.isConnected = false\n           clearTimeout(timeout)\n-          console.error('âŒ WebSocketè¿žæŽ¥é”™è¯¯:', error)\n-          reject(new Error('WebSocketè¿žæŽ¥å¤±è´¥'))\n+          console.error(`âŒ [${WINDOW_ID}] WebSocketè¿žæŽ¥å¤±è´¥:`, error)\n+          reject(error)\n         }\n \n-        this.wsConnection.onclose = (event) => {\n-          this.isWsConnected = false\n-          console.log(`ðŸ”Œ [${WINDOW_ID}] WebSocketè¿žæŽ¥å…³é—­: ${event.code} - ${event.reason}`)\n-\n-          // ðŸ”§ å¦‚æžœä¸æ˜¯æ­£å¸¸å…³é—­ï¼Œå°è¯•é‡è¿ž\n-          if (event.code !== 1000 && event.code !== 1001) {\n-            console.log(`ðŸ”„ [${WINDOW_ID}] éžæ­£å¸¸å…³é—­ï¼Œå‡†å¤‡é‡è¿ž...`)\n-            setTimeout(() => {\n-              if (!this.isWsConnected) {\n-                console.log(`ðŸ”„ [${WINDOW_ID}] æ‰§è¡ŒWebSocketé‡è¿ž`)\n-                this.initializeWebSocket(baseUrl).catch(error => {\n-                  console.error('âŒ WebSocketé‡è¿žå¤±è´¥:', error)\n-                })\n-              }\n-            }, 3000)\n-          }\n+        this.ws.onclose = () => {\n+          this.isConnected = false\n+          console.log(`ðŸ”Œ [${WINDOW_ID}] WebSocketè¿žæŽ¥å…³é—­`)\n         }\n \n-        this.wsConnection.onmessage = (event) => {\n+        // æ ¸å¿ƒæ¶ˆæ¯å¤„ç† - åŸºäºŽå®˜æ–¹æ ·ä¾‹\n+        this.ws.onmessage = (event) => {\n           try {\n-            const message = event.data\n-\n-            // ðŸ”§ å¢žå¼ºæ¶ˆæ¯è¿‡æ»¤ï¼šåªå¤„ç†å½“å‰çª—å£çš„æ¶ˆæ¯\n-            if (typeof message === 'object' && message.windowId && message.windowId !== WINDOW_ID) {\n-              console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„æ¶ˆæ¯: ${message.windowId}`)\n-              return\n-            }\n-\n-            // å®˜æ–¹æ ‡å‡†ï¼šåªå¤„ç†å­—ç¬¦ä¸²æ¶ˆæ¯\n-            if (typeof message === 'string') {\n-              try {\n-                const parsedMessage = JSON.parse(message)\n-\n-                // è°ƒç”¨é‡æž„åŽçš„æ¶ˆæ¯å¤„ç†å‡½æ•°\n-                this.handleWebSocketMessage(parsedMessage)\n-              } catch (parseError) {\n-                console.error('âŒ [OFFICIAL] JSONè§£æžå¤±è´¥:', parseError.message)\n-              }\n-            }\n-\n+            const message = JSON.parse(event.data)\n+            this._handleMessage(message)\n           } catch (error) {\n-            console.error('âŒ [OFFICIAL] WebSocketæ¶ˆæ¯å¤„ç†å¤±è´¥:', error)\n+            console.error(`âŒ [${WINDOW_ID}] æ¶ˆæ¯è§£æžå¤±è´¥:`, error)\n           }\n         }\n       })\n     } catch (error) {\n-      console.error('âŒ åˆå§‹åŒ– WebSocket å¤±è´¥:', error)\n-\n-      // ðŸ”§ æ ¹æ®é”™è¯¯ç±»åž‹å†³å®šæ˜¯å¦æ¸…é™¤æœåŠ¡å™¨é”å®š\n-      if (error.message.includes('è´Ÿè½½å‡è¡¡å™¨') || error.message.includes('æ— æ³•èŽ·å–å¯ç”¨çš„ComfyUIæœåŠ¡å™¨')) {\n-        // å¦‚æžœæ˜¯è´Ÿè½½å‡è¡¡å™¨é”™è¯¯ï¼Œæ¸…é™¤æœåŠ¡å™¨é”å®š\n-        this.currentWebSocketServer = null\n-        this.clearWindowServerLock()\n-        console.log('ðŸ”“ è´Ÿè½½å‡è¡¡å™¨é”™è¯¯ï¼Œæ¸…é™¤æœåŠ¡å™¨é”å®š')\n-      } else if (error.message.includes('ComfyUIæœåŠ¡å™¨ä¸å¯è¾¾') || error.message.includes('WebSocket è¿žæŽ¥è¶…æ—¶')) {\n-        // å¦‚æžœæ˜¯è¿žæŽ¥é”™è¯¯ä½†æœåŠ¡å™¨å¯èƒ½æ¢å¤ï¼Œä¿æŒé”å®šä»¥ä¾¿é‡è¯•\n-        console.log('ðŸ”’ è¿žæŽ¥é”™è¯¯ä½†ä¿æŒæœåŠ¡å™¨é”å®šä»¥ä¾¿é‡è¯•')\n-      } else {\n-        // å…¶ä»–æœªçŸ¥é”™è¯¯ï¼Œæ¸…é™¤é”å®š\n-        this.currentWebSocketServer = null\n-        this.clearWindowServerLock()\n-        console.log('ðŸ”“ æœªçŸ¥é”™è¯¯ï¼Œæ¸…é™¤æœåŠ¡å™¨é”å®š')\n-      }\n-\n+      console.error(`âŒ [${WINDOW_ID}] è¿žæŽ¥å¤±è´¥:`, error)\n       throw error\n     }\n   }\n \n-  // ðŸ”§ èŽ·å–å½“å‰çª—å£çš„æœåŠ¡å™¨é”å®šä¿¡æ¯\n-  getWindowServerLock() {\n-    return this.WINDOW_SERVER_LOCKS.get(WINDOW_ID) || null\n-  }\n+  // æ¶ˆæ¯å¤„ç† - åŸºäºŽå®˜æ–¹ websockets_api_example.py ç¬¬37-40è¡Œ\n+  _handleMessage(message) {\n+    const { type, data } = message\n \n-  // ðŸ”§ è®¾ç½®å½“å‰çª—å£çš„æœåŠ¡å™¨é”å®šä¿¡æ¯\n-  setWindowServerLock(server, timestamp = Date.now()) {\n-    this.WINDOW_SERVER_LOCKS.set(WINDOW_ID, {\n-      server,\n-      timestamp,\n-      windowId: WINDOW_ID,\n-      clientId: WINDOW_CLIENT_ID\n-    })\n-    console.log(`ðŸ”’ [${WINDOW_ID}] è®¾ç½®çª—å£æœåŠ¡å™¨é”å®š: ${server}`)\n-  }\n-\n-  // ðŸ”§ æ¸…é™¤å½“å‰çª—å£çš„æœåŠ¡å™¨é”å®šä¿¡æ¯\n-  clearWindowServerLock() {\n-    const lock = this.WINDOW_SERVER_LOCKS.get(WINDOW_ID)\n-    if (lock) {\n-      this.WINDOW_SERVER_LOCKS.delete(WINDOW_ID)\n-      console.log(`ðŸ”“ [${WINDOW_ID}] æ¸…é™¤çª—å£æœåŠ¡å™¨é”å®š: ${lock.server}`)\n-    }\n-  }\n-\n-  // ðŸ”§ åŠ¨æ€æœåŠ¡å™¨é”å®šç®¡ç†ï¼ˆåŸºäºŽä»»åŠ¡çŠ¶æ€çš„æ™ºèƒ½é”å®šï¼‰\n-  lockServerForWindow(serverUrl) {\n-    const timestamp = Date.now()\n-    this.setWindowServerLock(serverUrl, timestamp)\n-\n-    console.log(`ðŸ”’ [${WINDOW_ID}] é”å®šæœåŠ¡å™¨: ${serverUrl}`)\n-    console.log(`ðŸ• [${WINDOW_ID}] é”å®šæ—¶é—´: ${new Date(timestamp).toLocaleTimeString()}`)\n-    console.log(`ðŸŽ¯ [${WINDOW_ID}] é”å®šæ¨¡å¼: ä»»åŠ¡é©±åŠ¨åŠ¨æ€é”å®šï¼ˆæ— å›ºå®šè¶…æ—¶ï¼‰`)\n-    console.log(`ðŸªŸ [${WINDOW_ID}] çª—å£éš”ç¦»: ç‹¬ç«‹é”å®šï¼Œä¸å½±å“å…¶ä»–çª—å£`)\n-\n-    // ðŸ”§ å®žçŽ°åŠ¨æ€é”å®šæœºåˆ¶ï¼šåœ¨ä»»åŠ¡å®Œæˆå‰ä¸è§£é”æœåŠ¡å™¨\n-    this.scheduleServerUnlockCheck()\n-  }\n-\n-  unlockServerForWindow() {\n-    const currentLock = this.getWindowServerLock()\n-    if (currentLock) {\n-      const lockDuration = Date.now() - currentLock.timestamp\n-      console.log(`ðŸ”“ [${WINDOW_ID}] è§£é”æœåŠ¡å™¨: ${currentLock.server}`)\n-      console.log(`â±ï¸ [${WINDOW_ID}] é”å®šæŒç»­æ—¶é—´: ${Math.round(lockDuration / 1000)}ç§’`)\n-      console.log(`ðŸ“Š [${WINDOW_ID}] è§£é”æ—¶ä»»åŠ¡æ•°: ${this.windowTasks.size}`)\n-      console.log(`ðŸªŸ [${WINDOW_ID}] çª—å£éš”ç¦»: ä»…è§£é”å½“å‰çª—å£ï¼Œä¸å½±å“å…¶ä»–çª—å£`)\n-\n-      this.clearWindowServerLock()\n-\n-      // æ¸…ç†è§£é”æ£€æŸ¥å®šæ—¶å™¨\n-      this.clearServerUnlockTimer()\n-    }\n-  }\n-\n-  // ðŸ”§ å¼ºåˆ¶è§£é”æœåŠ¡å™¨ï¼ˆç”¨äºŽå¼‚å¸¸æƒ…å†µå¤„ç†ï¼‰\n-  forceUnlockServerForWindow() {\n-    const currentLock = this.getWindowServerLock()\n-    if (currentLock) {\n-      console.log(`ðŸš¨ [${WINDOW_ID}] å¼ºåˆ¶è§£é”æœåŠ¡å™¨: ${currentLock.server}`)\n-      console.log(`âš ï¸ [${WINDOW_ID}] å½“å‰ä»æœ‰ ${this.windowTasks.size} ä¸ªå¾…å¤„ç†ä»»åŠ¡`)\n-      console.log(`ðŸªŸ [${WINDOW_ID}] çª—å£éš”ç¦»: å¼ºåˆ¶è§£é”ä»…å½±å“å½“å‰çª—å£`)\n-      this.unlockServerForWindow()\n-      return true\n-    }\n-    return false\n-  }\n-\n-  // ðŸ”§ çª—å£çº§åˆ«çš„ä»»åŠ¡ç®¡ç†å‡½æ•° - å®Œå…¨éš”ç¦»ç‰ˆæœ¬\n-  registerWindowTask(promptId, task) {\n-    let currentLock = this.getWindowServerLock()\n-\n-    // ðŸ”§ æ™ºèƒ½éªŒè¯ï¼šå¦‚æžœæœåŠ¡å™¨æœªé”å®šï¼Œè‡ªåŠ¨é”å®šåˆ°å½“å‰APIæœåŠ¡å™¨\n-    if (!currentLock || !currentLock.server) {\n-      console.warn(`âš ï¸ [${WINDOW_ID}] æ³¨å†Œä»»åŠ¡æ—¶æœåŠ¡å™¨æœªé”å®šï¼Œå°è¯•è‡ªåŠ¨é”å®š...`)\n-      try {\n-        // ä½¿ç”¨å½“å‰ä»»åŠ¡çš„æ‰§è¡ŒæœåŠ¡å™¨æˆ–é»˜è®¤APIæœåŠ¡å™¨\n-        const serverToLock = task.executionServer || this._getDefaultServerUrl()\n-        this.lockServerForWindow(serverToLock)\n-        currentLock = this.getWindowServerLock()\n-        console.log(`ðŸ”’ [${WINDOW_ID}] è‡ªåŠ¨é”å®šæœåŠ¡å™¨: ${serverToLock}`)\n-      } catch (lockError) {\n-        console.error(`âŒ [${WINDOW_ID}] è‡ªåŠ¨é”å®šå¤±è´¥: ${lockError.message}`)\n-        // ç»§ç»­æ‰§è¡Œï¼Œä½†è®°å½•è­¦å‘Š\n-        console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡ ${promptId} å°†åœ¨æ— é”å®šçŠ¶æ€ä¸‹æ³¨å†Œ`)\n+    // åªå¤„ç† executing æ¶ˆæ¯ï¼Œæ£€æµ‹ä»»åŠ¡å®Œæˆ\n+    if (type === 'executing' && data) {\n+      const { node, prompt_id } = data\n+      \n+      // ä»»åŠ¡å®Œæˆæ£€æµ‹ï¼šnode ä¸º null è¡¨ç¤ºæ‰§è¡Œå®Œæˆ\n+      if (node === null && prompt_id) {\n+        console.log(`ðŸŽ‰ [${WINDOW_ID}] ä»»åŠ¡å®Œæˆ: ${prompt_id}`)\n+        this._handleTaskCompletion(prompt_id)\n+      } else if (node && prompt_id) {\n+        // ä»»åŠ¡æ‰§è¡Œä¸­\n+        console.log(`ðŸ”„ [${WINDOW_ID}] æ‰§è¡ŒèŠ‚ç‚¹: ${node} (ä»»åŠ¡: ${prompt_id})`)\n+        this._handleTaskProgress(prompt_id, `æ‰§è¡ŒèŠ‚ç‚¹: ${node}`, 50)\n       }\n     }\n \n-    // ðŸ”§ æ™ºèƒ½ç»‘å®šæœåŠ¡å™¨ï¼šä¼˜å…ˆä½¿ç”¨é”å®šæœåŠ¡å™¨ï¼Œå¦åˆ™ä½¿ç”¨ä»»åŠ¡è‡ªå¸¦çš„æœåŠ¡å™¨\n-    if (currentLock && currentLock.server) {\n-      task.executionServer = currentLock.server\n-    } else if (!task.executionServer) {\n-      // å¦‚æžœéƒ½æ²¡æœ‰ï¼Œä½¿ç”¨é»˜è®¤é…ç½®\n-      task.executionServer = this._getDefaultServerUrl()\n-      console.warn(`âš ï¸ [${WINDOW_ID}] ä½¿ç”¨é»˜è®¤æœåŠ¡å™¨ç»‘å®šä»»åŠ¡: ${task.executionServer}`)\n+    // å¤„ç†å…¶ä»–æ¶ˆæ¯ç±»åž‹\n+    if (type === 'progress' && data && data.prompt_id) {\n+      this._handleTaskProgress(data.prompt_id, 'å¤„ç†ä¸­...', data.value || 0)\n     }\n \n-    task.windowId = WINDOW_ID\n-    task.clientId = WINDOW_CLIENT_ID\n-    task.registeredAt = Date.now()\n-    task.lockInfo = currentLock ? { ...currentLock } : null // ä¿å­˜é”å®šä¿¡æ¯å¿«ç…§\n-\n-    this.windowTasks.set(promptId, task)\n-\n-    console.log(`ðŸ“ [${WINDOW_ID}] ä»»åŠ¡å·²æ³¨å†Œ: ${promptId}, ç»‘å®šæœåŠ¡å™¨: ${task.executionServer}`)\n-    console.log(`ðŸ“Š [${WINDOW_ID}] å½“å‰çª—å£ä»»åŠ¡æ•°: ${this.windowTasks.size}`)\n-    console.log(`ðŸ”’ [${WINDOW_ID}] ä»»åŠ¡é”å®šä¿¡æ¯:`, task.lockInfo)\n-\n-    // ðŸ”§ é”å®šç»­æœŸï¼šæ£€æµ‹åˆ°æ–°ä»»åŠ¡æ—¶è‡ªåŠ¨ç»­æœŸé”å®šçŠ¶æ€\n-    if (currentLock) {\n-      console.log(`ðŸ”„ [${WINDOW_ID}] æ£€æµ‹åˆ°æ–°ä»»åŠ¡ï¼Œç»­æœŸæœåŠ¡å™¨é”å®šçŠ¶æ€`)\n-      // é‡æ–°è°ƒåº¦è§£é”æ£€æŸ¥\n-      this.scheduleServerUnlockCheck()\n+    if (type === 'execution_error' && data && data.prompt_id) {\n+      this._handleTaskError(data.prompt_id, data.exception_message || 'æ‰§è¡Œé”™è¯¯')\n     }\n   }\n \n-  getWindowTask(promptId) {\n-    const task = this.windowTasks.get(promptId)\n-    if (task) {\n-      // ðŸ”§ ç®€åŒ–æ£€æµ‹ï¼šå¦‚æžœä»»åŠ¡å­˜åœ¨å°±è¿”å›žï¼Œä¸ä¸¥æ ¼æ£€æŸ¥çª—å£å½’å±ž\n-      // è¿™æ ·å¯ä»¥é¿å…å› çª—å£IDä¸åŒ¹é…å¯¼è‡´çš„ä»»åŠ¡ä¸¢å¤±\n-      if (task.windowId !== WINDOW_ID) {\n-        console.log(`ðŸ” [${WINDOW_ID}] ä½¿ç”¨å…¶ä»–çª—å£çš„ä»»åŠ¡: ${promptId} (åŽŸçª—å£: ${task.windowId})`)\n-      }\n-      return task\n+  // ä»»åŠ¡è¿›åº¦å¤„ç†\n+  _handleTaskProgress(promptId, message, progress) {\n+    const task = this.tasks.get(promptId)\n+    if (task && task.onProgress) {\n+      task.onProgress(message, progress)\n     }\n-\n-    return null\n   }\n \n-  removeWindowTask(promptId) {\n-    const task = this.windowTasks.get(promptId)\n-    if (task && task.windowId === WINDOW_ID) {\n-      this.windowTasks.delete(promptId)\n-      console.log(`ðŸ—‘ï¸ [${WINDOW_ID}] ä»»åŠ¡å·²ç§»é™¤: ${promptId}`)\n-      console.log(`ðŸ“Š [${WINDOW_ID}] å‰©ä½™çª—å£ä»»åŠ¡æ•°: ${this.windowTasks.size}`)\n-\n-      // ðŸ”§ ä»»åŠ¡ç§»é™¤åŽç«‹å³æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n-      const currentLock = this.getWindowServerLock()\n-      if (this.windowTasks.size === 0 && currentLock) {\n-        console.log(`ðŸ”“ [${WINDOW_ID}] æœ€åŽä¸€ä¸ªä»»åŠ¡å®Œæˆï¼Œç«‹å³è§£é”æœåŠ¡å™¨`)\n-        this.unlockServerForWindow()\n-      } else if (this.windowTasks.size > 0) {\n-        console.log(`ðŸ”’ [${WINDOW_ID}] ä»æœ‰ä»»åŠ¡è¿è¡Œï¼Œä¿æŒæœåŠ¡å™¨é”å®š`)\n-      }\n-\n-      return true\n+  // ä»»åŠ¡å®Œæˆå¤„ç† - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬47-56è¡Œ\n+  async _handleTaskCompletion(promptId) {\n+    const task = this.tasks.get(promptId)\n+    if (!task) {\n+      console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡ä¸å­˜åœ¨: ${promptId}`)\n+      return\n     }\n-    return false\n-  }\n \n-  // ðŸ”§ æ–°å¢žï¼šæ ¹æ®ä»»åŠ¡IDèŽ·å–ç»‘å®šçš„æœåŠ¡å™¨åœ°å€\n-  getTaskBoundServer(promptId) {\n-    const task = this.getWindowTask(promptId)\n-    if (task && task.executionServer) {\n-      console.log(`ðŸŽ¯ [${WINDOW_ID}] ä»»åŠ¡ ${promptId} ç»‘å®šæœåŠ¡å™¨: ${task.executionServer}`)\n-      return task.executionServer\n-    }\n-    console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡ ${promptId} æœªæ‰¾åˆ°ç»‘å®šæœåŠ¡å™¨`)\n-    return null\n-  }\n-\n-  // ðŸ”§ èŽ·å–é»˜è®¤æœåŠ¡å™¨URLçš„è¾…åŠ©æ–¹æ³•\n-  _getDefaultServerUrl() {\n-    // è¿™é‡Œéœ€è¦ä»Žé…ç½®ä¸­èŽ·å–ï¼Œæš‚æ—¶è¿”å›žä¸€ä¸ªé»˜è®¤å€¼\n-    // åœ¨å®žé™…ä½¿ç”¨æ—¶ä¼šé€šè¿‡ä¾èµ–æ³¨å…¥æˆ–é…ç½®ä¼ å…¥\n-    return 'http://localhost:8188'\n-  }\n-\n-  // ðŸ”§ çª—å£é—´é€šä¿¡æœºåˆ¶ï¼ˆç”¨äºŽè°ƒè¯•å’Œç›‘æŽ§ï¼‰\n-  broadcastTaskStatus(promptId, status) {\n     try {\n-      const message = {\n-        type: 'task_status',\n-        windowId: WINDOW_ID,\n-        clientId: WINDOW_CLIENT_ID,\n-        promptId: promptId,\n-        status: status,\n-        timestamp: Date.now()\n+      // èŽ·å–ä»»åŠ¡åŽ†å² - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬47è¡Œ\n+      const history = await this._getHistory(promptId)\n+      \n+      // æå–ç»“æžœ - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬48-56è¡Œ\n+      const result = this._extractResults(history, promptId)\n+      \n+      console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`)\n+      \n+      // è°ƒç”¨å®Œæˆå›žè°ƒ\n+      if (task.onComplete) {\n+        task.onComplete(result)\n       }\n-\n-      localStorage.setItem(`comfyui_task_${promptId}`, JSON.stringify(message))\n-      console.log(`ðŸ“¡ [${WINDOW_ID}] å¹¿æ’­ä»»åŠ¡çŠ¶æ€: ${promptId} -> ${status}`)\n     } catch (error) {\n-      console.warn(`âš ï¸ [${WINDOW_ID}] å¹¿æ’­ä»»åŠ¡çŠ¶æ€å¤±è´¥:`, error)\n+      console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–å¤±è´¥: ${promptId}`, error)\n+      if (task.onError) {\n+        task.onError(error)\n+      }\n+    } finally {\n+      // æ¸…ç†ä»»åŠ¡\n+      this.tasks.delete(promptId)\n+      \n+      // æ£€æŸ¥æ˜¯å¦éœ€è¦è§£é”æœåŠ¡å™¨\n+      this._checkUnlock()\n     }\n   }\n \n-  // ðŸ”§ åŽŸå­æ€§ä»»åŠ¡çŠ¶æ€æ›´æ–°å‡½æ•° - çª—å£éš”ç¦»ç‰ˆæœ¬\n-  updateTaskStatus(promptId, newStatus, additionalData = {}) {\n-    // ðŸ”§ åªå¤„ç†å±žäºŽå½“å‰çª—å£çš„ä»»åŠ¡\n-    const task = this.getWindowTask(promptId)\n-    if (!task) {\n-      console.warn(`âš ï¸ [${WINDOW_ID}] å°è¯•æ›´æ–°ä¸å­˜åœ¨æˆ–ä¸å±žäºŽå½“å‰çª—å£çš„ä»»åŠ¡çŠ¶æ€: ${promptId}`)\n-      return false\n+  // ä»»åŠ¡é”™è¯¯å¤„ç†\n+  _handleTaskError(promptId, errorMessage) {\n+    const task = this.tasks.get(promptId)\n+    if (task && task.onError) {\n+      task.onError(new Error(errorMessage))\n     }\n-\n-    const oldStatus = task.status\n-    task.status = newStatus\n-    task.lastStatusUpdate = Date.now()\n-\n-    // åˆå¹¶é¢å¤–æ•°æ®\n-    Object.assign(task, additionalData)\n-\n-    console.log(`ðŸ”„ [${WINDOW_ID}] ä»»åŠ¡çŠ¶æ€å˜æ›´: ${promptId} ${oldStatus} â†’ ${newStatus}`)\n-\n-    // ðŸ”§ å¹¿æ’­ä»»åŠ¡çŠ¶æ€å˜æ›´\n-    this.broadcastTaskStatus(promptId, newStatus)\n-\n-    return true\n+    this.tasks.delete(promptId)\n+    this._checkUnlock()\n   }\n \n-  // ðŸ”§ åŠ¨æ€è§£é”æ£€æŸ¥æœºåˆ¶\n-  // ðŸ”§ è°ƒåº¦æœåŠ¡å™¨è§£é”æ£€æŸ¥ï¼ˆå®šæœŸæ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼‰\n-  scheduleServerUnlockCheck() {\n-    // æ¸…ç†ä¹‹å‰çš„å®šæ—¶å™¨\n-    this.clearServerUnlockTimer()\n-\n-    // è®¾ç½®å®šæœŸæ£€æŸ¥ï¼ˆæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰\n-    this.serverUnlockTimer = setInterval(() => {\n-      this.checkServerUnlockCondition()\n-    }, 30000)\n-\n-    console.log(`â° [${WINDOW_ID}] å·²è°ƒåº¦åŠ¨æ€è§£é”æ£€æŸ¥ï¼ˆæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰`)\n-  }\n-\n-  // ðŸ”§ æ¸…ç†è§£é”æ£€æŸ¥å®šæ—¶å™¨\n-  clearServerUnlockTimer() {\n-    if (this.serverUnlockTimer) {\n-      clearInterval(this.serverUnlockTimer)\n-      this.serverUnlockTimer = null\n-      console.log(`ðŸ§¹ [${WINDOW_ID}] å·²æ¸…ç†è§£é”æ£€æŸ¥å®šæ—¶å™¨`)\n+  // èŽ·å–ä»»åŠ¡åŽ†å² - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬25-27è¡Œ\n+  async _getHistory(promptId) {\n+    const response = await fetch(`${this.currentServer}/api/history/${promptId}`)\n+    if (!response.ok) {\n+      throw new Error(`èŽ·å–åŽ†å²å¤±è´¥: ${response.status}`)\n     }\n+    return await response.json()\n   }\n \n-  // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨çš„å‡½æ•°ï¼ˆå¢žå¼ºç‰ˆæœ¬ï¼‰\n-  checkServerUnlockCondition() {\n-    const currentLock = this.getWindowServerLock()\n-    if (!currentLock) {\n-      // æœåŠ¡å™¨æœªé”å®šï¼Œæ¸…ç†å®šæ—¶å™¨\n-      this.clearServerUnlockTimer()\n-      return false\n+  // æå–ç»“æžœ - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬48-56è¡Œ\n+  _extractResults(history, promptId) {\n+    const taskData = history[promptId]\n+    if (!taskData || !taskData.outputs) {\n+      throw new Error(`ä»»åŠ¡ ${promptId} æ²¡æœ‰è¾“å‡ºæ•°æ®`)\n     }\n \n-    const taskCount = this.windowTasks.size\n-    const lockDuration = Date.now() - currentLock.timestamp\n-\n-    console.log(`ðŸ” [${WINDOW_ID}] è§£é”æ¡ä»¶æ£€æŸ¥:`)\n-    console.log(`   - å¾…å¤„ç†ä»»åŠ¡æ•°: ${taskCount}`)\n-    console.log(`   - é”å®šæŒç»­æ—¶é—´: ${Math.round(lockDuration / 1000)}ç§’`)\n-    console.log(`   - é”å®šæœåŠ¡å™¨: ${currentLock.server}`)\n-\n-    if (taskCount === 0) {\n-      console.log(`ðŸ”“ [${WINDOW_ID}] æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼Œè‡ªåŠ¨è§£é”æœåŠ¡å™¨`)\n-      this.unlockServerForWindow()\n-      return true\n-    } else {\n-      console.log(`ðŸ”’ [${WINDOW_ID}] ä»æœ‰ ${taskCount} ä¸ªå¾…å¤„ç†ä»»åŠ¡ï¼Œä¿æŒæœåŠ¡å™¨é”å®š`)\n-\n-      // åˆ—å‡ºå¾…å¤„ç†ä»»åŠ¡\n-      const taskIds = Array.from(this.windowTasks.keys())\n-      console.log(`ðŸ“‹ [${WINDOW_ID}] å¾…å¤„ç†ä»»åŠ¡: [${taskIds.join(', ')}]`)\n-\n-      // æ£€æŸ¥æ˜¯å¦æœ‰é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡\n-      const longRunningTasks = []\n-      this.windowTasks.forEach((task, promptId) => {\n-        const taskDuration = Date.now() - (task.registeredAt || currentLock.timestamp)\n-        if (taskDuration > 10 * 60 * 1000) { // è¶…è¿‡10åˆ†é’Ÿ\n-          longRunningTasks.push({ promptId, duration: Math.round(taskDuration / 1000) })\n-        }\n-      })\n-\n-      if (longRunningTasks.length > 0) {\n-        console.log(`âš ï¸ [${WINDOW_ID}] æ£€æµ‹åˆ°é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡:`)\n-        longRunningTasks.forEach(({ promptId, duration }) => {\n-          console.log(`   - ${promptId}: ${duration}ç§’`)\n-        })\n+    const results = {}\n+    for (const nodeId in taskData.outputs) {\n+      const nodeOutput = taskData.outputs[nodeId]\n+      if (nodeOutput.images) {\n+        results[nodeId] = nodeOutput.images\n       }\n     }\n-\n-    return false\n+    \n+    return results\n   }\n \n-  // ðŸ”§ æ–°å¢žï¼šç¡®ä¿WebSocketè¿žæŽ¥ä¸Žä»»åŠ¡æ‰§è¡ŒæœåŠ¡å™¨ä¸€è‡´æ€§\n-  async ensureWebSocketServerConsistency(taskServer) {\n+  // é€‰æ‹©æœ€ä½³æœåŠ¡å™¨\n+  async _selectBestServer() {\n     try {\n-      console.log(`ðŸ” [${WINDOW_ID}] æ£€æŸ¥WebSocketæœåŠ¡å™¨ä¸€è‡´æ€§...`)\n-      console.log(`ðŸŽ¯ [${WINDOW_ID}] ä»»åŠ¡æ‰§è¡ŒæœåŠ¡å™¨: ${taskServer}`)\n-\n-      const currentLock = this.getWindowServerLock()\n-      const lockedServer = currentLock?.server\n-      const wsServer = this.currentWebSocketServer\n-\n-      console.log(`ðŸ”’ [${WINDOW_ID}] å½“å‰é”å®šæœåŠ¡å™¨: ${lockedServer}`)\n-      console.log(`ðŸ”— [${WINDOW_ID}] WebSocketè¿žæŽ¥æœåŠ¡å™¨: ${wsServer}`)\n-\n-      // æ£€æŸ¥æ‰€æœ‰æœåŠ¡å™¨æ˜¯å¦ä¸€è‡´\n-      const serversMatch = taskServer === lockedServer && taskServer === wsServer\n-\n-      if (serversMatch && this.wsConnection && this.wsConnection.readyState === WebSocket.OPEN) {\n-        console.log(`âœ… [${WINDOW_ID}] æœåŠ¡å™¨ä¸€è‡´æ€§éªŒè¯é€šè¿‡`)\n-        return true\n-      }\n-\n-      // æœåŠ¡å™¨ä¸ä¸€è‡´ï¼Œéœ€è¦é‡æ–°å»ºç«‹è¿žæŽ¥\n-      console.log(`ðŸ”„ [${WINDOW_ID}] æœåŠ¡å™¨ä¸ä¸€è‡´ï¼Œé‡æ–°å»ºç«‹WebSocketè¿žæŽ¥`)\n-      console.log(`   ä»»åŠ¡æœåŠ¡å™¨: ${taskServer}`)\n-      console.log(`   é”å®šæœåŠ¡å™¨: ${lockedServer}`)\n-      console.log(`   WebSocketæœåŠ¡å™¨: ${wsServer}`)\n-\n-      // å…³é—­çŽ°æœ‰è¿žæŽ¥\n-      if (this.wsConnection) {\n-        this.wsConnection.close(1000, 'æœåŠ¡å™¨ä¸ä¸€è‡´ï¼Œé‡æ–°è¿žæŽ¥')\n-        this.wsConnection = null\n-        this.isWsConnected = false\n-      }\n-\n-      // é‡æ–°åˆå§‹åŒ–WebSocketè¿žæŽ¥åˆ°æ­£ç¡®çš„æœåŠ¡å™¨\n-      await this.initializeWebSocket(taskServer)\n-\n-      console.log(`âœ… [${WINDOW_ID}] WebSocketé‡æ–°è¿žæŽ¥åˆ°æ­£ç¡®æœåŠ¡å™¨: ${taskServer}`)\n-      return true\n-\n+      const bestServer = await loadBalancer.getBestServer()\n+      console.log(`ðŸŽ¯ [${WINDOW_ID}] é€‰æ‹©æœåŠ¡å™¨: ${bestServer}`)\n+      return bestServer\n     } catch (error) {\n-      console.error(`âŒ [${WINDOW_ID}] WebSocketæœåŠ¡å™¨ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥:`, error)\n+      console.error(`âŒ [${WINDOW_ID}] æœåŠ¡å™¨é€‰æ‹©å¤±è´¥:`, error)\n       throw error\n     }\n   }\n \n-  // ðŸ”§ æ–°å¢žï¼šç¡®ä¿WebSocketè¿žæŽ¥ - é‡æž„ç‰ˆæœ¬ï¼ˆæ”¯æŒä»»åŠ¡-æœåŠ¡å™¨ç»‘å®šä¸€è‡´æ€§ï¼‰\n-  async ensureWebSocketConnection(taskServer = null) {\n-    console.log(`ðŸ”Œ [${WINDOW_ID}] ç¡®ä¿WebSocketè¿žæŽ¥`)\n-\n-    if (taskServer) {\n-      console.log(`ðŸŽ¯ [${WINDOW_ID}] æŒ‡å®šä»»åŠ¡æœåŠ¡å™¨: ${taskServer}`)\n-\n-      // ðŸ”§ å…³é”®ä¿®å¤ï¼šå¦‚æžœæŒ‡å®šäº†ä»»åŠ¡æœåŠ¡å™¨ï¼Œç¡®ä¿WebSocketè¿žæŽ¥åˆ°æ­£ç¡®æœåŠ¡å™¨\n-      await this.ensureWebSocketServerConsistency(taskServer)\n-      return true\n+  // é”å®šæœåŠ¡å™¨\n+  _lockServer(serverUrl) {\n+    if (!this.lockedServer) {\n+      this.lockedServer = serverUrl\n+      this.lockTimestamp = Date.now()\n+      console.log(`ðŸ”’ [${WINDOW_ID}] é”å®šæœåŠ¡å™¨: ${serverUrl}`)\n     }\n-\n-    // å¦‚æžœå·²è¿žæŽ¥ï¼Œæ£€æŸ¥æœåŠ¡å™¨ä¸€è‡´æ€§\n-    if (this.wsConnection && this.wsConnection.readyState === WebSocket.OPEN && this.isWsConnected) {\n-      console.log(`âœ… [${WINDOW_ID}] WebSocketå·²è¿žæŽ¥`)\n-\n-      // å°è¯•é”å®šæœåŠ¡å™¨ï¼Œä½†å¤±è´¥ä¸å½±å“ç»§ç»­ä½¿ç”¨\n-      const currentLock = this.getWindowServerLock()\n-      if (!currentLock) {\n-        try {\n-          // è¿™é‡Œéœ€è¦å¤–éƒ¨æä¾› getApiBaseUrl å‡½æ•°\n-          console.log(`ðŸ”’ [${WINDOW_ID}] éœ€è¦è¡¥å……é”å®šæœåŠ¡å™¨ï¼Œä½†ç¼ºå°‘ getApiBaseUrl å‡½æ•°`)\n-        } catch (error) {\n-          console.warn(`âš ï¸ [${WINDOW_ID}] æœåŠ¡å™¨é”å®šå¤±è´¥ï¼Œä½†ç»§ç»­ä½¿ç”¨è¿žæŽ¥:`, error.message)\n-        }\n-      } else {\n-        console.log(`ðŸ”’ [${WINDOW_ID}] æœåŠ¡å™¨å·²é”å®š: ${currentLock.server}`)\n-\n-        // ðŸ”§ éªŒè¯WebSocketè¿žæŽ¥ä¸Žé”å®šæœåŠ¡å™¨çš„ä¸€è‡´æ€§\n-        const wsServer = this.currentWebSocketServer\n-        if (wsServer && wsServer !== currentLock.server) {\n-          console.log(`ðŸ”„ [${WINDOW_ID}] WebSocketæœåŠ¡å™¨ä¸Žé”å®šæœåŠ¡å™¨ä¸ä¸€è‡´ï¼Œé‡æ–°è¿žæŽ¥`)\n-          console.log(`   WebSocketæœåŠ¡å™¨: ${wsServer}`)\n-          console.log(`   é”å®šæœåŠ¡å™¨: ${currentLock.server}`)\n-\n-          // é‡æ–°è¿žæŽ¥åˆ°é”å®šçš„æœåŠ¡å™¨\n-          await this.initializeWebSocket(currentLock.server)\n-        }\n-      }\n-      return true\n-    }\n-\n-    // éœ€è¦å»ºç«‹æ–°è¿žæŽ¥\n-    console.log(`ðŸ”„ [${WINDOW_ID}] å»ºç«‹æ–°çš„WebSocketè¿žæŽ¥`)\n-\n-    try {\n-      await this.initializeWebSocket()\n-\n-      // ç»™è¿žæŽ¥ä¸€äº›æ—¶é—´ç¨³å®š\n-      await new Promise(resolve => setTimeout(resolve, 500))\n-\n-      if (!this.isWsConnected) {\n-        console.warn(`âš ï¸ [${WINDOW_ID}] WebSocketè¿žæŽ¥çŠ¶æ€å¼‚å¸¸ï¼Œä½†å°è¯•ç»§ç»­`)\n-      }\n-\n-      console.log(`âœ… [${WINDOW_ID}] WebSocketè¿žæŽ¥å®Œæˆ`)\n-      return true\n-\n-    } catch (error) {\n-      console.warn(`âš ï¸ [${WINDOW_ID}] WebSocketè¿žæŽ¥å¤±è´¥ï¼Œä½†ä¸é˜»æ­¢æ“ä½œ:`, error.message)\n-      // ðŸ”§ å…³é”®æ”¹è¿›ï¼šä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸é™çº§ä½¿ç”¨\n-      return false\n-    }\n   }\n \n-  // ðŸ”§ æ–°å¢žï¼šæ‰‹åŠ¨é‡ç½®WebSocketæœåŠ¡å™¨é”å®šçš„åŠŸèƒ½\n-  resetWebSocketServer(force = false) {\n-    const currentLock = this.getWindowServerLock()\n-    console.log('ðŸ”„ æ‰‹åŠ¨é‡ç½®WebSocketæœåŠ¡å™¨é”å®š')\n-    console.log('ðŸ”“ æ¸…é™¤æœåŠ¡å™¨é”å®š:', currentLock?.server || 'æ— ')\n-\n-    if (!force && this.windowTasks.size > 0) {\n-      console.log(`âš ï¸ æœ‰ ${this.windowTasks.size} ä¸ªå¾…å¤„ç†ä»»åŠ¡ï¼Œå»ºè®®ç­‰å¾…å®ŒæˆåŽå†é‡ç½®`)\n-      console.log('ðŸ’¡ å¦‚éœ€å¼ºåˆ¶é‡ç½®ï¼Œè¯·è°ƒç”¨: resetWebSocketServer(true)')\n-      return false\n+  // æ£€æŸ¥è§£é”æ¡ä»¶\n+  _checkUnlock() {\n+    if (this.tasks.size === 0 && this.lockedServer) {\n+      console.log(`ðŸ”“ [${WINDOW_ID}] è§£é”æœåŠ¡å™¨: ${this.lockedServer}`)\n+      this.lockedServer = null\n+      this.lockTimestamp = null\n     }\n-\n-    // æ¸…é™¤æœåŠ¡å™¨é”å®š\n-    this.unlockServerForWindow()\n-\n-    // å…³é—­çŽ°æœ‰WebSocketè¿žæŽ¥\n-    if (this.wsConnection) {\n-      console.log('ðŸ”Œ å…³é—­çŽ°æœ‰WebSocketè¿žæŽ¥')\n-      this.wsConnection.close(1000, 'æ‰‹åŠ¨é‡ç½®æœåŠ¡å™¨')\n-      this.wsConnection = null\n-      this.isWsConnected = false\n-    }\n-\n-    // æ¸…ç†æ‰€æœ‰å¾…å¤„ç†ä»»åŠ¡ï¼ˆå¦‚æžœå¼ºåˆ¶é‡ç½®ï¼‰\n-    if (force && this.windowTasks.size > 0) {\n-      console.log(`ðŸ§¹ å¼ºåˆ¶æ¸…ç† ${this.windowTasks.size} ä¸ªå¾…å¤„ç†ä»»åŠ¡`)\n-      const taskIds = Array.from(this.windowTasks.keys())\n-      for (const promptId of taskIds) {\n-        const task = this.windowTasks.get(promptId)\n-        if (task && task.onError) {\n-          task.onError('WebSocketæœåŠ¡å™¨å·²å¼ºåˆ¶é‡ç½®')\n-        }\n-        this.windowTasks.delete(promptId)\n-      }\n-    }\n-\n-    console.log('âœ… WebSocketæœåŠ¡å™¨é‡ç½®å®Œæˆ')\n-    return true\n   }\n \n-  // ðŸ”§ æ–°å¢žï¼šèŽ·å–å½“å‰WebSocketæœåŠ¡å™¨çŠ¶æ€çš„å‡½æ•°ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n-  getWebSocketServerStatus() {\n-    return {\n-      windowId: WINDOW_ID,\n-      clientId: WINDOW_CLIENT_ID,\n-      isConnected: this.isWsConnected,\n-      lockedServer: this.getWindowServerLock()?.server,\n-      lockTimestamp: this.getWindowServerLock()?.timestamp,\n-      lockDuration: this.getWindowServerLock()?.timestamp ? Date.now() - this.getWindowServerLock().timestamp : null,\n-      pendingTasksCount: this.windowTasks.size,\n-      connectionState: this.wsConnection?.readyState || 'CLOSED'\n-    }\n-  }\n-\n-  // ==================== WebSocket æ¶ˆæ¯å¤„ç†æ–¹æ³• ====================\n-\n-  // ðŸ”¥ é˜²æŠ–æœºåˆ¶ï¼šé¿å…é¢‘ç¹çš„è¿›åº¦å›žè°ƒè§¦å‘é€’å½’æ›´æ–°\n-  safeProgressCallback(promptId, task, message, percent) {\n-    if (!task.onProgress) return\n-\n-    // é˜²æŠ–ï¼šåŒä¸€ä»»åŠ¡çš„è¿›åº¦å›žè°ƒé—´éš”è‡³å°‘100ms\n-    const lastCallTime = this.progressCallbackDebounce.get(promptId) || 0\n-    const now = Date.now()\n-\n-    if (now - lastCallTime < 100) {\n-      console.log(`ðŸš« [${WINDOW_ID}] è¿›åº¦å›žè°ƒé˜²æŠ–: ${promptId} (${percent}%)`)\n-      return\n-    }\n-\n-    this.progressCallbackDebounce.set(promptId, now)\n-\n+  // æäº¤ä»»åŠ¡ - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬13-17è¡Œ\n+  async submitTask(workflow, promptId, callbacks = {}) {\n     try {\n-      // ðŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿å›žè°ƒåœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªçŽ¯ä¸­æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n-      setTimeout(() => {\n-        task.onProgress(message, percent)\n-      }, 0)\n-    } catch (error) {\n-      console.error(`âŒ [${WINDOW_ID}] è¿›åº¦å›žè°ƒæ‰§è¡Œå¤±è´¥: ${promptId}`, error.message)\n-    }\n-  }\n-\n-  // ðŸ”¥ ä¸»è¦çš„WebSocketæ¶ˆæ¯å¤„ç†å‡½æ•° - é‡æž„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n-  handleWebSocketMessage(message) {\n-    try {\n-      const { type, data } = message\n-\n-      // ðŸ”¥ ç®€åŒ–æ¶ˆæ¯è¿‡æ»¤ï¼šå¦‚æžœæ‰¾åˆ°ä»»åŠ¡å°±å¤„ç†ï¼Œä¸ä¸¥æ ¼é™åˆ¶çª—å£å½’å±ž\n-      if (data && data.prompt_id) {\n-        const task = this.getWindowTask(data.prompt_id)\n-        if (!task) {\n-          // ä»»åŠ¡ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯å…¶ä»–çª—å£çš„æ¶ˆæ¯ï¼Œé™é»˜å¿½ç•¥\n-          return\n-        }\n-\n-        // ðŸ”¥ éªŒè¯æ¶ˆæ¯æ¥æºæœåŠ¡å™¨ä¸€è‡´æ€§\n-        const currentLock = this.getWindowServerLock()\n-        if (currentLock && task.executionServer && task.executionServer !== currentLock.server) {\n-          console.warn(`âš ï¸ [${WINDOW_ID}] è·¨æœåŠ¡å™¨æ¶ˆæ¯æ£€æµ‹: ä»»åŠ¡åœ¨ ${task.executionServer}, å½“å‰é”å®š ${currentLock.server}`)\n-          // ä»ç„¶å¤„ç†æ¶ˆæ¯ï¼Œä½†è®°å½•è­¦å‘Šä»¥ä¾¿è°ƒè¯•\n-        }\n-\n-        // ðŸ”¥ è®°å½•æ¶ˆæ¯å¤„ç†æ—¥å¿—ï¼ˆç”¨äºŽè·¨æœåŠ¡å™¨è°ƒè¯•ï¼‰\n-        console.log(`ðŸ“¨ [${WINDOW_ID}] å¤„ç†æ¶ˆæ¯: ${type} (prompt_id: ${data.prompt_id}, æœåŠ¡å™¨: ${task.executionServer || 'æœªçŸ¥'})`)\n+      // é€‰æ‹©æœåŠ¡å™¨\n+      const serverUrl = this.lockedServer || await this._selectBestServer()\n+      \n+      // è¿žæŽ¥åˆ°æœåŠ¡å™¨\n+      await this.connectToServer(serverUrl)\n+      \n+      // é”å®šæœåŠ¡å™¨\n+      this._lockServer(serverUrl)\n+      \n+      // æ³¨å†Œä»»åŠ¡\n+      this.tasks.set(promptId, {\n+        ...callbacks,\n+        server: serverUrl,\n+        startTime: Date.now()\n+      })\n+      \n+      // æäº¤å·¥ä½œæµ - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬14-17è¡Œ\n+      const requestBody = {\n+        prompt: workflow,\n+        client_id: CLIENT_ID,\n+        prompt_id: promptId\n       }\n-\n-      // ðŸ”¥ è®°å½•æ‰€æœ‰æ¶ˆæ¯ç±»åž‹ç”¨äºŽè°ƒè¯•\n-      if (type !== 'status') {\n-        console.log(`ðŸ“¨ [OFFICIAL] æ”¶åˆ°æ¶ˆæ¯: ${type}`, data)\n+      \n+      const response = await fetch(`${serverUrl}/api/prompt`, {\n+        method: 'POST',\n+        headers: { 'Content-Type': 'application/json' },\n+        body: JSON.stringify(requestBody)\n+      })\n+      \n+      if (!response.ok) {\n+        throw new Error(`æäº¤å¤±è´¥: ${response.status}`)\n       }\n-\n-      // æ ¹æ®å®˜æ–¹WebSocket APIæ–‡æ¡£å¤„ç†æ‰€æœ‰æ ‡å‡†æ¶ˆæ¯ç±»åž‹\n-      switch (type) {\n-        case 'status':\n-          // æœåŠ¡å™¨çŠ¶æ€å’Œé˜Ÿåˆ—ä¿¡æ¯\n-          this.handleStatusMessage(data)\n-          break\n-\n-        case 'execution_start':\n-          // ä»»åŠ¡å¼€å§‹æ‰§è¡Œ - å®˜æ–¹æ ‡å‡†çŠ¶æ€æ£€æµ‹\n-          this.handleExecutionStartMessage(data)\n-          break\n-\n-        case 'executing':\n-          // èŠ‚ç‚¹æ‰§è¡ŒçŠ¶æ€ - å®˜æ–¹æ ‡å‡†å®Œæˆæ£€æµ‹\n-          this.handleExecutingMessage(data)\n-          break\n-\n-        case 'progress':\n-          // èŠ‚ç‚¹æ‰§è¡Œè¿›åº¦\n-          this.handleProgressMessage(data)\n-          break\n-\n-        case 'executed':\n-          // èŠ‚ç‚¹æ‰§è¡Œå®Œæˆ\n-          this.handleExecutedMessage(data)\n-          break\n-\n-        case 'execution_cached':\n-          // èŠ‚ç‚¹ç¼“å­˜å‘½ä¸­\n-          this.handleExecutionCachedMessage(data)\n-          break\n-\n-        case 'execution_error':\n-          // æ‰§è¡Œé”™è¯¯\n-          this.handleExecutionErrorMessage(data)\n-          break\n-\n-        case 'execution_interrupted':\n-          // æ‰§è¡Œä¸­æ–­\n-          this.handleExecutionInterruptedMessage(data)\n-          break\n-\n-        default:\n-          // è®°å½•æœªçŸ¥æ¶ˆæ¯ç±»åž‹ç”¨äºŽè°ƒè¯•\n-          console.log(`ðŸ” [OFFICIAL] æœªçŸ¥æ¶ˆæ¯ç±»åž‹: ${type}`, data)\n-      }\n-\n+      \n+      console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡æäº¤æˆåŠŸ: ${promptId}`)\n+      return promptId\n+      \n     } catch (error) {\n-      console.error('âŒ [OFFICIAL] æ¶ˆæ¯å¤„ç†å¤±è´¥:', error.message, message)\n+      // æ¸…ç†å¤±è´¥çš„ä»»åŠ¡\n+      this.tasks.delete(promptId)\n+      this._checkUnlock()\n+      throw error\n     }\n   }\n \n-  // ðŸ”¥ å¤„ç†æœåŠ¡å™¨çŠ¶æ€æ¶ˆæ¯ - é‡æž„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n-  handleStatusMessage(data) {\n-    if (!data || !data.status) {\n-      return\n-    }\n-\n-    // ðŸ”§ åªè®°å½•é˜Ÿåˆ—å˜åŒ–ï¼Œä¸å¤„ç†å…·ä½“ä»»åŠ¡ï¼ˆé¿å…è·¨çª—å£å¹²æ‰°ï¼‰\n-    const queueRunning = data.status.exec_info?.queue_remaining || 0\n-    if (queueRunning > 0) {\n-      console.log(`ðŸ“Š [${WINDOW_ID}] æœåŠ¡å™¨é˜Ÿåˆ—çŠ¶æ€: ${queueRunning} ä¸ªä»»åŠ¡ç­‰å¾…æ‰§è¡Œ`)\n-    }\n-\n-    // ðŸ”§ è§¦å‘çŠ¶æ€æ›´æ–°äº‹ä»¶ä¾›Vueç»„ä»¶ç›‘å¬\n-    if (typeof window !== 'undefined') {\n-      window.dispatchEvent(new CustomEvent('comfyui-queue-status', {\n-        detail: {\n-          queueRemaining: queueRunning,\n-          windowId: WINDOW_ID,\n-          timestamp: Date.now()\n-        }\n-      }))\n-    }\n-  }\n-\n-  // ðŸ”¥ å¤„ç†ä»»åŠ¡å¼€å§‹æ‰§è¡Œæ¶ˆæ¯ - é‡æž„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n-  handleExecutionStartMessage(data) {\n-    if (!data || !data.prompt_id) {\n-      return\n-    }\n-\n-    const promptId = data.prompt_id\n-\n-    // ðŸ”§ åªå¤„ç†å±žäºŽå½“å‰çª—å£çš„ä»»åŠ¡\n-    const task = this.getWindowTask(promptId)\n-    if (!task) {\n-      console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„æ‰§è¡Œå¼€å§‹æ¶ˆæ¯: ${promptId}`)\n-      return\n-    }\n-\n-    console.log(`ðŸš€ [${WINDOW_ID}] ä»»åŠ¡å¼€å§‹æ‰§è¡Œ: ${promptId}`)\n-\n-    // åŽŸå­æ€§çŠ¶æ€æ›´æ–°ï¼šwaiting â†’ executing\n-    this.updateTaskStatus(promptId, this.TASK_STATUS.EXECUTING, {\n-      executionStartTime: Date.now()\n-    })\n-\n-    // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n-    this.safeProgressCallback(promptId, task, 'ä»»åŠ¡å¼€å§‹æ‰§è¡Œ', 10)\n-  }\n-\n-  // ðŸ”¥ å¤„ç†èŠ‚ç‚¹æ‰§è¡Œè¿›åº¦æ¶ˆæ¯ - é‡æž„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n-  handleProgressMessage(data) {\n-    if (!data || !data.prompt_id || typeof data.value !== 'number' || typeof data.max !== 'number') {\n-      return\n-    }\n-\n-    const promptId = data.prompt_id\n-\n-    // ðŸ”§ åªå¤„ç†å±žäºŽå½“å‰çª—å£çš„ä»»åŠ¡\n-    const task = this.getWindowTask(promptId)\n-    if (!task || task.status !== this.TASK_STATUS.EXECUTING) {\n+  // ç­‰å¾…ä»»åŠ¡å®Œæˆ - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬33-40è¡Œçš„ while True é€»è¾‘\n+  async waitForCompletion(promptId, callbacks = {}) {\n+    return new Promise((resolve, reject) => {\n+      const task = this.tasks.get(promptId)\n       if (!task) {\n-        console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„è¿›åº¦æ¶ˆæ¯: ${promptId}`)\n-      }\n-      return\n-    }\n-\n-    // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”\n-    const percent = Math.round((data.value / data.max) * 100)\n-    const nodeInfo = data.node ? ` (èŠ‚ç‚¹: ${data.node})` : ''\n-\n-    console.log(`ðŸ“ˆ [${WINDOW_ID}] ä»»åŠ¡è¿›åº¦: ${promptId} - ${percent}%${nodeInfo}`)\n-\n-    // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n-    this.safeProgressCallback(promptId, task, `æ‰§è¡Œè¿›åº¦: ${percent}%${nodeInfo}`, Math.min(percent + 10, 90))\n-  }\n-\n-  // ðŸ”¥ å¤„ç†èŠ‚ç‚¹æ‰§è¡Œå®Œæˆæ¶ˆæ¯ - é‡æž„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n-  handleExecutedMessage(data) {\n-    if (!data || !data.prompt_id || !data.node) {\n-      return\n-    }\n-\n-    const promptId = data.prompt_id\n-\n-    // ðŸ”§ åªå¤„ç†å±žäºŽå½“å‰çª—å£çš„ä»»åŠ¡\n-    const task = this.getWindowTask(promptId)\n-    if (!task || task.status !== this.TASK_STATUS.EXECUTING) {\n-      if (!task) {\n-        console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„èŠ‚ç‚¹å®Œæˆæ¶ˆæ¯: ${promptId}`)\n-      }\n-      return\n-    }\n-\n-    console.log(`âœ… [${WINDOW_ID}] èŠ‚ç‚¹å®Œæˆ: ${data.node} (ä»»åŠ¡: ${promptId})`)\n-\n-    // è®°å½•å®Œæˆçš„èŠ‚ç‚¹\n-    if (!task.completedNodes) {\n-      task.completedNodes = []\n-    }\n-    task.completedNodes.push(data.node)\n-\n-    // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n-    this.safeProgressCallback(promptId, task, `èŠ‚ç‚¹ ${data.node} å®Œæˆ`, 60)\n-  }\n-\n-  // ðŸ”¥ å¤„ç†èŠ‚ç‚¹æ‰§è¡ŒçŠ¶æ€æ¶ˆæ¯ - å®˜æ–¹æ ‡å‡†å®Œæˆæ£€æµ‹ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n-  handleExecutingMessage(data) {\n-    if (!data || !data.prompt_id) {\n-      return\n-    }\n-\n-    const promptId = data.prompt_id\n-\n-    // ðŸ”§ åªå¤„ç†å±žäºŽå½“å‰çª—å£çš„ä»»åŠ¡\n-    const task = this.getWindowTask(promptId)\n-    if (!task) {\n-      console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„æ‰§è¡ŒçŠ¶æ€æ¶ˆæ¯: ${promptId}`)\n-      return\n-    }\n-\n-    // å®˜æ–¹æ ‡å‡†åŒé‡æ¡ä»¶æ£€æµ‹ï¼šdata.node === null && data.prompt_id === promptId\n-    if (data.node === null && data.prompt_id === promptId) {\n-      console.log(`ðŸŽ¯ [${WINDOW_ID}] ä»»åŠ¡æ‰§è¡Œå®Œæˆ: ${promptId}`)\n-\n-      // åŽŸå­æ€§çŠ¶æ€æ›´æ–°ï¼šexecuting â†’ completed\n-      this.updateTaskStatus(promptId, this.TASK_STATUS.COMPLETED, {\n-        completionTime: Date.now()\n-      })\n-\n-      // ç«‹å³å¤„ç†ä»»åŠ¡å®Œæˆ\n-      this.handleTaskCompletion(promptId)\n-    } else if (data.node) {\n-      // è®°å½•æ­£åœ¨æ‰§è¡Œçš„èŠ‚ç‚¹\n-      console.log(`ðŸ”„ [${WINDOW_ID}] æ­£åœ¨æ‰§è¡ŒèŠ‚ç‚¹: ${data.node} (ä»»åŠ¡: ${promptId})`)\n-\n-      // æ›´æ–°ä»»åŠ¡çš„å½“å‰æ‰§è¡ŒèŠ‚ç‚¹\n-      if (task) {\n-        task.currentNode = data.node\n-        this.safeProgressCallback(promptId, task, `æ­£åœ¨æ‰§è¡ŒèŠ‚ç‚¹: ${data.node}`, 30)\n-      }\n-    }\n-  }\n-\n-  // ðŸ”¥ å¤„ç†ä»»åŠ¡å®Œæˆçš„æ ¸å¿ƒå‡½æ•° - ä¿®å¤ç‰ˆæœ¬ï¼ˆæ¢å¤ç»“æžœèŽ·å–é€»è¾‘ï¼‰\n-  async handleTaskCompletion(promptId) {\n-    try {\n-      const task = this.getWindowTask(promptId)\n-      if (!task) {\n-        console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡å®Œæˆå¤„ç†å¤±è´¥: ä»»åŠ¡ä¸å­˜åœ¨ ${promptId}`)\n+        reject(new Error(`ä»»åŠ¡ä¸å­˜åœ¨: ${promptId}`))\n         return\n       }\n-\n-      console.log(`ðŸŽ‰ [${WINDOW_ID}] ä»»åŠ¡å®Œæˆå¤„ç†å¼€å§‹: ${promptId}`)\n-\n-      // ðŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›žè°ƒ\n-      this.safeProgressCallback(promptId, task, 'ä»»åŠ¡æ‰§è¡Œå®Œæˆ', 100)\n-\n-      // ðŸ”§ èŽ·å–ä»»åŠ¡åŽ†å²å’Œç»“æžœï¼ˆæ¢å¤é‡æž„å‰çš„é€»è¾‘ï¼‰\n-      let taskResult = null\n-      try {\n-        // åŠ¨æ€å¯¼å…¥ comfyui.js ä¸­çš„å‡½æ•°\n-        const comfyuiModule = await import('./comfyui.js')\n-        const { getTaskHistory, extractTaskResults } = comfyuiModule\n-\n-        console.log(`ðŸ“Š [${WINDOW_ID}] å¼€å§‹èŽ·å–ä»»åŠ¡ç»“æžœ: ${promptId}`)\n-        const history = await getTaskHistory()\n-        taskResult = await extractTaskResults(history, promptId)\n-        console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`, taskResult)\n-      } catch (error) {\n-        console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–å¤±è´¥: ${promptId}`, error)\n-        // ç»§ç»­æ‰§è¡Œï¼Œä½†ç»“æžœä¸ºnull\n-        taskResult = null\n-      }\n-\n-      // ç«‹å³æ¸…ç†ä»»åŠ¡\n-      this.removeWindowTask(promptId)\n-\n-      // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n-      this.checkServerUnlockCondition()\n-\n-      // è°ƒç”¨æˆåŠŸå›žè°ƒï¼Œä¼ é€’å®Œæ•´çš„ä»»åŠ¡ç»“æžœï¼ˆä¿®å¤ï¼šä½¿ç”¨onCompleteè€Œä¸æ˜¯onSuccessï¼‰\n-      if (task.onComplete) {\n-        // ðŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿æˆåŠŸå›žè°ƒç«‹å³æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n-        setTimeout(() => {\n-          task.onComplete(taskResult) // âœ… ä¿®å¤ï¼šä¼ é€’å®Œæ•´çš„ä»»åŠ¡ç»“æžœè€Œä¸æ˜¯åªä¼ é€’promptId\n-        }, 0)\n-      }\n-\n-      console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡å®Œæˆå¤„ç†ç»“æŸ: ${promptId}`)\n-\n-    } catch (error) {\n-      console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡å®Œæˆå¤„ç†å¤±è´¥: ${promptId}`, error.message)\n-\n-      // ç«‹å³æ¸…ç†ä»»åŠ¡å¹¶è°ƒç”¨é”™è¯¯å›žè°ƒ\n-      this.removeWindowTask(promptId)\n-\n-      // ðŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n-      this.checkServerUnlockCondition()\n-\n-      const task = this.getWindowTask(promptId)\n-      if (task && task.onError) {\n-        // ðŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿é”™è¯¯å›žè°ƒç«‹å³æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n-        setTimeout(() => {\n-          task.onError(error.message)\n-        }, 0)\n-      }\n-    }\n-  }\n-\n-  // ðŸ”¥ å¤„ç†èŠ‚ç‚¹ç¼“å­˜å‘½ä¸­æ¶ˆæ¯\n-  handleExecutionCachedMessage(data) {\n-    if (!data || !data.prompt_id) {\n-      return\n-    }\n-\n-    const promptId = data.prompt_id\n-    const task = this.getWindowTask(promptId)\n-    if (!task) {\n-      console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„ç¼“å­˜æ¶ˆæ¯: ${promptId}`)\n-      return\n-    }\n-\n-    console.log(`ðŸ’¾ [${WINDOW_ID}] èŠ‚ç‚¹ç¼“å­˜å‘½ä¸­: ${promptId}`)\n-    this.safeProgressCallback(promptId, task, 'ä½¿ç”¨ç¼“å­˜ç»“æžœ', 80)\n-  }\n-\n-  // ðŸ”¥ å¤„ç†æ‰§è¡Œé”™è¯¯æ¶ˆæ¯\n-  handleExecutionErrorMessage(data) {\n-    if (!data || !data.prompt_id) {\n-      return\n-    }\n-\n-    const promptId = data.prompt_id\n-    const task = this.getWindowTask(promptId)\n-    if (!task) {\n-      console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„é”™è¯¯æ¶ˆæ¯: ${promptId}`)\n-      return\n-    }\n-\n-    console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡æ‰§è¡Œé”™è¯¯: ${promptId}`, data)\n-\n-    // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºé”™è¯¯\n-    this.updateTaskStatus(promptId, this.TASK_STATUS.ERROR, {\n-      errorTime: Date.now(),\n-      errorData: data\n+      \n+      // æ›´æ–°å›žè°ƒ\n+      task.onComplete = resolve\n+      task.onError = reject\n+      task.onProgress = callbacks.onProgress || (() => {})\n+      \n+      console.log(`â³ [${WINDOW_ID}] ç­‰å¾…ä»»åŠ¡å®Œæˆ: ${promptId}`)\n     })\n-\n-    // æ¸…ç†ä»»åŠ¡å¹¶è°ƒç”¨é”™è¯¯å›žè°ƒ\n-    this.removeWindowTask(promptId)\n-    this.checkServerUnlockCondition()\n-\n-    if (task.onError) {\n-      setTimeout(() => {\n-        task.onError(data.exception_message || 'ä»»åŠ¡æ‰§è¡Œé”™è¯¯')\n-      }, 0)\n-    }\n   }\n \n-  // ðŸ”¥ å¤„ç†æ‰§è¡Œä¸­æ–­æ¶ˆæ¯\n-  handleExecutionInterruptedMessage(data) {\n-    if (!data || !data.prompt_id) {\n-      return\n+  // èŽ·å–çŠ¶æ€ä¿¡æ¯\n+  getStatus() {\n+    return {\n+      windowId: WINDOW_ID,\n+      clientId: CLIENT_ID,\n+      connected: this.isConnected,\n+      server: this.currentServer,\n+      lockedServer: this.lockedServer,\n+      taskCount: this.tasks.size\n     }\n-\n-    const promptId = data.prompt_id\n-    const task = this.getWindowTask(promptId)\n-    if (!task) {\n-      console.log(`ðŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„ä¸­æ–­æ¶ˆæ¯: ${promptId}`)\n-      return\n-    }\n-\n-    console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡æ‰§è¡Œä¸­æ–­: ${promptId}`)\n-\n-    // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºä¸­æ–­\n-    this.updateTaskStatus(promptId, this.TASK_STATUS.INTERRUPTED, {\n-      interruptTime: Date.now()\n-    })\n-\n-    // æ¸…ç†ä»»åŠ¡å¹¶è°ƒç”¨é”™è¯¯å›žè°ƒ\n-    this.removeWindowTask(promptId)\n-    this.checkServerUnlockCondition()\n-\n-    if (task.onError) {\n-      setTimeout(() => {\n-        task.onError('ä»»åŠ¡æ‰§è¡Œè¢«ä¸­æ–­')\n-      }, 0)\n-    }\n   }\n-\n-  // ðŸ”§ è¾…åŠ©æ–¹æ³•ï¼šæ˜¾ç¤ºé€šçŸ¥\n-  _showNotification(message, type = 'info') {\n-    const timestamp = new Date().toLocaleTimeString()\n-    const typeEmoji = {\n-      'success': 'âœ…',\n-      'error': 'âŒ',\n-      'warning': 'âš ï¸',\n-      'info': 'â„¹ï¸'\n-    }\n-\n-    console.log(`${typeEmoji[type] || 'â„¹ï¸'} [${timestamp}] ${message}`)\n-\n-    // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ä¾›Vueç»„ä»¶ç›‘å¬\n-    if (typeof window !== 'undefined') {\n-      window.dispatchEvent(new CustomEvent('comfyui-status', {\n-        detail: { message, type, timestamp }\n-      }))\n-    }\n-  }\n-\n-  // ðŸ”§ è¾…åŠ©æ–¹æ³•ï¼šè®°å½•æœåŠ¡å™¨ä¸€è‡´æ€§ä¿¡æ¯\n-  _logServerConsistency(context) {\n-    const currentLock = this.getWindowServerLock()\n-    const wsServer = this.currentWebSocketServer\n-\n-    console.log(`ðŸ” [${WINDOW_ID}] æœåŠ¡å™¨ä¸€è‡´æ€§æ£€æŸ¥ (${context}):`)\n-    console.log(`   - é”å®šæœåŠ¡å™¨: ${currentLock?.server || 'æ— '}`)\n-    console.log(`   - WebSocketæœåŠ¡å™¨: ${wsServer || 'æ— '}`)\n-    console.log(`   - è¿žæŽ¥çŠ¶æ€: ${this.isWsConnected ? 'å·²è¿žæŽ¥' : 'æœªè¿žæŽ¥'}`)\n-  }\n }\n-\n-// ç›‘å¬å…¶ä»–çª—å£çš„ä»»åŠ¡çŠ¶æ€ï¼ˆç”¨äºŽè°ƒè¯•ï¼‰\n-if (typeof window !== 'undefined') {\n-  window.addEventListener('storage', (e) => {\n-    if (e.key && e.key.startsWith('comfyui_task_')) {\n-      try {\n-        const message = JSON.parse(e.newValue)\n-        if (message.windowId !== WINDOW_ID) {\n-          console.log(`ðŸ“¡ [${WINDOW_ID}] æ”¶åˆ°å…¶ä»–çª—å£ä»»åŠ¡çŠ¶æ€: ${message.promptId} -> ${message.status} (æ¥è‡ªçª—å£: ${message.windowId})`)\n-        }\n-      } catch (error) {\n-        // å¿½ç•¥è§£æžé”™è¯¯\n-      }\n-    }\n-  })\n-}\n-\n-// åˆ›å»ºå…¨å±€å®žä¾‹\n-const webSocketManager = new WebSocketManager()\n-\n-// ðŸ”§ æš´éœ²æ ¸å¿ƒç®¡ç†å‡½æ•°åˆ°å…¨å±€ï¼Œç”¨äºŽæ•…éšœæ¢å¤\n-if (typeof window !== 'undefined') {\n-  window.resetWebSocketServer = webSocketManager.resetWebSocketServer.bind(webSocketManager)\n-  window.getWebSocketServerStatus = webSocketManager.getWebSocketServerStatus.bind(webSocketManager)\n-  window.pendingTasks = webSocketManager.windowTasks // ðŸ”§ æš´éœ²çª—å£çº§åˆ«çš„ä»»åŠ¡é˜Ÿåˆ—\n-\n-  // ðŸ”§ åŠ¨æ€é”å®šç®¡ç†å‡½æ•°\n-  window.forceUnlockServerForWindow = webSocketManager.forceUnlockServerForWindow.bind(webSocketManager)\n-\n-  console.log(`ðŸ”§ [${WINDOW_ID}] æ ¸å¿ƒç®¡ç†å‡½æ•°å·²æš´éœ²åˆ°å…¨å±€`)\n-}\n-\n-// å¯¼å‡ºå®žä¾‹å’Œç›¸å…³å¸¸é‡\n-export default webSocketManager\n-export { WINDOW_ID, WINDOW_CLIENT_ID }\n"
                },
                {
                    "date": 1753513103231,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -24,16 +24,16 @@\n     // WebSocket è¿žæŽ¥\n     this.ws = null\n     this.isConnected = false\n     this.currentServer = null\n-    \n+\n     // ä»»åŠ¡ç®¡ç† - åªä¿ç•™å½“å‰çª—å£çš„ä»»åŠ¡\n     this.tasks = new Map() // promptId -> { onComplete, onError, onProgress, server }\n-    \n+\n     // æœåŠ¡å™¨é”å®š - ç®€åŒ–ä¸ºçª—å£çº§åˆ«\n     this.lockedServer = null\n     this.lockTimestamp = null\n-    \n+\n     // åˆå§‹åŒ–çª—å£äº‹ä»¶\n     this._initWindowEvents()\n   }\n \n@@ -70,9 +70,9 @@\n \n     try {\n       const wsUrl = `${serverUrl.replace('http', 'ws')}/ws?clientId=${CLIENT_ID}`\n       console.log(`ðŸ”Œ [${WINDOW_ID}] è¿žæŽ¥åˆ°: ${wsUrl}`)\n-      \n+\n       this.ws = new WebSocket(wsUrl)\n       this.currentServer = serverUrl\n \n       return new Promise((resolve, reject) => {\n@@ -121,9 +121,9 @@\n \n     // åªå¤„ç† executing æ¶ˆæ¯ï¼Œæ£€æµ‹ä»»åŠ¡å®Œæˆ\n     if (type === 'executing' && data) {\n       const { node, prompt_id } = data\n-      \n+\n       // ä»»åŠ¡å®Œæˆæ£€æµ‹ï¼šnode ä¸º null è¡¨ç¤ºæ‰§è¡Œå®Œæˆ\n       if (node === null && prompt_id) {\n         console.log(`ðŸŽ‰ [${WINDOW_ID}] ä»»åŠ¡å®Œæˆ: ${prompt_id}`)\n         this._handleTaskCompletion(prompt_id)\n@@ -162,14 +162,14 @@\n \n     try {\n       // èŽ·å–ä»»åŠ¡åŽ†å² - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬47è¡Œ\n       const history = await this._getHistory(promptId)\n-      \n+\n       // æå–ç»“æžœ - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬48-56è¡Œ\n       const result = this._extractResults(history, promptId)\n-      \n+\n       console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`)\n-      \n+\n       // è°ƒç”¨å®Œæˆå›žè°ƒ\n       if (task.onComplete) {\n         task.onComplete(result)\n       }\n@@ -180,9 +180,9 @@\n       }\n     } finally {\n       // æ¸…ç†ä»»åŠ¡\n       this.tasks.delete(promptId)\n-      \n+\n       // æ£€æŸ¥æ˜¯å¦éœ€è¦è§£é”æœåŠ¡å™¨\n       this._checkUnlock()\n     }\n   }\n@@ -219,9 +219,9 @@\n       if (nodeOutput.images) {\n         results[nodeId] = nodeOutput.images\n       }\n     }\n-    \n+\n     return results\n   }\n \n   // é€‰æ‹©æœ€ä½³æœåŠ¡å™¨\n@@ -258,42 +258,42 @@\n   async submitTask(workflow, promptId, callbacks = {}) {\n     try {\n       // é€‰æ‹©æœåŠ¡å™¨\n       const serverUrl = this.lockedServer || await this._selectBestServer()\n-      \n+\n       // è¿žæŽ¥åˆ°æœåŠ¡å™¨\n       await this.connectToServer(serverUrl)\n-      \n+\n       // é”å®šæœåŠ¡å™¨\n       this._lockServer(serverUrl)\n-      \n+\n       // æ³¨å†Œä»»åŠ¡\n       this.tasks.set(promptId, {\n         ...callbacks,\n         server: serverUrl,\n         startTime: Date.now()\n       })\n-      \n+\n       // æäº¤å·¥ä½œæµ - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬14-17è¡Œ\n       const requestBody = {\n         prompt: workflow,\n         client_id: CLIENT_ID,\n         prompt_id: promptId\n       }\n-      \n+\n       const response = await fetch(`${serverUrl}/api/prompt`, {\n         method: 'POST',\n         headers: { 'Content-Type': 'application/json' },\n         body: JSON.stringify(requestBody)\n       })\n-      \n+\n       if (!response.ok) {\n         throw new Error(`æäº¤å¤±è´¥: ${response.status}`)\n       }\n-      \n+\n       console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡æäº¤æˆåŠŸ: ${promptId}`)\n       return promptId\n-      \n+\n     } catch (error) {\n       // æ¸…ç†å¤±è´¥çš„ä»»åŠ¡\n       this.tasks.delete(promptId)\n       this._checkUnlock()\n@@ -308,14 +308,14 @@\n       if (!task) {\n         reject(new Error(`ä»»åŠ¡ä¸å­˜åœ¨: ${promptId}`))\n         return\n       }\n-      \n+\n       // æ›´æ–°å›žè°ƒ\n       task.onComplete = resolve\n       task.onError = reject\n       task.onProgress = callbacks.onProgress || (() => {})\n-      \n+\n       console.log(`â³ [${WINDOW_ID}] ç­‰å¾…ä»»åŠ¡å®Œæˆ: ${promptId}`)\n     })\n   }\n \n@@ -329,5 +329,105 @@\n       lockedServer: this.lockedServer,\n       taskCount: this.tasks.size\n     }\n   }\n+\n+  // ==================== å…¼å®¹æ€§æ–¹æ³• ====================\n+\n+  // å…¼å®¹åŽŸæœ‰æŽ¥å£\n+  async initializeWebSocket(targetServer = null) {\n+    const serverUrl = targetServer || this.lockedServer || await this._selectBestServer()\n+    return await this.connectToServer(serverUrl)\n+  }\n+\n+  async ensureWebSocketConnection(taskServer = null) {\n+    const serverUrl = taskServer || this.currentServer\n+    if (serverUrl && this.isConnected && this.currentServer === serverUrl) {\n+      return true\n+    }\n+    return await this.connectToServer(serverUrl || await this._selectBestServer())\n+  }\n+\n+  // ä»»åŠ¡ç®¡ç†å…¼å®¹æ–¹æ³•\n+  registerWindowTask(promptId, task) {\n+    this.tasks.set(promptId, task)\n+    console.log(`ðŸ“ [${WINDOW_ID}] ä»»åŠ¡å·²æ³¨å†Œ: ${promptId}`)\n+  }\n+\n+  getWindowTask(promptId) {\n+    return this.tasks.get(promptId)\n+  }\n+\n+  removeWindowTask(promptId) {\n+    const removed = this.tasks.delete(promptId)\n+    if (removed) {\n+      console.log(`ðŸ—‘ï¸ [${WINDOW_ID}] ä»»åŠ¡å·²ç§»é™¤: ${promptId}`)\n+      this._checkUnlock()\n+    }\n+    return removed\n+  }\n+\n+  // æœåŠ¡å™¨é”å®šå…¼å®¹æ–¹æ³•\n+  lockServerForWindow(serverUrl) {\n+    this._lockServer(serverUrl)\n+  }\n+\n+  unlockServerForWindow() {\n+    console.log(`ðŸ”“ [${WINDOW_ID}] æ‰‹åŠ¨è§£é”æœåŠ¡å™¨: ${this.lockedServer}`)\n+    this.lockedServer = null\n+    this.lockTimestamp = null\n+  }\n+\n+  getWindowServerLock() {\n+    if (this.lockedServer) {\n+      return {\n+        server: this.lockedServer,\n+        timestamp: this.lockTimestamp,\n+        windowId: WINDOW_ID\n+      }\n+    }\n+    return null\n+  }\n+\n+  // ä»»åŠ¡å®Œæˆå¤„ç† - ä¾›å¤–éƒ¨è°ƒç”¨\n+  async handleTaskCompletion(promptId) {\n+    await this._handleTaskCompletion(promptId)\n+  }\n+\n+  // è¿›åº¦å›žè°ƒå®‰å…¨åŒ…è£…\n+  safeProgressCallback(promptId, task, message, progress) {\n+    if (task && task.onProgress) {\n+      try {\n+        task.onProgress(message, progress)\n+      } catch (error) {\n+        console.error(`âŒ [${WINDOW_ID}] è¿›åº¦å›žè°ƒé”™è¯¯:`, error)\n+      }\n+    }\n+  }\n+\n+  // èŽ·å–ä»»åŠ¡ç»‘å®šçš„æœåŠ¡å™¨\n+  getTaskBoundServer(promptId) {\n+    const task = this.tasks.get(promptId)\n+    return task ? task.server : null\n+  }\n+\n+  // æ£€æŸ¥æœåŠ¡å™¨è§£é”æ¡ä»¶\n+  checkServerUnlockCondition() {\n+    this._checkUnlock()\n+  }\n+\n+  // çª—å£ä»»åŠ¡å±žæ€§ï¼ˆå…¼å®¹æ€§ï¼‰\n+  get windowTasks() {\n+    return this.tasks\n+  }\n+\n+  // ä»»åŠ¡çŠ¶æ€æžšä¸¾ï¼ˆå…¼å®¹æ€§ï¼‰\n+  get TASK_STATUS() {\n+    return {\n+      WAITING: 'waiting',\n+      EXECUTING: 'executing',\n+      COMPLETED: 'completed',\n+      ERROR: 'error',\n+      INTERRUPTED: 'interrupted'\n+    }\n+  }\n }\n"
                },
                {
                    "date": 1753513146556,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -430,4 +430,23 @@\n       INTERRUPTED: 'interrupted'\n     }\n   }\n }\n+\n+// åˆ›å»ºå…¨å±€å®žä¾‹\n+const webSocketManager = new SimpleWebSocketManager()\n+\n+// å…¨å±€å…¼å®¹æ€§è®¾ç½®\n+if (typeof window !== 'undefined') {\n+  // ä¿æŒåŽŸæœ‰çš„å…¨å±€å˜é‡å…¼å®¹æ€§\n+  window.pendingTasks = webSocketManager.tasks\n+\n+  // å…¼å®¹åŽŸæœ‰çš„å…¨å±€å‡½æ•°\n+  window.getWindowTask = webSocketManager.getWindowTask.bind(webSocketManager)\n+  window.removeWindowTask = webSocketManager.removeWindowTask.bind(webSocketManager)\n+\n+  console.log(`ðŸ”§ [${WINDOW_ID}] å…¼å®¹æ€§æŽ¥å£å·²è®¾ç½®`)\n+}\n+\n+// å¯¼å‡º\n+export default webSocketManager\n+export { WINDOW_ID, CLIENT_ID }\n"
                },
                {
                    "date": 1753513209404,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -329,9 +329,8 @@\n       lockedServer: this.lockedServer,\n       taskCount: this.tasks.size\n     }\n   }\n-\n   // ==================== å…¼å®¹æ€§æ–¹æ³• ====================\n \n   // å…¼å®¹åŽŸæœ‰æŽ¥å£\n   async initializeWebSocket(targetServer = null) {\n@@ -429,8 +428,21 @@\n       ERROR: 'error',\n       INTERRUPTED: 'interrupted'\n     }\n   }\n+\n+  // å…¼å®¹æ€§å±žæ€§\n+  get wsConnection() {\n+    return this.ws\n+  }\n+\n+  get isWsConnected() {\n+    return this.isConnected\n+  }\n+\n+  get currentWebSocketServer() {\n+    return this.currentServer\n+  }\n }\n \n // åˆ›å»ºå…¨å±€å®žä¾‹\n const webSocketManager = new SimpleWebSocketManager()\n@@ -448,5 +460,5 @@\n }\n \n // å¯¼å‡º\n export default webSocketManager\n-export { WINDOW_ID, CLIENT_ID }\n+export { WINDOW_ID, CLIENT_ID, CLIENT_ID as WINDOW_CLIENT_ID }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1753515700320,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -166,10 +166,17 @@\n \n       // æå–ç»“æžœ - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬48-56è¡Œ\n       const result = this._extractResults(history, promptId)\n \n-      console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`)\n+      // ðŸ”§ å…³é”®ä¿®å¤ï¼šä¿å­˜ä»»åŠ¡æ‰§è¡ŒæœåŠ¡å™¨ä¿¡æ¯åˆ°ç»“æžœä¸­\n+      if (result && task.server) {\n+        result.executionServer = task.server\n+        result.promptId = promptId\n+        console.log(`ðŸ’¾ [${WINDOW_ID}] ä¿å­˜ä»»åŠ¡æ‰§è¡ŒæœåŠ¡å™¨ä¿¡æ¯: ${task.server}`)\n+      }\n \n+      console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`, result)\n+\n       // è°ƒç”¨å®Œæˆå›žè°ƒ\n       if (task.onComplete) {\n         task.onComplete(result)\n       }\n"
                },
                {
                    "date": 1753515791651,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -173,9 +173,9 @@\n         result.promptId = promptId\n         console.log(`ðŸ’¾ [${WINDOW_ID}] ä¿å­˜ä»»åŠ¡æ‰§è¡ŒæœåŠ¡å™¨ä¿¡æ¯: ${task.server}`)\n       }\n \n-      console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`, result)\n+      console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`)\n \n       // è°ƒç”¨å®Œæˆå›žè°ƒ\n       if (task.onComplete) {\n         task.onComplete(result)\n"
                },
                {
                    "date": 1753515899857,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -173,9 +173,9 @@\n         result.promptId = promptId\n         console.log(`ðŸ’¾ [${WINDOW_ID}] ä¿å­˜ä»»åŠ¡æ‰§è¡ŒæœåŠ¡å™¨ä¿¡æ¯: ${task.server}`)\n       }\n \n-      console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`)\n+      console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`, result)\n \n       // è°ƒç”¨å®Œæˆå›žè°ƒ\n       if (task.onComplete) {\n         task.onComplete(result)\n"
                },
                {
                    "date": 1753515942173,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -173,9 +173,9 @@\n         result.promptId = promptId\n         console.log(`ðŸ’¾ [${WINDOW_ID}] ä¿å­˜ä»»åŠ¡æ‰§è¡ŒæœåŠ¡å™¨ä¿¡æ¯: ${task.server}`)\n       }\n \n-      console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`, result)\n+      console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡ç»“æžœèŽ·å–æˆåŠŸ: ${promptId}`)\n \n       // è°ƒç”¨å®Œæˆå›žè°ƒ\n       if (task.onComplete) {\n         task.onComplete(result)\n@@ -212,23 +212,25 @@\n     }\n     return await response.json()\n   }\n \n-  // æå–ç»“æžœ - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬48-56è¡Œ\n+  // æå–ç»“æžœ - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬48-56è¡Œï¼ˆå¢žå¼ºç‰ˆï¼‰\n   _extractResults(history, promptId) {\n     const taskData = history[promptId]\n     if (!taskData || !taskData.outputs) {\n-      throw new Error(`ä»»åŠ¡ ${promptId} æ²¡æœ‰è¾“å‡ºæ•°æ®`)\n+      console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡ ${promptId} æ²¡æœ‰è¾“å‡ºæ•°æ®ï¼Œè¿”å›žç©ºç»“æžœ`)\n+      return {}\n     }\n \n     const results = {}\n     for (const nodeId in taskData.outputs) {\n       const nodeOutput = taskData.outputs[nodeId]\n-      if (nodeOutput.images) {\n-        results[nodeId] = nodeOutput.images\n-      }\n+      // ðŸ”§ ä¿®å¤ï¼šä¿å­˜æ‰€æœ‰è¾“å‡ºæ•°æ®ï¼Œä¸ä»…ä»…æ˜¯å›¾ç‰‡\n+      results[nodeId] = nodeOutput\n+      console.log(`ðŸ“Š [${WINDOW_ID}] æå–èŠ‚ç‚¹ ${nodeId} è¾“å‡º:`, nodeOutput)\n     }\n \n+    console.log(`ðŸ“‹ [${WINDOW_ID}] å®Œæ•´ç»“æžœç»“æž„:`, results)\n     return results\n   }\n \n   // é€‰æ‹©æœ€ä½³æœåŠ¡å™¨\n"
                },
                {
                    "date": 1753515953308,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -212,14 +212,13 @@\n     }\n     return await response.json()\n   }\n \n-  // æå–ç»“æžœ - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬48-56è¡Œï¼ˆå¢žå¼ºç‰ˆï¼‰\n+  // æå–ç»“æžœ - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬48-56è¡Œ\n   _extractResults(history, promptId) {\n     const taskData = history[promptId]\n     if (!taskData || !taskData.outputs) {\n-      console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡ ${promptId} æ²¡æœ‰è¾“å‡ºæ•°æ®ï¼Œè¿”å›žç©ºç»“æžœ`)\n-      return {}\n+      throw new Error(`ä»»åŠ¡ ${promptId} æ²¡æœ‰è¾“å‡ºæ•°æ®`)\n     }\n \n     const results = {}\n     for (const nodeId in taskData.outputs) {\n"
                },
                {
                    "date": 1753515962718,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -227,9 +227,8 @@\n       results[nodeId] = nodeOutput\n       console.log(`ðŸ“Š [${WINDOW_ID}] æå–èŠ‚ç‚¹ ${nodeId} è¾“å‡º:`, nodeOutput)\n     }\n \n-    console.log(`ðŸ“‹ [${WINDOW_ID}] å®Œæ•´ç»“æžœç»“æž„:`, results)\n     return results\n   }\n \n   // é€‰æ‹©æœ€ä½³æœåŠ¡å™¨\n"
                },
                {
                    "date": 1753515974605,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -212,13 +212,14 @@\n     }\n     return await response.json()\n   }\n \n-  // æå–ç»“æžœ - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬48-56è¡Œ\n+  // æå–ç»“æžœ - åŸºäºŽå®˜æ–¹æ ·ä¾‹ç¬¬48-56è¡Œï¼ˆå¢žå¼ºç‰ˆï¼‰\n   _extractResults(history, promptId) {\n     const taskData = history[promptId]\n     if (!taskData || !taskData.outputs) {\n-      throw new Error(`ä»»åŠ¡ ${promptId} æ²¡æœ‰è¾“å‡ºæ•°æ®`)\n+      console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡ ${promptId} æ²¡æœ‰è¾“å‡ºæ•°æ®ï¼Œè¿”å›žç©ºç»“æžœ`)\n+      return {}\n     }\n \n     const results = {}\n     for (const nodeId in taskData.outputs) {\n@@ -227,8 +228,9 @@\n       results[nodeId] = nodeOutput\n       console.log(`ðŸ“Š [${WINDOW_ID}] æå–èŠ‚ç‚¹ ${nodeId} è¾“å‡º:`, nodeOutput)\n     }\n \n+    console.log(`ðŸ“‹ [${WINDOW_ID}] å®Œæ•´ç»“æžœç»“æž„:`, results)\n     return results\n   }\n \n   // é€‰æ‹©æœ€ä½³æœåŠ¡å™¨\n"
                },
                {
                    "date": 1753516538264,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -467,7 +467,9 @@\n \n   console.log(`ðŸ”§ [${WINDOW_ID}] å…¼å®¹æ€§æŽ¥å£å·²è®¾ç½®`)\n }\n \n+\n+\n // å¯¼å‡º\n export default webSocketManager\n export { WINDOW_ID, CLIENT_ID, CLIENT_ID as WINDOW_CLIENT_ID }\n\\ No newline at end of file\n"
                }
            ],
            "date": 1753463557474,
            "name": "Commit-0",
            "content": "/**\n * ðŸ”¥ WebSocketè¿žæŽ¥ç®¡ç†å™¨ - ç‹¬ç«‹çš„WebSocketæœåŠ¡\n *\n * æ ¸å¿ƒåŠŸèƒ½ï¼š\n * 1. WebSocketè¿žæŽ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†\n * 2. å¤šçª—å£éš”ç¦»æœºåˆ¶\n * 3. æœåŠ¡å™¨é”å®šä¸Žä¸€è‡´æ€§ä¿è¯\n * 4. æ¶ˆæ¯è·¯ç”±ä¸Žäº‹ä»¶åˆ†å‘\n * 5. è‡ªåŠ¨é‡è¿žä¸Žå¥åº·æ£€æŸ¥\n *\n * æž¶æž„ä¼˜åŠ¿ï¼š\n * - è§£è€¦WebSocketç®¡ç†ä¸Žä¸šåŠ¡é€»è¾‘\n * - æ”¯æŒå¤šç§æœåŠ¡å¤ç”¨åŒä¸€WebSocketè¿žæŽ¥\n * - æä¾›ç»Ÿä¸€çš„è¿žæŽ¥ç®¡ç†ç­–ç•¥\n * - ä¾¿äºŽæµ‹è¯•å’Œç»´æŠ¤\n */\n\nimport loadBalancer from './loadBalancer.js'\n\n// WebSocketè¿žæŽ¥çŠ¶æ€æžšä¸¾\nexport const WS_STATE = {\n  DISCONNECTED: 'disconnected',\n  CONNECTING: 'connecting',\n  CONNECTED: 'connected',\n  RECONNECTING: 'reconnecting',\n  FAILED: 'failed'\n}\n\n// ðŸ”§ ç”Ÿæˆçª—å£å”¯ä¸€æ ‡è¯†ç¬¦\nfunction generateWindowId() {\n  return `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\n}\n\n// ðŸ”§ ç”Ÿæˆå¢žå¼ºçš„å®¢æˆ·ç«¯ID\nfunction generateUniqueClientId() {\n  const baseId = 'abc1373d4ad648a3a81d0587fbe5534b'\n  const timestamp = Date.now()\n  const random = Math.random().toString(36).substr(2, 9)\n  const windowId = generateWindowId()\n  return `${baseId}_${timestamp}_${random}_${windowId}`\n}\n\nclass WebSocketManager {\n  constructor() {\n    // çª—å£æ ‡è¯†\n    this.windowId = generateWindowId()\n    this.clientId = generateUniqueClientId()\n\n    // è¿žæŽ¥ç®¡ç†\n    this.connection = null\n    this.state = WS_STATE.DISCONNECTED\n    this.currentServer = null\n\n    // æœåŠ¡å™¨é”å®šæœºåˆ¶ï¼ˆçª—å£çº§åˆ«ï¼‰\n    this.lockedServer = null\n    this.lockTimestamp = null\n\n    // äº‹ä»¶ç®¡ç†\n    this.eventHandlers = new Map()\n    this.messageQueue = []\n\n    // é‡è¿žç®¡ç†\n    this.reconnectAttempts = 0\n    this.maxReconnectAttempts = 5\n    this.reconnectDelay = 2000\n    this.reconnectTimer = null\n\n    // å¥åº·æ£€æŸ¥\n    this.healthCheckInterval = null\n    this.lastHeartbeat = null\n    this.lastMessageTime = null\n\n    console.log(`ðŸ”Œ WebSocketManager åˆå§‹åŒ–å®Œæˆ`)\n    console.log(`ðŸªŸ çª—å£ID: ${this.windowId}`)\n    console.log(`ðŸ”‘ å®¢æˆ·ç«¯ID: ${this.clientId}`)\n\n    // è®¾ç½®çª—å£å…³é—­æ¸…ç†\n    this.setupWindowCleanup()\n  }\n\n  /**\n   * ðŸ”§ è®¾ç½®çª—å£å…³é—­æ—¶çš„æ¸…ç†æœºåˆ¶\n   */\n  setupWindowCleanup() {\n    window.addEventListener('beforeunload', () => {\n      console.log(`ðŸšª [${this.windowId}] çª—å£å³å°†å…³é—­ï¼Œæ‰§è¡ŒWebSocketæ¸…ç†...`)\n      this.disconnect()\n      this.unlockServer()\n    })\n\n    // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†\n    document.addEventListener('visibilitychange', () => {\n      if (document.hidden) {\n        console.log(`ðŸ‘ï¸ [${this.windowId}] çª—å£éšè—`)\n      } else {\n        console.log(`ðŸ‘ï¸ [${this.windowId}] çª—å£é‡æ–°å¯è§`)\n        this.checkConnectionHealth()\n      }\n    })\n  }\n\n  /**\n   * ðŸ”§ è¿žæŽ¥åˆ°æŒ‡å®šæœåŠ¡å™¨\n   */\n  async connect(serverUrl = null) {\n    if (this.state === WS_STATE.CONNECTING) {\n      console.log(`ðŸ”„ [${this.windowId}] WebSocketæ­£åœ¨è¿žæŽ¥ä¸­ï¼Œè·³è¿‡é‡å¤è¿žæŽ¥`)\n      return false\n    }\n\n    try {\n      this.state = WS_STATE.CONNECTING\n\n      // ç¡®å®šç›®æ ‡æœåŠ¡å™¨\n      const targetServer = serverUrl || await this.getTargetServer()\n      if (!targetServer) {\n        throw new Error('æ— æ³•èŽ·å–å¯ç”¨çš„æœåŠ¡å™¨')\n      }\n\n      // é”å®šæœåŠ¡å™¨\n      this.lockServer(targetServer)\n\n      // å»ºç«‹WebSocketè¿žæŽ¥\n      await this.establishConnection(targetServer)\n\n      this.state = WS_STATE.CONNECTED\n      this.reconnectAttempts = 0\n      this.startHealthCheck()\n\n      console.log(`âœ… [${this.windowId}] WebSocketè¿žæŽ¥æˆåŠŸ: ${targetServer}`)\n      this.emit('connected', { server: targetServer, windowId: this.windowId })\n\n      return true\n\n    } catch (error) {\n      this.state = WS_STATE.FAILED\n      console.error(`âŒ [${this.windowId}] WebSocketè¿žæŽ¥å¤±è´¥:`, error)\n      this.emit('error', { error, windowId: this.windowId })\n\n      // å¯åŠ¨é‡è¿ž\n      this.scheduleReconnect()\n      return false\n    }\n  }\n\n  /**\n   * ðŸ”§ å»ºç«‹WebSocketè¿žæŽ¥\n   */\n  async establishConnection(serverUrl) {\n    return new Promise((resolve, reject) => {\n      const wsUrl = this.buildWebSocketUrl(serverUrl)\n      console.log(`ðŸ”— [${this.windowId}] å»ºç«‹WebSocketè¿žæŽ¥: ${wsUrl}`)\n\n      // å…ˆè¿›è¡ŒHTTPè¿žæŽ¥æµ‹è¯•\n      this.testHttpConnection(serverUrl)\n        .then(() => {\n          this.connection = new WebSocket(wsUrl)\n          this.currentServer = serverUrl\n\n          const timeout = setTimeout(() => {\n            reject(new Error('WebSocketè¿žæŽ¥è¶…æ—¶'))\n          }, 10000)\n\n          this.connection.onopen = () => {\n            clearTimeout(timeout)\n            console.log(`ðŸŽ‰ [${this.windowId}] WebSocketè¿žæŽ¥å·²å»ºç«‹`)\n            resolve()\n          }\n\n          this.connection.onclose = (event) => {\n            clearTimeout(timeout)\n            this.handleConnectionClose(event)\n          }\n\n          this.connection.onerror = (error) => {\n            clearTimeout(timeout)\n            console.error(`âŒ [${this.windowId}] WebSocketè¿žæŽ¥é”™è¯¯:`, error)\n            reject(error)\n          }\n\n          this.connection.onmessage = (event) => {\n            this.handleMessage(event)\n          }\n        })\n        .catch(reject)\n    })\n  }\n\n  /**\n   * ðŸ”§ HTTPè¿žæŽ¥æµ‹è¯•\n   */\n  async testHttpConnection(serverUrl) {\n    try {\n      const response = await fetch(`${serverUrl}/api/queue`, {\n        method: 'GET',\n        signal: AbortSignal.timeout(5000)\n      })\n      if (!response.ok) {\n        throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status}`)\n      }\n      console.log(`âœ… [${this.windowId}] HTTPè¿žæŽ¥æµ‹è¯•é€šè¿‡: ${serverUrl}`)\n    } catch (error) {\n      throw new Error(`ComfyUIæœåŠ¡å™¨ä¸å¯è¾¾: ${error.message}`)\n    }\n  }\n\n  /**\n   * ðŸ”§ æž„å»ºWebSocket URL\n   */\n  buildWebSocketUrl(serverUrl) {\n    let wsUrl\n    if (serverUrl.startsWith('https://')) {\n      wsUrl = serverUrl.replace('https://', 'wss://')\n    } else {\n      wsUrl = serverUrl.replace('http://', 'ws://')\n    }\n    return `${wsUrl}/ws?clientId=${this.clientId}`\n  }\n\n  /**\n   * ðŸ”§ æ¶ˆæ¯å¤„ç†\n   */\n  handleMessage(event) {\n    try {\n      this.lastMessageTime = Date.now()\n      const message = event.data\n\n      // å¤„ç†äºŒè¿›åˆ¶æ¶ˆæ¯\n      if (message instanceof ArrayBuffer || message instanceof Blob) {\n        this.emit('binary', { data: message, windowId: this.windowId })\n        return\n      }\n\n      // å¤„ç†æ–‡æœ¬æ¶ˆæ¯\n      if (typeof message === 'string') {\n        const parsedMessage = JSON.parse(message)\n\n        // æ·»åŠ çª—å£æ ‡è¯†\n        const enrichedMessage = {\n          ...parsedMessage,\n          windowId: this.windowId,\n          timestamp: Date.now()\n        }\n\n        this.emit('message', enrichedMessage)\n\n        // æ ¹æ®æ¶ˆæ¯ç±»åž‹åˆ†å‘\n        if (parsedMessage.type) {\n          this.emit(`message:${parsedMessage.type}`, enrichedMessage)\n        }\n      }\n\n    } catch (error) {\n      console.error(`âŒ [${this.windowId}] WebSocketæ¶ˆæ¯å¤„ç†å¤±è´¥:`, error)\n      this.emit('error', { error, windowId: this.windowId })\n    }\n  }\n\n  /**\n   * ðŸ”§ è¿žæŽ¥å…³é—­å¤„ç†\n   */\n  handleConnectionClose(event) {\n    console.log(`ðŸ”Œ [${this.windowId}] WebSocketè¿žæŽ¥å…³é—­: ä»£ç =${event.code}`)\n    this.state = WS_STATE.DISCONNECTED\n    this.stopHealthCheck()\n\n    this.emit('disconnected', {\n      code: event.code,\n      reason: event.reason,\n      windowId: this.windowId\n    })\n\n    // æ ¹æ®å…³é—­åŽŸå› å†³å®šæ˜¯å¦é‡è¿ž\n    if (event.code !== 1000) { // éžæ­£å¸¸å…³é—­\n      this.scheduleReconnect()\n    }\n  }\n\n  /**\n   * ðŸ”§ å‘é€æ¶ˆæ¯\n   */\n  send(data) {\n    if (this.state !== WS_STATE.CONNECTED || !this.connection) {\n      console.warn(`âš ï¸ [${this.windowId}] WebSocketæœªè¿žæŽ¥ï¼Œæ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—`)\n      this.messageQueue.push(data)\n      return false\n    }\n\n    try {\n      const message = typeof data === 'string' ? data : JSON.stringify(data)\n      this.connection.send(message)\n      return true\n    } catch (error) {\n      console.error(`âŒ [${this.windowId}] WebSocketå‘é€æ¶ˆæ¯å¤±è´¥:`, error)\n      return false\n    }\n  }\n\n  /**\n   * ðŸ”§ å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—\n   */\n  processMessageQueue() {\n    if (this.messageQueue.length > 0 && this.state === WS_STATE.CONNECTED) {\n      console.log(`ðŸ“¤ [${this.windowId}] å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—: ${this.messageQueue.length} æ¡æ¶ˆæ¯`)\n\n      while (this.messageQueue.length > 0) {\n        const message = this.messageQueue.shift()\n        if (!this.send(message)) {\n          // å‘é€å¤±è´¥ï¼Œé‡æ–°åŠ å…¥é˜Ÿåˆ—\n          this.messageQueue.unshift(message)\n          break\n        }\n      }\n    }\n  }\n\n  /**\n   * ðŸ”§ äº‹ä»¶ç›‘å¬\n   */\n  on(event, handler) {\n    if (!this.eventHandlers.has(event)) {\n      this.eventHandlers.set(event, new Set())\n    }\n    this.eventHandlers.get(event).add(handler)\n    console.log(`ðŸ“¡ [${this.windowId}] æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨: ${event}`)\n  }\n\n  /**\n   * ðŸ”§ ç§»é™¤äº‹ä»¶ç›‘å¬\n   */\n  off(event, handler) {\n    if (this.eventHandlers.has(event)) {\n      this.eventHandlers.get(event).delete(handler)\n      console.log(`ðŸ“¡ [${this.windowId}] ç§»é™¤äº‹ä»¶ç›‘å¬å™¨: ${event}`)\n    }\n  }\n\n  /**\n   * ðŸ”§ è§¦å‘äº‹ä»¶\n   */\n  emit(event, data) {\n    if (this.eventHandlers.has(event)) {\n      this.eventHandlers.get(event).forEach(handler => {\n        try {\n          handler(data)\n        } catch (error) {\n          console.error(`âŒ [${this.windowId}] äº‹ä»¶å¤„ç†å™¨é”™è¯¯ [${event}]:`, error)\n        }\n      })\n    }\n  }\n\n  /**\n   * ðŸ”§ æœåŠ¡å™¨é”å®š\n   */\n  lockServer(serverUrl) {\n    this.lockedServer = serverUrl\n    this.lockTimestamp = Date.now()\n    console.log(`ðŸ”’ [${this.windowId}] é”å®šæœåŠ¡å™¨: ${serverUrl}`)\n    console.log(`ðŸ• [${this.windowId}] é”å®šæ—¶é—´: ${new Date(this.lockTimestamp).toLocaleTimeString()}`)\n\n    this.emit('server:locked', {\n      server: serverUrl,\n      timestamp: this.lockTimestamp,\n      windowId: this.windowId\n    })\n  }\n\n  /**\n   * ðŸ”§ è§£é”æœåŠ¡å™¨\n   */\n  unlockServer() {\n    if (this.lockedServer) {\n      console.log(`ðŸ”“ [${this.windowId}] è§£é”æœåŠ¡å™¨: ${this.lockedServer}`)\n      const unlockedServer = this.lockedServer\n      this.lockedServer = null\n      this.lockTimestamp = null\n\n      this.emit('server:unlocked', {\n        server: unlockedServer,\n        windowId: this.windowId\n      })\n    }\n  }\n\n  /**\n   * ðŸ”§ èŽ·å–ç›®æ ‡æœåŠ¡å™¨\n   */\n  async getTargetServer() {\n    // å¦‚æžœæœ‰é”å®šçš„æœåŠ¡å™¨ï¼Œä¼˜å…ˆä½¿ç”¨\n    if (this.lockedServer) {\n      console.log(`ðŸ”’ [${this.windowId}] ä½¿ç”¨é”å®šçš„æœåŠ¡å™¨: ${this.lockedServer}`)\n      return this.lockedServer\n    }\n\n    // ä»Žè´Ÿè½½å‡è¡¡å™¨èŽ·å–æœ€ä¼˜æœåŠ¡å™¨\n    try {\n      const optimalServer = await loadBalancer.getOptimalServer()\n      console.log(`ðŸŽ¯ [${this.windowId}] è´Ÿè½½å‡è¡¡é€‰æ‹©æœåŠ¡å™¨: ${optimalServer}`)\n      return optimalServer\n    } catch (error) {\n      console.error(`âŒ [${this.windowId}] èŽ·å–æœåŠ¡å™¨å¤±è´¥:`, error)\n      return null\n    }\n  }\n\n  /**\n   * ðŸ”§ å¯åŠ¨å¥åº·æ£€æŸ¥\n   */\n  startHealthCheck() {\n    this.stopHealthCheck() // æ¸…ç†ä¹‹å‰çš„æ£€æŸ¥\n\n    this.healthCheckInterval = setInterval(() => {\n      this.performHealthCheck()\n    }, 30000) // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡\n\n    console.log(`ðŸ’“ [${this.windowId}] å¯åŠ¨å¥åº·æ£€æŸ¥`)\n  }\n\n  /**\n   * ðŸ”§ åœæ­¢å¥åº·æ£€æŸ¥\n   */\n  stopHealthCheck() {\n    if (this.healthCheckInterval) {\n      clearInterval(this.healthCheckInterval)\n      this.healthCheckInterval = null\n      console.log(`ðŸ’“ [${this.windowId}] åœæ­¢å¥åº·æ£€æŸ¥`)\n    }\n  }\n\n  /**\n   * ðŸ”§ æ‰§è¡Œå¥åº·æ£€æŸ¥\n   */\n  performHealthCheck() {\n    const now = Date.now()\n\n    // æ£€æŸ¥è¿žæŽ¥çŠ¶æ€\n    if (this.connection && this.connection.readyState !== WebSocket.OPEN) {\n      console.warn(`âš ï¸ [${this.windowId}] å¥åº·æ£€æŸ¥: WebSocketè¿žæŽ¥å¼‚å¸¸`)\n      this.scheduleReconnect()\n      return\n    }\n\n    // æ£€æŸ¥æ¶ˆæ¯æ´»è·ƒåº¦\n    if (this.lastMessageTime && (now - this.lastMessageTime) > 120000) { // 2åˆ†é’Ÿæ— æ¶ˆæ¯\n      console.warn(`âš ï¸ [${this.windowId}] å¥åº·æ£€æŸ¥: é•¿æ—¶é—´æ— æ¶ˆæ¯`)\n    }\n\n    console.log(`ðŸ’“ [${this.windowId}] å¥åº·æ£€æŸ¥é€šè¿‡`)\n  }\n\n  /**\n   * ðŸ”§ æ£€æŸ¥è¿žæŽ¥å¥åº·çŠ¶æ€\n   */\n  checkConnectionHealth() {\n    if (this.state === WS_STATE.CONNECTED && this.connection) {\n      if (this.connection.readyState !== WebSocket.OPEN) {\n        console.warn(`âš ï¸ [${this.windowId}] è¿žæŽ¥çŠ¶æ€å¼‚å¸¸ï¼Œå°è¯•é‡è¿ž`)\n        this.scheduleReconnect()\n      }\n    }\n  }\n\n  /**\n   * ðŸ”§ è°ƒåº¦é‡è¿ž\n   */\n  scheduleReconnect() {\n    if (this.reconnectTimer) {\n      return // å·²ç»åœ¨é‡è¿žä¸­\n    }\n\n    if (this.reconnectAttempts >= this.maxReconnectAttempts) {\n      console.error(`âŒ [${this.windowId}] é‡è¿žæ¬¡æ•°è¶…é™ï¼Œåœæ­¢é‡è¿ž`)\n      this.state = WS_STATE.FAILED\n      this.emit('reconnect:failed', { windowId: this.windowId })\n      return\n    }\n\n    this.state = WS_STATE.RECONNECTING\n    this.reconnectAttempts++\n\n    const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1) // æŒ‡æ•°é€€é¿\n\n    console.log(`ðŸ”„ [${this.windowId}] è°ƒåº¦é‡è¿ž (ç¬¬${this.reconnectAttempts}æ¬¡ï¼Œ${delay}msåŽ)`)\n\n    this.reconnectTimer = setTimeout(async () => {\n      this.reconnectTimer = null\n\n      try {\n        await this.connect(this.lockedServer)\n        console.log(`âœ… [${this.windowId}] é‡è¿žæˆåŠŸ`)\n        this.emit('reconnect:success', { windowId: this.windowId })\n      } catch (error) {\n        console.error(`âŒ [${this.windowId}] é‡è¿žå¤±è´¥:`, error)\n        this.scheduleReconnect() // ç»§ç»­å°è¯•é‡è¿ž\n      }\n    }, delay)\n  }\n\n  /**\n   * ðŸ”§ æ¸…é™¤é‡è¿žå®šæ—¶å™¨\n   */\n  clearReconnectTimer() {\n    if (this.reconnectTimer) {\n      clearTimeout(this.reconnectTimer)\n      this.reconnectTimer = null\n      console.log(`ðŸ§¹ [${this.windowId}] æ¸…é™¤é‡è¿žå®šæ—¶å™¨`)\n    }\n  }\n"
        }
    ]
}