{
    "sourceFile": "client/src/services/webSocketConnection.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1753509515084,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1753509515084,
            "name": "Commit-0",
            "content": "// WebSocket è¿æ¥ç®¡ç†æ‰©å±• - å¤„ç†è¿æ¥å’Œæ¶ˆæ¯\n// è¿™ä¸ªæ–‡ä»¶åŒ…å« WebSocket è¿æ¥åˆå§‹åŒ–ã€æ¶ˆæ¯å¤„ç†å’Œé‡è¿é€»è¾‘\n\nimport webSocketManager, { WINDOW_ID, WINDOW_CLIENT_ID } from './webSocketManager.js'\nimport loadBalancer from './loadBalancer.js'\n\n/**\n * WebSocket è¿æ¥ç®¡ç†å™¨æ‰©å±•\n * å¤„ç†å®é™…çš„ WebSocket è¿æ¥ã€æ¶ˆæ¯è·¯ç”±å’Œé‡è¿é€»è¾‘\n */\nclass WebSocketConnection {\n  constructor(manager) {\n    this.manager = manager\n  }\n\n  // ğŸ”§ åˆå§‹åŒ– WebSocket è¿æ¥ - é‡æ„ç‰ˆæœ¬ï¼ˆè§£å†³å¤šæœåŠ¡å™¨æ¶ˆæ¯è·¯ç”±é”™ä¹±ï¼‰\n  async initializeWebSocket(targetServer = null) {\n    try {\n      // ğŸ”§ å…³é”®ä¿®å¤ï¼šæ”¯æŒæŒ‡å®šç›®æ ‡æœåŠ¡å™¨ï¼Œç¡®ä¿ä»»åŠ¡-æœåŠ¡å™¨ç»‘å®šä¸€è‡´æ€§\n      let baseUrl\n      const currentLock = this.manager.getWindowServerLock()\n\n      if (targetServer) {\n        // ğŸ”§ æ–°å¢ï¼šå¼ºåˆ¶è¿æ¥åˆ°æŒ‡å®šæœåŠ¡å™¨ï¼ˆç”¨äºä»»åŠ¡æ‰§è¡Œæ—¶çš„æœåŠ¡å™¨ç»‘å®šï¼‰\n        baseUrl = targetServer\n        console.log(`ğŸ¯ [${WINDOW_ID}] å¼ºåˆ¶è¿æ¥åˆ°æŒ‡å®šæœåŠ¡å™¨: ${baseUrl}`)\n        console.log(`ğŸ”— [${WINDOW_ID}] ä»»åŠ¡-æœåŠ¡å™¨ç»‘å®š: ç¡®ä¿WebSocketä¸ä»»åŠ¡æ‰§è¡ŒæœåŠ¡å™¨ä¸€è‡´`)\n\n        // å¦‚æœæŒ‡å®šæœåŠ¡å™¨ä¸å½“å‰é”å®šä¸åŒï¼Œéœ€è¦æ›´æ–°é”å®š\n        if (!currentLock || currentLock.server !== baseUrl) {\n          this.manager.lockServerForWindow(baseUrl)\n          console.log(`ğŸ”’ [${WINDOW_ID}] æ›´æ–°æœåŠ¡å™¨é”å®š: ${baseUrl}`)\n        }\n      } else if (currentLock && currentLock.server) {\n        // å¦‚æœå·²æœ‰é”å®šçš„æœåŠ¡å™¨ï¼Œç»§ç»­ä½¿ç”¨\n        baseUrl = currentLock.server\n        console.log(`ğŸ”’ [${WINDOW_ID}] ä½¿ç”¨å·²é”å®šçš„WebSocketæœåŠ¡å™¨: ${baseUrl}`)\n        console.log(`ğŸªŸ [${WINDOW_ID}] çª—å£éš”ç¦»: ä½¿ç”¨å½“å‰çª—å£ç‹¬ç«‹é”å®šçš„æœåŠ¡å™¨`)\n        this._logServerConsistency('ä½¿ç”¨å·²é”å®šçš„WebSocketæœåŠ¡å™¨')\n      } else {\n        // é¦–æ¬¡è¿æ¥æˆ–é‡è¿æ—¶ï¼Œé€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨å¹¶é”å®š\n        try {\n          baseUrl = await loadBalancer.getOptimalServer()\n          if (!baseUrl) {\n            throw new Error('è´Ÿè½½å‡è¡¡å™¨æœªè¿”å›æœ‰æ•ˆçš„æœåŠ¡å™¨URL')\n          }\n          this.manager.lockServerForWindow(baseUrl)\n          console.log(`ğŸ”’ [${WINDOW_ID}] é”å®šWebSocketæœåŠ¡å™¨: ${baseUrl}`)\n          console.log(`ğŸ• [${WINDOW_ID}] é”å®šæ—¶é—´: ${new Date(this.manager.getWindowServerLock().timestamp).toLocaleTimeString()}`)\n          console.log(`ğŸªŸ [${WINDOW_ID}] çª—å£éš”ç¦»: ä¸ºå½“å‰çª—å£ç‹¬ç«‹é”å®šæœåŠ¡å™¨`)\n          this._logServerConsistency('é”å®šæ–°çš„WebSocketæœåŠ¡å™¨')\n        } catch (loadBalancerError) {\n          console.error(`âŒ [${WINDOW_ID}] è´Ÿè½½å‡è¡¡å™¨è·å–æœåŠ¡å™¨å¤±è´¥:`, loadBalancerError)\n          throw new Error(`æ— æ³•è·å–å¯ç”¨çš„ComfyUIæœåŠ¡å™¨: ${loadBalancerError.message}`)\n        }\n      }\n\n      // ğŸ”§ æ£€æŸ¥ç°æœ‰è¿æ¥æ˜¯å¦ä¸ç›®æ ‡æœåŠ¡å™¨ä¸€è‡´\n      if (this.manager.wsConnection && this.manager.wsConnection.readyState === WebSocket.OPEN) {\n        const currentWsServer = this.manager.currentWebSocketServer || this.manager.getWindowServerLock()?.server\n        if (currentWsServer === baseUrl) {\n          console.log(`âœ… [${WINDOW_ID}] WebSocketå·²è¿æ¥åˆ°æ­£ç¡®æœåŠ¡å™¨: ${baseUrl}`)\n          return true\n        } else {\n          console.log(`ğŸ”„ [${WINDOW_ID}] WebSocketæœåŠ¡å™¨ä¸åŒ¹é…ï¼Œéœ€è¦é‡è¿`)\n          console.log(`   å½“å‰è¿æ¥: ${currentWsServer}`)\n          console.log(`   ç›®æ ‡æœåŠ¡å™¨: ${baseUrl}`)\n          // å…³é—­ç°æœ‰è¿æ¥ï¼Œå»ºç«‹æ–°è¿æ¥\n          this.manager.wsConnection.close(1000, 'åˆ‡æ¢åˆ°æ­£ç¡®çš„æœåŠ¡å™¨')\n          this.manager.wsConnection = null\n          this.manager.isWsConnected = false\n        }\n      }\n\n      console.log(`ğŸ”Œ [${WINDOW_ID}] è¿æ¥WebSocket: ${baseUrl}`)\n\n      // ğŸ”§ æ„å»ºWebSocket URL - ä½¿ç”¨å¢å¼ºçš„å”¯ä¸€clientId\n      let wsUrl\n      if (baseUrl.startsWith('https://')) {\n        wsUrl = baseUrl.replace('https://', 'wss://') + '/ws?clientId=' + WINDOW_CLIENT_ID\n      } else {\n        wsUrl = baseUrl.replace('http://', 'ws://') + '/ws?clientId=' + WINDOW_CLIENT_ID\n      }\n\n      console.log(`ğŸ”— [${WINDOW_ID}] WebSocket URL: ${wsUrl}`)\n      console.log(`ğŸ”‘ [${WINDOW_ID}] ä½¿ç”¨å¢å¼ºclientId: ${WINDOW_CLIENT_ID}`)\n\n      // ç®€å•çš„HTTPè¿æ¥æµ‹è¯•\n      try {\n        const testResponse = await fetch(`${baseUrl}/api/queue`, {\n          method: 'GET',\n          signal: AbortSignal.timeout(5000)\n        })\n        if (!testResponse.ok) {\n          throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${testResponse.status}`)\n        }\n      } catch (httpError) {\n        throw new Error(`ComfyUIæœåŠ¡å™¨ä¸å¯è¾¾: ${httpError.message}`)\n      }\n\n      // ğŸ”§ è®°å½•å³å°†è¿æ¥çš„æœåŠ¡å™¨ï¼Œç”¨äºåç»­éªŒè¯\n      this.manager.currentWebSocketServer = baseUrl\n      this.manager.wsConnection = new WebSocket(wsUrl)\n\n      return new Promise((resolve, reject) => {\n        const timeout = setTimeout(() => {\n          reject(new Error('WebSocket è¿æ¥è¶…æ—¶'))\n        }, 10000)\n\n        this.manager.wsConnection.onopen = () => {\n          this.manager.isWsConnected = true\n          clearTimeout(timeout)\n          this._showNotification(`[${WINDOW_ID}] WebSocketè¿æ¥æˆåŠŸ`, 'success')\n          this._logServerConsistency('WebSocketè¿æ¥æˆåŠŸ')\n          resolve(true)\n        }\n\n        this.manager.wsConnection.onclose = (event) => {\n          console.log(`ğŸ”Œ [${WINDOW_ID}] WebSocket è¿æ¥å…³é—­: ä»£ç =${event.code}`)\n          this.manager.isWsConnected = false\n          clearTimeout(timeout)\n          this._showNotification(`[${WINDOW_ID}] WebSocketè¿æ¥å·²æ–­å¼€`, 'warning')\n\n          // ğŸ”§ å…³é”®ä¿®å¤ï¼šWebSocketæ–­å¼€æ—¶ä¸ç«‹å³è§£é”æœåŠ¡å™¨\n          // åªæœ‰åœ¨æ²¡æœ‰å¾…å¤„ç†ä»»åŠ¡æ—¶æ‰è€ƒè™‘è§£é”\n          if (this.manager.windowTasks.size === 0) {\n            console.log(`ğŸ”“ [${WINDOW_ID}] æ²¡æœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œå¯ä»¥è§£é”æœåŠ¡å™¨`)\n            this.manager.unlockServerForWindow()\n            this._logServerConsistency('WebSocketæ–­å¼€-è§£é”æœåŠ¡å™¨')\n          } else {\n            console.log(`ğŸ”’ [${WINDOW_ID}] æœ‰ ${this.manager.windowTasks.size} ä¸ªå¾…å¤„ç†ä»»åŠ¡ï¼Œä¿æŒæœåŠ¡å™¨é”å®š`)\n            console.log(`ğŸ“‹ [${WINDOW_ID}] å¾…å¤„ç†ä»»åŠ¡: [${Array.from(this.manager.windowTasks.keys()).join(', ')}]`)\n            this._logServerConsistency('WebSocketæ–­å¼€-ä¿æŒé”å®š')\n          }\n\n          // ğŸ”§ é‡è¿ç­–ç•¥ - ç¡®ä¿é‡è¿åˆ°æ­£ç¡®çš„æœåŠ¡å™¨\n          if (this.manager.windowTasks.size > 0) {\n            console.log(`ğŸ”„ [${WINDOW_ID}] æ£€æµ‹åˆ°å¾…å¤„ç†ä»»åŠ¡ï¼Œé‡è¿åˆ°é”å®šæœåŠ¡å™¨...`)\n            const lockedServer = this.manager.getWindowServerLock()?.server\n            if (lockedServer) {\n              console.log(`ğŸ¯ [${WINDOW_ID}] é‡è¿ç›®æ ‡æœåŠ¡å™¨: ${lockedServer}`)\n              setTimeout(() => {\n                // ğŸ”§ å…³é”®ä¿®å¤ï¼šé‡è¿æ—¶æŒ‡å®šæœåŠ¡å™¨ï¼Œç¡®ä¿ä»»åŠ¡-æœåŠ¡å™¨ç»‘å®šä¸€è‡´æ€§\n                this.initializeWebSocket(lockedServer).catch(error => {\n                  console.error(`âŒ [${WINDOW_ID}] é‡è¿åˆ°é”å®šæœåŠ¡å™¨å¤±è´¥:`, error)\n                  console.log(`âš ï¸ [${WINDOW_ID}] é‡è¿å¤±è´¥ï¼Œä½†ä¿æŒæœåŠ¡å™¨é”å®šä»¥ä¾¿æ‰‹åŠ¨é‡è¯•`)\n                  console.log(`â³ [${WINDOW_ID}] ä»»åŠ¡å°†ç»§ç»­ç­‰å¾…ï¼Œå¯æ‰‹åŠ¨é‡è¿æˆ–ç­‰å¾…è¶…æ—¶`)\n                })\n              }, 2000) // ç¼©çŸ­é‡è¿é—´éš”\n            } else {\n              console.error(`âŒ [${WINDOW_ID}] æœ‰å¾…å¤„ç†ä»»åŠ¡ä½†æ²¡æœ‰é”å®šæœåŠ¡å™¨ï¼Œæ— æ³•é‡è¿`)\n            }\n          } else {\n            console.log(`â„¹ï¸ [${WINDOW_ID}] æ²¡æœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œä¸è¿›è¡Œè‡ªåŠ¨é‡è¿`)\n          }\n        }\n\n        this.manager.wsConnection.onerror = (error) => {\n          clearTimeout(timeout)\n          this._showNotification(`[${WINDOW_ID}] WebSocketè¿æ¥é”™è¯¯`, 'error')\n\n          // ğŸ”§ å…³é”®ä¿®å¤ï¼šè¿æ¥é”™è¯¯æ—¶ä¸ç«‹å³è§£é”æœåŠ¡å™¨\n          // ä¿æŒé”å®šä»¥ä¾¿é‡è¿åˆ°åŒä¸€æœåŠ¡å™¨\n          console.log(`âš ï¸ [${WINDOW_ID}] WebSocketè¿æ¥é”™è¯¯ï¼Œä½†ä¿æŒæœåŠ¡å™¨é”å®šä»¥ä¾¿é‡è¿`)\n          console.log(`ğŸ”’ [${WINDOW_ID}] å½“å‰é”å®šæœåŠ¡å™¨: ${this.manager.getWindowServerLock()?.server}`)\n          console.log(`ğŸ“Š [${WINDOW_ID}] å¾…å¤„ç†ä»»åŠ¡æ•°: ${this.manager.windowTasks.size}`)\n\n          reject(error)\n        }\n\n        this.manager.wsConnection.onmessage = (event) => {\n          try {\n            // ğŸ”¥ å®˜æ–¹æ ‡å‡†æ¶ˆæ¯å¤„ç† - å®Œå…¨é‡æ„ç‰ˆæœ¬ï¼ˆåŸºäº websockets_api_example.py ç¬¬34-45è¡Œï¼‰\n            const message = event.data\n\n            // å®˜æ–¹æ ‡å‡†ï¼šå¤„ç†äºŒè¿›åˆ¶æ¶ˆæ¯ï¼ˆé¢„è§ˆå›¾åƒï¼‰\n            if (message instanceof ArrayBuffer || message instanceof Blob) {\n              // å®˜æ–¹æ³¨é‡Šï¼špreviews are binary data - continue\n              return\n            }\n\n            // å®˜æ–¹æ ‡å‡†ï¼šåªå¤„ç†å­—ç¬¦ä¸²æ¶ˆæ¯\n            if (typeof message === 'string') {\n              try {\n                const parsedMessage = JSON.parse(message)\n\n                // è°ƒç”¨é‡æ„åçš„æ¶ˆæ¯å¤„ç†å‡½æ•°\n                this.manager.handleWebSocketMessage(parsedMessage)\n              } catch (parseError) {\n                console.error('âŒ [OFFICIAL] JSONè§£æå¤±è´¥:', parseError.message)\n              }\n            }\n\n          } catch (error) {\n            console.error('âŒ [OFFICIAL] WebSocketæ¶ˆæ¯å¤„ç†å¤±è´¥:', error)\n          }\n        }\n      })\n    } catch (error) {\n      console.error('âŒ åˆå§‹åŒ– WebSocket å¤±è´¥:', error)\n\n      // ğŸ”§ æ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯å¦æ¸…é™¤æœåŠ¡å™¨é”å®š\n      if (error.message.includes('è´Ÿè½½å‡è¡¡å™¨') || error.message.includes('æ— æ³•è·å–å¯ç”¨çš„ComfyUIæœåŠ¡å™¨')) {\n        // å¦‚æœæ˜¯è´Ÿè½½å‡è¡¡å™¨é”™è¯¯ï¼Œæ¸…é™¤æœåŠ¡å™¨é”å®š\n        this.manager.currentWebSocketServer = null\n        this.manager.clearWindowServerLock()\n        console.log('ğŸ”“ è´Ÿè½½å‡è¡¡å™¨é”™è¯¯ï¼Œæ¸…é™¤æœåŠ¡å™¨é”å®š')\n      } else if (error.message.includes('ComfyUIæœåŠ¡å™¨ä¸å¯è¾¾') || error.message.includes('WebSocket è¿æ¥è¶…æ—¶')) {\n        // å¦‚æœæ˜¯è¿æ¥é”™è¯¯ä½†æœåŠ¡å™¨å¯èƒ½æ¢å¤ï¼Œä¿æŒé”å®šä»¥ä¾¿é‡è¯•\n        console.log('ğŸ”’ è¿æ¥é”™è¯¯ä½†ä¿æŒæœåŠ¡å™¨é”å®šä»¥ä¾¿é‡è¯•')\n      } else {\n        // å…¶ä»–æœªçŸ¥é”™è¯¯ï¼Œæ¸…é™¤é”å®š\n        this.manager.currentWebSocketServer = null\n        this.manager.clearWindowServerLock()\n        console.log('ğŸ”“ æœªçŸ¥é”™è¯¯ï¼Œæ¸…é™¤æœåŠ¡å™¨é”å®š')\n      }\n\n      throw error\n    }\n  }\n\n  // è¾…åŠ©æ–¹æ³•\n  _logServerConsistency(action, promptId = null) {\n    const timestamp = new Date().toISOString()\n    console.log(`ğŸ” [SERVER_TRACK] ${timestamp} - ${action}`)\n    console.log(`ğŸ” [SERVER_TRACK] å½“å‰WebSocketæœåŠ¡å™¨: ${this.manager.currentWebSocketServer}`)\n    console.log(`ğŸ” [SERVER_TRACK] WebSocketè¿æ¥çŠ¶æ€: ${this.manager.wsConnection?.readyState} (1=OPEN)`)\n    console.log(`ğŸ” [SERVER_TRACK] isWsConnected: ${this.manager.isWsConnected}`)\n    if (promptId) {\n      console.log(`ğŸ” [PROMPT_ID_TRACK] å½“å‰prompt_id: ${promptId}`)\n    }\n    console.log(`ğŸ” [SERVER_TRACK] å¾…å¤„ç†ä»»åŠ¡æ•°: ${this.manager.windowTasks.size}`)\n    console.log('ğŸ” [SERVER_TRACK] =====================================')\n  }\n\n  _showNotification(message, type = 'info') {\n    const timestamp = new Date().toLocaleTimeString()\n    const typeEmoji = {\n      'success': 'âœ…',\n      'error': 'âŒ',\n      'warning': 'âš ï¸',\n      'info': 'â„¹ï¸'\n    }\n\n    console.log(`${typeEmoji[type] || 'â„¹ï¸'} [${timestamp}] ${message}`)\n\n    // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ä¾›Vueç»„ä»¶ç›‘å¬\n    if (typeof window !== 'undefined') {\n      window.dispatchEvent(new CustomEvent('comfyui-status', {\n        detail: { message, type, timestamp }\n      }))\n    }\n  }\n}\n\n// åˆ›å»ºè¿æ¥ç®¡ç†å™¨å®ä¾‹\nconst webSocketConnection = new WebSocketConnection(webSocketManager)\n\n// å°†è¿æ¥æ–¹æ³•æ·»åŠ åˆ°ä¸»ç®¡ç†å™¨\nwebSocketManager.initializeWebSocket = webSocketConnection.initializeWebSocket.bind(webSocketConnection)\n\nexport default webSocketConnection\nexport { webSocketConnection }\n"
        }
    ]
}