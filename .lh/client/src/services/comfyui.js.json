{
    "sourceFile": "client/src/services/comfyui.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 41,
            "patches": [
                {
                    "date": 1752326450066,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752326477059,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -31,27 +31,48 @@\n \r\n // é…ç½®ç¼“å­˜\r\n let configCache = null\r\n \r\n-// ä»localStorageè·å–é…ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤é…ç½®\r\n-function getComfyUIConfig(forceRefresh = false) {\r\n+// ä»æœåŠ¡å™¨å’ŒlocalStorageè·å–é…ç½®\r\n+async function getComfyUIConfig(forceRefresh = false) {\r\n   // å¦‚æœå¼ºåˆ¶åˆ·æ–°æˆ–ç¼“å­˜ä¸ºç©ºï¼Œé‡æ–°è¯»å–é…ç½®\r\n   if (forceRefresh || !configCache) {\r\n-    const savedConfig = localStorage.getItem('comfyui_config')\r\n-    if (savedConfig) {\r\n-      try {\r\n-        const parsed = JSON.parse(savedConfig)\r\n-        configCache = { ...DEFAULT_CONFIG, ...parsed }\r\n-        console.log('ğŸ”„ é…ç½®å·²åˆ·æ–°:', configCache)\r\n-      } catch (error) {\r\n-        console.warn('è§£æä¿å­˜çš„é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error)\r\n-        configCache = { ...DEFAULT_CONFIG }\r\n+    try {\r\n+      // é¦–å…ˆè·å–æœåŠ¡å™¨é…ç½®ä½œä¸ºåŸºç¡€\r\n+      const serverConfig = await getDefaultConfig();\r\n+\r\n+      // ç„¶åæ£€æŸ¥localStorageä¸­çš„ç”¨æˆ·è‡ªå®šä¹‰é…ç½®\r\n+      const savedConfig = localStorage.getItem('comfyui_config');\r\n+      if (savedConfig) {\r\n+        try {\r\n+          const parsed = JSON.parse(savedConfig);\r\n+          // åˆå¹¶æœåŠ¡å™¨é…ç½®å’Œç”¨æˆ·é…ç½®ï¼Œç”¨æˆ·é…ç½®ä¼˜å…ˆ\r\n+          configCache = { ...serverConfig, ...parsed };\r\n+          console.log('ğŸ”„ é…ç½®å·²åˆ·æ–°ï¼ˆæœåŠ¡å™¨+ç”¨æˆ·ï¼‰:', configCache);\r\n+        } catch (error) {\r\n+          console.warn('è§£æä¿å­˜çš„é…ç½®å¤±è´¥ï¼Œä½¿ç”¨æœåŠ¡å™¨é…ç½®:', error);\r\n+          configCache = { ...serverConfig };\r\n+        }\r\n+      } else {\r\n+        configCache = { ...serverConfig };\r\n+        console.log('ğŸ”„ ä½¿ç”¨æœåŠ¡å™¨é…ç½®:', configCache);\r\n       }\r\n-    } else {\r\n-      configCache = { ...DEFAULT_CONFIG }\r\n+    } catch (error) {\r\n+      console.error('âŒ è·å–é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜æˆ–é»˜è®¤é…ç½®:', error);\r\n+      if (!configCache) {\r\n+        // å¦‚æœè¿ç¼“å­˜éƒ½æ²¡æœ‰ï¼Œä½¿ç”¨ç¡¬ç¼–ç çš„é»˜è®¤é…ç½®\r\n+        configCache = {\r\n+          COMFYUI_SERVER_URL: 'https://hwf0p724ub-8188.cnb.run',\r\n+          CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n+          TIMEOUT: 300000,\r\n+          BACKUP_SERVERS: [],\r\n+          AUTO_SWITCH: true,\r\n+          MAX_RETRIES: 3\r\n+        };\r\n+      }\r\n     }\r\n   }\r\n-  return { ...configCache }\r\n+  return { ...configCache };\r\n }\r\n \r\n // ä¿å­˜é…ç½®åˆ°localStorage\r\n function saveComfyUIConfig(config) {\r\n"
                },
                {
                    "date": 1752326498699,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -182,21 +182,21 @@\n function getCurrentConfig(forceRefresh = false) {\r\n   return getComfyUIConfig(forceRefresh)\r\n }\r\n \r\n-// è·å–APIåŸºç¡€URL - ç›´è¿æ¨¡å¼\r\n-function getApiBaseUrl() {\r\n-  const config = getComfyUIConfig(true)\r\n-  console.log('ğŸ¯ ç›´è¿ComfyUIæœåŠ¡å™¨:', config.COMFYUI_SERVER_URL)\r\n+// è·å–APIåŸºç¡€URL - åŠ¨æ€é…ç½®æ¨¡å¼\r\n+async function getApiBaseUrl() {\r\n+  const config = await getComfyUIConfig(true);\r\n+  console.log('ğŸ¯ ä½¿ç”¨ComfyUIæœåŠ¡å™¨:', config.COMFYUI_SERVER_URL);\r\n \r\n-  let baseUrl = config.COMFYUI_SERVER_URL\r\n+  let baseUrl = config.COMFYUI_SERVER_URL;\r\n \r\n   // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n   if (baseUrl && baseUrl.endsWith('/')) {\r\n-    baseUrl = baseUrl.slice(0, -1)\r\n+    baseUrl = baseUrl.slice(0, -1);\r\n   }\r\n \r\n-  return baseUrl\r\n+  return baseUrl;\r\n }\r\n \r\n // é‡ç½®ä¸ºé»˜è®¤é…ç½®\r\n function resetToDefaultConfig() {\r\n"
                },
                {
                    "date": 1752326513006,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -177,11 +177,11 @@\n     proxyUpdate: proxyUpdateResult\r\n   }\r\n }\r\n \r\n-// è·å–å½“å‰é…ç½®\r\n-function getCurrentConfig(forceRefresh = false) {\r\n-  return getComfyUIConfig(forceRefresh)\r\n+// è·å–å½“å‰é…ç½®ï¼ˆå¼‚æ­¥ï¼‰\r\n+async function getCurrentConfig(forceRefresh = false) {\r\n+  return await getComfyUIConfig(forceRefresh);\r\n }\r\n \r\n // è·å–APIåŸºç¡€URL - åŠ¨æ€é…ç½®æ¨¡å¼\r\n async function getApiBaseUrl() {\r\n"
                },
                {
                    "date": 1752326535389,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -152,31 +152,31 @@\n }\r\n \r\n // æ›´æ–°é…ç½®\r\n async function updateComfyUIConfig(newConfig) {\r\n-  const currentConfig = getComfyUIConfig(true) // å¼ºåˆ¶åˆ·æ–°å½“å‰é…ç½®\r\n-  const updatedConfig = { ...currentConfig, ...newConfig }\r\n+  const currentConfig = await getComfyUIConfig(true); // å¼ºåˆ¶åˆ·æ–°å½“å‰é…ç½®\r\n+  const updatedConfig = { ...currentConfig, ...newConfig };\r\n \r\n-  console.log('ğŸ”„ æ›´æ–°é…ç½®:', updatedConfig)\r\n+  console.log('ğŸ”„ æ›´æ–°é…ç½®:', updatedConfig);\r\n \r\n   // ä¿å­˜åˆ°localStorageï¼ˆè¿™ä¼šæ¸…é™¤ç¼“å­˜ï¼‰\r\n-  saveComfyUIConfig(updatedConfig)\r\n+  saveComfyUIConfig(updatedConfig);\r\n \r\n   // å¼ºåˆ¶åˆ·æ–°é…ç½®ç¼“å­˜\r\n-  configCache = null\r\n+  configCache = null;\r\n \r\n   // é€šçŸ¥é…ç½®å˜æ›´\r\n-  notifyConfigChange(updatedConfig)\r\n+  notifyConfigChange(updatedConfig);\r\n \r\n   // åŒæ—¶æ›´æ–°ä»£ç†æœåŠ¡å™¨é…ç½®\r\n-  const proxyUpdateResult = await updateProxyServerConfig(updatedConfig)\r\n+  const proxyUpdateResult = await updateProxyServerConfig(updatedConfig);\r\n \r\n-  console.log('âœ… é…ç½®æ›´æ–°å®Œæˆï¼Œæ–°é…ç½®å·²ç”Ÿæ•ˆ')\r\n+  console.log('âœ… é…ç½®æ›´æ–°å®Œæˆï¼Œæ–°é…ç½®å·²ç”Ÿæ•ˆ');\r\n \r\n   return {\r\n     config: updatedConfig,\r\n     proxyUpdate: proxyUpdateResult\r\n-  }\r\n+  };\r\n }\r\n \r\n // è·å–å½“å‰é…ç½®ï¼ˆå¼‚æ­¥ï¼‰\r\n async function getCurrentConfig(forceRefresh = false) {\r\n"
                },
                {
                    "date": 1752326556632,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -314,13 +314,13 @@\n \r\n // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n async function submitWorkflow(workflowPrompt) {\r\n   try {\r\n-    const config = getComfyUIConfig()\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n-    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n-    console.log('ğŸ”§ ä½¿ç”¨ä»£ç†:', config.USE_PROXY ? 'æ˜¯' : 'å¦')\r\n+    const config = await getComfyUIConfig();\r\n+    const apiBaseUrl = await getApiBaseUrl();\r\n+    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI');\r\n+    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`);\r\n+    console.log('ğŸ”§ ä½¿ç”¨ä»£ç†:', config.USE_PROXY ? 'æ˜¯' : 'å¦');\r\n \r\n     // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n     const requestBody = {\r\n       client_id: config.CLIENT_ID,\r\n"
                },
                {
                    "date": 1752326596152,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -211,12 +211,12 @@\n \r\n // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ Base64å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨å¹¶è·å–æ–‡ä»¶å\r\n async function uploadImageToComfyUI(base64Image) {\r\n   try {\r\n-    const config = getComfyUIConfig()\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n-    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n+    const config = await getComfyUIConfig();\r\n+    const apiBaseUrl = await getApiBaseUrl();\r\n+    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨');\r\n+    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`);\r\n \r\n     // éªŒè¯base64æ ¼å¼\r\n     if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n       throw new Error('æ— æ•ˆçš„base64å›¾ç‰‡æ ¼å¼')\r\n"
                },
                {
                    "date": 1752326636874,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -374,12 +374,12 @@\n \r\n // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n async function checkTaskStatus(promptId) {\r\n   try {\r\n-    const config = getComfyUIConfig()\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`)\r\n-    const response = await fetch(`${apiBaseUrl}/history/${promptId}`)\r\n+    const config = await getComfyUIConfig();\r\n+    const apiBaseUrl = await getApiBaseUrl();\r\n+    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`);\r\n+    const response = await fetch(`${apiBaseUrl}/history/${promptId}`);\r\n \r\n     if (!response.ok) {\r\n       throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText}`)\r\n     }\r\n"
                },
                {
                    "date": 1752326655020,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -395,10 +395,10 @@\n \r\n // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n async function getGeneratedImage(taskResult) {\r\n   try {\r\n-    const config = getComfyUIConfig()\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n+    const config = await getComfyUIConfig();\r\n+    const apiBaseUrl = await getApiBaseUrl();\r\n \r\n     // ä»ä»»åŠ¡ç»“æœä¸­æ‰¾åˆ°è¾“å‡ºå›¾ç‰‡\r\n     const outputs = taskResult.outputs\r\n     let imageInfo = null\r\n"
                },
                {
                    "date": 1752327478336,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,13 +16,13 @@\n       AUTO_SWITCH: config.AUTO_SWITCH,\r\n       MAX_RETRIES: config.MAX_RETRIES\r\n     };\r\n   } catch (error) {\r\n-    console.warn('âš ï¸ è·å–æœåŠ¡å™¨é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¡¬ç¼–ç é»˜è®¤å€¼:', error);\r\n+    console.warn('âš ï¸ è·å–æœåŠ¡å™¨é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼:', error);\r\n     return {\r\n-      COMFYUI_SERVER_URL: 'https://hwf0p724ub-8188.cnb.run',\r\n-      CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n-      TIMEOUT: 300000,\r\n+      COMFYUI_SERVER_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://your-comfyui-server.com',\r\n+      CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'your-comfyui-client-id',\r\n+      TIMEOUT: parseInt(import.meta.env.VITE_COMFYUI_TIMEOUT) || 300000,\r\n       BACKUP_SERVERS: [],\r\n       AUTO_SWITCH: true,\r\n       MAX_RETRIES: 3\r\n     };\r\n"
                },
                {
                    "date": 1752327494435,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -58,13 +58,13 @@\n       }\r\n     } catch (error) {\r\n       console.error('âŒ è·å–é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜æˆ–é»˜è®¤é…ç½®:', error);\r\n       if (!configCache) {\r\n-        // å¦‚æœè¿ç¼“å­˜éƒ½æ²¡æœ‰ï¼Œä½¿ç”¨ç¡¬ç¼–ç çš„é»˜è®¤é…ç½®\r\n+        // å¦‚æœè¿ç¼“å­˜éƒ½æ²¡æœ‰ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤é…ç½®\r\n         configCache = {\r\n-          COMFYUI_SERVER_URL: 'https://hwf0p724ub-8188.cnb.run',\r\n-          CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n-          TIMEOUT: 300000,\r\n+          COMFYUI_SERVER_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://your-comfyui-server.com',\r\n+          CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'your-comfyui-client-id',\r\n+          TIMEOUT: parseInt(import.meta.env.VITE_COMFYUI_TIMEOUT) || 300000,\r\n           BACKUP_SERVERS: [],\r\n           AUTO_SWITCH: true,\r\n           MAX_RETRIES: 3\r\n         };\r\n"
                },
                {
                    "date": 1752328761857,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -31,34 +31,73 @@\n \r\n // é…ç½®ç¼“å­˜\r\n let configCache = null\r\n \r\n+// æ£€æŸ¥å¹¶æ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®\r\n+function cleanupOldHardcodedConfig() {\r\n+  const savedConfig = localStorage.getItem('comfyui_config');\r\n+  if (savedConfig) {\r\n+    try {\r\n+      const parsed = JSON.parse(savedConfig);\r\n+      const hardcodedUrls = [\r\n+        'https://5gke5y9mzc-8188.cnb.run',\r\n+        'https://hwf0p724ub-8188.cnb.run',\r\n+        'https://dzqgp58z0s-8188.cnb.run'\r\n+      ];\r\n+      const hardcodedIds = [\r\n+        'abc1373d4ad648a3a81d0587fbe5534b'\r\n+      ];\r\n+\r\n+      // æ£€æŸ¥æ˜¯å¦åŒ…å«ç¡¬ç¼–ç é…ç½®\r\n+      const hasHardcodedUrl = hardcodedUrls.includes(parsed.COMFYUI_SERVER_URL);\r\n+      const hasHardcodedId = hardcodedIds.includes(parsed.CLIENT_ID);\r\n+\r\n+      if (hasHardcodedUrl || hasHardcodedId) {\r\n+        console.warn('ğŸ§¹ æ£€æµ‹åˆ°æ—§çš„ç¡¬ç¼–ç é…ç½®ï¼Œæ­£åœ¨æ¸…ç†...');\r\n+        console.warn('æ—§é…ç½®:', parsed);\r\n+        localStorage.removeItem('comfyui_config');\r\n+        console.log('âœ… å·²æ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®');\r\n+        return true;\r\n+      }\r\n+    } catch (error) {\r\n+      console.warn('è§£ælocalStorageé…ç½®å¤±è´¥ï¼Œæ¸…ç†é…ç½®:', error);\r\n+      localStorage.removeItem('comfyui_config');\r\n+      return true;\r\n+    }\r\n+  }\r\n+  return false;\r\n+}\r\n+\r\n // ä»æœåŠ¡å™¨å’ŒlocalStorageè·å–é…ç½®\r\n async function getComfyUIConfig(forceRefresh = false) {\r\n-  // å¦‚æœå¼ºåˆ¶åˆ·æ–°æˆ–ç¼“å­˜ä¸ºç©ºï¼Œé‡æ–°è¯»å–é…ç½®\r\n-  if (forceRefresh || !configCache) {\r\n+  // é¦–å…ˆæ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®\r\n+  const wasCleanedUp = cleanupOldHardcodedConfig();\r\n+\r\n+  // å¦‚æœå¼ºåˆ¶åˆ·æ–°ã€ç¼“å­˜ä¸ºç©ºæˆ–åˆšæ¸…ç†äº†é…ç½®ï¼Œé‡æ–°è¯»å–é…ç½®\r\n+  if (forceRefresh || !configCache || wasCleanedUp) {\r\n     try {\r\n       // é¦–å…ˆè·å–æœåŠ¡å™¨é…ç½®ä½œä¸ºåŸºç¡€\r\n       const serverConfig = await getDefaultConfig();\r\n+      console.log('ğŸŒ ä»æœåŠ¡å™¨è·å–çš„é…ç½®:', serverConfig);\r\n \r\n-      // ç„¶åæ£€æŸ¥localStorageä¸­çš„ç”¨æˆ·è‡ªå®šä¹‰é…ç½®\r\n+      // ç„¶åæ£€æŸ¥localStorageä¸­çš„ç”¨æˆ·è‡ªå®šä¹‰é…ç½®ï¼ˆå·²æ¸…ç†ç¡¬ç¼–ç ï¼‰\r\n       const savedConfig = localStorage.getItem('comfyui_config');\r\n       if (savedConfig) {\r\n         try {\r\n           const parsed = JSON.parse(savedConfig);\r\n-          // åˆå¹¶æœåŠ¡å™¨é…ç½®å’Œç”¨æˆ·é…ç½®ï¼Œç”¨æˆ·é…ç½®ä¼˜å…ˆ\r\n-          configCache = { ...serverConfig, ...parsed };\r\n-          console.log('ğŸ”„ é…ç½®å·²åˆ·æ–°ï¼ˆæœåŠ¡å™¨+ç”¨æˆ·ï¼‰:', configCache);\r\n+          // æœåŠ¡å™¨é…ç½®ä¼˜å…ˆï¼Œç”¨æˆ·é…ç½®ä½œä¸ºè¡¥å……\r\n+          configCache = { ...parsed, ...serverConfig };\r\n+          console.log('ğŸ”„ é…ç½®å·²åˆ·æ–°ï¼ˆæœåŠ¡å™¨ä¼˜å…ˆ+ç”¨æˆ·è¡¥å……ï¼‰:', configCache);\r\n         } catch (error) {\r\n           console.warn('è§£æä¿å­˜çš„é…ç½®å¤±è´¥ï¼Œä½¿ç”¨æœåŠ¡å™¨é…ç½®:', error);\r\n           configCache = { ...serverConfig };\r\n         }\r\n       } else {\r\n         configCache = { ...serverConfig };\r\n-        console.log('ğŸ”„ ä½¿ç”¨æœåŠ¡å™¨é…ç½®:', configCache);\r\n+        console.log('ğŸ”„ ä½¿ç”¨çº¯æœåŠ¡å™¨é…ç½®:', configCache);\r\n       }\r\n     } catch (error) {\r\n-      console.error('âŒ è·å–é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜æˆ–é»˜è®¤é…ç½®:', error);\r\n+      console.error('âŒ è·å–é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤é…ç½®:', error);\r\n       if (!configCache) {\r\n         // å¦‚æœè¿ç¼“å­˜éƒ½æ²¡æœ‰ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤é…ç½®\r\n         configCache = {\r\n           COMFYUI_SERVER_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://your-comfyui-server.com',\r\n"
                },
                {
                    "date": 1752328900466,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,119 +1,42 @@\n-// ComfyUIå·¥ä½œæµæœåŠ¡ - åŠ¨æ€é…ç½®æ¨¡å¼\r\n+// ComfyUIå·¥ä½œæµæœåŠ¡ - ç›´è¿æ¨¡å¼\r\n import undressWorkflow from '../workflows/undress.json'\r\n import faceSwapWorkflow from '../workflows/faceswap2.0.json'\r\n import comfyUIConfig from '../config/comfyui.config.js'\r\n import pointsManager from '../utils/pointsManager.js'\r\n \r\n-// è·å–åŠ¨æ€é…ç½®çš„é»˜è®¤å€¼\r\n-async function getDefaultConfig() {\r\n-  try {\r\n-    const config = await comfyUIConfig.getConfig();\r\n-    return {\r\n-      COMFYUI_SERVER_URL: config.BASE_URL,\r\n-      CLIENT_ID: config.CLIENT_ID,\r\n-      TIMEOUT: config.REQUEST_TIMEOUT,\r\n-      BACKUP_SERVERS: config.BACKUP_SERVERS,\r\n-      AUTO_SWITCH: config.AUTO_SWITCH,\r\n-      MAX_RETRIES: config.MAX_RETRIES\r\n-    };\r\n-  } catch (error) {\r\n-    console.warn('âš ï¸ è·å–æœåŠ¡å™¨é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼:', error);\r\n-    return {\r\n-      COMFYUI_SERVER_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://your-comfyui-server.com',\r\n-      CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'your-comfyui-client-id',\r\n-      TIMEOUT: parseInt(import.meta.env.VITE_COMFYUI_TIMEOUT) || 300000,\r\n-      BACKUP_SERVERS: [],\r\n-      AUTO_SWITCH: true,\r\n-      MAX_RETRIES: 3\r\n-    };\r\n-  }\r\n+// APIé…ç½® - ç›´è¿æ¨¡å¼\r\n+const DEFAULT_CONFIG = {\r\n+  // ComfyUIæœåŠ¡å™¨URLï¼ˆç”¨æˆ·å¯é…ç½®ï¼‰\r\n+  COMFYUI_SERVER_URL: comfyUIConfig.BASE_URL,\r\n+  CLIENT_ID: comfyUIConfig.CLIENT_ID,\r\n+  TIMEOUT: 300000 // 5åˆ†é’Ÿ\r\n }\r\n \r\n // é…ç½®ç¼“å­˜\r\n let configCache = null\r\n \r\n-// æ£€æŸ¥å¹¶æ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®\r\n-function cleanupOldHardcodedConfig() {\r\n-  const savedConfig = localStorage.getItem('comfyui_config');\r\n-  if (savedConfig) {\r\n-    try {\r\n-      const parsed = JSON.parse(savedConfig);\r\n-      const hardcodedUrls = [\r\n-        'https://5gke5y9mzc-8188.cnb.run',\r\n-        'https://hwf0p724ub-8188.cnb.run',\r\n-        'https://dzqgp58z0s-8188.cnb.run'\r\n-      ];\r\n-      const hardcodedIds = [\r\n-        'abc1373d4ad648a3a81d0587fbe5534b'\r\n-      ];\r\n-\r\n-      // æ£€æŸ¥æ˜¯å¦åŒ…å«ç¡¬ç¼–ç é…ç½®\r\n-      const hasHardcodedUrl = hardcodedUrls.includes(parsed.COMFYUI_SERVER_URL);\r\n-      const hasHardcodedId = hardcodedIds.includes(parsed.CLIENT_ID);\r\n-\r\n-      if (hasHardcodedUrl || hasHardcodedId) {\r\n-        console.warn('ğŸ§¹ æ£€æµ‹åˆ°æ—§çš„ç¡¬ç¼–ç é…ç½®ï¼Œæ­£åœ¨æ¸…ç†...');\r\n-        console.warn('æ—§é…ç½®:', parsed);\r\n-        localStorage.removeItem('comfyui_config');\r\n-        console.log('âœ… å·²æ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®');\r\n-        return true;\r\n+// ä»localStorageè·å–é…ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤é…ç½®\r\n+function getComfyUIConfig(forceRefresh = false) {\r\n+  // å¦‚æœå¼ºåˆ¶åˆ·æ–°æˆ–ç¼“å­˜ä¸ºç©ºï¼Œé‡æ–°è¯»å–é…ç½®\r\n+  if (forceRefresh || !configCache) {\r\n+    const savedConfig = localStorage.getItem('comfyui_config')\r\n+    if (savedConfig) {\r\n+      try {\r\n+        const parsed = JSON.parse(savedConfig)\r\n+        configCache = { ...DEFAULT_CONFIG, ...parsed }\r\n+        console.log('ğŸ”„ é…ç½®å·²åˆ·æ–°:', configCache)\r\n+      } catch (error) {\r\n+        console.warn('è§£æä¿å­˜çš„é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error)\r\n+        configCache = { ...DEFAULT_CONFIG }\r\n       }\r\n-    } catch (error) {\r\n-      console.warn('è§£ælocalStorageé…ç½®å¤±è´¥ï¼Œæ¸…ç†é…ç½®:', error);\r\n-      localStorage.removeItem('comfyui_config');\r\n-      return true;\r\n+    } else {\r\n+      configCache = { ...DEFAULT_CONFIG }\r\n     }\r\n   }\r\n-  return false;\r\n+  return { ...configCache }\r\n }\r\n \r\n-// ä»æœåŠ¡å™¨å’ŒlocalStorageè·å–é…ç½®\r\n-async function getComfyUIConfig(forceRefresh = false) {\r\n-  // é¦–å…ˆæ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®\r\n-  const wasCleanedUp = cleanupOldHardcodedConfig();\r\n-\r\n-  // å¦‚æœå¼ºåˆ¶åˆ·æ–°ã€ç¼“å­˜ä¸ºç©ºæˆ–åˆšæ¸…ç†äº†é…ç½®ï¼Œé‡æ–°è¯»å–é…ç½®\r\n-  if (forceRefresh || !configCache || wasCleanedUp) {\r\n-    try {\r\n-      // é¦–å…ˆè·å–æœåŠ¡å™¨é…ç½®ä½œä¸ºåŸºç¡€\r\n-      const serverConfig = await getDefaultConfig();\r\n-      console.log('ğŸŒ ä»æœåŠ¡å™¨è·å–çš„é…ç½®:', serverConfig);\r\n-\r\n-      // ç„¶åæ£€æŸ¥localStorageä¸­çš„ç”¨æˆ·è‡ªå®šä¹‰é…ç½®ï¼ˆå·²æ¸…ç†ç¡¬ç¼–ç ï¼‰\r\n-      const savedConfig = localStorage.getItem('comfyui_config');\r\n-      if (savedConfig) {\r\n-        try {\r\n-          const parsed = JSON.parse(savedConfig);\r\n-          // æœåŠ¡å™¨é…ç½®ä¼˜å…ˆï¼Œç”¨æˆ·é…ç½®ä½œä¸ºè¡¥å……\r\n-          configCache = { ...parsed, ...serverConfig };\r\n-          console.log('ğŸ”„ é…ç½®å·²åˆ·æ–°ï¼ˆæœåŠ¡å™¨ä¼˜å…ˆ+ç”¨æˆ·è¡¥å……ï¼‰:', configCache);\r\n-        } catch (error) {\r\n-          console.warn('è§£æä¿å­˜çš„é…ç½®å¤±è´¥ï¼Œä½¿ç”¨æœåŠ¡å™¨é…ç½®:', error);\r\n-          configCache = { ...serverConfig };\r\n-        }\r\n-      } else {\r\n-        configCache = { ...serverConfig };\r\n-        console.log('ğŸ”„ ä½¿ç”¨çº¯æœåŠ¡å™¨é…ç½®:', configCache);\r\n-      }\r\n-    } catch (error) {\r\n-      console.error('âŒ è·å–é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤é…ç½®:', error);\r\n-      if (!configCache) {\r\n-        // å¦‚æœè¿ç¼“å­˜éƒ½æ²¡æœ‰ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤é…ç½®\r\n-        configCache = {\r\n-          COMFYUI_SERVER_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://your-comfyui-server.com',\r\n-          CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'your-comfyui-client-id',\r\n-          TIMEOUT: parseInt(import.meta.env.VITE_COMFYUI_TIMEOUT) || 300000,\r\n-          BACKUP_SERVERS: [],\r\n-          AUTO_SWITCH: true,\r\n-          MAX_RETRIES: 3\r\n-        };\r\n-      }\r\n-    }\r\n-  }\r\n-  return { ...configCache };\r\n-}\r\n-\r\n // ä¿å­˜é…ç½®åˆ°localStorage\r\n function saveComfyUIConfig(config) {\r\n   try {\r\n     localStorage.setItem('comfyui_config', JSON.stringify(config))\r\n@@ -191,51 +114,51 @@\n }\r\n \r\n // æ›´æ–°é…ç½®\r\n async function updateComfyUIConfig(newConfig) {\r\n-  const currentConfig = await getComfyUIConfig(true); // å¼ºåˆ¶åˆ·æ–°å½“å‰é…ç½®\r\n-  const updatedConfig = { ...currentConfig, ...newConfig };\r\n+  const currentConfig = getComfyUIConfig(true) // å¼ºåˆ¶åˆ·æ–°å½“å‰é…ç½®\r\n+  const updatedConfig = { ...currentConfig, ...newConfig }\r\n \r\n-  console.log('ğŸ”„ æ›´æ–°é…ç½®:', updatedConfig);\r\n+  console.log('ğŸ”„ æ›´æ–°é…ç½®:', updatedConfig)\r\n \r\n   // ä¿å­˜åˆ°localStorageï¼ˆè¿™ä¼šæ¸…é™¤ç¼“å­˜ï¼‰\r\n-  saveComfyUIConfig(updatedConfig);\r\n+  saveComfyUIConfig(updatedConfig)\r\n \r\n   // å¼ºåˆ¶åˆ·æ–°é…ç½®ç¼“å­˜\r\n-  configCache = null;\r\n+  configCache = null\r\n \r\n   // é€šçŸ¥é…ç½®å˜æ›´\r\n-  notifyConfigChange(updatedConfig);\r\n+  notifyConfigChange(updatedConfig)\r\n \r\n   // åŒæ—¶æ›´æ–°ä»£ç†æœåŠ¡å™¨é…ç½®\r\n-  const proxyUpdateResult = await updateProxyServerConfig(updatedConfig);\r\n+  const proxyUpdateResult = await updateProxyServerConfig(updatedConfig)\r\n \r\n-  console.log('âœ… é…ç½®æ›´æ–°å®Œæˆï¼Œæ–°é…ç½®å·²ç”Ÿæ•ˆ');\r\n+  console.log('âœ… é…ç½®æ›´æ–°å®Œæˆï¼Œæ–°é…ç½®å·²ç”Ÿæ•ˆ')\r\n \r\n   return {\r\n     config: updatedConfig,\r\n     proxyUpdate: proxyUpdateResult\r\n-  };\r\n+  }\r\n }\r\n \r\n-// è·å–å½“å‰é…ç½®ï¼ˆå¼‚æ­¥ï¼‰\r\n-async function getCurrentConfig(forceRefresh = false) {\r\n-  return await getComfyUIConfig(forceRefresh);\r\n+// è·å–å½“å‰é…ç½®\r\n+function getCurrentConfig(forceRefresh = false) {\r\n+  return getComfyUIConfig(forceRefresh)\r\n }\r\n \r\n-// è·å–APIåŸºç¡€URL - åŠ¨æ€é…ç½®æ¨¡å¼\r\n-async function getApiBaseUrl() {\r\n-  const config = await getComfyUIConfig(true);\r\n-  console.log('ğŸ¯ ä½¿ç”¨ComfyUIæœåŠ¡å™¨:', config.COMFYUI_SERVER_URL);\r\n+// è·å–APIåŸºç¡€URL - ç›´è¿æ¨¡å¼\r\n+function getApiBaseUrl() {\r\n+  const config = getComfyUIConfig(true)\r\n+  console.log('ğŸ¯ ç›´è¿ComfyUIæœåŠ¡å™¨:', config.COMFYUI_SERVER_URL)\r\n \r\n-  let baseUrl = config.COMFYUI_SERVER_URL;\r\n+  let baseUrl = config.COMFYUI_SERVER_URL\r\n \r\n   // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n   if (baseUrl && baseUrl.endsWith('/')) {\r\n-    baseUrl = baseUrl.slice(0, -1);\r\n+    baseUrl = baseUrl.slice(0, -1)\r\n   }\r\n \r\n-  return baseUrl;\r\n+  return baseUrl\r\n }\r\n \r\n // é‡ç½®ä¸ºé»˜è®¤é…ç½®\r\n function resetToDefaultConfig() {\r\n@@ -250,12 +173,12 @@\n \r\n // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ Base64å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨å¹¶è·å–æ–‡ä»¶å\r\n async function uploadImageToComfyUI(base64Image) {\r\n   try {\r\n-    const config = await getComfyUIConfig();\r\n-    const apiBaseUrl = await getApiBaseUrl();\r\n-    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨');\r\n-    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`);\r\n+    const config = getComfyUIConfig()\r\n+    const apiBaseUrl = getApiBaseUrl()\r\n+    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n+    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n \r\n     // éªŒè¯base64æ ¼å¼\r\n     if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n       throw new Error('æ— æ•ˆçš„base64å›¾ç‰‡æ ¼å¼')\r\n@@ -353,13 +276,13 @@\n \r\n // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n async function submitWorkflow(workflowPrompt) {\r\n   try {\r\n-    const config = await getComfyUIConfig();\r\n-    const apiBaseUrl = await getApiBaseUrl();\r\n-    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI');\r\n-    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`);\r\n-    console.log('ğŸ”§ ä½¿ç”¨ä»£ç†:', config.USE_PROXY ? 'æ˜¯' : 'å¦');\r\n+    const config = getComfyUIConfig()\r\n+    const apiBaseUrl = getApiBaseUrl()\r\n+    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n+    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n+    console.log('ğŸ”§ ä½¿ç”¨ä»£ç†:', config.USE_PROXY ? 'æ˜¯' : 'å¦')\r\n \r\n     // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n     const requestBody = {\r\n       client_id: config.CLIENT_ID,\r\n@@ -413,12 +336,12 @@\n \r\n // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n async function checkTaskStatus(promptId) {\r\n   try {\r\n-    const config = await getComfyUIConfig();\r\n-    const apiBaseUrl = await getApiBaseUrl();\r\n-    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`);\r\n-    const response = await fetch(`${apiBaseUrl}/history/${promptId}`);\r\n+    const config = getComfyUIConfig()\r\n+    const apiBaseUrl = getApiBaseUrl()\r\n+    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`)\r\n+    const response = await fetch(`${apiBaseUrl}/history/${promptId}`)\r\n \r\n     if (!response.ok) {\r\n       throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText}`)\r\n     }\r\n@@ -434,10 +357,10 @@\n \r\n // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n async function getGeneratedImage(taskResult) {\r\n   try {\r\n-    const config = await getComfyUIConfig();\r\n-    const apiBaseUrl = await getApiBaseUrl();\r\n+    const config = getComfyUIConfig()\r\n+    const apiBaseUrl = getApiBaseUrl()\r\n \r\n     // ä»ä»»åŠ¡ç»“æœä¸­æ‰¾åˆ°è¾“å‡ºå›¾ç‰‡\r\n     const outputs = taskResult.outputs\r\n     let imageInfo = null\r\n"
                },
                {
                    "date": 1752330205149,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,8 +2,9 @@\n import undressWorkflow from '../workflows/undress.json'\r\n import faceSwapWorkflow from '../workflows/faceswap2.0.json'\r\n import comfyUIConfig from '../config/comfyui.config.js'\r\n import pointsManager from '../utils/pointsManager.js'\r\n+import { updateAPIConfig } from './api.js'\r\n \r\n // APIé…ç½® - ç›´è¿æ¨¡å¼\r\n const DEFAULT_CONFIG = {\r\n   // ComfyUIæœåŠ¡å™¨URLï¼ˆç”¨æˆ·å¯é…ç½®ï¼‰\r\n"
                },
                {
                    "date": 1752330218715,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -104,8 +104,15 @@\n }\r\n \r\n // é€šçŸ¥é…ç½®å˜æ›´\r\n function notifyConfigChange(config) {\r\n+  // åŒæ­¥æ›´æ–°APIé…ç½®\r\n+  try {\r\n+    updateAPIConfig(config)\r\n+  } catch (error) {\r\n+    console.error('æ›´æ–°APIé…ç½®å¤±è´¥:', error)\r\n+  }\r\n+\r\n   configChangeListeners.forEach(listener => {\r\n     try {\r\n       listener(config)\r\n     } catch (error) {\r\n"
                },
                {
                    "date": 1752332190423,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -183,10 +183,10 @@\n async function uploadImageToComfyUI(base64Image) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n     const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n-    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n+    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šé€šè¿‡åç«¯è´Ÿè½½å‡è¡¡ä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n+    console.log('ğŸ“¡ åç«¯APIåœ°å€:', '/api/comfyui/upload')\r\n \r\n     // éªŒè¯base64æ ¼å¼\r\n     if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n       throw new Error('æ— æ•ˆçš„base64å›¾ç‰‡æ ¼å¼')\r\n"
                },
                {
                    "date": 1752332206742,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -214,18 +214,18 @@\n       type: mimeType,\r\n       size: `${(blob.size / 1024).toFixed(2)} KB`\r\n     })\r\n \r\n-    // ç›´è¿ä¸Šä¼ å›¾ç‰‡\r\n+    // é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡ä¸Šä¼ å›¾ç‰‡\r\n     const formData = new FormData()\r\n     formData.append('image', blob, filename)\r\n     formData.append('type', 'input')\r\n     formData.append('subfolder', '')\r\n     formData.append('overwrite', 'false')\r\n \r\n-    console.log('ğŸ”„ å¼€å§‹ä¸Šä¼ å›¾ç‰‡...')\r\n+    console.log('ğŸ”„ å¼€å§‹é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡ä¸Šä¼ å›¾ç‰‡...')\r\n \r\n-    const response = await fetch(`${apiBaseUrl}/upload/image`, {\r\n+    const response = await fetch('/api/comfyui/upload', {\r\n       method: 'POST',\r\n       body: formData\r\n     })\r\n \r\n"
                },
                {
                    "date": 1752332222579,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -239,13 +239,13 @@\n     const result = await response.json()\r\n     console.log('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', result)\r\n \r\n     // éªŒè¯è¿”å›ç»“æœ\r\n-    if (!result.name) {\r\n+    if (!result.success || !result.data?.name) {\r\n       throw new Error('ä¸Šä¼ å“åº”ä¸­ç¼ºå°‘æ–‡ä»¶å')\r\n     }\r\n \r\n-    return result.name\r\n+    return result.data.name\r\n \r\n   } catch (error) {\r\n     console.error('âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error)\r\n     throw new Error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`)\r\n"
                },
                {
                    "date": 1752332246255,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -286,11 +286,10 @@\n async function submitWorkflow(workflowPrompt) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n     const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n-    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n-    console.log('ğŸ”§ ä½¿ç”¨ä»£ç†:', config.USE_PROXY ? 'æ˜¯' : 'å¦')\r\n+    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šé€šè¿‡åç«¯è´Ÿè½½å‡è¡¡æäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n+    console.log('ğŸ“¡ åç«¯APIåœ°å€:', '/api/comfyui/prompt')\r\n \r\n     // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n     const requestBody = {\r\n       client_id: config.CLIENT_ID,\r\n"
                },
                {
                    "date": 1752332262277,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -302,20 +302,17 @@\n       node_49_exists: !!requestBody.prompt['49'],\r\n       node_49_image: requestBody.prompt['49']?.inputs?.image\r\n     })\r\n \r\n-    // ç¬¬äºŒæ­¥APIè°ƒç”¨ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n-    const promptUrl = `${apiBaseUrl}/prompt`\r\n-    console.log('ğŸŒ è°ƒç”¨å·¥ä½œæµAPI:', promptUrl)\r\n+    // ç¬¬äºŒæ­¥APIè°ƒç”¨ï¼šé€šè¿‡åç«¯è´Ÿè½½å‡è¡¡æäº¤å·¥ä½œæµåˆ°ComfyUI\r\n+    console.log('ğŸŒ è°ƒç”¨åç«¯è´Ÿè½½å‡è¡¡å·¥ä½œæµAPI: /api/comfyui/prompt')\r\n \r\n-    const response = await fetch(promptUrl, {\r\n+    const response = await fetch('/api/comfyui/prompt', {\r\n       method: 'POST',\r\n       headers: {\r\n         'Content-Type': 'application/json'\r\n       },\r\n-      body: JSON.stringify(requestBody),\r\n-      mode: 'cors',\r\n-      credentials: 'omit'\r\n+      body: JSON.stringify(requestBody)\r\n     })\r\n \r\n     console.log('ğŸ“¥ å·¥ä½œæµå“åº”çŠ¶æ€:', response.status, response.statusText)\r\n \r\n"
                },
                {
                    "date": 1752332278398,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -325,13 +325,13 @@\n     const result = await response.json()\r\n     console.log('âœ… å·¥ä½œæµæäº¤æˆåŠŸ:', result)\r\n \r\n     // éªŒè¯è¿”å›ç»“æœ\r\n-    if (!result.prompt_id) {\r\n+    if (!result.success || !result.data?.prompt_id) {\r\n       throw new Error('å·¥ä½œæµå“åº”ä¸­ç¼ºå°‘prompt_id')\r\n     }\r\n \r\n-    return result.prompt_id // è¿”å›ä»»åŠ¡ID\r\n+    return result.data.prompt_id // è¿”å›ä»»åŠ¡ID\r\n \r\n   } catch (error) {\r\n     console.error('âŒ å·¥ä½œæµæäº¤å¤±è´¥:', error)\r\n     throw new Error(`å·¥ä½œæµæäº¤å¤±è´¥: ${error.message}`)\r\n"
                },
                {
                    "date": 1752332302531,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -342,10 +342,10 @@\n async function checkTaskStatus(promptId) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n     const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`)\r\n-    const response = await fetch(`${apiBaseUrl}/history/${promptId}`)\r\n+    console.log('ğŸ” é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `/api/comfyui/history/${promptId}`)\r\n+    const response = await fetch(`/api/comfyui/history/${promptId}`)\r\n \r\n     if (!response.ok) {\r\n       throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText}`)\r\n     }\r\n"
                },
                {
                    "date": 1752332316415,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -350,10 +350,16 @@\n       throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText}`)\r\n     }\r\n \r\n     const result = await response.json()\r\n-    return result[promptId] || null\r\n \r\n+    // å¤„ç†åç«¯APIå“åº”æ ¼å¼\r\n+    if (result.success && result.data) {\r\n+      return result.data[promptId] || null\r\n+    } else {\r\n+      return result[promptId] || null\r\n+    }\r\n+\r\n   } catch (error) {\r\n     console.error('çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', error)\r\n     throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${error.message}`)\r\n   }\r\n"
                },
                {
                    "date": 1752332340881,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -414,17 +414,17 @@\n     }\r\n \r\n     console.log('ğŸ“· æœ€ç»ˆé€‰æ‹©çš„å›¾ç‰‡:', imageInfo)\r\n \r\n-    // æ„å»ºå›¾ç‰‡URL - æŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n+    // æ„å»ºå›¾ç‰‡URL - é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡\r\n     const params = new URLSearchParams({\r\n       filename: imageInfo.filename,\r\n       type: imageInfo.type,\r\n       subfolder: imageInfo.subfolder || ''\r\n     })\r\n-    const imageUrl = `${apiBaseUrl}/view?${params.toString()}`\r\n+    const imageUrl = `/api/comfyui/view?${params.toString()}`\r\n \r\n-    console.log('ğŸŒ è·å–å›¾ç‰‡URL:', imageUrl)\r\n+    console.log('ğŸŒ é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡è·å–å›¾ç‰‡URL:', imageUrl)\r\n \r\n     // è·å–å›¾ç‰‡æ•°æ®å¹¶è½¬æ¢ä¸ºbase64\r\n     const imageResponse = await fetch(imageUrl)\r\n     if (!imageResponse.ok) {\r\n"
                },
                {
                    "date": 1752332665069,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -183,10 +183,10 @@\n async function uploadImageToComfyUI(base64Image) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n     const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šé€šè¿‡åç«¯è´Ÿè½½å‡è¡¡ä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n-    console.log('ğŸ“¡ åç«¯APIåœ°å€:', '/api/comfyui/upload')\r\n+    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n+    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n \r\n     // éªŒè¯base64æ ¼å¼\r\n     if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n       throw new Error('æ— æ•ˆçš„base64å›¾ç‰‡æ ¼å¼')\r\n@@ -214,18 +214,18 @@\n       type: mimeType,\r\n       size: `${(blob.size / 1024).toFixed(2)} KB`\r\n     })\r\n \r\n-    // é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡ä¸Šä¼ å›¾ç‰‡\r\n+    // ç›´è¿ä¸Šä¼ å›¾ç‰‡\r\n     const formData = new FormData()\r\n     formData.append('image', blob, filename)\r\n     formData.append('type', 'input')\r\n     formData.append('subfolder', '')\r\n     formData.append('overwrite', 'false')\r\n \r\n-    console.log('ğŸ”„ å¼€å§‹é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡ä¸Šä¼ å›¾ç‰‡...')\r\n+    console.log('ğŸ”„ å¼€å§‹ä¸Šä¼ å›¾ç‰‡...')\r\n \r\n-    const response = await fetch('/api/comfyui/upload', {\r\n+    const response = await fetch(`${apiBaseUrl}/upload/image`, {\r\n       method: 'POST',\r\n       body: formData\r\n     })\r\n \r\n@@ -239,13 +239,13 @@\n     const result = await response.json()\r\n     console.log('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', result)\r\n \r\n     // éªŒè¯è¿”å›ç»“æœ\r\n-    if (!result.success || !result.data?.name) {\r\n+    if (!result.name) {\r\n       throw new Error('ä¸Šä¼ å“åº”ä¸­ç¼ºå°‘æ–‡ä»¶å')\r\n     }\r\n \r\n-    return result.data.name\r\n+    return result.name\r\n \r\n   } catch (error) {\r\n     console.error('âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error)\r\n     throw new Error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`)\r\n@@ -286,10 +286,11 @@\n async function submitWorkflow(workflowPrompt) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n     const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šé€šè¿‡åç«¯è´Ÿè½½å‡è¡¡æäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n-    console.log('ğŸ“¡ åç«¯APIåœ°å€:', '/api/comfyui/prompt')\r\n+    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n+    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n+    console.log('ğŸ”§ ä½¿ç”¨ä»£ç†:', config.USE_PROXY ? 'æ˜¯' : 'å¦')\r\n \r\n     // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n     const requestBody = {\r\n       client_id: config.CLIENT_ID,\r\n@@ -302,17 +303,20 @@\n       node_49_exists: !!requestBody.prompt['49'],\r\n       node_49_image: requestBody.prompt['49']?.inputs?.image\r\n     })\r\n \r\n-    // ç¬¬äºŒæ­¥APIè°ƒç”¨ï¼šé€šè¿‡åç«¯è´Ÿè½½å‡è¡¡æäº¤å·¥ä½œæµåˆ°ComfyUI\r\n-    console.log('ğŸŒ è°ƒç”¨åç«¯è´Ÿè½½å‡è¡¡å·¥ä½œæµAPI: /api/comfyui/prompt')\r\n+    // ç¬¬äºŒæ­¥APIè°ƒç”¨ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n+    const promptUrl = `${apiBaseUrl}/prompt`\r\n+    console.log('ğŸŒ è°ƒç”¨å·¥ä½œæµAPI:', promptUrl)\r\n \r\n-    const response = await fetch('/api/comfyui/prompt', {\r\n+    const response = await fetch(promptUrl, {\r\n       method: 'POST',\r\n       headers: {\r\n         'Content-Type': 'application/json'\r\n       },\r\n-      body: JSON.stringify(requestBody)\r\n+      body: JSON.stringify(requestBody),\r\n+      mode: 'cors',\r\n+      credentials: 'omit'\r\n     })\r\n \r\n     console.log('ğŸ“¥ å·¥ä½œæµå“åº”çŠ¶æ€:', response.status, response.statusText)\r\n \r\n@@ -325,13 +329,13 @@\n     const result = await response.json()\r\n     console.log('âœ… å·¥ä½œæµæäº¤æˆåŠŸ:', result)\r\n \r\n     // éªŒè¯è¿”å›ç»“æœ\r\n-    if (!result.success || !result.data?.prompt_id) {\r\n+    if (!result.prompt_id) {\r\n       throw new Error('å·¥ä½œæµå“åº”ä¸­ç¼ºå°‘prompt_id')\r\n     }\r\n \r\n-    return result.data.prompt_id // è¿”å›ä»»åŠ¡ID\r\n+    return result.prompt_id // è¿”å›ä»»åŠ¡ID\r\n \r\n   } catch (error) {\r\n     console.error('âŒ å·¥ä½œæµæäº¤å¤±è´¥:', error)\r\n     throw new Error(`å·¥ä½œæµæäº¤å¤±è´¥: ${error.message}`)\r\n@@ -342,24 +346,18 @@\n async function checkTaskStatus(promptId) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n     const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ” é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `/api/comfyui/history/${promptId}`)\r\n-    const response = await fetch(`/api/comfyui/history/${promptId}`)\r\n+    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`)\r\n+    const response = await fetch(`${apiBaseUrl}/history/${promptId}`)\r\n \r\n     if (!response.ok) {\r\n       throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText}`)\r\n     }\r\n \r\n     const result = await response.json()\r\n+    return result[promptId] || null\r\n \r\n-    // å¤„ç†åç«¯APIå“åº”æ ¼å¼\r\n-    if (result.success && result.data) {\r\n-      return result.data[promptId] || null\r\n-    } else {\r\n-      return result[promptId] || null\r\n-    }\r\n-\r\n   } catch (error) {\r\n     console.error('çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', error)\r\n     throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${error.message}`)\r\n   }\r\n@@ -414,17 +412,17 @@\n     }\r\n \r\n     console.log('ğŸ“· æœ€ç»ˆé€‰æ‹©çš„å›¾ç‰‡:', imageInfo)\r\n \r\n-    // æ„å»ºå›¾ç‰‡URL - é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡\r\n+    // æ„å»ºå›¾ç‰‡URL - æŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n     const params = new URLSearchParams({\r\n       filename: imageInfo.filename,\r\n       type: imageInfo.type,\r\n       subfolder: imageInfo.subfolder || ''\r\n     })\r\n-    const imageUrl = `/api/comfyui/view?${params.toString()}`\r\n+    const imageUrl = `${apiBaseUrl}/view?${params.toString()}`\r\n \r\n-    console.log('ğŸŒ é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡è·å–å›¾ç‰‡URL:', imageUrl)\r\n+    console.log('ğŸŒ è·å–å›¾ç‰‡URL:', imageUrl)\r\n \r\n     // è·å–å›¾ç‰‡æ•°æ®å¹¶è½¬æ¢ä¸ºbase64\r\n     const imageResponse = await fetch(imageUrl)\r\n     if (!imageResponse.ok) {\r\n"
                },
                {
                    "date": 1752332884368,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,8 +3,9 @@\n import faceSwapWorkflow from '../workflows/faceswap2.0.json'\r\n import comfyUIConfig from '../config/comfyui.config.js'\r\n import pointsManager from '../utils/pointsManager.js'\r\n import { updateAPIConfig } from './api.js'\r\n+import loadBalancer from './loadBalancer.js'\r\n \r\n // APIé…ç½® - ç›´è¿æ¨¡å¼\r\n const DEFAULT_CONFIG = {\r\n   // ComfyUIæœåŠ¡å™¨URLï¼ˆç”¨æˆ·å¯é…ç½®ï¼‰\r\n"
                },
                {
                    "date": 1752332902461,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -153,21 +153,35 @@\n function getCurrentConfig(forceRefresh = false) {\r\n   return getComfyUIConfig(forceRefresh)\r\n }\r\n \r\n-// è·å–APIåŸºç¡€URL - ç›´è¿æ¨¡å¼\r\n-function getApiBaseUrl() {\r\n-  const config = getComfyUIConfig(true)\r\n-  console.log('ğŸ¯ ç›´è¿ComfyUIæœåŠ¡å™¨:', config.COMFYUI_SERVER_URL)\r\n+// è·å–APIåŸºç¡€URL - ä½¿ç”¨è´Ÿè½½å‡è¡¡\r\n+async function getApiBaseUrl() {\r\n+  try {\r\n+    // ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\r\n+    const optimalServer = await loadBalancer.getOptimalServer()\r\n+    console.log('ğŸ¯ è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœåŠ¡å™¨:', optimalServer)\r\n \r\n-  let baseUrl = config.COMFYUI_SERVER_URL\r\n+    // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n+    let baseUrl = optimalServer\r\n+    if (baseUrl && baseUrl.endsWith('/')) {\r\n+      baseUrl = baseUrl.slice(0, -1)\r\n+    }\r\n \r\n-  // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n-  if (baseUrl && baseUrl.endsWith('/')) {\r\n-    baseUrl = baseUrl.slice(0, -1)\r\n+    return baseUrl\r\n+  } catch (error) {\r\n+    console.warn('âš ï¸ è´Ÿè½½å‡è¡¡å™¨å¤±è´¥ï¼Œä½¿ç”¨é…ç½®çš„æœåŠ¡å™¨:', error)\r\n+\r\n+    // é™çº§åˆ°é…ç½®çš„æœåŠ¡å™¨\r\n+    const config = getComfyUIConfig(true)\r\n+    let baseUrl = config.COMFYUI_SERVER_URL\r\n+\r\n+    if (baseUrl && baseUrl.endsWith('/')) {\r\n+      baseUrl = baseUrl.slice(0, -1)\r\n+    }\r\n+\r\n+    return baseUrl\r\n   }\r\n-\r\n-  return baseUrl\r\n }\r\n \r\n // é‡ç½®ä¸ºé»˜è®¤é…ç½®\r\n function resetToDefaultConfig() {\r\n"
                },
                {
                    "date": 1752332920823,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -298,14 +298,16 @@\n }\r\n \r\n // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n async function submitWorkflow(workflowPrompt) {\r\n+  let selectedServer = null\r\n   try {\r\n     const config = getComfyUIConfig()\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n+    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n+    selectedServer = apiBaseUrl // è®°å½•é€‰æ‹©çš„æœåŠ¡å™¨\r\n     console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n     console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n-    console.log('ğŸ”§ ä½¿ç”¨ä»£ç†:', config.USE_PROXY ? 'æ˜¯' : 'å¦')\r\n+    console.log('ğŸ”§ ä½¿ç”¨è´Ÿè½½å‡è¡¡:', 'æ˜¯')\r\n \r\n     // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n     const requestBody = {\r\n       client_id: config.CLIENT_ID,\r\n"
                },
                {
                    "date": 1752332934682,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -354,8 +354,15 @@\n     return result.prompt_id // è¿”å›ä»»åŠ¡ID\r\n \r\n   } catch (error) {\r\n     console.error('âŒ å·¥ä½œæµæäº¤å¤±è´¥:', error)\r\n+\r\n+    // è®°å½•æœåŠ¡å™¨å¤±è´¥\r\n+    if (selectedServer) {\r\n+      console.log('ğŸ“ è®°å½•æœåŠ¡å™¨å¤±è´¥:', selectedServer)\r\n+      await loadBalancer.recordFailure(selectedServer)\r\n+    }\r\n+\r\n     throw new Error(`å·¥ä½œæµæäº¤å¤±è´¥: ${error.message}`)\r\n   }\r\n }\r\n \r\n"
                },
                {
                    "date": 1752332949434,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -369,9 +369,9 @@\n // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n async function checkTaskStatus(promptId) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n+    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n     console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`)\r\n     const response = await fetch(`${apiBaseUrl}/history/${promptId}`)\r\n \r\n     if (!response.ok) {\r\n"
                },
                {
                    "date": 1752332964179,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -579,9 +579,9 @@\n \r\n // æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€\r\n async function checkComfyUIServerStatus() {\r\n   try {\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n+    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n     console.log('ğŸ” æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€:', apiBaseUrl)\r\n \r\n     const response = await fetch(`${apiBaseUrl}/system_stats`, {\r\n       method: 'GET',\r\n"
                },
                {
                    "date": 1752333462422,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -197,9 +197,9 @@\n // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ Base64å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨å¹¶è·å–æ–‡ä»¶å\r\n async function uploadImageToComfyUI(base64Image) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n+    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n     console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n     console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n \r\n     // éªŒè¯base64æ ¼å¼\r\n"
                },
                {
                    "date": 1752333492844,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -390,9 +390,9 @@\n // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n async function getGeneratedImage(taskResult) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n+    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n \r\n     // ä»ä»»åŠ¡ç»“æœä¸­æ‰¾åˆ°è¾“å‡ºå›¾ç‰‡\r\n     const outputs = taskResult.outputs\r\n     let imageInfo = null\r\n"
                },
                {
                    "date": 1752333507074,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -548,9 +548,9 @@\n         type: 'input',\r\n         subfolder: ''\r\n       })\r\n       const config = getComfyUIConfig()\r\n-      const apiBaseUrl = getApiBaseUrl()\r\n+      const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n       originalImage = `${apiBaseUrl}/view?${params.toString()}`\r\n       console.log('ğŸ“· è·å–èŠ‚ç‚¹49åŸå›¾URL:', originalImage)\r\n     } catch (error) {\r\n       console.warn('âš ï¸ è·å–èŠ‚ç‚¹49åŸå›¾å¤±è´¥ï¼Œä½¿ç”¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡:', error)\r\n"
                },
                {
                    "date": 1752334226908,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,8 +2,9 @@\n import undressWorkflow from '../workflows/undress.json'\r\n import faceSwapWorkflow from '../workflows/faceswap2.0.json'\r\n import comfyUIConfig from '../config/comfyui.config.js'\r\n import pointsManager from '../utils/pointsManager.js'\r\n+import levelCardPointsManager from '../utils/levelCardPointsManager.js'\r\n import { updateAPIConfig } from './api.js'\r\n import loadBalancer from './loadBalancer.js'\r\n \r\n // APIé…ç½® - ç›´è¿æ¨¡å¼\r\n"
                },
                {
                    "date": 1752334245348,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -495,13 +495,13 @@\n async function processUndressImage(base64Image) {\r\n   try {\r\n     console.log('ğŸš€ å¼€å§‹å¤„ç†æ¢è¡£è¯·æ±‚...')\r\n \r\n-    // æ£€æŸ¥ä½“éªŒç‚¹\r\n-    console.log('ğŸ’ æ£€æŸ¥ä½“éªŒç‚¹...')\r\n-    if (!pointsManager.hasEnoughPoints()) {\r\n-      const status = pointsManager.getPointsStatus()\r\n-      throw new Error(`ä½“éªŒç‚¹ä¸è¶³ï¼å½“å‰ç‚¹æ•°: ${status.current}ï¼Œéœ€è¦: ${status.generationCost}`)\r\n+    // æ£€æŸ¥ç§¯åˆ†ï¼ˆä¼˜å…ˆä½¿ç”¨ç­‰çº§å¡ç³»ç»Ÿï¼‰\r\n+    console.log('ğŸ’ æ£€æŸ¥ç§¯åˆ†...')\r\n+    const pointsStatus = await levelCardPointsManager.getPointsStatus()\r\n+    if (!pointsStatus.canGenerate) {\r\n+      throw new Error(`ç§¯åˆ†ä¸è¶³ï¼å½“å‰ç§¯åˆ†: ${pointsStatus.current}ï¼Œéœ€è¦: ${pointsStatus.generationCost}`)\r\n     }\r\n \r\n     console.log('ğŸ“‹ æµç¨‹ï¼šç¬¬ä¸€æ­¥ä¸Šä¼ å›¾ç‰‡ â†’ ç¬¬äºŒæ­¥æäº¤å·¥ä½œæµ')\r\n \r\n"
                },
                {
                    "date": 1752334262188,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -534,12 +534,12 @@\n     console.log('ğŸ“¥ è·å–ç”Ÿæˆçš„å›¾ç‰‡...')\r\n     const resultImage = await getGeneratedImage(taskResult)\r\n     console.log('ğŸ‰ æ¢è¡£å¤„ç†å®Œå…¨æˆåŠŸï¼')\r\n \r\n-    // æ¶ˆè€—ä½“éªŒç‚¹\r\n-    console.log('ğŸ’ æ¶ˆè€—ä½“éªŒç‚¹...')\r\n-    const pointsResult = pointsManager.consumePoints()\r\n-    console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ä½“éªŒç‚¹ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n+    // æ¶ˆè€—ç§¯åˆ†ï¼ˆä»ç­‰çº§å¡æ‰£é™¤ï¼‰\r\n+    console.log('ğŸ’ æ¶ˆè€—ç§¯åˆ†...')\r\n+    const pointsResult = await levelCardPointsManager.consumePoints(20, 'ä¸€é”®æ¢è¡£', resultImage)\r\n+    console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ç§¯åˆ†ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n \r\n     // è·å–èŠ‚ç‚¹49çš„åŸå›¾ç”¨äºå¯¹æ¯”\r\n     let originalImage = null\r\n     try {\r\n"
                },
                {
                    "date": 1752334280632,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -715,12 +715,12 @@\n \r\n     const imageUrl = await getGeneratedImage(taskResult)\r\n     console.log('ğŸ–¼ï¸ æˆåŠŸè·å–æ¢è„¸ç»“æœå›¾ç‰‡URL')\r\n \r\n-    // æ¶ˆè€—ä½“éªŒç‚¹\r\n-    console.log('ğŸ’ æ¶ˆè€—ä½“éªŒç‚¹...')\r\n-    const pointsResult = pointsManager.consumePoints()\r\n-    console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ä½“éªŒç‚¹ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n+    // æ¶ˆè€—ç§¯åˆ†ï¼ˆä»ç­‰çº§å¡æ‰£é™¤ï¼‰\r\n+    console.log('ğŸ’ æ¶ˆè€—ç§¯åˆ†...')\r\n+    const pointsResult = await levelCardPointsManager.consumePoints(20, 'æé€Ÿæ¢è„¸', imageUrl)\r\n+    console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ç§¯åˆ†ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n \r\n     if (onProgress) onProgress('æ¢è„¸å®Œæˆï¼', 100)\r\n \r\n     console.log('âœ… æ¢è„¸å¤„ç†å®Œæˆ')\r\n"
                },
                {
                    "date": 1752334511810,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -607,13 +607,13 @@\n async function processFaceSwapImage({ facePhotos, targetImage, onProgress }) {\r\n   try {\r\n     console.log('ğŸš€ å¼€å§‹æ¢è„¸å¤„ç†')\r\n \r\n-    // æ£€æŸ¥ä½“éªŒç‚¹\r\n-    console.log('ğŸ’ æ£€æŸ¥ä½“éªŒç‚¹...')\r\n-    if (!pointsManager.hasEnoughPoints()) {\r\n-      const status = pointsManager.getPointsStatus()\r\n-      throw new Error(`ä½“éªŒç‚¹ä¸è¶³ï¼å½“å‰ç‚¹æ•°: ${status.current}ï¼Œéœ€è¦: ${status.generationCost}`)\r\n+    // æ£€æŸ¥ç§¯åˆ†ï¼ˆä¼˜å…ˆä½¿ç”¨ç­‰çº§å¡ç³»ç»Ÿï¼‰\r\n+    console.log('ğŸ’ æ£€æŸ¥ç§¯åˆ†...')\r\n+    const pointsStatus = await levelCardPointsManager.getPointsStatus()\r\n+    if (!pointsStatus.canGenerate) {\r\n+      throw new Error(`ç§¯åˆ†ä¸è¶³ï¼å½“å‰ç§¯åˆ†: ${pointsStatus.current}ï¼Œéœ€è¦: ${pointsStatus.generationCost}`)\r\n     }\r\n \r\n     if (onProgress) onProgress('æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...', 5)\r\n \r\n"
                },
                {
                    "date": 1752335446876,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -536,9 +536,11 @@\n     console.log('ğŸ‰ æ¢è¡£å¤„ç†å®Œå…¨æˆåŠŸï¼')\r\n \r\n     // æ¶ˆè€—ç§¯åˆ†ï¼ˆä»ç­‰çº§å¡æ‰£é™¤ï¼‰\r\n     console.log('ğŸ’ æ¶ˆè€—ç§¯åˆ†...')\r\n-    const pointsResult = await levelCardPointsManager.consumePoints(20, 'ä¸€é”®æ¢è¡£', resultImage)\r\n+    // è·å– ComfyUI å›¾ç‰‡è®¿é—®URLè€Œä¸æ˜¯ base64 æ•°æ®\r\n+    const imageViewUrl = getComfyUIImageUrl(resultImage)\r\n+    const pointsResult = await levelCardPointsManager.consumePoints(20, 'ä¸€é”®æ¢è¡£', imageViewUrl)\r\n     console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ç§¯åˆ†ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n \r\n     // è·å–èŠ‚ç‚¹49çš„åŸå›¾ç”¨äºå¯¹æ¯”\r\n     let originalImage = null\r\n"
                },
                {
                    "date": 1752335464632,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -719,9 +719,11 @@\n     console.log('ğŸ–¼ï¸ æˆåŠŸè·å–æ¢è„¸ç»“æœå›¾ç‰‡URL')\r\n \r\n     // æ¶ˆè€—ç§¯åˆ†ï¼ˆä»ç­‰çº§å¡æ‰£é™¤ï¼‰\r\n     console.log('ğŸ’ æ¶ˆè€—ç§¯åˆ†...')\r\n-    const pointsResult = await levelCardPointsManager.consumePoints(20, 'æé€Ÿæ¢è„¸', imageUrl)\r\n+    // è·å– ComfyUI å›¾ç‰‡è®¿é—®URLè€Œä¸æ˜¯ base64 æ•°æ®\r\n+    const imageViewUrl = getComfyUIImageUrl(imageUrl)\r\n+    const pointsResult = await levelCardPointsManager.consumePoints(20, 'æé€Ÿæ¢è„¸', imageViewUrl)\r\n     console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ç§¯åˆ†ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n \r\n     if (onProgress) onProgress('æ¢è„¸å®Œæˆï¼', 100)\r\n \r\n"
                },
                {
                    "date": 1752335491803,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -122,8 +122,47 @@\n     }\r\n   })\r\n }\r\n \r\n+// è·å– ComfyUI å›¾ç‰‡è®¿é—®URL\r\n+function getComfyUIImageUrl(imageData) {\r\n+  try {\r\n+    // å¦‚æœå·²ç»æ˜¯ ComfyUI çš„ URL æ ¼å¼ï¼Œç›´æ¥è¿”å›\r\n+    if (typeof imageData === 'string' && imageData.includes('/view?')) {\r\n+      console.log('ğŸ”— å·²æ˜¯ ComfyUI URL æ ¼å¼:', imageData)\r\n+      return imageData\r\n+    }\r\n+\r\n+    // å¦‚æœæ˜¯ base64 æ•°æ®ï¼Œå°è¯•ä»å…¨å±€å˜é‡æˆ–ç¼“å­˜ä¸­è·å–å¯¹åº”çš„ ComfyUI URL\r\n+    if (typeof imageData === 'string' && imageData.startsWith('data:image/')) {\r\n+      console.log('ğŸ“¸ æ£€æµ‹åˆ° base64 å›¾ç‰‡æ•°æ®ï¼Œå°è¯•è·å– ComfyUI URL...')\r\n+\r\n+      // æ£€æŸ¥æ˜¯å¦æœ‰å­˜å‚¨çš„ ComfyUI URLï¼ˆåœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­å¯èƒ½å·²ç»ä¿å­˜ï¼‰\r\n+      if (window.lastComfyUIImageUrl) {\r\n+        console.log('ğŸ”— ä½¿ç”¨ç¼“å­˜çš„ ComfyUI URL:', window.lastComfyUIImageUrl)\r\n+        return window.lastComfyUIImageUrl\r\n+      }\r\n+\r\n+      // å¦‚æœæ²¡æœ‰ç¼“å­˜çš„URLï¼Œè¿”å›ä¸€ä¸ªå ä½ç¬¦æˆ–è€… null\r\n+      console.warn('âš ï¸ æ— æ³•è·å– ComfyUI URLï¼Œä½¿ç”¨å ä½ç¬¦')\r\n+      return null\r\n+    }\r\n+\r\n+    // å…¶ä»–æƒ…å†µï¼Œå°è¯•è½¬æ¢ä¸ºå­—ç¬¦ä¸²\r\n+    const urlString = String(imageData)\r\n+    if (urlString.includes('/view?')) {\r\n+      return urlString\r\n+    }\r\n+\r\n+    console.warn('âš ï¸ æ— æ³•è¯†åˆ«çš„å›¾ç‰‡æ•°æ®æ ¼å¼:', typeof imageData)\r\n+    return null\r\n+\r\n+  } catch (error) {\r\n+    console.error('âŒ è·å– ComfyUI å›¾ç‰‡URLå¤±è´¥:', error)\r\n+    return null\r\n+  }\r\n+}\r\n+\r\n // æ›´æ–°é…ç½®\r\n async function updateComfyUIConfig(newConfig) {\r\n   const currentConfig = getComfyUIConfig(true) // å¼ºåˆ¶åˆ·æ–°å½“å‰é…ç½®\r\n   const updatedConfig = { ...currentConfig, ...newConfig }\r\n"
                }
            ],
            "date": 1752326450066,
            "name": "Commit-0",
            "content": "// ComfyUIå·¥ä½œæµæœåŠ¡ - åŠ¨æ€é…ç½®æ¨¡å¼\r\nimport undressWorkflow from '../workflows/undress.json'\r\nimport faceSwapWorkflow from '../workflows/faceswap2.0.json'\r\nimport comfyUIConfig from '../config/comfyui.config.js'\r\nimport pointsManager from '../utils/pointsManager.js'\r\n\r\n// è·å–åŠ¨æ€é…ç½®çš„é»˜è®¤å€¼\r\nasync function getDefaultConfig() {\r\n  try {\r\n    const config = await comfyUIConfig.getConfig();\r\n    return {\r\n      COMFYUI_SERVER_URL: config.BASE_URL,\r\n      CLIENT_ID: config.CLIENT_ID,\r\n      TIMEOUT: config.REQUEST_TIMEOUT,\r\n      BACKUP_SERVERS: config.BACKUP_SERVERS,\r\n      AUTO_SWITCH: config.AUTO_SWITCH,\r\n      MAX_RETRIES: config.MAX_RETRIES\r\n    };\r\n  } catch (error) {\r\n    console.warn('âš ï¸ è·å–æœåŠ¡å™¨é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¡¬ç¼–ç é»˜è®¤å€¼:', error);\r\n    return {\r\n      COMFYUI_SERVER_URL: 'https://hwf0p724ub-8188.cnb.run',\r\n      CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n      TIMEOUT: 300000,\r\n      BACKUP_SERVERS: [],\r\n      AUTO_SWITCH: true,\r\n      MAX_RETRIES: 3\r\n    };\r\n  }\r\n}\r\n\r\n// é…ç½®ç¼“å­˜\r\nlet configCache = null\r\n\r\n// ä»localStorageè·å–é…ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤é…ç½®\r\nfunction getComfyUIConfig(forceRefresh = false) {\r\n  // å¦‚æœå¼ºåˆ¶åˆ·æ–°æˆ–ç¼“å­˜ä¸ºç©ºï¼Œé‡æ–°è¯»å–é…ç½®\r\n  if (forceRefresh || !configCache) {\r\n    const savedConfig = localStorage.getItem('comfyui_config')\r\n    if (savedConfig) {\r\n      try {\r\n        const parsed = JSON.parse(savedConfig)\r\n        configCache = { ...DEFAULT_CONFIG, ...parsed }\r\n        console.log('ğŸ”„ é…ç½®å·²åˆ·æ–°:', configCache)\r\n      } catch (error) {\r\n        console.warn('è§£æä¿å­˜çš„é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error)\r\n        configCache = { ...DEFAULT_CONFIG }\r\n      }\r\n    } else {\r\n      configCache = { ...DEFAULT_CONFIG }\r\n    }\r\n  }\r\n  return { ...configCache }\r\n}\r\n\r\n// ä¿å­˜é…ç½®åˆ°localStorage\r\nfunction saveComfyUIConfig(config) {\r\n  try {\r\n    localStorage.setItem('comfyui_config', JSON.stringify(config))\r\n    // æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶ä¸‹æ¬¡è¯»å–æ—¶é‡æ–°åŠ è½½\r\n    configCache = null\r\n    console.log('ComfyUIé…ç½®å·²ä¿å­˜:', config)\r\n  } catch (error) {\r\n    console.error('ä¿å­˜é…ç½®å¤±è´¥:', error)\r\n  }\r\n}\r\n\r\n// æ›´æ–°ä»£ç†æœåŠ¡å™¨é…ç½®\r\nasync function updateProxyServerConfig(config) {\r\n  try {\r\n    // åªæœ‰åœ¨ä½¿ç”¨ä»£ç†æ—¶æ‰æ›´æ–°ä»£ç†æœåŠ¡å™¨é…ç½®\r\n    if (!config.USE_PROXY) {\r\n      console.log('ğŸ”§ ä¸ä½¿ç”¨ä»£ç†ï¼Œè·³è¿‡ä»£ç†æœåŠ¡å™¨é…ç½®æ›´æ–°')\r\n      return { success: true, message: 'ä¸ä½¿ç”¨ä»£ç†æ¨¡å¼' }\r\n    }\r\n\r\n    const proxyConfigUrl = config.PROXY_SERVER_URL.replace('/api', '/api/config')\r\n    console.log('ğŸ”§ æ›´æ–°ä»£ç†æœåŠ¡å™¨é…ç½®:', proxyConfigUrl)\r\n\r\n    const response = await fetch(proxyConfigUrl, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify({\r\n        COMFYUI_SERVER_URL: config.COMFYUI_SERVER_URL,\r\n        CLIENT_ID: config.CLIENT_ID\r\n      }),\r\n      timeout: 10000\r\n    })\r\n\r\n    if (response.ok) {\r\n      const result = await response.json()\r\n      console.log('âœ… ä»£ç†æœåŠ¡å™¨é…ç½®æ›´æ–°æˆåŠŸ:', result)\r\n      return { success: true, message: 'ä»£ç†æœåŠ¡å™¨é…ç½®æ›´æ–°æˆåŠŸ' }\r\n    } else {\r\n      console.warn('âš ï¸ ä»£ç†æœåŠ¡å™¨é…ç½®æ›´æ–°å¤±è´¥:', response.status)\r\n      return { success: false, message: `ä»£ç†æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status}` }\r\n    }\r\n  } catch (error) {\r\n    console.warn('âš ï¸ æ— æ³•è¿æ¥åˆ°ä»£ç†æœåŠ¡å™¨ï¼Œå¯èƒ½ä»£ç†æœåŠ¡å™¨æœªå¯åŠ¨:', error.message)\r\n    return { success: false, message: 'æ— æ³•è¿æ¥åˆ°ä»£ç†æœåŠ¡å™¨' }\r\n  }\r\n}\r\n\r\n// é…ç½®å˜æ›´ç›‘å¬å™¨\r\nconst configChangeListeners = []\r\n\r\n// æ·»åŠ é…ç½®å˜æ›´ç›‘å¬å™¨\r\nfunction addConfigChangeListener(listener) {\r\n  configChangeListeners.push(listener)\r\n}\r\n\r\n// ç§»é™¤é…ç½®å˜æ›´ç›‘å¬å™¨\r\nfunction removeConfigChangeListener(listener) {\r\n  const index = configChangeListeners.indexOf(listener)\r\n  if (index > -1) {\r\n    configChangeListeners.splice(index, 1)\r\n  }\r\n}\r\n\r\n// é€šçŸ¥é…ç½®å˜æ›´\r\nfunction notifyConfigChange(config) {\r\n  configChangeListeners.forEach(listener => {\r\n    try {\r\n      listener(config)\r\n    } catch (error) {\r\n      console.error('é…ç½®å˜æ›´ç›‘å¬å™¨æ‰§è¡Œå¤±è´¥:', error)\r\n    }\r\n  })\r\n}\r\n\r\n// æ›´æ–°é…ç½®\r\nasync function updateComfyUIConfig(newConfig) {\r\n  const currentConfig = getComfyUIConfig(true) // å¼ºåˆ¶åˆ·æ–°å½“å‰é…ç½®\r\n  const updatedConfig = { ...currentConfig, ...newConfig }\r\n\r\n  console.log('ğŸ”„ æ›´æ–°é…ç½®:', updatedConfig)\r\n\r\n  // ä¿å­˜åˆ°localStorageï¼ˆè¿™ä¼šæ¸…é™¤ç¼“å­˜ï¼‰\r\n  saveComfyUIConfig(updatedConfig)\r\n\r\n  // å¼ºåˆ¶åˆ·æ–°é…ç½®ç¼“å­˜\r\n  configCache = null\r\n\r\n  // é€šçŸ¥é…ç½®å˜æ›´\r\n  notifyConfigChange(updatedConfig)\r\n\r\n  // åŒæ—¶æ›´æ–°ä»£ç†æœåŠ¡å™¨é…ç½®\r\n  const proxyUpdateResult = await updateProxyServerConfig(updatedConfig)\r\n\r\n  console.log('âœ… é…ç½®æ›´æ–°å®Œæˆï¼Œæ–°é…ç½®å·²ç”Ÿæ•ˆ')\r\n\r\n  return {\r\n    config: updatedConfig,\r\n    proxyUpdate: proxyUpdateResult\r\n  }\r\n}\r\n\r\n// è·å–å½“å‰é…ç½®\r\nfunction getCurrentConfig(forceRefresh = false) {\r\n  return getComfyUIConfig(forceRefresh)\r\n}\r\n\r\n// è·å–APIåŸºç¡€URL - ç›´è¿æ¨¡å¼\r\nfunction getApiBaseUrl() {\r\n  const config = getComfyUIConfig(true)\r\n  console.log('ğŸ¯ ç›´è¿ComfyUIæœåŠ¡å™¨:', config.COMFYUI_SERVER_URL)\r\n\r\n  let baseUrl = config.COMFYUI_SERVER_URL\r\n\r\n  // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n  if (baseUrl && baseUrl.endsWith('/')) {\r\n    baseUrl = baseUrl.slice(0, -1)\r\n  }\r\n\r\n  return baseUrl\r\n}\r\n\r\n// é‡ç½®ä¸ºé»˜è®¤é…ç½®\r\nfunction resetToDefaultConfig() {\r\n  localStorage.removeItem('comfyui_config')\r\n  return { ...DEFAULT_CONFIG }\r\n}\r\n\r\n// ç”Ÿæˆéšæœºå®¢æˆ·ç«¯IDï¼ˆå¤‡ç”¨å‡½æ•°ï¼‰\r\nfunction generateClientId() {\r\n  return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)\r\n}\r\n\r\n// ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ Base64å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨å¹¶è·å–æ–‡ä»¶å\r\nasync function uploadImageToComfyUI(base64Image) {\r\n  try {\r\n    const config = getComfyUIConfig()\r\n    const apiBaseUrl = getApiBaseUrl()\r\n    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n\r\n    // éªŒè¯base64æ ¼å¼\r\n    if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n      throw new Error('æ— æ•ˆçš„base64å›¾ç‰‡æ ¼å¼')\r\n    }\r\n\r\n    // ä»base64æ•°æ®ä¸­æå–å›¾ç‰‡ä¿¡æ¯\r\n    const base64Data = base64Image.split(',')[1]\r\n    const mimeType = base64Image.split(',')[0].split(':')[1].split(';')[0]\r\n    const extension = mimeType.split('/')[1] || 'jpg'\r\n\r\n    // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å\r\n    const filename = `upload_${Date.now()}_${Math.random().toString(36).substring(7)}.${extension}`\r\n\r\n    // å°†base64è½¬æ¢ä¸ºBlob\r\n    const byteCharacters = atob(base64Data)\r\n    const byteNumbers = new Array(byteCharacters.length)\r\n    for (let i = 0; i < byteCharacters.length; i++) {\r\n      byteNumbers[i] = byteCharacters.charCodeAt(i)\r\n    }\r\n    const byteArray = new Uint8Array(byteNumbers)\r\n    const blob = new Blob([byteArray], { type: mimeType })\r\n\r\n    console.log('ğŸ“¤ ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯:', {\r\n      filename,\r\n      type: mimeType,\r\n      size: `${(blob.size / 1024).toFixed(2)} KB`\r\n    })\r\n\r\n    // ç›´è¿ä¸Šä¼ å›¾ç‰‡\r\n    const formData = new FormData()\r\n    formData.append('image', blob, filename)\r\n    formData.append('type', 'input')\r\n    formData.append('subfolder', '')\r\n    formData.append('overwrite', 'false')\r\n\r\n    console.log('ğŸ”„ å¼€å§‹ä¸Šä¼ å›¾ç‰‡...')\r\n\r\n    const response = await fetch(`${apiBaseUrl}/upload/image`, {\r\n      method: 'POST',\r\n      body: formData\r\n    })\r\n\r\n    console.log('ğŸ“¥ ä¸Šä¼ å“åº”çŠ¶æ€:', response.status, response.statusText)\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text().catch(() => response.statusText)\r\n      throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status} ${response.statusText} - ${errorText}`)\r\n    }\r\n\r\n    const result = await response.json()\r\n    console.log('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', result)\r\n\r\n    // éªŒè¯è¿”å›ç»“æœ\r\n    if (!result.name) {\r\n      throw new Error('ä¸Šä¼ å“åº”ä¸­ç¼ºå°‘æ–‡ä»¶å')\r\n    }\r\n\r\n    return result.name\r\n\r\n  } catch (error) {\r\n    console.error('âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error)\r\n    throw new Error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`)\r\n  }\r\n}\r\n\r\n// åˆ›å»ºå·¥ä½œæµæç¤ºè¯ï¼Œå°†ç”¨æˆ·å›¾ç‰‡å…³è”åˆ°èŠ‚ç‚¹49\r\nfunction createUndressWorkflowPrompt(uploadedImageName) {\r\n  try {\r\n    // æ·±æ‹·è´å·¥ä½œæµ\r\n    const workflow = JSON.parse(JSON.stringify(undressWorkflow))\r\n\r\n    // å°†ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶åè®¾ç½®åˆ°èŠ‚ç‚¹49\r\n    if (workflow['49'] && workflow['49'].class_type === 'LoadImage') {\r\n      workflow['49'].inputs.image = uploadedImageName\r\n      console.log('èŠ‚ç‚¹49å›¾ç‰‡è®¾ç½®ä¸º:', uploadedImageName)\r\n    } else {\r\n      throw new Error('å·¥ä½œæµä¸­æœªæ‰¾åˆ°èŠ‚ç‚¹49æˆ–èŠ‚ç‚¹ç±»å‹ä¸æ­£ç¡®')\r\n    }\r\n\r\n    // éšæœºåŒ–ç§å­ä»¥è·å¾—ä¸åŒçš„ç»“æœ\r\n    if (workflow['174'] && workflow['174'].inputs) {\r\n      const newSeed = Math.floor(Math.random() * 1000000000000000)\r\n      workflow['174'].inputs.noise_seed = newSeed\r\n      console.log('éšæœºç§å­è®¾ç½®ä¸º:', newSeed)\r\n    }\r\n\r\n    console.log('å·¥ä½œæµé…ç½®å®Œæˆ')\r\n    return workflow\r\n\r\n  } catch (error) {\r\n    console.error('å·¥ä½œæµåˆ›å»ºå¤±è´¥:', error)\r\n    throw new Error(`å·¥ä½œæµåˆ›å»ºå¤±è´¥: ${error.message}`)\r\n  }\r\n}\r\n\r\n// ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\nasync function submitWorkflow(workflowPrompt) {\r\n  try {\r\n    const config = getComfyUIConfig()\r\n    const apiBaseUrl = getApiBaseUrl()\r\n    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n    console.log('ğŸ”§ ä½¿ç”¨ä»£ç†:', config.USE_PROXY ? 'æ˜¯' : 'å¦')\r\n\r\n    // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n    const requestBody = {\r\n      client_id: config.CLIENT_ID,\r\n      prompt: workflowPrompt\r\n    }\r\n\r\n    console.log('ğŸ“‹ è¯·æ±‚ä½“ç»“æ„:', {\r\n      client_id: requestBody.client_id,\r\n      prompt_keys: Object.keys(requestBody.prompt),\r\n      node_49_exists: !!requestBody.prompt['49'],\r\n      node_49_image: requestBody.prompt['49']?.inputs?.image\r\n    })\r\n\r\n    // ç¬¬äºŒæ­¥APIè°ƒç”¨ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n    const promptUrl = `${apiBaseUrl}/prompt`\r\n    console.log('ğŸŒ è°ƒç”¨å·¥ä½œæµAPI:', promptUrl)\r\n\r\n    const response = await fetch(promptUrl, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify(requestBody),\r\n      mode: 'cors',\r\n      credentials: 'omit'\r\n    })\r\n\r\n    console.log('ğŸ“¥ å·¥ä½œæµå“åº”çŠ¶æ€:', response.status, response.statusText)\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text()\r\n      console.error('âŒ å·¥ä½œæµæäº¤å¤±è´¥å“åº”:', errorText)\r\n      throw new Error(`å·¥ä½œæµæäº¤å¤±è´¥: ${response.status} ${response.statusText} - ${errorText}`)\r\n    }\r\n\r\n    const result = await response.json()\r\n    console.log('âœ… å·¥ä½œæµæäº¤æˆåŠŸ:', result)\r\n\r\n    // éªŒè¯è¿”å›ç»“æœ\r\n    if (!result.prompt_id) {\r\n      throw new Error('å·¥ä½œæµå“åº”ä¸­ç¼ºå°‘prompt_id')\r\n    }\r\n\r\n    return result.prompt_id // è¿”å›ä»»åŠ¡ID\r\n\r\n  } catch (error) {\r\n    console.error('âŒ å·¥ä½œæµæäº¤å¤±è´¥:', error)\r\n    throw new Error(`å·¥ä½œæµæäº¤å¤±è´¥: ${error.message}`)\r\n  }\r\n}\r\n\r\n// æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\nasync function checkTaskStatus(promptId) {\r\n  try {\r\n    const config = getComfyUIConfig()\r\n    const apiBaseUrl = getApiBaseUrl()\r\n    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`)\r\n    const response = await fetch(`${apiBaseUrl}/history/${promptId}`)\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText}`)\r\n    }\r\n\r\n    const result = await response.json()\r\n    return result[promptId] || null\r\n\r\n  } catch (error) {\r\n    console.error('çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', error)\r\n    throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${error.message}`)\r\n  }\r\n}\r\n\r\n// è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\nasync function getGeneratedImage(taskResult) {\r\n  try {\r\n    const config = getComfyUIConfig()\r\n    const apiBaseUrl = getApiBaseUrl()\r\n\r\n    // ä»ä»»åŠ¡ç»“æœä¸­æ‰¾åˆ°è¾“å‡ºå›¾ç‰‡\r\n    const outputs = taskResult.outputs\r\n    let imageInfo = null\r\n\r\n    // ä¼˜å…ˆæŸ¥æ‰¾èŠ‚ç‚¹730çš„è¾“å‡ºå›¾ç‰‡ï¼ˆä¸€é”®æ¢è¡£å¤„ç†ç»“æœï¼‰\r\n    if (outputs['730'] && outputs['730'].images && outputs['730'].images.length > 0) {\r\n      imageInfo = outputs['730'].images[0]\r\n      console.log('ğŸ“· æ‰¾åˆ°èŠ‚ç‚¹730çš„ä¸€é”®æ¢è¡£å¤„ç†ç»“æœå›¾ç‰‡:', imageInfo)\r\n    } else if (outputs['812'] && outputs['812'].images && outputs['812'].images.length > 0) {\r\n      // å¤‡ç”¨ï¼šæŸ¥æ‰¾èŠ‚ç‚¹812çš„è¾“å‡ºå›¾ç‰‡ï¼ˆæ¢è„¸å¤„ç†ç»“æœï¼‰\r\n      imageInfo = outputs['812'].images[0]\r\n      console.log('ğŸ“· æ‰¾åˆ°èŠ‚ç‚¹812çš„æ¢è„¸å¤„ç†ç»“æœå›¾ç‰‡:', imageInfo)\r\n    } else if (outputs['813'] && outputs['813'].images && outputs['813'].images.length > 0) {\r\n      // å¤‡ç”¨ï¼šæŸ¥æ‰¾èŠ‚ç‚¹813çš„è¾“å‡ºå›¾ç‰‡ï¼ˆæ—§ç‰ˆæ¢è„¸ç»“æœï¼‰\r\n      imageInfo = outputs['813'].images[0]\r\n      console.log('ğŸ“· æ‰¾åˆ°èŠ‚ç‚¹813çš„æ¢è„¸å¤„ç†ç»“æœå›¾ç‰‡:', imageInfo)\r\n    } else if (outputs['746'] && outputs['746'].images && outputs['746'].images.length > 0) {\r\n      // å¤‡ç”¨ï¼šæŸ¥æ‰¾èŠ‚ç‚¹746çš„è¾“å‡ºå›¾ç‰‡ï¼ˆæ›´æ—§ç‰ˆæ¢è„¸ç»“æœï¼‰\r\n      imageInfo = outputs['746'].images[0]\r\n      console.log('ğŸ“· æ‰¾åˆ°èŠ‚ç‚¹746çš„æ¢è„¸å¤„ç†ç»“æœå›¾ç‰‡:', imageInfo)\r\n    } else if (outputs['710'] && outputs['710'].images && outputs['710'].images.length > 0) {\r\n      // å¤‡ç”¨ï¼šæŸ¥æ‰¾èŠ‚ç‚¹710çš„è¾“å‡ºå›¾ç‰‡ï¼ˆæ¢è¡£å¤„ç†ç»“æœï¼‰\r\n      imageInfo = outputs['710'].images[0]\r\n      console.log('ğŸ“· æ‰¾åˆ°èŠ‚ç‚¹710çš„å¤„ç†ç»“æœå›¾ç‰‡:', imageInfo)\r\n    } else {\r\n      // å¦‚æœä¸»è¦èŠ‚ç‚¹éƒ½æ²¡æœ‰è¾“å‡ºï¼Œåˆ™æŸ¥æ‰¾å…¶ä»–èŠ‚ç‚¹çš„è¾“å‡ºå›¾ç‰‡\r\n      console.log('âš ï¸ èŠ‚ç‚¹812ã€813ã€746å’Œ710éƒ½æ— è¾“å‡ºï¼ŒæŸ¥æ‰¾å…¶ä»–èŠ‚ç‚¹...')\r\n      for (const nodeId in outputs) {\r\n        const nodeOutput = outputs[nodeId]\r\n        if (nodeOutput.images && nodeOutput.images.length > 0) {\r\n          imageInfo = nodeOutput.images[0]\r\n          console.log(`ğŸ“· æ‰¾åˆ°èŠ‚ç‚¹${nodeId}çš„å›¾ç‰‡:`, imageInfo)\r\n          break\r\n        }\r\n      }\r\n    }\r\n\r\n    if (!imageInfo) {\r\n      console.error('âŒ æ‰€æœ‰èŠ‚ç‚¹è¾“å‡º:', JSON.stringify(outputs, null, 2))\r\n      throw new Error('æœªæ‰¾åˆ°ç”Ÿæˆçš„å›¾ç‰‡')\r\n    }\r\n\r\n    console.log('ğŸ“· æœ€ç»ˆé€‰æ‹©çš„å›¾ç‰‡:', imageInfo)\r\n\r\n    // æ„å»ºå›¾ç‰‡URL - æŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n    const params = new URLSearchParams({\r\n      filename: imageInfo.filename,\r\n      type: imageInfo.type,\r\n      subfolder: imageInfo.subfolder || ''\r\n    })\r\n    const imageUrl = `${apiBaseUrl}/view?${params.toString()}`\r\n\r\n    console.log('ğŸŒ è·å–å›¾ç‰‡URL:', imageUrl)\r\n\r\n    // è·å–å›¾ç‰‡æ•°æ®å¹¶è½¬æ¢ä¸ºbase64\r\n    const imageResponse = await fetch(imageUrl)\r\n    if (!imageResponse.ok) {\r\n      throw new Error(`å›¾ç‰‡è·å–å¤±è´¥: ${imageResponse.status}`)\r\n    }\r\n\r\n    const imageBlob = await imageResponse.blob()\r\n    return new Promise((resolve, reject) => {\r\n      const reader = new FileReader()\r\n      reader.onload = () => resolve(reader.result)\r\n      reader.onerror = reject\r\n      reader.readAsDataURL(imageBlob)\r\n    })\r\n\r\n  } catch (error) {\r\n    console.error('å›¾ç‰‡è·å–å¤±è´¥:', error)\r\n    throw new Error(`å›¾ç‰‡è·å–å¤±è´¥: ${error.message}`)\r\n  }\r\n}\r\n\r\n// ç­‰å¾…ä»»åŠ¡å®Œæˆ\r\nasync function waitForTaskCompletion(promptId, maxWaitTime = 300000) {\r\n  const startTime = Date.now()\r\n  const pollInterval = 2000 // 2ç§’è½®è¯¢ä¸€æ¬¡\r\n\r\n  while (Date.now() - startTime < maxWaitTime) {\r\n    const taskResult = await checkTaskStatus(promptId)\r\n\r\n    if (taskResult) {\r\n      if (taskResult.status && taskResult.status.completed) {\r\n        return taskResult\r\n      } else if (taskResult.status && taskResult.status.status_str === 'error') {\r\n        throw new Error(`ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${JSON.stringify(taskResult.status)}`)\r\n      }\r\n    }\r\n\r\n    // ç­‰å¾…ä¸‹æ¬¡è½®è¯¢\r\n    await new Promise(resolve => setTimeout(resolve, pollInterval))\r\n  }\r\n\r\n  throw new Error('ä»»åŠ¡æ‰§è¡Œè¶…æ—¶')\r\n}\r\n\r\n// ä¸»è¦çš„æ¢è¡£APIå‡½æ•° - ä¸¤æ­¥æµç¨‹\r\nasync function processUndressImage(base64Image) {\r\n  try {\r\n    console.log('ğŸš€ å¼€å§‹å¤„ç†æ¢è¡£è¯·æ±‚...')\r\n\r\n    // æ£€æŸ¥ä½“éªŒç‚¹\r\n    console.log('ğŸ’ æ£€æŸ¥ä½“éªŒç‚¹...')\r\n    if (!pointsManager.hasEnoughPoints()) {\r\n      const status = pointsManager.getPointsStatus()\r\n      throw new Error(`ä½“éªŒç‚¹ä¸è¶³ï¼å½“å‰ç‚¹æ•°: ${status.current}ï¼Œéœ€è¦: ${status.generationCost}`)\r\n    }\r\n\r\n    console.log('ğŸ“‹ æµç¨‹ï¼šç¬¬ä¸€æ­¥ä¸Šä¼ å›¾ç‰‡ â†’ ç¬¬äºŒæ­¥æäº¤å·¥ä½œæµ')\r\n\r\n    // éªŒè¯å›¾ç‰‡æ•°æ®æ ¼å¼\r\n    console.log('ğŸ” éªŒè¯å›¾ç‰‡æ•°æ®æ ¼å¼...')\r\n    if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n      throw new Error('æ— æ•ˆçš„å›¾ç‰‡æ•°æ®æ ¼å¼')\r\n    }\r\n\r\n    // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨\r\n    console.log('ğŸ“¤ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ° /api/upload/image')\r\n    const uploadedImageName = await uploadImageToComfyUI(base64Image)\r\n    console.log('âœ… ç¬¬ä¸€æ­¥å®Œæˆï¼Œè·å¾—æ–‡ä»¶å:', uploadedImageName)\r\n\r\n    // åˆ›å»ºå·¥ä½œæµæç¤ºè¯ï¼Œå°†ä¸Šä¼ çš„å›¾ç‰‡å…³è”åˆ°èŠ‚ç‚¹49\r\n    console.log('ğŸ”§ é…ç½®å·¥ä½œæµï¼Œå…³è”å›¾ç‰‡åˆ°èŠ‚ç‚¹49...')\r\n    const workflowPrompt = createUndressWorkflowPrompt(uploadedImageName)\r\n\r\n    // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµ\r\n    console.log('ğŸš€ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ° /api/prompt')\r\n    const promptId = await submitWorkflow(workflowPrompt)\r\n    console.log('âœ… ç¬¬äºŒæ­¥å®Œæˆï¼Œè·å¾—ä»»åŠ¡ID:', promptId)\r\n\r\n    // ç­‰å¾…ä»»åŠ¡å®Œæˆ\r\n    console.log('â³ ç­‰å¾…ComfyUIå¤„ç†ä»»åŠ¡...')\r\n    const taskResult = await waitForTaskCompletion(promptId)\r\n    console.log('âœ… ä»»åŠ¡å¤„ç†å®Œæˆ')\r\n\r\n    // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n    console.log('ğŸ“¥ è·å–ç”Ÿæˆçš„å›¾ç‰‡...')\r\n    const resultImage = await getGeneratedImage(taskResult)\r\n    console.log('ğŸ‰ æ¢è¡£å¤„ç†å®Œå…¨æˆåŠŸï¼')\r\n\r\n    // æ¶ˆè€—ä½“éªŒç‚¹\r\n    console.log('ğŸ’ æ¶ˆè€—ä½“éªŒç‚¹...')\r\n    const pointsResult = pointsManager.consumePoints()\r\n    console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ä½“éªŒç‚¹ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n\r\n    // è·å–èŠ‚ç‚¹49çš„åŸå›¾ç”¨äºå¯¹æ¯”\r\n    let originalImage = null\r\n    try {\r\n      // æ„å»ºèŠ‚ç‚¹49åŸå›¾çš„URL\r\n      const params = new URLSearchParams({\r\n        filename: uploadedImageName,\r\n        type: 'input',\r\n        subfolder: ''\r\n      })\r\n      const config = getComfyUIConfig()\r\n      const apiBaseUrl = getApiBaseUrl()\r\n      originalImage = `${apiBaseUrl}/view?${params.toString()}`\r\n      console.log('ğŸ“· è·å–èŠ‚ç‚¹49åŸå›¾URL:', originalImage)\r\n    } catch (error) {\r\n      console.warn('âš ï¸ è·å–èŠ‚ç‚¹49åŸå›¾å¤±è´¥ï¼Œä½¿ç”¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡:', error)\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      resultImage: resultImage,\r\n      originalImage: originalImage, // æ–°å¢ï¼šèŠ‚ç‚¹49çš„åŸå›¾\r\n      promptId: promptId,\r\n      uploadedImageName: uploadedImageName,\r\n      pointsConsumed: pointsResult.consumed,\r\n      pointsRemaining: pointsResult.remaining,\r\n      message: 'æ¢è¡£å¤„ç†å®Œæˆ'\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('âŒ æ¢è¡£å¤„ç†å¤±è´¥:', error)\r\n    return {\r\n      success: false,\r\n      error: error.message,\r\n      message: 'æ¢è¡£å¤„ç†å¤±è´¥'\r\n    }\r\n  }\r\n}\r\n\r\n// æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€\r\nasync function checkComfyUIServerStatus() {\r\n  try {\r\n    const apiBaseUrl = getApiBaseUrl()\r\n    console.log('ğŸ” æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€:', apiBaseUrl)\r\n\r\n    const response = await fetch(`${apiBaseUrl}/system_stats`, {\r\n      method: 'GET',\r\n      signal: AbortSignal.timeout(10000) // 10ç§’è¶…æ—¶\r\n    })\r\n\r\n    if (response.ok) {\r\n      const stats = await response.json()\r\n      console.log('âœ… ComfyUIæœåŠ¡å™¨çŠ¶æ€æ­£å¸¸:', stats)\r\n      return { status: 'ok', stats }\r\n    } else {\r\n      console.warn('âš ï¸ ComfyUIæœåŠ¡å™¨å“åº”å¼‚å¸¸:', response.status)\r\n      return { status: 'error', code: response.status }\r\n    }\r\n  } catch (error) {\r\n    console.error('âŒ ComfyUIæœåŠ¡å™¨è¿æ¥å¤±è´¥:', error)\r\n    return { status: 'error', error: error.message }\r\n  }\r\n}\r\n\r\n// æ¢è„¸å¤„ç†å‡½æ•°\r\nasync function processFaceSwapImage({ facePhotos, targetImage, onProgress }) {\r\n  try {\r\n    console.log('ğŸš€ å¼€å§‹æ¢è„¸å¤„ç†')\r\n\r\n    // æ£€æŸ¥ä½“éªŒç‚¹\r\n    console.log('ğŸ’ æ£€æŸ¥ä½“éªŒç‚¹...')\r\n    if (!pointsManager.hasEnoughPoints()) {\r\n      const status = pointsManager.getPointsStatus()\r\n      throw new Error(`ä½“éªŒç‚¹ä¸è¶³ï¼å½“å‰ç‚¹æ•°: ${status.current}ï¼Œéœ€è¦: ${status.generationCost}`)\r\n    }\r\n\r\n    if (onProgress) onProgress('æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...', 5)\r\n\r\n    // æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€\r\n    const serverStatus = await checkComfyUIServerStatus()\r\n    if (serverStatus.status === 'error') {\r\n      throw new Error(`ComfyUIæœåŠ¡å™¨ä¸å¯ç”¨: ${serverStatus.error || serverStatus.code}`)\r\n    }\r\n\r\n    if (onProgress) onProgress('æ­£åœ¨å‡†å¤‡å·¥ä½œæµ...', 10)\r\n\r\n    // éªŒè¯è¾“å…¥\r\n    if (!facePhotos || facePhotos.length !== 4) {\r\n      throw new Error('éœ€è¦æä¾›4å¼ äººè„¸ç…§ç‰‡')\r\n    }\r\n\r\n    if (!targetImage) {\r\n      throw new Error('éœ€è¦æä¾›ç›®æ ‡å›¾ç‰‡')\r\n    }\r\n\r\n    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰äººè„¸ç…§ç‰‡éƒ½å·²ä¸Šä¼ \r\n    const validFacePhotos = facePhotos.filter(photo => photo !== null)\r\n    if (validFacePhotos.length !== 4) {\r\n      throw new Error('è¯·ä¸Šä¼ 4å¼ äººè„¸ç…§ç‰‡')\r\n    }\r\n\r\n    if (onProgress) onProgress('æ­£åœ¨ä¸Šä¼ äººè„¸ç…§ç‰‡...', 20)\r\n\r\n    // ä¸Šä¼ 4å¼ äººè„¸ç…§ç‰‡\r\n    const uploadedFacePhotos = []\r\n    for (let i = 0; i < facePhotos.length; i++) {\r\n      const photo = facePhotos[i]\r\n      if (onProgress) onProgress(`æ­£åœ¨ä¸Šä¼ äººè„¸ç…§ç‰‡ ${i + 1}/4...`, 20 + (i * 10))\r\n\r\n      const uploadedFilename = await uploadImageToComfyUI(photo)\r\n      uploadedFacePhotos.push(uploadedFilename)\r\n    }\r\n\r\n    if (onProgress) onProgress('æ­£åœ¨ä¸Šä¼ ç›®æ ‡å›¾ç‰‡...', 60)\r\n\r\n    // ä¸Šä¼ ç›®æ ‡å›¾ç‰‡\r\n    const targetUploadedFilename = await uploadImageToComfyUI(targetImage)\r\n\r\n    if (onProgress) onProgress('æ­£åœ¨å‡†å¤‡æ¢è„¸å·¥ä½œæµ...', 70)\r\n\r\n    // å‡†å¤‡å·¥ä½œæµ\r\n    const workflow = JSON.parse(JSON.stringify(faceSwapWorkflow))\r\n\r\n    // æ›´æ–°å·¥ä½œæµä¸­çš„å›¾ç‰‡èŠ‚ç‚¹\r\n    // æ ¹æ®æœ€æ–°å·¥ä½œæµï¼Œæ­£ç¡®çš„èŠ‚ç‚¹æ˜ å°„ï¼š\r\n    // èŠ‚ç‚¹670: ç¬¬ä¸€å¼ äººè„¸ç…§ç‰‡\r\n    // èŠ‚ç‚¹662: ç¬¬äºŒå¼ äººè„¸ç…§ç‰‡\r\n    // èŠ‚ç‚¹658: ç¬¬ä¸‰å¼ äººè„¸ç…§ç‰‡\r\n    // èŠ‚ç‚¹655: ç¬¬å››å¼ äººè„¸ç…§ç‰‡\r\n    // èŠ‚ç‚¹737: ç›®æ ‡å›¾ç‰‡\r\n    // èŠ‚ç‚¹812: å¤„ç†ç»“æœè¾“å‡ºï¼ˆæœ€æ–°ï¼‰\r\n\r\n    if (workflow['670']) {\r\n      workflow['670'].inputs.image = uploadedFacePhotos[0]\r\n      console.log('âœ… èŠ‚ç‚¹670è®¾ç½®ç¬¬ä¸€å¼ äººè„¸ç…§ç‰‡:', uploadedFacePhotos[0])\r\n    }\r\n    if (workflow['662']) {\r\n      workflow['662'].inputs.image = uploadedFacePhotos[1]\r\n      console.log('âœ… èŠ‚ç‚¹662è®¾ç½®ç¬¬äºŒå¼ äººè„¸ç…§ç‰‡:', uploadedFacePhotos[1])\r\n    }\r\n    if (workflow['658']) {\r\n      workflow['658'].inputs.image = uploadedFacePhotos[2]\r\n      console.log('âœ… èŠ‚ç‚¹658è®¾ç½®ç¬¬ä¸‰å¼ äººè„¸ç…§ç‰‡:', uploadedFacePhotos[2])\r\n    }\r\n    if (workflow['655']) {\r\n      workflow['655'].inputs.image = uploadedFacePhotos[3]\r\n      console.log('âœ… èŠ‚ç‚¹655è®¾ç½®ç¬¬å››å¼ äººè„¸ç…§ç‰‡:', uploadedFacePhotos[3])\r\n    }\r\n    if (workflow['737']) {\r\n      workflow['737'].inputs.image = targetUploadedFilename\r\n      console.log('âœ… èŠ‚ç‚¹737è®¾ç½®ç›®æ ‡å›¾ç‰‡:', targetUploadedFilename)\r\n    }\r\n\r\n    if (onProgress) onProgress('æ­£åœ¨æäº¤æ¢è„¸ä»»åŠ¡...', 80)\r\n\r\n    // æäº¤å·¥ä½œæµ\r\n    const promptId = await submitWorkflow(workflow)\r\n\r\n    if (onProgress) onProgress('æ­£åœ¨å¤„ç†æ¢è„¸...', 85)\r\n\r\n    // ç­‰å¾…ä»»åŠ¡å®Œæˆ - æ¢è„¸éœ€è¦æ›´é•¿æ—¶é—´ï¼Œè®¾ç½®10åˆ†é’Ÿè¶…æ—¶\r\n    const maxWaitTime = 600000 // 10åˆ†é’Ÿ\r\n    console.log(`â³ å¼€å§‹ç­‰å¾…æ¢è„¸ä»»åŠ¡å®Œæˆï¼Œä»»åŠ¡ID: ${promptId}ï¼Œæœ€å¤§ç­‰å¾…æ—¶é—´: ${maxWaitTime/1000}ç§’`)\r\n\r\n    const taskResult = await waitForTaskCompletion(promptId, maxWaitTime)\r\n    console.log('âœ… æ¢è„¸ä»»åŠ¡å¤„ç†å®Œæˆï¼Œç»“æœ:', taskResult)\r\n\r\n    if (onProgress) onProgress('æ­£åœ¨è·å–å¤„ç†ç»“æœ...', 95)\r\n\r\n    // è·å–ç»“æœå›¾ç‰‡\r\n    // æ ¹æ®æœ€æ–°å·¥ä½œæµï¼Œæœ€ç»ˆç»“æœåº”è¯¥åœ¨èŠ‚ç‚¹812çš„è¾“å‡º\r\n    console.log('ğŸ“¥ å¼€å§‹è·å–æ¢è„¸ç»“æœå›¾ç‰‡ï¼ŒæŸ¥æ‰¾èŠ‚ç‚¹812çš„è¾“å‡º...')\r\n    console.log('ğŸ” ä»»åŠ¡ç»“æœç»“æ„:', JSON.stringify(taskResult, null, 2))\r\n\r\n    const imageUrl = await getGeneratedImage(taskResult)\r\n    console.log('ğŸ–¼ï¸ æˆåŠŸè·å–æ¢è„¸ç»“æœå›¾ç‰‡URL')\r\n\r\n    // æ¶ˆè€—ä½“éªŒç‚¹\r\n    console.log('ğŸ’ æ¶ˆè€—ä½“éªŒç‚¹...')\r\n    const pointsResult = pointsManager.consumePoints()\r\n    console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ä½“éªŒç‚¹ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n\r\n    if (onProgress) onProgress('æ¢è„¸å®Œæˆï¼', 100)\r\n\r\n    console.log('âœ… æ¢è„¸å¤„ç†å®Œæˆ')\r\n    return {\r\n      success: true,\r\n      imageUrl: imageUrl,\r\n      targetImageUrl: targetImage, // è¿”å›ç›®æ ‡å›¾åƒç”¨äºå¯¹æ¯”\r\n      promptId: promptId,\r\n      pointsConsumed: pointsResult.consumed,\r\n      pointsRemaining: pointsResult.remaining,\r\n      message: 'æ¢è„¸å¤„ç†å®Œæˆ'\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('âŒ æ¢è„¸å¤„ç†å¤±è´¥:', error)\r\n    return {\r\n      success: false,\r\n      error: error.message,\r\n      message: 'æ¢è„¸å¤„ç†å¤±è´¥'\r\n    }\r\n  }\r\n}\r\n\r\n// å¯¼å‡ºæ‰€æœ‰å…¬å…±å‡½æ•°\r\nexport {\r\n  getCurrentConfig,\r\n  updateComfyUIConfig,\r\n  resetToDefaultConfig,\r\n  generateClientId,\r\n  getApiBaseUrl,\r\n  addConfigChangeListener,\r\n  removeConfigChangeListener,\r\n  processUndressImage,\r\n  processFaceSwapImage\r\n}\r\n"
        }
    ]
}