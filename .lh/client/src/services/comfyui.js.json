{
    "sourceFile": "client/src/services/comfyui.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 235,
            "patches": [
                {
                    "date": 1752326450066,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752326477059,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -31,27 +31,48 @@\n \r\n // é…ç½®ç¼“å­˜\r\n let configCache = null\r\n \r\n-// ä»localStorageè·å–é…ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤é…ç½®\r\n-function getComfyUIConfig(forceRefresh = false) {\r\n+// ä»æœåŠ¡å™¨å’ŒlocalStorageè·å–é…ç½®\r\n+async function getComfyUIConfig(forceRefresh = false) {\r\n   // å¦‚æœå¼ºåˆ¶åˆ·æ–°æˆ–ç¼“å­˜ä¸ºç©ºï¼Œé‡æ–°è¯»å–é…ç½®\r\n   if (forceRefresh || !configCache) {\r\n-    const savedConfig = localStorage.getItem('comfyui_config')\r\n-    if (savedConfig) {\r\n-      try {\r\n-        const parsed = JSON.parse(savedConfig)\r\n-        configCache = { ...DEFAULT_CONFIG, ...parsed }\r\n-        console.log('ğŸ”„ é…ç½®å·²åˆ·æ–°:', configCache)\r\n-      } catch (error) {\r\n-        console.warn('è§£æä¿å­˜çš„é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error)\r\n-        configCache = { ...DEFAULT_CONFIG }\r\n+    try {\r\n+      // é¦–å…ˆè·å–æœåŠ¡å™¨é…ç½®ä½œä¸ºåŸºç¡€\r\n+      const serverConfig = await getDefaultConfig();\r\n+\r\n+      // ç„¶åæ£€æŸ¥localStorageä¸­çš„ç”¨æˆ·è‡ªå®šä¹‰é…ç½®\r\n+      const savedConfig = localStorage.getItem('comfyui_config');\r\n+      if (savedConfig) {\r\n+        try {\r\n+          const parsed = JSON.parse(savedConfig);\r\n+          // åˆå¹¶æœåŠ¡å™¨é…ç½®å’Œç”¨æˆ·é…ç½®ï¼Œç”¨æˆ·é…ç½®ä¼˜å…ˆ\r\n+          configCache = { ...serverConfig, ...parsed };\r\n+          console.log('ğŸ”„ é…ç½®å·²åˆ·æ–°ï¼ˆæœåŠ¡å™¨+ç”¨æˆ·ï¼‰:', configCache);\r\n+        } catch (error) {\r\n+          console.warn('è§£æä¿å­˜çš„é…ç½®å¤±è´¥ï¼Œä½¿ç”¨æœåŠ¡å™¨é…ç½®:', error);\r\n+          configCache = { ...serverConfig };\r\n+        }\r\n+      } else {\r\n+        configCache = { ...serverConfig };\r\n+        console.log('ğŸ”„ ä½¿ç”¨æœåŠ¡å™¨é…ç½®:', configCache);\r\n       }\r\n-    } else {\r\n-      configCache = { ...DEFAULT_CONFIG }\r\n+    } catch (error) {\r\n+      console.error('âŒ è·å–é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜æˆ–é»˜è®¤é…ç½®:', error);\r\n+      if (!configCache) {\r\n+        // å¦‚æœè¿ç¼“å­˜éƒ½æ²¡æœ‰ï¼Œä½¿ç”¨ç¡¬ç¼–ç çš„é»˜è®¤é…ç½®\r\n+        configCache = {\r\n+          COMFYUI_SERVER_URL: 'https://hwf0p724ub-8188.cnb.run',\r\n+          CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n+          TIMEOUT: 300000,\r\n+          BACKUP_SERVERS: [],\r\n+          AUTO_SWITCH: true,\r\n+          MAX_RETRIES: 3\r\n+        };\r\n+      }\r\n     }\r\n   }\r\n-  return { ...configCache }\r\n+  return { ...configCache };\r\n }\r\n \r\n // ä¿å­˜é…ç½®åˆ°localStorage\r\n function saveComfyUIConfig(config) {\r\n"
                },
                {
                    "date": 1752326498699,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -182,21 +182,21 @@\n function getCurrentConfig(forceRefresh = false) {\r\n   return getComfyUIConfig(forceRefresh)\r\n }\r\n \r\n-// è·å–APIåŸºç¡€URL - ç›´è¿æ¨¡å¼\r\n-function getApiBaseUrl() {\r\n-  const config = getComfyUIConfig(true)\r\n-  console.log('ğŸ¯ ç›´è¿ComfyUIæœåŠ¡å™¨:', config.COMFYUI_SERVER_URL)\r\n+// è·å–APIåŸºç¡€URL - åŠ¨æ€é…ç½®æ¨¡å¼\r\n+async function getApiBaseUrl() {\r\n+  const config = await getComfyUIConfig(true);\r\n+  console.log('ğŸ¯ ä½¿ç”¨ComfyUIæœåŠ¡å™¨:', config.COMFYUI_SERVER_URL);\r\n \r\n-  let baseUrl = config.COMFYUI_SERVER_URL\r\n+  let baseUrl = config.COMFYUI_SERVER_URL;\r\n \r\n   // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n   if (baseUrl && baseUrl.endsWith('/')) {\r\n-    baseUrl = baseUrl.slice(0, -1)\r\n+    baseUrl = baseUrl.slice(0, -1);\r\n   }\r\n \r\n-  return baseUrl\r\n+  return baseUrl;\r\n }\r\n \r\n // é‡ç½®ä¸ºé»˜è®¤é…ç½®\r\n function resetToDefaultConfig() {\r\n"
                },
                {
                    "date": 1752326513006,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -177,11 +177,11 @@\n     proxyUpdate: proxyUpdateResult\r\n   }\r\n }\r\n \r\n-// è·å–å½“å‰é…ç½®\r\n-function getCurrentConfig(forceRefresh = false) {\r\n-  return getComfyUIConfig(forceRefresh)\r\n+// è·å–å½“å‰é…ç½®ï¼ˆå¼‚æ­¥ï¼‰\r\n+async function getCurrentConfig(forceRefresh = false) {\r\n+  return await getComfyUIConfig(forceRefresh);\r\n }\r\n \r\n // è·å–APIåŸºç¡€URL - åŠ¨æ€é…ç½®æ¨¡å¼\r\n async function getApiBaseUrl() {\r\n"
                },
                {
                    "date": 1752326535389,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -152,31 +152,31 @@\n }\r\n \r\n // æ›´æ–°é…ç½®\r\n async function updateComfyUIConfig(newConfig) {\r\n-  const currentConfig = getComfyUIConfig(true) // å¼ºåˆ¶åˆ·æ–°å½“å‰é…ç½®\r\n-  const updatedConfig = { ...currentConfig, ...newConfig }\r\n+  const currentConfig = await getComfyUIConfig(true); // å¼ºåˆ¶åˆ·æ–°å½“å‰é…ç½®\r\n+  const updatedConfig = { ...currentConfig, ...newConfig };\r\n \r\n-  console.log('ğŸ”„ æ›´æ–°é…ç½®:', updatedConfig)\r\n+  console.log('ğŸ”„ æ›´æ–°é…ç½®:', updatedConfig);\r\n \r\n   // ä¿å­˜åˆ°localStorageï¼ˆè¿™ä¼šæ¸…é™¤ç¼“å­˜ï¼‰\r\n-  saveComfyUIConfig(updatedConfig)\r\n+  saveComfyUIConfig(updatedConfig);\r\n \r\n   // å¼ºåˆ¶åˆ·æ–°é…ç½®ç¼“å­˜\r\n-  configCache = null\r\n+  configCache = null;\r\n \r\n   // é€šçŸ¥é…ç½®å˜æ›´\r\n-  notifyConfigChange(updatedConfig)\r\n+  notifyConfigChange(updatedConfig);\r\n \r\n   // åŒæ—¶æ›´æ–°ä»£ç†æœåŠ¡å™¨é…ç½®\r\n-  const proxyUpdateResult = await updateProxyServerConfig(updatedConfig)\r\n+  const proxyUpdateResult = await updateProxyServerConfig(updatedConfig);\r\n \r\n-  console.log('âœ… é…ç½®æ›´æ–°å®Œæˆï¼Œæ–°é…ç½®å·²ç”Ÿæ•ˆ')\r\n+  console.log('âœ… é…ç½®æ›´æ–°å®Œæˆï¼Œæ–°é…ç½®å·²ç”Ÿæ•ˆ');\r\n \r\n   return {\r\n     config: updatedConfig,\r\n     proxyUpdate: proxyUpdateResult\r\n-  }\r\n+  };\r\n }\r\n \r\n // è·å–å½“å‰é…ç½®ï¼ˆå¼‚æ­¥ï¼‰\r\n async function getCurrentConfig(forceRefresh = false) {\r\n"
                },
                {
                    "date": 1752326556632,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -314,13 +314,13 @@\n \r\n // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n async function submitWorkflow(workflowPrompt) {\r\n   try {\r\n-    const config = getComfyUIConfig()\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n-    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n-    console.log('ğŸ”§ ä½¿ç”¨ä»£ç†:', config.USE_PROXY ? 'æ˜¯' : 'å¦')\r\n+    const config = await getComfyUIConfig();\r\n+    const apiBaseUrl = await getApiBaseUrl();\r\n+    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI');\r\n+    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`);\r\n+    console.log('ğŸ”§ ä½¿ç”¨ä»£ç†:', config.USE_PROXY ? 'æ˜¯' : 'å¦');\r\n \r\n     // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n     const requestBody = {\r\n       client_id: config.CLIENT_ID,\r\n"
                },
                {
                    "date": 1752326596152,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -211,12 +211,12 @@\n \r\n // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ Base64å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨å¹¶è·å–æ–‡ä»¶å\r\n async function uploadImageToComfyUI(base64Image) {\r\n   try {\r\n-    const config = getComfyUIConfig()\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n-    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n+    const config = await getComfyUIConfig();\r\n+    const apiBaseUrl = await getApiBaseUrl();\r\n+    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨');\r\n+    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`);\r\n \r\n     // éªŒè¯base64æ ¼å¼\r\n     if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n       throw new Error('æ— æ•ˆçš„base64å›¾ç‰‡æ ¼å¼')\r\n"
                },
                {
                    "date": 1752326636874,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -374,12 +374,12 @@\n \r\n // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n async function checkTaskStatus(promptId) {\r\n   try {\r\n-    const config = getComfyUIConfig()\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`)\r\n-    const response = await fetch(`${apiBaseUrl}/history/${promptId}`)\r\n+    const config = await getComfyUIConfig();\r\n+    const apiBaseUrl = await getApiBaseUrl();\r\n+    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`);\r\n+    const response = await fetch(`${apiBaseUrl}/history/${promptId}`);\r\n \r\n     if (!response.ok) {\r\n       throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText}`)\r\n     }\r\n"
                },
                {
                    "date": 1752326655020,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -395,10 +395,10 @@\n \r\n // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n async function getGeneratedImage(taskResult) {\r\n   try {\r\n-    const config = getComfyUIConfig()\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n+    const config = await getComfyUIConfig();\r\n+    const apiBaseUrl = await getApiBaseUrl();\r\n \r\n     // ä»ä»»åŠ¡ç»“æœä¸­æ‰¾åˆ°è¾“å‡ºå›¾ç‰‡\r\n     const outputs = taskResult.outputs\r\n     let imageInfo = null\r\n"
                },
                {
                    "date": 1752327478336,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,13 +16,13 @@\n       AUTO_SWITCH: config.AUTO_SWITCH,\r\n       MAX_RETRIES: config.MAX_RETRIES\r\n     };\r\n   } catch (error) {\r\n-    console.warn('âš ï¸ è·å–æœåŠ¡å™¨é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¡¬ç¼–ç é»˜è®¤å€¼:', error);\r\n+    console.warn('âš ï¸ è·å–æœåŠ¡å™¨é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼:', error);\r\n     return {\r\n-      COMFYUI_SERVER_URL: 'https://hwf0p724ub-8188.cnb.run',\r\n-      CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n-      TIMEOUT: 300000,\r\n+      COMFYUI_SERVER_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://your-comfyui-server.com',\r\n+      CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'your-comfyui-client-id',\r\n+      TIMEOUT: parseInt(import.meta.env.VITE_COMFYUI_TIMEOUT) || 300000,\r\n       BACKUP_SERVERS: [],\r\n       AUTO_SWITCH: true,\r\n       MAX_RETRIES: 3\r\n     };\r\n"
                },
                {
                    "date": 1752327494435,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -58,13 +58,13 @@\n       }\r\n     } catch (error) {\r\n       console.error('âŒ è·å–é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜æˆ–é»˜è®¤é…ç½®:', error);\r\n       if (!configCache) {\r\n-        // å¦‚æœè¿ç¼“å­˜éƒ½æ²¡æœ‰ï¼Œä½¿ç”¨ç¡¬ç¼–ç çš„é»˜è®¤é…ç½®\r\n+        // å¦‚æœè¿ç¼“å­˜éƒ½æ²¡æœ‰ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤é…ç½®\r\n         configCache = {\r\n-          COMFYUI_SERVER_URL: 'https://hwf0p724ub-8188.cnb.run',\r\n-          CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n-          TIMEOUT: 300000,\r\n+          COMFYUI_SERVER_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://your-comfyui-server.com',\r\n+          CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'your-comfyui-client-id',\r\n+          TIMEOUT: parseInt(import.meta.env.VITE_COMFYUI_TIMEOUT) || 300000,\r\n           BACKUP_SERVERS: [],\r\n           AUTO_SWITCH: true,\r\n           MAX_RETRIES: 3\r\n         };\r\n"
                },
                {
                    "date": 1752328761857,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -31,34 +31,73 @@\n \r\n // é…ç½®ç¼“å­˜\r\n let configCache = null\r\n \r\n+// æ£€æŸ¥å¹¶æ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®\r\n+function cleanupOldHardcodedConfig() {\r\n+  const savedConfig = localStorage.getItem('comfyui_config');\r\n+  if (savedConfig) {\r\n+    try {\r\n+      const parsed = JSON.parse(savedConfig);\r\n+      const hardcodedUrls = [\r\n+        'https://5gke5y9mzc-8188.cnb.run',\r\n+        'https://hwf0p724ub-8188.cnb.run',\r\n+        'https://dzqgp58z0s-8188.cnb.run'\r\n+      ];\r\n+      const hardcodedIds = [\r\n+        'abc1373d4ad648a3a81d0587fbe5534b'\r\n+      ];\r\n+\r\n+      // æ£€æŸ¥æ˜¯å¦åŒ…å«ç¡¬ç¼–ç é…ç½®\r\n+      const hasHardcodedUrl = hardcodedUrls.includes(parsed.COMFYUI_SERVER_URL);\r\n+      const hasHardcodedId = hardcodedIds.includes(parsed.CLIENT_ID);\r\n+\r\n+      if (hasHardcodedUrl || hasHardcodedId) {\r\n+        console.warn('ğŸ§¹ æ£€æµ‹åˆ°æ—§çš„ç¡¬ç¼–ç é…ç½®ï¼Œæ­£åœ¨æ¸…ç†...');\r\n+        console.warn('æ—§é…ç½®:', parsed);\r\n+        localStorage.removeItem('comfyui_config');\r\n+        console.log('âœ… å·²æ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®');\r\n+        return true;\r\n+      }\r\n+    } catch (error) {\r\n+      console.warn('è§£ælocalStorageé…ç½®å¤±è´¥ï¼Œæ¸…ç†é…ç½®:', error);\r\n+      localStorage.removeItem('comfyui_config');\r\n+      return true;\r\n+    }\r\n+  }\r\n+  return false;\r\n+}\r\n+\r\n // ä»æœåŠ¡å™¨å’ŒlocalStorageè·å–é…ç½®\r\n async function getComfyUIConfig(forceRefresh = false) {\r\n-  // å¦‚æœå¼ºåˆ¶åˆ·æ–°æˆ–ç¼“å­˜ä¸ºç©ºï¼Œé‡æ–°è¯»å–é…ç½®\r\n-  if (forceRefresh || !configCache) {\r\n+  // é¦–å…ˆæ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®\r\n+  const wasCleanedUp = cleanupOldHardcodedConfig();\r\n+\r\n+  // å¦‚æœå¼ºåˆ¶åˆ·æ–°ã€ç¼“å­˜ä¸ºç©ºæˆ–åˆšæ¸…ç†äº†é…ç½®ï¼Œé‡æ–°è¯»å–é…ç½®\r\n+  if (forceRefresh || !configCache || wasCleanedUp) {\r\n     try {\r\n       // é¦–å…ˆè·å–æœåŠ¡å™¨é…ç½®ä½œä¸ºåŸºç¡€\r\n       const serverConfig = await getDefaultConfig();\r\n+      console.log('ğŸŒ ä»æœåŠ¡å™¨è·å–çš„é…ç½®:', serverConfig);\r\n \r\n-      // ç„¶åæ£€æŸ¥localStorageä¸­çš„ç”¨æˆ·è‡ªå®šä¹‰é…ç½®\r\n+      // ç„¶åæ£€æŸ¥localStorageä¸­çš„ç”¨æˆ·è‡ªå®šä¹‰é…ç½®ï¼ˆå·²æ¸…ç†ç¡¬ç¼–ç ï¼‰\r\n       const savedConfig = localStorage.getItem('comfyui_config');\r\n       if (savedConfig) {\r\n         try {\r\n           const parsed = JSON.parse(savedConfig);\r\n-          // åˆå¹¶æœåŠ¡å™¨é…ç½®å’Œç”¨æˆ·é…ç½®ï¼Œç”¨æˆ·é…ç½®ä¼˜å…ˆ\r\n-          configCache = { ...serverConfig, ...parsed };\r\n-          console.log('ğŸ”„ é…ç½®å·²åˆ·æ–°ï¼ˆæœåŠ¡å™¨+ç”¨æˆ·ï¼‰:', configCache);\r\n+          // æœåŠ¡å™¨é…ç½®ä¼˜å…ˆï¼Œç”¨æˆ·é…ç½®ä½œä¸ºè¡¥å……\r\n+          configCache = { ...parsed, ...serverConfig };\r\n+          console.log('ğŸ”„ é…ç½®å·²åˆ·æ–°ï¼ˆæœåŠ¡å™¨ä¼˜å…ˆ+ç”¨æˆ·è¡¥å……ï¼‰:', configCache);\r\n         } catch (error) {\r\n           console.warn('è§£æä¿å­˜çš„é…ç½®å¤±è´¥ï¼Œä½¿ç”¨æœåŠ¡å™¨é…ç½®:', error);\r\n           configCache = { ...serverConfig };\r\n         }\r\n       } else {\r\n         configCache = { ...serverConfig };\r\n-        console.log('ğŸ”„ ä½¿ç”¨æœåŠ¡å™¨é…ç½®:', configCache);\r\n+        console.log('ğŸ”„ ä½¿ç”¨çº¯æœåŠ¡å™¨é…ç½®:', configCache);\r\n       }\r\n     } catch (error) {\r\n-      console.error('âŒ è·å–é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜æˆ–é»˜è®¤é…ç½®:', error);\r\n+      console.error('âŒ è·å–é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤é…ç½®:', error);\r\n       if (!configCache) {\r\n         // å¦‚æœè¿ç¼“å­˜éƒ½æ²¡æœ‰ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤é…ç½®\r\n         configCache = {\r\n           COMFYUI_SERVER_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://your-comfyui-server.com',\r\n"
                },
                {
                    "date": 1752328900466,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,119 +1,42 @@\n-// ComfyUIå·¥ä½œæµæœåŠ¡ - åŠ¨æ€é…ç½®æ¨¡å¼\r\n+// ComfyUIå·¥ä½œæµæœåŠ¡ - ç›´è¿æ¨¡å¼\r\n import undressWorkflow from '../workflows/undress.json'\r\n import faceSwapWorkflow from '../workflows/faceswap2.0.json'\r\n import comfyUIConfig from '../config/comfyui.config.js'\r\n import pointsManager from '../utils/pointsManager.js'\r\n \r\n-// è·å–åŠ¨æ€é…ç½®çš„é»˜è®¤å€¼\r\n-async function getDefaultConfig() {\r\n-  try {\r\n-    const config = await comfyUIConfig.getConfig();\r\n-    return {\r\n-      COMFYUI_SERVER_URL: config.BASE_URL,\r\n-      CLIENT_ID: config.CLIENT_ID,\r\n-      TIMEOUT: config.REQUEST_TIMEOUT,\r\n-      BACKUP_SERVERS: config.BACKUP_SERVERS,\r\n-      AUTO_SWITCH: config.AUTO_SWITCH,\r\n-      MAX_RETRIES: config.MAX_RETRIES\r\n-    };\r\n-  } catch (error) {\r\n-    console.warn('âš ï¸ è·å–æœåŠ¡å™¨é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼:', error);\r\n-    return {\r\n-      COMFYUI_SERVER_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://your-comfyui-server.com',\r\n-      CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'your-comfyui-client-id',\r\n-      TIMEOUT: parseInt(import.meta.env.VITE_COMFYUI_TIMEOUT) || 300000,\r\n-      BACKUP_SERVERS: [],\r\n-      AUTO_SWITCH: true,\r\n-      MAX_RETRIES: 3\r\n-    };\r\n-  }\r\n+// APIé…ç½® - ç›´è¿æ¨¡å¼\r\n+const DEFAULT_CONFIG = {\r\n+  // ComfyUIæœåŠ¡å™¨URLï¼ˆç”¨æˆ·å¯é…ç½®ï¼‰\r\n+  COMFYUI_SERVER_URL: comfyUIConfig.BASE_URL,\r\n+  CLIENT_ID: comfyUIConfig.CLIENT_ID,\r\n+  TIMEOUT: 300000 // 5åˆ†é’Ÿ\r\n }\r\n \r\n // é…ç½®ç¼“å­˜\r\n let configCache = null\r\n \r\n-// æ£€æŸ¥å¹¶æ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®\r\n-function cleanupOldHardcodedConfig() {\r\n-  const savedConfig = localStorage.getItem('comfyui_config');\r\n-  if (savedConfig) {\r\n-    try {\r\n-      const parsed = JSON.parse(savedConfig);\r\n-      const hardcodedUrls = [\r\n-        'https://5gke5y9mzc-8188.cnb.run',\r\n-        'https://hwf0p724ub-8188.cnb.run',\r\n-        'https://dzqgp58z0s-8188.cnb.run'\r\n-      ];\r\n-      const hardcodedIds = [\r\n-        'abc1373d4ad648a3a81d0587fbe5534b'\r\n-      ];\r\n-\r\n-      // æ£€æŸ¥æ˜¯å¦åŒ…å«ç¡¬ç¼–ç é…ç½®\r\n-      const hasHardcodedUrl = hardcodedUrls.includes(parsed.COMFYUI_SERVER_URL);\r\n-      const hasHardcodedId = hardcodedIds.includes(parsed.CLIENT_ID);\r\n-\r\n-      if (hasHardcodedUrl || hasHardcodedId) {\r\n-        console.warn('ğŸ§¹ æ£€æµ‹åˆ°æ—§çš„ç¡¬ç¼–ç é…ç½®ï¼Œæ­£åœ¨æ¸…ç†...');\r\n-        console.warn('æ—§é…ç½®:', parsed);\r\n-        localStorage.removeItem('comfyui_config');\r\n-        console.log('âœ… å·²æ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®');\r\n-        return true;\r\n+// ä»localStorageè·å–é…ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤é…ç½®\r\n+function getComfyUIConfig(forceRefresh = false) {\r\n+  // å¦‚æœå¼ºåˆ¶åˆ·æ–°æˆ–ç¼“å­˜ä¸ºç©ºï¼Œé‡æ–°è¯»å–é…ç½®\r\n+  if (forceRefresh || !configCache) {\r\n+    const savedConfig = localStorage.getItem('comfyui_config')\r\n+    if (savedConfig) {\r\n+      try {\r\n+        const parsed = JSON.parse(savedConfig)\r\n+        configCache = { ...DEFAULT_CONFIG, ...parsed }\r\n+        console.log('ğŸ”„ é…ç½®å·²åˆ·æ–°:', configCache)\r\n+      } catch (error) {\r\n+        console.warn('è§£æä¿å­˜çš„é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error)\r\n+        configCache = { ...DEFAULT_CONFIG }\r\n       }\r\n-    } catch (error) {\r\n-      console.warn('è§£ælocalStorageé…ç½®å¤±è´¥ï¼Œæ¸…ç†é…ç½®:', error);\r\n-      localStorage.removeItem('comfyui_config');\r\n-      return true;\r\n+    } else {\r\n+      configCache = { ...DEFAULT_CONFIG }\r\n     }\r\n   }\r\n-  return false;\r\n+  return { ...configCache }\r\n }\r\n \r\n-// ä»æœåŠ¡å™¨å’ŒlocalStorageè·å–é…ç½®\r\n-async function getComfyUIConfig(forceRefresh = false) {\r\n-  // é¦–å…ˆæ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®\r\n-  const wasCleanedUp = cleanupOldHardcodedConfig();\r\n-\r\n-  // å¦‚æœå¼ºåˆ¶åˆ·æ–°ã€ç¼“å­˜ä¸ºç©ºæˆ–åˆšæ¸…ç†äº†é…ç½®ï¼Œé‡æ–°è¯»å–é…ç½®\r\n-  if (forceRefresh || !configCache || wasCleanedUp) {\r\n-    try {\r\n-      // é¦–å…ˆè·å–æœåŠ¡å™¨é…ç½®ä½œä¸ºåŸºç¡€\r\n-      const serverConfig = await getDefaultConfig();\r\n-      console.log('ğŸŒ ä»æœåŠ¡å™¨è·å–çš„é…ç½®:', serverConfig);\r\n-\r\n-      // ç„¶åæ£€æŸ¥localStorageä¸­çš„ç”¨æˆ·è‡ªå®šä¹‰é…ç½®ï¼ˆå·²æ¸…ç†ç¡¬ç¼–ç ï¼‰\r\n-      const savedConfig = localStorage.getItem('comfyui_config');\r\n-      if (savedConfig) {\r\n-        try {\r\n-          const parsed = JSON.parse(savedConfig);\r\n-          // æœåŠ¡å™¨é…ç½®ä¼˜å…ˆï¼Œç”¨æˆ·é…ç½®ä½œä¸ºè¡¥å……\r\n-          configCache = { ...parsed, ...serverConfig };\r\n-          console.log('ğŸ”„ é…ç½®å·²åˆ·æ–°ï¼ˆæœåŠ¡å™¨ä¼˜å…ˆ+ç”¨æˆ·è¡¥å……ï¼‰:', configCache);\r\n-        } catch (error) {\r\n-          console.warn('è§£æä¿å­˜çš„é…ç½®å¤±è´¥ï¼Œä½¿ç”¨æœåŠ¡å™¨é…ç½®:', error);\r\n-          configCache = { ...serverConfig };\r\n-        }\r\n-      } else {\r\n-        configCache = { ...serverConfig };\r\n-        console.log('ğŸ”„ ä½¿ç”¨çº¯æœåŠ¡å™¨é…ç½®:', configCache);\r\n-      }\r\n-    } catch (error) {\r\n-      console.error('âŒ è·å–é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤é…ç½®:', error);\r\n-      if (!configCache) {\r\n-        // å¦‚æœè¿ç¼“å­˜éƒ½æ²¡æœ‰ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤é…ç½®\r\n-        configCache = {\r\n-          COMFYUI_SERVER_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://your-comfyui-server.com',\r\n-          CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'your-comfyui-client-id',\r\n-          TIMEOUT: parseInt(import.meta.env.VITE_COMFYUI_TIMEOUT) || 300000,\r\n-          BACKUP_SERVERS: [],\r\n-          AUTO_SWITCH: true,\r\n-          MAX_RETRIES: 3\r\n-        };\r\n-      }\r\n-    }\r\n-  }\r\n-  return { ...configCache };\r\n-}\r\n-\r\n // ä¿å­˜é…ç½®åˆ°localStorage\r\n function saveComfyUIConfig(config) {\r\n   try {\r\n     localStorage.setItem('comfyui_config', JSON.stringify(config))\r\n@@ -191,51 +114,51 @@\n }\r\n \r\n // æ›´æ–°é…ç½®\r\n async function updateComfyUIConfig(newConfig) {\r\n-  const currentConfig = await getComfyUIConfig(true); // å¼ºåˆ¶åˆ·æ–°å½“å‰é…ç½®\r\n-  const updatedConfig = { ...currentConfig, ...newConfig };\r\n+  const currentConfig = getComfyUIConfig(true) // å¼ºåˆ¶åˆ·æ–°å½“å‰é…ç½®\r\n+  const updatedConfig = { ...currentConfig, ...newConfig }\r\n \r\n-  console.log('ğŸ”„ æ›´æ–°é…ç½®:', updatedConfig);\r\n+  console.log('ğŸ”„ æ›´æ–°é…ç½®:', updatedConfig)\r\n \r\n   // ä¿å­˜åˆ°localStorageï¼ˆè¿™ä¼šæ¸…é™¤ç¼“å­˜ï¼‰\r\n-  saveComfyUIConfig(updatedConfig);\r\n+  saveComfyUIConfig(updatedConfig)\r\n \r\n   // å¼ºåˆ¶åˆ·æ–°é…ç½®ç¼“å­˜\r\n-  configCache = null;\r\n+  configCache = null\r\n \r\n   // é€šçŸ¥é…ç½®å˜æ›´\r\n-  notifyConfigChange(updatedConfig);\r\n+  notifyConfigChange(updatedConfig)\r\n \r\n   // åŒæ—¶æ›´æ–°ä»£ç†æœåŠ¡å™¨é…ç½®\r\n-  const proxyUpdateResult = await updateProxyServerConfig(updatedConfig);\r\n+  const proxyUpdateResult = await updateProxyServerConfig(updatedConfig)\r\n \r\n-  console.log('âœ… é…ç½®æ›´æ–°å®Œæˆï¼Œæ–°é…ç½®å·²ç”Ÿæ•ˆ');\r\n+  console.log('âœ… é…ç½®æ›´æ–°å®Œæˆï¼Œæ–°é…ç½®å·²ç”Ÿæ•ˆ')\r\n \r\n   return {\r\n     config: updatedConfig,\r\n     proxyUpdate: proxyUpdateResult\r\n-  };\r\n+  }\r\n }\r\n \r\n-// è·å–å½“å‰é…ç½®ï¼ˆå¼‚æ­¥ï¼‰\r\n-async function getCurrentConfig(forceRefresh = false) {\r\n-  return await getComfyUIConfig(forceRefresh);\r\n+// è·å–å½“å‰é…ç½®\r\n+function getCurrentConfig(forceRefresh = false) {\r\n+  return getComfyUIConfig(forceRefresh)\r\n }\r\n \r\n-// è·å–APIåŸºç¡€URL - åŠ¨æ€é…ç½®æ¨¡å¼\r\n-async function getApiBaseUrl() {\r\n-  const config = await getComfyUIConfig(true);\r\n-  console.log('ğŸ¯ ä½¿ç”¨ComfyUIæœåŠ¡å™¨:', config.COMFYUI_SERVER_URL);\r\n+// è·å–APIåŸºç¡€URL - ç›´è¿æ¨¡å¼\r\n+function getApiBaseUrl() {\r\n+  const config = getComfyUIConfig(true)\r\n+  console.log('ğŸ¯ ç›´è¿ComfyUIæœåŠ¡å™¨:', config.COMFYUI_SERVER_URL)\r\n \r\n-  let baseUrl = config.COMFYUI_SERVER_URL;\r\n+  let baseUrl = config.COMFYUI_SERVER_URL\r\n \r\n   // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n   if (baseUrl && baseUrl.endsWith('/')) {\r\n-    baseUrl = baseUrl.slice(0, -1);\r\n+    baseUrl = baseUrl.slice(0, -1)\r\n   }\r\n \r\n-  return baseUrl;\r\n+  return baseUrl\r\n }\r\n \r\n // é‡ç½®ä¸ºé»˜è®¤é…ç½®\r\n function resetToDefaultConfig() {\r\n@@ -250,12 +173,12 @@\n \r\n // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ Base64å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨å¹¶è·å–æ–‡ä»¶å\r\n async function uploadImageToComfyUI(base64Image) {\r\n   try {\r\n-    const config = await getComfyUIConfig();\r\n-    const apiBaseUrl = await getApiBaseUrl();\r\n-    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨');\r\n-    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`);\r\n+    const config = getComfyUIConfig()\r\n+    const apiBaseUrl = getApiBaseUrl()\r\n+    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n+    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n \r\n     // éªŒè¯base64æ ¼å¼\r\n     if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n       throw new Error('æ— æ•ˆçš„base64å›¾ç‰‡æ ¼å¼')\r\n@@ -353,13 +276,13 @@\n \r\n // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n async function submitWorkflow(workflowPrompt) {\r\n   try {\r\n-    const config = await getComfyUIConfig();\r\n-    const apiBaseUrl = await getApiBaseUrl();\r\n-    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI');\r\n-    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`);\r\n-    console.log('ğŸ”§ ä½¿ç”¨ä»£ç†:', config.USE_PROXY ? 'æ˜¯' : 'å¦');\r\n+    const config = getComfyUIConfig()\r\n+    const apiBaseUrl = getApiBaseUrl()\r\n+    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n+    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n+    console.log('ğŸ”§ ä½¿ç”¨ä»£ç†:', config.USE_PROXY ? 'æ˜¯' : 'å¦')\r\n \r\n     // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n     const requestBody = {\r\n       client_id: config.CLIENT_ID,\r\n@@ -413,12 +336,12 @@\n \r\n // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n async function checkTaskStatus(promptId) {\r\n   try {\r\n-    const config = await getComfyUIConfig();\r\n-    const apiBaseUrl = await getApiBaseUrl();\r\n-    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`);\r\n-    const response = await fetch(`${apiBaseUrl}/history/${promptId}`);\r\n+    const config = getComfyUIConfig()\r\n+    const apiBaseUrl = getApiBaseUrl()\r\n+    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`)\r\n+    const response = await fetch(`${apiBaseUrl}/history/${promptId}`)\r\n \r\n     if (!response.ok) {\r\n       throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText}`)\r\n     }\r\n@@ -434,10 +357,10 @@\n \r\n // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n async function getGeneratedImage(taskResult) {\r\n   try {\r\n-    const config = await getComfyUIConfig();\r\n-    const apiBaseUrl = await getApiBaseUrl();\r\n+    const config = getComfyUIConfig()\r\n+    const apiBaseUrl = getApiBaseUrl()\r\n \r\n     // ä»ä»»åŠ¡ç»“æœä¸­æ‰¾åˆ°è¾“å‡ºå›¾ç‰‡\r\n     const outputs = taskResult.outputs\r\n     let imageInfo = null\r\n"
                },
                {
                    "date": 1752330205149,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,8 +2,9 @@\n import undressWorkflow from '../workflows/undress.json'\r\n import faceSwapWorkflow from '../workflows/faceswap2.0.json'\r\n import comfyUIConfig from '../config/comfyui.config.js'\r\n import pointsManager from '../utils/pointsManager.js'\r\n+import { updateAPIConfig } from './api.js'\r\n \r\n // APIé…ç½® - ç›´è¿æ¨¡å¼\r\n const DEFAULT_CONFIG = {\r\n   // ComfyUIæœåŠ¡å™¨URLï¼ˆç”¨æˆ·å¯é…ç½®ï¼‰\r\n"
                },
                {
                    "date": 1752330218715,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -104,8 +104,15 @@\n }\r\n \r\n // é€šçŸ¥é…ç½®å˜æ›´\r\n function notifyConfigChange(config) {\r\n+  // åŒæ­¥æ›´æ–°APIé…ç½®\r\n+  try {\r\n+    updateAPIConfig(config)\r\n+  } catch (error) {\r\n+    console.error('æ›´æ–°APIé…ç½®å¤±è´¥:', error)\r\n+  }\r\n+\r\n   configChangeListeners.forEach(listener => {\r\n     try {\r\n       listener(config)\r\n     } catch (error) {\r\n"
                },
                {
                    "date": 1752332190423,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -183,10 +183,10 @@\n async function uploadImageToComfyUI(base64Image) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n     const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n-    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n+    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šé€šè¿‡åç«¯è´Ÿè½½å‡è¡¡ä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n+    console.log('ğŸ“¡ åç«¯APIåœ°å€:', '/api/comfyui/upload')\r\n \r\n     // éªŒè¯base64æ ¼å¼\r\n     if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n       throw new Error('æ— æ•ˆçš„base64å›¾ç‰‡æ ¼å¼')\r\n"
                },
                {
                    "date": 1752332206742,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -214,18 +214,18 @@\n       type: mimeType,\r\n       size: `${(blob.size / 1024).toFixed(2)} KB`\r\n     })\r\n \r\n-    // ç›´è¿ä¸Šä¼ å›¾ç‰‡\r\n+    // é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡ä¸Šä¼ å›¾ç‰‡\r\n     const formData = new FormData()\r\n     formData.append('image', blob, filename)\r\n     formData.append('type', 'input')\r\n     formData.append('subfolder', '')\r\n     formData.append('overwrite', 'false')\r\n \r\n-    console.log('ğŸ”„ å¼€å§‹ä¸Šä¼ å›¾ç‰‡...')\r\n+    console.log('ğŸ”„ å¼€å§‹é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡ä¸Šä¼ å›¾ç‰‡...')\r\n \r\n-    const response = await fetch(`${apiBaseUrl}/upload/image`, {\r\n+    const response = await fetch('/api/comfyui/upload', {\r\n       method: 'POST',\r\n       body: formData\r\n     })\r\n \r\n"
                },
                {
                    "date": 1752332222579,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -239,13 +239,13 @@\n     const result = await response.json()\r\n     console.log('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', result)\r\n \r\n     // éªŒè¯è¿”å›ç»“æœ\r\n-    if (!result.name) {\r\n+    if (!result.success || !result.data?.name) {\r\n       throw new Error('ä¸Šä¼ å“åº”ä¸­ç¼ºå°‘æ–‡ä»¶å')\r\n     }\r\n \r\n-    return result.name\r\n+    return result.data.name\r\n \r\n   } catch (error) {\r\n     console.error('âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error)\r\n     throw new Error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`)\r\n"
                },
                {
                    "date": 1752332246255,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -286,11 +286,10 @@\n async function submitWorkflow(workflowPrompt) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n     const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n-    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n-    console.log('ğŸ”§ ä½¿ç”¨ä»£ç†:', config.USE_PROXY ? 'æ˜¯' : 'å¦')\r\n+    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šé€šè¿‡åç«¯è´Ÿè½½å‡è¡¡æäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n+    console.log('ğŸ“¡ åç«¯APIåœ°å€:', '/api/comfyui/prompt')\r\n \r\n     // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n     const requestBody = {\r\n       client_id: config.CLIENT_ID,\r\n"
                },
                {
                    "date": 1752332262277,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -302,20 +302,17 @@\n       node_49_exists: !!requestBody.prompt['49'],\r\n       node_49_image: requestBody.prompt['49']?.inputs?.image\r\n     })\r\n \r\n-    // ç¬¬äºŒæ­¥APIè°ƒç”¨ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n-    const promptUrl = `${apiBaseUrl}/prompt`\r\n-    console.log('ğŸŒ è°ƒç”¨å·¥ä½œæµAPI:', promptUrl)\r\n+    // ç¬¬äºŒæ­¥APIè°ƒç”¨ï¼šé€šè¿‡åç«¯è´Ÿè½½å‡è¡¡æäº¤å·¥ä½œæµåˆ°ComfyUI\r\n+    console.log('ğŸŒ è°ƒç”¨åç«¯è´Ÿè½½å‡è¡¡å·¥ä½œæµAPI: /api/comfyui/prompt')\r\n \r\n-    const response = await fetch(promptUrl, {\r\n+    const response = await fetch('/api/comfyui/prompt', {\r\n       method: 'POST',\r\n       headers: {\r\n         'Content-Type': 'application/json'\r\n       },\r\n-      body: JSON.stringify(requestBody),\r\n-      mode: 'cors',\r\n-      credentials: 'omit'\r\n+      body: JSON.stringify(requestBody)\r\n     })\r\n \r\n     console.log('ğŸ“¥ å·¥ä½œæµå“åº”çŠ¶æ€:', response.status, response.statusText)\r\n \r\n"
                },
                {
                    "date": 1752332278398,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -325,13 +325,13 @@\n     const result = await response.json()\r\n     console.log('âœ… å·¥ä½œæµæäº¤æˆåŠŸ:', result)\r\n \r\n     // éªŒè¯è¿”å›ç»“æœ\r\n-    if (!result.prompt_id) {\r\n+    if (!result.success || !result.data?.prompt_id) {\r\n       throw new Error('å·¥ä½œæµå“åº”ä¸­ç¼ºå°‘prompt_id')\r\n     }\r\n \r\n-    return result.prompt_id // è¿”å›ä»»åŠ¡ID\r\n+    return result.data.prompt_id // è¿”å›ä»»åŠ¡ID\r\n \r\n   } catch (error) {\r\n     console.error('âŒ å·¥ä½œæµæäº¤å¤±è´¥:', error)\r\n     throw new Error(`å·¥ä½œæµæäº¤å¤±è´¥: ${error.message}`)\r\n"
                },
                {
                    "date": 1752332302531,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -342,10 +342,10 @@\n async function checkTaskStatus(promptId) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n     const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`)\r\n-    const response = await fetch(`${apiBaseUrl}/history/${promptId}`)\r\n+    console.log('ğŸ” é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `/api/comfyui/history/${promptId}`)\r\n+    const response = await fetch(`/api/comfyui/history/${promptId}`)\r\n \r\n     if (!response.ok) {\r\n       throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText}`)\r\n     }\r\n"
                },
                {
                    "date": 1752332316415,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -350,10 +350,16 @@\n       throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText}`)\r\n     }\r\n \r\n     const result = await response.json()\r\n-    return result[promptId] || null\r\n \r\n+    // å¤„ç†åç«¯APIå“åº”æ ¼å¼\r\n+    if (result.success && result.data) {\r\n+      return result.data[promptId] || null\r\n+    } else {\r\n+      return result[promptId] || null\r\n+    }\r\n+\r\n   } catch (error) {\r\n     console.error('çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', error)\r\n     throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${error.message}`)\r\n   }\r\n"
                },
                {
                    "date": 1752332340881,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -414,17 +414,17 @@\n     }\r\n \r\n     console.log('ğŸ“· æœ€ç»ˆé€‰æ‹©çš„å›¾ç‰‡:', imageInfo)\r\n \r\n-    // æ„å»ºå›¾ç‰‡URL - æŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n+    // æ„å»ºå›¾ç‰‡URL - é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡\r\n     const params = new URLSearchParams({\r\n       filename: imageInfo.filename,\r\n       type: imageInfo.type,\r\n       subfolder: imageInfo.subfolder || ''\r\n     })\r\n-    const imageUrl = `${apiBaseUrl}/view?${params.toString()}`\r\n+    const imageUrl = `/api/comfyui/view?${params.toString()}`\r\n \r\n-    console.log('ğŸŒ è·å–å›¾ç‰‡URL:', imageUrl)\r\n+    console.log('ğŸŒ é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡è·å–å›¾ç‰‡URL:', imageUrl)\r\n \r\n     // è·å–å›¾ç‰‡æ•°æ®å¹¶è½¬æ¢ä¸ºbase64\r\n     const imageResponse = await fetch(imageUrl)\r\n     if (!imageResponse.ok) {\r\n"
                },
                {
                    "date": 1752332665069,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -183,10 +183,10 @@\n async function uploadImageToComfyUI(base64Image) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n     const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šé€šè¿‡åç«¯è´Ÿè½½å‡è¡¡ä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n-    console.log('ğŸ“¡ åç«¯APIåœ°å€:', '/api/comfyui/upload')\r\n+    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n+    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n \r\n     // éªŒè¯base64æ ¼å¼\r\n     if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n       throw new Error('æ— æ•ˆçš„base64å›¾ç‰‡æ ¼å¼')\r\n@@ -214,18 +214,18 @@\n       type: mimeType,\r\n       size: `${(blob.size / 1024).toFixed(2)} KB`\r\n     })\r\n \r\n-    // é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡ä¸Šä¼ å›¾ç‰‡\r\n+    // ç›´è¿ä¸Šä¼ å›¾ç‰‡\r\n     const formData = new FormData()\r\n     formData.append('image', blob, filename)\r\n     formData.append('type', 'input')\r\n     formData.append('subfolder', '')\r\n     formData.append('overwrite', 'false')\r\n \r\n-    console.log('ğŸ”„ å¼€å§‹é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡ä¸Šä¼ å›¾ç‰‡...')\r\n+    console.log('ğŸ”„ å¼€å§‹ä¸Šä¼ å›¾ç‰‡...')\r\n \r\n-    const response = await fetch('/api/comfyui/upload', {\r\n+    const response = await fetch(`${apiBaseUrl}/upload/image`, {\r\n       method: 'POST',\r\n       body: formData\r\n     })\r\n \r\n@@ -239,13 +239,13 @@\n     const result = await response.json()\r\n     console.log('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', result)\r\n \r\n     // éªŒè¯è¿”å›ç»“æœ\r\n-    if (!result.success || !result.data?.name) {\r\n+    if (!result.name) {\r\n       throw new Error('ä¸Šä¼ å“åº”ä¸­ç¼ºå°‘æ–‡ä»¶å')\r\n     }\r\n \r\n-    return result.data.name\r\n+    return result.name\r\n \r\n   } catch (error) {\r\n     console.error('âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error)\r\n     throw new Error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`)\r\n@@ -286,10 +286,11 @@\n async function submitWorkflow(workflowPrompt) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n     const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šé€šè¿‡åç«¯è´Ÿè½½å‡è¡¡æäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n-    console.log('ğŸ“¡ åç«¯APIåœ°å€:', '/api/comfyui/prompt')\r\n+    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n+    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n+    console.log('ğŸ”§ ä½¿ç”¨ä»£ç†:', config.USE_PROXY ? 'æ˜¯' : 'å¦')\r\n \r\n     // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n     const requestBody = {\r\n       client_id: config.CLIENT_ID,\r\n@@ -302,17 +303,20 @@\n       node_49_exists: !!requestBody.prompt['49'],\r\n       node_49_image: requestBody.prompt['49']?.inputs?.image\r\n     })\r\n \r\n-    // ç¬¬äºŒæ­¥APIè°ƒç”¨ï¼šé€šè¿‡åç«¯è´Ÿè½½å‡è¡¡æäº¤å·¥ä½œæµåˆ°ComfyUI\r\n-    console.log('ğŸŒ è°ƒç”¨åç«¯è´Ÿè½½å‡è¡¡å·¥ä½œæµAPI: /api/comfyui/prompt')\r\n+    // ç¬¬äºŒæ­¥APIè°ƒç”¨ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n+    const promptUrl = `${apiBaseUrl}/prompt`\r\n+    console.log('ğŸŒ è°ƒç”¨å·¥ä½œæµAPI:', promptUrl)\r\n \r\n-    const response = await fetch('/api/comfyui/prompt', {\r\n+    const response = await fetch(promptUrl, {\r\n       method: 'POST',\r\n       headers: {\r\n         'Content-Type': 'application/json'\r\n       },\r\n-      body: JSON.stringify(requestBody)\r\n+      body: JSON.stringify(requestBody),\r\n+      mode: 'cors',\r\n+      credentials: 'omit'\r\n     })\r\n \r\n     console.log('ğŸ“¥ å·¥ä½œæµå“åº”çŠ¶æ€:', response.status, response.statusText)\r\n \r\n@@ -325,13 +329,13 @@\n     const result = await response.json()\r\n     console.log('âœ… å·¥ä½œæµæäº¤æˆåŠŸ:', result)\r\n \r\n     // éªŒè¯è¿”å›ç»“æœ\r\n-    if (!result.success || !result.data?.prompt_id) {\r\n+    if (!result.prompt_id) {\r\n       throw new Error('å·¥ä½œæµå“åº”ä¸­ç¼ºå°‘prompt_id')\r\n     }\r\n \r\n-    return result.data.prompt_id // è¿”å›ä»»åŠ¡ID\r\n+    return result.prompt_id // è¿”å›ä»»åŠ¡ID\r\n \r\n   } catch (error) {\r\n     console.error('âŒ å·¥ä½œæµæäº¤å¤±è´¥:', error)\r\n     throw new Error(`å·¥ä½œæµæäº¤å¤±è´¥: ${error.message}`)\r\n@@ -342,24 +346,18 @@\n async function checkTaskStatus(promptId) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n     const apiBaseUrl = getApiBaseUrl()\r\n-    console.log('ğŸ” é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `/api/comfyui/history/${promptId}`)\r\n-    const response = await fetch(`/api/comfyui/history/${promptId}`)\r\n+    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`)\r\n+    const response = await fetch(`${apiBaseUrl}/history/${promptId}`)\r\n \r\n     if (!response.ok) {\r\n       throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText}`)\r\n     }\r\n \r\n     const result = await response.json()\r\n+    return result[promptId] || null\r\n \r\n-    // å¤„ç†åç«¯APIå“åº”æ ¼å¼\r\n-    if (result.success && result.data) {\r\n-      return result.data[promptId] || null\r\n-    } else {\r\n-      return result[promptId] || null\r\n-    }\r\n-\r\n   } catch (error) {\r\n     console.error('çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', error)\r\n     throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${error.message}`)\r\n   }\r\n@@ -414,17 +412,17 @@\n     }\r\n \r\n     console.log('ğŸ“· æœ€ç»ˆé€‰æ‹©çš„å›¾ç‰‡:', imageInfo)\r\n \r\n-    // æ„å»ºå›¾ç‰‡URL - é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡\r\n+    // æ„å»ºå›¾ç‰‡URL - æŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n     const params = new URLSearchParams({\r\n       filename: imageInfo.filename,\r\n       type: imageInfo.type,\r\n       subfolder: imageInfo.subfolder || ''\r\n     })\r\n-    const imageUrl = `/api/comfyui/view?${params.toString()}`\r\n+    const imageUrl = `${apiBaseUrl}/view?${params.toString()}`\r\n \r\n-    console.log('ğŸŒ é€šè¿‡åç«¯è´Ÿè½½å‡è¡¡è·å–å›¾ç‰‡URL:', imageUrl)\r\n+    console.log('ğŸŒ è·å–å›¾ç‰‡URL:', imageUrl)\r\n \r\n     // è·å–å›¾ç‰‡æ•°æ®å¹¶è½¬æ¢ä¸ºbase64\r\n     const imageResponse = await fetch(imageUrl)\r\n     if (!imageResponse.ok) {\r\n"
                },
                {
                    "date": 1752332884368,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,8 +3,9 @@\n import faceSwapWorkflow from '../workflows/faceswap2.0.json'\r\n import comfyUIConfig from '../config/comfyui.config.js'\r\n import pointsManager from '../utils/pointsManager.js'\r\n import { updateAPIConfig } from './api.js'\r\n+import loadBalancer from './loadBalancer.js'\r\n \r\n // APIé…ç½® - ç›´è¿æ¨¡å¼\r\n const DEFAULT_CONFIG = {\r\n   // ComfyUIæœåŠ¡å™¨URLï¼ˆç”¨æˆ·å¯é…ç½®ï¼‰\r\n"
                },
                {
                    "date": 1752332902461,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -153,21 +153,35 @@\n function getCurrentConfig(forceRefresh = false) {\r\n   return getComfyUIConfig(forceRefresh)\r\n }\r\n \r\n-// è·å–APIåŸºç¡€URL - ç›´è¿æ¨¡å¼\r\n-function getApiBaseUrl() {\r\n-  const config = getComfyUIConfig(true)\r\n-  console.log('ğŸ¯ ç›´è¿ComfyUIæœåŠ¡å™¨:', config.COMFYUI_SERVER_URL)\r\n+// è·å–APIåŸºç¡€URL - ä½¿ç”¨è´Ÿè½½å‡è¡¡\r\n+async function getApiBaseUrl() {\r\n+  try {\r\n+    // ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\r\n+    const optimalServer = await loadBalancer.getOptimalServer()\r\n+    console.log('ğŸ¯ è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœåŠ¡å™¨:', optimalServer)\r\n \r\n-  let baseUrl = config.COMFYUI_SERVER_URL\r\n+    // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n+    let baseUrl = optimalServer\r\n+    if (baseUrl && baseUrl.endsWith('/')) {\r\n+      baseUrl = baseUrl.slice(0, -1)\r\n+    }\r\n \r\n-  // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n-  if (baseUrl && baseUrl.endsWith('/')) {\r\n-    baseUrl = baseUrl.slice(0, -1)\r\n+    return baseUrl\r\n+  } catch (error) {\r\n+    console.warn('âš ï¸ è´Ÿè½½å‡è¡¡å™¨å¤±è´¥ï¼Œä½¿ç”¨é…ç½®çš„æœåŠ¡å™¨:', error)\r\n+\r\n+    // é™çº§åˆ°é…ç½®çš„æœåŠ¡å™¨\r\n+    const config = getComfyUIConfig(true)\r\n+    let baseUrl = config.COMFYUI_SERVER_URL\r\n+\r\n+    if (baseUrl && baseUrl.endsWith('/')) {\r\n+      baseUrl = baseUrl.slice(0, -1)\r\n+    }\r\n+\r\n+    return baseUrl\r\n   }\r\n-\r\n-  return baseUrl\r\n }\r\n \r\n // é‡ç½®ä¸ºé»˜è®¤é…ç½®\r\n function resetToDefaultConfig() {\r\n"
                },
                {
                    "date": 1752332920823,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -298,14 +298,16 @@\n }\r\n \r\n // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n async function submitWorkflow(workflowPrompt) {\r\n+  let selectedServer = null\r\n   try {\r\n     const config = getComfyUIConfig()\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n+    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n+    selectedServer = apiBaseUrl // è®°å½•é€‰æ‹©çš„æœåŠ¡å™¨\r\n     console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n     console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n-    console.log('ğŸ”§ ä½¿ç”¨ä»£ç†:', config.USE_PROXY ? 'æ˜¯' : 'å¦')\r\n+    console.log('ğŸ”§ ä½¿ç”¨è´Ÿè½½å‡è¡¡:', 'æ˜¯')\r\n \r\n     // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n     const requestBody = {\r\n       client_id: config.CLIENT_ID,\r\n"
                },
                {
                    "date": 1752332934682,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -354,8 +354,15 @@\n     return result.prompt_id // è¿”å›ä»»åŠ¡ID\r\n \r\n   } catch (error) {\r\n     console.error('âŒ å·¥ä½œæµæäº¤å¤±è´¥:', error)\r\n+\r\n+    // è®°å½•æœåŠ¡å™¨å¤±è´¥\r\n+    if (selectedServer) {\r\n+      console.log('ğŸ“ è®°å½•æœåŠ¡å™¨å¤±è´¥:', selectedServer)\r\n+      await loadBalancer.recordFailure(selectedServer)\r\n+    }\r\n+\r\n     throw new Error(`å·¥ä½œæµæäº¤å¤±è´¥: ${error.message}`)\r\n   }\r\n }\r\n \r\n"
                },
                {
                    "date": 1752332949434,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -369,9 +369,9 @@\n // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n async function checkTaskStatus(promptId) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n+    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n     console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`)\r\n     const response = await fetch(`${apiBaseUrl}/history/${promptId}`)\r\n \r\n     if (!response.ok) {\r\n"
                },
                {
                    "date": 1752332964179,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -579,9 +579,9 @@\n \r\n // æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€\r\n async function checkComfyUIServerStatus() {\r\n   try {\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n+    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n     console.log('ğŸ” æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€:', apiBaseUrl)\r\n \r\n     const response = await fetch(`${apiBaseUrl}/system_stats`, {\r\n       method: 'GET',\r\n"
                },
                {
                    "date": 1752333462422,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -197,9 +197,9 @@\n // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ Base64å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨å¹¶è·å–æ–‡ä»¶å\r\n async function uploadImageToComfyUI(base64Image) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n+    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n     console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n     console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n \r\n     // éªŒè¯base64æ ¼å¼\r\n"
                },
                {
                    "date": 1752333492844,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -390,9 +390,9 @@\n // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n async function getGeneratedImage(taskResult) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n-    const apiBaseUrl = getApiBaseUrl()\r\n+    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n \r\n     // ä»ä»»åŠ¡ç»“æœä¸­æ‰¾åˆ°è¾“å‡ºå›¾ç‰‡\r\n     const outputs = taskResult.outputs\r\n     let imageInfo = null\r\n"
                },
                {
                    "date": 1752333507074,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -548,9 +548,9 @@\n         type: 'input',\r\n         subfolder: ''\r\n       })\r\n       const config = getComfyUIConfig()\r\n-      const apiBaseUrl = getApiBaseUrl()\r\n+      const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n       originalImage = `${apiBaseUrl}/view?${params.toString()}`\r\n       console.log('ğŸ“· è·å–èŠ‚ç‚¹49åŸå›¾URL:', originalImage)\r\n     } catch (error) {\r\n       console.warn('âš ï¸ è·å–èŠ‚ç‚¹49åŸå›¾å¤±è´¥ï¼Œä½¿ç”¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡:', error)\r\n"
                },
                {
                    "date": 1752334226908,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,8 +2,9 @@\n import undressWorkflow from '../workflows/undress.json'\r\n import faceSwapWorkflow from '../workflows/faceswap2.0.json'\r\n import comfyUIConfig from '../config/comfyui.config.js'\r\n import pointsManager from '../utils/pointsManager.js'\r\n+import levelCardPointsManager from '../utils/levelCardPointsManager.js'\r\n import { updateAPIConfig } from './api.js'\r\n import loadBalancer from './loadBalancer.js'\r\n \r\n // APIé…ç½® - ç›´è¿æ¨¡å¼\r\n"
                },
                {
                    "date": 1752334245348,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -495,13 +495,13 @@\n async function processUndressImage(base64Image) {\r\n   try {\r\n     console.log('ğŸš€ å¼€å§‹å¤„ç†æ¢è¡£è¯·æ±‚...')\r\n \r\n-    // æ£€æŸ¥ä½“éªŒç‚¹\r\n-    console.log('ğŸ’ æ£€æŸ¥ä½“éªŒç‚¹...')\r\n-    if (!pointsManager.hasEnoughPoints()) {\r\n-      const status = pointsManager.getPointsStatus()\r\n-      throw new Error(`ä½“éªŒç‚¹ä¸è¶³ï¼å½“å‰ç‚¹æ•°: ${status.current}ï¼Œéœ€è¦: ${status.generationCost}`)\r\n+    // æ£€æŸ¥ç§¯åˆ†ï¼ˆä¼˜å…ˆä½¿ç”¨ç­‰çº§å¡ç³»ç»Ÿï¼‰\r\n+    console.log('ğŸ’ æ£€æŸ¥ç§¯åˆ†...')\r\n+    const pointsStatus = await levelCardPointsManager.getPointsStatus()\r\n+    if (!pointsStatus.canGenerate) {\r\n+      throw new Error(`ç§¯åˆ†ä¸è¶³ï¼å½“å‰ç§¯åˆ†: ${pointsStatus.current}ï¼Œéœ€è¦: ${pointsStatus.generationCost}`)\r\n     }\r\n \r\n     console.log('ğŸ“‹ æµç¨‹ï¼šç¬¬ä¸€æ­¥ä¸Šä¼ å›¾ç‰‡ â†’ ç¬¬äºŒæ­¥æäº¤å·¥ä½œæµ')\r\n \r\n"
                },
                {
                    "date": 1752334262188,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -534,12 +534,12 @@\n     console.log('ğŸ“¥ è·å–ç”Ÿæˆçš„å›¾ç‰‡...')\r\n     const resultImage = await getGeneratedImage(taskResult)\r\n     console.log('ğŸ‰ æ¢è¡£å¤„ç†å®Œå…¨æˆåŠŸï¼')\r\n \r\n-    // æ¶ˆè€—ä½“éªŒç‚¹\r\n-    console.log('ğŸ’ æ¶ˆè€—ä½“éªŒç‚¹...')\r\n-    const pointsResult = pointsManager.consumePoints()\r\n-    console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ä½“éªŒç‚¹ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n+    // æ¶ˆè€—ç§¯åˆ†ï¼ˆä»ç­‰çº§å¡æ‰£é™¤ï¼‰\r\n+    console.log('ğŸ’ æ¶ˆè€—ç§¯åˆ†...')\r\n+    const pointsResult = await levelCardPointsManager.consumePoints(20, 'ä¸€é”®æ¢è¡£', resultImage)\r\n+    console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ç§¯åˆ†ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n \r\n     // è·å–èŠ‚ç‚¹49çš„åŸå›¾ç”¨äºå¯¹æ¯”\r\n     let originalImage = null\r\n     try {\r\n"
                },
                {
                    "date": 1752334280632,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -715,12 +715,12 @@\n \r\n     const imageUrl = await getGeneratedImage(taskResult)\r\n     console.log('ğŸ–¼ï¸ æˆåŠŸè·å–æ¢è„¸ç»“æœå›¾ç‰‡URL')\r\n \r\n-    // æ¶ˆè€—ä½“éªŒç‚¹\r\n-    console.log('ğŸ’ æ¶ˆè€—ä½“éªŒç‚¹...')\r\n-    const pointsResult = pointsManager.consumePoints()\r\n-    console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ä½“éªŒç‚¹ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n+    // æ¶ˆè€—ç§¯åˆ†ï¼ˆä»ç­‰çº§å¡æ‰£é™¤ï¼‰\r\n+    console.log('ğŸ’ æ¶ˆè€—ç§¯åˆ†...')\r\n+    const pointsResult = await levelCardPointsManager.consumePoints(20, 'æé€Ÿæ¢è„¸', imageUrl)\r\n+    console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ç§¯åˆ†ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n \r\n     if (onProgress) onProgress('æ¢è„¸å®Œæˆï¼', 100)\r\n \r\n     console.log('âœ… æ¢è„¸å¤„ç†å®Œæˆ')\r\n"
                },
                {
                    "date": 1752334511810,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -607,13 +607,13 @@\n async function processFaceSwapImage({ facePhotos, targetImage, onProgress }) {\r\n   try {\r\n     console.log('ğŸš€ å¼€å§‹æ¢è„¸å¤„ç†')\r\n \r\n-    // æ£€æŸ¥ä½“éªŒç‚¹\r\n-    console.log('ğŸ’ æ£€æŸ¥ä½“éªŒç‚¹...')\r\n-    if (!pointsManager.hasEnoughPoints()) {\r\n-      const status = pointsManager.getPointsStatus()\r\n-      throw new Error(`ä½“éªŒç‚¹ä¸è¶³ï¼å½“å‰ç‚¹æ•°: ${status.current}ï¼Œéœ€è¦: ${status.generationCost}`)\r\n+    // æ£€æŸ¥ç§¯åˆ†ï¼ˆä¼˜å…ˆä½¿ç”¨ç­‰çº§å¡ç³»ç»Ÿï¼‰\r\n+    console.log('ğŸ’ æ£€æŸ¥ç§¯åˆ†...')\r\n+    const pointsStatus = await levelCardPointsManager.getPointsStatus()\r\n+    if (!pointsStatus.canGenerate) {\r\n+      throw new Error(`ç§¯åˆ†ä¸è¶³ï¼å½“å‰ç§¯åˆ†: ${pointsStatus.current}ï¼Œéœ€è¦: ${pointsStatus.generationCost}`)\r\n     }\r\n \r\n     if (onProgress) onProgress('æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...', 5)\r\n \r\n"
                },
                {
                    "date": 1752335446876,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -536,9 +536,11 @@\n     console.log('ğŸ‰ æ¢è¡£å¤„ç†å®Œå…¨æˆåŠŸï¼')\r\n \r\n     // æ¶ˆè€—ç§¯åˆ†ï¼ˆä»ç­‰çº§å¡æ‰£é™¤ï¼‰\r\n     console.log('ğŸ’ æ¶ˆè€—ç§¯åˆ†...')\r\n-    const pointsResult = await levelCardPointsManager.consumePoints(20, 'ä¸€é”®æ¢è¡£', resultImage)\r\n+    // è·å– ComfyUI å›¾ç‰‡è®¿é—®URLè€Œä¸æ˜¯ base64 æ•°æ®\r\n+    const imageViewUrl = getComfyUIImageUrl(resultImage)\r\n+    const pointsResult = await levelCardPointsManager.consumePoints(20, 'ä¸€é”®æ¢è¡£', imageViewUrl)\r\n     console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ç§¯åˆ†ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n \r\n     // è·å–èŠ‚ç‚¹49çš„åŸå›¾ç”¨äºå¯¹æ¯”\r\n     let originalImage = null\r\n"
                },
                {
                    "date": 1752335464632,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -719,9 +719,11 @@\n     console.log('ğŸ–¼ï¸ æˆåŠŸè·å–æ¢è„¸ç»“æœå›¾ç‰‡URL')\r\n \r\n     // æ¶ˆè€—ç§¯åˆ†ï¼ˆä»ç­‰çº§å¡æ‰£é™¤ï¼‰\r\n     console.log('ğŸ’ æ¶ˆè€—ç§¯åˆ†...')\r\n-    const pointsResult = await levelCardPointsManager.consumePoints(20, 'æé€Ÿæ¢è„¸', imageUrl)\r\n+    // è·å– ComfyUI å›¾ç‰‡è®¿é—®URLè€Œä¸æ˜¯ base64 æ•°æ®\r\n+    const imageViewUrl = getComfyUIImageUrl(imageUrl)\r\n+    const pointsResult = await levelCardPointsManager.consumePoints(20, 'æé€Ÿæ¢è„¸', imageViewUrl)\r\n     console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ç§¯åˆ†ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n \r\n     if (onProgress) onProgress('æ¢è„¸å®Œæˆï¼', 100)\r\n \r\n"
                },
                {
                    "date": 1752335491803,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -122,8 +122,47 @@\n     }\r\n   })\r\n }\r\n \r\n+// è·å– ComfyUI å›¾ç‰‡è®¿é—®URL\r\n+function getComfyUIImageUrl(imageData) {\r\n+  try {\r\n+    // å¦‚æœå·²ç»æ˜¯ ComfyUI çš„ URL æ ¼å¼ï¼Œç›´æ¥è¿”å›\r\n+    if (typeof imageData === 'string' && imageData.includes('/view?')) {\r\n+      console.log('ğŸ”— å·²æ˜¯ ComfyUI URL æ ¼å¼:', imageData)\r\n+      return imageData\r\n+    }\r\n+\r\n+    // å¦‚æœæ˜¯ base64 æ•°æ®ï¼Œå°è¯•ä»å…¨å±€å˜é‡æˆ–ç¼“å­˜ä¸­è·å–å¯¹åº”çš„ ComfyUI URL\r\n+    if (typeof imageData === 'string' && imageData.startsWith('data:image/')) {\r\n+      console.log('ğŸ“¸ æ£€æµ‹åˆ° base64 å›¾ç‰‡æ•°æ®ï¼Œå°è¯•è·å– ComfyUI URL...')\r\n+\r\n+      // æ£€æŸ¥æ˜¯å¦æœ‰å­˜å‚¨çš„ ComfyUI URLï¼ˆåœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­å¯èƒ½å·²ç»ä¿å­˜ï¼‰\r\n+      if (window.lastComfyUIImageUrl) {\r\n+        console.log('ğŸ”— ä½¿ç”¨ç¼“å­˜çš„ ComfyUI URL:', window.lastComfyUIImageUrl)\r\n+        return window.lastComfyUIImageUrl\r\n+      }\r\n+\r\n+      // å¦‚æœæ²¡æœ‰ç¼“å­˜çš„URLï¼Œè¿”å›ä¸€ä¸ªå ä½ç¬¦æˆ–è€… null\r\n+      console.warn('âš ï¸ æ— æ³•è·å– ComfyUI URLï¼Œä½¿ç”¨å ä½ç¬¦')\r\n+      return null\r\n+    }\r\n+\r\n+    // å…¶ä»–æƒ…å†µï¼Œå°è¯•è½¬æ¢ä¸ºå­—ç¬¦ä¸²\r\n+    const urlString = String(imageData)\r\n+    if (urlString.includes('/view?')) {\r\n+      return urlString\r\n+    }\r\n+\r\n+    console.warn('âš ï¸ æ— æ³•è¯†åˆ«çš„å›¾ç‰‡æ•°æ®æ ¼å¼:', typeof imageData)\r\n+    return null\r\n+\r\n+  } catch (error) {\r\n+    console.error('âŒ è·å– ComfyUI å›¾ç‰‡URLå¤±è´¥:', error)\r\n+    return null\r\n+  }\r\n+}\r\n+\r\n // æ›´æ–°é…ç½®\r\n async function updateComfyUIConfig(newConfig) {\r\n   const currentConfig = getComfyUIConfig(true) // å¼ºåˆ¶åˆ·æ–°å½“å‰é…ç½®\r\n   const updatedConfig = { ...currentConfig, ...newConfig }\r\n"
                },
                {
                    "date": 1752411356027,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -194,10 +194,16 @@\n   return getComfyUIConfig(forceRefresh)\r\n }\r\n \r\n // è·å–APIåŸºç¡€URL - ä½¿ç”¨è´Ÿè½½å‡è¡¡\r\n-async function getApiBaseUrl() {\r\n+async function getApiBaseUrl(forceReassessment = false) {\r\n   try {\r\n+    // å¦‚æœéœ€è¦å¼ºåˆ¶é‡æ–°è¯„ä¼°ï¼Œè§¦å‘è´Ÿè½½å‡è¡¡å™¨é‡æ–°è¯„ä¼°\r\n+    if (forceReassessment) {\r\n+      console.log('ğŸ”„ å¼ºåˆ¶é‡æ–°è¯„ä¼°æœåŠ¡å™¨...')\r\n+      await loadBalancer.forceReassessment()\r\n+    }\r\n+\r\n     // ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\r\n     const optimalServer = await loadBalancer.getOptimalServer()\r\n     console.log('ğŸ¯ è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœåŠ¡å™¨:', optimalServer)\r\n \r\n@@ -486,8 +492,12 @@\n     const imageUrl = `${apiBaseUrl}/view?${params.toString()}`\r\n \r\n     console.log('ğŸŒ è·å–å›¾ç‰‡URL:', imageUrl)\r\n \r\n+    // ä¿å­˜ ComfyUI åŸå§‹URLåˆ°å…¨å±€å˜é‡ï¼Œä¾›ç§¯åˆ†æ‰£é™¤æ—¶ä½¿ç”¨\r\n+    window.lastComfyUIImageUrl = imageUrl\r\n+    console.log('ğŸ’¾ ä¿å­˜ ComfyUI å›¾ç‰‡URL ä¾›ç§¯åˆ†è®°å½•ä½¿ç”¨:', imageUrl)\r\n+\r\n     // è·å–å›¾ç‰‡æ•°æ®å¹¶è½¬æ¢ä¸ºbase64\r\n     const imageResponse = await fetch(imageUrl)\r\n     if (!imageResponse.ok) {\r\n       throw new Error(`å›¾ç‰‡è·å–å¤±è´¥: ${imageResponse.status}`)\r\n"
                },
                {
                    "date": 1752411374142,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -308,8 +308,16 @@\n     return result.name\r\n \r\n   } catch (error) {\r\n     console.error('âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error)\r\n+\r\n+    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œè®°å½•å¤±è´¥å¹¶å¯èƒ½è§¦å‘é‡æ–°è¯„ä¼°\r\n+    if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('timeout')) {\r\n+      const currentServer = await getApiBaseUrl()\r\n+      console.log('ğŸ“ è®°å½•æœåŠ¡å™¨ä¸Šä¼ å¤±è´¥:', currentServer)\r\n+      await loadBalancer.recordFailure(currentServer)\r\n+    }\r\n+\r\n     throw new Error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`)\r\n   }\r\n }\r\n \r\n"
                },
                {
                    "date": 1752411390149,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -436,8 +436,16 @@\n     return result[promptId] || null\r\n \r\n   } catch (error) {\r\n     console.error('çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', error)\r\n+\r\n+    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œè®°å½•å¤±è´¥\r\n+    if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('timeout')) {\r\n+      const currentServer = await getApiBaseUrl()\r\n+      console.log('ğŸ“ è®°å½•æœåŠ¡å™¨çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', currentServer)\r\n+      await loadBalancer.recordFailure(currentServer)\r\n+    }\r\n+\r\n     throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${error.message}`)\r\n   }\r\n }\r\n \r\n"
                },
                {
                    "date": 1752411410623,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -560,8 +560,17 @@\n async function processUndressImage(base64Image) {\r\n   try {\r\n     console.log('ğŸš€ å¼€å§‹å¤„ç†æ¢è¡£è¯·æ±‚...')\r\n \r\n+    // é¢„æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€\r\n+    console.log('ğŸ” é¢„æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...')\r\n+    const serverStatus = await checkComfyUIServerStatus()\r\n+    if (serverStatus.status === 'error') {\r\n+      console.warn('âš ï¸ å½“å‰æœåŠ¡å™¨çŠ¶æ€å¼‚å¸¸ï¼Œè§¦å‘é‡æ–°è¯„ä¼°...')\r\n+      // å¼ºåˆ¶é‡æ–°è¯„ä¼°æœåŠ¡å™¨\r\n+      await getApiBaseUrl(true)\r\n+    }\r\n+\r\n     // æ£€æŸ¥ç§¯åˆ†ï¼ˆä¼˜å…ˆä½¿ç”¨ç­‰çº§å¡ç³»ç»Ÿï¼‰\r\n     console.log('ğŸ’ æ£€æŸ¥ç§¯åˆ†...')\r\n     const pointsStatus = await levelCardPointsManager.getPointsStatus()\r\n     if (!pointsStatus.canGenerate) {\r\n"
                },
                {
                    "date": 1752424351055,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -608,14 +608,20 @@\n     console.log('ğŸ“¥ è·å–ç”Ÿæˆçš„å›¾ç‰‡...')\r\n     const resultImage = await getGeneratedImage(taskResult)\r\n     console.log('ğŸ‰ æ¢è¡£å¤„ç†å®Œå…¨æˆåŠŸï¼')\r\n \r\n-    // æ¶ˆè€—ç§¯åˆ†ï¼ˆä»ç­‰çº§å¡æ‰£é™¤ï¼‰\r\n-    console.log('ğŸ’ æ¶ˆè€—ç§¯åˆ†...')\r\n-    // è·å– ComfyUI å›¾ç‰‡è®¿é—®URLè€Œä¸æ˜¯ base64 æ•°æ®\r\n-    const imageViewUrl = getComfyUIImageUrl(resultImage)\r\n-    const pointsResult = await levelCardPointsManager.consumePoints(20, 'ä¸€é”®æ¢è¡£', imageViewUrl)\r\n-    console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ç§¯åˆ†ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n+    // æ¶ˆè€—ç§¯åˆ†ï¼ˆä»ç­‰çº§å¡æ‰£é™¤ï¼‰- ä¸å½±å“ä¸»è¦åŠŸèƒ½\r\n+    let pointsResult = { consumed: 0, remaining: 0 }\r\n+    try {\r\n+      console.log('ğŸ’ æ¶ˆè€—ç§¯åˆ†...')\r\n+      // è·å– ComfyUI å›¾ç‰‡è®¿é—®URLè€Œä¸æ˜¯ base64 æ•°æ®\r\n+      const imageViewUrl = getComfyUIImageUrl(resultImage)\r\n+      pointsResult = await levelCardPointsManager.consumePoints(20, 'ä¸€é”®æ¢è¡£', imageViewUrl)\r\n+      console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ç§¯åˆ†ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n+    } catch (pointsError) {\r\n+      console.warn('âš ï¸ ç§¯åˆ†æ‰£é™¤å¤±è´¥ï¼Œä½†ä¸å½±å“å›¾ç‰‡å¤„ç†ç»“æœ:', pointsError.message)\r\n+      // ç§¯åˆ†æ‰£é™¤å¤±è´¥ä¸å½±å“ä¸»è¦åŠŸèƒ½ï¼Œç»§ç»­è¿”å›å¤„ç†ç»“æœ\r\n+    }\r\n \r\n     // è·å–èŠ‚ç‚¹49çš„åŸå›¾ç”¨äºå¯¹æ¯”\r\n     let originalImage = null\r\n     try {\r\n"
                },
                {
                    "date": 1752424930329,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -608,20 +608,14 @@\n     console.log('ğŸ“¥ è·å–ç”Ÿæˆçš„å›¾ç‰‡...')\r\n     const resultImage = await getGeneratedImage(taskResult)\r\n     console.log('ğŸ‰ æ¢è¡£å¤„ç†å®Œå…¨æˆåŠŸï¼')\r\n \r\n-    // æ¶ˆè€—ç§¯åˆ†ï¼ˆä»ç­‰çº§å¡æ‰£é™¤ï¼‰- ä¸å½±å“ä¸»è¦åŠŸèƒ½\r\n-    let pointsResult = { consumed: 0, remaining: 0 }\r\n-    try {\r\n-      console.log('ğŸ’ æ¶ˆè€—ç§¯åˆ†...')\r\n-      // è·å– ComfyUI å›¾ç‰‡è®¿é—®URLè€Œä¸æ˜¯ base64 æ•°æ®\r\n-      const imageViewUrl = getComfyUIImageUrl(resultImage)\r\n-      pointsResult = await levelCardPointsManager.consumePoints(20, 'ä¸€é”®æ¢è¡£', imageViewUrl)\r\n-      console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ç§¯åˆ†ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n-    } catch (pointsError) {\r\n-      console.warn('âš ï¸ ç§¯åˆ†æ‰£é™¤å¤±è´¥ï¼Œä½†ä¸å½±å“å›¾ç‰‡å¤„ç†ç»“æœ:', pointsError.message)\r\n-      // ç§¯åˆ†æ‰£é™¤å¤±è´¥ä¸å½±å“ä¸»è¦åŠŸèƒ½ï¼Œç»§ç»­è¿”å›å¤„ç†ç»“æœ\r\n-    }\r\n+    // æ¶ˆè€—ç§¯åˆ†ï¼ˆä»ç­‰çº§å¡æ‰£é™¤ï¼‰\r\n+    console.log('ğŸ’ æ¶ˆè€—ç§¯åˆ†...')\r\n+    // è·å– ComfyUI å›¾ç‰‡è®¿é—®URLè€Œä¸æ˜¯ base64 æ•°æ®\r\n+    const imageViewUrl = getComfyUIImageUrl(resultImage)\r\n+    const pointsResult = await levelCardPointsManager.consumePoints(20, 'ä¸€é”®æ¢è¡£', imageViewUrl)\r\n+    console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ç§¯åˆ†ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n \r\n     // è·å–èŠ‚ç‚¹49çš„åŸå›¾ç”¨äºå¯¹æ¯”\r\n     let originalImage = null\r\n     try {\r\n"
                },
                {
                    "date": 1752433200356,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -313,9 +313,16 @@\n     // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œè®°å½•å¤±è´¥å¹¶å¯èƒ½è§¦å‘é‡æ–°è¯„ä¼°\r\n     if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('timeout')) {\r\n       const currentServer = await getApiBaseUrl()\r\n       console.log('ğŸ“ è®°å½•æœåŠ¡å™¨ä¸Šä¼ å¤±è´¥:', currentServer)\r\n-      await loadBalancer.recordFailure(currentServer)\r\n+\r\n+      // ç¡®å®šé”™è¯¯ç±»å‹\r\n+      let errorType = 'upload_error'\r\n+      if (error.message.includes('timeout')) errorType = 'timeout'\r\n+      else if (error.message.includes('network')) errorType = 'network'\r\n+      else if (error.message.includes('fetch')) errorType = 'connection'\r\n+\r\n+      await loadBalancer.recordFailure(currentServer, errorType)\r\n     }\r\n \r\n     throw new Error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`)\r\n   }\r\n"
                },
                {
                    "date": 1752433216313,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -419,9 +419,17 @@\n \r\n     // è®°å½•æœåŠ¡å™¨å¤±è´¥\r\n     if (selectedServer) {\r\n       console.log('ğŸ“ è®°å½•æœåŠ¡å™¨å¤±è´¥:', selectedServer)\r\n-      await loadBalancer.recordFailure(selectedServer)\r\n+\r\n+      // ç¡®å®šé”™è¯¯ç±»å‹\r\n+      let errorType = 'workflow_error'\r\n+      if (error.message.includes('timeout')) errorType = 'timeout'\r\n+      else if (error.message.includes('network')) errorType = 'network'\r\n+      else if (error.message.includes('fetch')) errorType = 'connection'\r\n+      else if (error.message.includes('500') || error.message.includes('502') || error.message.includes('503')) errorType = 'server_error'\r\n+\r\n+      await loadBalancer.recordFailure(selectedServer, errorType)\r\n     }\r\n \r\n     throw new Error(`å·¥ä½œæµæäº¤å¤±è´¥: ${error.message}`)\r\n   }\r\n"
                },
                {
                    "date": 1752433232169,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -456,9 +456,16 @@\n     // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œè®°å½•å¤±è´¥\r\n     if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('timeout')) {\r\n       const currentServer = await getApiBaseUrl()\r\n       console.log('ğŸ“ è®°å½•æœåŠ¡å™¨çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', currentServer)\r\n-      await loadBalancer.recordFailure(currentServer)\r\n+\r\n+      // ç¡®å®šé”™è¯¯ç±»å‹\r\n+      let errorType = 'status_check_error'\r\n+      if (error.message.includes('timeout')) errorType = 'timeout'\r\n+      else if (error.message.includes('network')) errorType = 'network'\r\n+      else if (error.message.includes('fetch')) errorType = 'connection'\r\n+\r\n+      await loadBalancer.recordFailure(currentServer, errorType)\r\n     }\r\n \r\n     throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${error.message}`)\r\n   }\r\n"
                },
                {
                    "date": 1752433338914,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -194,18 +194,25 @@\n   return getComfyUIConfig(forceRefresh)\r\n }\r\n \r\n // è·å–APIåŸºç¡€URL - ä½¿ç”¨è´Ÿè½½å‡è¡¡\r\n-async function getApiBaseUrl(forceReassessment = false) {\r\n+async function getApiBaseUrl(forceReassessment = false, excludeUrls = []) {\r\n   try {\r\n     // å¦‚æœéœ€è¦å¼ºåˆ¶é‡æ–°è¯„ä¼°ï¼Œè§¦å‘è´Ÿè½½å‡è¡¡å™¨é‡æ–°è¯„ä¼°\r\n     if (forceReassessment) {\r\n       console.log('ğŸ”„ å¼ºåˆ¶é‡æ–°è¯„ä¼°æœåŠ¡å™¨...')\r\n       await loadBalancer.forceReassessment()\r\n     }\r\n \r\n     // ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\r\n-    const optimalServer = await loadBalancer.getOptimalServer()\r\n+    let optimalServer\r\n+    if (excludeUrls.length > 0) {\r\n+      console.log('ğŸ”„ è·å–ä¸‹ä¸€ä¸ªå¯ç”¨æœåŠ¡å™¨ï¼Œæ’é™¤:', excludeUrls)\r\n+      optimalServer = await loadBalancer.getNextAvailableServer(excludeUrls)\r\n+    } else {\r\n+      optimalServer = await loadBalancer.getOptimalServer()\r\n+    }\r\n+\r\n     console.log('ğŸ¯ è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœåŠ¡å™¨:', optimalServer)\r\n \r\n     // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n     let baseUrl = optimalServer\r\n@@ -228,8 +235,54 @@\n     return baseUrl\r\n   }\r\n }\r\n \r\n+// å¸¦é‡è¯•çš„APIè°ƒç”¨åŒ…è£…å™¨\r\n+async function callWithRetry(apiCall, maxRetries = 2, excludeUrls = []) {\r\n+  let lastError = null\r\n+\r\n+  for (let attempt = 0; attempt <= maxRetries; attempt++) {\r\n+    try {\r\n+      const result = await apiCall()\r\n+      return result\r\n+    } catch (error) {\r\n+      lastError = error\r\n+      console.warn(`âš ï¸ APIè°ƒç”¨å¤±è´¥ (å°è¯• ${attempt + 1}/${maxRetries + 1}):`, error.message)\r\n+\r\n+      // å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œä¸”æ˜¯ç½‘ç»œç›¸å…³é”™è¯¯ï¼Œå°è¯•ä¸‹ä¸€ä¸ªæœåŠ¡å™¨\r\n+      if (attempt < maxRetries &&\r\n+          (error.message.includes('fetch') ||\r\n+           error.message.includes('network') ||\r\n+           error.message.includes('timeout') ||\r\n+           error.message.includes('500') ||\r\n+           error.message.includes('502') ||\r\n+           error.message.includes('503'))) {\r\n+\r\n+        // è·å–å½“å‰å¤±è´¥çš„æœåŠ¡å™¨URL\r\n+        const currentServer = await getApiBaseUrl()\r\n+        if (currentServer) {\r\n+          excludeUrls.push(currentServer)\r\n+          console.log(`ğŸ”„ æ·»åŠ å¤±è´¥æœåŠ¡å™¨åˆ°æ’é™¤åˆ—è¡¨: ${currentServer}`)\r\n+\r\n+          // è®°å½•å¤±è´¥\r\n+          let errorType = 'api_error'\r\n+          if (error.message.includes('timeout')) errorType = 'timeout'\r\n+          else if (error.message.includes('network')) errorType = 'network'\r\n+          else if (error.message.includes('fetch')) errorType = 'connection'\r\n+          else if (error.message.includes('500') || error.message.includes('502') || error.message.includes('503')) errorType = 'server_error'\r\n+\r\n+          await loadBalancer.recordFailure(currentServer, errorType)\r\n+        }\r\n+\r\n+        // ç­‰å¾…ä¸€æ®µæ—¶é—´å†é‡è¯•\r\n+        await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)))\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  throw lastError\r\n+}\r\n+\r\n // é‡ç½®ä¸ºé»˜è®¤é…ç½®\r\n function resetToDefaultConfig() {\r\n   localStorage.removeItem('comfyui_config')\r\n   return { ...DEFAULT_CONFIG }\r\n"
                },
                {
                    "date": 1752462837261,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -607,29 +607,269 @@\n     throw new Error(`å›¾ç‰‡è·å–å¤±è´¥: ${error.message}`)\r\n   }\r\n }\r\n \r\n-// ç­‰å¾…ä»»åŠ¡å®Œæˆ\r\n+// WebSocket è¿æ¥ç®¡ç†\r\n+let wsConnection = null\r\n+let wsReconnectTimer = null\r\n+let isWsConnected = false\r\n+let wsMessageHandlers = new Map()\r\n+let pendingTasks = new Map()\r\n+\r\n+// åˆå§‹åŒ– WebSocket è¿æ¥\r\n+async function initializeWebSocket() {\r\n+  try {\r\n+    if (wsConnection && wsConnection.readyState === WebSocket.OPEN) {\r\n+      console.log('WebSocket å·²è¿æ¥ï¼Œæ— éœ€é‡æ–°åˆå§‹åŒ–')\r\n+      return true\r\n+    }\r\n+\r\n+    const config = getComfyUIConfig()\r\n+    const baseUrl = await getApiBaseUrl()\r\n+    const wsUrl = baseUrl.replace(/^http/, 'ws') + '/ws?clientId=' + config.CLIENT_ID\r\n+\r\n+    console.log(`ğŸ”Œ è¿æ¥ ComfyUI WebSocket: ${wsUrl}`)\r\n+\r\n+    wsConnection = new WebSocket(wsUrl)\r\n+\r\n+    return new Promise((resolve, reject) => {\r\n+      const timeout = setTimeout(() => {\r\n+        reject(new Error('WebSocket è¿æ¥è¶…æ—¶'))\r\n+      }, 10000)\r\n+\r\n+      wsConnection.onopen = () => {\r\n+        console.log('âœ… ComfyUI WebSocket è¿æ¥æˆåŠŸ')\r\n+        isWsConnected = true\r\n+        clearTimeout(timeout)\r\n+        clearTimeout(wsReconnectTimer)\r\n+        resolve(true)\r\n+      }\r\n+\r\n+      wsConnection.onclose = (event) => {\r\n+        console.log(`âŒ ComfyUI WebSocket è¿æ¥å…³é—­: ${event.code} ${event.reason}`)\r\n+        isWsConnected = false\r\n+        clearTimeout(timeout)\r\n+\r\n+        // å°è¯•é‡æ–°è¿æ¥\r\n+        if (!wsReconnectTimer) {\r\n+          wsReconnectTimer = setTimeout(() => {\r\n+            wsReconnectTimer = null\r\n+            console.log('ğŸ”„ å°è¯•é‡æ–°è¿æ¥ ComfyUI WebSocket...')\r\n+            initializeWebSocket().catch(error => {\r\n+              console.error('âŒ WebSocket é‡è¿å¤±è´¥:', error)\r\n+            })\r\n+          }, 5000)\r\n+        }\r\n+      }\r\n+\r\n+      wsConnection.onerror = (error) => {\r\n+        console.error('âŒ ComfyUI WebSocket é”™è¯¯:', error)\r\n+        clearTimeout(timeout)\r\n+        reject(error)\r\n+      }\r\n+\r\n+      wsConnection.onmessage = (event) => {\r\n+        try {\r\n+          const message = JSON.parse(event.data)\r\n+          handleWebSocketMessage(message)\r\n+        } catch (error) {\r\n+          console.error('âŒ è§£æ WebSocket æ¶ˆæ¯å¤±è´¥:', error, event.data)\r\n+        }\r\n+      }\r\n+    })\r\n+  } catch (error) {\r\n+    console.error('âŒ åˆå§‹åŒ– WebSocket å¤±è´¥:', error)\r\n+    throw error\r\n+  }\r\n+}\r\n+\r\n+// å¤„ç† WebSocket æ¶ˆæ¯\r\n+function handleWebSocketMessage(message) {\r\n+  try {\r\n+    const { type, data } = message\r\n+\r\n+    console.log(`ğŸ“¨ æ”¶åˆ° WebSocket æ¶ˆæ¯: ${type}`, data)\r\n+\r\n+    switch (type) {\r\n+      case 'status':\r\n+        handleStatusMessage(data)\r\n+        break\r\n+      case 'progress':\r\n+        handleProgressMessage(data)\r\n+        break\r\n+      case 'executed':\r\n+        handleExecutedMessage(data)\r\n+        break\r\n+      case 'execution_error':\r\n+        handleExecutionErrorMessage(data)\r\n+        break\r\n+      case 'executing':\r\n+        handleExecutingMessage(data)\r\n+        break\r\n+      default:\r\n+        console.log(`ğŸ” æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹: ${type}`, data)\r\n+    }\r\n+\r\n+    // è§¦å‘æ³¨å†Œçš„æ¶ˆæ¯å¤„ç†å™¨\r\n+    if (wsMessageHandlers.has(type)) {\r\n+      wsMessageHandlers.get(type).forEach(handler => {\r\n+        try {\r\n+          handler(data)\r\n+        } catch (error) {\r\n+          console.error(`âŒ å¤„ç† ${type} æ¶ˆæ¯æ—¶å‡ºé”™:`, error)\r\n+        }\r\n+      })\r\n+    }\r\n+  } catch (error) {\r\n+    console.error('âŒ å¤„ç† WebSocket æ¶ˆæ¯å¤±è´¥:', error)\r\n+  }\r\n+}\r\n+\r\n+// å¤„ç†çŠ¶æ€æ¶ˆæ¯\r\n+function handleStatusMessage(data) {\r\n+  if (data && data.sid) {\r\n+    console.log(`ğŸ“Š é˜Ÿåˆ—çŠ¶æ€æ›´æ–°: æ‰§è¡Œä¸­=${data.status?.exec_info?.queue_remaining || 0}`)\r\n+  }\r\n+}\r\n+\r\n+// å¤„ç†è¿›åº¦æ¶ˆæ¯\r\n+function handleProgressMessage(data) {\r\n+  if (data && data.prompt_id) {\r\n+    const task = pendingTasks.get(data.prompt_id)\r\n+    if (task && task.onProgress) {\r\n+      const progress = Math.round((data.value / data.max) * 100)\r\n+      console.log(`ğŸ“ˆ ä»»åŠ¡ ${data.prompt_id} è¿›åº¦: ${progress}%`)\r\n+      task.onProgress(progress, 'processing')\r\n+    }\r\n+  }\r\n+}\r\n+\r\n+// å¤„ç†æ‰§è¡Œå®Œæˆæ¶ˆæ¯\r\n+function handleExecutedMessage(data) {\r\n+  if (data && data.prompt_id) {\r\n+    const task = pendingTasks.get(data.prompt_id)\r\n+    if (task) {\r\n+      console.log(`âœ… ä»»åŠ¡ ${data.prompt_id} æ‰§è¡Œå®Œæˆ`)\r\n+\r\n+      // è·å–å®Œæ•´çš„å†å²è®°å½•\r\n+      checkTaskStatus(data.prompt_id).then(result => {\r\n+        if (task.onComplete) {\r\n+          task.onComplete(result)\r\n+        }\r\n+        pendingTasks.delete(data.prompt_id)\r\n+      }).catch(error => {\r\n+        console.error('âŒ è·å–ä»»åŠ¡ç»“æœå¤±è´¥:', error)\r\n+        if (task.onError) {\r\n+          task.onError(error.message)\r\n+        }\r\n+        pendingTasks.delete(data.prompt_id)\r\n+      })\r\n+    }\r\n+  }\r\n+}\r\n+\r\n+// å¤„ç†æ‰§è¡Œé”™è¯¯æ¶ˆæ¯\r\n+function handleExecutionErrorMessage(data) {\r\n+  if (data && data.prompt_id) {\r\n+    const task = pendingTasks.get(data.prompt_id)\r\n+    if (task) {\r\n+      console.error(`âŒ ä»»åŠ¡ ${data.prompt_id} æ‰§è¡Œå¤±è´¥:`, data)\r\n+      if (task.onError) {\r\n+        task.onError(data.exception_message || data.traceback || 'ä»»åŠ¡æ‰§è¡Œå¤±è´¥')\r\n+      }\r\n+      pendingTasks.delete(data.prompt_id)\r\n+    }\r\n+  }\r\n+}\r\n+\r\n+// å¤„ç†æ­£åœ¨æ‰§è¡Œæ¶ˆæ¯\r\n+function handleExecutingMessage(data) {\r\n+  if (data && data.prompt_id) {\r\n+    const task = pendingTasks.get(data.prompt_id)\r\n+    if (task && task.onProgress) {\r\n+      console.log(`ğŸ”„ ä»»åŠ¡ ${data.prompt_id} æ­£åœ¨æ‰§è¡ŒèŠ‚ç‚¹: ${data.node}`)\r\n+      task.onProgress(10, 'executing')\r\n+    }\r\n+  }\r\n+}\r\n+\r\n+// ç­‰å¾…ä»»åŠ¡å®Œæˆ - ä½¿ç”¨ WebSocket\r\n async function waitForTaskCompletion(promptId, maxWaitTime = 300000) {\r\n+  console.log(`â³ ç­‰å¾…ä»»åŠ¡å®Œæˆ: ${promptId}`)\r\n+\r\n+  // ç¡®ä¿ WebSocket è¿æ¥\r\n+  await initializeWebSocket()\r\n+\r\n+  return new Promise((resolve, reject) => {\r\n+    // è®¾ç½®è¶…æ—¶\r\n+    const timeout = setTimeout(() => {\r\n+      pendingTasks.delete(promptId)\r\n+      reject(new Error(`ä»»åŠ¡ ${promptId} æ‰§è¡Œè¶…æ—¶`))\r\n+    }, maxWaitTime)\r\n+\r\n+    // åˆ›å»ºä»»åŠ¡è·Ÿè¸ªå¯¹è±¡\r\n+    const task = {\r\n+      id: promptId,\r\n+      onProgress: (progress, status) => {\r\n+        console.log(`ğŸ“ˆ ä»»åŠ¡ ${promptId} è¿›åº¦: ${progress}% (${status})`)\r\n+      },\r\n+      onComplete: (result) => {\r\n+        clearTimeout(timeout)\r\n+        console.log(`âœ… ä»»åŠ¡ ${promptId} å®Œæˆ`)\r\n+        resolve(result)\r\n+      },\r\n+      onError: (error) => {\r\n+        clearTimeout(timeout)\r\n+        console.error(`âŒ ä»»åŠ¡ ${promptId} å¤±è´¥:`, error)\r\n+        reject(new Error(error))\r\n+      }\r\n+    }\r\n+\r\n+    // æ³¨å†Œä»»åŠ¡\r\n+    pendingTasks.set(promptId, task)\r\n+\r\n+    // å¦‚æœ WebSocket æœªè¿æ¥ï¼Œå›é€€åˆ°è½®è¯¢æ¨¡å¼\r\n+    if (!isWsConnected) {\r\n+      console.log('âš ï¸ WebSocket æœªè¿æ¥ï¼Œä½¿ç”¨è½®è¯¢æ¨¡å¼')\r\n+      fallbackToPolling(promptId, task, timeout)\r\n+    }\r\n+  })\r\n+}\r\n+\r\n+// å›é€€åˆ°è½®è¯¢æ¨¡å¼\r\n+async function fallbackToPolling(promptId, task, timeout) {\r\n+  const pollInterval = 2000\r\n   const startTime = Date.now()\r\n-  const pollInterval = 2000 // 2ç§’è½®è¯¢ä¸€æ¬¡\r\n \r\n-  while (Date.now() - startTime < maxWaitTime) {\r\n-    const taskResult = await checkTaskStatus(promptId)\r\n+  const poll = async () => {\r\n+    try {\r\n+      if (Date.now() - startTime > 300000) { // 5åˆ†é’Ÿè¶…æ—¶\r\n+        return\r\n+      }\r\n \r\n-    if (taskResult) {\r\n-      if (taskResult.status && taskResult.status.completed) {\r\n-        return taskResult\r\n-      } else if (taskResult.status && taskResult.status.status_str === 'error') {\r\n-        throw new Error(`ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${JSON.stringify(taskResult.status)}`)\r\n+      const result = await checkTaskStatus(promptId)\r\n+\r\n+      if (result) {\r\n+        if (result.status && result.status.completed) {\r\n+          clearTimeout(timeout)\r\n+          task.onComplete(result)\r\n+          return\r\n+        } else if (result.status && result.status.status_str === 'error') {\r\n+          clearTimeout(timeout)\r\n+          task.onError(`ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${result.status.status_str}`)\r\n+          return\r\n+        }\r\n       }\r\n+\r\n+      // ç»§ç»­è½®è¯¢\r\n+      setTimeout(poll, pollInterval)\r\n+    } catch (error) {\r\n+      console.error('âŒ è½®è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error)\r\n+      setTimeout(poll, pollInterval)\r\n     }\r\n-\r\n-    // ç­‰å¾…ä¸‹æ¬¡è½®è¯¢\r\n-    await new Promise(resolve => setTimeout(resolve, pollInterval))\r\n   }\r\n \r\n-  throw new Error('ä»»åŠ¡æ‰§è¡Œè¶…æ—¶')\r\n+  poll()\r\n }\r\n \r\n // ä¸»è¦çš„æ¢è¡£APIå‡½æ•° - ä¸¤æ­¥æµç¨‹\r\n async function processUndressImage(base64Image) {\r\n"
                },
                {
                    "date": 1752462898147,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -414,14 +414,18 @@\n // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n async function submitWorkflow(workflowPrompt) {\r\n   let selectedServer = null\r\n   try {\r\n+    // ç¡®ä¿ WebSocket è¿æ¥\r\n+    await initializeWebSocket()\r\n+\r\n     const config = getComfyUIConfig()\r\n     const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n     selectedServer = apiBaseUrl // è®°å½•é€‰æ‹©çš„æœåŠ¡å™¨\r\n     console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n     console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n     console.log('ğŸ”§ ä½¿ç”¨è´Ÿè½½å‡è¡¡:', 'æ˜¯')\r\n+    console.log('ğŸ”Œ WebSocketçŠ¶æ€:', isWsConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥')\r\n \r\n     // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n     const requestBody = {\r\n       client_id: config.CLIENT_ID,\r\n"
                },
                {
                    "date": 1752462927197,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1150,6 +1150,9 @@\n   getApiBaseUrl,\r\n   addConfigChangeListener,\r\n   removeConfigChangeListener,\r\n   processUndressImage,\r\n-  processFaceSwapImage\r\n+  processFaceSwapImage,\r\n+  initializeWebSocket,\r\n+  wsConnection,\r\n+  isWsConnected\r\n }\r\n"
                },
                {
                    "date": 1752463049368,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -795,10 +795,10 @@\n     }\r\n   }\r\n }\r\n \r\n-// ç­‰å¾…ä»»åŠ¡å®Œæˆ - ä½¿ç”¨ WebSocket\r\n-async function waitForTaskCompletion(promptId, maxWaitTime = 300000) {\r\n+// ç­‰å¾…ä»»åŠ¡å®Œæˆ - ä½¿ç”¨ WebSocketï¼Œæ”¯æŒè¿›åº¦å›è°ƒ\r\n+async function waitForTaskCompletion(promptId, maxWaitTime = 300000, onProgress = null) {\r\n   console.log(`â³ ç­‰å¾…ä»»åŠ¡å®Œæˆ: ${promptId}`)\r\n \r\n   // ç¡®ä¿ WebSocket è¿æ¥\r\n   await initializeWebSocket()\r\n@@ -814,17 +814,27 @@\n     const task = {\r\n       id: promptId,\r\n       onProgress: (progress, status) => {\r\n         console.log(`ğŸ“ˆ ä»»åŠ¡ ${promptId} è¿›åº¦: ${progress}% (${status})`)\r\n+        // è°ƒç”¨å¤–éƒ¨è¿›åº¦å›è°ƒ\r\n+        if (onProgress) {\r\n+          onProgress(`æ­£åœ¨å¤„ç†: ${status}`, progress)\r\n+        }\r\n       },\r\n       onComplete: (result) => {\r\n         clearTimeout(timeout)\r\n         console.log(`âœ… ä»»åŠ¡ ${promptId} å®Œæˆ`)\r\n+        if (onProgress) {\r\n+          onProgress('å¤„ç†å®Œæˆ', 100)\r\n+        }\r\n         resolve(result)\r\n       },\r\n       onError: (error) => {\r\n         clearTimeout(timeout)\r\n         console.error(`âŒ ä»»åŠ¡ ${promptId} å¤±è´¥:`, error)\r\n+        if (onProgress) {\r\n+          onProgress('å¤„ç†å¤±è´¥', 0)\r\n+        }\r\n         reject(new Error(error))\r\n       }\r\n     }\r\n \r\n"
                },
                {
                    "date": 1752463068283,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -929,9 +929,11 @@\n     console.log('âœ… ç¬¬äºŒæ­¥å®Œæˆï¼Œè·å¾—ä»»åŠ¡ID:', promptId)\r\n \r\n     // ç­‰å¾…ä»»åŠ¡å®Œæˆ\r\n     console.log('â³ ç­‰å¾…ComfyUIå¤„ç†ä»»åŠ¡...')\r\n-    const taskResult = await waitForTaskCompletion(promptId)\r\n+    const taskResult = await waitForTaskCompletion(promptId, 300000, (status, progress) => {\r\n+      console.log(`ğŸ“Š ä»»åŠ¡è¿›åº¦: ${status} - ${progress}%`)\r\n+    })\r\n     console.log('âœ… ä»»åŠ¡å¤„ç†å®Œæˆ')\r\n \r\n     // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n     console.log('ğŸ“¥ è·å–ç”Ÿæˆçš„å›¾ç‰‡...')\r\n"
                },
                {
                    "date": 1752463087783,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1109,9 +1109,9 @@\n     // ç­‰å¾…ä»»åŠ¡å®Œæˆ - æ¢è„¸éœ€è¦æ›´é•¿æ—¶é—´ï¼Œè®¾ç½®10åˆ†é’Ÿè¶…æ—¶\r\n     const maxWaitTime = 600000 // 10åˆ†é’Ÿ\r\n     console.log(`â³ å¼€å§‹ç­‰å¾…æ¢è„¸ä»»åŠ¡å®Œæˆï¼Œä»»åŠ¡ID: ${promptId}ï¼Œæœ€å¤§ç­‰å¾…æ—¶é—´: ${maxWaitTime/1000}ç§’`)\r\n \r\n-    const taskResult = await waitForTaskCompletion(promptId, maxWaitTime)\r\n+    const taskResult = await waitForTaskCompletion(promptId, maxWaitTime, onProgress)\r\n     console.log('âœ… æ¢è„¸ä»»åŠ¡å¤„ç†å®Œæˆï¼Œç»“æœ:', taskResult)\r\n \r\n     if (onProgress) onProgress('æ­£åœ¨è·å–å¤„ç†ç»“æœ...', 95)\r\n \r\n"
                },
                {
                    "date": 1752463551874,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -710,8 +710,16 @@\n         handleExecutingMessage(data)\r\n         break\r\n       default:\r\n         console.log(`ğŸ” æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹: ${type}`, data)\r\n+        // å¯¹äºæœªçŸ¥æ¶ˆæ¯ç±»å‹ï¼Œä¹Ÿå°è¯•å¤„ç† prompt_id\r\n+        if (data && data.prompt_id) {\r\n+          console.log(`ğŸ” æ£€æŸ¥æœªçŸ¥æ¶ˆæ¯ç±»å‹æ˜¯å¦åŒ…å«ä»»åŠ¡å®Œæˆä¿¡æ¯: ${type}`)\r\n+          // å¯èƒ½æ˜¯ä»»åŠ¡å®Œæˆçš„æ¶ˆæ¯ï¼Œå°è¯•ä½œä¸ºæ‰§è¡Œå®Œæˆå¤„ç†\r\n+          if (type === 'execution_cached' || type === 'execution_success') {\r\n+            handleExecutedMessage(data)\r\n+          }\r\n+        }\r\n     }\r\n \r\n     // è§¦å‘æ³¨å†Œçš„æ¶ˆæ¯å¤„ç†å™¨\r\n     if (wsMessageHandlers.has(type)) {\r\n"
                },
                {
                    "date": 1752463576688,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -756,27 +756,48 @@\n }\r\n \r\n // å¤„ç†æ‰§è¡Œå®Œæˆæ¶ˆæ¯\r\n function handleExecutedMessage(data) {\r\n+  console.log(`ğŸ¯ å¤„ç†æ‰§è¡Œå®Œæˆæ¶ˆæ¯:`, data)\r\n+\r\n   if (data && data.prompt_id) {\r\n     const task = pendingTasks.get(data.prompt_id)\r\n     if (task) {\r\n-      console.log(`âœ… ä»»åŠ¡ ${data.prompt_id} æ‰§è¡Œå®Œæˆ`)\r\n+      console.log(`âœ… ä»»åŠ¡ ${data.prompt_id} æ‰§è¡Œå®Œæˆï¼Œå¼€å§‹è·å–ç»“æœ`)\r\n \r\n-      // è·å–å®Œæ•´çš„å†å²è®°å½•\r\n-      checkTaskStatus(data.prompt_id).then(result => {\r\n-        if (task.onComplete) {\r\n-          task.onComplete(result)\r\n+      // å»¶è¿Ÿä¸€ä¸‹å†è·å–ç»“æœï¼Œç¡®ä¿ ComfyUI å·²ç»å®Œå…¨å¤„ç†å®Œæˆ\r\n+      setTimeout(async () => {\r\n+        try {\r\n+          console.log(`ğŸ” è·å–ä»»åŠ¡ ${data.prompt_id} çš„å®Œæ•´å†å²è®°å½•`)\r\n+          const result = await checkTaskStatus(data.prompt_id)\r\n+\r\n+          if (result && result[data.prompt_id]) {\r\n+            console.log(`ğŸ“‹ ä»»åŠ¡ ${data.prompt_id} ç»“æœ:`, result[data.prompt_id])\r\n+\r\n+            if (task.onComplete) {\r\n+              task.onComplete(result[data.prompt_id])\r\n+            }\r\n+          } else {\r\n+            console.warn(`âš ï¸ ä»»åŠ¡ ${data.prompt_id} ç»“æœä¸ºç©ºï¼Œå°è¯•ç›´æ¥ä½¿ç”¨ WebSocket æ•°æ®`)\r\n+            if (task.onComplete) {\r\n+              task.onComplete(data)\r\n+            }\r\n+          }\r\n+\r\n+          pendingTasks.delete(data.prompt_id)\r\n+        } catch (error) {\r\n+          console.error(`âŒ è·å–ä»»åŠ¡ ${data.prompt_id} ç»“æœå¤±è´¥:`, error)\r\n+          if (task.onError) {\r\n+            task.onError(error.message)\r\n+          }\r\n+          pendingTasks.delete(data.prompt_id)\r\n         }\r\n-        pendingTasks.delete(data.prompt_id)\r\n-      }).catch(error => {\r\n-        console.error('âŒ è·å–ä»»åŠ¡ç»“æœå¤±è´¥:', error)\r\n-        if (task.onError) {\r\n-          task.onError(error.message)\r\n-        }\r\n-        pendingTasks.delete(data.prompt_id)\r\n-      })\r\n+      }, 1000) // å»¶è¿Ÿ 1 ç§’\r\n+    } else {\r\n+      console.warn(`âš ï¸ æ”¶åˆ°æœªè·Ÿè¸ªä»»åŠ¡çš„å®Œæˆæ¶ˆæ¯: ${data.prompt_id}`)\r\n     }\r\n+  } else {\r\n+    console.warn(`âš ï¸ æ‰§è¡Œå®Œæˆæ¶ˆæ¯ç¼ºå°‘ prompt_id:`, data)\r\n   }\r\n }\r\n \r\n // å¤„ç†æ‰§è¡Œé”™è¯¯æ¶ˆæ¯\r\n"
                },
                {
                    "date": 1752463597334,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -672,9 +672,11 @@\n       }\r\n \r\n       wsConnection.onmessage = (event) => {\r\n         try {\r\n+          console.log(`ğŸ“¨ åŸå§‹ WebSocket æ¶ˆæ¯:`, event.data)\r\n           const message = JSON.parse(event.data)\r\n+          console.log(`ğŸ“¨ è§£æåçš„ WebSocket æ¶ˆæ¯:`, message)\r\n           handleWebSocketMessage(message)\r\n         } catch (error) {\r\n           console.error('âŒ è§£æ WebSocket æ¶ˆæ¯å¤±è´¥:', error, event.data)\r\n         }\r\n"
                },
                {
                    "date": 1752463614776,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -870,13 +870,17 @@\n     }\r\n \r\n     // æ³¨å†Œä»»åŠ¡\r\n     pendingTasks.set(promptId, task)\r\n+    console.log(`ğŸ“ å·²æ³¨å†Œä»»åŠ¡ ${promptId}ï¼Œå½“å‰å¾…å¤„ç†ä»»åŠ¡æ•°: ${pendingTasks.size}`)\r\n+    console.log(`ğŸ”Œ WebSocket è¿æ¥çŠ¶æ€: ${isWsConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}`)\r\n \r\n     // å¦‚æœ WebSocket æœªè¿æ¥ï¼Œå›é€€åˆ°è½®è¯¢æ¨¡å¼\r\n     if (!isWsConnected) {\r\n       console.log('âš ï¸ WebSocket æœªè¿æ¥ï¼Œä½¿ç”¨è½®è¯¢æ¨¡å¼')\r\n       fallbackToPolling(promptId, task, timeout)\r\n+    } else {\r\n+      console.log(`âœ… ä½¿ç”¨ WebSocket æ¨¡å¼ç­‰å¾…ä»»åŠ¡ ${promptId} å®Œæˆ`)\r\n     }\r\n   })\r\n }\r\n \r\n"
                },
                {
                    "date": 1752463668612,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,8 +5,9 @@\n import pointsManager from '../utils/pointsManager.js'\r\n import levelCardPointsManager from '../utils/levelCardPointsManager.js'\r\n import { updateAPIConfig } from './api.js'\r\n import loadBalancer from './loadBalancer.js'\r\n+import { logWebSocketMessage, logConnectionEvent } from '../utils/websocketDebugger.js'\r\n \r\n // APIé…ç½® - ç›´è¿æ¨¡å¼\r\n const DEFAULT_CONFIG = {\r\n   // ComfyUIæœåŠ¡å™¨URLï¼ˆç”¨æˆ·å¯é…ç½®ï¼‰\r\n"
                },
                {
                    "date": 1752463688480,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -645,8 +645,9 @@\n         console.log('âœ… ComfyUI WebSocket è¿æ¥æˆåŠŸ')\r\n         isWsConnected = true\r\n         clearTimeout(timeout)\r\n         clearTimeout(wsReconnectTimer)\r\n+        logConnectionEvent('connected', { url: wsUrl })\r\n         resolve(true)\r\n       }\r\n \r\n       wsConnection.onclose = (event) => {\r\n"
                },
                {
                    "date": 1752463711374,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -653,16 +653,19 @@\n       wsConnection.onclose = (event) => {\r\n         console.log(`âŒ ComfyUI WebSocket è¿æ¥å…³é—­: ${event.code} ${event.reason}`)\r\n         isWsConnected = false\r\n         clearTimeout(timeout)\r\n+        logConnectionEvent('disconnected', { code: event.code, reason: event.reason })\r\n \r\n         // å°è¯•é‡æ–°è¿æ¥\r\n         if (!wsReconnectTimer) {\r\n           wsReconnectTimer = setTimeout(() => {\r\n             wsReconnectTimer = null\r\n             console.log('ğŸ”„ å°è¯•é‡æ–°è¿æ¥ ComfyUI WebSocket...')\r\n+            logConnectionEvent('reconnecting')\r\n             initializeWebSocket().catch(error => {\r\n               console.error('âŒ WebSocket é‡è¿å¤±è´¥:', error)\r\n+              logConnectionEvent('reconnect_failed', { error: error.message })\r\n             })\r\n           }, 5000)\r\n         }\r\n       }\r\n"
                },
                {
                    "date": 1752463732089,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -680,11 +680,16 @@\n         try {\r\n           console.log(`ğŸ“¨ åŸå§‹ WebSocket æ¶ˆæ¯:`, event.data)\r\n           const message = JSON.parse(event.data)\r\n           console.log(`ğŸ“¨ è§£æåçš„ WebSocket æ¶ˆæ¯:`, message)\r\n+\r\n+          // è®°å½•æ¶ˆæ¯åˆ°è°ƒè¯•å™¨\r\n+          logWebSocketMessage(message.type || 'unknown', message.data || message, 'received')\r\n+\r\n           handleWebSocketMessage(message)\r\n         } catch (error) {\r\n           console.error('âŒ è§£æ WebSocket æ¶ˆæ¯å¤±è´¥:', error, event.data)\r\n+          logWebSocketMessage('parse_error', { error: error.message, rawData: event.data }, 'error')\r\n         }\r\n       }\r\n     })\r\n   } catch (error) {\r\n"
                },
                {
                    "date": 1752464153115,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,9 +5,8 @@\n import pointsManager from '../utils/pointsManager.js'\r\n import levelCardPointsManager from '../utils/levelCardPointsManager.js'\r\n import { updateAPIConfig } from './api.js'\r\n import loadBalancer from './loadBalancer.js'\r\n-import { logWebSocketMessage, logConnectionEvent } from '../utils/websocketDebugger.js'\r\n \r\n // APIé…ç½® - ç›´è¿æ¨¡å¼\r\n const DEFAULT_CONFIG = {\r\n   // ComfyUIæœåŠ¡å™¨URLï¼ˆç”¨æˆ·å¯é…ç½®ï¼‰\r\n@@ -645,27 +644,23 @@\n         console.log('âœ… ComfyUI WebSocket è¿æ¥æˆåŠŸ')\r\n         isWsConnected = true\r\n         clearTimeout(timeout)\r\n         clearTimeout(wsReconnectTimer)\r\n-        logConnectionEvent('connected', { url: wsUrl })\r\n         resolve(true)\r\n       }\r\n \r\n       wsConnection.onclose = (event) => {\r\n         console.log(`âŒ ComfyUI WebSocket è¿æ¥å…³é—­: ${event.code} ${event.reason}`)\r\n         isWsConnected = false\r\n         clearTimeout(timeout)\r\n-        logConnectionEvent('disconnected', { code: event.code, reason: event.reason })\r\n \r\n         // å°è¯•é‡æ–°è¿æ¥\r\n         if (!wsReconnectTimer) {\r\n           wsReconnectTimer = setTimeout(() => {\r\n             wsReconnectTimer = null\r\n             console.log('ğŸ”„ å°è¯•é‡æ–°è¿æ¥ ComfyUI WebSocket...')\r\n-            logConnectionEvent('reconnecting')\r\n             initializeWebSocket().catch(error => {\r\n               console.error('âŒ WebSocket é‡è¿å¤±è´¥:', error)\r\n-              logConnectionEvent('reconnect_failed', { error: error.message })\r\n             })\r\n           }, 5000)\r\n         }\r\n       }\r\n@@ -677,19 +672,12 @@\n       }\r\n \r\n       wsConnection.onmessage = (event) => {\r\n         try {\r\n-          console.log(`ğŸ“¨ åŸå§‹ WebSocket æ¶ˆæ¯:`, event.data)\r\n           const message = JSON.parse(event.data)\r\n-          console.log(`ğŸ“¨ è§£æåçš„ WebSocket æ¶ˆæ¯:`, message)\r\n-\r\n-          // è®°å½•æ¶ˆæ¯åˆ°è°ƒè¯•å™¨\r\n-          logWebSocketMessage(message.type || 'unknown', message.data || message, 'received')\r\n-\r\n           handleWebSocketMessage(message)\r\n         } catch (error) {\r\n           console.error('âŒ è§£æ WebSocket æ¶ˆæ¯å¤±è´¥:', error, event.data)\r\n-          logWebSocketMessage('parse_error', { error: error.message, rawData: event.data }, 'error')\r\n         }\r\n       }\r\n     })\r\n   } catch (error) {\r\n@@ -722,16 +710,8 @@\n         handleExecutingMessage(data)\r\n         break\r\n       default:\r\n         console.log(`ğŸ” æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹: ${type}`, data)\r\n-        // å¯¹äºæœªçŸ¥æ¶ˆæ¯ç±»å‹ï¼Œä¹Ÿå°è¯•å¤„ç† prompt_id\r\n-        if (data && data.prompt_id) {\r\n-          console.log(`ğŸ” æ£€æŸ¥æœªçŸ¥æ¶ˆæ¯ç±»å‹æ˜¯å¦åŒ…å«ä»»åŠ¡å®Œæˆä¿¡æ¯: ${type}`)\r\n-          // å¯èƒ½æ˜¯ä»»åŠ¡å®Œæˆçš„æ¶ˆæ¯ï¼Œå°è¯•ä½œä¸ºæ‰§è¡Œå®Œæˆå¤„ç†\r\n-          if (type === 'execution_cached' || type === 'execution_success') {\r\n-            handleExecutedMessage(data)\r\n-          }\r\n-        }\r\n     }\r\n \r\n     // è§¦å‘æ³¨å†Œçš„æ¶ˆæ¯å¤„ç†å™¨\r\n     if (wsMessageHandlers.has(type)) {\r\n@@ -768,48 +748,27 @@\n }\r\n \r\n // å¤„ç†æ‰§è¡Œå®Œæˆæ¶ˆæ¯\r\n function handleExecutedMessage(data) {\r\n-  console.log(`ğŸ¯ å¤„ç†æ‰§è¡Œå®Œæˆæ¶ˆæ¯:`, data)\r\n-\r\n   if (data && data.prompt_id) {\r\n     const task = pendingTasks.get(data.prompt_id)\r\n     if (task) {\r\n-      console.log(`âœ… ä»»åŠ¡ ${data.prompt_id} æ‰§è¡Œå®Œæˆï¼Œå¼€å§‹è·å–ç»“æœ`)\r\n+      console.log(`âœ… ä»»åŠ¡ ${data.prompt_id} æ‰§è¡Œå®Œæˆ`)\r\n \r\n-      // å»¶è¿Ÿä¸€ä¸‹å†è·å–ç»“æœï¼Œç¡®ä¿ ComfyUI å·²ç»å®Œå…¨å¤„ç†å®Œæˆ\r\n-      setTimeout(async () => {\r\n-        try {\r\n-          console.log(`ğŸ” è·å–ä»»åŠ¡ ${data.prompt_id} çš„å®Œæ•´å†å²è®°å½•`)\r\n-          const result = await checkTaskStatus(data.prompt_id)\r\n-\r\n-          if (result && result[data.prompt_id]) {\r\n-            console.log(`ğŸ“‹ ä»»åŠ¡ ${data.prompt_id} ç»“æœ:`, result[data.prompt_id])\r\n-\r\n-            if (task.onComplete) {\r\n-              task.onComplete(result[data.prompt_id])\r\n-            }\r\n-          } else {\r\n-            console.warn(`âš ï¸ ä»»åŠ¡ ${data.prompt_id} ç»“æœä¸ºç©ºï¼Œå°è¯•ç›´æ¥ä½¿ç”¨ WebSocket æ•°æ®`)\r\n-            if (task.onComplete) {\r\n-              task.onComplete(data)\r\n-            }\r\n-          }\r\n-\r\n-          pendingTasks.delete(data.prompt_id)\r\n-        } catch (error) {\r\n-          console.error(`âŒ è·å–ä»»åŠ¡ ${data.prompt_id} ç»“æœå¤±è´¥:`, error)\r\n-          if (task.onError) {\r\n-            task.onError(error.message)\r\n-          }\r\n-          pendingTasks.delete(data.prompt_id)\r\n+      // è·å–å®Œæ•´çš„å†å²è®°å½•\r\n+      checkTaskStatus(data.prompt_id).then(result => {\r\n+        if (task.onComplete) {\r\n+          task.onComplete(result)\r\n         }\r\n-      }, 1000) // å»¶è¿Ÿ 1 ç§’\r\n-    } else {\r\n-      console.warn(`âš ï¸ æ”¶åˆ°æœªè·Ÿè¸ªä»»åŠ¡çš„å®Œæˆæ¶ˆæ¯: ${data.prompt_id}`)\r\n+        pendingTasks.delete(data.prompt_id)\r\n+      }).catch(error => {\r\n+        console.error('âŒ è·å–ä»»åŠ¡ç»“æœå¤±è´¥:', error)\r\n+        if (task.onError) {\r\n+          task.onError(error.message)\r\n+        }\r\n+        pendingTasks.delete(data.prompt_id)\r\n+      })\r\n     }\r\n-  } else {\r\n-    console.warn(`âš ï¸ æ‰§è¡Œå®Œæˆæ¶ˆæ¯ç¼ºå°‘ prompt_id:`, data)\r\n   }\r\n }\r\n \r\n // å¤„ç†æ‰§è¡Œé”™è¯¯æ¶ˆæ¯\r\n@@ -880,17 +839,13 @@\n     }\r\n \r\n     // æ³¨å†Œä»»åŠ¡\r\n     pendingTasks.set(promptId, task)\r\n-    console.log(`ğŸ“ å·²æ³¨å†Œä»»åŠ¡ ${promptId}ï¼Œå½“å‰å¾…å¤„ç†ä»»åŠ¡æ•°: ${pendingTasks.size}`)\r\n-    console.log(`ğŸ”Œ WebSocket è¿æ¥çŠ¶æ€: ${isWsConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}`)\r\n \r\n     // å¦‚æœ WebSocket æœªè¿æ¥ï¼Œå›é€€åˆ°è½®è¯¢æ¨¡å¼\r\n     if (!isWsConnected) {\r\n       console.log('âš ï¸ WebSocket æœªè¿æ¥ï¼Œä½¿ç”¨è½®è¯¢æ¨¡å¼')\r\n       fallbackToPolling(promptId, task, timeout)\r\n-    } else {\r\n-      console.log(`âœ… ä½¿ç”¨ WebSocket æ¨¡å¼ç­‰å¾…ä»»åŠ¡ ${promptId} å®Œæˆ`)\r\n     }\r\n   })\r\n }\r\n \r\n"
                },
                {
                    "date": 1752464964257,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -748,27 +748,43 @@\n }\r\n \r\n // å¤„ç†æ‰§è¡Œå®Œæˆæ¶ˆæ¯\r\n function handleExecutedMessage(data) {\r\n+  console.log(`ğŸ“£ æ”¶åˆ°æ‰§è¡Œå®Œæˆæ¶ˆæ¯:`, data)\r\n+\r\n   if (data && data.prompt_id) {\r\n-    const task = pendingTasks.get(data.prompt_id)\r\n+    const promptId = data.prompt_id\r\n+    console.log(`ğŸ” æŸ¥æ‰¾ä»»åŠ¡: ${promptId}ï¼Œå½“å‰ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n+\r\n+    const task = pendingTasks.get(promptId)\r\n     if (task) {\r\n-      console.log(`âœ… ä»»åŠ¡ ${data.prompt_id} æ‰§è¡Œå®Œæˆ`)\r\n+      console.log(`âœ… æ‰¾åˆ°ä»»åŠ¡ ${promptId}ï¼Œå‡†å¤‡è·å–ç»“æœ`)\r\n \r\n       // è·å–å®Œæ•´çš„å†å²è®°å½•\r\n-      checkTaskStatus(data.prompt_id).then(result => {\r\n+      checkTaskStatus(promptId).then(result => {\r\n+        console.log(`ğŸ“‹ è·å–åˆ°ä»»åŠ¡ ${promptId} çš„å®Œæ•´ç»“æœ:`, result)\r\n+\r\n         if (task.onComplete) {\r\n+          console.log(`ğŸš€ è§¦å‘ä»»åŠ¡ ${promptId} çš„å®Œæˆå›è°ƒ`)\r\n           task.onComplete(result)\r\n+        } else {\r\n+          console.warn(`âš ï¸ ä»»åŠ¡ ${promptId} æ²¡æœ‰å®Œæˆå›è°ƒå‡½æ•°`)\r\n         }\r\n-        pendingTasks.delete(data.prompt_id)\r\n+\r\n+        pendingTasks.delete(promptId)\r\n+        console.log(`ğŸ—‘ï¸ å·²åˆ é™¤å®Œæˆçš„ä»»åŠ¡ ${promptId}ï¼Œå‰©ä½™ä»»åŠ¡:`, pendingTasks.size)\r\n       }).catch(error => {\r\n-        console.error('âŒ è·å–ä»»åŠ¡ç»“æœå¤±è´¥:', error)\r\n+        console.error(`âŒ è·å–ä»»åŠ¡ ${promptId} ç»“æœå¤±è´¥:`, error)\r\n         if (task.onError) {\r\n           task.onError(error.message)\r\n         }\r\n-        pendingTasks.delete(data.prompt_id)\r\n+        pendingTasks.delete(promptId)\r\n       })\r\n+    } else {\r\n+      console.warn(`âš ï¸ æ”¶åˆ°æœªçŸ¥ä»»åŠ¡ ${promptId} çš„æ‰§è¡Œå®Œæˆæ¶ˆæ¯`)\r\n     }\r\n+  } else {\r\n+    console.warn(`âš ï¸ æ”¶åˆ°æ— æ•ˆçš„æ‰§è¡Œå®Œæˆæ¶ˆæ¯:`, data)\r\n   }\r\n }\r\n \r\n // å¤„ç†æ‰§è¡Œé”™è¯¯æ¶ˆæ¯\r\n"
                },
                {
                    "date": 1752465034873,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -672,12 +672,30 @@\n       }\r\n \r\n       wsConnection.onmessage = (event) => {\r\n         try {\r\n-          const message = JSON.parse(event.data)\r\n+          console.log(`ğŸ“¨ æ”¶åˆ°WebSocketåŸå§‹æ¶ˆæ¯:`, event.data.substring(0, 200))\r\n+\r\n+          let message;\r\n+          try {\r\n+            message = JSON.parse(event.data)\r\n+          } catch (parseError) {\r\n+            console.error('âŒ WebSocketæ¶ˆæ¯è§£æå¤±è´¥:', parseError)\r\n+            console.log('åŸå§‹æ¶ˆæ¯å†…å®¹:', event.data.substring(0, 500))\r\n+            return\r\n+          }\r\n+\r\n+          console.log(`ğŸ“¨ è§£æåçš„WebSocketæ¶ˆæ¯ç±»å‹: ${message.type}`)\r\n+\r\n+          // è®°å½•å…³é”®æ¶ˆæ¯ç±»å‹çš„è¯¦ç»†å†…å®¹\r\n+          if (['executed', 'execution_error', 'progress'].includes(message.type)) {\r\n+            console.log(`ğŸ“‹ ${message.type} æ¶ˆæ¯è¯¦æƒ…:`, message)\r\n+          }\r\n+\r\n           handleWebSocketMessage(message)\r\n         } catch (error) {\r\n-          console.error('âŒ è§£æ WebSocket æ¶ˆæ¯å¤±è´¥:', error, event.data)\r\n+          console.error('âŒ å¤„ç†WebSocketæ¶ˆæ¯å¤±è´¥:', error)\r\n+          console.log('é—®é¢˜æ¶ˆæ¯å†…å®¹:', event.data.substring(0, 200))\r\n         }\r\n       }\r\n     })\r\n   } catch (error) {\r\n"
                },
                {
                    "date": 1752465087389,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -829,25 +829,30 @@\n     }\r\n   }\r\n }\r\n \r\n-// ç­‰å¾…ä»»åŠ¡å®Œæˆ - ä½¿ç”¨ WebSocketï¼Œæ”¯æŒè¿›åº¦å›è°ƒ\r\n+// ç­‰å¾…ä»»åŠ¡å®Œæˆ - æ”¯æŒWebSocketå’ŒHTTPè½®è¯¢ä¸¤ç§æ¨¡å¼\r\n async function waitForTaskCompletion(promptId, maxWaitTime = 300000, onProgress = null) {\r\n   console.log(`â³ ç­‰å¾…ä»»åŠ¡å®Œæˆ: ${promptId}`)\r\n \r\n-  // ç¡®ä¿ WebSocket è¿æ¥\r\n-  await initializeWebSocket()\r\n+  // å°è¯•åˆå§‹åŒ–WebSocketè¿æ¥ï¼Œä½†ä¸å¼ºåˆ¶è¦æ±‚æˆåŠŸ\r\n+  try {\r\n+    await initializeWebSocket()\r\n+  } catch (error) {\r\n+    console.warn(`âš ï¸ WebSocketè¿æ¥åˆå§‹åŒ–å¤±è´¥ï¼Œå°†ä½¿ç”¨HTTPè½®è¯¢: ${error.message}`)\r\n+  }\r\n \r\n   return new Promise((resolve, reject) => {\r\n     // è®¾ç½®è¶…æ—¶\r\n     const timeout = setTimeout(() => {\r\n+      console.warn(`â° ä»»åŠ¡ ${promptId} ç­‰å¾…è¶…æ—¶`)\r\n       pendingTasks.delete(promptId)\r\n       reject(new Error(`ä»»åŠ¡ ${promptId} æ‰§è¡Œè¶…æ—¶`))\r\n     }, maxWaitTime)\r\n \r\n     // åˆ›å»ºä»»åŠ¡è·Ÿè¸ªå¯¹è±¡\r\n     const task = {\r\n-      id: promptId,\r\n+      promptId, // ä¿®å¤ï¼šä½¿ç”¨ promptId è€Œä¸æ˜¯ id\r\n       onProgress: (progress, status) => {\r\n         console.log(`ğŸ“ˆ ä»»åŠ¡ ${promptId} è¿›åº¦: ${progress}% (${status})`)\r\n         // è°ƒç”¨å¤–éƒ¨è¿›åº¦å›è°ƒ\r\n         if (onProgress) {\r\n@@ -855,9 +860,9 @@\n         }\r\n       },\r\n       onComplete: (result) => {\r\n         clearTimeout(timeout)\r\n-        console.log(`âœ… ä»»åŠ¡ ${promptId} å®Œæˆ`)\r\n+        console.log(`âœ… ä»»åŠ¡ ${promptId} å®Œæˆï¼Œç»“æœ:`, result)\r\n         if (onProgress) {\r\n           onProgress('å¤„ç†å®Œæˆ', 100)\r\n         }\r\n         resolve(result)\r\n@@ -873,14 +878,18 @@\n     }\r\n \r\n     // æ³¨å†Œä»»åŠ¡\r\n     pendingTasks.set(promptId, task)\r\n+    console.log(`ğŸ“ å·²æ³¨å†Œä»»åŠ¡ ${promptId}ï¼Œå½“å‰ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n \r\n-    // å¦‚æœ WebSocket æœªè¿æ¥ï¼Œå›é€€åˆ°è½®è¯¢æ¨¡å¼\r\n-    if (!isWsConnected) {\r\n-      console.log('âš ï¸ WebSocket æœªè¿æ¥ï¼Œä½¿ç”¨è½®è¯¢æ¨¡å¼')\r\n-      fallbackToPolling(promptId, task, timeout)\r\n+    // åŒæ—¶ä½¿ç”¨WebSocketå’ŒHTTPè½®è¯¢ï¼Œç¡®ä¿è‡³å°‘ä¸€ç§æ–¹å¼èƒ½å·¥ä½œ\r\n+    if (isWsConnected) {\r\n+      console.log(`ğŸ”Œ ä½¿ç”¨WebSocketç›‘å¬ä»»åŠ¡ ${promptId} çŠ¶æ€`)\r\n     }\r\n+\r\n+    // æ— è®ºWebSocketæ˜¯å¦è¿æ¥ï¼Œéƒ½å¯åŠ¨HTTPè½®è¯¢ä½œä¸ºå¤‡ä»½\r\n+    console.log(`ğŸ”„ å¯åŠ¨HTTPè½®è¯¢ä½œä¸ºå¤‡ä»½æœºåˆ¶`)\r\n+    fallbackToPolling(promptId, task, timeout)\r\n   })\r\n }\r\n \r\n // å›é€€åˆ°è½®è¯¢æ¨¡å¼\r\n"
                },
                {
                    "date": 1752465274612,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -622,38 +622,49 @@\n // åˆå§‹åŒ– WebSocket è¿æ¥\r\n async function initializeWebSocket() {\r\n   try {\r\n     if (wsConnection && wsConnection.readyState === WebSocket.OPEN) {\r\n-      console.log('WebSocket å·²è¿æ¥ï¼Œæ— éœ€é‡æ–°åˆå§‹åŒ–')\r\n+      console.log('ğŸ¯ WebSocket å·²è¿æ¥ï¼Œæ— éœ€é‡æ–°åˆå§‹åŒ–')\r\n       return true\r\n     }\r\n \r\n     const config = getComfyUIConfig()\r\n     const baseUrl = await getApiBaseUrl()\r\n     const wsUrl = baseUrl.replace(/^http/, 'ws') + '/ws?clientId=' + config.CLIENT_ID\r\n \r\n-    console.log(`ğŸ”Œ è¿æ¥ ComfyUI WebSocket: ${wsUrl}`)\r\n+    console.log('ğŸš€ğŸš€ğŸš€ æ­£åœ¨åˆå§‹åŒ– ComfyUI WebSocket è¿æ¥ ğŸš€ğŸš€ğŸš€')\r\n+    console.log(`ğŸ”— WebSocket URL: ${wsUrl}`)\r\n+    console.log(`ğŸ†” å®¢æˆ·ç«¯ID: ${config.CLIENT_ID}`)\r\n \r\n     wsConnection = new WebSocket(wsUrl)\r\n \r\n     return new Promise((resolve, reject) => {\r\n       const timeout = setTimeout(() => {\r\n+        console.error('âŒâŒâŒ WebSocket è¿æ¥è¶…æ—¶ (10ç§’) âŒâŒâŒ')\r\n         reject(new Error('WebSocket è¿æ¥è¶…æ—¶'))\r\n       }, 10000)\r\n \r\n       wsConnection.onopen = () => {\r\n-        console.log('âœ… ComfyUI WebSocket è¿æ¥æˆåŠŸ')\r\n+        console.log('ğŸ‰ğŸ‰ğŸ‰ ComfyUI WebSocket è¿æ¥æˆåŠŸå»ºç«‹! ğŸ‰ğŸ‰ğŸ‰')\r\n+        console.log('ğŸ“¡ å®æ—¶é€šä¿¡å·²å¯ç”¨ï¼Œç­‰å¾…ComfyUIå¤„ç†ç»“æœ...')\r\n         isWsConnected = true\r\n         clearTimeout(timeout)\r\n         clearTimeout(wsReconnectTimer)\r\n+\r\n+        // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n+        showWebSocketStatusNotification('WebSocketè¿æ¥æˆåŠŸ', 'success')\r\n+\r\n         resolve(true)\r\n       }\r\n \r\n       wsConnection.onclose = (event) => {\r\n-        console.log(`âŒ ComfyUI WebSocket è¿æ¥å…³é—­: ${event.code} ${event.reason}`)\r\n+        console.log(`ğŸ”Œ ComfyUI WebSocket è¿æ¥å…³é—­: ä»£ç =${event.code}, åŸå› =${event.reason}`)\r\n         isWsConnected = false\r\n         clearTimeout(timeout)\r\n \r\n+        // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n+        showWebSocketStatusNotification('WebSocketè¿æ¥å·²æ–­å¼€', 'warning')\r\n+\r\n         // å°è¯•é‡æ–°è¿æ¥\r\n         if (!wsReconnectTimer) {\r\n           wsReconnectTimer = setTimeout(() => {\r\n             wsReconnectTimer = null\r\n@@ -665,16 +676,20 @@\n         }\r\n       }\r\n \r\n       wsConnection.onerror = (error) => {\r\n-        console.error('âŒ ComfyUI WebSocket é”™è¯¯:', error)\r\n+        console.error('âŒâŒâŒ ComfyUI WebSocket è¿æ¥é”™è¯¯ âŒâŒâŒ', error)\r\n         clearTimeout(timeout)\r\n+\r\n+        // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n+        showWebSocketStatusNotification('WebSocketè¿æ¥é”™è¯¯', 'error')\r\n+\r\n         reject(error)\r\n       }\r\n \r\n       wsConnection.onmessage = (event) => {\r\n         try {\r\n-          console.log(`ğŸ“¨ æ”¶åˆ°WebSocketåŸå§‹æ¶ˆæ¯:`, event.data.substring(0, 200))\r\n+          console.log(`ğŸ“¨ æ”¶åˆ°WebSocketåŸå§‹æ¶ˆæ¯ (${event.data.length}å­—ç¬¦):`, event.data.substring(0, 200))\r\n \r\n           let message;\r\n           try {\r\n             message = JSON.parse(event.data)\r\n@@ -683,13 +698,14 @@\n             console.log('åŸå§‹æ¶ˆæ¯å†…å®¹:', event.data.substring(0, 500))\r\n             return\r\n           }\r\n \r\n-          console.log(`ğŸ“¨ è§£æåçš„WebSocketæ¶ˆæ¯ç±»å‹: ${message.type}`)\r\n+          console.log(`ğŸ“‹ WebSocketæ¶ˆæ¯ç±»å‹: ${message.type}`)\r\n \r\n-          // è®°å½•å…³é”®æ¶ˆæ¯ç±»å‹çš„è¯¦ç»†å†…å®¹\r\n-          if (['executed', 'execution_error', 'progress'].includes(message.type)) {\r\n-            console.log(`ğŸ“‹ ${message.type} æ¶ˆæ¯è¯¦æƒ…:`, message)\r\n+          // å¯¹å…³é”®æ¶ˆæ¯ç±»å‹æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯å’Œæ˜æ˜¾æ ‡è®°\r\n+          if (['executed', 'execution_error', 'progress', 'executing'].includes(message.type)) {\r\n+            console.log(`ğŸ”¥ğŸ”¥ğŸ”¥ é‡è¦æ¶ˆæ¯: ${message.type.toUpperCase()} ğŸ”¥ğŸ”¥ğŸ”¥`)\r\n+            console.log(`ğŸ“Š æ¶ˆæ¯è¯¦æƒ…:`, message)\r\n           }\r\n \r\n           handleWebSocketMessage(message)\r\n         } catch (error) {\r\n@@ -698,9 +714,9 @@\n         }\r\n       }\r\n     })\r\n   } catch (error) {\r\n-    console.error('âŒ åˆå§‹åŒ– WebSocket å¤±è´¥:', error)\r\n+    console.error('âŒâŒâŒ åˆå§‹åŒ– WebSocket å¤±è´¥ âŒâŒâŒ', error)\r\n     throw error\r\n   }\r\n }\r\n \r\n"
                },
                {
                    "date": 1752465311351,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -782,43 +782,73 @@\n }\r\n \r\n // å¤„ç†æ‰§è¡Œå®Œæˆæ¶ˆæ¯\r\n function handleExecutedMessage(data) {\r\n-  console.log(`ğŸ“£ æ”¶åˆ°æ‰§è¡Œå®Œæˆæ¶ˆæ¯:`, data)\r\n+  console.log('ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯')\r\n+  console.log('ğŸ‰ğŸ‰ğŸ‰ ComfyUI ä»»åŠ¡æ‰§è¡Œå®Œæˆ! ğŸ‰ğŸ‰ğŸ‰')\r\n+  console.log('ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯')\r\n+  console.log(`ğŸ“£ æ‰§è¡Œå®Œæˆæ¶ˆæ¯è¯¦æƒ…:`, data)\r\n \r\n   if (data && data.prompt_id) {\r\n     const promptId = data.prompt_id\r\n-    console.log(`ğŸ” æŸ¥æ‰¾ä»»åŠ¡: ${promptId}ï¼Œå½“å‰ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n+    console.log(`ğŸ” æŸ¥æ‰¾ä»»åŠ¡: ${promptId}`)\r\n+    console.log(`ğŸ“‹ å½“å‰å¾…å¤„ç†ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n \r\n     const task = pendingTasks.get(promptId)\r\n     if (task) {\r\n-      console.log(`âœ… æ‰¾åˆ°ä»»åŠ¡ ${promptId}ï¼Œå‡†å¤‡è·å–ç»“æœ`)\r\n+      console.log('âœ…âœ…âœ… æ‰¾åˆ°å¯¹åº”ä»»åŠ¡ï¼Œå¼€å§‹è·å–å¤„ç†ç»“æœ âœ…âœ…âœ…')\r\n \r\n+      // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n+      showWebSocketStatusNotification(`ä»»åŠ¡ ${promptId.substring(0, 8)} å¤„ç†å®Œæˆ!`, 'success')\r\n+\r\n       // è·å–å®Œæ•´çš„å†å²è®°å½•\r\n       checkTaskStatus(promptId).then(result => {\r\n-        console.log(`ğŸ“‹ è·å–åˆ°ä»»åŠ¡ ${promptId} çš„å®Œæ•´ç»“æœ:`, result)\r\n+        console.log('ğŸŠğŸŠğŸŠ æˆåŠŸè·å–ä»»åŠ¡å®Œæ•´ç»“æœ ğŸŠğŸŠğŸŠ')\r\n+        console.log(`ğŸ“‹ ä»»åŠ¡ ${promptId} çš„å®Œæ•´ç»“æœ:`, result)\r\n \r\n         if (task.onComplete) {\r\n-          console.log(`ğŸš€ è§¦å‘ä»»åŠ¡ ${promptId} çš„å®Œæˆå›è°ƒ`)\r\n+          console.log('ğŸš€ğŸš€ğŸš€ è§¦å‘ä»»åŠ¡å®Œæˆå›è°ƒå‡½æ•° ğŸš€ğŸš€ğŸš€')\r\n+          console.log('ğŸ¯ å³å°†è¿”å›å¤„ç†ç»“æœåˆ°å‰ç«¯ç•Œé¢...')\r\n+\r\n+          // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥\r\n+          showWebSocketStatusNotification('å›¾ç‰‡å¤„ç†æˆåŠŸï¼Œæ­£åœ¨åŠ è½½ç»“æœ...', 'success')\r\n+\r\n           task.onComplete(result)\r\n+\r\n+          console.log('âœ…âœ…âœ… ä»»åŠ¡å®Œæˆå›è°ƒå·²æ‰§è¡Œï¼Œç»“æœå·²è¿”å›å‰ç«¯ âœ…âœ…âœ…')\r\n         } else {\r\n-          console.warn(`âš ï¸ ä»»åŠ¡ ${promptId} æ²¡æœ‰å®Œæˆå›è°ƒå‡½æ•°`)\r\n+          console.warn(`âš ï¸âš ï¸âš ï¸ ä»»åŠ¡ ${promptId} æ²¡æœ‰å®Œæˆå›è°ƒå‡½æ•°! âš ï¸âš ï¸âš ï¸`)\r\n         }\r\n \r\n         pendingTasks.delete(promptId)\r\n-        console.log(`ğŸ—‘ï¸ å·²åˆ é™¤å®Œæˆçš„ä»»åŠ¡ ${promptId}ï¼Œå‰©ä½™ä»»åŠ¡:`, pendingTasks.size)\r\n+        console.log(`ğŸ—‘ï¸ å·²åˆ é™¤å®Œæˆçš„ä»»åŠ¡ ${promptId}ï¼Œå‰©ä½™ä»»åŠ¡æ•°: ${pendingTasks.size}`)\r\n+\r\n+        console.log('ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰')\r\n+        console.log('ğŸŠ ComfyUI å¤„ç†æµç¨‹å®Œå…¨ç»“æŸ! ğŸŠ')\r\n+        console.log('ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰')\r\n+\r\n       }).catch(error => {\r\n-        console.error(`âŒ è·å–ä»»åŠ¡ ${promptId} ç»“æœå¤±è´¥:`, error)\r\n+        console.error('âŒâŒâŒ è·å–ä»»åŠ¡ç»“æœå¤±è´¥ âŒâŒâŒ', error)\r\n+        console.error(`âŒ ä»»åŠ¡ ${promptId} ç»“æœè·å–å¤±è´¥:`, error)\r\n+\r\n+        // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥\r\n+        showWebSocketStatusNotification('è·å–å¤„ç†ç»“æœå¤±è´¥', 'error')\r\n+\r\n         if (task.onError) {\r\n           task.onError(error.message)\r\n         }\r\n         pendingTasks.delete(promptId)\r\n       })\r\n     } else {\r\n+      console.warn('âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸')\r\n       console.warn(`âš ï¸ æ”¶åˆ°æœªçŸ¥ä»»åŠ¡ ${promptId} çš„æ‰§è¡Œå®Œæˆæ¶ˆæ¯`)\r\n+      console.warn('âš ï¸ å¯èƒ½çš„åŸå› : 1) ä»»åŠ¡å·²è¢«æ¸…ç† 2) ä»»åŠ¡IDä¸åŒ¹é… 3) é‡å¤æ¶ˆæ¯')\r\n+      console.warn(`âš ï¸ å½“å‰ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n+      console.warn('âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸')\r\n     }\r\n   } else {\r\n-    console.warn(`âš ï¸ æ”¶åˆ°æ— æ•ˆçš„æ‰§è¡Œå®Œæˆæ¶ˆæ¯:`, data)\r\n+    console.warn('âš ï¸âš ï¸âš ï¸ æ”¶åˆ°æ— æ•ˆçš„æ‰§è¡Œå®Œæˆæ¶ˆæ¯ âš ï¸âš ï¸âš ï¸')\r\n+    console.warn('æ¶ˆæ¯å†…å®¹:', data)\r\n   }\r\n }\r\n \r\n // å¤„ç†æ‰§è¡Œé”™è¯¯æ¶ˆæ¯\r\n"
                },
                {
                    "date": 1752465348669,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -875,67 +875,105 @@\n     }\r\n   }\r\n }\r\n \r\n-// ç­‰å¾…ä»»åŠ¡å®Œæˆ - æ”¯æŒWebSocketå’ŒHTTPè½®è¯¢ä¸¤ç§æ¨¡å¼\r\n+// ç­‰å¾…ä»»åŠ¡å®Œæˆ - ä¸“æ³¨ä½¿ç”¨WebSocketæœºåˆ¶\r\n async function waitForTaskCompletion(promptId, maxWaitTime = 300000, onProgress = null) {\r\n-  console.log(`â³ ç­‰å¾…ä»»åŠ¡å®Œæˆ: ${promptId}`)\r\n+  console.log('ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯')\r\n+  console.log(`â³ å¼€å§‹ç­‰å¾…ä»»åŠ¡å®Œæˆ: ${promptId}`)\r\n+  console.log('ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯')\r\n \r\n-  // å°è¯•åˆå§‹åŒ–WebSocketè¿æ¥ï¼Œä½†ä¸å¼ºåˆ¶è¦æ±‚æˆåŠŸ\r\n+  // ç¡®ä¿WebSocketè¿æ¥å·²å»ºç«‹\r\n+  console.log('ğŸ”Œ ç¡®ä¿WebSocketè¿æ¥å·²å»ºç«‹...')\r\n   try {\r\n-    await initializeWebSocket()\r\n+    const wsConnected = await initializeWebSocket()\r\n+    if (!wsConnected) {\r\n+      throw new Error('WebSocketè¿æ¥å¤±è´¥')\r\n+    }\r\n+    console.log('âœ… WebSocketè¿æ¥ç¡®è®¤æˆåŠŸ')\r\n   } catch (error) {\r\n-    console.warn(`âš ï¸ WebSocketè¿æ¥åˆå§‹åŒ–å¤±è´¥ï¼Œå°†ä½¿ç”¨HTTPè½®è¯¢: ${error.message}`)\r\n+    console.error('âŒâŒâŒ WebSocketè¿æ¥å¤±è´¥ï¼Œæ— æ³•ä½¿ç”¨å®æ—¶é€šä¿¡ âŒâŒâŒ', error)\r\n+    throw new Error(`WebSocketè¿æ¥å¤±è´¥: ${error.message}`)\r\n   }\r\n \r\n   return new Promise((resolve, reject) => {\r\n     // è®¾ç½®è¶…æ—¶\r\n     const timeout = setTimeout(() => {\r\n-      console.warn(`â° ä»»åŠ¡ ${promptId} ç­‰å¾…è¶…æ—¶`)\r\n+      console.warn('â°â°â° ä»»åŠ¡ç­‰å¾…è¶…æ—¶ â°â°â°')\r\n+      console.warn(`â° ä»»åŠ¡ ${promptId} ç­‰å¾…è¶…æ—¶ (${maxWaitTime/1000}ç§’)`)\r\n       pendingTasks.delete(promptId)\r\n+\r\n+      // æ˜¾ç¤ºè¶…æ—¶é€šçŸ¥\r\n+      showWebSocketStatusNotification('ä»»åŠ¡å¤„ç†è¶…æ—¶', 'error')\r\n+\r\n       reject(new Error(`ä»»åŠ¡ ${promptId} æ‰§è¡Œè¶…æ—¶`))\r\n     }, maxWaitTime)\r\n \r\n     // åˆ›å»ºä»»åŠ¡è·Ÿè¸ªå¯¹è±¡\r\n     const task = {\r\n-      promptId, // ä¿®å¤ï¼šä½¿ç”¨ promptId è€Œä¸æ˜¯ id\r\n+      promptId,\r\n       onProgress: (progress, status) => {\r\n         console.log(`ğŸ“ˆ ä»»åŠ¡ ${promptId} è¿›åº¦: ${progress}% (${status})`)\r\n         // è°ƒç”¨å¤–éƒ¨è¿›åº¦å›è°ƒ\r\n         if (onProgress) {\r\n           onProgress(`æ­£åœ¨å¤„ç†: ${status}`, progress)\r\n         }\r\n+\r\n+        // æ˜¾ç¤ºè¿›åº¦é€šçŸ¥\r\n+        showWebSocketStatusNotification(`å¤„ç†è¿›åº¦: ${progress}%`, 'info')\r\n       },\r\n       onComplete: (result) => {\r\n         clearTimeout(timeout)\r\n+        console.log('ğŸ‰ğŸ‰ğŸ‰ ä»»åŠ¡å®Œæˆå›è°ƒè¢«è§¦å‘ ğŸ‰ğŸ‰ğŸ‰')\r\n         console.log(`âœ… ä»»åŠ¡ ${promptId} å®Œæˆï¼Œç»“æœ:`, result)\r\n+\r\n         if (onProgress) {\r\n           onProgress('å¤„ç†å®Œæˆ', 100)\r\n         }\r\n+\r\n+        console.log('ğŸš€ æ­£åœ¨è¿”å›å¤„ç†ç»“æœ...')\r\n         resolve(result)\r\n       },\r\n       onError: (error) => {\r\n         clearTimeout(timeout)\r\n+        console.error('âŒâŒâŒ ä»»åŠ¡é”™è¯¯å›è°ƒè¢«è§¦å‘ âŒâŒâŒ')\r\n         console.error(`âŒ ä»»åŠ¡ ${promptId} å¤±è´¥:`, error)\r\n+\r\n         if (onProgress) {\r\n           onProgress('å¤„ç†å¤±è´¥', 0)\r\n         }\r\n+\r\n+        // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥\r\n+        showWebSocketStatusNotification('ä»»åŠ¡å¤„ç†å¤±è´¥', 'error')\r\n+\r\n         reject(new Error(error))\r\n       }\r\n     }\r\n \r\n-    // æ³¨å†Œä»»åŠ¡\r\n+    // æ³¨å†Œä»»åŠ¡åˆ°å¾…å¤„ç†åˆ—è¡¨\r\n     pendingTasks.set(promptId, task)\r\n-    console.log(`ğŸ“ å·²æ³¨å†Œä»»åŠ¡ ${promptId}ï¼Œå½“å‰ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n+    console.log('ğŸ“ğŸ“ğŸ“ ä»»åŠ¡å·²æ³¨å†Œåˆ°WebSocketç›‘å¬åˆ—è¡¨ ğŸ“ğŸ“ğŸ“')\r\n+    console.log(`ğŸ“ ä»»åŠ¡ID: ${promptId}`)\r\n+    console.log(`ğŸ“ å½“å‰å¾…å¤„ç†ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n+    console.log(`ğŸ“ ä»»åŠ¡æ€»æ•°: ${pendingTasks.size}`)\r\n \r\n-    // åŒæ—¶ä½¿ç”¨WebSocketå’ŒHTTPè½®è¯¢ï¼Œç¡®ä¿è‡³å°‘ä¸€ç§æ–¹å¼èƒ½å·¥ä½œ\r\n-    if (isWsConnected) {\r\n-      console.log(`ğŸ”Œ ä½¿ç”¨WebSocketç›‘å¬ä»»åŠ¡ ${promptId} çŠ¶æ€`)\r\n+    // ç¡®è®¤WebSocketè¿æ¥çŠ¶æ€\r\n+    if (isWsConnected && wsConnection && wsConnection.readyState === WebSocket.OPEN) {\r\n+      console.log('ğŸ”ŒğŸ”ŒğŸ”Œ WebSocketè¿æ¥çŠ¶æ€è‰¯å¥½ï¼Œç­‰å¾…ComfyUIæ¨é€ç»“æœ ğŸ”ŒğŸ”ŒğŸ”Œ')\r\n+      console.log('ğŸ“¡ å®æ—¶é€šä¿¡å·²å¯ç”¨ï¼Œæ— éœ€è½®è¯¢')\r\n+\r\n+      // æ˜¾ç¤ºç­‰å¾…é€šçŸ¥\r\n+      showWebSocketStatusNotification(`æ­£åœ¨ç­‰å¾…ä»»åŠ¡ ${promptId.substring(0, 8)} å®Œæˆ...`, 'info')\r\n+    } else {\r\n+      console.error('âŒâŒâŒ WebSocketè¿æ¥çŠ¶æ€å¼‚å¸¸ âŒâŒâŒ')\r\n+      console.error('è¿æ¥çŠ¶æ€:', wsConnection ? wsConnection.readyState : 'null')\r\n+      console.error('è¿æ¥æ ‡å¿—:', isWsConnected)\r\n+\r\n+      // æ¸…ç†ä»»åŠ¡å¹¶æ‹’ç»\r\n+      pendingTasks.delete(promptId)\r\n+      clearTimeout(timeout)\r\n+      reject(new Error('WebSocketè¿æ¥çŠ¶æ€å¼‚å¸¸ï¼Œæ— æ³•ç›‘å¬ä»»åŠ¡å®Œæˆ'))\r\n     }\r\n-\r\n-    // æ— è®ºWebSocketæ˜¯å¦è¿æ¥ï¼Œéƒ½å¯åŠ¨HTTPè½®è¯¢ä½œä¸ºå¤‡ä»½\r\n-    console.log(`ğŸ”„ å¯åŠ¨HTTPè½®è¯¢ä½œä¸ºå¤‡ä»½æœºåˆ¶`)\r\n-    fallbackToPolling(promptId, task, timeout)\r\n   })\r\n }\r\n \r\n // å›é€€åˆ°è½®è¯¢æ¨¡å¼\r\n"
                },
                {
                    "date": 1752465368747,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -618,8 +618,41 @@\n let isWsConnected = false\r\n let wsMessageHandlers = new Map()\r\n let pendingTasks = new Map()\r\n \r\n+// å‰ç«¯é€šçŸ¥å‡½æ•°\r\n+function showWebSocketStatusNotification(message, type = 'info') {\r\n+  try {\r\n+    // åœ¨æ§åˆ¶å°æ˜¾ç¤ºæ˜æ˜¾æ ‡è®°\r\n+    const timestamp = new Date().toLocaleTimeString()\r\n+    const typeEmoji = {\r\n+      'success': 'âœ…',\r\n+      'error': 'âŒ',\r\n+      'warning': 'âš ï¸',\r\n+      'info': 'â„¹ï¸'\r\n+    }\r\n+\r\n+    console.log(`${typeEmoji[type] || 'â„¹ï¸'} [${timestamp}] ${message}`)\r\n+\r\n+    // å°è¯•æ˜¾ç¤ºæµè§ˆå™¨é€šçŸ¥ï¼ˆå¦‚æœç”¨æˆ·å…è®¸ï¼‰\r\n+    if ('Notification' in window && Notification.permission === 'granted') {\r\n+      new Notification('ComfyUI å¤„ç†çŠ¶æ€', {\r\n+        body: message,\r\n+        icon: '/favicon.ico'\r\n+      })\r\n+    }\r\n+\r\n+    // å°è¯•è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œä¾›Vueç»„ä»¶ç›‘å¬\r\n+    if (typeof window !== 'undefined') {\r\n+      window.dispatchEvent(new CustomEvent('comfyui-status', {\r\n+        detail: { message, type, timestamp }\r\n+      }))\r\n+    }\r\n+  } catch (error) {\r\n+    console.warn('æ˜¾ç¤ºé€šçŸ¥å¤±è´¥:', error)\r\n+  }\r\n+}\r\n+\r\n // åˆå§‹åŒ– WebSocket è¿æ¥\r\n async function initializeWebSocket() {\r\n   try {\r\n     if (wsConnection && wsConnection.readyState === WebSocket.OPEN) {\r\n"
                },
                {
                    "date": 1752465450711,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -804,14 +804,26 @@\n \r\n // å¤„ç†è¿›åº¦æ¶ˆæ¯\r\n function handleProgressMessage(data) {\r\n   if (data && data.prompt_id) {\r\n-    const task = pendingTasks.get(data.prompt_id)\r\n+    const promptId = data.prompt_id\r\n+    const task = pendingTasks.get(promptId)\r\n+\r\n     if (task && task.onProgress) {\r\n       const progress = Math.round((data.value / data.max) * 100)\r\n-      console.log(`ğŸ“ˆ ä»»åŠ¡ ${data.prompt_id} è¿›åº¦: ${progress}%`)\r\n+      console.log('ğŸ“ˆğŸ“ˆğŸ“ˆ ComfyUI å¤„ç†è¿›åº¦æ›´æ–° ğŸ“ˆğŸ“ˆğŸ“ˆ')\r\n+      console.log(`ğŸ“ˆ ä»»åŠ¡ ${promptId} è¿›åº¦: ${progress}% (${data.value}/${data.max})`)\r\n+      console.log(`ğŸ”„ å½“å‰å¤„ç†èŠ‚ç‚¹: ${data.node || 'æœªçŸ¥'}`)\r\n+\r\n+      // æ˜¾ç¤ºè¿›åº¦é€šçŸ¥\r\n+      showWebSocketStatusNotification(`å¤„ç†è¿›åº¦: ${progress}%`, 'info')\r\n+\r\n       task.onProgress(progress, 'processing')\r\n+    } else {\r\n+      console.log(`ğŸ“ˆ æ”¶åˆ°ä»»åŠ¡ ${promptId} çš„è¿›åº¦æ¶ˆæ¯ï¼Œä½†æœªæ‰¾åˆ°å¯¹åº”ä»»åŠ¡`)\r\n     }\r\n+  } else {\r\n+    console.warn('âš ï¸ æ”¶åˆ°æ— æ•ˆçš„è¿›åº¦æ¶ˆæ¯:', data)\r\n   }\r\n }\r\n \r\n // å¤„ç†æ‰§è¡Œå®Œæˆæ¶ˆæ¯\r\n"
                },
                {
                    "date": 1752465466726,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -912,13 +912,24 @@\n \r\n // å¤„ç†æ­£åœ¨æ‰§è¡Œæ¶ˆæ¯\r\n function handleExecutingMessage(data) {\r\n   if (data && data.prompt_id) {\r\n-    const task = pendingTasks.get(data.prompt_id)\r\n+    const promptId = data.prompt_id\r\n+    const task = pendingTasks.get(promptId)\r\n+\r\n     if (task && task.onProgress) {\r\n-      console.log(`ğŸ”„ ä»»åŠ¡ ${data.prompt_id} æ­£åœ¨æ‰§è¡ŒèŠ‚ç‚¹: ${data.node}`)\r\n+      console.log('ğŸ”„ğŸ”„ğŸ”„ ComfyUI å¼€å§‹æ‰§è¡Œä»»åŠ¡ ğŸ”„ğŸ”„ğŸ”„')\r\n+      console.log(`ğŸ”„ ä»»åŠ¡ ${promptId} æ­£åœ¨æ‰§è¡ŒèŠ‚ç‚¹: ${data.node || 'æœªçŸ¥'}`)\r\n+\r\n+      // æ˜¾ç¤ºæ‰§è¡Œé€šçŸ¥\r\n+      showWebSocketStatusNotification(`æ­£åœ¨æ‰§è¡ŒèŠ‚ç‚¹: ${data.node || 'æœªçŸ¥'}`, 'info')\r\n+\r\n       task.onProgress(10, 'executing')\r\n+    } else {\r\n+      console.log(`ğŸ”„ æ”¶åˆ°ä»»åŠ¡ ${promptId} çš„æ‰§è¡Œæ¶ˆæ¯ï¼Œä½†æœªæ‰¾åˆ°å¯¹åº”ä»»åŠ¡`)\r\n     }\r\n+  } else {\r\n+    console.warn('âš ï¸ æ”¶åˆ°æ— æ•ˆçš„æ‰§è¡Œæ¶ˆæ¯:', data)\r\n   }\r\n }\r\n \r\n // ç­‰å¾…ä»»åŠ¡å®Œæˆ - ä¸“æ³¨ä½¿ç”¨WebSocketæœºåˆ¶\r\n"
                },
                {
                    "date": 1752465482290,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1031,44 +1031,11 @@\n     }\r\n   })\r\n }\r\n \r\n-// å›é€€åˆ°è½®è¯¢æ¨¡å¼\r\n-async function fallbackToPolling(promptId, task, timeout) {\r\n-  const pollInterval = 2000\r\n-  const startTime = Date.now()\r\n+// HTTPè½®è¯¢å¤‡ä»½æœºåˆ¶å·²ç§»é™¤ï¼Œä¸“æ³¨ä½¿ç”¨WebSocketå®æ—¶é€šä¿¡\r\n+// å¦‚æœéœ€è¦æ‰‹åŠ¨æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼Œè¯·ä½¿ç”¨ checkTaskStatus(promptId) å‡½æ•°\r\n \r\n-  const poll = async () => {\r\n-    try {\r\n-      if (Date.now() - startTime > 300000) { // 5åˆ†é’Ÿè¶…æ—¶\r\n-        return\r\n-      }\r\n-\r\n-      const result = await checkTaskStatus(promptId)\r\n-\r\n-      if (result) {\r\n-        if (result.status && result.status.completed) {\r\n-          clearTimeout(timeout)\r\n-          task.onComplete(result)\r\n-          return\r\n-        } else if (result.status && result.status.status_str === 'error') {\r\n-          clearTimeout(timeout)\r\n-          task.onError(`ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${result.status.status_str}`)\r\n-          return\r\n-        }\r\n-      }\r\n-\r\n-      // ç»§ç»­è½®è¯¢\r\n-      setTimeout(poll, pollInterval)\r\n-    } catch (error) {\r\n-      console.error('âŒ è½®è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error)\r\n-      setTimeout(poll, pollInterval)\r\n-    }\r\n-  }\r\n-\r\n-  poll()\r\n-}\r\n-\r\n // ä¸»è¦çš„æ¢è¡£APIå‡½æ•° - ä¸¤æ­¥æµç¨‹\r\n async function processUndressImage(base64Image) {\r\n   try {\r\n     console.log('ğŸš€ å¼€å§‹å¤„ç†æ¢è¡£è¯·æ±‚...')\r\n"
                },
                {
                    "date": 1752465705528,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1035,14 +1035,17 @@\n // HTTPè½®è¯¢å¤‡ä»½æœºåˆ¶å·²ç§»é™¤ï¼Œä¸“æ³¨ä½¿ç”¨WebSocketå®æ—¶é€šä¿¡\r\n // å¦‚æœéœ€è¦æ‰‹åŠ¨æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼Œè¯·ä½¿ç”¨ checkTaskStatus(promptId) å‡½æ•°\r\n \r\n // ä¸»è¦çš„æ¢è¡£APIå‡½æ•° - ä¸¤æ­¥æµç¨‹\r\n-async function processUndressImage(base64Image) {\r\n+async function processUndressImage(base64Image, onProgress = null) {\r\n   try {\r\n-    console.log('ğŸš€ å¼€å§‹å¤„ç†æ¢è¡£è¯·æ±‚...')\r\n+    console.log('ğŸš€ğŸš€ğŸš€ å¼€å§‹å¤„ç†æ¢è¡£è¯·æ±‚ ğŸš€ğŸš€ğŸš€')\r\n+    console.log('ğŸ“± å‰ç«¯è¿›åº¦å›è°ƒå‡½æ•°:', onProgress ? 'å·²æä¾›' : 'æœªæä¾›')\r\n \r\n     // é¢„æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€\r\n     console.log('ğŸ” é¢„æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...')\r\n+    if (onProgress) onProgress('æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...', 5)\r\n+\r\n     const serverStatus = await checkComfyUIServerStatus()\r\n     if (serverStatus.status === 'error') {\r\n       console.warn('âš ï¸ å½“å‰æœåŠ¡å™¨çŠ¶æ€å¼‚å¸¸ï¼Œè§¦å‘é‡æ–°è¯„ä¼°...')\r\n       // å¼ºåˆ¶é‡æ–°è¯„ä¼°æœåŠ¡å™¨\r\n@@ -1050,8 +1053,10 @@\n     }\r\n \r\n     // æ£€æŸ¥ç§¯åˆ†ï¼ˆä¼˜å…ˆä½¿ç”¨ç­‰çº§å¡ç³»ç»Ÿï¼‰\r\n     console.log('ğŸ’ æ£€æŸ¥ç§¯åˆ†...')\r\n+    if (onProgress) onProgress('æ­£åœ¨æ£€æŸ¥ç§¯åˆ†...', 10)\r\n+\r\n     const pointsStatus = await levelCardPointsManager.getPointsStatus()\r\n     if (!pointsStatus.canGenerate) {\r\n       throw new Error(`ç§¯åˆ†ä¸è¶³ï¼å½“å‰ç§¯åˆ†: ${pointsStatus.current}ï¼Œéœ€è¦: ${pointsStatus.generationCost}`)\r\n     }\r\n@@ -1059,32 +1064,51 @@\n     console.log('ğŸ“‹ æµç¨‹ï¼šç¬¬ä¸€æ­¥ä¸Šä¼ å›¾ç‰‡ â†’ ç¬¬äºŒæ­¥æäº¤å·¥ä½œæµ')\r\n \r\n     // éªŒè¯å›¾ç‰‡æ•°æ®æ ¼å¼\r\n     console.log('ğŸ” éªŒè¯å›¾ç‰‡æ•°æ®æ ¼å¼...')\r\n+    if (onProgress) onProgress('æ­£åœ¨éªŒè¯å›¾ç‰‡æ ¼å¼...', 15)\r\n+\r\n     if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n       throw new Error('æ— æ•ˆçš„å›¾ç‰‡æ•°æ®æ ¼å¼')\r\n     }\r\n \r\n     // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨\r\n     console.log('ğŸ“¤ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ° /api/upload/image')\r\n+    if (onProgress) onProgress('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡åˆ°ComfyUI...', 20)\r\n+\r\n     const uploadedImageName = await uploadImageToComfyUI(base64Image)\r\n     console.log('âœ… ç¬¬ä¸€æ­¥å®Œæˆï¼Œè·å¾—æ–‡ä»¶å:', uploadedImageName)\r\n \r\n     // åˆ›å»ºå·¥ä½œæµæç¤ºè¯ï¼Œå°†ä¸Šä¼ çš„å›¾ç‰‡å…³è”åˆ°èŠ‚ç‚¹49\r\n     console.log('ğŸ”§ é…ç½®å·¥ä½œæµï¼Œå…³è”å›¾ç‰‡åˆ°èŠ‚ç‚¹49...')\r\n+    if (onProgress) onProgress('æ­£åœ¨é…ç½®å·¥ä½œæµ...', 30)\r\n+\r\n     const workflowPrompt = createUndressWorkflowPrompt(uploadedImageName)\r\n \r\n     // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµ\r\n     console.log('ğŸš€ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ° /api/prompt')\r\n+    if (onProgress) onProgress('æ­£åœ¨æäº¤å·¥ä½œæµåˆ°ComfyUI...', 40)\r\n+\r\n     const promptId = await submitWorkflow(workflowPrompt)\r\n     console.log('âœ… ç¬¬äºŒæ­¥å®Œæˆï¼Œè·å¾—ä»»åŠ¡ID:', promptId)\r\n \r\n-    // ç­‰å¾…ä»»åŠ¡å®Œæˆ\r\n+    // ç­‰å¾…ä»»åŠ¡å®Œæˆ - ä¼ é€’å‰ç«¯è¿›åº¦å›è°ƒ\r\n     console.log('â³ ç­‰å¾…ComfyUIå¤„ç†ä»»åŠ¡...')\r\n+    if (onProgress) onProgress('æ­£åœ¨ç­‰å¾…ComfyUIå¤„ç†...', 50)\r\n+\r\n     const taskResult = await waitForTaskCompletion(promptId, 300000, (status, progress) => {\r\n-      console.log(`ğŸ“Š ä»»åŠ¡è¿›åº¦: ${status} - ${progress}%`)\r\n+      console.log(`ğŸ“ŠğŸ“ŠğŸ“Š WebSocketè¿›åº¦æ›´æ–° ğŸ“ŠğŸ“ŠğŸ“Š`)\r\n+      console.log(`ä»»åŠ¡è¿›åº¦: ${status} - ${progress}%`)\r\n+\r\n+      // å°†WebSocketè¿›åº¦ä¼ é€’ç»™å‰ç«¯\r\n+      if (onProgress) {\r\n+        // ç¡®ä¿è¿›åº¦åœ¨50-95ä¹‹é—´ï¼Œä¸ºæœ€åçš„å›¾ç‰‡è·å–ç•™å‡ºç©ºé—´\r\n+        const adjustedProgress = Math.min(95, Math.max(50, 50 + (progress * 0.45)))\r\n+        console.log(`ğŸ”„ ä¼ é€’ç»™å‰ç«¯çš„è°ƒæ•´åè¿›åº¦: ${adjustedProgress}%`)\r\n+        onProgress(status, adjustedProgress)\r\n+      }\r\n     })\r\n-    console.log('âœ… ä»»åŠ¡å¤„ç†å®Œæˆ')\r\n+    console.log('âœ…âœ…âœ… ä»»åŠ¡å¤„ç†å®Œæˆ âœ…âœ…âœ…')\r\n \r\n     // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n     console.log('ğŸ“¥ è·å–ç”Ÿæˆçš„å›¾ç‰‡...')\r\n     const resultImage = await getGeneratedImage(taskResult)\r\n"
                },
                {
                    "date": 1752465732525,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1110,13 +1110,17 @@\n     console.log('âœ…âœ…âœ… ä»»åŠ¡å¤„ç†å®Œæˆ âœ…âœ…âœ…')\r\n \r\n     // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n     console.log('ğŸ“¥ è·å–ç”Ÿæˆçš„å›¾ç‰‡...')\r\n+    if (onProgress) onProgress('æ­£åœ¨è·å–å¤„ç†ç»“æœ...', 96)\r\n+\r\n     const resultImage = await getGeneratedImage(taskResult)\r\n-    console.log('ğŸ‰ æ¢è¡£å¤„ç†å®Œå…¨æˆåŠŸï¼')\r\n+    console.log('ğŸ‰ğŸ‰ğŸ‰ æ¢è¡£å¤„ç†å®Œå…¨æˆåŠŸ! ğŸ‰ğŸ‰ğŸ‰')\r\n \r\n     // æ¶ˆè€—ç§¯åˆ†ï¼ˆä»ç­‰çº§å¡æ‰£é™¤ï¼‰\r\n     console.log('ğŸ’ æ¶ˆè€—ç§¯åˆ†...')\r\n+    if (onProgress) onProgress('æ­£åœ¨æ›´æ–°ç§¯åˆ†...', 98)\r\n+\r\n     // è·å– ComfyUI å›¾ç‰‡è®¿é—®URLè€Œä¸æ˜¯ base64 æ•°æ®\r\n     const imageViewUrl = getComfyUIImageUrl(resultImage)\r\n     const pointsResult = await levelCardPointsManager.consumePoints(20, 'ä¸€é”®æ¢è¡£', imageViewUrl)\r\n     console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ç§¯åˆ†ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n@@ -1137,8 +1141,13 @@\n     } catch (error) {\r\n       console.warn('âš ï¸ è·å–èŠ‚ç‚¹49åŸå›¾å¤±è´¥ï¼Œä½¿ç”¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡:', error)\r\n     }\r\n \r\n+    // æœ€ç»ˆå®Œæˆ\r\n+    if (onProgress) onProgress('å¤„ç†å®Œæˆ', 100)\r\n+\r\n+    console.log('ğŸŠğŸŠğŸŠ æ‰€æœ‰å¤„ç†æ­¥éª¤å®Œæˆï¼Œå‡†å¤‡è¿”å›ç»“æœ ğŸŠğŸŠğŸŠ')\r\n+\r\n     return {\r\n       success: true,\r\n       resultImage: resultImage,\r\n       originalImage: originalImage, // æ–°å¢ï¼šèŠ‚ç‚¹49çš„åŸå›¾\r\n"
                },
                {
                    "date": 1752466149807,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -661,14 +661,39 @@\n     }\r\n \r\n     const config = getComfyUIConfig()\r\n     const baseUrl = await getApiBaseUrl()\r\n-    const wsUrl = baseUrl.replace(/^http/, 'ws') + '/ws?clientId=' + config.CLIENT_ID\r\n \r\n+    // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„WebSocket URLæ ¼å¼\r\n+    let wsUrl\r\n+    if (baseUrl.startsWith('https://')) {\r\n+      wsUrl = baseUrl.replace('https://', 'wss://') + '/ws?clientId=' + config.CLIENT_ID\r\n+    } else {\r\n+      wsUrl = baseUrl.replace('http://', 'ws://') + '/ws?clientId=' + config.CLIENT_ID\r\n+    }\r\n+\r\n     console.log('ğŸš€ğŸš€ğŸš€ æ­£åœ¨åˆå§‹åŒ– ComfyUI WebSocket è¿æ¥ ğŸš€ğŸš€ğŸš€')\r\n+    console.log(`ğŸ”— åŸå§‹URL: ${baseUrl}`)\r\n     console.log(`ğŸ”— WebSocket URL: ${wsUrl}`)\r\n     console.log(`ğŸ†” å®¢æˆ·ç«¯ID: ${config.CLIENT_ID}`)\r\n \r\n+    // å…ˆæµ‹è¯•HTTPè¿æ¥æ˜¯å¦æ­£å¸¸\r\n+    try {\r\n+      console.log('ğŸ” æµ‹è¯•ComfyUI HTTPè¿æ¥...')\r\n+      const testResponse = await fetch(`${baseUrl}/system_stats`, {\r\n+        method: 'GET',\r\n+        signal: AbortSignal.timeout(5000)\r\n+      })\r\n+      if (testResponse.ok) {\r\n+        console.log('âœ… ComfyUI HTTPè¿æ¥æ­£å¸¸')\r\n+      } else {\r\n+        console.warn('âš ï¸ ComfyUI HTTPè¿æ¥å¼‚å¸¸:', testResponse.status)\r\n+      }\r\n+    } catch (httpError) {\r\n+      console.error('âŒ ComfyUI HTTPè¿æ¥å¤±è´¥:', httpError)\r\n+      throw new Error(`ComfyUIæœåŠ¡å™¨ä¸å¯è¾¾: ${httpError.message}`)\r\n+    }\r\n+\r\n     wsConnection = new WebSocket(wsUrl)\r\n \r\n     return new Promise((resolve, reject) => {\r\n       const timeout = setTimeout(() => {\r\n"
                },
                {
                    "date": 1752466173877,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -745,9 +745,9 @@\n       }\r\n \r\n       wsConnection.onmessage = (event) => {\r\n         try {\r\n-          console.log(`ğŸ“¨ æ”¶åˆ°WebSocketåŸå§‹æ¶ˆæ¯ (${event.data.length}å­—ç¬¦):`, event.data.substring(0, 200))\r\n+          console.log(`ğŸ“¨ æ”¶åˆ°WebSocketåŸå§‹æ¶ˆæ¯ (${event.data.length}å­—ç¬¦):`, event.data.substring(0, 300))\r\n \r\n           let message;\r\n           try {\r\n             message = JSON.parse(event.data)\r\n@@ -756,20 +756,28 @@\n             console.log('åŸå§‹æ¶ˆæ¯å†…å®¹:', event.data.substring(0, 500))\r\n             return\r\n           }\r\n \r\n-          console.log(`ğŸ“‹ WebSocketæ¶ˆæ¯ç±»å‹: ${message.type}`)\r\n+          // ComfyUIçš„æ¶ˆæ¯æ ¼å¼é€šå¸¸æ˜¯ { type: \"...\", data: {...} }\r\n+          console.log(`ğŸ“‹ WebSocketæ¶ˆæ¯ç»“æ„:`, message)\r\n+          console.log(`ğŸ“‹ æ¶ˆæ¯ç±»å‹: ${message.type}`)\r\n+          console.log(`ğŸ“‹ æ¶ˆæ¯æ•°æ®:`, message.data)\r\n \r\n           // å¯¹å…³é”®æ¶ˆæ¯ç±»å‹æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯å’Œæ˜æ˜¾æ ‡è®°\r\n-          if (['executed', 'execution_error', 'progress', 'executing'].includes(message.type)) {\r\n+          if (['executed', 'execution_error', 'progress', 'executing', 'status'].includes(message.type)) {\r\n             console.log(`ğŸ”¥ğŸ”¥ğŸ”¥ é‡è¦æ¶ˆæ¯: ${message.type.toUpperCase()} ğŸ”¥ğŸ”¥ğŸ”¥`)\r\n-            console.log(`ğŸ“Š æ¶ˆæ¯è¯¦æƒ…:`, message)\r\n+            console.log(`ğŸ“Š å®Œæ•´æ¶ˆæ¯è¯¦æƒ…:`, JSON.stringify(message, null, 2))\r\n+\r\n+            // ç‰¹åˆ«å…³æ³¨executedæ¶ˆæ¯\r\n+            if (message.type === 'executed' && message.data && message.data.prompt_id) {\r\n+              console.log(`ğŸ¯ğŸ¯ğŸ¯ æ£€æµ‹åˆ°ä»»åŠ¡å®Œæˆæ¶ˆæ¯! ä»»åŠ¡ID: ${message.data.prompt_id} ğŸ¯ğŸ¯ğŸ¯`)\r\n+            }\r\n           }\r\n \r\n           handleWebSocketMessage(message)\r\n         } catch (error) {\r\n           console.error('âŒ å¤„ç†WebSocketæ¶ˆæ¯å¤±è´¥:', error)\r\n-          console.log('é—®é¢˜æ¶ˆæ¯å†…å®¹:', event.data.substring(0, 200))\r\n+          console.log('é—®é¢˜æ¶ˆæ¯å†…å®¹:', event.data.substring(0, 500))\r\n         }\r\n       }\r\n     })\r\n   } catch (error) {\r\n"
                },
                {
                    "date": 1752466199036,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -790,28 +790,46 @@\n function handleWebSocketMessage(message) {\r\n   try {\r\n     const { type, data } = message\r\n \r\n-    console.log(`ğŸ“¨ æ”¶åˆ° WebSocket æ¶ˆæ¯: ${type}`, data)\r\n+    console.log(`ğŸ“¨ğŸ“¨ğŸ“¨ å¤„ç†WebSocketæ¶ˆæ¯ ğŸ“¨ğŸ“¨ğŸ“¨`)\r\n+    console.log(`æ¶ˆæ¯ç±»å‹: ${type}`)\r\n+    console.log(`æ¶ˆæ¯æ•°æ®:`, data)\r\n \r\n     switch (type) {\r\n       case 'status':\r\n+        console.log('ğŸ”„ å¤„ç†çŠ¶æ€æ¶ˆæ¯')\r\n         handleStatusMessage(data)\r\n         break\r\n       case 'progress':\r\n+        console.log('ğŸ“ˆ å¤„ç†è¿›åº¦æ¶ˆæ¯')\r\n         handleProgressMessage(data)\r\n         break\r\n       case 'executed':\r\n+        console.log('ğŸ‰ å¤„ç†æ‰§è¡Œå®Œæˆæ¶ˆæ¯')\r\n         handleExecutedMessage(data)\r\n         break\r\n       case 'execution_error':\r\n+        console.log('âŒ å¤„ç†æ‰§è¡Œé”™è¯¯æ¶ˆæ¯')\r\n         handleExecutionErrorMessage(data)\r\n         break\r\n       case 'executing':\r\n+        console.log('ğŸ”„ å¤„ç†æ­£åœ¨æ‰§è¡Œæ¶ˆæ¯')\r\n         handleExecutingMessage(data)\r\n         break\r\n       default:\r\n-        console.log(`ğŸ” æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹: ${type}`, data)\r\n+        console.log(`ğŸ” æ”¶åˆ°æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹: ${type}`)\r\n+        console.log(`æœªå¤„ç†æ¶ˆæ¯çš„å®Œæ•´å†…å®¹:`, JSON.stringify(message, null, 2))\r\n+\r\n+        // å°è¯•æ£€æŸ¥æ˜¯å¦æ˜¯å…¶ä»–æ ¼å¼çš„æ‰§è¡Œå®Œæˆæ¶ˆæ¯\r\n+        if (data && (data.prompt_id || data.node || data.output)) {\r\n+          console.log('ğŸ” å¯èƒ½æ˜¯ç‰¹æ®Šæ ¼å¼çš„ä»»åŠ¡ç›¸å…³æ¶ˆæ¯ï¼Œå°è¯•å¤„ç†...')\r\n+          if (data.prompt_id) {\r\n+            console.log(`ğŸ¯ å‘ç°ä»»åŠ¡ID: ${data.prompt_id}`)\r\n+            // å°è¯•ä½œä¸ºæ‰§è¡Œå®Œæˆæ¶ˆæ¯å¤„ç†\r\n+            handleExecutedMessage(data)\r\n+          }\r\n+        }\r\n     }\r\n \r\n     // è§¦å‘æ³¨å†Œçš„æ¶ˆæ¯å¤„ç†å™¨\r\n     if (wsMessageHandlers.has(type)) {\r\n@@ -824,8 +842,10 @@\n       })\r\n     }\r\n   } catch (error) {\r\n     console.error('âŒ å¤„ç† WebSocket æ¶ˆæ¯å¤±è´¥:', error)\r\n+    console.error('é”™è¯¯è¯¦æƒ…:', error)\r\n+    console.log('é—®é¢˜æ¶ˆæ¯:', JSON.stringify(message, null, 2))\r\n   }\r\n }\r\n \r\n // å¤„ç†çŠ¶æ€æ¶ˆæ¯\r\n"
                },
                {
                    "date": 1752466230229,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -651,8 +651,97 @@\n     console.warn('æ˜¾ç¤ºé€šçŸ¥å¤±è´¥:', error)\r\n   }\r\n }\r\n \r\n+// è°ƒè¯•å‡½æ•°ï¼šæµ‹è¯•WebSocketè¿æ¥\r\n+async function debugWebSocketConnection() {\r\n+  console.log('ğŸ”§ğŸ”§ğŸ”§ å¼€å§‹WebSocketè¿æ¥è°ƒè¯• ğŸ”§ğŸ”§ğŸ”§')\r\n+\r\n+  try {\r\n+    // 1. æ£€æŸ¥é…ç½®\r\n+    const config = getComfyUIConfig()\r\n+    console.log('ğŸ“‹ å½“å‰é…ç½®:', config)\r\n+\r\n+    // 2. æ£€æŸ¥API URL\r\n+    const apiUrl = await getApiBaseUrl()\r\n+    console.log('ğŸ”— API URL:', apiUrl)\r\n+\r\n+    // 3. æµ‹è¯•HTTPè¿æ¥\r\n+    console.log('ğŸ” æµ‹è¯•HTTPè¿æ¥...')\r\n+    const httpResponse = await fetch(`${apiUrl}/system_stats`)\r\n+    console.log('ğŸ“Š HTTPå“åº”çŠ¶æ€:', httpResponse.status)\r\n+    if (httpResponse.ok) {\r\n+      const stats = await httpResponse.json()\r\n+      console.log('ğŸ“Š æœåŠ¡å™¨ç»Ÿè®¡:', stats)\r\n+    }\r\n+\r\n+    // 4. æµ‹è¯•WebSocketè¿æ¥\r\n+    console.log('ğŸ”Œ æµ‹è¯•WebSocketè¿æ¥...')\r\n+    await initializeWebSocket()\r\n+\r\n+    // 5. æ£€æŸ¥è¿æ¥çŠ¶æ€\r\n+    console.log('ğŸ“¡ WebSocketçŠ¶æ€:', {\r\n+      isConnected: isWsConnected,\r\n+      readyState: wsConnection ? wsConnection.readyState : 'null',\r\n+      url: wsConnection ? wsConnection.url : 'null'\r\n+    })\r\n+\r\n+    return true\r\n+  } catch (error) {\r\n+    console.error('âŒ WebSocketè°ƒè¯•å¤±è´¥:', error)\r\n+    return false\r\n+  }\r\n+}\r\n+\r\n+// è°ƒè¯•å‡½æ•°ï¼šæ¨¡æ‹Ÿä»»åŠ¡æäº¤å’Œç›‘å¬\r\n+async function debugTaskSubmission() {\r\n+  console.log('ğŸ¯ğŸ¯ğŸ¯ å¼€å§‹ä»»åŠ¡æäº¤è°ƒè¯• ğŸ¯ğŸ¯ğŸ¯')\r\n+\r\n+  try {\r\n+    // ç¡®ä¿WebSocketè¿æ¥\r\n+    await initializeWebSocket()\r\n+\r\n+    // åˆ›å»ºæµ‹è¯•ä»»åŠ¡\r\n+    const testPromptId = 'test-' + Date.now()\r\n+    console.log(`ğŸ“ åˆ›å»ºæµ‹è¯•ä»»åŠ¡: ${testPromptId}`)\r\n+\r\n+    // æ³¨å†Œä»»åŠ¡ç›‘å¬\r\n+    const testTask = {\r\n+      promptId: testPromptId,\r\n+      onProgress: (progress, status) => {\r\n+        console.log(`ğŸ“ˆ æµ‹è¯•ä»»åŠ¡è¿›åº¦: ${progress}% (${status})`)\r\n+      },\r\n+      onComplete: (result) => {\r\n+        console.log(`âœ… æµ‹è¯•ä»»åŠ¡å®Œæˆ:`, result)\r\n+      },\r\n+      onError: (error) => {\r\n+        console.error(`âŒ æµ‹è¯•ä»»åŠ¡å¤±è´¥:`, error)\r\n+      }\r\n+    }\r\n+\r\n+    pendingTasks.set(testPromptId, testTask)\r\n+    console.log(`ğŸ“‹ å·²æ³¨å†Œæµ‹è¯•ä»»åŠ¡ï¼Œå½“å‰ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n+\r\n+    // æ¨¡æ‹Ÿå‘é€æ‰§è¡Œå®Œæˆæ¶ˆæ¯ï¼ˆç”¨äºæµ‹è¯•ï¼‰\r\n+    setTimeout(() => {\r\n+      console.log('ğŸ§ª æ¨¡æ‹Ÿæ‰§è¡Œå®Œæˆæ¶ˆæ¯...')\r\n+      const mockMessage = {\r\n+        type: 'executed',\r\n+        data: {\r\n+          prompt_id: testPromptId,\r\n+          output: { test: 'result' }\r\n+        }\r\n+      }\r\n+      handleWebSocketMessage(mockMessage)\r\n+    }, 3000)\r\n+\r\n+    return testPromptId\r\n+  } catch (error) {\r\n+    console.error('âŒ ä»»åŠ¡æäº¤è°ƒè¯•å¤±è´¥:', error)\r\n+    return null\r\n+  }\r\n+}\r\n+\r\n // åˆå§‹åŒ– WebSocket è¿æ¥\r\n async function initializeWebSocket() {\r\n   try {\r\n     if (wsConnection && wsConnection.readyState === WebSocket.OPEN) {\r\n"
                },
                {
                    "date": 1752466277306,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1490,6 +1490,27 @@\n   processUndressImage,\r\n   processFaceSwapImage,\r\n   initializeWebSocket,\r\n   wsConnection,\r\n-  isWsConnected\r\n+  isWsConnected,\r\n+  debugWebSocketConnection,\r\n+  debugTaskSubmission,\r\n+  pendingTasks,\r\n+  checkTaskStatus\r\n }\r\n+\r\n+// åœ¨å¼€å‘ç¯å¢ƒä¸­æš´éœ²è°ƒè¯•å‡½æ•°åˆ°å…¨å±€\r\n+if (import.meta.env.DEV) {\r\n+  window.comfyUIDebug = {\r\n+    debugWebSocketConnection,\r\n+    debugTaskSubmission,\r\n+    pendingTasks,\r\n+    wsConnection: () => wsConnection,\r\n+    isWsConnected: () => isWsConnected,\r\n+    checkTaskStatus,\r\n+    getApiBaseUrl,\r\n+    handleExecutedMessage: (data) => handleExecutedMessage(data),\r\n+    handleWebSocketMessage: (message) => handleWebSocketMessage(message)\r\n+  }\r\n+  console.log('ğŸ”§ ComfyUIè°ƒè¯•å‡½æ•°å·²æš´éœ²åˆ° window.comfyUIDebug')\r\n+  console.log('ğŸ”§ å¯ç”¨è°ƒè¯•å‡½æ•°:', Object.keys(window.comfyUIDebug))\r\n+}\r\n"
                },
                {
                    "date": 1752466422415,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -845,25 +845,59 @@\n             console.log('åŸå§‹æ¶ˆæ¯å†…å®¹:', event.data.substring(0, 500))\r\n             return\r\n           }\r\n \r\n-          // ComfyUIçš„æ¶ˆæ¯æ ¼å¼é€šå¸¸æ˜¯ { type: \"...\", data: {...} }\r\n-          console.log(`ğŸ“‹ WebSocketæ¶ˆæ¯ç»“æ„:`, message)\r\n-          console.log(`ğŸ“‹ æ¶ˆæ¯ç±»å‹: ${message.type}`)\r\n-          console.log(`ğŸ“‹ æ¶ˆæ¯æ•°æ®:`, message.data)\r\n+          // ComfyUIçš„æ¶ˆæ¯æ ¼å¼å¯èƒ½æœ‰å¤šç§ï¼š\r\n+          // 1. { type: \"...\", data: {...} }\r\n+          // 2. ç›´æ¥çš„æ¶ˆæ¯å¯¹è±¡\r\n+          console.log(`ğŸ“‹ WebSocketæ¶ˆæ¯å®Œæ•´ç»“æ„:`, JSON.stringify(message, null, 2))\r\n \r\n+          // æ£€æŸ¥æ¶ˆæ¯æ ¼å¼å¹¶æ ‡å‡†åŒ–\r\n+          let normalizedMessage = message;\r\n+          if (message.type && message.data) {\r\n+            // æ ‡å‡†æ ¼å¼ï¼š{ type: \"...\", data: {...} }\r\n+            console.log(`ğŸ“‹ æ ‡å‡†æ ¼å¼æ¶ˆæ¯ - ç±»å‹: ${message.type}`)\r\n+          } else if (typeof message === 'object') {\r\n+            // å¯èƒ½æ˜¯ç›´æ¥çš„æ¶ˆæ¯å¯¹è±¡ï¼Œå°è¯•æ¨æ–­ç±»å‹\r\n+            console.log(`ğŸ“‹ æ£€æµ‹æ¶ˆæ¯å¯¹è±¡ç»“æ„:`, Object.keys(message))\r\n+\r\n+            // æ£€æŸ¥æ˜¯å¦æ˜¯æ‰§è¡Œå®Œæˆæ¶ˆæ¯çš„å…¶ä»–æ ¼å¼\r\n+            if (message.prompt_id && (message.output || message.outputs)) {\r\n+              console.log(`ğŸ¯ æ£€æµ‹åˆ°å¯èƒ½çš„æ‰§è¡Œå®Œæˆæ¶ˆæ¯æ ¼å¼`)\r\n+              normalizedMessage = {\r\n+                type: 'executed',\r\n+                data: message\r\n+              }\r\n+            } else if (message.prompt_id && message.node) {\r\n+              console.log(`ğŸ”„ æ£€æµ‹åˆ°å¯èƒ½çš„æ‰§è¡Œä¸­æ¶ˆæ¯æ ¼å¼`)\r\n+              normalizedMessage = {\r\n+                type: 'executing',\r\n+                data: message\r\n+              }\r\n+            } else if (message.prompt_id && (message.value !== undefined && message.max !== undefined)) {\r\n+              console.log(`ğŸ“ˆ æ£€æµ‹åˆ°å¯èƒ½çš„è¿›åº¦æ¶ˆæ¯æ ¼å¼`)\r\n+              normalizedMessage = {\r\n+                type: 'progress',\r\n+                data: message\r\n+              }\r\n+            }\r\n+          }\r\n+\r\n           // å¯¹å…³é”®æ¶ˆæ¯ç±»å‹æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯å’Œæ˜æ˜¾æ ‡è®°\r\n-          if (['executed', 'execution_error', 'progress', 'executing', 'status'].includes(message.type)) {\r\n-            console.log(`ğŸ”¥ğŸ”¥ğŸ”¥ é‡è¦æ¶ˆæ¯: ${message.type.toUpperCase()} ğŸ”¥ğŸ”¥ğŸ”¥`)\r\n-            console.log(`ğŸ“Š å®Œæ•´æ¶ˆæ¯è¯¦æƒ…:`, JSON.stringify(message, null, 2))\r\n+          if (['executed', 'execution_error', 'progress', 'executing', 'status'].includes(normalizedMessage.type)) {\r\n+            console.log(`ğŸ”¥ğŸ”¥ğŸ”¥ é‡è¦æ¶ˆæ¯: ${normalizedMessage.type.toUpperCase()} ğŸ”¥ğŸ”¥ğŸ”¥`)\r\n+            console.log(`ğŸ“Š æ ‡å‡†åŒ–åçš„æ¶ˆæ¯:`, JSON.stringify(normalizedMessage, null, 2))\r\n \r\n             // ç‰¹åˆ«å…³æ³¨executedæ¶ˆæ¯\r\n-            if (message.type === 'executed' && message.data && message.data.prompt_id) {\r\n-              console.log(`ğŸ¯ğŸ¯ğŸ¯ æ£€æµ‹åˆ°ä»»åŠ¡å®Œæˆæ¶ˆæ¯! ä»»åŠ¡ID: ${message.data.prompt_id} ğŸ¯ğŸ¯ğŸ¯`)\r\n+            if (normalizedMessage.type === 'executed') {\r\n+              const data = normalizedMessage.data;\r\n+              if (data && data.prompt_id) {\r\n+                console.log(`ğŸ¯ğŸ¯ğŸ¯ æ£€æµ‹åˆ°ä»»åŠ¡å®Œæˆæ¶ˆæ¯! ä»»åŠ¡ID: ${data.prompt_id} ğŸ¯ğŸ¯ğŸ¯`)\r\n+              }\r\n             }\r\n           }\r\n \r\n-          handleWebSocketMessage(message)\r\n+          handleWebSocketMessage(normalizedMessage)\r\n         } catch (error) {\r\n           console.error('âŒ å¤„ç†WebSocketæ¶ˆæ¯å¤±è´¥:', error)\r\n           console.log('é—®é¢˜æ¶ˆæ¯å†…å®¹:', event.data.substring(0, 500))\r\n         }\r\n"
                },
                {
                    "date": 1752466592818,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1008,10 +1008,19 @@\n   console.log('ğŸ‰ğŸ‰ğŸ‰ ComfyUI ä»»åŠ¡æ‰§è¡Œå®Œæˆ! ğŸ‰ğŸ‰ğŸ‰')\r\n   console.log('ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯')\r\n   console.log(`ğŸ“£ æ‰§è¡Œå®Œæˆæ¶ˆæ¯è¯¦æƒ…:`, data)\r\n \r\n+  // å°è¯•ä»ä¸åŒçš„å­—æ®µè·å–prompt_id\r\n+  let promptId = null;\r\n   if (data && data.prompt_id) {\r\n-    const promptId = data.prompt_id\r\n+    promptId = data.prompt_id;\r\n+  } else if (data && data.id) {\r\n+    promptId = data.id;\r\n+  } else if (data && typeof data === 'string') {\r\n+    promptId = data;\r\n+  }\r\n+\r\n+  if (promptId) {\r\n     console.log(`ğŸ” æŸ¥æ‰¾ä»»åŠ¡: ${promptId}`)\r\n     console.log(`ğŸ“‹ å½“å‰å¾…å¤„ç†ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n \r\n     const task = pendingTasks.get(promptId)\r\n@@ -1020,25 +1029,26 @@\n \r\n       // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n       showWebSocketStatusNotification(`ä»»åŠ¡ ${promptId.substring(0, 8)} å¤„ç†å®Œæˆ!`, 'success')\r\n \r\n-      // è·å–å®Œæ•´çš„å†å²è®°å½•\r\n-      checkTaskStatus(promptId).then(result => {\r\n-        console.log('ğŸŠğŸŠğŸŠ æˆåŠŸè·å–ä»»åŠ¡å®Œæ•´ç»“æœ ğŸŠğŸŠğŸŠ')\r\n-        console.log(`ğŸ“‹ ä»»åŠ¡ ${promptId} çš„å®Œæ•´ç»“æœ:`, result)\r\n+      // ç›´æ¥ä½¿ç”¨WebSocketæ¶ˆæ¯ä¸­çš„æ•°æ®ï¼Œå¦‚æœæœ‰çš„è¯\r\n+      if (data.output || data.outputs) {\r\n+        console.log('ğŸš€ ç›´æ¥ä½¿ç”¨WebSocketæ¶ˆæ¯ä¸­çš„è¾“å‡ºæ•°æ®')\r\n+        const result = {\r\n+          outputs: data.output || data.outputs,\r\n+          status: { completed: true }\r\n+        };\r\n \r\n         if (task.onComplete) {\r\n-          console.log('ğŸš€ğŸš€ğŸš€ è§¦å‘ä»»åŠ¡å®Œæˆå›è°ƒå‡½æ•° ğŸš€ğŸš€ğŸš€')\r\n+          console.log('ğŸš€ğŸš€ğŸš€ ç›´æ¥è§¦å‘ä»»åŠ¡å®Œæˆå›è°ƒå‡½æ•° ğŸš€ğŸš€ğŸš€')\r\n           console.log('ğŸ¯ å³å°†è¿”å›å¤„ç†ç»“æœåˆ°å‰ç«¯ç•Œé¢...')\r\n \r\n           // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥\r\n           showWebSocketStatusNotification('å›¾ç‰‡å¤„ç†æˆåŠŸï¼Œæ­£åœ¨åŠ è½½ç»“æœ...', 'success')\r\n \r\n           task.onComplete(result)\r\n \r\n           console.log('âœ…âœ…âœ… ä»»åŠ¡å®Œæˆå›è°ƒå·²æ‰§è¡Œï¼Œç»“æœå·²è¿”å›å‰ç«¯ âœ…âœ…âœ…')\r\n-        } else {\r\n-          console.warn(`âš ï¸âš ï¸âš ï¸ ä»»åŠ¡ ${promptId} æ²¡æœ‰å®Œæˆå›è°ƒå‡½æ•°! âš ï¸âš ï¸âš ï¸`)\r\n         }\r\n \r\n         pendingTasks.delete(promptId)\r\n         console.log(`ğŸ—‘ï¸ å·²åˆ é™¤å®Œæˆçš„ä»»åŠ¡ ${promptId}ï¼Œå‰©ä½™ä»»åŠ¡æ•°: ${pendingTasks.size}`)\r\n@@ -1046,30 +1056,92 @@\n         console.log('ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰')\r\n         console.log('ğŸŠ ComfyUI å¤„ç†æµç¨‹å®Œå…¨ç»“æŸ! ğŸŠ')\r\n         console.log('ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰')\r\n \r\n-      }).catch(error => {\r\n-        console.error('âŒâŒâŒ è·å–ä»»åŠ¡ç»“æœå¤±è´¥ âŒâŒâŒ', error)\r\n-        console.error(`âŒ ä»»åŠ¡ ${promptId} ç»“æœè·å–å¤±è´¥:`, error)\r\n+      } else {\r\n+        // å¦‚æœWebSocketæ¶ˆæ¯ä¸­æ²¡æœ‰è¾“å‡ºæ•°æ®ï¼Œåˆ™æŸ¥è¯¢å†å²è®°å½•\r\n+        console.log('ğŸ“¥ WebSocketæ¶ˆæ¯ä¸­æ— è¾“å‡ºæ•°æ®ï¼ŒæŸ¥è¯¢å†å²è®°å½•...')\r\n+        checkTaskStatus(promptId).then(result => {\r\n+          console.log('ğŸŠğŸŠğŸŠ æˆåŠŸè·å–ä»»åŠ¡å®Œæ•´ç»“æœ ğŸŠğŸŠğŸŠ')\r\n+          console.log(`ğŸ“‹ ä»»åŠ¡ ${promptId} çš„å®Œæ•´ç»“æœ:`, result)\r\n \r\n-        // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥\r\n-        showWebSocketStatusNotification('è·å–å¤„ç†ç»“æœå¤±è´¥', 'error')\r\n+          if (task.onComplete) {\r\n+            console.log('ğŸš€ğŸš€ğŸš€ è§¦å‘ä»»åŠ¡å®Œæˆå›è°ƒå‡½æ•° ğŸš€ğŸš€ğŸš€')\r\n+            console.log('ğŸ¯ å³å°†è¿”å›å¤„ç†ç»“æœåˆ°å‰ç«¯ç•Œé¢...')\r\n \r\n-        if (task.onError) {\r\n-          task.onError(error.message)\r\n-        }\r\n-        pendingTasks.delete(promptId)\r\n-      })\r\n+            // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥\r\n+            showWebSocketStatusNotification('å›¾ç‰‡å¤„ç†æˆåŠŸï¼Œæ­£åœ¨åŠ è½½ç»“æœ...', 'success')\r\n+\r\n+            task.onComplete(result)\r\n+\r\n+            console.log('âœ…âœ…âœ… ä»»åŠ¡å®Œæˆå›è°ƒå·²æ‰§è¡Œï¼Œç»“æœå·²è¿”å›å‰ç«¯ âœ…âœ…âœ…')\r\n+          } else {\r\n+            console.warn(`âš ï¸âš ï¸âš ï¸ ä»»åŠ¡ ${promptId} æ²¡æœ‰å®Œæˆå›è°ƒå‡½æ•°! âš ï¸âš ï¸âš ï¸`)\r\n+          }\r\n+\r\n+          pendingTasks.delete(promptId)\r\n+          console.log(`ğŸ—‘ï¸ å·²åˆ é™¤å®Œæˆçš„ä»»åŠ¡ ${promptId}ï¼Œå‰©ä½™ä»»åŠ¡æ•°: ${pendingTasks.size}`)\r\n+\r\n+          console.log('ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰')\r\n+          console.log('ğŸŠ ComfyUI å¤„ç†æµç¨‹å®Œå…¨ç»“æŸ! ğŸŠ')\r\n+          console.log('ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰')\r\n+\r\n+        }).catch(error => {\r\n+          console.error('âŒâŒâŒ è·å–ä»»åŠ¡ç»“æœå¤±è´¥ âŒâŒâŒ', error)\r\n+          console.error(`âŒ ä»»åŠ¡ ${promptId} ç»“æœè·å–å¤±è´¥:`, error)\r\n+\r\n+          // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥\r\n+          showWebSocketStatusNotification('è·å–å¤„ç†ç»“æœå¤±è´¥', 'error')\r\n+\r\n+          if (task.onError) {\r\n+            task.onError(error.message)\r\n+          }\r\n+          pendingTasks.delete(promptId)\r\n+        })\r\n+      }\r\n     } else {\r\n       console.warn('âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸')\r\n       console.warn(`âš ï¸ æ”¶åˆ°æœªçŸ¥ä»»åŠ¡ ${promptId} çš„æ‰§è¡Œå®Œæˆæ¶ˆæ¯`)\r\n       console.warn('âš ï¸ å¯èƒ½çš„åŸå› : 1) ä»»åŠ¡å·²è¢«æ¸…ç† 2) ä»»åŠ¡IDä¸åŒ¹é… 3) é‡å¤æ¶ˆæ¯')\r\n       console.warn(`âš ï¸ å½“å‰ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n       console.warn('âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸')\r\n+\r\n+      // å°è¯•é€šè¿‡æ¨¡ç³ŠåŒ¹é…æ‰¾åˆ°ä»»åŠ¡\r\n+      const allTasks = Array.from(pendingTasks.keys());\r\n+      const partialMatch = allTasks.find(taskId => taskId.includes(promptId) || promptId.includes(taskId));\r\n+      if (partialMatch) {\r\n+        console.log(`ğŸ” æ‰¾åˆ°éƒ¨åˆ†åŒ¹é…çš„ä»»åŠ¡: ${partialMatch}ï¼Œå°è¯•å¤„ç†...`);\r\n+        const matchedTask = pendingTasks.get(partialMatch);\r\n+        if (matchedTask && matchedTask.onComplete) {\r\n+          console.log('ğŸš€ è§¦å‘éƒ¨åˆ†åŒ¹é…ä»»åŠ¡çš„å®Œæˆå›è°ƒ');\r\n+          const result = {\r\n+            outputs: data.output || data.outputs || {},\r\n+            status: { completed: true }\r\n+          };\r\n+          matchedTask.onComplete(result);\r\n+          pendingTasks.delete(partialMatch);\r\n+        }\r\n+      }\r\n     }\r\n   } else {\r\n     console.warn('âš ï¸âš ï¸âš ï¸ æ”¶åˆ°æ— æ•ˆçš„æ‰§è¡Œå®Œæˆæ¶ˆæ¯ âš ï¸âš ï¸âš ï¸')\r\n     console.warn('æ¶ˆæ¯å†…å®¹:', data)\r\n+\r\n+    // å¦‚æœæ²¡æœ‰prompt_idä½†æœ‰è¾“å‡ºæ•°æ®ï¼Œå°è¯•å¤„ç†ç¬¬ä¸€ä¸ªå¾…å¤„ç†ä»»åŠ¡\r\n+    if ((data.output || data.outputs) && pendingTasks.size > 0) {\r\n+      console.log('ğŸ” å°è¯•å°†ç»“æœåˆ†é…ç»™ç¬¬ä¸€ä¸ªå¾…å¤„ç†ä»»åŠ¡...');\r\n+      const firstTaskId = Array.from(pendingTasks.keys())[0];\r\n+      const firstTask = pendingTasks.get(firstTaskId);\r\n+      if (firstTask && firstTask.onComplete) {\r\n+        console.log(`ğŸš€ å°†ç»“æœåˆ†é…ç»™ä»»åŠ¡: ${firstTaskId}`);\r\n+        const result = {\r\n+          outputs: data.output || data.outputs,\r\n+          status: { completed: true }\r\n+        };\r\n+        firstTask.onComplete(result);\r\n+        pendingTasks.delete(firstTaskId);\r\n+      }\r\n+    }\r\n   }\r\n }\r\n \r\n // å¤„ç†æ‰§è¡Œé”™è¯¯æ¶ˆæ¯\r\n"
                },
                {
                    "date": 1752466860214,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -908,9 +908,9 @@\n     throw error\r\n   }\r\n }\r\n \r\n-// å¤„ç† WebSocket æ¶ˆæ¯\r\n+// å¤„ç† WebSocket æ¶ˆæ¯ - æ ¹æ®ComfyUIå®˜æ–¹æ–‡æ¡£è§„èŒƒ\r\n function handleWebSocketMessage(message) {\r\n   try {\r\n     const { type, data } = message\r\n \r\n@@ -919,40 +919,46 @@\n     console.log(`æ¶ˆæ¯æ•°æ®:`, data)\r\n \r\n     switch (type) {\r\n       case 'status':\r\n-        console.log('ğŸ”„ å¤„ç†çŠ¶æ€æ¶ˆæ¯')\r\n+        console.log('ğŸ“Š å¤„ç†é˜Ÿåˆ—çŠ¶æ€æ¶ˆæ¯')\r\n         handleStatusMessage(data)\r\n         break\r\n       case 'progress':\r\n         console.log('ğŸ“ˆ å¤„ç†è¿›åº¦æ¶ˆæ¯')\r\n         handleProgressMessage(data)\r\n         break\r\n+      case 'executing':\r\n+        console.log('ğŸ”„ å¤„ç†æ­£åœ¨æ‰§è¡Œæ¶ˆæ¯')\r\n+        handleExecutingMessage(data)\r\n+        break\r\n       case 'executed':\r\n-        console.log('ğŸ‰ å¤„ç†æ‰§è¡Œå®Œæˆæ¶ˆæ¯')\r\n+        console.log('ğŸ¯ å¤„ç†èŠ‚ç‚¹æ‰§è¡Œå®Œæˆæ¶ˆæ¯ï¼ˆUIæ›´æ–°ï¼‰')\r\n         handleExecutedMessage(data)\r\n         break\r\n+      case 'execution_start':\r\n+        console.log('ğŸš€ å¤„ç†æ‰§è¡Œå¼€å§‹æ¶ˆæ¯')\r\n+        handleExecutionStartMessage(data)\r\n+        break\r\n+      case 'execution_success':\r\n+        console.log('ğŸ‰ğŸ‰ğŸ‰ å¤„ç†æ‰§è¡ŒæˆåŠŸæ¶ˆæ¯ ğŸ‰ğŸ‰ğŸ‰')\r\n+        handleExecutionSuccessMessage(data)\r\n+        break\r\n       case 'execution_error':\r\n         console.log('âŒ å¤„ç†æ‰§è¡Œé”™è¯¯æ¶ˆæ¯')\r\n         handleExecutionErrorMessage(data)\r\n         break\r\n-      case 'executing':\r\n-        console.log('ğŸ”„ å¤„ç†æ­£åœ¨æ‰§è¡Œæ¶ˆæ¯')\r\n-        handleExecutingMessage(data)\r\n+      case 'execution_interrupted':\r\n+        console.log('â¸ï¸ å¤„ç†æ‰§è¡Œä¸­æ–­æ¶ˆæ¯')\r\n+        handleExecutionInterruptedMessage(data)\r\n         break\r\n+      case 'execution_cached':\r\n+        console.log('ğŸ’¾ å¤„ç†æ‰§è¡Œç¼“å­˜æ¶ˆæ¯')\r\n+        handleExecutionCachedMessage(data)\r\n+        break\r\n       default:\r\n         console.log(`ğŸ” æ”¶åˆ°æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹: ${type}`)\r\n         console.log(`æœªå¤„ç†æ¶ˆæ¯çš„å®Œæ•´å†…å®¹:`, JSON.stringify(message, null, 2))\r\n-\r\n-        // å°è¯•æ£€æŸ¥æ˜¯å¦æ˜¯å…¶ä»–æ ¼å¼çš„æ‰§è¡Œå®Œæˆæ¶ˆæ¯\r\n-        if (data && (data.prompt_id || data.node || data.output)) {\r\n-          console.log('ğŸ” å¯èƒ½æ˜¯ç‰¹æ®Šæ ¼å¼çš„ä»»åŠ¡ç›¸å…³æ¶ˆæ¯ï¼Œå°è¯•å¤„ç†...')\r\n-          if (data.prompt_id) {\r\n-            console.log(`ğŸ¯ å‘ç°ä»»åŠ¡ID: ${data.prompt_id}`)\r\n-            // å°è¯•ä½œä¸ºæ‰§è¡Œå®Œæˆæ¶ˆæ¯å¤„ç†\r\n-            handleExecutedMessage(data)\r\n-          }\r\n-        }\r\n     }\r\n \r\n     // è§¦å‘æ³¨å†Œçš„æ¶ˆæ¯å¤„ç†å™¨\r\n     if (wsMessageHandlers.has(type)) {\r\n"
                },
                {
                    "date": 1752466902136,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -976,15 +976,139 @@\n     console.log('é—®é¢˜æ¶ˆæ¯:', JSON.stringify(message, null, 2))\r\n   }\r\n }\r\n \r\n-// å¤„ç†çŠ¶æ€æ¶ˆæ¯\r\n+// å¤„ç†çŠ¶æ€æ¶ˆæ¯ - é˜Ÿåˆ—çŠ¶æ€å˜åŒ–\r\n function handleStatusMessage(data) {\r\n-  if (data && data.sid) {\r\n-    console.log(`ğŸ“Š é˜Ÿåˆ—çŠ¶æ€æ›´æ–°: æ‰§è¡Œä¸­=${data.status?.exec_info?.queue_remaining || 0}`)\r\n+  if (data && data.exec_info) {\r\n+    const queueRemaining = data.exec_info.queue_remaining || 0\r\n+    console.log(`ğŸ“Š é˜Ÿåˆ—çŠ¶æ€æ›´æ–°: å‰©ä½™ä»»åŠ¡=${queueRemaining}`)\r\n+\r\n+    // æ˜¾ç¤ºé˜Ÿåˆ—çŠ¶æ€é€šçŸ¥\r\n+    if (queueRemaining === 0) {\r\n+      showWebSocketStatusNotification('é˜Ÿåˆ—å·²æ¸…ç©º', 'info')\r\n+    } else {\r\n+      showWebSocketStatusNotification(`é˜Ÿåˆ—ä¸­è¿˜æœ‰ ${queueRemaining} ä¸ªä»»åŠ¡`, 'info')\r\n+    }\r\n   }\r\n }\r\n \r\n+// å¤„ç†æ‰§è¡Œå¼€å§‹æ¶ˆæ¯\r\n+function handleExecutionStartMessage(data) {\r\n+  if (data && data.prompt_id) {\r\n+    const promptId = data.prompt_id\r\n+    console.log(`ğŸš€ ä»»åŠ¡å¼€å§‹æ‰§è¡Œ: ${promptId}`)\r\n+\r\n+    const task = pendingTasks.get(promptId)\r\n+    if (task && task.onProgress) {\r\n+      task.onProgress('å¼€å§‹æ‰§è¡Œ', 5)\r\n+    }\r\n+\r\n+    showWebSocketStatusNotification(`ä»»åŠ¡ ${promptId.substring(0, 8)} å¼€å§‹æ‰§è¡Œ`, 'info')\r\n+  }\r\n+}\r\n+\r\n+// å¤„ç†æ‰§è¡ŒæˆåŠŸæ¶ˆæ¯ - è¿™æ˜¯å…³é”®çš„å®Œæˆæ¶ˆæ¯ï¼\r\n+function handleExecutionSuccessMessage(data) {\r\n+  console.log('ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯')\r\n+  console.log('ğŸ‰ğŸ‰ğŸ‰ ComfyUI æ‰§è¡ŒæˆåŠŸ! æ‰€æœ‰èŠ‚ç‚¹å·²å®Œæˆ! ğŸ‰ğŸ‰ğŸ‰')\r\n+  console.log('ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯')\r\n+  console.log(`ğŸ“£ æ‰§è¡ŒæˆåŠŸæ¶ˆæ¯è¯¦æƒ…:`, data)\r\n+\r\n+  if (data && data.prompt_id) {\r\n+    const promptId = data.prompt_id\r\n+    console.log(`ğŸ” æŸ¥æ‰¾ä»»åŠ¡: ${promptId}`)\r\n+    console.log(`ğŸ“‹ å½“å‰å¾…å¤„ç†ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n+\r\n+    const task = pendingTasks.get(promptId)\r\n+    if (task) {\r\n+      console.log('âœ…âœ…âœ… æ‰¾åˆ°å¯¹åº”ä»»åŠ¡ï¼Œæ‰§è¡Œå·²æˆåŠŸå®Œæˆ âœ…âœ…âœ…')\r\n+\r\n+      // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n+      showWebSocketStatusNotification(`ä»»åŠ¡ ${promptId.substring(0, 8)} æ‰§è¡ŒæˆåŠŸ!`, 'success')\r\n+\r\n+      // è·å–å®Œæ•´çš„å†å²è®°å½•æ¥è·å–è¾“å‡ºç»“æœ\r\n+      console.log('ğŸ“¥ è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ...')\r\n+      checkTaskStatus(promptId).then(result => {\r\n+        console.log('ğŸŠğŸŠğŸŠ æˆåŠŸè·å–ä»»åŠ¡å®Œæ•´ç»“æœ ğŸŠğŸŠğŸŠ')\r\n+        console.log(`ğŸ“‹ ä»»åŠ¡ ${promptId} çš„å®Œæ•´ç»“æœ:`, result)\r\n+\r\n+        if (task.onComplete) {\r\n+          console.log('ğŸš€ğŸš€ğŸš€ è§¦å‘ä»»åŠ¡å®Œæˆå›è°ƒå‡½æ•° ğŸš€ğŸš€ğŸš€')\r\n+          console.log('ğŸ¯ å³å°†è¿”å›å¤„ç†ç»“æœåˆ°å‰ç«¯ç•Œé¢...')\r\n+\r\n+          // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥\r\n+          showWebSocketStatusNotification('å›¾ç‰‡å¤„ç†æˆåŠŸï¼Œæ­£åœ¨åŠ è½½ç»“æœ...', 'success')\r\n+\r\n+          task.onComplete(result)\r\n+\r\n+          console.log('âœ…âœ…âœ… ä»»åŠ¡å®Œæˆå›è°ƒå·²æ‰§è¡Œï¼Œç»“æœå·²è¿”å›å‰ç«¯ âœ…âœ…âœ…')\r\n+        } else {\r\n+          console.warn(`âš ï¸âš ï¸âš ï¸ ä»»åŠ¡ ${promptId} æ²¡æœ‰å®Œæˆå›è°ƒå‡½æ•°! âš ï¸âš ï¸âš ï¸`)\r\n+        }\r\n+\r\n+        pendingTasks.delete(promptId)\r\n+        console.log(`ğŸ—‘ï¸ å·²åˆ é™¤å®Œæˆçš„ä»»åŠ¡ ${promptId}ï¼Œå‰©ä½™ä»»åŠ¡æ•°: ${pendingTasks.size}`)\r\n+\r\n+        console.log('ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰')\r\n+        console.log('ğŸŠ ComfyUI å¤„ç†æµç¨‹å®Œå…¨ç»“æŸ! ğŸŠ')\r\n+        console.log('ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰')\r\n+\r\n+      }).catch(error => {\r\n+        console.error('âŒâŒâŒ è·å–ä»»åŠ¡ç»“æœå¤±è´¥ âŒâŒâŒ', error)\r\n+        console.error(`âŒ ä»»åŠ¡ ${promptId} ç»“æœè·å–å¤±è´¥:`, error)\r\n+\r\n+        // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥\r\n+        showWebSocketStatusNotification('è·å–å¤„ç†ç»“æœå¤±è´¥', 'error')\r\n+\r\n+        if (task.onError) {\r\n+          task.onError(error.message)\r\n+        }\r\n+        pendingTasks.delete(promptId)\r\n+      })\r\n+    } else {\r\n+      console.warn('âš ï¸âš ï¸âš ï¸ æ”¶åˆ°æœªçŸ¥ä»»åŠ¡çš„æ‰§è¡ŒæˆåŠŸæ¶ˆæ¯ âš ï¸âš ï¸âš ï¸')\r\n+      console.warn(`âš ï¸ ä»»åŠ¡ID: ${promptId}`)\r\n+      console.warn(`âš ï¸ å½“å‰ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n+    }\r\n+  } else {\r\n+    console.warn('âš ï¸âš ï¸âš ï¸ æ”¶åˆ°æ— æ•ˆçš„æ‰§è¡ŒæˆåŠŸæ¶ˆæ¯ âš ï¸âš ï¸âš ï¸')\r\n+    console.warn('æ¶ˆæ¯å†…å®¹:', data)\r\n+  }\r\n+}\r\n+\r\n+// å¤„ç†æ‰§è¡Œä¸­æ–­æ¶ˆæ¯\r\n+function handleExecutionInterruptedMessage(data) {\r\n+  if (data && data.prompt_id) {\r\n+    const promptId = data.prompt_id\r\n+    console.log(`â¸ï¸ ä»»åŠ¡æ‰§è¡Œè¢«ä¸­æ–­: ${promptId}`)\r\n+\r\n+    const task = pendingTasks.get(promptId)\r\n+    if (task && task.onError) {\r\n+      task.onError('ä»»åŠ¡æ‰§è¡Œè¢«ä¸­æ–­')\r\n+    }\r\n+\r\n+    pendingTasks.delete(promptId)\r\n+    showWebSocketStatusNotification(`ä»»åŠ¡ ${promptId.substring(0, 8)} è¢«ä¸­æ–­`, 'warning')\r\n+  }\r\n+}\r\n+\r\n+// å¤„ç†æ‰§è¡Œç¼“å­˜æ¶ˆæ¯\r\n+function handleExecutionCachedMessage(data) {\r\n+  if (data && data.prompt_id) {\r\n+    const promptId = data.prompt_id\r\n+    const cachedNodes = data.nodes || []\r\n+    console.log(`ğŸ’¾ ä»»åŠ¡ä½¿ç”¨ç¼“å­˜: ${promptId}, ç¼“å­˜èŠ‚ç‚¹æ•°: ${cachedNodes.length}`)\r\n+\r\n+    const task = pendingTasks.get(promptId)\r\n+    if (task && task.onProgress) {\r\n+      task.onProgress(`ä½¿ç”¨ç¼“å­˜ (${cachedNodes.length}ä¸ªèŠ‚ç‚¹)`, 30)\r\n+    }\r\n+\r\n+    showWebSocketStatusNotification(`ä½¿ç”¨ç¼“å­˜åŠ é€Ÿå¤„ç†`, 'info')\r\n+  }\r\n+}\r\n+\r\n // å¤„ç†è¿›åº¦æ¶ˆæ¯\r\n function handleProgressMessage(data) {\r\n   if (data && data.prompt_id) {\r\n     const promptId = data.prompt_id\r\n"
                },
                {
                    "date": 1752466926415,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1107,24 +1107,25 @@\n     showWebSocketStatusNotification(`ä½¿ç”¨ç¼“å­˜åŠ é€Ÿå¤„ç†`, 'info')\r\n   }\r\n }\r\n \r\n-// å¤„ç†è¿›åº¦æ¶ˆæ¯\r\n+// å¤„ç†è¿›åº¦æ¶ˆæ¯ - æ ¹æ®å®˜æ–¹æ–‡æ¡£è§„èŒƒ\r\n function handleProgressMessage(data) {\r\n-  if (data && data.prompt_id) {\r\n+  if (data && data.prompt_id && data.value !== undefined && data.max !== undefined) {\r\n     const promptId = data.prompt_id\r\n+    const nodeId = data.node\r\n+    const progress = Math.round((data.value / data.max) * 100)\r\n+\r\n+    console.log('ğŸ“ˆğŸ“ˆğŸ“ˆ ComfyUI å¤„ç†è¿›åº¦æ›´æ–° ğŸ“ˆğŸ“ˆğŸ“ˆ')\r\n+    console.log(`ğŸ“ˆ ä»»åŠ¡ ${promptId} è¿›åº¦: ${progress}% (${data.value}/${data.max})`)\r\n+    console.log(`ğŸ”„ å½“å‰å¤„ç†èŠ‚ç‚¹: ${nodeId || 'æœªçŸ¥'}`)\r\n+\r\n     const task = pendingTasks.get(promptId)\r\n-\r\n     if (task && task.onProgress) {\r\n-      const progress = Math.round((data.value / data.max) * 100)\r\n-      console.log('ğŸ“ˆğŸ“ˆğŸ“ˆ ComfyUI å¤„ç†è¿›åº¦æ›´æ–° ğŸ“ˆğŸ“ˆğŸ“ˆ')\r\n-      console.log(`ğŸ“ˆ ä»»åŠ¡ ${promptId} è¿›åº¦: ${progress}% (${data.value}/${data.max})`)\r\n-      console.log(`ğŸ”„ å½“å‰å¤„ç†èŠ‚ç‚¹: ${data.node || 'æœªçŸ¥'}`)\r\n-\r\n       // æ˜¾ç¤ºè¿›åº¦é€šçŸ¥\r\n       showWebSocketStatusNotification(`å¤„ç†è¿›åº¦: ${progress}%`, 'info')\r\n \r\n-      task.onProgress(progress, 'processing')\r\n+      task.onProgress(progress, `å¤„ç†èŠ‚ç‚¹ ${nodeId || ''}`)\r\n     } else {\r\n       console.log(`ğŸ“ˆ æ”¶åˆ°ä»»åŠ¡ ${promptId} çš„è¿›åº¦æ¶ˆæ¯ï¼Œä½†æœªæ‰¾åˆ°å¯¹åº”ä»»åŠ¡`)\r\n     }\r\n   } else {\r\n"
                },
                {
                    "date": 1752466949515,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1288,24 +1288,36 @@\n     }\r\n   }\r\n }\r\n \r\n-// å¤„ç†æ­£åœ¨æ‰§è¡Œæ¶ˆæ¯\r\n+// å¤„ç†æ­£åœ¨æ‰§è¡Œæ¶ˆæ¯ - æ ¹æ®å®˜æ–¹æ–‡æ¡£è§„èŒƒ\r\n function handleExecutingMessage(data) {\r\n   if (data && data.prompt_id) {\r\n     const promptId = data.prompt_id\r\n-    const task = pendingTasks.get(promptId)\r\n+    const nodeId = data.node\r\n \r\n-    if (task && task.onProgress) {\r\n-      console.log('ğŸ”„ğŸ”„ğŸ”„ ComfyUI å¼€å§‹æ‰§è¡Œä»»åŠ¡ ğŸ”„ğŸ”„ğŸ”„')\r\n-      console.log(`ğŸ”„ ä»»åŠ¡ ${promptId} æ­£åœ¨æ‰§è¡ŒèŠ‚ç‚¹: ${data.node || 'æœªçŸ¥'}`)\r\n+    console.log('ğŸ”„ğŸ”„ğŸ”„ ComfyUI èŠ‚ç‚¹æ‰§è¡ŒçŠ¶æ€æ›´æ–° ğŸ”„ğŸ”„ğŸ”„')\r\n \r\n-      // æ˜¾ç¤ºæ‰§è¡Œé€šçŸ¥\r\n-      showWebSocketStatusNotification(`æ­£åœ¨æ‰§è¡ŒèŠ‚ç‚¹: ${data.node || 'æœªçŸ¥'}`, 'info')\r\n+    if (nodeId === null || nodeId === undefined) {\r\n+      // nodeä¸ºnullè¡¨ç¤ºæ‰§è¡Œå®Œæˆ\r\n+      console.log(`âœ… ä»»åŠ¡ ${promptId} æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œå®Œæˆ`)\r\n \r\n-      task.onProgress(10, 'executing')\r\n+      const task = pendingTasks.get(promptId)\r\n+      if (task && task.onProgress) {\r\n+        task.onProgress(95, 'æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œå®Œæˆ')\r\n+      }\r\n+\r\n+      showWebSocketStatusNotification(`ä»»åŠ¡ ${promptId.substring(0, 8)} èŠ‚ç‚¹æ‰§è¡Œå®Œæˆ`, 'success')\r\n     } else {\r\n-      console.log(`ğŸ”„ æ”¶åˆ°ä»»åŠ¡ ${promptId} çš„æ‰§è¡Œæ¶ˆæ¯ï¼Œä½†æœªæ‰¾åˆ°å¯¹åº”ä»»åŠ¡`)\r\n+      // å¼€å§‹æ‰§è¡Œæ–°èŠ‚ç‚¹\r\n+      console.log(`ğŸ”„ ä»»åŠ¡ ${promptId} æ­£åœ¨æ‰§è¡ŒèŠ‚ç‚¹: ${nodeId}`)\r\n+\r\n+      const task = pendingTasks.get(promptId)\r\n+      if (task && task.onProgress) {\r\n+        task.onProgress(50, `æ‰§è¡ŒèŠ‚ç‚¹ ${nodeId}`)\r\n+      }\r\n+\r\n+      showWebSocketStatusNotification(`æ­£åœ¨æ‰§è¡ŒèŠ‚ç‚¹: ${nodeId}`, 'info')\r\n     }\r\n   } else {\r\n     console.warn('âš ï¸ æ”¶åˆ°æ— æ•ˆçš„æ‰§è¡Œæ¶ˆæ¯:', data)\r\n   }\r\n"
                },
                {
                    "date": 1752466966467,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1132,14 +1132,12 @@\n     console.warn('âš ï¸ æ”¶åˆ°æ— æ•ˆçš„è¿›åº¦æ¶ˆæ¯:', data)\r\n   }\r\n }\r\n \r\n-// å¤„ç†æ‰§è¡Œå®Œæˆæ¶ˆæ¯\r\n+// å¤„ç†èŠ‚ç‚¹æ‰§è¡Œå®Œæˆæ¶ˆæ¯ - å½“èŠ‚ç‚¹è¿”å›UIå…ƒç´ æ—¶\r\n function handleExecutedMessage(data) {\r\n-  console.log('ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯')\r\n-  console.log('ğŸ‰ğŸ‰ğŸ‰ ComfyUI ä»»åŠ¡æ‰§è¡Œå®Œæˆ! ğŸ‰ğŸ‰ğŸ‰')\r\n-  console.log('ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯')\r\n-  console.log(`ğŸ“£ æ‰§è¡Œå®Œæˆæ¶ˆæ¯è¯¦æƒ…:`, data)\r\n+  console.log('ğŸ¯ æ”¶åˆ°èŠ‚ç‚¹æ‰§è¡Œå®Œæˆæ¶ˆæ¯ï¼ˆUIæ›´æ–°ï¼‰')\r\n+  console.log(`ğŸ“£ èŠ‚ç‚¹æ‰§è¡Œæ¶ˆæ¯è¯¦æƒ…:`, data)\r\n \r\n   // å°è¯•ä»ä¸åŒçš„å­—æ®µè·å–prompt_id\r\n   let promptId = null;\r\n   if (data && data.prompt_id) {\r\n"
                },
                {
                    "date": 1752467009225,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1137,140 +1137,27 @@\n function handleExecutedMessage(data) {\r\n   console.log('ğŸ¯ æ”¶åˆ°èŠ‚ç‚¹æ‰§è¡Œå®Œæˆæ¶ˆæ¯ï¼ˆUIæ›´æ–°ï¼‰')\r\n   console.log(`ğŸ“£ èŠ‚ç‚¹æ‰§è¡Œæ¶ˆæ¯è¯¦æƒ…:`, data)\r\n \r\n-  // å°è¯•ä»ä¸åŒçš„å­—æ®µè·å–prompt_id\r\n-  let promptId = null;\r\n-  if (data && data.prompt_id) {\r\n-    promptId = data.prompt_id;\r\n-  } else if (data && data.id) {\r\n-    promptId = data.id;\r\n-  } else if (data && typeof data === 'string') {\r\n-    promptId = data;\r\n-  }\r\n+  // æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œexecutedæ¶ˆæ¯åªåœ¨èŠ‚ç‚¹è¿”å›UIå…ƒç´ æ—¶å‘é€\r\n+  // è¿™ä¸æ˜¯ä»»åŠ¡å®Œæˆçš„ä¿¡å·ï¼ŒçœŸæ­£çš„å®Œæˆä¿¡å·æ˜¯execution_success\r\n \r\n-  if (promptId) {\r\n-    console.log(`ğŸ” æŸ¥æ‰¾ä»»åŠ¡: ${promptId}`)\r\n-    console.log(`ğŸ“‹ å½“å‰å¾…å¤„ç†ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n+  if (data && data.prompt_id && data.node && data.output) {\r\n+    const promptId = data.prompt_id\r\n+    const nodeId = data.node\r\n \r\n+    console.log(`ğŸ¯ èŠ‚ç‚¹ ${nodeId} è¿”å›UIæ›´æ–°ï¼Œä»»åŠ¡: ${promptId}`)\r\n+    console.log(`ğŸ“‹ UIè¾“å‡º:`, data.output)\r\n+\r\n+    // è¿™é‡Œå¯ä»¥å¤„ç†ä¸­é—´ç»“æœæˆ–UIæ›´æ–°ï¼Œä½†ä¸åº”è¯¥è§¦å‘ä»»åŠ¡å®Œæˆ\r\n     const task = pendingTasks.get(promptId)\r\n-    if (task) {\r\n-      console.log('âœ…âœ…âœ… æ‰¾åˆ°å¯¹åº”ä»»åŠ¡ï¼Œå¼€å§‹è·å–å¤„ç†ç»“æœ âœ…âœ…âœ…')\r\n+    if (task && task.onProgress) {\r\n+      task.onProgress(80, `èŠ‚ç‚¹ ${nodeId} å®Œæˆ`)\r\n+    }\r\n \r\n-      // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n-      showWebSocketStatusNotification(`ä»»åŠ¡ ${promptId.substring(0, 8)} å¤„ç†å®Œæˆ!`, 'success')\r\n-\r\n-      // ç›´æ¥ä½¿ç”¨WebSocketæ¶ˆæ¯ä¸­çš„æ•°æ®ï¼Œå¦‚æœæœ‰çš„è¯\r\n-      if (data.output || data.outputs) {\r\n-        console.log('ğŸš€ ç›´æ¥ä½¿ç”¨WebSocketæ¶ˆæ¯ä¸­çš„è¾“å‡ºæ•°æ®')\r\n-        const result = {\r\n-          outputs: data.output || data.outputs,\r\n-          status: { completed: true }\r\n-        };\r\n-\r\n-        if (task.onComplete) {\r\n-          console.log('ğŸš€ğŸš€ğŸš€ ç›´æ¥è§¦å‘ä»»åŠ¡å®Œæˆå›è°ƒå‡½æ•° ğŸš€ğŸš€ğŸš€')\r\n-          console.log('ğŸ¯ å³å°†è¿”å›å¤„ç†ç»“æœåˆ°å‰ç«¯ç•Œé¢...')\r\n-\r\n-          // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥\r\n-          showWebSocketStatusNotification('å›¾ç‰‡å¤„ç†æˆåŠŸï¼Œæ­£åœ¨åŠ è½½ç»“æœ...', 'success')\r\n-\r\n-          task.onComplete(result)\r\n-\r\n-          console.log('âœ…âœ…âœ… ä»»åŠ¡å®Œæˆå›è°ƒå·²æ‰§è¡Œï¼Œç»“æœå·²è¿”å›å‰ç«¯ âœ…âœ…âœ…')\r\n-        }\r\n-\r\n-        pendingTasks.delete(promptId)\r\n-        console.log(`ğŸ—‘ï¸ å·²åˆ é™¤å®Œæˆçš„ä»»åŠ¡ ${promptId}ï¼Œå‰©ä½™ä»»åŠ¡æ•°: ${pendingTasks.size}`)\r\n-\r\n-        console.log('ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰')\r\n-        console.log('ğŸŠ ComfyUI å¤„ç†æµç¨‹å®Œå…¨ç»“æŸ! ğŸŠ')\r\n-        console.log('ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰')\r\n-\r\n-      } else {\r\n-        // å¦‚æœWebSocketæ¶ˆæ¯ä¸­æ²¡æœ‰è¾“å‡ºæ•°æ®ï¼Œåˆ™æŸ¥è¯¢å†å²è®°å½•\r\n-        console.log('ğŸ“¥ WebSocketæ¶ˆæ¯ä¸­æ— è¾“å‡ºæ•°æ®ï¼ŒæŸ¥è¯¢å†å²è®°å½•...')\r\n-        checkTaskStatus(promptId).then(result => {\r\n-          console.log('ğŸŠğŸŠğŸŠ æˆåŠŸè·å–ä»»åŠ¡å®Œæ•´ç»“æœ ğŸŠğŸŠğŸŠ')\r\n-          console.log(`ğŸ“‹ ä»»åŠ¡ ${promptId} çš„å®Œæ•´ç»“æœ:`, result)\r\n-\r\n-          if (task.onComplete) {\r\n-            console.log('ğŸš€ğŸš€ğŸš€ è§¦å‘ä»»åŠ¡å®Œæˆå›è°ƒå‡½æ•° ğŸš€ğŸš€ğŸš€')\r\n-            console.log('ğŸ¯ å³å°†è¿”å›å¤„ç†ç»“æœåˆ°å‰ç«¯ç•Œé¢...')\r\n-\r\n-            // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥\r\n-            showWebSocketStatusNotification('å›¾ç‰‡å¤„ç†æˆåŠŸï¼Œæ­£åœ¨åŠ è½½ç»“æœ...', 'success')\r\n-\r\n-            task.onComplete(result)\r\n-\r\n-            console.log('âœ…âœ…âœ… ä»»åŠ¡å®Œæˆå›è°ƒå·²æ‰§è¡Œï¼Œç»“æœå·²è¿”å›å‰ç«¯ âœ…âœ…âœ…')\r\n-          } else {\r\n-            console.warn(`âš ï¸âš ï¸âš ï¸ ä»»åŠ¡ ${promptId} æ²¡æœ‰å®Œæˆå›è°ƒå‡½æ•°! âš ï¸âš ï¸âš ï¸`)\r\n-          }\r\n-\r\n-          pendingTasks.delete(promptId)\r\n-          console.log(`ğŸ—‘ï¸ å·²åˆ é™¤å®Œæˆçš„ä»»åŠ¡ ${promptId}ï¼Œå‰©ä½™ä»»åŠ¡æ•°: ${pendingTasks.size}`)\r\n-\r\n-          console.log('ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰')\r\n-          console.log('ğŸŠ ComfyUI å¤„ç†æµç¨‹å®Œå…¨ç»“æŸ! ğŸŠ')\r\n-          console.log('ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰')\r\n-\r\n-        }).catch(error => {\r\n-          console.error('âŒâŒâŒ è·å–ä»»åŠ¡ç»“æœå¤±è´¥ âŒâŒâŒ', error)\r\n-          console.error(`âŒ ä»»åŠ¡ ${promptId} ç»“æœè·å–å¤±è´¥:`, error)\r\n-\r\n-          // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥\r\n-          showWebSocketStatusNotification('è·å–å¤„ç†ç»“æœå¤±è´¥', 'error')\r\n-\r\n-          if (task.onError) {\r\n-            task.onError(error.message)\r\n-          }\r\n-          pendingTasks.delete(promptId)\r\n-        })\r\n-      }\r\n-    } else {\r\n-      console.warn('âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸')\r\n-      console.warn(`âš ï¸ æ”¶åˆ°æœªçŸ¥ä»»åŠ¡ ${promptId} çš„æ‰§è¡Œå®Œæˆæ¶ˆæ¯`)\r\n-      console.warn('âš ï¸ å¯èƒ½çš„åŸå› : 1) ä»»åŠ¡å·²è¢«æ¸…ç† 2) ä»»åŠ¡IDä¸åŒ¹é… 3) é‡å¤æ¶ˆæ¯')\r\n-      console.warn(`âš ï¸ å½“å‰ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n-      console.warn('âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸')\r\n-\r\n-      // å°è¯•é€šè¿‡æ¨¡ç³ŠåŒ¹é…æ‰¾åˆ°ä»»åŠ¡\r\n-      const allTasks = Array.from(pendingTasks.keys());\r\n-      const partialMatch = allTasks.find(taskId => taskId.includes(promptId) || promptId.includes(taskId));\r\n-      if (partialMatch) {\r\n-        console.log(`ğŸ” æ‰¾åˆ°éƒ¨åˆ†åŒ¹é…çš„ä»»åŠ¡: ${partialMatch}ï¼Œå°è¯•å¤„ç†...`);\r\n-        const matchedTask = pendingTasks.get(partialMatch);\r\n-        if (matchedTask && matchedTask.onComplete) {\r\n-          console.log('ğŸš€ è§¦å‘éƒ¨åˆ†åŒ¹é…ä»»åŠ¡çš„å®Œæˆå›è°ƒ');\r\n-          const result = {\r\n-            outputs: data.output || data.outputs || {},\r\n-            status: { completed: true }\r\n-          };\r\n-          matchedTask.onComplete(result);\r\n-          pendingTasks.delete(partialMatch);\r\n-        }\r\n-      }\r\n-    }\r\n+    showWebSocketStatusNotification(`èŠ‚ç‚¹ ${nodeId} å¤„ç†å®Œæˆ`, 'info')\r\n   } else {\r\n-    console.warn('âš ï¸âš ï¸âš ï¸ æ”¶åˆ°æ— æ•ˆçš„æ‰§è¡Œå®Œæˆæ¶ˆæ¯ âš ï¸âš ï¸âš ï¸')\r\n-    console.warn('æ¶ˆæ¯å†…å®¹:', data)\r\n-\r\n-    // å¦‚æœæ²¡æœ‰prompt_idä½†æœ‰è¾“å‡ºæ•°æ®ï¼Œå°è¯•å¤„ç†ç¬¬ä¸€ä¸ªå¾…å¤„ç†ä»»åŠ¡\r\n-    if ((data.output || data.outputs) && pendingTasks.size > 0) {\r\n-      console.log('ğŸ” å°è¯•å°†ç»“æœåˆ†é…ç»™ç¬¬ä¸€ä¸ªå¾…å¤„ç†ä»»åŠ¡...');\r\n-      const firstTaskId = Array.from(pendingTasks.keys())[0];\r\n-      const firstTask = pendingTasks.get(firstTaskId);\r\n-      if (firstTask && firstTask.onComplete) {\r\n-        console.log(`ğŸš€ å°†ç»“æœåˆ†é…ç»™ä»»åŠ¡: ${firstTaskId}`);\r\n-        const result = {\r\n-          outputs: data.output || data.outputs,\r\n-          status: { completed: true }\r\n-        };\r\n-        firstTask.onComplete(result);\r\n-        pendingTasks.delete(firstTaskId);\r\n-      }\r\n-    }\r\n+    console.log('ğŸ“‹ æ”¶åˆ°executedæ¶ˆæ¯ï¼Œä½†æ ¼å¼ä¸å®Œæ•´:', data)\r\n   }\r\n }\r\n \r\n // å¤„ç†æ‰§è¡Œé”™è¯¯æ¶ˆæ¯\r\n"
                },
                {
                    "date": 1752467287603,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1624,27 +1624,6 @@\n   processUndressImage,\r\n   processFaceSwapImage,\r\n   initializeWebSocket,\r\n   wsConnection,\r\n-  isWsConnected,\r\n-  debugWebSocketConnection,\r\n-  debugTaskSubmission,\r\n-  pendingTasks,\r\n-  checkTaskStatus\r\n+  isWsConnected\r\n }\r\n-\r\n-// åœ¨å¼€å‘ç¯å¢ƒä¸­æš´éœ²è°ƒè¯•å‡½æ•°åˆ°å…¨å±€\r\n-if (import.meta.env.DEV) {\r\n-  window.comfyUIDebug = {\r\n-    debugWebSocketConnection,\r\n-    debugTaskSubmission,\r\n-    pendingTasks,\r\n-    wsConnection: () => wsConnection,\r\n-    isWsConnected: () => isWsConnected,\r\n-    checkTaskStatus,\r\n-    getApiBaseUrl,\r\n-    handleExecutedMessage: (data) => handleExecutedMessage(data),\r\n-    handleWebSocketMessage: (message) => handleWebSocketMessage(message)\r\n-  }\r\n-  console.log('ğŸ”§ ComfyUIè°ƒè¯•å‡½æ•°å·²æš´éœ²åˆ° window.comfyUIDebug')\r\n-  console.log('ğŸ”§ å¯ç”¨è°ƒè¯•å‡½æ•°:', Object.keys(window.comfyUIDebug))\r\n-}\r\n"
                },
                {
                    "date": 1752467329366,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -651,97 +651,10 @@\n     console.warn('æ˜¾ç¤ºé€šçŸ¥å¤±è´¥:', error)\r\n   }\r\n }\r\n \r\n-// è°ƒè¯•å‡½æ•°ï¼šæµ‹è¯•WebSocketè¿æ¥\r\n-async function debugWebSocketConnection() {\r\n-  console.log('ğŸ”§ğŸ”§ğŸ”§ å¼€å§‹WebSocketè¿æ¥è°ƒè¯• ğŸ”§ğŸ”§ğŸ”§')\r\n \r\n-  try {\r\n-    // 1. æ£€æŸ¥é…ç½®\r\n-    const config = getComfyUIConfig()\r\n-    console.log('ğŸ“‹ å½“å‰é…ç½®:', config)\r\n \r\n-    // 2. æ£€æŸ¥API URL\r\n-    const apiUrl = await getApiBaseUrl()\r\n-    console.log('ğŸ”— API URL:', apiUrl)\r\n-\r\n-    // 3. æµ‹è¯•HTTPè¿æ¥\r\n-    console.log('ğŸ” æµ‹è¯•HTTPè¿æ¥...')\r\n-    const httpResponse = await fetch(`${apiUrl}/system_stats`)\r\n-    console.log('ğŸ“Š HTTPå“åº”çŠ¶æ€:', httpResponse.status)\r\n-    if (httpResponse.ok) {\r\n-      const stats = await httpResponse.json()\r\n-      console.log('ğŸ“Š æœåŠ¡å™¨ç»Ÿè®¡:', stats)\r\n-    }\r\n-\r\n-    // 4. æµ‹è¯•WebSocketè¿æ¥\r\n-    console.log('ğŸ”Œ æµ‹è¯•WebSocketè¿æ¥...')\r\n-    await initializeWebSocket()\r\n-\r\n-    // 5. æ£€æŸ¥è¿æ¥çŠ¶æ€\r\n-    console.log('ğŸ“¡ WebSocketçŠ¶æ€:', {\r\n-      isConnected: isWsConnected,\r\n-      readyState: wsConnection ? wsConnection.readyState : 'null',\r\n-      url: wsConnection ? wsConnection.url : 'null'\r\n-    })\r\n-\r\n-    return true\r\n-  } catch (error) {\r\n-    console.error('âŒ WebSocketè°ƒè¯•å¤±è´¥:', error)\r\n-    return false\r\n-  }\r\n-}\r\n-\r\n-// è°ƒè¯•å‡½æ•°ï¼šæ¨¡æ‹Ÿä»»åŠ¡æäº¤å’Œç›‘å¬\r\n-async function debugTaskSubmission() {\r\n-  console.log('ğŸ¯ğŸ¯ğŸ¯ å¼€å§‹ä»»åŠ¡æäº¤è°ƒè¯• ğŸ¯ğŸ¯ğŸ¯')\r\n-\r\n-  try {\r\n-    // ç¡®ä¿WebSocketè¿æ¥\r\n-    await initializeWebSocket()\r\n-\r\n-    // åˆ›å»ºæµ‹è¯•ä»»åŠ¡\r\n-    const testPromptId = 'test-' + Date.now()\r\n-    console.log(`ğŸ“ åˆ›å»ºæµ‹è¯•ä»»åŠ¡: ${testPromptId}`)\r\n-\r\n-    // æ³¨å†Œä»»åŠ¡ç›‘å¬\r\n-    const testTask = {\r\n-      promptId: testPromptId,\r\n-      onProgress: (progress, status) => {\r\n-        console.log(`ğŸ“ˆ æµ‹è¯•ä»»åŠ¡è¿›åº¦: ${progress}% (${status})`)\r\n-      },\r\n-      onComplete: (result) => {\r\n-        console.log(`âœ… æµ‹è¯•ä»»åŠ¡å®Œæˆ:`, result)\r\n-      },\r\n-      onError: (error) => {\r\n-        console.error(`âŒ æµ‹è¯•ä»»åŠ¡å¤±è´¥:`, error)\r\n-      }\r\n-    }\r\n-\r\n-    pendingTasks.set(testPromptId, testTask)\r\n-    console.log(`ğŸ“‹ å·²æ³¨å†Œæµ‹è¯•ä»»åŠ¡ï¼Œå½“å‰ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n-\r\n-    // æ¨¡æ‹Ÿå‘é€æ‰§è¡Œå®Œæˆæ¶ˆæ¯ï¼ˆç”¨äºæµ‹è¯•ï¼‰\r\n-    setTimeout(() => {\r\n-      console.log('ğŸ§ª æ¨¡æ‹Ÿæ‰§è¡Œå®Œæˆæ¶ˆæ¯...')\r\n-      const mockMessage = {\r\n-        type: 'executed',\r\n-        data: {\r\n-          prompt_id: testPromptId,\r\n-          output: { test: 'result' }\r\n-        }\r\n-      }\r\n-      handleWebSocketMessage(mockMessage)\r\n-    }, 3000)\r\n-\r\n-    return testPromptId\r\n-  } catch (error) {\r\n-    console.error('âŒ ä»»åŠ¡æäº¤è°ƒè¯•å¤±è´¥:', error)\r\n-    return null\r\n-  }\r\n-}\r\n-\r\n // åˆå§‹åŒ– WebSocket è¿æ¥\r\n async function initializeWebSocket() {\r\n   try {\r\n     if (wsConnection && wsConnection.readyState === WebSocket.OPEN) {\r\n"
                },
                {
                    "date": 1752467358849,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -672,23 +672,17 @@\n     } else {\r\n       wsUrl = baseUrl.replace('http://', 'ws://') + '/ws?clientId=' + config.CLIENT_ID\r\n     }\r\n \r\n-    console.log('ğŸš€ğŸš€ğŸš€ æ­£åœ¨åˆå§‹åŒ– ComfyUI WebSocket è¿æ¥ ğŸš€ğŸš€ğŸš€')\r\n-    console.log(`ğŸ”— åŸå§‹URL: ${baseUrl}`)\r\n-    console.log(`ğŸ”— WebSocket URL: ${wsUrl}`)\r\n-    console.log(`ğŸ†” å®¢æˆ·ç«¯ID: ${config.CLIENT_ID}`)\r\n+    console.log('ğŸ”Œ æ­£åœ¨è¿æ¥ ComfyUI WebSocket...')\r\n \r\n     // å…ˆæµ‹è¯•HTTPè¿æ¥æ˜¯å¦æ­£å¸¸\r\n     try {\r\n-      console.log('ğŸ” æµ‹è¯•ComfyUI HTTPè¿æ¥...')\r\n       const testResponse = await fetch(`${baseUrl}/system_stats`, {\r\n         method: 'GET',\r\n         signal: AbortSignal.timeout(5000)\r\n       })\r\n-      if (testResponse.ok) {\r\n-        console.log('âœ… ComfyUI HTTPè¿æ¥æ­£å¸¸')\r\n-      } else {\r\n+      if (!testResponse.ok) {\r\n         console.warn('âš ï¸ ComfyUI HTTPè¿æ¥å¼‚å¸¸:', testResponse.status)\r\n       }\r\n     } catch (httpError) {\r\n       console.error('âŒ ComfyUI HTTPè¿æ¥å¤±è´¥:', httpError)\r\n"
                },
                {
                    "date": 1752467375914,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -692,15 +692,14 @@\n     wsConnection = new WebSocket(wsUrl)\r\n \r\n     return new Promise((resolve, reject) => {\r\n       const timeout = setTimeout(() => {\r\n-        console.error('âŒâŒâŒ WebSocket è¿æ¥è¶…æ—¶ (10ç§’) âŒâŒâŒ')\r\n+        console.error('âŒ WebSocket è¿æ¥è¶…æ—¶')\r\n         reject(new Error('WebSocket è¿æ¥è¶…æ—¶'))\r\n       }, 10000)\r\n \r\n       wsConnection.onopen = () => {\r\n-        console.log('ğŸ‰ğŸ‰ğŸ‰ ComfyUI WebSocket è¿æ¥æˆåŠŸå»ºç«‹! ğŸ‰ğŸ‰ğŸ‰')\r\n-        console.log('ğŸ“¡ å®æ—¶é€šä¿¡å·²å¯ç”¨ï¼Œç­‰å¾…ComfyUIå¤„ç†ç»“æœ...')\r\n+        console.log('âœ… ComfyUI WebSocket è¿æ¥æˆåŠŸ')\r\n         isWsConnected = true\r\n         clearTimeout(timeout)\r\n         clearTimeout(wsReconnectTimer)\r\n \r\n"
                },
                {
                    "date": 1752467400456,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -729,9 +729,9 @@\n         }\r\n       }\r\n \r\n       wsConnection.onerror = (error) => {\r\n-        console.error('âŒâŒâŒ ComfyUI WebSocket è¿æ¥é”™è¯¯ âŒâŒâŒ', error)\r\n+        console.error('âŒ ComfyUI WebSocket è¿æ¥é”™è¯¯:', error)\r\n         clearTimeout(timeout)\r\n \r\n         // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n         showWebSocketStatusNotification('WebSocketè¿æ¥é”™è¯¯', 'error')\r\n"
                },
                {
                    "date": 1752467431784,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -740,73 +740,44 @@\n       }\r\n \r\n       wsConnection.onmessage = (event) => {\r\n         try {\r\n-          console.log(`ğŸ“¨ æ”¶åˆ°WebSocketåŸå§‹æ¶ˆæ¯ (${event.data.length}å­—ç¬¦):`, event.data.substring(0, 300))\r\n-\r\n           let message;\r\n           try {\r\n             message = JSON.parse(event.data)\r\n           } catch (parseError) {\r\n             console.error('âŒ WebSocketæ¶ˆæ¯è§£æå¤±è´¥:', parseError)\r\n-            console.log('åŸå§‹æ¶ˆæ¯å†…å®¹:', event.data.substring(0, 500))\r\n             return\r\n           }\r\n \r\n-          // ComfyUIçš„æ¶ˆæ¯æ ¼å¼å¯èƒ½æœ‰å¤šç§ï¼š\r\n-          // 1. { type: \"...\", data: {...} }\r\n-          // 2. ç›´æ¥çš„æ¶ˆæ¯å¯¹è±¡\r\n-          console.log(`ğŸ“‹ WebSocketæ¶ˆæ¯å®Œæ•´ç»“æ„:`, JSON.stringify(message, null, 2))\r\n-\r\n           // æ£€æŸ¥æ¶ˆæ¯æ ¼å¼å¹¶æ ‡å‡†åŒ–\r\n           let normalizedMessage = message;\r\n           if (message.type && message.data) {\r\n             // æ ‡å‡†æ ¼å¼ï¼š{ type: \"...\", data: {...} }\r\n-            console.log(`ğŸ“‹ æ ‡å‡†æ ¼å¼æ¶ˆæ¯ - ç±»å‹: ${message.type}`)\r\n+            normalizedMessage = message;\r\n           } else if (typeof message === 'object') {\r\n             // å¯èƒ½æ˜¯ç›´æ¥çš„æ¶ˆæ¯å¯¹è±¡ï¼Œå°è¯•æ¨æ–­ç±»å‹\r\n-            console.log(`ğŸ“‹ æ£€æµ‹æ¶ˆæ¯å¯¹è±¡ç»“æ„:`, Object.keys(message))\r\n-\r\n-            // æ£€æŸ¥æ˜¯å¦æ˜¯æ‰§è¡Œå®Œæˆæ¶ˆæ¯çš„å…¶ä»–æ ¼å¼\r\n             if (message.prompt_id && (message.output || message.outputs)) {\r\n-              console.log(`ğŸ¯ æ£€æµ‹åˆ°å¯èƒ½çš„æ‰§è¡Œå®Œæˆæ¶ˆæ¯æ ¼å¼`)\r\n               normalizedMessage = {\r\n                 type: 'executed',\r\n                 data: message\r\n               }\r\n             } else if (message.prompt_id && message.node) {\r\n-              console.log(`ğŸ”„ æ£€æµ‹åˆ°å¯èƒ½çš„æ‰§è¡Œä¸­æ¶ˆæ¯æ ¼å¼`)\r\n               normalizedMessage = {\r\n                 type: 'executing',\r\n                 data: message\r\n               }\r\n             } else if (message.prompt_id && (message.value !== undefined && message.max !== undefined)) {\r\n-              console.log(`ğŸ“ˆ æ£€æµ‹åˆ°å¯èƒ½çš„è¿›åº¦æ¶ˆæ¯æ ¼å¼`)\r\n               normalizedMessage = {\r\n                 type: 'progress',\r\n                 data: message\r\n               }\r\n             }\r\n           }\r\n \r\n-          // å¯¹å…³é”®æ¶ˆæ¯ç±»å‹æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯å’Œæ˜æ˜¾æ ‡è®°\r\n-          if (['executed', 'execution_error', 'progress', 'executing', 'status'].includes(normalizedMessage.type)) {\r\n-            console.log(`ğŸ”¥ğŸ”¥ğŸ”¥ é‡è¦æ¶ˆæ¯: ${normalizedMessage.type.toUpperCase()} ğŸ”¥ğŸ”¥ğŸ”¥`)\r\n-            console.log(`ğŸ“Š æ ‡å‡†åŒ–åçš„æ¶ˆæ¯:`, JSON.stringify(normalizedMessage, null, 2))\r\n-\r\n-            // ç‰¹åˆ«å…³æ³¨executedæ¶ˆæ¯\r\n-            if (normalizedMessage.type === 'executed') {\r\n-              const data = normalizedMessage.data;\r\n-              if (data && data.prompt_id) {\r\n-                console.log(`ğŸ¯ğŸ¯ğŸ¯ æ£€æµ‹åˆ°ä»»åŠ¡å®Œæˆæ¶ˆæ¯! ä»»åŠ¡ID: ${data.prompt_id} ğŸ¯ğŸ¯ğŸ¯`)\r\n-              }\r\n-            }\r\n-          }\r\n-\r\n           handleWebSocketMessage(normalizedMessage)\r\n         } catch (error) {\r\n           console.error('âŒ å¤„ç†WebSocketæ¶ˆæ¯å¤±è´¥:', error)\r\n-          console.log('é—®é¢˜æ¶ˆæ¯å†…å®¹:', event.data.substring(0, 500))\r\n         }\r\n       }\r\n     })\r\n   } catch (error) {\r\n"
                },
                {
                    "date": 1752467450562,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -790,12 +790,8 @@\n function handleWebSocketMessage(message) {\r\n   try {\r\n     const { type, data } = message\r\n \r\n-    console.log(`ğŸ“¨ğŸ“¨ğŸ“¨ å¤„ç†WebSocketæ¶ˆæ¯ ğŸ“¨ğŸ“¨ğŸ“¨`)\r\n-    console.log(`æ¶ˆæ¯ç±»å‹: ${type}`)\r\n-    console.log(`æ¶ˆæ¯æ•°æ®:`, data)\r\n-\r\n     switch (type) {\r\n       case 'status':\r\n         console.log('ğŸ“Š å¤„ç†é˜Ÿåˆ—çŠ¶æ€æ¶ˆæ¯')\r\n         handleStatusMessage(data)\r\n"
                },
                {
                    "date": 1752467479589,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -792,46 +792,37 @@\n     const { type, data } = message\r\n \r\n     switch (type) {\r\n       case 'status':\r\n-        console.log('ğŸ“Š å¤„ç†é˜Ÿåˆ—çŠ¶æ€æ¶ˆæ¯')\r\n         handleStatusMessage(data)\r\n         break\r\n       case 'progress':\r\n-        console.log('ğŸ“ˆ å¤„ç†è¿›åº¦æ¶ˆæ¯')\r\n         handleProgressMessage(data)\r\n         break\r\n       case 'executing':\r\n-        console.log('ğŸ”„ å¤„ç†æ­£åœ¨æ‰§è¡Œæ¶ˆæ¯')\r\n         handleExecutingMessage(data)\r\n         break\r\n       case 'executed':\r\n-        console.log('ğŸ¯ å¤„ç†èŠ‚ç‚¹æ‰§è¡Œå®Œæˆæ¶ˆæ¯ï¼ˆUIæ›´æ–°ï¼‰')\r\n         handleExecutedMessage(data)\r\n         break\r\n       case 'execution_start':\r\n-        console.log('ğŸš€ å¤„ç†æ‰§è¡Œå¼€å§‹æ¶ˆæ¯')\r\n         handleExecutionStartMessage(data)\r\n         break\r\n       case 'execution_success':\r\n-        console.log('ğŸ‰ğŸ‰ğŸ‰ å¤„ç†æ‰§è¡ŒæˆåŠŸæ¶ˆæ¯ ğŸ‰ğŸ‰ğŸ‰')\r\n+        console.log('ğŸ‰ ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ!')\r\n         handleExecutionSuccessMessage(data)\r\n         break\r\n       case 'execution_error':\r\n-        console.log('âŒ å¤„ç†æ‰§è¡Œé”™è¯¯æ¶ˆæ¯')\r\n         handleExecutionErrorMessage(data)\r\n         break\r\n       case 'execution_interrupted':\r\n-        console.log('â¸ï¸ å¤„ç†æ‰§è¡Œä¸­æ–­æ¶ˆæ¯')\r\n         handleExecutionInterruptedMessage(data)\r\n         break\r\n       case 'execution_cached':\r\n-        console.log('ğŸ’¾ å¤„ç†æ‰§è¡Œç¼“å­˜æ¶ˆæ¯')\r\n         handleExecutionCachedMessage(data)\r\n         break\r\n       default:\r\n-        console.log(`ğŸ” æ”¶åˆ°æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹: ${type}`)\r\n-        console.log(`æœªå¤„ç†æ¶ˆæ¯çš„å®Œæ•´å†…å®¹:`, JSON.stringify(message, null, 2))\r\n+        console.log(`æ”¶åˆ°æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹: ${type}`)\r\n     }\r\n \r\n     // è§¦å‘æ³¨å†Œçš„æ¶ˆæ¯å¤„ç†å™¨\r\n     if (wsMessageHandlers.has(type)) {\r\n"
                },
                {
                    "date": 1752467514801,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -872,55 +872,36 @@\n }\r\n \r\n // å¤„ç†æ‰§è¡ŒæˆåŠŸæ¶ˆæ¯ - è¿™æ˜¯å…³é”®çš„å®Œæˆæ¶ˆæ¯ï¼\r\n function handleExecutionSuccessMessage(data) {\r\n-  console.log('ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯')\r\n-  console.log('ğŸ‰ğŸ‰ğŸ‰ ComfyUI æ‰§è¡ŒæˆåŠŸ! æ‰€æœ‰èŠ‚ç‚¹å·²å®Œæˆ! ğŸ‰ğŸ‰ğŸ‰')\r\n-  console.log('ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯')\r\n-  console.log(`ğŸ“£ æ‰§è¡ŒæˆåŠŸæ¶ˆæ¯è¯¦æƒ…:`, data)\r\n+  console.log('ğŸ‰ ComfyUI æ‰§è¡ŒæˆåŠŸ! æ‰€æœ‰èŠ‚ç‚¹å·²å®Œæˆ!')\r\n \r\n   if (data && data.prompt_id) {\r\n     const promptId = data.prompt_id\r\n-    console.log(`ğŸ” æŸ¥æ‰¾ä»»åŠ¡: ${promptId}`)\r\n-    console.log(`ğŸ“‹ å½“å‰å¾…å¤„ç†ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n+    const task = pendingTasks.get(promptId)\r\n \r\n-    const task = pendingTasks.get(promptId)\r\n     if (task) {\r\n-      console.log('âœ…âœ…âœ… æ‰¾åˆ°å¯¹åº”ä»»åŠ¡ï¼Œæ‰§è¡Œå·²æˆåŠŸå®Œæˆ âœ…âœ…âœ…')\r\n+      console.log(`âœ… ä»»åŠ¡ ${promptId} æ‰§è¡Œå®Œæˆ`)\r\n \r\n       // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n-      showWebSocketStatusNotification(`ä»»åŠ¡ ${promptId.substring(0, 8)} æ‰§è¡ŒæˆåŠŸ!`, 'success')\r\n+      showWebSocketStatusNotification(`ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ!`, 'success')\r\n \r\n       // è·å–å®Œæ•´çš„å†å²è®°å½•æ¥è·å–è¾“å‡ºç»“æœ\r\n-      console.log('ğŸ“¥ è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ...')\r\n       checkTaskStatus(promptId).then(result => {\r\n-        console.log('ğŸŠğŸŠğŸŠ æˆåŠŸè·å–ä»»åŠ¡å®Œæ•´ç»“æœ ğŸŠğŸŠğŸŠ')\r\n-        console.log(`ğŸ“‹ ä»»åŠ¡ ${promptId} çš„å®Œæ•´ç»“æœ:`, result)\r\n-\r\n         if (task.onComplete) {\r\n-          console.log('ğŸš€ğŸš€ğŸš€ è§¦å‘ä»»åŠ¡å®Œæˆå›è°ƒå‡½æ•° ğŸš€ğŸš€ğŸš€')\r\n-          console.log('ğŸ¯ å³å°†è¿”å›å¤„ç†ç»“æœåˆ°å‰ç«¯ç•Œé¢...')\r\n+          console.log('ğŸš€ è¿”å›å¤„ç†ç»“æœåˆ°å‰ç«¯')\r\n \r\n           // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥\r\n           showWebSocketStatusNotification('å›¾ç‰‡å¤„ç†æˆåŠŸï¼Œæ­£åœ¨åŠ è½½ç»“æœ...', 'success')\r\n \r\n           task.onComplete(result)\r\n-\r\n-          console.log('âœ…âœ…âœ… ä»»åŠ¡å®Œæˆå›è°ƒå·²æ‰§è¡Œï¼Œç»“æœå·²è¿”å›å‰ç«¯ âœ…âœ…âœ…')\r\n-        } else {\r\n-          console.warn(`âš ï¸âš ï¸âš ï¸ ä»»åŠ¡ ${promptId} æ²¡æœ‰å®Œæˆå›è°ƒå‡½æ•°! âš ï¸âš ï¸âš ï¸`)\r\n         }\r\n \r\n         pendingTasks.delete(promptId)\r\n-        console.log(`ğŸ—‘ï¸ å·²åˆ é™¤å®Œæˆçš„ä»»åŠ¡ ${promptId}ï¼Œå‰©ä½™ä»»åŠ¡æ•°: ${pendingTasks.size}`)\r\n+        console.log('âœ… ComfyUI å¤„ç†æµç¨‹å®Œæˆ!')\r\n \r\n-        console.log('ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰')\r\n-        console.log('ğŸŠ ComfyUI å¤„ç†æµç¨‹å®Œå…¨ç»“æŸ! ğŸŠ')\r\n-        console.log('ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰')\r\n-\r\n       }).catch(error => {\r\n-        console.error('âŒâŒâŒ è·å–ä»»åŠ¡ç»“æœå¤±è´¥ âŒâŒâŒ', error)\r\n-        console.error(`âŒ ä»»åŠ¡ ${promptId} ç»“æœè·å–å¤±è´¥:`, error)\r\n+        console.error('âŒ è·å–ä»»åŠ¡ç»“æœå¤±è´¥:', error)\r\n \r\n         // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥\r\n         showWebSocketStatusNotification('è·å–å¤„ç†ç»“æœå¤±è´¥', 'error')\r\n \r\n@@ -929,15 +910,12 @@\n         }\r\n         pendingTasks.delete(promptId)\r\n       })\r\n     } else {\r\n-      console.warn('âš ï¸âš ï¸âš ï¸ æ”¶åˆ°æœªçŸ¥ä»»åŠ¡çš„æ‰§è¡ŒæˆåŠŸæ¶ˆæ¯ âš ï¸âš ï¸âš ï¸')\r\n-      console.warn(`âš ï¸ ä»»åŠ¡ID: ${promptId}`)\r\n-      console.warn(`âš ï¸ å½“å‰ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n+      console.warn(`âš ï¸ æ”¶åˆ°æœªçŸ¥ä»»åŠ¡çš„æ‰§è¡ŒæˆåŠŸæ¶ˆæ¯: ${promptId}`)\r\n     }\r\n   } else {\r\n-    console.warn('âš ï¸âš ï¸âš ï¸ æ”¶åˆ°æ— æ•ˆçš„æ‰§è¡ŒæˆåŠŸæ¶ˆæ¯ âš ï¸âš ï¸âš ï¸')\r\n-    console.warn('æ¶ˆæ¯å†…å®¹:', data)\r\n+    console.warn('âš ï¸ æ”¶åˆ°æ— æ•ˆçš„æ‰§è¡ŒæˆåŠŸæ¶ˆæ¯')\r\n   }\r\n }\r\n \r\n // å¤„ç†æ‰§è¡Œä¸­æ–­æ¶ˆæ¯\r\n"
                },
                {
                    "date": 1752467536138,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -956,23 +956,12 @@\n     const promptId = data.prompt_id\r\n     const nodeId = data.node\r\n     const progress = Math.round((data.value / data.max) * 100)\r\n \r\n-    console.log('ğŸ“ˆğŸ“ˆğŸ“ˆ ComfyUI å¤„ç†è¿›åº¦æ›´æ–° ğŸ“ˆğŸ“ˆğŸ“ˆ')\r\n-    console.log(`ğŸ“ˆ ä»»åŠ¡ ${promptId} è¿›åº¦: ${progress}% (${data.value}/${data.max})`)\r\n-    console.log(`ğŸ”„ å½“å‰å¤„ç†èŠ‚ç‚¹: ${nodeId || 'æœªçŸ¥'}`)\r\n-\r\n     const task = pendingTasks.get(promptId)\r\n     if (task && task.onProgress) {\r\n-      // æ˜¾ç¤ºè¿›åº¦é€šçŸ¥\r\n-      showWebSocketStatusNotification(`å¤„ç†è¿›åº¦: ${progress}%`, 'info')\r\n-\r\n       task.onProgress(progress, `å¤„ç†èŠ‚ç‚¹ ${nodeId || ''}`)\r\n-    } else {\r\n-      console.log(`ğŸ“ˆ æ”¶åˆ°ä»»åŠ¡ ${promptId} çš„è¿›åº¦æ¶ˆæ¯ï¼Œä½†æœªæ‰¾åˆ°å¯¹åº”ä»»åŠ¡`)\r\n     }\r\n-  } else {\r\n-    console.warn('âš ï¸ æ”¶åˆ°æ— æ•ˆçš„è¿›åº¦æ¶ˆæ¯:', data)\r\n   }\r\n }\r\n \r\n // å¤„ç†èŠ‚ç‚¹æ‰§è¡Œå®Œæˆæ¶ˆæ¯ - å½“èŠ‚ç‚¹è¿”å›UIå…ƒç´ æ—¶\r\n"
                },
                {
                    "date": 1752467556815,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1010,33 +1010,18 @@\n   if (data && data.prompt_id) {\r\n     const promptId = data.prompt_id\r\n     const nodeId = data.node\r\n \r\n-    console.log('ğŸ”„ğŸ”„ğŸ”„ ComfyUI èŠ‚ç‚¹æ‰§è¡ŒçŠ¶æ€æ›´æ–° ğŸ”„ğŸ”„ğŸ”„')\r\n-\r\n-    if (nodeId === null || nodeId === undefined) {\r\n-      // nodeä¸ºnullè¡¨ç¤ºæ‰§è¡Œå®Œæˆ\r\n-      console.log(`âœ… ä»»åŠ¡ ${promptId} æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œå®Œæˆ`)\r\n-\r\n-      const task = pendingTasks.get(promptId)\r\n-      if (task && task.onProgress) {\r\n+    const task = pendingTasks.get(promptId)\r\n+    if (task && task.onProgress) {\r\n+      if (nodeId === null || nodeId === undefined) {\r\n+        // nodeä¸ºnullè¡¨ç¤ºæ‰§è¡Œå®Œæˆ\r\n         task.onProgress(95, 'æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œå®Œæˆ')\r\n-      }\r\n-\r\n-      showWebSocketStatusNotification(`ä»»åŠ¡ ${promptId.substring(0, 8)} èŠ‚ç‚¹æ‰§è¡Œå®Œæˆ`, 'success')\r\n-    } else {\r\n-      // å¼€å§‹æ‰§è¡Œæ–°èŠ‚ç‚¹\r\n-      console.log(`ğŸ”„ ä»»åŠ¡ ${promptId} æ­£åœ¨æ‰§è¡ŒèŠ‚ç‚¹: ${nodeId}`)\r\n-\r\n-      const task = pendingTasks.get(promptId)\r\n-      if (task && task.onProgress) {\r\n+      } else {\r\n+        // å¼€å§‹æ‰§è¡Œæ–°èŠ‚ç‚¹\r\n         task.onProgress(50, `æ‰§è¡ŒèŠ‚ç‚¹ ${nodeId}`)\r\n       }\r\n-\r\n-      showWebSocketStatusNotification(`æ­£åœ¨æ‰§è¡ŒèŠ‚ç‚¹: ${nodeId}`, 'info')\r\n     }\r\n-  } else {\r\n-    console.warn('âš ï¸ æ”¶åˆ°æ— æ•ˆçš„æ‰§è¡Œæ¶ˆæ¯:', data)\r\n   }\r\n }\r\n \r\n // ç­‰å¾…ä»»åŠ¡å®Œæˆ - ä¸“æ³¨ä½¿ç”¨WebSocketæœºåˆ¶\r\n"
                },
                {
                    "date": 1752467579124,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -965,30 +965,20 @@\n }\r\n \r\n // å¤„ç†èŠ‚ç‚¹æ‰§è¡Œå®Œæˆæ¶ˆæ¯ - å½“èŠ‚ç‚¹è¿”å›UIå…ƒç´ æ—¶\r\n function handleExecutedMessage(data) {\r\n-  console.log('ğŸ¯ æ”¶åˆ°èŠ‚ç‚¹æ‰§è¡Œå®Œæˆæ¶ˆæ¯ï¼ˆUIæ›´æ–°ï¼‰')\r\n-  console.log(`ğŸ“£ èŠ‚ç‚¹æ‰§è¡Œæ¶ˆæ¯è¯¦æƒ…:`, data)\r\n-\r\n   // æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œexecutedæ¶ˆæ¯åªåœ¨èŠ‚ç‚¹è¿”å›UIå…ƒç´ æ—¶å‘é€\r\n   // è¿™ä¸æ˜¯ä»»åŠ¡å®Œæˆçš„ä¿¡å·ï¼ŒçœŸæ­£çš„å®Œæˆä¿¡å·æ˜¯execution_success\r\n \r\n   if (data && data.prompt_id && data.node && data.output) {\r\n     const promptId = data.prompt_id\r\n     const nodeId = data.node\r\n \r\n-    console.log(`ğŸ¯ èŠ‚ç‚¹ ${nodeId} è¿”å›UIæ›´æ–°ï¼Œä»»åŠ¡: ${promptId}`)\r\n-    console.log(`ğŸ“‹ UIè¾“å‡º:`, data.output)\r\n-\r\n     // è¿™é‡Œå¯ä»¥å¤„ç†ä¸­é—´ç»“æœæˆ–UIæ›´æ–°ï¼Œä½†ä¸åº”è¯¥è§¦å‘ä»»åŠ¡å®Œæˆ\r\n     const task = pendingTasks.get(promptId)\r\n     if (task && task.onProgress) {\r\n       task.onProgress(80, `èŠ‚ç‚¹ ${nodeId} å®Œæˆ`)\r\n     }\r\n-\r\n-    showWebSocketStatusNotification(`èŠ‚ç‚¹ ${nodeId} å¤„ç†å®Œæˆ`, 'info')\r\n-  } else {\r\n-    console.log('ğŸ“‹ æ”¶åˆ°executedæ¶ˆæ¯ï¼Œä½†æ ¼å¼ä¸å®Œæ•´:', data)\r\n   }\r\n }\r\n \r\n // å¤„ç†æ‰§è¡Œé”™è¯¯æ¶ˆæ¯\r\n"
                },
                {
                    "date": 1752467595699,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -859,16 +859,12 @@\n // å¤„ç†æ‰§è¡Œå¼€å§‹æ¶ˆæ¯\r\n function handleExecutionStartMessage(data) {\r\n   if (data && data.prompt_id) {\r\n     const promptId = data.prompt_id\r\n-    console.log(`ğŸš€ ä»»åŠ¡å¼€å§‹æ‰§è¡Œ: ${promptId}`)\r\n-\r\n     const task = pendingTasks.get(promptId)\r\n     if (task && task.onProgress) {\r\n       task.onProgress('å¼€å§‹æ‰§è¡Œ', 5)\r\n     }\r\n-\r\n-    showWebSocketStatusNotification(`ä»»åŠ¡ ${promptId.substring(0, 8)} å¼€å§‹æ‰§è¡Œ`, 'info')\r\n   }\r\n }\r\n \r\n // å¤„ç†æ‰§è¡ŒæˆåŠŸæ¶ˆæ¯ - è¿™æ˜¯å…³é”®çš„å®Œæˆæ¶ˆæ¯ï¼\r\n"
                },
                {
                    "date": 1752467614182,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -842,19 +842,10 @@\n }\r\n \r\n // å¤„ç†çŠ¶æ€æ¶ˆæ¯ - é˜Ÿåˆ—çŠ¶æ€å˜åŒ–\r\n function handleStatusMessage(data) {\r\n-  if (data && data.exec_info) {\r\n-    const queueRemaining = data.exec_info.queue_remaining || 0\r\n-    console.log(`ğŸ“Š é˜Ÿåˆ—çŠ¶æ€æ›´æ–°: å‰©ä½™ä»»åŠ¡=${queueRemaining}`)\r\n-\r\n-    // æ˜¾ç¤ºé˜Ÿåˆ—çŠ¶æ€é€šçŸ¥\r\n-    if (queueRemaining === 0) {\r\n-      showWebSocketStatusNotification('é˜Ÿåˆ—å·²æ¸…ç©º', 'info')\r\n-    } else {\r\n-      showWebSocketStatusNotification(`é˜Ÿåˆ—ä¸­è¿˜æœ‰ ${queueRemaining} ä¸ªä»»åŠ¡`, 'info')\r\n-    }\r\n-  }\r\n+  // é˜Ÿåˆ—çŠ¶æ€æ¶ˆæ¯ï¼Œé€šå¸¸ç”¨äºç›‘æ§é˜Ÿåˆ—çŠ¶æ€\r\n+  // è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ é˜Ÿåˆ—çŠ¶æ€å¤„ç†é€»è¾‘\r\n }\r\n \r\n // å¤„ç†æ‰§è¡Œå¼€å§‹æ¶ˆæ¯\r\n function handleExecutionStartMessage(data) {\r\n"
                },
                {
                    "date": 1752467636639,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -908,33 +908,25 @@\n // å¤„ç†æ‰§è¡Œä¸­æ–­æ¶ˆæ¯\r\n function handleExecutionInterruptedMessage(data) {\r\n   if (data && data.prompt_id) {\r\n     const promptId = data.prompt_id\r\n-    console.log(`â¸ï¸ ä»»åŠ¡æ‰§è¡Œè¢«ä¸­æ–­: ${promptId}`)\r\n-\r\n     const task = pendingTasks.get(promptId)\r\n     if (task && task.onError) {\r\n       task.onError('ä»»åŠ¡æ‰§è¡Œè¢«ä¸­æ–­')\r\n     }\r\n-\r\n     pendingTasks.delete(promptId)\r\n-    showWebSocketStatusNotification(`ä»»åŠ¡ ${promptId.substring(0, 8)} è¢«ä¸­æ–­`, 'warning')\r\n   }\r\n }\r\n \r\n // å¤„ç†æ‰§è¡Œç¼“å­˜æ¶ˆæ¯\r\n function handleExecutionCachedMessage(data) {\r\n   if (data && data.prompt_id) {\r\n     const promptId = data.prompt_id\r\n     const cachedNodes = data.nodes || []\r\n-    console.log(`ğŸ’¾ ä»»åŠ¡ä½¿ç”¨ç¼“å­˜: ${promptId}, ç¼“å­˜èŠ‚ç‚¹æ•°: ${cachedNodes.length}`)\r\n-\r\n     const task = pendingTasks.get(promptId)\r\n     if (task && task.onProgress) {\r\n       task.onProgress(`ä½¿ç”¨ç¼“å­˜ (${cachedNodes.length}ä¸ªèŠ‚ç‚¹)`, 30)\r\n     }\r\n-\r\n-    showWebSocketStatusNotification(`ä½¿ç”¨ç¼“å­˜åŠ é€Ÿå¤„ç†`, 'info')\r\n   }\r\n }\r\n \r\n // å¤„ç†è¿›åº¦æ¶ˆæ¯ - æ ¹æ®å®˜æ–¹æ–‡æ¡£è§„èŒƒ\r\n"
                },
                {
                    "date": 1752467665230,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -994,22 +994,18 @@\n }\r\n \r\n // ç­‰å¾…ä»»åŠ¡å®Œæˆ - ä¸“æ³¨ä½¿ç”¨WebSocketæœºåˆ¶\r\n async function waitForTaskCompletion(promptId, maxWaitTime = 300000, onProgress = null) {\r\n-  console.log('ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯')\r\n-  console.log(`â³ å¼€å§‹ç­‰å¾…ä»»åŠ¡å®Œæˆ: ${promptId}`)\r\n-  console.log('ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯')\r\n+  console.log(`â³ ç­‰å¾…ä»»åŠ¡å®Œæˆ: ${promptId}`)\r\n \r\n   // ç¡®ä¿WebSocketè¿æ¥å·²å»ºç«‹\r\n-  console.log('ğŸ”Œ ç¡®ä¿WebSocketè¿æ¥å·²å»ºç«‹...')\r\n   try {\r\n     const wsConnected = await initializeWebSocket()\r\n     if (!wsConnected) {\r\n       throw new Error('WebSocketè¿æ¥å¤±è´¥')\r\n     }\r\n-    console.log('âœ… WebSocketè¿æ¥ç¡®è®¤æˆåŠŸ')\r\n   } catch (error) {\r\n-    console.error('âŒâŒâŒ WebSocketè¿æ¥å¤±è´¥ï¼Œæ— æ³•ä½¿ç”¨å®æ—¶é€šä¿¡ âŒâŒâŒ', error)\r\n+    console.error('âŒ WebSocketè¿æ¥å¤±è´¥:', error)\r\n     throw new Error(`WebSocketè¿æ¥å¤±è´¥: ${error.message}`)\r\n   }\r\n \r\n   return new Promise((resolve, reject) => {\r\n"
                },
                {
                    "date": 1752467689611,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1010,10 +1010,9 @@\n \r\n   return new Promise((resolve, reject) => {\r\n     // è®¾ç½®è¶…æ—¶\r\n     const timeout = setTimeout(() => {\r\n-      console.warn('â°â°â° ä»»åŠ¡ç­‰å¾…è¶…æ—¶ â°â°â°')\r\n-      console.warn(`â° ä»»åŠ¡ ${promptId} ç­‰å¾…è¶…æ—¶ (${maxWaitTime/1000}ç§’)`)\r\n+      console.warn(`â° ä»»åŠ¡ ${promptId} ç­‰å¾…è¶…æ—¶`)\r\n       pendingTasks.delete(promptId)\r\n \r\n       // æ˜¾ç¤ºè¶…æ—¶é€šçŸ¥\r\n       showWebSocketStatusNotification('ä»»åŠ¡å¤„ç†è¶…æ—¶', 'error')\r\n@@ -1024,32 +1023,25 @@\n     // åˆ›å»ºä»»åŠ¡è·Ÿè¸ªå¯¹è±¡\r\n     const task = {\r\n       promptId,\r\n       onProgress: (progress, status) => {\r\n-        console.log(`ğŸ“ˆ ä»»åŠ¡ ${promptId} è¿›åº¦: ${progress}% (${status})`)\r\n         // è°ƒç”¨å¤–éƒ¨è¿›åº¦å›è°ƒ\r\n         if (onProgress) {\r\n           onProgress(`æ­£åœ¨å¤„ç†: ${status}`, progress)\r\n         }\r\n-\r\n-        // æ˜¾ç¤ºè¿›åº¦é€šçŸ¥\r\n-        showWebSocketStatusNotification(`å¤„ç†è¿›åº¦: ${progress}%`, 'info')\r\n       },\r\n       onComplete: (result) => {\r\n         clearTimeout(timeout)\r\n-        console.log('ğŸ‰ğŸ‰ğŸ‰ ä»»åŠ¡å®Œæˆå›è°ƒè¢«è§¦å‘ ğŸ‰ğŸ‰ğŸ‰')\r\n-        console.log(`âœ… ä»»åŠ¡ ${promptId} å®Œæˆï¼Œç»“æœ:`, result)\r\n+        console.log(`âœ… ä»»åŠ¡ ${promptId} å®Œæˆ`)\r\n \r\n         if (onProgress) {\r\n           onProgress('å¤„ç†å®Œæˆ', 100)\r\n         }\r\n \r\n-        console.log('ğŸš€ æ­£åœ¨è¿”å›å¤„ç†ç»“æœ...')\r\n         resolve(result)\r\n       },\r\n       onError: (error) => {\r\n         clearTimeout(timeout)\r\n-        console.error('âŒâŒâŒ ä»»åŠ¡é”™è¯¯å›è°ƒè¢«è§¦å‘ âŒâŒâŒ')\r\n         console.error(`âŒ ä»»åŠ¡ ${promptId} å¤±è´¥:`, error)\r\n \r\n         if (onProgress) {\r\n           onProgress('å¤„ç†å¤±è´¥', 0)\r\n"
                },
                {
                    "date": 1752467721565,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1055,25 +1055,14 @@\n     }\r\n \r\n     // æ³¨å†Œä»»åŠ¡åˆ°å¾…å¤„ç†åˆ—è¡¨\r\n     pendingTasks.set(promptId, task)\r\n-    console.log('ğŸ“ğŸ“ğŸ“ ä»»åŠ¡å·²æ³¨å†Œåˆ°WebSocketç›‘å¬åˆ—è¡¨ ğŸ“ğŸ“ğŸ“')\r\n-    console.log(`ğŸ“ ä»»åŠ¡ID: ${promptId}`)\r\n-    console.log(`ğŸ“ å½“å‰å¾…å¤„ç†ä»»åŠ¡åˆ—è¡¨:`, Array.from(pendingTasks.keys()))\r\n-    console.log(`ğŸ“ ä»»åŠ¡æ€»æ•°: ${pendingTasks.size}`)\r\n \r\n     // ç¡®è®¤WebSocketè¿æ¥çŠ¶æ€\r\n     if (isWsConnected && wsConnection && wsConnection.readyState === WebSocket.OPEN) {\r\n-      console.log('ğŸ”ŒğŸ”ŒğŸ”Œ WebSocketè¿æ¥çŠ¶æ€è‰¯å¥½ï¼Œç­‰å¾…ComfyUIæ¨é€ç»“æœ ğŸ”ŒğŸ”ŒğŸ”Œ')\r\n-      console.log('ğŸ“¡ å®æ—¶é€šä¿¡å·²å¯ç”¨ï¼Œæ— éœ€è½®è¯¢')\r\n-\r\n-      // æ˜¾ç¤ºç­‰å¾…é€šçŸ¥\r\n-      showWebSocketStatusNotification(`æ­£åœ¨ç­‰å¾…ä»»åŠ¡ ${promptId.substring(0, 8)} å®Œæˆ...`, 'info')\r\n+      console.log('ğŸ“¡ WebSocketå·²è¿æ¥ï¼Œç­‰å¾…ä»»åŠ¡å®Œæˆ')\r\n     } else {\r\n-      console.error('âŒâŒâŒ WebSocketè¿æ¥çŠ¶æ€å¼‚å¸¸ âŒâŒâŒ')\r\n-      console.error('è¿æ¥çŠ¶æ€:', wsConnection ? wsConnection.readyState : 'null')\r\n-      console.error('è¿æ¥æ ‡å¿—:', isWsConnected)\r\n-\r\n+      console.error('âŒ WebSocketè¿æ¥çŠ¶æ€å¼‚å¸¸')\r\n       // æ¸…ç†ä»»åŠ¡å¹¶æ‹’ç»\r\n       pendingTasks.delete(promptId)\r\n       clearTimeout(timeout)\r\n       reject(new Error('WebSocketè¿æ¥çŠ¶æ€å¼‚å¸¸ï¼Œæ— æ³•ç›‘å¬ä»»åŠ¡å®Œæˆ'))\r\n"
                },
                {
                    "date": 1752467771332,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1075,78 +1075,64 @@\n \r\n // ä¸»è¦çš„æ¢è¡£APIå‡½æ•° - ä¸¤æ­¥æµç¨‹\r\n async function processUndressImage(base64Image, onProgress = null) {\r\n   try {\r\n-    console.log('ğŸš€ğŸš€ğŸš€ å¼€å§‹å¤„ç†æ¢è¡£è¯·æ±‚ ğŸš€ğŸš€ğŸš€')\r\n-    console.log('ğŸ“± å‰ç«¯è¿›åº¦å›è°ƒå‡½æ•°:', onProgress ? 'å·²æä¾›' : 'æœªæä¾›')\r\n+    console.log('ğŸš€ å¼€å§‹å¤„ç†æ¢è¡£è¯·æ±‚')\r\n \r\n     // é¢„æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€\r\n-    console.log('ğŸ” é¢„æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...')\r\n     if (onProgress) onProgress('æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...', 5)\r\n \r\n     const serverStatus = await checkComfyUIServerStatus()\r\n     if (serverStatus.status === 'error') {\r\n-      console.warn('âš ï¸ å½“å‰æœåŠ¡å™¨çŠ¶æ€å¼‚å¸¸ï¼Œè§¦å‘é‡æ–°è¯„ä¼°...')\r\n+      console.warn('âš ï¸ æœåŠ¡å™¨çŠ¶æ€å¼‚å¸¸ï¼Œé‡æ–°è¯„ä¼°...')\r\n       // å¼ºåˆ¶é‡æ–°è¯„ä¼°æœåŠ¡å™¨\r\n       await getApiBaseUrl(true)\r\n     }\r\n \r\n     // æ£€æŸ¥ç§¯åˆ†ï¼ˆä¼˜å…ˆä½¿ç”¨ç­‰çº§å¡ç³»ç»Ÿï¼‰\r\n-    console.log('ğŸ’ æ£€æŸ¥ç§¯åˆ†...')\r\n     if (onProgress) onProgress('æ­£åœ¨æ£€æŸ¥ç§¯åˆ†...', 10)\r\n \r\n     const pointsStatus = await levelCardPointsManager.getPointsStatus()\r\n     if (!pointsStatus.canGenerate) {\r\n       throw new Error(`ç§¯åˆ†ä¸è¶³ï¼å½“å‰ç§¯åˆ†: ${pointsStatus.current}ï¼Œéœ€è¦: ${pointsStatus.generationCost}`)\r\n     }\r\n \r\n-    console.log('ğŸ“‹ æµç¨‹ï¼šç¬¬ä¸€æ­¥ä¸Šä¼ å›¾ç‰‡ â†’ ç¬¬äºŒæ­¥æäº¤å·¥ä½œæµ')\r\n-\r\n     // éªŒè¯å›¾ç‰‡æ•°æ®æ ¼å¼\r\n-    console.log('ğŸ” éªŒè¯å›¾ç‰‡æ•°æ®æ ¼å¼...')\r\n     if (onProgress) onProgress('æ­£åœ¨éªŒè¯å›¾ç‰‡æ ¼å¼...', 15)\r\n \r\n     if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n       throw new Error('æ— æ•ˆçš„å›¾ç‰‡æ•°æ®æ ¼å¼')\r\n     }\r\n \r\n     // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨\r\n-    console.log('ğŸ“¤ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ° /api/upload/image')\r\n     if (onProgress) onProgress('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡åˆ°ComfyUI...', 20)\r\n \r\n     const uploadedImageName = await uploadImageToComfyUI(base64Image)\r\n-    console.log('âœ… ç¬¬ä¸€æ­¥å®Œæˆï¼Œè·å¾—æ–‡ä»¶å:', uploadedImageName)\r\n+    console.log('âœ… å›¾ç‰‡ä¸Šä¼ å®Œæˆ:', uploadedImageName)\r\n \r\n     // åˆ›å»ºå·¥ä½œæµæç¤ºè¯ï¼Œå°†ä¸Šä¼ çš„å›¾ç‰‡å…³è”åˆ°èŠ‚ç‚¹49\r\n-    console.log('ğŸ”§ é…ç½®å·¥ä½œæµï¼Œå…³è”å›¾ç‰‡åˆ°èŠ‚ç‚¹49...')\r\n     if (onProgress) onProgress('æ­£åœ¨é…ç½®å·¥ä½œæµ...', 30)\r\n \r\n     const workflowPrompt = createUndressWorkflowPrompt(uploadedImageName)\r\n \r\n     // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµ\r\n-    console.log('ğŸš€ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ° /api/prompt')\r\n     if (onProgress) onProgress('æ­£åœ¨æäº¤å·¥ä½œæµåˆ°ComfyUI...', 40)\r\n \r\n     const promptId = await submitWorkflow(workflowPrompt)\r\n-    console.log('âœ… ç¬¬äºŒæ­¥å®Œæˆï¼Œè·å¾—ä»»åŠ¡ID:', promptId)\r\n+    console.log('âœ… å·¥ä½œæµæäº¤å®Œæˆï¼Œä»»åŠ¡ID:', promptId)\r\n \r\n     // ç­‰å¾…ä»»åŠ¡å®Œæˆ - ä¼ é€’å‰ç«¯è¿›åº¦å›è°ƒ\r\n-    console.log('â³ ç­‰å¾…ComfyUIå¤„ç†ä»»åŠ¡...')\r\n     if (onProgress) onProgress('æ­£åœ¨ç­‰å¾…ComfyUIå¤„ç†...', 50)\r\n \r\n     const taskResult = await waitForTaskCompletion(promptId, 300000, (status, progress) => {\r\n-      console.log(`ğŸ“ŠğŸ“ŠğŸ“Š WebSocketè¿›åº¦æ›´æ–° ğŸ“ŠğŸ“ŠğŸ“Š`)\r\n-      console.log(`ä»»åŠ¡è¿›åº¦: ${status} - ${progress}%`)\r\n-\r\n       // å°†WebSocketè¿›åº¦ä¼ é€’ç»™å‰ç«¯\r\n       if (onProgress) {\r\n         // ç¡®ä¿è¿›åº¦åœ¨50-95ä¹‹é—´ï¼Œä¸ºæœ€åçš„å›¾ç‰‡è·å–ç•™å‡ºç©ºé—´\r\n         const adjustedProgress = Math.min(95, Math.max(50, 50 + (progress * 0.45)))\r\n-        console.log(`ğŸ”„ ä¼ é€’ç»™å‰ç«¯çš„è°ƒæ•´åè¿›åº¦: ${adjustedProgress}%`)\r\n         onProgress(status, adjustedProgress)\r\n       }\r\n     })\r\n-    console.log('âœ…âœ…âœ… ä»»åŠ¡å¤„ç†å®Œæˆ âœ…âœ…âœ…')\r\n+    console.log('âœ… ä»»åŠ¡å¤„ç†å®Œæˆ')\r\n \r\n     // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n     console.log('ğŸ“¥ è·å–ç”Ÿæˆçš„å›¾ç‰‡...')\r\n     if (onProgress) onProgress('æ­£åœ¨è·å–å¤„ç†ç»“æœ...', 96)\r\n"
                },
                {
                    "date": 1752467797795,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1133,22 +1133,19 @@\n     })\r\n     console.log('âœ… ä»»åŠ¡å¤„ç†å®Œæˆ')\r\n \r\n     // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n-    console.log('ğŸ“¥ è·å–ç”Ÿæˆçš„å›¾ç‰‡...')\r\n     if (onProgress) onProgress('æ­£åœ¨è·å–å¤„ç†ç»“æœ...', 96)\r\n \r\n     const resultImage = await getGeneratedImage(taskResult)\r\n-    console.log('ğŸ‰ğŸ‰ğŸ‰ æ¢è¡£å¤„ç†å®Œå…¨æˆåŠŸ! ğŸ‰ğŸ‰ğŸ‰')\r\n+    console.log('ğŸ‰ æ¢è¡£å¤„ç†æˆåŠŸ!')\r\n \r\n     // æ¶ˆè€—ç§¯åˆ†ï¼ˆä»ç­‰çº§å¡æ‰£é™¤ï¼‰\r\n-    console.log('ğŸ’ æ¶ˆè€—ç§¯åˆ†...')\r\n     if (onProgress) onProgress('æ­£åœ¨æ›´æ–°ç§¯åˆ†...', 98)\r\n \r\n     // è·å– ComfyUI å›¾ç‰‡è®¿é—®URLè€Œä¸æ˜¯ base64 æ•°æ®\r\n     const imageViewUrl = getComfyUIImageUrl(resultImage)\r\n     const pointsResult = await levelCardPointsManager.consumePoints(20, 'ä¸€é”®æ¢è¡£', imageViewUrl)\r\n-    console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ç§¯åˆ†ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n \r\n     // è·å–èŠ‚ç‚¹49çš„åŸå›¾ç”¨äºå¯¹æ¯”\r\n     let originalImage = null\r\n     try {\r\n@@ -1158,20 +1155,17 @@\n         type: 'input',\r\n         subfolder: ''\r\n       })\r\n       const config = getComfyUIConfig()\r\n-      const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n+      const apiBaseUrl = await getApiBaseUrl()\r\n       originalImage = `${apiBaseUrl}/view?${params.toString()}`\r\n-      console.log('ğŸ“· è·å–èŠ‚ç‚¹49åŸå›¾URL:', originalImage)\r\n     } catch (error) {\r\n-      console.warn('âš ï¸ è·å–èŠ‚ç‚¹49åŸå›¾å¤±è´¥ï¼Œä½¿ç”¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡:', error)\r\n+      console.warn('âš ï¸ è·å–åŸå›¾å¤±è´¥:', error)\r\n     }\r\n \r\n     // æœ€ç»ˆå®Œæˆ\r\n     if (onProgress) onProgress('å¤„ç†å®Œæˆ', 100)\r\n \r\n-    console.log('ğŸŠğŸŠğŸŠ æ‰€æœ‰å¤„ç†æ­¥éª¤å®Œæˆï¼Œå‡†å¤‡è¿”å›ç»“æœ ğŸŠğŸŠğŸŠ')\r\n-\r\n     return {\r\n       success: true,\r\n       resultImage: resultImage,\r\n       originalImage: originalImage, // æ–°å¢ï¼šèŠ‚ç‚¹49çš„åŸå›¾\r\n"
                },
                {
                    "date": 1752468047385,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1216,9 +1216,8 @@\n   try {\r\n     console.log('ğŸš€ å¼€å§‹æ¢è„¸å¤„ç†')\r\n \r\n     // æ£€æŸ¥ç§¯åˆ†ï¼ˆä¼˜å…ˆä½¿ç”¨ç­‰çº§å¡ç³»ç»Ÿï¼‰\r\n-    console.log('ğŸ’ æ£€æŸ¥ç§¯åˆ†...')\r\n     const pointsStatus = await levelCardPointsManager.getPointsStatus()\r\n     if (!pointsStatus.canGenerate) {\r\n       throw new Error(`ç§¯åˆ†ä¸è¶³ï¼å½“å‰ç§¯åˆ†: ${pointsStatus.current}ï¼Œéœ€è¦: ${pointsStatus.generationCost}`)\r\n     }\r\n"
                },
                {
                    "date": 1752468076057,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1279,25 +1279,20 @@\n     // èŠ‚ç‚¹812: å¤„ç†ç»“æœè¾“å‡ºï¼ˆæœ€æ–°ï¼‰\r\n \r\n     if (workflow['670']) {\r\n       workflow['670'].inputs.image = uploadedFacePhotos[0]\r\n-      console.log('âœ… èŠ‚ç‚¹670è®¾ç½®ç¬¬ä¸€å¼ äººè„¸ç…§ç‰‡:', uploadedFacePhotos[0])\r\n     }\r\n     if (workflow['662']) {\r\n       workflow['662'].inputs.image = uploadedFacePhotos[1]\r\n-      console.log('âœ… èŠ‚ç‚¹662è®¾ç½®ç¬¬äºŒå¼ äººè„¸ç…§ç‰‡:', uploadedFacePhotos[1])\r\n     }\r\n     if (workflow['658']) {\r\n       workflow['658'].inputs.image = uploadedFacePhotos[2]\r\n-      console.log('âœ… èŠ‚ç‚¹658è®¾ç½®ç¬¬ä¸‰å¼ äººè„¸ç…§ç‰‡:', uploadedFacePhotos[2])\r\n     }\r\n     if (workflow['655']) {\r\n       workflow['655'].inputs.image = uploadedFacePhotos[3]\r\n-      console.log('âœ… èŠ‚ç‚¹655è®¾ç½®ç¬¬å››å¼ äººè„¸ç…§ç‰‡:', uploadedFacePhotos[3])\r\n     }\r\n     if (workflow['737']) {\r\n       workflow['737'].inputs.image = targetUploadedFilename\r\n-      console.log('âœ… èŠ‚ç‚¹737è®¾ç½®ç›®æ ‡å›¾ç‰‡:', targetUploadedFilename)\r\n     }\r\n \r\n     if (onProgress) onProgress('æ­£åœ¨æäº¤æ¢è„¸ä»»åŠ¡...', 80)\r\n \r\n"
                },
                {
                    "date": 1752468098945,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1302,29 +1302,21 @@\n     if (onProgress) onProgress('æ­£åœ¨å¤„ç†æ¢è„¸...', 85)\r\n \r\n     // ç­‰å¾…ä»»åŠ¡å®Œæˆ - æ¢è„¸éœ€è¦æ›´é•¿æ—¶é—´ï¼Œè®¾ç½®10åˆ†é’Ÿè¶…æ—¶\r\n     const maxWaitTime = 600000 // 10åˆ†é’Ÿ\r\n-    console.log(`â³ å¼€å§‹ç­‰å¾…æ¢è„¸ä»»åŠ¡å®Œæˆï¼Œä»»åŠ¡ID: ${promptId}ï¼Œæœ€å¤§ç­‰å¾…æ—¶é—´: ${maxWaitTime/1000}ç§’`)\r\n \r\n     const taskResult = await waitForTaskCompletion(promptId, maxWaitTime, onProgress)\r\n-    console.log('âœ… æ¢è„¸ä»»åŠ¡å¤„ç†å®Œæˆï¼Œç»“æœ:', taskResult)\r\n+    console.log('âœ… æ¢è„¸ä»»åŠ¡å¤„ç†å®Œæˆ')\r\n \r\n     if (onProgress) onProgress('æ­£åœ¨è·å–å¤„ç†ç»“æœ...', 95)\r\n \r\n     // è·å–ç»“æœå›¾ç‰‡\r\n-    // æ ¹æ®æœ€æ–°å·¥ä½œæµï¼Œæœ€ç»ˆç»“æœåº”è¯¥åœ¨èŠ‚ç‚¹812çš„è¾“å‡º\r\n-    console.log('ğŸ“¥ å¼€å§‹è·å–æ¢è„¸ç»“æœå›¾ç‰‡ï¼ŒæŸ¥æ‰¾èŠ‚ç‚¹812çš„è¾“å‡º...')\r\n-    console.log('ğŸ” ä»»åŠ¡ç»“æœç»“æ„:', JSON.stringify(taskResult, null, 2))\r\n-\r\n     const imageUrl = await getGeneratedImage(taskResult)\r\n-    console.log('ğŸ–¼ï¸ æˆåŠŸè·å–æ¢è„¸ç»“æœå›¾ç‰‡URL')\r\n \r\n     // æ¶ˆè€—ç§¯åˆ†ï¼ˆä»ç­‰çº§å¡æ‰£é™¤ï¼‰\r\n-    console.log('ğŸ’ æ¶ˆè€—ç§¯åˆ†...')\r\n     // è·å– ComfyUI å›¾ç‰‡è®¿é—®URLè€Œä¸æ˜¯ base64 æ•°æ®\r\n     const imageViewUrl = getComfyUIImageUrl(imageUrl)\r\n     const pointsResult = await levelCardPointsManager.consumePoints(20, 'æé€Ÿæ¢è„¸', imageViewUrl)\r\n-    console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ç§¯åˆ†ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n \r\n     if (onProgress) onProgress('æ¢è„¸å®Œæˆï¼', 100)\r\n \r\n     console.log('âœ… æ¢è„¸å¤„ç†å®Œæˆ')\r\n"
                },
                {
                    "date": 1752468993701,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -740,13 +740,63 @@\n       }\r\n \r\n       wsConnection.onmessage = (event) => {\r\n         try {\r\n+          // æ£€æŸ¥æ¶ˆæ¯æ•°æ®æ˜¯å¦ä¸ºç©ºæˆ–æ— æ•ˆ\r\n+          if (!event.data || typeof event.data !== 'string') {\r\n+            console.warn('âš ï¸ æ”¶åˆ°ç©ºæˆ–æ— æ•ˆçš„WebSocketæ¶ˆæ¯')\r\n+            return\r\n+          }\r\n+\r\n+          // æ£€æŸ¥æ˜¯å¦æ˜¯çº¯æ–‡æœ¬æ¶ˆæ¯ï¼ˆéJSONï¼‰\r\n+          const rawData = event.data.trim()\r\n+          if (rawData.length === 0) {\r\n+            console.warn('âš ï¸ æ”¶åˆ°ç©ºçš„WebSocketæ¶ˆæ¯')\r\n+            return\r\n+          }\r\n+\r\n+          // æ£€æŸ¥æ˜¯å¦æ˜¯å¿ƒè·³æˆ–çŠ¶æ€æ¶ˆæ¯\r\n+          if (rawData === 'ping' || rawData === 'pong' || rawData === 'heartbeat') {\r\n+            // å¿ƒè·³æ¶ˆæ¯ï¼Œä¸éœ€è¦å¤„ç†\r\n+            return\r\n+          }\r\n+\r\n           let message;\r\n           try {\r\n-            message = JSON.parse(event.data)\r\n+            message = JSON.parse(rawData)\r\n           } catch (parseError) {\r\n             console.error('âŒ WebSocketæ¶ˆæ¯è§£æå¤±è´¥:', parseError)\r\n+            console.error('åŸå§‹æ¶ˆæ¯å†…å®¹:', rawData.substring(0, 200) + (rawData.length > 200 ? '...' : ''))\r\n+            console.error('æ¶ˆæ¯é•¿åº¦:', rawData.length)\r\n+            console.error('æ¶ˆæ¯å¼€å¤´å­—ç¬¦:', rawData.charCodeAt(0), rawData.charAt(0))\r\n+\r\n+            // å°è¯•ä¿®å¤å¸¸è§çš„JSONæ ¼å¼é—®é¢˜\r\n+            let fixedData = rawData;\r\n+\r\n+            // ç§»é™¤å¯èƒ½çš„BOMæˆ–ç‰¹æ®Šå­—ç¬¦\r\n+            if (rawData.charCodeAt(0) === 0xFEFF) {\r\n+              fixedData = rawData.substring(1)\r\n+            }\r\n+\r\n+            // ç§»é™¤å¼€å¤´çš„éJSONå­—ç¬¦\r\n+            const jsonStart = fixedData.indexOf('{')\r\n+            if (jsonStart > 0) {\r\n+              fixedData = fixedData.substring(jsonStart)\r\n+            }\r\n+\r\n+            // å°è¯•å†æ¬¡è§£æ\r\n+            try {\r\n+              message = JSON.parse(fixedData)\r\n+              console.log('âœ… ä¿®å¤åçš„æ¶ˆæ¯è§£ææˆåŠŸ')\r\n+            } catch (secondParseError) {\r\n+              console.error('âŒ ä¿®å¤åä»æ— æ³•è§£ææ¶ˆæ¯ï¼Œè·³è¿‡æ­¤æ¶ˆæ¯')\r\n+              return\r\n+            }\r\n+          }\r\n+\r\n+          // éªŒè¯æ¶ˆæ¯å¯¹è±¡\r\n+          if (!message || typeof message !== 'object') {\r\n+            console.warn('âš ï¸ è§£æåçš„æ¶ˆæ¯ä¸æ˜¯æœ‰æ•ˆå¯¹è±¡:', message)\r\n             return\r\n           }\r\n \r\n           // æ£€æŸ¥æ¶ˆæ¯æ ¼å¼å¹¶æ ‡å‡†åŒ–\r\n@@ -760,9 +810,9 @@\n               normalizedMessage = {\r\n                 type: 'executed',\r\n                 data: message\r\n               }\r\n-            } else if (message.prompt_id && message.node) {\r\n+            } else if (message.prompt_id && message.node !== undefined) {\r\n               normalizedMessage = {\r\n                 type: 'executing',\r\n                 data: message\r\n               }\r\n@@ -770,14 +820,20 @@\n               normalizedMessage = {\r\n                 type: 'progress',\r\n                 data: message\r\n               }\r\n+            } else if (message.prompt_id && message.timestamp) {\r\n+              normalizedMessage = {\r\n+                type: 'execution_success',\r\n+                data: message\r\n+              }\r\n             }\r\n           }\r\n \r\n           handleWebSocketMessage(normalizedMessage)\r\n         } catch (error) {\r\n           console.error('âŒ å¤„ç†WebSocketæ¶ˆæ¯å¤±è´¥:', error)\r\n+          console.error('é”™è¯¯å †æ ˆ:', error.stack)\r\n         }\r\n       }\r\n     })\r\n   } catch (error) {\r\n"
                },
                {
                    "date": 1752469037973,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -716,17 +716,42 @@\n \r\n         // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n         showWebSocketStatusNotification('WebSocketè¿æ¥å·²æ–­å¼€', 'warning')\r\n \r\n-        // å°è¯•é‡æ–°è¿æ¥\r\n+        // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„ä»»åŠ¡\r\n+        const hasPendingTasks = pendingTasks.size > 0\r\n+        if (hasPendingTasks) {\r\n+          console.warn(`âš ï¸ WebSocketæ–­å¼€æ—¶æœ‰ ${pendingTasks.size} ä¸ªå¾…å¤„ç†ä»»åŠ¡`)\r\n+          showWebSocketStatusNotification(`è¿æ¥æ–­å¼€ï¼Œæœ‰ ${pendingTasks.size} ä¸ªä»»åŠ¡å¾…å¤„ç†`, 'warning')\r\n+        }\r\n+\r\n+        // æ™ºèƒ½é‡è¿ç­–ç•¥\r\n         if (!wsReconnectTimer) {\r\n-          wsReconnectTimer = setTimeout(() => {\r\n+          // å¦‚æœæœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œç«‹å³é‡è¿ï¼›å¦åˆ™å»¶è¿Ÿé‡è¿\r\n+          const reconnectDelay = hasPendingTasks ? 1000 : 5000\r\n+\r\n+          wsReconnectTimer = setTimeout(async () => {\r\n             wsReconnectTimer = null\r\n             console.log('ğŸ”„ å°è¯•é‡æ–°è¿æ¥ ComfyUI WebSocket...')\r\n-            initializeWebSocket().catch(error => {\r\n+\r\n+            try {\r\n+              await initializeWebSocket()\r\n+\r\n+              // é‡è¿æˆåŠŸåï¼Œæ£€æŸ¥å¾…å¤„ç†ä»»åŠ¡çš„çŠ¶æ€\r\n+              if (hasPendingTasks) {\r\n+                console.log('ğŸ” é‡è¿æˆåŠŸï¼Œæ£€æŸ¥å¾…å¤„ç†ä»»åŠ¡çŠ¶æ€...')\r\n+                await checkPendingTasksStatus()\r\n+              }\r\n+            } catch (error) {\r\n               console.error('âŒ WebSocket é‡è¿å¤±è´¥:', error)\r\n-            })\r\n-          }, 5000)\r\n+\r\n+              // å¦‚æœæœ‰å¾…å¤„ç†ä»»åŠ¡ä½†é‡è¿å¤±è´¥ï¼Œå°è¯•é€šè¿‡HTTPè½®è¯¢æ£€æŸ¥çŠ¶æ€\r\n+              if (hasPendingTasks) {\r\n+                console.log('ğŸ”„ WebSocketé‡è¿å¤±è´¥ï¼Œå°è¯•HTTPè½®è¯¢æ£€æŸ¥ä»»åŠ¡çŠ¶æ€...')\r\n+                await fallbackToHttpPolling()\r\n+              }\r\n+            }\r\n+          }, reconnectDelay)\r\n         }\r\n       }\r\n \r\n       wsConnection.onerror = (error) => {\r\n"
                },
                {
                    "date": 1752469065495,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -866,8 +866,100 @@\n     throw error\r\n   }\r\n }\r\n \r\n+// æ£€æŸ¥å¾…å¤„ç†ä»»åŠ¡çŠ¶æ€\r\n+async function checkPendingTasksStatus() {\r\n+  const taskIds = Array.from(pendingTasks.keys())\r\n+  console.log(`ğŸ” æ£€æŸ¥ ${taskIds.length} ä¸ªå¾…å¤„ç†ä»»åŠ¡çš„çŠ¶æ€...`)\r\n+\r\n+  for (const promptId of taskIds) {\r\n+    try {\r\n+      const result = await checkTaskStatus(promptId)\r\n+\r\n+      if (result && result.status && result.status.completed) {\r\n+        console.log(`âœ… å‘ç°ä»»åŠ¡ ${promptId} å·²å®Œæˆï¼Œè§¦å‘å›è°ƒ`)\r\n+\r\n+        const task = pendingTasks.get(promptId)\r\n+        if (task && task.onComplete) {\r\n+          task.onComplete(result)\r\n+          pendingTasks.delete(promptId)\r\n+          showWebSocketStatusNotification(`ä»»åŠ¡ ${promptId.substring(0, 8)} å·²å®Œæˆ`, 'success')\r\n+        }\r\n+      } else if (result && result.status && result.status.status_str === 'error') {\r\n+        console.error(`âŒ å‘ç°ä»»åŠ¡ ${promptId} æ‰§è¡Œå¤±è´¥`)\r\n+\r\n+        const task = pendingTasks.get(promptId)\r\n+        if (task && task.onError) {\r\n+          task.onError('ä»»åŠ¡æ‰§è¡Œå¤±è´¥')\r\n+          pendingTasks.delete(promptId)\r\n+          showWebSocketStatusNotification(`ä»»åŠ¡ ${promptId.substring(0, 8)} æ‰§è¡Œå¤±è´¥`, 'error')\r\n+        }\r\n+      }\r\n+    } catch (error) {\r\n+      console.error(`âŒ æ£€æŸ¥ä»»åŠ¡ ${promptId} çŠ¶æ€å¤±è´¥:`, error)\r\n+    }\r\n+  }\r\n+}\r\n+\r\n+// HTTPè½®è¯¢å¤‡ç”¨æœºåˆ¶\r\n+async function fallbackToHttpPolling() {\r\n+  const taskIds = Array.from(pendingTasks.keys())\r\n+  if (taskIds.length === 0) {\r\n+    return\r\n+  }\r\n+\r\n+  console.log(`ğŸ”„ å¯åŠ¨HTTPè½®è¯¢å¤‡ç”¨æœºåˆ¶ï¼Œç›‘æ§ ${taskIds.length} ä¸ªä»»åŠ¡...`)\r\n+  showWebSocketStatusNotification('ä½¿ç”¨HTTPè½®è¯¢ç›‘æ§ä»»åŠ¡çŠ¶æ€', 'info')\r\n+\r\n+  const pollInterval = setInterval(async () => {\r\n+    try {\r\n+      // å¦‚æœWebSocketé‡æ–°è¿æ¥æˆåŠŸï¼Œåœæ­¢è½®è¯¢\r\n+      if (isWsConnected) {\r\n+        console.log('âœ… WebSocketå·²é‡è¿ï¼Œåœæ­¢HTTPè½®è¯¢')\r\n+        clearInterval(pollInterval)\r\n+        return\r\n+      }\r\n+\r\n+      // æ£€æŸ¥å‰©ä½™ä»»åŠ¡\r\n+      const remainingTasks = Array.from(pendingTasks.keys())\r\n+      if (remainingTasks.length === 0) {\r\n+        console.log('âœ… æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼Œåœæ­¢HTTPè½®è¯¢')\r\n+        clearInterval(pollInterval)\r\n+        return\r\n+      }\r\n+\r\n+      // æ£€æŸ¥æ¯ä¸ªä»»åŠ¡çš„çŠ¶æ€\r\n+      for (const promptId of remainingTasks) {\r\n+        try {\r\n+          const result = await checkTaskStatus(promptId)\r\n+\r\n+          if (result && result.status && result.status.completed) {\r\n+            console.log(`âœ… HTTPè½®è¯¢å‘ç°ä»»åŠ¡ ${promptId} å·²å®Œæˆ`)\r\n+\r\n+            const task = pendingTasks.get(promptId)\r\n+            if (task && task.onComplete) {\r\n+              task.onComplete(result)\r\n+              pendingTasks.delete(promptId)\r\n+              showWebSocketStatusNotification(`ä»»åŠ¡å®Œæˆ (HTTPè½®è¯¢)`, 'success')\r\n+            }\r\n+          }\r\n+        } catch (error) {\r\n+          console.error(`âŒ HTTPè½®è¯¢æ£€æŸ¥ä»»åŠ¡ ${promptId} å¤±è´¥:`, error)\r\n+        }\r\n+      }\r\n+    } catch (error) {\r\n+      console.error('âŒ HTTPè½®è¯¢è¿‡ç¨‹ä¸­å‡ºé”™:', error)\r\n+    }\r\n+  }, 3000) // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡\r\n+\r\n+  // è®¾ç½®è½®è¯¢è¶…æ—¶ï¼ˆ5åˆ†é’Ÿååœæ­¢ï¼‰\r\n+  setTimeout(() => {\r\n+    clearInterval(pollInterval)\r\n+    console.log('â° HTTPè½®è¯¢è¶…æ—¶ï¼Œåœæ­¢è½®è¯¢')\r\n+  }, 300000)\r\n+}\r\n+\r\n // å¤„ç† WebSocket æ¶ˆæ¯ - æ ¹æ®ComfyUIå®˜æ–¹æ–‡æ¡£è§„èŒƒ\r\n function handleWebSocketMessage(message) {\r\n   try {\r\n     const { type, data } = message\r\n"
                },
                {
                    "date": 1752469115578,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1181,16 +1181,41 @@\n     throw new Error(`WebSocketè¿æ¥å¤±è´¥: ${error.message}`)\r\n   }\r\n \r\n   return new Promise((resolve, reject) => {\r\n+    let isResolved = false\r\n+    let wsCheckInterval = null\r\n+\r\n     // è®¾ç½®è¶…æ—¶\r\n-    const timeout = setTimeout(() => {\r\n-      console.warn(`â° ä»»åŠ¡ ${promptId} ç­‰å¾…è¶…æ—¶`)\r\n+    const timeout = setTimeout(async () => {\r\n+      if (isResolved) return\r\n+\r\n+      console.warn(`â° ä»»åŠ¡ ${promptId} ç­‰å¾…è¶…æ—¶ï¼Œå°è¯•æœ€åæ£€æŸ¥...`)\r\n+\r\n+      // è¶…æ—¶å‰æœ€åå°è¯•æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n+      try {\r\n+        const result = await checkTaskStatus(promptId)\r\n+        if (result && result.status && result.status.completed) {\r\n+          console.log(`âœ… è¶…æ—¶æ£€æŸ¥å‘ç°ä»»åŠ¡ ${promptId} å·²å®Œæˆ`)\r\n+          isResolved = true\r\n+          clearInterval(wsCheckInterval)\r\n+          pendingTasks.delete(promptId)\r\n+\r\n+          if (onProgress) {\r\n+            onProgress('å¤„ç†å®Œæˆ', 100)\r\n+          }\r\n+\r\n+          resolve(result)\r\n+          return\r\n+        }\r\n+      } catch (error) {\r\n+        console.error('âŒ è¶…æ—¶æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error)\r\n+      }\r\n+\r\n+      // ç¡®å®è¶…æ—¶\r\n       pendingTasks.delete(promptId)\r\n-\r\n-      // æ˜¾ç¤ºè¶…æ—¶é€šçŸ¥\r\n+      clearInterval(wsCheckInterval)\r\n       showWebSocketStatusNotification('ä»»åŠ¡å¤„ç†è¶…æ—¶', 'error')\r\n-\r\n       reject(new Error(`ä»»åŠ¡ ${promptId} æ‰§è¡Œè¶…æ—¶`))\r\n     }, maxWaitTime)\r\n \r\n     // åˆ›å»ºä»»åŠ¡è·Ÿè¸ªå¯¹è±¡\r\n@@ -1202,9 +1227,13 @@\n           onProgress(`æ­£åœ¨å¤„ç†: ${status}`, progress)\r\n         }\r\n       },\r\n       onComplete: (result) => {\r\n+        if (isResolved) return\r\n+        isResolved = true\r\n+\r\n         clearTimeout(timeout)\r\n+        clearInterval(wsCheckInterval)\r\n         console.log(`âœ… ä»»åŠ¡ ${promptId} å®Œæˆ`)\r\n \r\n         if (onProgress) {\r\n           onProgress('å¤„ç†å®Œæˆ', 100)\r\n@@ -1212,9 +1241,13 @@\n \r\n         resolve(result)\r\n       },\r\n       onError: (error) => {\r\n+        if (isResolved) return\r\n+        isResolved = true\r\n+\r\n         clearTimeout(timeout)\r\n+        clearInterval(wsCheckInterval)\r\n         console.error(`âŒ ä»»åŠ¡ ${promptId} å¤±è´¥:`, error)\r\n \r\n         if (onProgress) {\r\n           onProgress('å¤„ç†å¤±è´¥', 0)\r\n@@ -1226,8 +1259,34 @@\n         reject(new Error(error))\r\n       }\r\n     }\r\n \r\n+    // WebSocketè¿æ¥ç›‘æ§\r\n+    wsCheckInterval = setInterval(async () => {\r\n+      if (isResolved) {\r\n+        clearInterval(wsCheckInterval)\r\n+        return\r\n+      }\r\n+\r\n+      // æ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€\r\n+      if (!isWsConnected || !wsConnection || wsConnection.readyState !== WebSocket.OPEN) {\r\n+        console.warn(`âš ï¸ æ£€æµ‹åˆ°WebSocketæ–­å¼€ï¼Œä»»åŠ¡ ${promptId} åˆ‡æ¢åˆ°HTTPè½®è¯¢æ¨¡å¼`)\r\n+\r\n+        try {\r\n+          const result = await checkTaskStatus(promptId)\r\n+          if (result && result.status && result.status.completed) {\r\n+            console.log(`âœ… HTTPè½®è¯¢å‘ç°ä»»åŠ¡ ${promptId} å·²å®Œæˆ`)\r\n+            task.onComplete(result)\r\n+          } else if (result && result.status && result.status.status_str === 'error') {\r\n+            console.error(`âŒ HTTPè½®è¯¢å‘ç°ä»»åŠ¡ ${promptId} æ‰§è¡Œå¤±è´¥`)\r\n+            task.onError('ä»»åŠ¡æ‰§è¡Œå¤±è´¥')\r\n+          }\r\n+        } catch (error) {\r\n+          console.error(`âŒ HTTPè½®è¯¢æ£€æŸ¥ä»»åŠ¡ ${promptId} å¤±è´¥:`, error)\r\n+        }\r\n+      }\r\n+    }, 5000) // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡\r\n+\r\n     // æ³¨å†Œä»»åŠ¡åˆ°å¾…å¤„ç†åˆ—è¡¨\r\n     pendingTasks.set(promptId, task)\r\n \r\n     // ç¡®è®¤WebSocketè¿æ¥çŠ¶æ€\r\n"
                },
                {
                    "date": 1752469183553,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -617,8 +617,12 @@\n let wsReconnectTimer = null\r\n let isWsConnected = false\r\n let wsMessageHandlers = new Map()\r\n let pendingTasks = new Map()\r\n+let wsHealthCheckTimer = null\r\n+let lastMessageTime = Date.now()\r\n+let connectionAttempts = 0\r\n+let maxConnectionAttempts = 5\r\n \r\n // å‰ç«¯é€šçŸ¥å‡½æ•°\r\n function showWebSocketStatusNotification(message, type = 'info') {\r\n   try {\r\n"
                },
                {
                    "date": 1752469201226,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -769,8 +769,11 @@\n       }\r\n \r\n       wsConnection.onmessage = (event) => {\r\n         try {\r\n+          // æ›´æ–°æœ€åæ¶ˆæ¯æ—¶é—´\r\n+          lastMessageTime = Date.now()\r\n+\r\n           // æ£€æŸ¥æ¶ˆæ¯æ•°æ®æ˜¯å¦ä¸ºç©ºæˆ–æ— æ•ˆ\r\n           if (!event.data || typeof event.data !== 'string') {\r\n             console.warn('âš ï¸ æ”¶åˆ°ç©ºæˆ–æ— æ•ˆçš„WebSocketæ¶ˆæ¯')\r\n             return\r\n"
                },
                {
                    "date": 1752469229141,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -703,11 +703,16 @@\n \r\n       wsConnection.onopen = () => {\r\n         console.log('âœ… ComfyUI WebSocket è¿æ¥æˆåŠŸ')\r\n         isWsConnected = true\r\n+        connectionAttempts = 0 // é‡ç½®è¿æ¥å°è¯•æ¬¡æ•°\r\n+        lastMessageTime = Date.now() // é‡ç½®æœ€åæ¶ˆæ¯æ—¶é—´\r\n         clearTimeout(timeout)\r\n         clearTimeout(wsReconnectTimer)\r\n \r\n+        // å¯åŠ¨å¥åº·æ£€æŸ¥\r\n+        startWebSocketHealthCheck()\r\n+\r\n         // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n         showWebSocketStatusNotification('WebSocketè¿æ¥æˆåŠŸ', 'success')\r\n \r\n         resolve(true)\r\n"
                },
                {
                    "date": 1752469245963,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -722,8 +722,11 @@\n         console.log(`ğŸ”Œ ComfyUI WebSocket è¿æ¥å…³é—­: ä»£ç =${event.code}, åŸå› =${event.reason}`)\r\n         isWsConnected = false\r\n         clearTimeout(timeout)\r\n \r\n+        // åœæ­¢å¥åº·æ£€æŸ¥\r\n+        stopWebSocketHealthCheck()\r\n+\r\n         // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n         showWebSocketStatusNotification('WebSocketè¿æ¥å·²æ–­å¼€', 'warning')\r\n \r\n         // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„ä»»åŠ¡\r\n"
                },
                {
                    "date": 1752469266784,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -881,8 +881,53 @@\n     throw error\r\n   }\r\n }\r\n \r\n+// WebSocketå¥åº·æ£€æŸ¥\r\n+function startWebSocketHealthCheck() {\r\n+  // æ¸…é™¤ç°æœ‰çš„å¥åº·æ£€æŸ¥\r\n+  stopWebSocketHealthCheck()\r\n+\r\n+  wsHealthCheckTimer = setInterval(() => {\r\n+    const now = Date.now()\r\n+    const timeSinceLastMessage = now - lastMessageTime\r\n+\r\n+    // å¦‚æœè¶…è¿‡30ç§’æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ï¼Œè®¤ä¸ºè¿æ¥å¯èƒ½æœ‰é—®é¢˜\r\n+    if (timeSinceLastMessage > 30000) {\r\n+      console.warn(`âš ï¸ WebSocketå¥åº·æ£€æŸ¥ï¼š${timeSinceLastMessage/1000}ç§’æœªæ”¶åˆ°æ¶ˆæ¯`)\r\n+\r\n+      // æ£€æŸ¥è¿æ¥çŠ¶æ€\r\n+      if (wsConnection && wsConnection.readyState !== WebSocket.OPEN) {\r\n+        console.warn('âš ï¸ WebSocketè¿æ¥çŠ¶æ€å¼‚å¸¸ï¼Œå°è¯•é‡è¿')\r\n+        isWsConnected = false\r\n+\r\n+        // å¦‚æœæœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œç«‹å³å°è¯•é‡è¿\r\n+        if (pendingTasks.size > 0) {\r\n+          console.log('ğŸ”„ æ£€æµ‹åˆ°å¾…å¤„ç†ä»»åŠ¡ï¼Œç«‹å³é‡è¿WebSocket')\r\n+          initializeWebSocket().catch(error => {\r\n+            console.error('âŒ å¥åº·æ£€æŸ¥é‡è¿å¤±è´¥:', error)\r\n+            // å¯åŠ¨HTTPè½®è¯¢å¤‡ç”¨æœºåˆ¶\r\n+            fallbackToHttpPolling()\r\n+          })\r\n+        }\r\n+      }\r\n+    }\r\n+\r\n+    // å¦‚æœè¶…è¿‡60ç§’æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ä¸”æœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œå¯åŠ¨HTTPè½®è¯¢\r\n+    if (timeSinceLastMessage > 60000 && pendingTasks.size > 0) {\r\n+      console.warn('âš ï¸ WebSocketé•¿æ—¶é—´æ— å“åº”ï¼Œå¯åŠ¨HTTPè½®è¯¢å¤‡ç”¨æœºåˆ¶')\r\n+      fallbackToHttpPolling()\r\n+    }\r\n+  }, 10000) // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡\r\n+}\r\n+\r\n+function stopWebSocketHealthCheck() {\r\n+  if (wsHealthCheckTimer) {\r\n+    clearInterval(wsHealthCheckTimer)\r\n+    wsHealthCheckTimer = null\r\n+  }\r\n+}\r\n+\r\n // æ£€æŸ¥å¾…å¤„ç†ä»»åŠ¡çŠ¶æ€\r\n async function checkPendingTasksStatus() {\r\n   const taskIds = Array.from(pendingTasks.keys())\r\n   console.log(`ğŸ” æ£€æŸ¥ ${taskIds.length} ä¸ªå¾…å¤„ç†ä»»åŠ¡çš„çŠ¶æ€...`)\r\n"
                },
                {
                    "date": 1752469294497,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -737,15 +737,34 @@\n         }\r\n \r\n         // æ™ºèƒ½é‡è¿ç­–ç•¥\r\n         if (!wsReconnectTimer) {\r\n-          // å¦‚æœæœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œç«‹å³é‡è¿ï¼›å¦åˆ™å»¶è¿Ÿé‡è¿\r\n-          const reconnectDelay = hasPendingTasks ? 1000 : 5000\r\n+          connectionAttempts++\r\n \r\n+          // æŒ‡æ•°é€€é¿ç­–ç•¥ï¼šåŸºç¡€å»¶è¿Ÿ * 2^å°è¯•æ¬¡æ•°ï¼Œæœ€å¤§30ç§’\r\n+          const baseDelay = hasPendingTasks ? 1000 : 5000\r\n+          const exponentialDelay = Math.min(baseDelay * Math.pow(2, connectionAttempts - 1), 30000)\r\n+\r\n+          console.log(`ğŸ”„ è®¡åˆ’é‡è¿ (å°è¯• ${connectionAttempts}/${maxConnectionAttempts})ï¼Œå»¶è¿Ÿ ${exponentialDelay/1000}ç§’`)\r\n+\r\n           wsReconnectTimer = setTimeout(async () => {\r\n             wsReconnectTimer = null\r\n-            console.log('ğŸ”„ å°è¯•é‡æ–°è¿æ¥ ComfyUI WebSocket...')\r\n \r\n+            // å¦‚æœè¶…è¿‡æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢è‡ªåŠ¨é‡è¿\r\n+            if (connectionAttempts > maxConnectionAttempts) {\r\n+              console.error(`âŒ å·²è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•° (${maxConnectionAttempts})ï¼Œåœæ­¢è‡ªåŠ¨é‡è¿`)\r\n+              showWebSocketStatusNotification('WebSocketé‡è¿å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢', 'error')\r\n+\r\n+              // å¦‚æœæœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œå¯åŠ¨HTTPè½®è¯¢\r\n+              if (hasPendingTasks) {\r\n+                console.log('ğŸ”„ å¯åŠ¨HTTPè½®è¯¢ä½œä¸ºæœ€åå¤‡ç”¨æ–¹æ¡ˆ')\r\n+                await fallbackToHttpPolling()\r\n+              }\r\n+              return\r\n+            }\r\n+\r\n+            console.log(`ğŸ”„ å°è¯•é‡æ–°è¿æ¥ ComfyUI WebSocket (${connectionAttempts}/${maxConnectionAttempts})...`)\r\n+\r\n             try {\r\n               await initializeWebSocket()\r\n \r\n               // é‡è¿æˆåŠŸåï¼Œæ£€æŸ¥å¾…å¤„ç†ä»»åŠ¡çš„çŠ¶æ€\r\n@@ -753,17 +772,17 @@\n                 console.log('ğŸ” é‡è¿æˆåŠŸï¼Œæ£€æŸ¥å¾…å¤„ç†ä»»åŠ¡çŠ¶æ€...')\r\n                 await checkPendingTasksStatus()\r\n               }\r\n             } catch (error) {\r\n-              console.error('âŒ WebSocket é‡è¿å¤±è´¥:', error)\r\n+              console.error(`âŒ WebSocket é‡è¿å¤±è´¥ (${connectionAttempts}/${maxConnectionAttempts}):`, error)\r\n \r\n               // å¦‚æœæœ‰å¾…å¤„ç†ä»»åŠ¡ä½†é‡è¿å¤±è´¥ï¼Œå°è¯•é€šè¿‡HTTPè½®è¯¢æ£€æŸ¥çŠ¶æ€\r\n               if (hasPendingTasks) {\r\n                 console.log('ğŸ”„ WebSocketé‡è¿å¤±è´¥ï¼Œå°è¯•HTTPè½®è¯¢æ£€æŸ¥ä»»åŠ¡çŠ¶æ€...')\r\n                 await fallbackToHttpPolling()\r\n               }\r\n             }\r\n-          }, reconnectDelay)\r\n+          }, exponentialDelay)\r\n         }\r\n       }\r\n \r\n       wsConnection.onerror = (error) => {\r\n"
                },
                {
                    "date": 1752469627509,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -725,16 +725,43 @@\n \r\n         // åœæ­¢å¥åº·æ£€æŸ¥\r\n         stopWebSocketHealthCheck()\r\n \r\n-        // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n-        showWebSocketStatusNotification('WebSocketè¿æ¥å·²æ–­å¼€', 'warning')\r\n-\r\n         // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„ä»»åŠ¡\r\n         const hasPendingTasks = pendingTasks.size > 0\r\n-        if (hasPendingTasks) {\r\n-          console.warn(`âš ï¸ WebSocketæ–­å¼€æ—¶æœ‰ ${pendingTasks.size} ä¸ªå¾…å¤„ç†ä»»åŠ¡`)\r\n-          showWebSocketStatusNotification(`è¿æ¥æ–­å¼€ï¼Œæœ‰ ${pendingTasks.size} ä¸ªä»»åŠ¡å¾…å¤„ç†`, 'warning')\r\n+\r\n+        // åˆ†æå…³é—­åŸå› \r\n+        const isAbnormalClose = event.code === 1006 || event.code === 1011 || event.code === 1012\r\n+        const isNormalClose = event.code === 1000 || event.code === 1001\r\n+\r\n+        if (isAbnormalClose && hasPendingTasks) {\r\n+          // å¼‚å¸¸å…³é—­ä¸”æœ‰å¾…å¤„ç†ä»»åŠ¡ - ç«‹å³æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n+          console.warn(`âš ï¸ WebSocketå¼‚å¸¸å…³é—­ (ä»£ç ${event.code})ï¼Œæœ‰ ${pendingTasks.size} ä¸ªå¾…å¤„ç†ä»»åŠ¡`)\r\n+          console.log('ğŸ” ç«‹å³æ£€æŸ¥å¾…å¤„ç†ä»»åŠ¡çŠ¶æ€...')\r\n+\r\n+          // ç«‹å³æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼Œå¯èƒ½ä»»åŠ¡å·²ç»å®Œæˆ\r\n+          setTimeout(async () => {\r\n+            await checkPendingTasksStatus()\r\n+          }, 100)\r\n+\r\n+          showWebSocketStatusNotification(`è¿æ¥å¼‚å¸¸æ–­å¼€ï¼Œæ­£åœ¨æ£€æŸ¥ä»»åŠ¡çŠ¶æ€...`, 'warning')\r\n+        } else if (isNormalClose) {\r\n+          // æ­£å¸¸å…³é—­ - å¯èƒ½æ˜¯æœåŠ¡å™¨å®Œæˆå¤„ç†åä¸»åŠ¨å…³é—­\r\n+          console.log('âœ… WebSocketæ­£å¸¸å…³é—­')\r\n+          if (hasPendingTasks) {\r\n+            console.log('ğŸ” æ­£å¸¸å…³é—­ä½†æœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œæ£€æŸ¥çŠ¶æ€...')\r\n+            setTimeout(async () => {\r\n+              await checkPendingTasksStatus()\r\n+            }, 100)\r\n+          }\r\n+          showWebSocketStatusNotification('WebSocketè¿æ¥å·²å…³é—­', 'info')\r\n+        } else {\r\n+          // å…¶ä»–æƒ…å†µ\r\n+          showWebSocketStatusNotification('WebSocketè¿æ¥å·²æ–­å¼€', 'warning')\r\n+          if (hasPendingTasks) {\r\n+            console.warn(`âš ï¸ WebSocketæ–­å¼€æ—¶æœ‰ ${pendingTasks.size} ä¸ªå¾…å¤„ç†ä»»åŠ¡`)\r\n+            showWebSocketStatusNotification(`è¿æ¥æ–­å¼€ï¼Œæœ‰ ${pendingTasks.size} ä¸ªä»»åŠ¡å¾…å¤„ç†`, 'warning')\r\n+          }\r\n         }\r\n \r\n         // æ™ºèƒ½é‡è¿ç­–ç•¥\r\n         if (!wsReconnectTimer) {\r\n"
                },
                {
                    "date": 1752469681660,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -764,12 +764,35 @@\n         }\r\n \r\n         // æ™ºèƒ½é‡è¿ç­–ç•¥\r\n         if (!wsReconnectTimer) {\r\n+          // å¯¹äºæ­£å¸¸å…³é—­ä¸”æ— å¾…å¤„ç†ä»»åŠ¡ï¼Œä¸éœ€è¦é‡è¿\r\n+          if (isNormalClose && !hasPendingTasks) {\r\n+            console.log('âœ… æ­£å¸¸å…³é—­ä¸”æ— å¾…å¤„ç†ä»»åŠ¡ï¼Œä¸éœ€è¦é‡è¿')\r\n+            return\r\n+          }\r\n+\r\n+          // å¯¹äºå¼‚å¸¸å…³é—­ï¼Œä¼˜å…ˆæ£€æŸ¥ä»»åŠ¡çŠ¶æ€è€Œä¸æ˜¯ç«‹å³é‡è¿\r\n+          if (isAbnormalClose && hasPendingTasks) {\r\n+            console.log('ğŸ” å¼‚å¸¸å…³é—­ï¼Œå»¶è¿Ÿé‡è¿ä»¥ä¾¿å…ˆæ£€æŸ¥ä»»åŠ¡çŠ¶æ€')\r\n+            // ç»™ä»»åŠ¡çŠ¶æ€æ£€æŸ¥ä¸€äº›æ—¶é—´\r\n+            setTimeout(() => {\r\n+              if (pendingTasks.size > 0) {\r\n+                // å¦‚æœè¿˜æœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œå†è€ƒè™‘é‡è¿\r\n+                startReconnectProcess()\r\n+              }\r\n+            }, 2000)\r\n+            return\r\n+          }\r\n+\r\n+          startReconnectProcess()\r\n+        }\r\n+\r\n+        function startReconnectProcess() {\r\n           connectionAttempts++\r\n \r\n           // æŒ‡æ•°é€€é¿ç­–ç•¥ï¼šåŸºç¡€å»¶è¿Ÿ * 2^å°è¯•æ¬¡æ•°ï¼Œæœ€å¤§30ç§’\r\n-          const baseDelay = hasPendingTasks ? 1000 : 5000\r\n+          const baseDelay = pendingTasks.size > 0 ? 1000 : 5000\r\n           const exponentialDelay = Math.min(baseDelay * Math.pow(2, connectionAttempts - 1), 30000)\r\n \r\n           console.log(`ğŸ”„ è®¡åˆ’é‡è¿ (å°è¯• ${connectionAttempts}/${maxConnectionAttempts})ï¼Œå»¶è¿Ÿ ${exponentialDelay/1000}ç§’`)\r\n \r\n@@ -781,9 +804,9 @@\n               console.error(`âŒ å·²è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•° (${maxConnectionAttempts})ï¼Œåœæ­¢è‡ªåŠ¨é‡è¿`)\r\n               showWebSocketStatusNotification('WebSocketé‡è¿å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢', 'error')\r\n \r\n               // å¦‚æœæœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œå¯åŠ¨HTTPè½®è¯¢\r\n-              if (hasPendingTasks) {\r\n+              if (pendingTasks.size > 0) {\r\n                 console.log('ğŸ”„ å¯åŠ¨HTTPè½®è¯¢ä½œä¸ºæœ€åå¤‡ç”¨æ–¹æ¡ˆ')\r\n                 await fallbackToHttpPolling()\r\n               }\r\n               return\r\n@@ -794,17 +817,17 @@\n             try {\r\n               await initializeWebSocket()\r\n \r\n               // é‡è¿æˆåŠŸåï¼Œæ£€æŸ¥å¾…å¤„ç†ä»»åŠ¡çš„çŠ¶æ€\r\n-              if (hasPendingTasks) {\r\n+              if (pendingTasks.size > 0) {\r\n                 console.log('ğŸ” é‡è¿æˆåŠŸï¼Œæ£€æŸ¥å¾…å¤„ç†ä»»åŠ¡çŠ¶æ€...')\r\n                 await checkPendingTasksStatus()\r\n               }\r\n             } catch (error) {\r\n               console.error(`âŒ WebSocket é‡è¿å¤±è´¥ (${connectionAttempts}/${maxConnectionAttempts}):`, error)\r\n \r\n               // å¦‚æœæœ‰å¾…å¤„ç†ä»»åŠ¡ä½†é‡è¿å¤±è´¥ï¼Œå°è¯•é€šè¿‡HTTPè½®è¯¢æ£€æŸ¥çŠ¶æ€\r\n-              if (hasPendingTasks) {\r\n+              if (pendingTasks.size > 0) {\r\n                 console.log('ğŸ”„ WebSocketé‡è¿å¤±è´¥ï¼Œå°è¯•HTTPè½®è¯¢æ£€æŸ¥ä»»åŠ¡çŠ¶æ€...')\r\n                 await fallbackToHttpPolling()\r\n               }\r\n             }\r\n"
                },
                {
                    "date": 1752469704412,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -725,74 +725,24 @@\n \r\n         // åœæ­¢å¥åº·æ£€æŸ¥\r\n         stopWebSocketHealthCheck()\r\n \r\n+        // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n+        showWebSocketStatusNotification('WebSocketè¿æ¥å·²æ–­å¼€', 'warning')\r\n+\r\n         // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„ä»»åŠ¡\r\n         const hasPendingTasks = pendingTasks.size > 0\r\n-\r\n-        // åˆ†æå…³é—­åŸå› \r\n-        const isAbnormalClose = event.code === 1006 || event.code === 1011 || event.code === 1012\r\n-        const isNormalClose = event.code === 1000 || event.code === 1001\r\n-\r\n-        if (isAbnormalClose && hasPendingTasks) {\r\n-          // å¼‚å¸¸å…³é—­ä¸”æœ‰å¾…å¤„ç†ä»»åŠ¡ - ç«‹å³æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n-          console.warn(`âš ï¸ WebSocketå¼‚å¸¸å…³é—­ (ä»£ç ${event.code})ï¼Œæœ‰ ${pendingTasks.size} ä¸ªå¾…å¤„ç†ä»»åŠ¡`)\r\n-          console.log('ğŸ” ç«‹å³æ£€æŸ¥å¾…å¤„ç†ä»»åŠ¡çŠ¶æ€...')\r\n-\r\n-          // ç«‹å³æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼Œå¯èƒ½ä»»åŠ¡å·²ç»å®Œæˆ\r\n-          setTimeout(async () => {\r\n-            await checkPendingTasksStatus()\r\n-          }, 100)\r\n-\r\n-          showWebSocketStatusNotification(`è¿æ¥å¼‚å¸¸æ–­å¼€ï¼Œæ­£åœ¨æ£€æŸ¥ä»»åŠ¡çŠ¶æ€...`, 'warning')\r\n-        } else if (isNormalClose) {\r\n-          // æ­£å¸¸å…³é—­ - å¯èƒ½æ˜¯æœåŠ¡å™¨å®Œæˆå¤„ç†åä¸»åŠ¨å…³é—­\r\n-          console.log('âœ… WebSocketæ­£å¸¸å…³é—­')\r\n-          if (hasPendingTasks) {\r\n-            console.log('ğŸ” æ­£å¸¸å…³é—­ä½†æœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œæ£€æŸ¥çŠ¶æ€...')\r\n-            setTimeout(async () => {\r\n-              await checkPendingTasksStatus()\r\n-            }, 100)\r\n-          }\r\n-          showWebSocketStatusNotification('WebSocketè¿æ¥å·²å…³é—­', 'info')\r\n-        } else {\r\n-          // å…¶ä»–æƒ…å†µ\r\n-          showWebSocketStatusNotification('WebSocketè¿æ¥å·²æ–­å¼€', 'warning')\r\n-          if (hasPendingTasks) {\r\n-            console.warn(`âš ï¸ WebSocketæ–­å¼€æ—¶æœ‰ ${pendingTasks.size} ä¸ªå¾…å¤„ç†ä»»åŠ¡`)\r\n-            showWebSocketStatusNotification(`è¿æ¥æ–­å¼€ï¼Œæœ‰ ${pendingTasks.size} ä¸ªä»»åŠ¡å¾…å¤„ç†`, 'warning')\r\n-          }\r\n+        if (hasPendingTasks) {\r\n+          console.warn(`âš ï¸ WebSocketæ–­å¼€æ—¶æœ‰ ${pendingTasks.size} ä¸ªå¾…å¤„ç†ä»»åŠ¡`)\r\n+          showWebSocketStatusNotification(`è¿æ¥æ–­å¼€ï¼Œæœ‰ ${pendingTasks.size} ä¸ªä»»åŠ¡å¾…å¤„ç†`, 'warning')\r\n         }\r\n \r\n         // æ™ºèƒ½é‡è¿ç­–ç•¥\r\n         if (!wsReconnectTimer) {\r\n-          // å¯¹äºæ­£å¸¸å…³é—­ä¸”æ— å¾…å¤„ç†ä»»åŠ¡ï¼Œä¸éœ€è¦é‡è¿\r\n-          if (isNormalClose && !hasPendingTasks) {\r\n-            console.log('âœ… æ­£å¸¸å…³é—­ä¸”æ— å¾…å¤„ç†ä»»åŠ¡ï¼Œä¸éœ€è¦é‡è¿')\r\n-            return\r\n-          }\r\n-\r\n-          // å¯¹äºå¼‚å¸¸å…³é—­ï¼Œä¼˜å…ˆæ£€æŸ¥ä»»åŠ¡çŠ¶æ€è€Œä¸æ˜¯ç«‹å³é‡è¿\r\n-          if (isAbnormalClose && hasPendingTasks) {\r\n-            console.log('ğŸ” å¼‚å¸¸å…³é—­ï¼Œå»¶è¿Ÿé‡è¿ä»¥ä¾¿å…ˆæ£€æŸ¥ä»»åŠ¡çŠ¶æ€')\r\n-            // ç»™ä»»åŠ¡çŠ¶æ€æ£€æŸ¥ä¸€äº›æ—¶é—´\r\n-            setTimeout(() => {\r\n-              if (pendingTasks.size > 0) {\r\n-                // å¦‚æœè¿˜æœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œå†è€ƒè™‘é‡è¿\r\n-                startReconnectProcess()\r\n-              }\r\n-            }, 2000)\r\n-            return\r\n-          }\r\n-\r\n-          startReconnectProcess()\r\n-        }\r\n-\r\n-        function startReconnectProcess() {\r\n           connectionAttempts++\r\n \r\n           // æŒ‡æ•°é€€é¿ç­–ç•¥ï¼šåŸºç¡€å»¶è¿Ÿ * 2^å°è¯•æ¬¡æ•°ï¼Œæœ€å¤§30ç§’\r\n-          const baseDelay = pendingTasks.size > 0 ? 1000 : 5000\r\n+          const baseDelay = hasPendingTasks ? 1000 : 5000\r\n           const exponentialDelay = Math.min(baseDelay * Math.pow(2, connectionAttempts - 1), 30000)\r\n \r\n           console.log(`ğŸ”„ è®¡åˆ’é‡è¿ (å°è¯• ${connectionAttempts}/${maxConnectionAttempts})ï¼Œå»¶è¿Ÿ ${exponentialDelay/1000}ç§’`)\r\n \r\n@@ -804,9 +754,9 @@\n               console.error(`âŒ å·²è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•° (${maxConnectionAttempts})ï¼Œåœæ­¢è‡ªåŠ¨é‡è¿`)\r\n               showWebSocketStatusNotification('WebSocketé‡è¿å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢', 'error')\r\n \r\n               // å¦‚æœæœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œå¯åŠ¨HTTPè½®è¯¢\r\n-              if (pendingTasks.size > 0) {\r\n+              if (hasPendingTasks) {\r\n                 console.log('ğŸ”„ å¯åŠ¨HTTPè½®è¯¢ä½œä¸ºæœ€åå¤‡ç”¨æ–¹æ¡ˆ')\r\n                 await fallbackToHttpPolling()\r\n               }\r\n               return\r\n@@ -817,17 +767,17 @@\n             try {\r\n               await initializeWebSocket()\r\n \r\n               // é‡è¿æˆåŠŸåï¼Œæ£€æŸ¥å¾…å¤„ç†ä»»åŠ¡çš„çŠ¶æ€\r\n-              if (pendingTasks.size > 0) {\r\n+              if (hasPendingTasks) {\r\n                 console.log('ğŸ” é‡è¿æˆåŠŸï¼Œæ£€æŸ¥å¾…å¤„ç†ä»»åŠ¡çŠ¶æ€...')\r\n                 await checkPendingTasksStatus()\r\n               }\r\n             } catch (error) {\r\n               console.error(`âŒ WebSocket é‡è¿å¤±è´¥ (${connectionAttempts}/${maxConnectionAttempts}):`, error)\r\n \r\n               // å¦‚æœæœ‰å¾…å¤„ç†ä»»åŠ¡ä½†é‡è¿å¤±è´¥ï¼Œå°è¯•é€šè¿‡HTTPè½®è¯¢æ£€æŸ¥çŠ¶æ€\r\n-              if (pendingTasks.size > 0) {\r\n+              if (hasPendingTasks) {\r\n                 console.log('ğŸ”„ WebSocketé‡è¿å¤±è´¥ï¼Œå°è¯•HTTPè½®è¯¢æ£€æŸ¥ä»»åŠ¡çŠ¶æ€...')\r\n                 await fallbackToHttpPolling()\r\n               }\r\n             }\r\n"
                },
                {
                    "date": 1752469788529,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -621,8 +621,9 @@\n let wsHealthCheckTimer = null\r\n let lastMessageTime = Date.now()\r\n let connectionAttempts = 0\r\n let maxConnectionAttempts = 5\r\n+let currentWebSocketServer = null // è®°å½•å½“å‰WebSocketè¿æ¥çš„æœåŠ¡å™¨\r\n \r\n // å‰ç«¯é€šçŸ¥å‡½æ•°\r\n function showWebSocketStatusNotification(message, type = 'info') {\r\n   try {\r\n"
                },
                {
                    "date": 1752469812891,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -659,18 +659,41 @@\n \r\n \r\n \r\n // åˆå§‹åŒ– WebSocket è¿æ¥\r\n-async function initializeWebSocket() {\r\n+async function initializeWebSocket(forceNewConnection = false) {\r\n   try {\r\n-    if (wsConnection && wsConnection.readyState === WebSocket.OPEN) {\r\n-      console.log('ğŸ¯ WebSocket å·²è¿æ¥ï¼Œæ— éœ€é‡æ–°åˆå§‹åŒ–')\r\n-      return true\r\n+    // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°è¿æ¥\r\n+    if (!forceNewConnection && wsConnection && wsConnection.readyState === WebSocket.OPEN) {\r\n+      // æ£€æŸ¥å½“å‰è¿æ¥çš„æœåŠ¡å™¨æ˜¯å¦ä»ç„¶æ˜¯æœ€ä¼˜é€‰æ‹©\r\n+      const currentOptimalServer = await getApiBaseUrl()\r\n+      if (currentWebSocketServer === currentOptimalServer) {\r\n+        console.log('ğŸ¯ WebSocket å·²è¿æ¥åˆ°æœ€ä¼˜æœåŠ¡å™¨ï¼Œæ— éœ€é‡æ–°åˆå§‹åŒ–')\r\n+        return true\r\n+      } else {\r\n+        console.log(`ğŸ”„ æœ€ä¼˜æœåŠ¡å™¨å·²å˜æ›´ (${currentWebSocketServer} â†’ ${currentOptimalServer})ï¼Œé‡æ–°è¿æ¥WebSocket`)\r\n+        // å…³é—­å½“å‰è¿æ¥\r\n+        if (wsConnection) {\r\n+          wsConnection.close()\r\n+        }\r\n+      }\r\n     }\r\n \r\n     const config = getComfyUIConfig()\r\n+\r\n+    // ä¸ºWebSocketè¿æ¥é”å®šæœåŠ¡å™¨ï¼Œé¿å…åœ¨è¿æ¥è¿‡ç¨‹ä¸­åˆ‡æ¢\r\n+    console.log('ğŸ”’ ä¸ºWebSocketè¿æ¥é”å®šæœåŠ¡å™¨é€‰æ‹©...')\r\n     const baseUrl = await getApiBaseUrl()\r\n+    currentWebSocketServer = baseUrl\r\n \r\n+    // é€šçŸ¥è´Ÿè½½å‡è¡¡å™¨é”å®šå½“å‰æœåŠ¡å™¨ç”¨äºWebSocket\r\n+    try {\r\n+      await loadBalancer.lockServer(baseUrl)\r\n+      console.log(`ğŸ”’ å·²é”å®šæœåŠ¡å™¨ç”¨äºWebSocket: ${baseUrl}`)\r\n+    } catch (error) {\r\n+      console.warn('âš ï¸ æ— æ³•é”å®šæœåŠ¡å™¨ï¼Œç»§ç»­ä½¿ç”¨å½“å‰é€‰æ‹©:', error)\r\n+    }\r\n+\r\n     // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„WebSocket URLæ ¼å¼\r\n     let wsUrl\r\n     if (baseUrl.startsWith('https://')) {\r\n       wsUrl = baseUrl.replace('https://', 'wss://') + '/ws?clientId=' + config.CLIENT_ID\r\n"
                },
                {
                    "date": 1752469835354,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -749,11 +749,48 @@\n \r\n         // åœæ­¢å¥åº·æ£€æŸ¥\r\n         stopWebSocketHealthCheck()\r\n \r\n+        // é‡Šæ”¾æœåŠ¡å™¨é”å®š\r\n+        if (currentWebSocketServer) {\r\n+          try {\r\n+            loadBalancer.unlockServer()\r\n+            console.log(`ğŸ”“ å·²é‡Šæ”¾WebSocketæœåŠ¡å™¨é”å®š: ${currentWebSocketServer}`)\r\n+          } catch (error) {\r\n+            console.warn('âš ï¸ é‡Šæ”¾æœåŠ¡å™¨é”å®šå¤±è´¥:', error)\r\n+          }\r\n+          currentWebSocketServer = null\r\n+        }\r\n+\r\n         // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n         showWebSocketStatusNotification('WebSocketè¿æ¥å·²æ–­å¼€', 'warning')\r\n \r\n+        // åˆ†æå…³é—­åŸå› \r\n+        let closeReason = 'æœªçŸ¥åŸå› '\r\n+        switch (event.code) {\r\n+          case 1000:\r\n+            closeReason = 'æ­£å¸¸å…³é—­'\r\n+            break\r\n+          case 1001:\r\n+            closeReason = 'ç«¯ç‚¹ç¦»å¼€'\r\n+            break\r\n+          case 1002:\r\n+            closeReason = 'åè®®é”™è¯¯'\r\n+            break\r\n+          case 1003:\r\n+            closeReason = 'ä¸æ”¯æŒçš„æ•°æ®ç±»å‹'\r\n+            break\r\n+          case 1006:\r\n+            closeReason = 'è¿æ¥å¼‚å¸¸å…³é—­ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æœåŠ¡å™¨åˆ‡æ¢ï¼‰'\r\n+            break\r\n+          case 1011:\r\n+            closeReason = 'æœåŠ¡å™¨é”™è¯¯'\r\n+            break\r\n+          default:\r\n+            closeReason = `é”™è¯¯ä»£ç  ${event.code}`\r\n+        }\r\n+        console.log(`ğŸ“‹ WebSocketå…³é—­åŸå› : ${closeReason}`)\r\n+\r\n         // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„ä»»åŠ¡\r\n         const hasPendingTasks = pendingTasks.size > 0\r\n         if (hasPendingTasks) {\r\n           console.warn(`âš ï¸ WebSocketæ–­å¼€æ—¶æœ‰ ${pendingTasks.size} ä¸ªå¾…å¤„ç†ä»»åŠ¡`)\r\n"
                },
                {
                    "date": 1752469871115,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -196,8 +196,14 @@\n \r\n // è·å–APIåŸºç¡€URL - ä½¿ç”¨è´Ÿè½½å‡è¡¡\r\n async function getApiBaseUrl(forceReassessment = false, excludeUrls = []) {\r\n   try {\r\n+    // å¦‚æœWebSocketå·²è¿æ¥ä¸”æ²¡æœ‰å¼ºåˆ¶é‡æ–°è¯„ä¼°ï¼Œä¼˜å…ˆä½¿ç”¨WebSocketè¿æ¥çš„æœåŠ¡å™¨\r\n+    if (!forceReassessment && currentWebSocketServer && isWsConnected) {\r\n+      console.log('ğŸ”— ä½¿ç”¨WebSocketè¿æ¥çš„æœåŠ¡å™¨ä¿æŒä¸€è‡´æ€§:', currentWebSocketServer)\r\n+      return currentWebSocketServer\r\n+    }\r\n+\r\n     // å¦‚æœéœ€è¦å¼ºåˆ¶é‡æ–°è¯„ä¼°ï¼Œè§¦å‘è´Ÿè½½å‡è¡¡å™¨é‡æ–°è¯„ä¼°\r\n     if (forceReassessment) {\r\n       console.log('ğŸ”„ å¼ºåˆ¶é‡æ–°è¯„ä¼°æœåŠ¡å™¨...')\r\n       await loadBalancer.forceReassessment()\r\n@@ -213,8 +219,19 @@\n     }\r\n \r\n     console.log('ğŸ¯ è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœåŠ¡å™¨:', optimalServer)\r\n \r\n+    // å¦‚æœé€‰æ‹©çš„æœåŠ¡å™¨ä¸å½“å‰WebSocketæœåŠ¡å™¨ä¸åŒï¼Œä¸”WebSocketå·²è¿æ¥ï¼Œéœ€è¦é‡è¿WebSocket\r\n+    if (currentWebSocketServer && currentWebSocketServer !== optimalServer && isWsConnected) {\r\n+      console.log(`âš ï¸ æ£€æµ‹åˆ°æœåŠ¡å™¨åˆ‡æ¢ (${currentWebSocketServer} â†’ ${optimalServer})ï¼Œéœ€è¦é‡è¿WebSocket`)\r\n+      // å¼‚æ­¥é‡è¿WebSocketï¼Œä¸é˜»å¡å½“å‰è¯·æ±‚\r\n+      setTimeout(() => {\r\n+        initializeWebSocket(true).catch(error => {\r\n+          console.error('âŒ å¼‚æ­¥WebSocketé‡è¿å¤±è´¥:', error)\r\n+        })\r\n+      }, 100)\r\n+    }\r\n+\r\n     // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n     let baseUrl = optimalServer\r\n     if (baseUrl && baseUrl.endsWith('/')) {\r\n       baseUrl = baseUrl.slice(0, -1)\r\n"
                },
                {
                    "date": 1752469972268,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -703,10 +703,10 @@\n     currentWebSocketServer = baseUrl\r\n \r\n     // é€šçŸ¥è´Ÿè½½å‡è¡¡å™¨é”å®šå½“å‰æœåŠ¡å™¨ç”¨äºWebSocket\r\n     try {\r\n-      await loadBalancer.lockServer(baseUrl)\r\n-      console.log(`ğŸ”’ å·²é”å®šæœåŠ¡å™¨ç”¨äºWebSocket: ${baseUrl}`)\r\n+      await loadBalancer.lockServerForWebSocket(baseUrl)\r\n+      console.log(`ğŸ”’ğŸŒ å·²é”å®šæœåŠ¡å™¨ç”¨äºWebSocket: ${baseUrl}`)\r\n     } catch (error) {\r\n       console.warn('âš ï¸ æ— æ³•é”å®šæœåŠ¡å™¨ï¼Œç»§ç»­ä½¿ç”¨å½“å‰é€‰æ‹©:', error)\r\n     }\r\n \r\n"
                },
                {
                    "date": 1752469991057,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -769,10 +769,10 @@\n \r\n         // é‡Šæ”¾æœåŠ¡å™¨é”å®š\r\n         if (currentWebSocketServer) {\r\n           try {\r\n-            loadBalancer.unlockServer()\r\n-            console.log(`ğŸ”“ å·²é‡Šæ”¾WebSocketæœåŠ¡å™¨é”å®š: ${currentWebSocketServer}`)\r\n+            loadBalancer.unlockWebSocketServer()\r\n+            console.log(`ğŸ”“ğŸŒ å·²é‡Šæ”¾WebSocketæœåŠ¡å™¨é”å®š: ${currentWebSocketServer}`)\r\n           } catch (error) {\r\n             console.warn('âš ï¸ é‡Šæ”¾æœåŠ¡å™¨é”å®šå¤±è´¥:', error)\r\n           }\r\n           currentWebSocketServer = null\r\n"
                },
                {
                    "date": 1752470514218,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -829,14 +829,21 @@\n \r\n             // å¦‚æœè¶…è¿‡æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢è‡ªåŠ¨é‡è¿\r\n             if (connectionAttempts > maxConnectionAttempts) {\r\n               console.error(`âŒ å·²è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•° (${maxConnectionAttempts})ï¼Œåœæ­¢è‡ªåŠ¨é‡è¿`)\r\n-              showWebSocketStatusNotification('WebSocketé‡è¿å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢', 'error')\r\n+              showWebSocketStatusNotification('WebSocketé‡è¿å¤±è´¥ï¼Œä»»åŠ¡å¯èƒ½æ— æ³•å®Œæˆ', 'error')\r\n \r\n-              // å¦‚æœæœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œå¯åŠ¨HTTPè½®è¯¢\r\n+              // æ ‡è®°æ‰€æœ‰å¾…å¤„ç†ä»»åŠ¡ä¸ºå¤±è´¥\r\n               if (hasPendingTasks) {\r\n-                console.log('ğŸ”„ å¯åŠ¨HTTPè½®è¯¢ä½œä¸ºæœ€åå¤‡ç”¨æ–¹æ¡ˆ')\r\n-                await fallbackToHttpPolling()\r\n+                console.log('âŒ æ ‡è®°æ‰€æœ‰å¾…å¤„ç†ä»»åŠ¡ä¸ºå¤±è´¥')\r\n+                const taskIds = Array.from(pendingTasks.keys())\r\n+                for (const promptId of taskIds) {\r\n+                  const task = pendingTasks.get(promptId)\r\n+                  if (task && task.onError) {\r\n+                    task.onError('WebSocketè¿æ¥å¤±è´¥ï¼Œæ— æ³•ç›‘å¬ä»»åŠ¡å®Œæˆ')\r\n+                  }\r\n+                  pendingTasks.delete(promptId)\r\n+                }\r\n               }\r\n               return\r\n             }\r\n \r\n@@ -851,14 +858,8 @@\n                 await checkPendingTasksStatus()\r\n               }\r\n             } catch (error) {\r\n               console.error(`âŒ WebSocket é‡è¿å¤±è´¥ (${connectionAttempts}/${maxConnectionAttempts}):`, error)\r\n-\r\n-              // å¦‚æœæœ‰å¾…å¤„ç†ä»»åŠ¡ä½†é‡è¿å¤±è´¥ï¼Œå°è¯•é€šè¿‡HTTPè½®è¯¢æ£€æŸ¥çŠ¶æ€\r\n-              if (hasPendingTasks) {\r\n-                console.log('ğŸ”„ WebSocketé‡è¿å¤±è´¥ï¼Œå°è¯•HTTPè½®è¯¢æ£€æŸ¥ä»»åŠ¡çŠ¶æ€...')\r\n-                await fallbackToHttpPolling()\r\n-              }\r\n             }\r\n           }, exponentialDelay)\r\n         }\r\n       }\r\n"
                },
                {
                    "date": 1752470538308,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1002,19 +1002,25 @@\n         if (pendingTasks.size > 0) {\r\n           console.log('ğŸ”„ æ£€æµ‹åˆ°å¾…å¤„ç†ä»»åŠ¡ï¼Œç«‹å³é‡è¿WebSocket')\r\n           initializeWebSocket().catch(error => {\r\n             console.error('âŒ å¥åº·æ£€æŸ¥é‡è¿å¤±è´¥:', error)\r\n-            // å¯åŠ¨HTTPè½®è¯¢å¤‡ç”¨æœºåˆ¶\r\n-            fallbackToHttpPolling()\r\n           })\r\n         }\r\n       }\r\n     }\r\n \r\n-    // å¦‚æœè¶…è¿‡60ç§’æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ä¸”æœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œå¯åŠ¨HTTPè½®è¯¢\r\n-    if (timeSinceLastMessage > 60000 && pendingTasks.size > 0) {\r\n-      console.warn('âš ï¸ WebSocketé•¿æ—¶é—´æ— å“åº”ï¼Œå¯åŠ¨HTTPè½®è¯¢å¤‡ç”¨æœºåˆ¶')\r\n-      fallbackToHttpPolling()\r\n+    // å¦‚æœè¶…è¿‡120ç§’æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ä¸”æœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œæ ‡è®°ä»»åŠ¡å¤±è´¥\r\n+    if (timeSinceLastMessage > 120000 && pendingTasks.size > 0) {\r\n+      console.error('âŒ WebSocketé•¿æ—¶é—´æ— å“åº”ï¼Œæ ‡è®°å¾…å¤„ç†ä»»åŠ¡ä¸ºå¤±è´¥')\r\n+      const taskIds = Array.from(pendingTasks.keys())\r\n+      for (const promptId of taskIds) {\r\n+        const task = pendingTasks.get(promptId)\r\n+        if (task && task.onError) {\r\n+          task.onError('WebSocketè¿æ¥é•¿æ—¶é—´æ— å“åº”')\r\n+        }\r\n+        pendingTasks.delete(promptId)\r\n+      }\r\n+      showWebSocketStatusNotification('WebSocketè¿æ¥å¼‚å¸¸ï¼Œä»»åŠ¡å·²å–æ¶ˆ', 'error')\r\n     }\r\n   }, 10000) // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡\r\n }\r\n \r\n"
                },
                {
                    "date": 1752470559245,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1064,66 +1064,11 @@\n     }\r\n   }\r\n }\r\n \r\n-// HTTPè½®è¯¢å¤‡ç”¨æœºåˆ¶\r\n-async function fallbackToHttpPolling() {\r\n-  const taskIds = Array.from(pendingTasks.keys())\r\n-  if (taskIds.length === 0) {\r\n-    return\r\n-  }\r\n+// å·²ç§»é™¤HTTPè½®è¯¢å¤‡ç”¨æœºåˆ¶ï¼Œå®Œå…¨ä¾èµ–WebSocketè¿›è¡Œä»»åŠ¡çŠ¶æ€ç›‘æ§\r\n+// å¦‚æœéœ€è¦æ‰‹åŠ¨æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼Œè¯·ä½¿ç”¨ checkTaskStatus(promptId) å‡½æ•°\r\n \r\n-  console.log(`ğŸ”„ å¯åŠ¨HTTPè½®è¯¢å¤‡ç”¨æœºåˆ¶ï¼Œç›‘æ§ ${taskIds.length} ä¸ªä»»åŠ¡...`)\r\n-  showWebSocketStatusNotification('ä½¿ç”¨HTTPè½®è¯¢ç›‘æ§ä»»åŠ¡çŠ¶æ€', 'info')\r\n-\r\n-  const pollInterval = setInterval(async () => {\r\n-    try {\r\n-      // å¦‚æœWebSocketé‡æ–°è¿æ¥æˆåŠŸï¼Œåœæ­¢è½®è¯¢\r\n-      if (isWsConnected) {\r\n-        console.log('âœ… WebSocketå·²é‡è¿ï¼Œåœæ­¢HTTPè½®è¯¢')\r\n-        clearInterval(pollInterval)\r\n-        return\r\n-      }\r\n-\r\n-      // æ£€æŸ¥å‰©ä½™ä»»åŠ¡\r\n-      const remainingTasks = Array.from(pendingTasks.keys())\r\n-      if (remainingTasks.length === 0) {\r\n-        console.log('âœ… æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼Œåœæ­¢HTTPè½®è¯¢')\r\n-        clearInterval(pollInterval)\r\n-        return\r\n-      }\r\n-\r\n-      // æ£€æŸ¥æ¯ä¸ªä»»åŠ¡çš„çŠ¶æ€\r\n-      for (const promptId of remainingTasks) {\r\n-        try {\r\n-          const result = await checkTaskStatus(promptId)\r\n-\r\n-          if (result && result.status && result.status.completed) {\r\n-            console.log(`âœ… HTTPè½®è¯¢å‘ç°ä»»åŠ¡ ${promptId} å·²å®Œæˆ`)\r\n-\r\n-            const task = pendingTasks.get(promptId)\r\n-            if (task && task.onComplete) {\r\n-              task.onComplete(result)\r\n-              pendingTasks.delete(promptId)\r\n-              showWebSocketStatusNotification(`ä»»åŠ¡å®Œæˆ (HTTPè½®è¯¢)`, 'success')\r\n-            }\r\n-          }\r\n-        } catch (error) {\r\n-          console.error(`âŒ HTTPè½®è¯¢æ£€æŸ¥ä»»åŠ¡ ${promptId} å¤±è´¥:`, error)\r\n-        }\r\n-      }\r\n-    } catch (error) {\r\n-      console.error('âŒ HTTPè½®è¯¢è¿‡ç¨‹ä¸­å‡ºé”™:', error)\r\n-    }\r\n-  }, 3000) // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡\r\n-\r\n-  // è®¾ç½®è½®è¯¢è¶…æ—¶ï¼ˆ5åˆ†é’Ÿååœæ­¢ï¼‰\r\n-  setTimeout(() => {\r\n-    clearInterval(pollInterval)\r\n-    console.log('â° HTTPè½®è¯¢è¶…æ—¶ï¼Œåœæ­¢è½®è¯¢')\r\n-  }, 300000)\r\n-}\r\n-\r\n // å¤„ç† WebSocket æ¶ˆæ¯ - æ ¹æ®ComfyUIå®˜æ–¹æ–‡æ¡£è§„èŒƒ\r\n function handleWebSocketMessage(message) {\r\n   try {\r\n     const { type, data } = message\r\n"
                },
                {
                    "date": 1752470584314,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1150,8 +1150,13 @@\n \r\n     if (task) {\r\n       console.log(`âœ… ä»»åŠ¡ ${promptId} æ‰§è¡Œå®Œæˆ`)\r\n \r\n+      // ç«‹å³æ›´æ–°è¿›åº¦åˆ°99%\r\n+      if (task.onProgress) {\r\n+        task.onProgress('å¤„ç†å®Œæˆï¼Œæ­£åœ¨åŠ è½½ç»“æœ...', 99)\r\n+      }\r\n+\r\n       // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n       showWebSocketStatusNotification(`ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ!`, 'success')\r\n \r\n       // è·å–å®Œæ•´çš„å†å²è®°å½•æ¥è·å–è¾“å‡ºç»“æœ\r\n"
                },
                {
                    "date": 1752470602367,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1241,9 +1241,11 @@\n \r\n     // è¿™é‡Œå¯ä»¥å¤„ç†ä¸­é—´ç»“æœæˆ–UIæ›´æ–°ï¼Œä½†ä¸åº”è¯¥è§¦å‘ä»»åŠ¡å®Œæˆ\r\n     const task = pendingTasks.get(promptId)\r\n     if (task && task.onProgress) {\r\n-      task.onProgress(80, `èŠ‚ç‚¹ ${nodeId} å®Œæˆ`)\r\n+      // æ›´æ–°è¿›åº¦ï¼Œä½†ä¸è¶…è¿‡95%ï¼Œä¸ºæœ€ç»ˆå®Œæˆç•™å‡ºç©ºé—´\r\n+      const currentProgress = Math.min(95, 60 + Math.random() * 30)\r\n+      task.onProgress(`èŠ‚ç‚¹ ${nodeId} å®Œæˆ`, currentProgress)\r\n     }\r\n   }\r\n }\r\n \r\n"
                },
                {
                    "date": 1752470619234,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1271,13 +1271,14 @@\n \r\n     const task = pendingTasks.get(promptId)\r\n     if (task && task.onProgress) {\r\n       if (nodeId === null || nodeId === undefined) {\r\n-        // nodeä¸ºnullè¡¨ç¤ºæ‰§è¡Œå®Œæˆ\r\n-        task.onProgress(95, 'æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œå®Œæˆ')\r\n+        // nodeä¸ºnullè¡¨ç¤ºæ‰§è¡Œå®Œæˆï¼Œä½†ä¸æ˜¯æœ€ç»ˆå®Œæˆ\r\n+        task.onProgress('æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œå®Œæˆï¼Œç­‰å¾…ç»“æœ...', 95)\r\n       } else {\r\n-        // å¼€å§‹æ‰§è¡Œæ–°èŠ‚ç‚¹\r\n-        task.onProgress(50, `æ‰§è¡ŒèŠ‚ç‚¹ ${nodeId}`)\r\n+        // å¼€å§‹æ‰§è¡Œæ–°èŠ‚ç‚¹ï¼ŒåŠ¨æ€è®¡ç®—è¿›åº¦\r\n+        const currentProgress = Math.min(90, 30 + Math.random() * 50)\r\n+        task.onProgress(`æ‰§è¡ŒèŠ‚ç‚¹ ${nodeId}`, currentProgress)\r\n       }\r\n     }\r\n   }\r\n }\r\n"
                },
                {
                    "date": 1752470657339,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1282,9 +1282,9 @@\n     }\r\n   }\r\n }\r\n \r\n-// ç­‰å¾…ä»»åŠ¡å®Œæˆ - ä¸“æ³¨ä½¿ç”¨WebSocketæœºåˆ¶\r\n+// ç­‰å¾…ä»»åŠ¡å®Œæˆ - å®Œå…¨ä¾èµ–WebSocketæœºåˆ¶\r\n async function waitForTaskCompletion(promptId, maxWaitTime = 300000, onProgress = null) {\r\n   console.log(`â³ ç­‰å¾…ä»»åŠ¡å®Œæˆ: ${promptId}`)\r\n \r\n   // ç¡®ä¿WebSocketè¿æ¥å·²å»ºç«‹\r\n@@ -1299,58 +1299,35 @@\n   }\r\n \r\n   return new Promise((resolve, reject) => {\r\n     let isResolved = false\r\n-    let wsCheckInterval = null\r\n \r\n     // è®¾ç½®è¶…æ—¶\r\n-    const timeout = setTimeout(async () => {\r\n+    const timeout = setTimeout(() => {\r\n       if (isResolved) return\r\n \r\n-      console.warn(`â° ä»»åŠ¡ ${promptId} ç­‰å¾…è¶…æ—¶ï¼Œå°è¯•æœ€åæ£€æŸ¥...`)\r\n+      console.warn(`â° ä»»åŠ¡ ${promptId} ç­‰å¾…è¶…æ—¶`)\r\n \r\n-      // è¶…æ—¶å‰æœ€åå°è¯•æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n-      try {\r\n-        const result = await checkTaskStatus(promptId)\r\n-        if (result && result.status && result.status.completed) {\r\n-          console.log(`âœ… è¶…æ—¶æ£€æŸ¥å‘ç°ä»»åŠ¡ ${promptId} å·²å®Œæˆ`)\r\n-          isResolved = true\r\n-          clearInterval(wsCheckInterval)\r\n-          pendingTasks.delete(promptId)\r\n-\r\n-          if (onProgress) {\r\n-            onProgress('å¤„ç†å®Œæˆ', 100)\r\n-          }\r\n-\r\n-          resolve(result)\r\n-          return\r\n-        }\r\n-      } catch (error) {\r\n-        console.error('âŒ è¶…æ—¶æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error)\r\n-      }\r\n-\r\n       // ç¡®å®è¶…æ—¶\r\n       pendingTasks.delete(promptId)\r\n-      clearInterval(wsCheckInterval)\r\n       showWebSocketStatusNotification('ä»»åŠ¡å¤„ç†è¶…æ—¶', 'error')\r\n       reject(new Error(`ä»»åŠ¡ ${promptId} æ‰§è¡Œè¶…æ—¶`))\r\n     }, maxWaitTime)\r\n \r\n     // åˆ›å»ºä»»åŠ¡è·Ÿè¸ªå¯¹è±¡\r\n     const task = {\r\n       promptId,\r\n-      onProgress: (progress, status) => {\r\n+      onProgress: (status, progress) => {\r\n         // è°ƒç”¨å¤–éƒ¨è¿›åº¦å›è°ƒ\r\n         if (onProgress) {\r\n-          onProgress(`æ­£åœ¨å¤„ç†: ${status}`, progress)\r\n+          onProgress(status, progress)\r\n         }\r\n       },\r\n       onComplete: (result) => {\r\n         if (isResolved) return\r\n         isResolved = true\r\n \r\n         clearTimeout(timeout)\r\n-        clearInterval(wsCheckInterval)\r\n         console.log(`âœ… ä»»åŠ¡ ${promptId} å®Œæˆ`)\r\n \r\n         if (onProgress) {\r\n           onProgress('å¤„ç†å®Œæˆ', 100)\r\n@@ -1362,9 +1339,8 @@\n         if (isResolved) return\r\n         isResolved = true\r\n \r\n         clearTimeout(timeout)\r\n-        clearInterval(wsCheckInterval)\r\n         console.error(`âŒ ä»»åŠ¡ ${promptId} å¤±è´¥:`, error)\r\n \r\n         if (onProgress) {\r\n           onProgress('å¤„ç†å¤±è´¥', 0)\r\n@@ -1376,40 +1352,19 @@\n         reject(new Error(error))\r\n       }\r\n     }\r\n \r\n-    // WebSocketè¿æ¥ç›‘æ§\r\n-    wsCheckInterval = setInterval(async () => {\r\n-      if (isResolved) {\r\n-        clearInterval(wsCheckInterval)\r\n-        return\r\n-      }\r\n-\r\n-      // æ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€\r\n-      if (!isWsConnected || !wsConnection || wsConnection.readyState !== WebSocket.OPEN) {\r\n-        console.warn(`âš ï¸ æ£€æµ‹åˆ°WebSocketæ–­å¼€ï¼Œä»»åŠ¡ ${promptId} åˆ‡æ¢åˆ°HTTPè½®è¯¢æ¨¡å¼`)\r\n-\r\n-        try {\r\n-          const result = await checkTaskStatus(promptId)\r\n-          if (result && result.status && result.status.completed) {\r\n-            console.log(`âœ… HTTPè½®è¯¢å‘ç°ä»»åŠ¡ ${promptId} å·²å®Œæˆ`)\r\n-            task.onComplete(result)\r\n-          } else if (result && result.status && result.status.status_str === 'error') {\r\n-            console.error(`âŒ HTTPè½®è¯¢å‘ç°ä»»åŠ¡ ${promptId} æ‰§è¡Œå¤±è´¥`)\r\n-            task.onError('ä»»åŠ¡æ‰§è¡Œå¤±è´¥')\r\n-          }\r\n-        } catch (error) {\r\n-          console.error(`âŒ HTTPè½®è¯¢æ£€æŸ¥ä»»åŠ¡ ${promptId} å¤±è´¥:`, error)\r\n-        }\r\n-      }\r\n-    }, 5000) // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡\r\n-\r\n     // æ³¨å†Œä»»åŠ¡åˆ°å¾…å¤„ç†åˆ—è¡¨\r\n     pendingTasks.set(promptId, task)\r\n \r\n     // ç¡®è®¤WebSocketè¿æ¥çŠ¶æ€\r\n     if (isWsConnected && wsConnection && wsConnection.readyState === WebSocket.OPEN) {\r\n       console.log('ğŸ“¡ WebSocketå·²è¿æ¥ï¼Œç­‰å¾…ä»»åŠ¡å®Œæˆ')\r\n+\r\n+      // åˆå§‹è¿›åº¦\r\n+      if (onProgress) {\r\n+        onProgress('ä»»åŠ¡å·²æäº¤ï¼Œç­‰å¾…å¤„ç†...', 10)\r\n+      }\r\n     } else {\r\n       console.error('âŒ WebSocketè¿æ¥çŠ¶æ€å¼‚å¸¸')\r\n       // æ¸…ç†ä»»åŠ¡å¹¶æ‹’ç»\r\n       pendingTasks.delete(promptId)\r\n"
                },
                {
                    "date": 1752470706487,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1373,11 +1373,22 @@\n     }\r\n   })\r\n }\r\n \r\n-// HTTPè½®è¯¢å¤‡ä»½æœºåˆ¶å·²ç§»é™¤ï¼Œä¸“æ³¨ä½¿ç”¨WebSocketå®æ—¶é€šä¿¡\r\n+// HTTPè½®è¯¢å¤‡ä»½æœºåˆ¶å·²ç§»é™¤ï¼Œå®Œå…¨ä¾èµ–WebSocketå®æ—¶é€šä¿¡\r\n // å¦‚æœéœ€è¦æ‰‹åŠ¨æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼Œè¯·ä½¿ç”¨ checkTaskStatus(promptId) å‡½æ•°\r\n \r\n+// å¤„ç†æ‰§è¡Œå¼€å§‹æ¶ˆæ¯\r\n+function handleExecutionStartMessage(data) {\r\n+  if (data && data.prompt_id) {\r\n+    const promptId = data.prompt_id\r\n+    const task = pendingTasks.get(promptId)\r\n+    if (task && task.onProgress) {\r\n+      task.onProgress('å¼€å§‹æ‰§è¡Œ', 15)\r\n+    }\r\n+  }\r\n+}\r\n+\r\n // ä¸»è¦çš„æ¢è¡£APIå‡½æ•° - ä¸¤æ­¥æµç¨‹\r\n async function processUndressImage(base64Image, onProgress = null) {\r\n   try {\r\n     console.log('ğŸš€ å¼€å§‹å¤„ç†æ¢è¡£è¯·æ±‚')\r\n"
                },
                {
                    "date": 1752470737651,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1128,19 +1128,10 @@\n   // é˜Ÿåˆ—çŠ¶æ€æ¶ˆæ¯ï¼Œé€šå¸¸ç”¨äºç›‘æ§é˜Ÿåˆ—çŠ¶æ€\r\n   // è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ é˜Ÿåˆ—çŠ¶æ€å¤„ç†é€»è¾‘\r\n }\r\n \r\n-// å¤„ç†æ‰§è¡Œå¼€å§‹æ¶ˆæ¯\r\n-function handleExecutionStartMessage(data) {\r\n-  if (data && data.prompt_id) {\r\n-    const promptId = data.prompt_id\r\n-    const task = pendingTasks.get(promptId)\r\n-    if (task && task.onProgress) {\r\n-      task.onProgress('å¼€å§‹æ‰§è¡Œ', 5)\r\n-    }\r\n-  }\r\n-}\r\n \r\n+\r\n // å¤„ç†æ‰§è¡ŒæˆåŠŸæ¶ˆæ¯ - è¿™æ˜¯å…³é”®çš„å®Œæˆæ¶ˆæ¯ï¼\r\n function handleExecutionSuccessMessage(data) {\r\n   console.log('ğŸ‰ ComfyUI æ‰§è¡ŒæˆåŠŸ! æ‰€æœ‰èŠ‚ç‚¹å·²å®Œæˆ!')\r\n \r\n"
                },
                {
                    "date": 1752511085238,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -76,16 +76,13 @@\n     })\r\n \r\n     if (response.ok) {\r\n       const result = await response.json()\r\n-      console.log('âœ… ä»£ç†æœåŠ¡å™¨é…ç½®æ›´æ–°æˆåŠŸ:', result)\r\n       return { success: true, message: 'ä»£ç†æœåŠ¡å™¨é…ç½®æ›´æ–°æˆåŠŸ' }\r\n     } else {\r\n-      console.warn('âš ï¸ ä»£ç†æœåŠ¡å™¨é…ç½®æ›´æ–°å¤±è´¥:', response.status)\r\n       return { success: false, message: `ä»£ç†æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status}` }\r\n     }\r\n   } catch (error) {\r\n-    console.warn('âš ï¸ æ— æ³•è¿æ¥åˆ°ä»£ç†æœåŠ¡å™¨ï¼Œå¯èƒ½ä»£ç†æœåŠ¡å™¨æœªå¯åŠ¨:', error.message)\r\n     return { success: false, message: 'æ— æ³•è¿æ¥åˆ°ä»£ç†æœåŠ¡å™¨' }\r\n   }\r\n }\r\n \r\n"
                },
                {
                    "date": 1752511104239,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -163,10 +163,8 @@\n async function updateComfyUIConfig(newConfig) {\r\n   const currentConfig = getComfyUIConfig(true) // å¼ºåˆ¶åˆ·æ–°å½“å‰é…ç½®\r\n   const updatedConfig = { ...currentConfig, ...newConfig }\r\n \r\n-  console.log('ğŸ”„ æ›´æ–°é…ç½®:', updatedConfig)\r\n-\r\n   // ä¿å­˜åˆ°localStorageï¼ˆè¿™ä¼šæ¸…é™¤ç¼“å­˜ï¼‰\r\n   saveComfyUIConfig(updatedConfig)\r\n \r\n   // å¼ºåˆ¶åˆ·æ–°é…ç½®ç¼“å­˜\r\n@@ -177,10 +175,8 @@\n \r\n   // åŒæ—¶æ›´æ–°ä»£ç†æœåŠ¡å™¨é…ç½®\r\n   const proxyUpdateResult = await updateProxyServerConfig(updatedConfig)\r\n \r\n-  console.log('âœ… é…ç½®æ›´æ–°å®Œæˆï¼Œæ–°é…ç½®å·²ç”Ÿæ•ˆ')\r\n-\r\n   return {\r\n     config: updatedConfig,\r\n     proxyUpdate: proxyUpdateResult\r\n   }\r\n"
                },
                {
                    "date": 1752511118743,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -231,10 +231,8 @@\n     }\r\n \r\n     return baseUrl\r\n   } catch (error) {\r\n-    console.warn('âš ï¸ è´Ÿè½½å‡è¡¡å™¨å¤±è´¥ï¼Œä½¿ç”¨é…ç½®çš„æœåŠ¡å™¨:', error)\r\n-\r\n     // é™çº§åˆ°é…ç½®çš„æœåŠ¡å™¨\r\n     const config = getComfyUIConfig(true)\r\n     let baseUrl = config.COMFYUI_SERVER_URL\r\n \r\n"
                },
                {
                    "date": 1752511143034,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -253,9 +253,8 @@\n       const result = await apiCall()\r\n       return result\r\n     } catch (error) {\r\n       lastError = error\r\n-      console.warn(`âš ï¸ APIè°ƒç”¨å¤±è´¥ (å°è¯• ${attempt + 1}/${maxRetries + 1}):`, error.message)\r\n \r\n       // å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œä¸”æ˜¯ç½‘ç»œç›¸å…³é”™è¯¯ï¼Œå°è¯•ä¸‹ä¸€ä¸ªæœåŠ¡å™¨\r\n       if (attempt < maxRetries &&\r\n           (error.message.includes('fetch') ||\r\n"
                },
                {
                    "date": 1752511157452,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -267,9 +267,8 @@\n         // è·å–å½“å‰å¤±è´¥çš„æœåŠ¡å™¨URL\r\n         const currentServer = await getApiBaseUrl()\r\n         if (currentServer) {\r\n           excludeUrls.push(currentServer)\r\n-          console.log(`ğŸ”„ æ·»åŠ å¤±è´¥æœåŠ¡å™¨åˆ°æ’é™¤åˆ—è¡¨: ${currentServer}`)\r\n \r\n           // è®°å½•å¤±è´¥\r\n           let errorType = 'api_error'\r\n           if (error.message.includes('timeout')) errorType = 'timeout'\r\n"
                },
                {
                    "date": 1752511183414,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -371,9 +371,8 @@\n \r\n     // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œè®°å½•å¤±è´¥å¹¶å¯èƒ½è§¦å‘é‡æ–°è¯„ä¼°\r\n     if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('timeout')) {\r\n       const currentServer = await getApiBaseUrl()\r\n-      console.log('ğŸ“ è®°å½•æœåŠ¡å™¨ä¸Šä¼ å¤±è´¥:', currentServer)\r\n \r\n       // ç¡®å®šé”™è¯¯ç±»å‹\r\n       let errorType = 'upload_error'\r\n       if (error.message.includes('timeout')) errorType = 'timeout'\r\n"
                },
                {
                    "date": 1752511198103,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -425,12 +425,8 @@\n \r\n     const config = getComfyUIConfig()\r\n     const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n     selectedServer = apiBaseUrl // è®°å½•é€‰æ‹©çš„æœåŠ¡å™¨\r\n-    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n-    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n-    console.log('ğŸ”§ ä½¿ç”¨è´Ÿè½½å‡è¡¡:', 'æ˜¯')\r\n-    console.log('ğŸ”Œ WebSocketçŠ¶æ€:', isWsConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥')\r\n \r\n     // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n     const requestBody = {\r\n       client_id: config.CLIENT_ID,\r\n"
                },
                {
                    "date": 1752511212365,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -432,18 +432,10 @@\n       client_id: config.CLIENT_ID,\r\n       prompt: workflowPrompt\r\n     }\r\n \r\n-    console.log('ğŸ“‹ è¯·æ±‚ä½“ç»“æ„:', {\r\n-      client_id: requestBody.client_id,\r\n-      prompt_keys: Object.keys(requestBody.prompt),\r\n-      node_49_exists: !!requestBody.prompt['49'],\r\n-      node_49_image: requestBody.prompt['49']?.inputs?.image\r\n-    })\r\n-\r\n     // ç¬¬äºŒæ­¥APIè°ƒç”¨ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n     const promptUrl = `${apiBaseUrl}/prompt`\r\n-    console.log('ğŸŒ è°ƒç”¨å·¥ä½œæµAPI:', promptUrl)\r\n \r\n     const response = await fetch(promptUrl, {\r\n       method: 'POST',\r\n       headers: {\r\n"
                },
                {
                    "date": 1752511238647,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -445,18 +445,14 @@\n       mode: 'cors',\r\n       credentials: 'omit'\r\n     })\r\n \r\n-    console.log('ğŸ“¥ å·¥ä½œæµå“åº”çŠ¶æ€:', response.status, response.statusText)\r\n-\r\n     if (!response.ok) {\r\n       const errorText = await response.text()\r\n-      console.error('âŒ å·¥ä½œæµæäº¤å¤±è´¥å“åº”:', errorText)\r\n       throw new Error(`å·¥ä½œæµæäº¤å¤±è´¥: ${response.status} ${response.statusText} - ${errorText}`)\r\n     }\r\n \r\n     const result = await response.json()\r\n-    console.log('âœ… å·¥ä½œæµæäº¤æˆåŠŸ:', result)\r\n \r\n     // éªŒè¯è¿”å›ç»“æœ\r\n     if (!result.prompt_id) {\r\n       throw new Error('å·¥ä½œæµå“åº”ä¸­ç¼ºå°‘prompt_id')\r\n"
                },
                {
                    "date": 1752511254874,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -464,10 +464,8 @@\n     console.error('âŒ å·¥ä½œæµæäº¤å¤±è´¥:', error)\r\n \r\n     // è®°å½•æœåŠ¡å™¨å¤±è´¥\r\n     if (selectedServer) {\r\n-      console.log('ğŸ“ è®°å½•æœåŠ¡å™¨å¤±è´¥:', selectedServer)\r\n-\r\n       // ç¡®å®šé”™è¯¯ç±»å‹\r\n       let errorType = 'workflow_error'\r\n       if (error.message.includes('timeout')) errorType = 'timeout'\r\n       else if (error.message.includes('network')) errorType = 'network'\r\n"
                },
                {
                    "date": 1752511270939,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -499,9 +499,8 @@\n \r\n     // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œè®°å½•å¤±è´¥\r\n     if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('timeout')) {\r\n       const currentServer = await getApiBaseUrl()\r\n-      console.log('ğŸ“ è®°å½•æœåŠ¡å™¨çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', currentServer)\r\n \r\n       // ç¡®å®šé”™è¯¯ç±»å‹\r\n       let errorType = 'status_check_error'\r\n       if (error.message.includes('timeout')) errorType = 'timeout'\r\n"
                },
                {
                    "date": 1752511287625,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -686,21 +686,18 @@\n     } else {\r\n       wsUrl = baseUrl.replace('http://', 'ws://') + '/ws?clientId=' + config.CLIENT_ID\r\n     }\r\n \r\n-    console.log('ğŸ”Œ æ­£åœ¨è¿æ¥ ComfyUI WebSocket...')\r\n-\r\n     // å…ˆæµ‹è¯•HTTPè¿æ¥æ˜¯å¦æ­£å¸¸\r\n     try {\r\n       const testResponse = await fetch(`${baseUrl}/system_stats`, {\r\n         method: 'GET',\r\n         signal: AbortSignal.timeout(5000)\r\n       })\r\n       if (!testResponse.ok) {\r\n-        console.warn('âš ï¸ ComfyUI HTTPè¿æ¥å¼‚å¸¸:', testResponse.status)\r\n+        throw new Error(`HTTPè¿æ¥å¼‚å¸¸: ${testResponse.status}`)\r\n       }\r\n     } catch (httpError) {\r\n-      console.error('âŒ ComfyUI HTTPè¿æ¥å¤±è´¥:', httpError)\r\n       throw new Error(`ComfyUIæœåŠ¡å™¨ä¸å¯è¾¾: ${httpError.message}`)\r\n     }\r\n \r\n     wsConnection = new WebSocket(wsUrl)\r\n"
                },
                {
                    "date": 1752511303763,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -703,14 +703,12 @@\n     wsConnection = new WebSocket(wsUrl)\r\n \r\n     return new Promise((resolve, reject) => {\r\n       const timeout = setTimeout(() => {\r\n-        console.error('âŒ WebSocket è¿æ¥è¶…æ—¶')\r\n         reject(new Error('WebSocket è¿æ¥è¶…æ—¶'))\r\n       }, 10000)\r\n \r\n       wsConnection.onopen = () => {\r\n-        console.log('âœ… ComfyUI WebSocket è¿æ¥æˆåŠŸ')\r\n         isWsConnected = true\r\n         connectionAttempts = 0 // é‡ç½®è¿æ¥å°è¯•æ¬¡æ•°\r\n         lastMessageTime = Date.now() // é‡ç½®æœ€åæ¶ˆæ¯æ—¶é—´\r\n         clearTimeout(timeout)\r\n"
                },
                {
                    "date": 1752511325472,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -810,20 +810,17 @@\n               }\r\n               return\r\n             }\r\n \r\n-            console.log(`ğŸ”„ å°è¯•é‡æ–°è¿æ¥ ComfyUI WebSocket (${connectionAttempts}/${maxConnectionAttempts})...`)\r\n-\r\n             try {\r\n               await initializeWebSocket()\r\n \r\n               // é‡è¿æˆåŠŸåï¼Œæ£€æŸ¥å¾…å¤„ç†ä»»åŠ¡çš„çŠ¶æ€\r\n               if (hasPendingTasks) {\r\n-                console.log('ğŸ” é‡è¿æˆåŠŸï¼Œæ£€æŸ¥å¾…å¤„ç†ä»»åŠ¡çŠ¶æ€...')\r\n                 await checkPendingTasksStatus()\r\n               }\r\n             } catch (error) {\r\n-              console.error(`âŒ WebSocket é‡è¿å¤±è´¥ (${connectionAttempts}/${maxConnectionAttempts}):`, error)\r\n+              // é‡è¿å¤±è´¥ï¼Œç»§ç»­ç­‰å¾…ä¸‹æ¬¡é‡è¯•\r\n             }\r\n           }, exponentialDelay)\r\n         }\r\n       }\r\n"
                },
                {
                    "date": 1752511341754,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -825,9 +825,8 @@\n         }\r\n       }\r\n \r\n       wsConnection.onerror = (error) => {\r\n-        console.error('âŒ ComfyUI WebSocket è¿æ¥é”™è¯¯:', error)\r\n         clearTimeout(timeout)\r\n \r\n         // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n         showWebSocketStatusNotification('WebSocketè¿æ¥é”™è¯¯', 'error')\r\n"
                },
                {
                    "date": 1752511364787,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -969,9 +969,8 @@\n     }\r\n \r\n     // å¦‚æœè¶…è¿‡120ç§’æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ä¸”æœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œæ ‡è®°ä»»åŠ¡å¤±è´¥\r\n     if (timeSinceLastMessage > 120000 && pendingTasks.size > 0) {\r\n-      console.error('âŒ WebSocketé•¿æ—¶é—´æ— å“åº”ï¼Œæ ‡è®°å¾…å¤„ç†ä»»åŠ¡ä¸ºå¤±è´¥')\r\n       const taskIds = Array.from(pendingTasks.keys())\r\n       for (const promptId of taskIds) {\r\n         const task = pendingTasks.get(promptId)\r\n         if (task && task.onError) {\r\n"
                },
                {
                    "date": 1752511383444,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -992,9 +992,8 @@\n \r\n // æ£€æŸ¥å¾…å¤„ç†ä»»åŠ¡çŠ¶æ€\r\n async function checkPendingTasksStatus() {\r\n   const taskIds = Array.from(pendingTasks.keys())\r\n-  console.log(`ğŸ” æ£€æŸ¥ ${taskIds.length} ä¸ªå¾…å¤„ç†ä»»åŠ¡çš„çŠ¶æ€...`)\r\n \r\n   for (const promptId of taskIds) {\r\n     try {\r\n       const result = await checkTaskStatus(promptId)\r\n"
                },
                {
                    "date": 1752511400167,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1453,25 +1453,21 @@\n // æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€\r\n async function checkComfyUIServerStatus() {\r\n   try {\r\n     const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n-    console.log('ğŸ” æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€:', apiBaseUrl)\r\n \r\n     const response = await fetch(`${apiBaseUrl}/system_stats`, {\r\n       method: 'GET',\r\n       signal: AbortSignal.timeout(10000) // 10ç§’è¶…æ—¶\r\n     })\r\n \r\n     if (response.ok) {\r\n       const stats = await response.json()\r\n-      console.log('âœ… ComfyUIæœåŠ¡å™¨çŠ¶æ€æ­£å¸¸:', stats)\r\n       return { status: 'ok', stats }\r\n     } else {\r\n-      console.warn('âš ï¸ ComfyUIæœåŠ¡å™¨å“åº”å¼‚å¸¸:', response.status)\r\n       return { status: 'error', code: response.status }\r\n     }\r\n   } catch (error) {\r\n-    console.error('âŒ ComfyUIæœåŠ¡å™¨è¿æ¥å¤±è´¥:', error)\r\n     return { status: 'error', error: error.message }\r\n   }\r\n }\r\n \r\n"
                },
                {
                    "date": 1752512660186,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -186,54 +186,32 @@\n function getCurrentConfig(forceRefresh = false) {\r\n   return getComfyUIConfig(forceRefresh)\r\n }\r\n \r\n-// è·å–APIåŸºç¡€URL - ä½¿ç”¨è´Ÿè½½å‡è¡¡\r\n-async function getApiBaseUrl(forceReassessment = false, excludeUrls = []) {\r\n+// è·å–APIåŸºç¡€URL - ä½¿ç”¨æç®€è´Ÿè½½å‡è¡¡\r\n+async function getApiBaseUrl() {\r\n   try {\r\n-    // å¦‚æœWebSocketå·²è¿æ¥ä¸”æ²¡æœ‰å¼ºåˆ¶é‡æ–°è¯„ä¼°ï¼Œä¼˜å…ˆä½¿ç”¨WebSocketè¿æ¥çš„æœåŠ¡å™¨\r\n-    if (!forceReassessment && currentWebSocketServer && isWsConnected) {\r\n+    // å¦‚æœWebSocketå·²è¿æ¥ï¼Œä¼˜å…ˆä½¿ç”¨WebSocketè¿æ¥çš„æœåŠ¡å™¨ä¿æŒä¸€è‡´æ€§\r\n+    if (currentWebSocketServer && isWsConnected) {\r\n       console.log('ğŸ”— ä½¿ç”¨WebSocketè¿æ¥çš„æœåŠ¡å™¨ä¿æŒä¸€è‡´æ€§:', currentWebSocketServer)\r\n       return currentWebSocketServer\r\n     }\r\n \r\n-    // å¦‚æœéœ€è¦å¼ºåˆ¶é‡æ–°è¯„ä¼°ï¼Œè§¦å‘è´Ÿè½½å‡è¡¡å™¨é‡æ–°è¯„ä¼°\r\n-    if (forceReassessment) {\r\n-      console.log('ğŸ”„ å¼ºåˆ¶é‡æ–°è¯„ä¼°æœåŠ¡å™¨...')\r\n-      await loadBalancer.forceReassessment()\r\n-    }\r\n-\r\n     // ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\r\n-    let optimalServer\r\n-    if (excludeUrls.length > 0) {\r\n-      console.log('ğŸ”„ è·å–ä¸‹ä¸€ä¸ªå¯ç”¨æœåŠ¡å™¨ï¼Œæ’é™¤:', excludeUrls)\r\n-      optimalServer = await loadBalancer.getNextAvailableServer(excludeUrls)\r\n-    } else {\r\n-      optimalServer = await loadBalancer.getOptimalServer()\r\n-    }\r\n-\r\n+    const optimalServer = await loadBalancer.getOptimalServer()\r\n     console.log('ğŸ¯ è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœåŠ¡å™¨:', optimalServer)\r\n \r\n-    // å¦‚æœé€‰æ‹©çš„æœåŠ¡å™¨ä¸å½“å‰WebSocketæœåŠ¡å™¨ä¸åŒï¼Œä¸”WebSocketå·²è¿æ¥ï¼Œéœ€è¦é‡è¿WebSocket\r\n-    if (currentWebSocketServer && currentWebSocketServer !== optimalServer && isWsConnected) {\r\n-      console.log(`âš ï¸ æ£€æµ‹åˆ°æœåŠ¡å™¨åˆ‡æ¢ (${currentWebSocketServer} â†’ ${optimalServer})ï¼Œéœ€è¦é‡è¿WebSocket`)\r\n-      // å¼‚æ­¥é‡è¿WebSocketï¼Œä¸é˜»å¡å½“å‰è¯·æ±‚\r\n-      setTimeout(() => {\r\n-        initializeWebSocket(true).catch(error => {\r\n-          console.error('âŒ å¼‚æ­¥WebSocketé‡è¿å¤±è´¥:', error)\r\n-        })\r\n-      }, 100)\r\n-    }\r\n-\r\n     // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n     let baseUrl = optimalServer\r\n     if (baseUrl && baseUrl.endsWith('/')) {\r\n       baseUrl = baseUrl.slice(0, -1)\r\n     }\r\n \r\n     return baseUrl\r\n   } catch (error) {\r\n-    // é™çº§åˆ°é…ç½®çš„æœåŠ¡å™¨\r\n+    console.error('âŒ è·å–APIåŸºç¡€URLå¤±è´¥:', error)\r\n+\r\n+    // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨é…ç½®ä¸­çš„é»˜è®¤æœåŠ¡å™¨\r\n     const config = getComfyUIConfig(true)\r\n     let baseUrl = config.COMFYUI_SERVER_URL\r\n \r\n     if (baseUrl && baseUrl.endsWith('/')) {\r\n"
                },
                {
                    "date": 1752512681313,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -643,21 +643,13 @@\n     }\r\n \r\n     const config = getComfyUIConfig()\r\n \r\n-    // ä¸ºWebSocketè¿æ¥é”å®šæœåŠ¡å™¨ï¼Œé¿å…åœ¨è¿æ¥è¿‡ç¨‹ä¸­åˆ‡æ¢\r\n-    console.log('ğŸ”’ ä¸ºWebSocketè¿æ¥é”å®šæœåŠ¡å™¨é€‰æ‹©...')\r\n+    // è·å–æœåŠ¡å™¨URLç”¨äºWebSocketè¿æ¥\r\n     const baseUrl = await getApiBaseUrl()\r\n     currentWebSocketServer = baseUrl\r\n+    console.log(`ğŸ”Œ å‡†å¤‡è¿æ¥WebSocketæœåŠ¡å™¨: ${baseUrl}`)\r\n \r\n-    // é€šçŸ¥è´Ÿè½½å‡è¡¡å™¨é”å®šå½“å‰æœåŠ¡å™¨ç”¨äºWebSocket\r\n-    try {\r\n-      await loadBalancer.lockServerForWebSocket(baseUrl)\r\n-      console.log(`ğŸ”’ğŸŒ å·²é”å®šæœåŠ¡å™¨ç”¨äºWebSocket: ${baseUrl}`)\r\n-    } catch (error) {\r\n-      console.warn('âš ï¸ æ— æ³•é”å®šæœåŠ¡å™¨ï¼Œç»§ç»­ä½¿ç”¨å½“å‰é€‰æ‹©:', error)\r\n-    }\r\n-\r\n     // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„WebSocket URLæ ¼å¼\r\n     let wsUrl\r\n     if (baseUrl.startsWith('https://')) {\r\n       wsUrl = baseUrl.replace('https://', 'wss://') + '/ws?clientId=' + config.CLIENT_ID\r\n"
                },
                {
                    "date": 1752512748068,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -700,16 +700,11 @@\n \r\n         // åœæ­¢å¥åº·æ£€æŸ¥\r\n         stopWebSocketHealthCheck()\r\n \r\n-        // é‡Šæ”¾æœåŠ¡å™¨é”å®š\r\n+        // æ¸…ç†WebSocketæœåŠ¡å™¨è®°å½•\r\n         if (currentWebSocketServer) {\r\n-          try {\r\n-            loadBalancer.unlockWebSocketServer()\r\n-            console.log(`ğŸ”“ğŸŒ å·²é‡Šæ”¾WebSocketæœåŠ¡å™¨é”å®š: ${currentWebSocketServer}`)\r\n-          } catch (error) {\r\n-            console.warn('âš ï¸ é‡Šæ”¾æœåŠ¡å™¨é”å®šå¤±è´¥:', error)\r\n-          }\r\n+          console.log(`ğŸ”Œ WebSocketè¿æ¥å·²æ–­å¼€: ${currentWebSocketServer}`)\r\n           currentWebSocketServer = null\r\n         }\r\n \r\n         // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n"
                },
                {
                    "date": 1752520314318,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -186,8 +186,55 @@\n function getCurrentConfig(forceRefresh = false) {\r\n   return getComfyUIConfig(forceRefresh)\r\n }\r\n \r\n+// æ£€æµ‹APIå‰ç¼€\r\n+async function detectApiPrefix(serverUrl) {\r\n+  try {\r\n+    // å…ˆå°è¯• /api/queue\r\n+    const apiResponse = await fetch(`${serverUrl}/api/queue`, {\r\n+      method: 'GET',\r\n+      timeout: 3000,\r\n+      headers: {\r\n+        'Accept': '*/*',\r\n+        'comfy-user': 'prefix-detector'\r\n+      },\r\n+      mode: 'cors',\r\n+      credentials: 'omit'\r\n+    })\r\n+\r\n+    if (apiResponse.ok) {\r\n+      console.log('ğŸ” æ£€æµ‹åˆ°APIå‰ç¼€: /api')\r\n+      return '/api'\r\n+    }\r\n+  } catch (error) {\r\n+    // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­å°è¯•æ ‡å‡†ç«¯ç‚¹\r\n+  }\r\n+\r\n+  try {\r\n+    // å†å°è¯•æ ‡å‡† /queue\r\n+    const standardResponse = await fetch(`${serverUrl}/queue`, {\r\n+      method: 'GET',\r\n+      timeout: 3000,\r\n+      headers: {\r\n+        'Accept': '*/*',\r\n+        'comfy-user': 'prefix-detector'\r\n+      },\r\n+      mode: 'cors',\r\n+      credentials: 'omit'\r\n+    })\r\n+\r\n+    if (standardResponse.ok) {\r\n+      console.log('ğŸ” ä½¿ç”¨æ ‡å‡†ç«¯ç‚¹ï¼Œæ— APIå‰ç¼€')\r\n+      return ''\r\n+    }\r\n+  } catch (error) {\r\n+    console.warn('âš ï¸ æ— æ³•æ£€æµ‹APIå‰ç¼€ï¼Œä½¿ç”¨é»˜è®¤')\r\n+  }\r\n+\r\n+  return '' // é»˜è®¤æ— å‰ç¼€\r\n+}\r\n+\r\n // è·å–APIåŸºç¡€URL - ä½¿ç”¨æç®€è´Ÿè½½å‡è¡¡\r\n async function getApiBaseUrl() {\r\n   try {\r\n     // å¦‚æœWebSocketå·²è¿æ¥ï¼Œä¼˜å…ˆä½¿ç”¨WebSocketè¿æ¥çš„æœåŠ¡å™¨ä¿æŒä¸€è‡´æ€§\r\n@@ -199,14 +246,21 @@\n     // ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\r\n     const optimalServer = await loadBalancer.getOptimalServer()\r\n     console.log('ğŸ¯ è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœåŠ¡å™¨:', optimalServer)\r\n \r\n+    // æ£€æµ‹æœåŠ¡å™¨æ˜¯å¦ä½¿ç”¨APIå‰ç¼€\r\n+    const apiPrefix = await detectApiPrefix(optimalServer)\r\n+\r\n     // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n     let baseUrl = optimalServer\r\n     if (baseUrl && baseUrl.endsWith('/')) {\r\n       baseUrl = baseUrl.slice(0, -1)\r\n     }\r\n \r\n+    // æ·»åŠ APIå‰ç¼€\r\n+    baseUrl = `${baseUrl}${apiPrefix}`\r\n+\r\n+    console.log(`ğŸ”— æœ€ç»ˆAPIåŸºç¡€URL: ${baseUrl}`)\r\n     return baseUrl\r\n   } catch (error) {\r\n     console.error('âŒ è·å–APIåŸºç¡€URLå¤±è´¥:', error)\r\n \r\n"
                },
                {
                    "date": 1752520330438,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -470,9 +470,12 @@\n \r\n     const response = await fetch(promptUrl, {\r\n       method: 'POST',\r\n       headers: {\r\n-        'Content-Type': 'application/json'\r\n+        'Content-Type': 'application/json',\r\n+        'Accept': '*/*',\r\n+        'comfy-user': config.CLIENT_ID,\r\n+        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'\r\n       },\r\n       body: JSON.stringify(requestBody),\r\n       mode: 'cors',\r\n       credentials: 'omit'\r\n"
                },
                {
                    "date": 1752520972759,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -186,56 +186,9 @@\n function getCurrentConfig(forceRefresh = false) {\r\n   return getComfyUIConfig(forceRefresh)\r\n }\r\n \r\n-// æ£€æµ‹APIå‰ç¼€\r\n-async function detectApiPrefix(serverUrl) {\r\n-  try {\r\n-    // å…ˆå°è¯• /api/queue\r\n-    const apiResponse = await fetch(`${serverUrl}/api/queue`, {\r\n-      method: 'GET',\r\n-      timeout: 3000,\r\n-      headers: {\r\n-        'Accept': '*/*',\r\n-        'comfy-user': 'prefix-detector'\r\n-      },\r\n-      mode: 'cors',\r\n-      credentials: 'omit'\r\n-    })\r\n-\r\n-    if (apiResponse.ok) {\r\n-      console.log('ğŸ” æ£€æµ‹åˆ°APIå‰ç¼€: /api')\r\n-      return '/api'\r\n-    }\r\n-  } catch (error) {\r\n-    // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­å°è¯•æ ‡å‡†ç«¯ç‚¹\r\n-  }\r\n-\r\n-  try {\r\n-    // å†å°è¯•æ ‡å‡† /queue\r\n-    const standardResponse = await fetch(`${serverUrl}/queue`, {\r\n-      method: 'GET',\r\n-      timeout: 3000,\r\n-      headers: {\r\n-        'Accept': '*/*',\r\n-        'comfy-user': 'prefix-detector'\r\n-      },\r\n-      mode: 'cors',\r\n-      credentials: 'omit'\r\n-    })\r\n-\r\n-    if (standardResponse.ok) {\r\n-      console.log('ğŸ” ä½¿ç”¨æ ‡å‡†ç«¯ç‚¹ï¼Œæ— APIå‰ç¼€')\r\n-      return ''\r\n-    }\r\n-  } catch (error) {\r\n-    console.warn('âš ï¸ æ— æ³•æ£€æµ‹APIå‰ç¼€ï¼Œä½¿ç”¨é»˜è®¤')\r\n-  }\r\n-\r\n-  return '' // é»˜è®¤æ— å‰ç¼€\r\n-}\r\n-\r\n-// è·å–APIåŸºç¡€URL - ä½¿ç”¨æç®€è´Ÿè½½å‡è¡¡\r\n+// è·å–APIåŸºç¡€URL - ç®€åŒ–ç‰ˆæœ¬\r\n async function getApiBaseUrl() {\r\n   try {\r\n     // å¦‚æœWebSocketå·²è¿æ¥ï¼Œä¼˜å…ˆä½¿ç”¨WebSocketè¿æ¥çš„æœåŠ¡å™¨ä¿æŒä¸€è‡´æ€§\r\n     if (currentWebSocketServer && isWsConnected) {\r\n@@ -246,20 +199,14 @@\n     // ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\r\n     const optimalServer = await loadBalancer.getOptimalServer()\r\n     console.log('ğŸ¯ è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœåŠ¡å™¨:', optimalServer)\r\n \r\n-    // æ£€æµ‹æœåŠ¡å™¨æ˜¯å¦ä½¿ç”¨APIå‰ç¼€\r\n-    const apiPrefix = await detectApiPrefix(optimalServer)\r\n-\r\n     // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n     let baseUrl = optimalServer\r\n     if (baseUrl && baseUrl.endsWith('/')) {\r\n       baseUrl = baseUrl.slice(0, -1)\r\n     }\r\n \r\n-    // æ·»åŠ APIå‰ç¼€\r\n-    baseUrl = `${baseUrl}${apiPrefix}`\r\n-\r\n     console.log(`ğŸ”— æœ€ç»ˆAPIåŸºç¡€URL: ${baseUrl}`)\r\n     return baseUrl\r\n   } catch (error) {\r\n     console.error('âŒ è·å–APIåŸºç¡€URLå¤±è´¥:', error)\r\n"
                },
                {
                    "date": 1752544047438,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -246,17 +246,9 @@\n         // è·å–å½“å‰å¤±è´¥çš„æœåŠ¡å™¨URL\r\n         const currentServer = await getApiBaseUrl()\r\n         if (currentServer) {\r\n           excludeUrls.push(currentServer)\r\n-\r\n-          // è®°å½•å¤±è´¥\r\n-          let errorType = 'api_error'\r\n-          if (error.message.includes('timeout')) errorType = 'timeout'\r\n-          else if (error.message.includes('network')) errorType = 'network'\r\n-          else if (error.message.includes('fetch')) errorType = 'connection'\r\n-          else if (error.message.includes('500') || error.message.includes('502') || error.message.includes('503')) errorType = 'server_error'\r\n-\r\n-          await loadBalancer.recordFailure(currentServer, errorType)\r\n+          console.warn(`âš ï¸ æœåŠ¡å™¨ ${currentServer} è¯·æ±‚å¤±è´¥ï¼Œå°†åœ¨é‡è¯•æ—¶æ’é™¤`)\r\n         }\r\n \r\n         // ç­‰å¾…ä¸€æ®µæ—¶é—´å†é‡è¯•\r\n         await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)))\r\n"
                },
                {
                    "date": 1752544079644,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -339,19 +339,12 @@\n \r\n   } catch (error) {\r\n     console.error('âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error)\r\n \r\n-    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œè®°å½•å¤±è´¥å¹¶å¯èƒ½è§¦å‘é‡æ–°è¯„ä¼°\r\n+    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œè®°å½•å¤±è´¥ä¿¡æ¯\r\n     if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('timeout')) {\r\n       const currentServer = await getApiBaseUrl()\r\n-\r\n-      // ç¡®å®šé”™è¯¯ç±»å‹\r\n-      let errorType = 'upload_error'\r\n-      if (error.message.includes('timeout')) errorType = 'timeout'\r\n-      else if (error.message.includes('network')) errorType = 'network'\r\n-      else if (error.message.includes('fetch')) errorType = 'connection'\r\n-\r\n-      await loadBalancer.recordFailure(currentServer, errorType)\r\n+      console.warn(`âš ï¸ å›¾ç‰‡ä¸Šä¼ åˆ°æœåŠ¡å™¨ ${currentServer} å¤±è´¥:`, error.message)\r\n     }\r\n \r\n     throw new Error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`)\r\n   }\r\n"
                },
                {
                    "date": 1752545490170,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -645,17 +645,37 @@\n     } else {\r\n       wsUrl = baseUrl.replace('http://', 'ws://') + '/ws?clientId=' + config.CLIENT_ID\r\n     }\r\n \r\n-    // å…ˆæµ‹è¯•HTTPè¿æ¥æ˜¯å¦æ­£å¸¸\r\n+    // å…ˆæµ‹è¯•HTTPè¿æ¥æ˜¯å¦æ­£å¸¸ - ä½¿ç”¨å®˜æ–¹ç«¯ç‚¹\r\n     try {\r\n-      const testResponse = await fetch(`${baseUrl}/system_stats`, {\r\n-        method: 'GET',\r\n-        signal: AbortSignal.timeout(5000)\r\n-      })\r\n-      if (!testResponse.ok) {\r\n-        throw new Error(`HTTPè¿æ¥å¼‚å¸¸: ${testResponse.status}`)\r\n+      // å°è¯•å¤šä¸ªç«¯ç‚¹ç¡®ä¿è¿æ¥æ­£å¸¸\r\n+      const testEndpoints = ['/api/queue', '/api/system_stats', '/queue', '/system_stats']\r\n+      let connectionOk = false\r\n+\r\n+      for (const endpoint of testEndpoints) {\r\n+        try {\r\n+          const testResponse = await fetch(`${baseUrl}${endpoint}`, {\r\n+            method: 'GET',\r\n+            headers: {\r\n+              'Accept': 'application/json, */*',\r\n+              'comfy-user': 'websocket-test'\r\n+            },\r\n+            signal: AbortSignal.timeout(5000)\r\n+          })\r\n+          if (testResponse.ok) {\r\n+            console.log(`âœ… HTTPè¿æ¥æµ‹è¯•æˆåŠŸ: ${endpoint}`)\r\n+            connectionOk = true\r\n+            break\r\n+          }\r\n+        } catch (endpointError) {\r\n+          console.log(`âš ï¸ ç«¯ç‚¹ ${endpoint} æµ‹è¯•å¤±è´¥: ${endpointError.message}`)\r\n+        }\r\n       }\r\n+\r\n+      if (!connectionOk) {\r\n+        throw new Error('æ‰€æœ‰HTTPç«¯ç‚¹æµ‹è¯•å¤±è´¥')\r\n+      }\r\n     } catch (httpError) {\r\n       throw new Error(`ComfyUIæœåŠ¡å™¨ä¸å¯è¾¾: ${httpError.message}`)\r\n     }\r\n \r\n"
                },
                {
                    "date": 1752545507200,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1423,24 +1423,42 @@\n     }\r\n   }\r\n }\r\n \r\n-// æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€\r\n+// æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€ - ä½¿ç”¨å®˜æ–¹ç«¯ç‚¹\r\n async function checkComfyUIServerStatus() {\r\n   try {\r\n     const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n \r\n-    const response = await fetch(`${apiBaseUrl}/system_stats`, {\r\n-      method: 'GET',\r\n-      signal: AbortSignal.timeout(10000) // 10ç§’è¶…æ—¶\r\n-    })\r\n+    // åŸºäºå®˜æ–¹æ–‡æ¡£çš„ç«¯ç‚¹åˆ—è¡¨\r\n+    const testEndpoints = ['/api/system_stats', '/api/queue', '/system_stats', '/queue']\r\n \r\n-    if (response.ok) {\r\n-      const stats = await response.json()\r\n-      return { status: 'ok', stats }\r\n-    } else {\r\n-      return { status: 'error', code: response.status }\r\n+    for (const endpoint of testEndpoints) {\r\n+      try {\r\n+        const response = await fetch(`${apiBaseUrl}${endpoint}`, {\r\n+          method: 'GET',\r\n+          headers: {\r\n+            'Accept': 'application/json, */*',\r\n+            'comfy-user': 'status-check'\r\n+          },\r\n+          signal: AbortSignal.timeout(10000) // 10ç§’è¶…æ—¶\r\n+        })\r\n+\r\n+        if (response.ok) {\r\n+          try {\r\n+            const data = await response.json()\r\n+            return { status: 'ok', endpoint, data }\r\n+          } catch (jsonError) {\r\n+            // å³ä½¿ä¸æ˜¯JSONï¼Œåªè¦å“åº”æˆåŠŸå°±è®¤ä¸ºæœåŠ¡å™¨æ­£å¸¸\r\n+            return { status: 'ok', endpoint, note: 'éJSONå“åº”ä½†è¿æ¥æ­£å¸¸' }\r\n+          }\r\n+        }\r\n+      } catch (endpointError) {\r\n+        console.log(`ç«¯ç‚¹ ${endpoint} æµ‹è¯•å¤±è´¥: ${endpointError.message}`)\r\n+      }\r\n     }\r\n+\r\n+    return { status: 'error', error: 'æ‰€æœ‰ç«¯ç‚¹æµ‹è¯•å¤±è´¥' }\r\n   } catch (error) {\r\n     return { status: 'error', error: error.message }\r\n   }\r\n }\r\n"
                },
                {
                    "date": 1752547652314,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -645,28 +645,38 @@\n     } else {\r\n       wsUrl = baseUrl.replace('http://', 'ws://') + '/ws?clientId=' + config.CLIENT_ID\r\n     }\r\n \r\n-    // å…ˆæµ‹è¯•HTTPè¿æ¥æ˜¯å¦æ­£å¸¸ - ä½¿ç”¨å®˜æ–¹ç«¯ç‚¹\r\n+    // å…ˆæµ‹è¯•HTTPè¿æ¥æ˜¯å¦æ­£å¸¸ - ä½¿ç”¨ç»Ÿä¸€çš„å®˜æ–¹ç«¯ç‚¹é…ç½®\r\n     try {\r\n-      // å°è¯•å¤šä¸ªç«¯ç‚¹ç¡®ä¿è¿æ¥æ­£å¸¸\r\n-      const testEndpoints = ['/api/queue', '/api/system_stats', '/queue', '/system_stats']\r\n+      const testEndpoints = comfyUIConfig.getHealthCheckEndpoints()\r\n       let connectionOk = false\r\n \r\n       for (const endpoint of testEndpoints) {\r\n         try {\r\n           const testResponse = await fetch(`${baseUrl}${endpoint}`, {\r\n             method: 'GET',\r\n-            headers: {\r\n-              'Accept': 'application/json, */*',\r\n-              'comfy-user': 'websocket-test'\r\n-            },\r\n-            signal: AbortSignal.timeout(5000)\r\n+            headers: comfyUIConfig.HEALTH_CHECK.HEADERS,\r\n+            signal: AbortSignal.timeout(comfyUIConfig.HEALTH_CHECK.TIMEOUT / 2) // ä½¿ç”¨ä¸€åŠè¶…æ—¶æ—¶é—´\r\n           })\r\n+\r\n           if (testResponse.ok) {\r\n-            console.log(`âœ… HTTPè¿æ¥æµ‹è¯•æˆåŠŸ: ${endpoint}`)\r\n-            connectionOk = true\r\n-            break\r\n+            // éªŒè¯å“åº”æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ComfyUIå“åº”\r\n+            try {\r\n+              const data = await testResponse.json()\r\n+              const isValid = comfyUIConfig.validateResponse(endpoint, data)\r\n+              if (isValid) {\r\n+                console.log(`âœ… HTTPè¿æ¥æµ‹è¯•æˆåŠŸ: ${endpoint} (å·²éªŒè¯ComfyUIå“åº”)`)\r\n+                connectionOk = true\r\n+                break\r\n+              } else {\r\n+                console.log(`âš ï¸ ç«¯ç‚¹ ${endpoint} å“åº”ä½†éªŒè¯å¤±è´¥`)\r\n+              }\r\n+            } catch (jsonError) {\r\n+              console.log(`âœ… HTTPè¿æ¥æµ‹è¯•æˆåŠŸ: ${endpoint} (éJSONå“åº”ä½†è¿æ¥æ­£å¸¸)`)\r\n+              connectionOk = true\r\n+              break\r\n+            }\r\n           }\r\n         } catch (endpointError) {\r\n           console.log(`âš ï¸ ç«¯ç‚¹ ${endpoint} æµ‹è¯•å¤±è´¥: ${endpointError.message}`)\r\n         }\r\n"
                },
                {
                    "date": 1752547676651,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1433,33 +1433,40 @@\n     }\r\n   }\r\n }\r\n \r\n-// æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€ - ä½¿ç”¨å®˜æ–¹ç«¯ç‚¹\r\n+// æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€ - ä½¿ç”¨ç»Ÿä¸€çš„å®˜æ–¹ç«¯ç‚¹é…ç½®\r\n async function checkComfyUIServerStatus() {\r\n   try {\r\n     const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n+    const testEndpoints = comfyUIConfig.getHealthCheckEndpoints()\r\n \r\n-    // åŸºäºå®˜æ–¹æ–‡æ¡£çš„ç«¯ç‚¹åˆ—è¡¨\r\n-    const testEndpoints = ['/api/system_stats', '/api/queue', '/system_stats', '/queue']\r\n+    console.log('ğŸ” æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€:', apiBaseUrl)\r\n+    console.log('ğŸ“‹ ä½¿ç”¨ç«¯ç‚¹åˆ—è¡¨:', testEndpoints)\r\n \r\n     for (const endpoint of testEndpoints) {\r\n       try {\r\n         const response = await fetch(`${apiBaseUrl}${endpoint}`, {\r\n           method: 'GET',\r\n-          headers: {\r\n-            'Accept': 'application/json, */*',\r\n-            'comfy-user': 'status-check'\r\n-          },\r\n-          signal: AbortSignal.timeout(10000) // 10ç§’è¶…æ—¶\r\n+          headers: comfyUIConfig.HEALTH_CHECK.HEADERS,\r\n+          signal: AbortSignal.timeout(comfyUIConfig.HEALTH_CHECK.TIMEOUT)\r\n         })\r\n \r\n         if (response.ok) {\r\n           try {\r\n             const data = await response.json()\r\n-            return { status: 'ok', endpoint, data }\r\n+            const isValid = comfyUIConfig.validateResponse(endpoint, data)\r\n+\r\n+            if (isValid) {\r\n+              console.log(`âœ… æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥æˆåŠŸ: ${endpoint} (å·²éªŒè¯ComfyUIå“åº”)`)\r\n+              return { status: 'ok', endpoint, data, validated: true }\r\n+            } else {\r\n+              console.log(`âš ï¸ ç«¯ç‚¹ ${endpoint} å“åº”ä½†éªŒè¯å¤±è´¥`)\r\n+              continue\r\n+            }\r\n           } catch (jsonError) {\r\n             // å³ä½¿ä¸æ˜¯JSONï¼Œåªè¦å“åº”æˆåŠŸå°±è®¤ä¸ºæœåŠ¡å™¨æ­£å¸¸\r\n+            console.log(`âœ… æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥æˆåŠŸ: ${endpoint} (éJSONå“åº”ä½†è¿æ¥æ­£å¸¸)`)\r\n             return { status: 'ok', endpoint, note: 'éJSONå“åº”ä½†è¿æ¥æ­£å¸¸' }\r\n           }\r\n         }\r\n       } catch (endpointError) {\r\n"
                },
                {
                    "date": 1752551930854,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -222,37 +222,48 @@\n     return baseUrl\r\n   }\r\n }\r\n \r\n-// å¸¦é‡è¯•çš„APIè°ƒç”¨åŒ…è£…å™¨\r\n-async function callWithRetry(apiCall, maxRetries = 2, excludeUrls = []) {\r\n+// å¸¦é‡è¯•çš„APIè°ƒç”¨åŒ…è£…å™¨ - ä¿®å¤ç‰ˆæœ¬ï¼Œé¿å…é‡å¤è°ƒç”¨æ‰€æœ‰æœåŠ¡å™¨\r\n+async function callWithRetry(apiCall, maxRetries = 2) {\r\n   let lastError = null\r\n+  let selectedServer = null\r\n \r\n   for (let attempt = 0; attempt <= maxRetries; attempt++) {\r\n     try {\r\n-      const result = await apiCall()\r\n+      // åªåœ¨ç¬¬ä¸€æ¬¡å°è¯•æ—¶é€‰æ‹©æœåŠ¡å™¨ï¼Œåç»­é‡è¯•ä½¿ç”¨ç›¸åŒæœåŠ¡å™¨\r\n+      if (attempt === 0) {\r\n+        selectedServer = await getApiBaseUrl()\r\n+        console.log(`ğŸ¯ é€‰æ‹©æœåŠ¡å™¨è¿›è¡ŒAPIè°ƒç”¨: ${selectedServer}`)\r\n+      }\r\n+\r\n+      const result = await apiCall(selectedServer)\r\n       return result\r\n     } catch (error) {\r\n       lastError = error\r\n+      console.warn(`âš ï¸ ç¬¬${attempt + 1}æ¬¡å°è¯•å¤±è´¥: ${error.message}`)\r\n \r\n-      // å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œä¸”æ˜¯ç½‘ç»œç›¸å…³é”™è¯¯ï¼Œå°è¯•ä¸‹ä¸€ä¸ªæœåŠ¡å™¨\r\n+      // å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œä¸”æ˜¯ç½‘ç»œç›¸å…³é”™è¯¯ï¼Œè®°å½•æœåŠ¡å™¨æ•…éšœå¹¶ç­‰å¾…é‡è¯•\r\n       if (attempt < maxRetries &&\r\n           (error.message.includes('fetch') ||\r\n            error.message.includes('network') ||\r\n            error.message.includes('timeout') ||\r\n            error.message.includes('500') ||\r\n            error.message.includes('502') ||\r\n            error.message.includes('503'))) {\r\n \r\n-        // è·å–å½“å‰å¤±è´¥çš„æœåŠ¡å™¨URL\r\n-        const currentServer = await getApiBaseUrl()\r\n-        if (currentServer) {\r\n-          excludeUrls.push(currentServer)\r\n-          console.warn(`âš ï¸ æœåŠ¡å™¨ ${currentServer} è¯·æ±‚å¤±è´¥ï¼Œå°†åœ¨é‡è¯•æ—¶æ’é™¤`)\r\n+        // è®°å½•æœåŠ¡å™¨æ•…éšœ\r\n+        if (selectedServer) {\r\n+          await loadBalancer.recordFailure(selectedServer, 'api_call_failed')\r\n+          console.warn(`âš ï¸ å·²è®°å½•æœåŠ¡å™¨æ•…éšœ: ${selectedServer}`)\r\n         }\r\n \r\n         // ç­‰å¾…ä¸€æ®µæ—¶é—´å†é‡è¯•\r\n         await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)))\r\n+\r\n+        // é‡æ–°é€‰æ‹©æœåŠ¡å™¨è¿›è¡Œä¸‹ä¸€æ¬¡å°è¯•\r\n+        selectedServer = await getApiBaseUrl()\r\n+        console.log(`ğŸ”„ é‡è¯•ä½¿ç”¨æ–°æœåŠ¡å™¨: ${selectedServer}`)\r\n       }\r\n     }\r\n   }\r\n \r\n"
                },
                {
                    "date": 1752551960969,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -392,33 +392,29 @@\n }\r\n \r\n // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n async function submitWorkflow(workflowPrompt) {\r\n-  let selectedServer = null\r\n-  try {\r\n-    // ç¡®ä¿ WebSocket è¿æ¥\r\n+  return await callWithRetry(async (serverUrl) => {\r\n+    // ç¡®ä¿ WebSocket è¿æ¥åˆ°ç›¸åŒçš„æœåŠ¡å™¨\r\n     await initializeWebSocket()\r\n \r\n     const config = getComfyUIConfig()\r\n-    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n-    selectedServer = apiBaseUrl // è®°å½•é€‰æ‹©çš„æœåŠ¡å™¨\r\n+    console.log(`ğŸ”„ æäº¤å·¥ä½œæµåˆ°æœåŠ¡å™¨: ${serverUrl}`)\r\n \r\n     // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n     const requestBody = {\r\n       client_id: config.CLIENT_ID,\r\n       prompt: workflowPrompt\r\n     }\r\n \r\n     // ç¬¬äºŒæ­¥APIè°ƒç”¨ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n-    const promptUrl = `${apiBaseUrl}/prompt`\r\n+    const promptUrl = `${serverUrl}/prompt`\r\n \r\n     const response = await fetch(promptUrl, {\r\n       method: 'POST',\r\n       headers: {\r\n         'Content-Type': 'application/json',\r\n-        'Accept': '*/*',\r\n-        'comfy-user': config.CLIENT_ID,\r\n-        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'\r\n+        'Accept': 'application/json'\r\n       },\r\n       body: JSON.stringify(requestBody),\r\n       mode: 'cors',\r\n       credentials: 'omit'\r\n@@ -435,8 +431,9 @@\n     if (!result.prompt_id) {\r\n       throw new Error('å·¥ä½œæµå“åº”ä¸­ç¼ºå°‘prompt_id')\r\n     }\r\n \r\n+    console.log(`âœ… å·¥ä½œæµæäº¤æˆåŠŸï¼Œä»»åŠ¡ID: ${result.prompt_id}`)\r\n     return result.prompt_id // è¿”å›ä»»åŠ¡ID\r\n \r\n   } catch (error) {\r\n     console.error('âŒ å·¥ä½œæµæäº¤å¤±è´¥:', error)\r\n"
                },
                {
                    "date": 1752551982737,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -455,13 +455,18 @@\n }\r\n \r\n // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n async function checkTaskStatus(promptId) {\r\n-  try {\r\n-    const config = getComfyUIConfig()\r\n-    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n-    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`)\r\n-    const response = await fetch(`${apiBaseUrl}/history/${promptId}`)\r\n+  return await callWithRetry(async (serverUrl) => {\r\n+    console.log(`ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€: ${serverUrl}/history/${promptId}`)\r\n+    const response = await fetch(`${serverUrl}/history/${promptId}`, {\r\n+      method: 'GET',\r\n+      headers: {\r\n+        'Accept': 'application/json'\r\n+      },\r\n+      mode: 'cors',\r\n+      credentials: 'omit'\r\n+    })\r\n \r\n     if (!response.ok) {\r\n       throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText}`)\r\n     }\r\n"
                },
                {
                    "date": 1752552134369,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -472,27 +472,9 @@\n     }\r\n \r\n     const result = await response.json()\r\n     return result[promptId] || null\r\n-\r\n-  } catch (error) {\r\n-    console.error('çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', error)\r\n-\r\n-    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œè®°å½•å¤±è´¥\r\n-    if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('timeout')) {\r\n-      const currentServer = await getApiBaseUrl()\r\n-\r\n-      // ç¡®å®šé”™è¯¯ç±»å‹\r\n-      let errorType = 'status_check_error'\r\n-      if (error.message.includes('timeout')) errorType = 'timeout'\r\n-      else if (error.message.includes('network')) errorType = 'network'\r\n-      else if (error.message.includes('fetch')) errorType = 'connection'\r\n-\r\n-      await loadBalancer.recordFailure(currentServer, errorType)\r\n-    }\r\n-\r\n-    throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${error.message}`)\r\n-  }\r\n+  })\r\n }\r\n \r\n // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n async function getGeneratedImage(taskResult) {\r\n"
                },
                {
                    "date": 1752552163838,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -477,11 +477,9 @@\n }\r\n \r\n // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n async function getGeneratedImage(taskResult) {\r\n-  try {\r\n-    const config = getComfyUIConfig()\r\n-    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n+  return await callWithRetry(async (serverUrl) => {\r\n \r\n     // ä»ä»»åŠ¡ç»“æœä¸­æ‰¾åˆ°è¾“å‡ºå›¾ç‰‡\r\n     const outputs = taskResult.outputs\r\n     let imageInfo = null\r\n"
                },
                {
                    "date": 1752552200999,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -529,18 +529,26 @@\n       filename: imageInfo.filename,\r\n       type: imageInfo.type,\r\n       subfolder: imageInfo.subfolder || ''\r\n     })\r\n-    const imageUrl = `${apiBaseUrl}/view?${params.toString()}`\r\n+    const imageUrl = `${serverUrl}/view?${params.toString()}`\r\n \r\n     console.log('ğŸŒ è·å–å›¾ç‰‡URL:', imageUrl)\r\n \r\n     // ä¿å­˜ ComfyUI åŸå§‹URLåˆ°å…¨å±€å˜é‡ï¼Œä¾›ç§¯åˆ†æ‰£é™¤æ—¶ä½¿ç”¨\r\n     window.lastComfyUIImageUrl = imageUrl\r\n     console.log('ğŸ’¾ ä¿å­˜ ComfyUI å›¾ç‰‡URL ä¾›ç§¯åˆ†è®°å½•ä½¿ç”¨:', imageUrl)\r\n \r\n     // è·å–å›¾ç‰‡æ•°æ®å¹¶è½¬æ¢ä¸ºbase64\r\n-    const imageResponse = await fetch(imageUrl)\r\n+    const imageResponse = await fetch(imageUrl, {\r\n+      method: 'GET',\r\n+      headers: {\r\n+        'Accept': 'image/*'\r\n+      },\r\n+      mode: 'cors',\r\n+      credentials: 'omit'\r\n+    })\r\n+\r\n     if (!imageResponse.ok) {\r\n       throw new Error(`å›¾ç‰‡è·å–å¤±è´¥: ${imageResponse.status}`)\r\n     }\r\n \r\n@@ -550,13 +558,9 @@\n       reader.onload = () => resolve(reader.result)\r\n       reader.onerror = reject\r\n       reader.readAsDataURL(imageBlob)\r\n     })\r\n-\r\n-  } catch (error) {\r\n-    console.error('å›¾ç‰‡è·å–å¤±è´¥:', error)\r\n-    throw new Error(`å›¾ç‰‡è·å–å¤±è´¥: ${error.message}`)\r\n-  }\r\n+  })\r\n }\r\n \r\n // WebSocket è¿æ¥ç®¡ç†\r\n let wsConnection = null\r\n"
                },
                {
                    "date": 1752552528058,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -222,48 +222,37 @@\n     return baseUrl\r\n   }\r\n }\r\n \r\n-// å¸¦é‡è¯•çš„APIè°ƒç”¨åŒ…è£…å™¨ - ä¿®å¤ç‰ˆæœ¬ï¼Œé¿å…é‡å¤è°ƒç”¨æ‰€æœ‰æœåŠ¡å™¨\r\n-async function callWithRetry(apiCall, maxRetries = 2) {\r\n+// å¸¦é‡è¯•çš„APIè°ƒç”¨åŒ…è£…å™¨\r\n+async function callWithRetry(apiCall, maxRetries = 2, excludeUrls = []) {\r\n   let lastError = null\r\n-  let selectedServer = null\r\n \r\n   for (let attempt = 0; attempt <= maxRetries; attempt++) {\r\n     try {\r\n-      // åªåœ¨ç¬¬ä¸€æ¬¡å°è¯•æ—¶é€‰æ‹©æœåŠ¡å™¨ï¼Œåç»­é‡è¯•ä½¿ç”¨ç›¸åŒæœåŠ¡å™¨\r\n-      if (attempt === 0) {\r\n-        selectedServer = await getApiBaseUrl()\r\n-        console.log(`ğŸ¯ é€‰æ‹©æœåŠ¡å™¨è¿›è¡ŒAPIè°ƒç”¨: ${selectedServer}`)\r\n-      }\r\n-\r\n-      const result = await apiCall(selectedServer)\r\n+      const result = await apiCall()\r\n       return result\r\n     } catch (error) {\r\n       lastError = error\r\n-      console.warn(`âš ï¸ ç¬¬${attempt + 1}æ¬¡å°è¯•å¤±è´¥: ${error.message}`)\r\n \r\n-      // å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œä¸”æ˜¯ç½‘ç»œç›¸å…³é”™è¯¯ï¼Œè®°å½•æœåŠ¡å™¨æ•…éšœå¹¶ç­‰å¾…é‡è¯•\r\n+      // å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œä¸”æ˜¯ç½‘ç»œç›¸å…³é”™è¯¯ï¼Œå°è¯•ä¸‹ä¸€ä¸ªæœåŠ¡å™¨\r\n       if (attempt < maxRetries &&\r\n           (error.message.includes('fetch') ||\r\n            error.message.includes('network') ||\r\n            error.message.includes('timeout') ||\r\n            error.message.includes('500') ||\r\n            error.message.includes('502') ||\r\n            error.message.includes('503'))) {\r\n \r\n-        // è®°å½•æœåŠ¡å™¨æ•…éšœ\r\n-        if (selectedServer) {\r\n-          await loadBalancer.recordFailure(selectedServer, 'api_call_failed')\r\n-          console.warn(`âš ï¸ å·²è®°å½•æœåŠ¡å™¨æ•…éšœ: ${selectedServer}`)\r\n+        // è·å–å½“å‰å¤±è´¥çš„æœåŠ¡å™¨URL\r\n+        const currentServer = await getApiBaseUrl()\r\n+        if (currentServer) {\r\n+          excludeUrls.push(currentServer)\r\n+          console.warn(`âš ï¸ æœåŠ¡å™¨ ${currentServer} è¯·æ±‚å¤±è´¥ï¼Œå°†åœ¨é‡è¯•æ—¶æ’é™¤`)\r\n         }\r\n \r\n         // ç­‰å¾…ä¸€æ®µæ—¶é—´å†é‡è¯•\r\n         await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)))\r\n-\r\n-        // é‡æ–°é€‰æ‹©æœåŠ¡å™¨è¿›è¡Œä¸‹ä¸€æ¬¡å°è¯•\r\n-        selectedServer = await getApiBaseUrl()\r\n-        console.log(`ğŸ”„ é‡è¯•ä½¿ç”¨æ–°æœåŠ¡å™¨: ${selectedServer}`)\r\n       }\r\n     }\r\n   }\r\n \r\n@@ -392,29 +381,33 @@\n }\r\n \r\n // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n async function submitWorkflow(workflowPrompt) {\r\n-  return await callWithRetry(async (serverUrl) => {\r\n-    // ç¡®ä¿ WebSocket è¿æ¥åˆ°ç›¸åŒçš„æœåŠ¡å™¨\r\n+  let selectedServer = null\r\n+  try {\r\n+    // ç¡®ä¿ WebSocket è¿æ¥\r\n     await initializeWebSocket()\r\n \r\n     const config = getComfyUIConfig()\r\n-    console.log(`ğŸ”„ æäº¤å·¥ä½œæµåˆ°æœåŠ¡å™¨: ${serverUrl}`)\r\n+    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n+    selectedServer = apiBaseUrl // è®°å½•é€‰æ‹©çš„æœåŠ¡å™¨\r\n \r\n     // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n     const requestBody = {\r\n       client_id: config.CLIENT_ID,\r\n       prompt: workflowPrompt\r\n     }\r\n \r\n     // ç¬¬äºŒæ­¥APIè°ƒç”¨ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n-    const promptUrl = `${serverUrl}/prompt`\r\n+    const promptUrl = `${apiBaseUrl}/prompt`\r\n \r\n     const response = await fetch(promptUrl, {\r\n       method: 'POST',\r\n       headers: {\r\n         'Content-Type': 'application/json',\r\n-        'Accept': 'application/json'\r\n+        'Accept': '*/*',\r\n+        'comfy-user': config.CLIENT_ID,\r\n+        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'\r\n       },\r\n       body: JSON.stringify(requestBody),\r\n       mode: 'cors',\r\n       credentials: 'omit'\r\n@@ -431,9 +424,8 @@\n     if (!result.prompt_id) {\r\n       throw new Error('å·¥ä½œæµå“åº”ä¸­ç¼ºå°‘prompt_id')\r\n     }\r\n \r\n-    console.log(`âœ… å·¥ä½œæµæäº¤æˆåŠŸï¼Œä»»åŠ¡ID: ${result.prompt_id}`)\r\n     return result.prompt_id // è¿”å›ä»»åŠ¡ID\r\n \r\n   } catch (error) {\r\n     console.error('âŒ å·¥ä½œæµæäº¤å¤±è´¥:', error)\r\n@@ -455,31 +447,46 @@\n }\r\n \r\n // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n async function checkTaskStatus(promptId) {\r\n-  return await callWithRetry(async (serverUrl) => {\r\n-    console.log(`ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€: ${serverUrl}/history/${promptId}`)\r\n-    const response = await fetch(`${serverUrl}/history/${promptId}`, {\r\n-      method: 'GET',\r\n-      headers: {\r\n-        'Accept': 'application/json'\r\n-      },\r\n-      mode: 'cors',\r\n-      credentials: 'omit'\r\n-    })\r\n+  try {\r\n+    const config = getComfyUIConfig()\r\n+    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n+    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`)\r\n+    const response = await fetch(`${apiBaseUrl}/history/${promptId}`)\r\n \r\n     if (!response.ok) {\r\n       throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText}`)\r\n     }\r\n \r\n     const result = await response.json()\r\n     return result[promptId] || null\r\n-  })\r\n+\r\n+  } catch (error) {\r\n+    console.error('çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', error)\r\n+\r\n+    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œè®°å½•å¤±è´¥\r\n+    if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('timeout')) {\r\n+      const currentServer = await getApiBaseUrl()\r\n+\r\n+      // ç¡®å®šé”™è¯¯ç±»å‹\r\n+      let errorType = 'status_check_error'\r\n+      if (error.message.includes('timeout')) errorType = 'timeout'\r\n+      else if (error.message.includes('network')) errorType = 'network'\r\n+      else if (error.message.includes('fetch')) errorType = 'connection'\r\n+\r\n+      await loadBalancer.recordFailure(currentServer, errorType)\r\n+    }\r\n+\r\n+    throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${error.message}`)\r\n+  }\r\n }\r\n \r\n // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n async function getGeneratedImage(taskResult) {\r\n-  return await callWithRetry(async (serverUrl) => {\r\n+  try {\r\n+    const config = getComfyUIConfig()\r\n+    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n \r\n     // ä»ä»»åŠ¡ç»“æœä¸­æ‰¾åˆ°è¾“å‡ºå›¾ç‰‡\r\n     const outputs = taskResult.outputs\r\n     let imageInfo = null\r\n@@ -529,26 +536,18 @@\n       filename: imageInfo.filename,\r\n       type: imageInfo.type,\r\n       subfolder: imageInfo.subfolder || ''\r\n     })\r\n-    const imageUrl = `${serverUrl}/view?${params.toString()}`\r\n+    const imageUrl = `${apiBaseUrl}/view?${params.toString()}`\r\n \r\n     console.log('ğŸŒ è·å–å›¾ç‰‡URL:', imageUrl)\r\n \r\n     // ä¿å­˜ ComfyUI åŸå§‹URLåˆ°å…¨å±€å˜é‡ï¼Œä¾›ç§¯åˆ†æ‰£é™¤æ—¶ä½¿ç”¨\r\n     window.lastComfyUIImageUrl = imageUrl\r\n     console.log('ğŸ’¾ ä¿å­˜ ComfyUI å›¾ç‰‡URL ä¾›ç§¯åˆ†è®°å½•ä½¿ç”¨:', imageUrl)\r\n \r\n     // è·å–å›¾ç‰‡æ•°æ®å¹¶è½¬æ¢ä¸ºbase64\r\n-    const imageResponse = await fetch(imageUrl, {\r\n-      method: 'GET',\r\n-      headers: {\r\n-        'Accept': 'image/*'\r\n-      },\r\n-      mode: 'cors',\r\n-      credentials: 'omit'\r\n-    })\r\n-\r\n+    const imageResponse = await fetch(imageUrl)\r\n     if (!imageResponse.ok) {\r\n       throw new Error(`å›¾ç‰‡è·å–å¤±è´¥: ${imageResponse.status}`)\r\n     }\r\n \r\n@@ -558,9 +557,13 @@\n       reader.onload = () => resolve(reader.result)\r\n       reader.onerror = reject\r\n       reader.readAsDataURL(imageBlob)\r\n     })\r\n-  })\r\n+\r\n+  } catch (error) {\r\n+    console.error('å›¾ç‰‡è·å–å¤±è´¥:', error)\r\n+    throw new Error(`å›¾ç‰‡è·å–å¤±è´¥: ${error.message}`)\r\n+  }\r\n }\r\n \r\n // WebSocket è¿æ¥ç®¡ç†\r\n let wsConnection = null\r\n"
                },
                {
                    "date": 1752553421467,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -186,19 +186,16 @@\n function getCurrentConfig(forceRefresh = false) {\r\n   return getComfyUIConfig(forceRefresh)\r\n }\r\n \r\n-// è·å–APIåŸºç¡€URL - ç®€åŒ–ç‰ˆæœ¬\r\n-async function getApiBaseUrl() {\r\n+// è·å–APIåŸºç¡€URL - ä¼˜å…ˆä½¿ç”¨è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœ€ä¼˜æœåŠ¡å™¨\r\n+async function getApiBaseUrl(excludeUrls = []) {\r\n   try {\r\n-    // å¦‚æœWebSocketå·²è¿æ¥ï¼Œä¼˜å…ˆä½¿ç”¨WebSocketè¿æ¥çš„æœåŠ¡å™¨ä¿æŒä¸€è‡´æ€§\r\n-    if (currentWebSocketServer && isWsConnected) {\r\n-      console.log('ğŸ”— ä½¿ç”¨WebSocketè¿æ¥çš„æœåŠ¡å™¨ä¿æŒä¸€è‡´æ€§:', currentWebSocketServer)\r\n-      return currentWebSocketServer\r\n-    }\r\n+    // æš‚æ—¶å¿½ç•¥WebSocketæœºåˆ¶ï¼Œç¡®ä¿æ¯æ¬¡éƒ½ä½¿ç”¨è´Ÿè½½å‡è¡¡é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\r\n+    console.log('ğŸ¯ ä½¿ç”¨è´Ÿè½½å‡è¡¡é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨...')\r\n \r\n-    // ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\r\n-    const optimalServer = await loadBalancer.getOptimalServer()\r\n+    // ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨ï¼Œæ’é™¤å¤±è´¥çš„æœåŠ¡å™¨\r\n+    const optimalServer = await loadBalancer.getOptimalServer(excludeUrls)\r\n     console.log('ğŸ¯ è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœåŠ¡å™¨:', optimalServer)\r\n \r\n     // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n     let baseUrl = optimalServer\r\n"
                },
                {
                    "date": 1752553441176,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -219,15 +219,16 @@\n     return baseUrl\r\n   }\r\n }\r\n \r\n-// å¸¦é‡è¯•çš„APIè°ƒç”¨åŒ…è£…å™¨\r\n+// å¸¦é‡è¯•çš„APIè°ƒç”¨åŒ…è£…å™¨ - ä¿®å¤è´Ÿè½½å‡è¡¡é€»è¾‘\r\n async function callWithRetry(apiCall, maxRetries = 2, excludeUrls = []) {\r\n   let lastError = null\r\n \r\n   for (let attempt = 0; attempt <= maxRetries; attempt++) {\r\n     try {\r\n-      const result = await apiCall()\r\n+      // æ¯æ¬¡é‡è¯•éƒ½é‡æ–°è·å–æœ€ä¼˜æœåŠ¡å™¨ï¼Œæ’é™¤å¤±è´¥çš„æœåŠ¡å™¨\r\n+      const result = await apiCall(excludeUrls)\r\n       return result\r\n     } catch (error) {\r\n       lastError = error\r\n \r\n@@ -239,11 +240,11 @@\n            error.message.includes('500') ||\r\n            error.message.includes('502') ||\r\n            error.message.includes('503'))) {\r\n \r\n-        // è·å–å½“å‰å¤±è´¥çš„æœåŠ¡å™¨URL\r\n-        const currentServer = await getApiBaseUrl()\r\n-        if (currentServer) {\r\n+        // è·å–å½“å‰å¤±è´¥çš„æœåŠ¡å™¨URLå¹¶åŠ å…¥æ’é™¤åˆ—è¡¨\r\n+        const currentServer = await getApiBaseUrl(excludeUrls)\r\n+        if (currentServer && !excludeUrls.includes(currentServer)) {\r\n           excludeUrls.push(currentServer)\r\n           console.warn(`âš ï¸ æœåŠ¡å™¨ ${currentServer} è¯·æ±‚å¤±è´¥ï¼Œå°†åœ¨é‡è¯•æ—¶æ’é™¤`)\r\n         }\r\n \r\n"
                },
                {
                    "date": 1752553496077,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,11 +269,12 @@\n }\r\n \r\n // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ Base64å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨å¹¶è·å–æ–‡ä»¶å\r\n async function uploadImageToComfyUI(base64Image) {\r\n-  try {\r\n+  // ä½¿ç”¨é‡è¯•æœºåˆ¶ä¸Šä¼ å›¾ç‰‡\r\n+  return await callWithRetry(async (excludeUrls = []) => {\r\n     const config = getComfyUIConfig()\r\n-    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n+    const apiBaseUrl = await getApiBaseUrl(excludeUrls)\r\n     console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n     console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n \r\n     // éªŒè¯base64æ ¼å¼\r\n@@ -333,20 +334,9 @@\n       throw new Error('ä¸Šä¼ å“åº”ä¸­ç¼ºå°‘æ–‡ä»¶å')\r\n     }\r\n \r\n     return result.name\r\n-\r\n-  } catch (error) {\r\n-    console.error('âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error)\r\n-\r\n-    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œè®°å½•å¤±è´¥ä¿¡æ¯\r\n-    if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('timeout')) {\r\n-      const currentServer = await getApiBaseUrl()\r\n-      console.warn(`âš ï¸ å›¾ç‰‡ä¸Šä¼ åˆ°æœåŠ¡å™¨ ${currentServer} å¤±è´¥:`, error.message)\r\n-    }\r\n-\r\n-    throw new Error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`)\r\n-  }\r\n+  })\r\n }\r\n \r\n // åˆ›å»ºå·¥ä½œæµæç¤ºè¯ï¼Œå°†ç”¨æˆ·å›¾ç‰‡å…³è”åˆ°èŠ‚ç‚¹49\r\n function createUndressWorkflowPrompt(uploadedImageName) {\r\n"
                },
                {
                    "date": 1752553532964,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -369,16 +369,17 @@\n }\r\n \r\n // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n async function submitWorkflow(workflowPrompt) {\r\n-  let selectedServer = null\r\n-  try {\r\n+  // ä½¿ç”¨é‡è¯•æœºåˆ¶æäº¤å·¥ä½œæµ\r\n+  return await callWithRetry(async (excludeUrls = []) => {\r\n     // ç¡®ä¿ WebSocket è¿æ¥\r\n     await initializeWebSocket()\r\n \r\n     const config = getComfyUIConfig()\r\n-    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n-    selectedServer = apiBaseUrl // è®°å½•é€‰æ‹©çš„æœåŠ¡å™¨\r\n+    const apiBaseUrl = await getApiBaseUrl(excludeUrls)\r\n+    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n+    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n \r\n     // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n     const requestBody = {\r\n       client_id: config.CLIENT_ID,\r\n@@ -412,27 +413,11 @@\n     if (!result.prompt_id) {\r\n       throw new Error('å·¥ä½œæµå“åº”ä¸­ç¼ºå°‘prompt_id')\r\n     }\r\n \r\n+    console.log('âœ… å·¥ä½œæµæäº¤æˆåŠŸï¼Œä»»åŠ¡ID:', result.prompt_id)\r\n     return result.prompt_id // è¿”å›ä»»åŠ¡ID\r\n-\r\n-  } catch (error) {\r\n-    console.error('âŒ å·¥ä½œæµæäº¤å¤±è´¥:', error)\r\n-\r\n-    // è®°å½•æœåŠ¡å™¨å¤±è´¥\r\n-    if (selectedServer) {\r\n-      // ç¡®å®šé”™è¯¯ç±»å‹\r\n-      let errorType = 'workflow_error'\r\n-      if (error.message.includes('timeout')) errorType = 'timeout'\r\n-      else if (error.message.includes('network')) errorType = 'network'\r\n-      else if (error.message.includes('fetch')) errorType = 'connection'\r\n-      else if (error.message.includes('500') || error.message.includes('502') || error.message.includes('503')) errorType = 'server_error'\r\n-\r\n-      await loadBalancer.recordFailure(selectedServer, errorType)\r\n-    }\r\n-\r\n-    throw new Error(`å·¥ä½œæµæäº¤å¤±è´¥: ${error.message}`)\r\n-  }\r\n+  })\r\n }\r\n \r\n // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n async function checkTaskStatus(promptId) {\r\n"
                },
                {
                    "date": 1752555013870,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -186,16 +186,15 @@\n function getCurrentConfig(forceRefresh = false) {\r\n   return getComfyUIConfig(forceRefresh)\r\n }\r\n \r\n-// è·å–APIåŸºç¡€URL - ä¼˜å…ˆä½¿ç”¨è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœ€ä¼˜æœåŠ¡å™¨\r\n-async function getApiBaseUrl(excludeUrls = []) {\r\n+// è·å–APIåŸºç¡€URL - ä½¿ç”¨è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœ€ä¼˜æœåŠ¡å™¨\r\n+async function getApiBaseUrl() {\r\n   try {\r\n-    // æš‚æ—¶å¿½ç•¥WebSocketæœºåˆ¶ï¼Œç¡®ä¿æ¯æ¬¡éƒ½ä½¿ç”¨è´Ÿè½½å‡è¡¡é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\r\n     console.log('ğŸ¯ ä½¿ç”¨è´Ÿè½½å‡è¡¡é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨...')\r\n \r\n-    // ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨ï¼Œæ’é™¤å¤±è´¥çš„æœåŠ¡å™¨\r\n-    const optimalServer = await loadBalancer.getOptimalServer(excludeUrls)\r\n+    // ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\r\n+    const optimalServer = await loadBalancer.getOptimalServer()\r\n     console.log('ğŸ¯ è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœåŠ¡å™¨:', optimalServer)\r\n \r\n     // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n     let baseUrl = optimalServer\r\n"
                },
                {
                    "date": 1752555040583,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -218,45 +218,10 @@\n     return baseUrl\r\n   }\r\n }\r\n \r\n-// å¸¦é‡è¯•çš„APIè°ƒç”¨åŒ…è£…å™¨ - ä¿®å¤è´Ÿè½½å‡è¡¡é€»è¾‘\r\n-async function callWithRetry(apiCall, maxRetries = 2, excludeUrls = []) {\r\n-  let lastError = null\r\n+// åˆ é™¤é‡è¯•æœºåˆ¶ï¼Œç›´æ¥ä½¿ç”¨æœ€ä¼˜æœåŠ¡å™¨\r\n \r\n-  for (let attempt = 0; attempt <= maxRetries; attempt++) {\r\n-    try {\r\n-      // æ¯æ¬¡é‡è¯•éƒ½é‡æ–°è·å–æœ€ä¼˜æœåŠ¡å™¨ï¼Œæ’é™¤å¤±è´¥çš„æœåŠ¡å™¨\r\n-      const result = await apiCall(excludeUrls)\r\n-      return result\r\n-    } catch (error) {\r\n-      lastError = error\r\n-\r\n-      // å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œä¸”æ˜¯ç½‘ç»œç›¸å…³é”™è¯¯ï¼Œå°è¯•ä¸‹ä¸€ä¸ªæœåŠ¡å™¨\r\n-      if (attempt < maxRetries &&\r\n-          (error.message.includes('fetch') ||\r\n-           error.message.includes('network') ||\r\n-           error.message.includes('timeout') ||\r\n-           error.message.includes('500') ||\r\n-           error.message.includes('502') ||\r\n-           error.message.includes('503'))) {\r\n-\r\n-        // è·å–å½“å‰å¤±è´¥çš„æœåŠ¡å™¨URLå¹¶åŠ å…¥æ’é™¤åˆ—è¡¨\r\n-        const currentServer = await getApiBaseUrl(excludeUrls)\r\n-        if (currentServer && !excludeUrls.includes(currentServer)) {\r\n-          excludeUrls.push(currentServer)\r\n-          console.warn(`âš ï¸ æœåŠ¡å™¨ ${currentServer} è¯·æ±‚å¤±è´¥ï¼Œå°†åœ¨é‡è¯•æ—¶æ’é™¤`)\r\n-        }\r\n-\r\n-        // ç­‰å¾…ä¸€æ®µæ—¶é—´å†é‡è¯•\r\n-        await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)))\r\n-      }\r\n-    }\r\n-  }\r\n-\r\n-  throw lastError\r\n-}\r\n-\r\n // é‡ç½®ä¸ºé»˜è®¤é…ç½®\r\n function resetToDefaultConfig() {\r\n   localStorage.removeItem('comfyui_config')\r\n   return { ...DEFAULT_CONFIG }\r\n"
                },
                {
                    "date": 1752555075826,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -233,74 +233,71 @@\n }\r\n \r\n // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ Base64å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨å¹¶è·å–æ–‡ä»¶å\r\n async function uploadImageToComfyUI(base64Image) {\r\n-  // ä½¿ç”¨é‡è¯•æœºåˆ¶ä¸Šä¼ å›¾ç‰‡\r\n-  return await callWithRetry(async (excludeUrls = []) => {\r\n-    const config = getComfyUIConfig()\r\n-    const apiBaseUrl = await getApiBaseUrl(excludeUrls)\r\n-    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n-    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n+  const config = getComfyUIConfig()\r\n+  const apiBaseUrl = await getApiBaseUrl()\r\n+  console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n+  console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n \r\n-    // éªŒè¯base64æ ¼å¼\r\n-    if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n-      throw new Error('æ— æ•ˆçš„base64å›¾ç‰‡æ ¼å¼')\r\n-    }\r\n+  // éªŒè¯base64æ ¼å¼\r\n+  if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n+    throw new Error('æ— æ•ˆçš„base64å›¾ç‰‡æ ¼å¼')\r\n+  }\r\n \r\n-    // ä»base64æ•°æ®ä¸­æå–å›¾ç‰‡ä¿¡æ¯\r\n-    const base64Data = base64Image.split(',')[1]\r\n-    const mimeType = base64Image.split(',')[0].split(':')[1].split(';')[0]\r\n-    const extension = mimeType.split('/')[1] || 'jpg'\r\n+  // ä»base64æ•°æ®ä¸­æå–å›¾ç‰‡ä¿¡æ¯\r\n+  const base64Data = base64Image.split(',')[1]\r\n+  const mimeType = base64Image.split(',')[0].split(':')[1].split(';')[0]\r\n+  const extension = mimeType.split('/')[1] || 'jpg'\r\n \r\n-    // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å\r\n-    const filename = `upload_${Date.now()}_${Math.random().toString(36).substring(7)}.${extension}`\r\n+  // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å\r\n+  const filename = `upload_${Date.now()}_${Math.random().toString(36).substring(7)}.${extension}`\r\n \r\n-    // å°†base64è½¬æ¢ä¸ºBlob\r\n-    const byteCharacters = atob(base64Data)\r\n-    const byteNumbers = new Array(byteCharacters.length)\r\n-    for (let i = 0; i < byteCharacters.length; i++) {\r\n-      byteNumbers[i] = byteCharacters.charCodeAt(i)\r\n-    }\r\n-    const byteArray = new Uint8Array(byteNumbers)\r\n-    const blob = new Blob([byteArray], { type: mimeType })\r\n+  // å°†base64è½¬æ¢ä¸ºBlob\r\n+  const byteCharacters = atob(base64Data)\r\n+  const byteNumbers = new Array(byteCharacters.length)\r\n+  for (let i = 0; i < byteCharacters.length; i++) {\r\n+    byteNumbers[i] = byteCharacters.charCodeAt(i)\r\n+  }\r\n+  const byteArray = new Uint8Array(byteNumbers)\r\n+  const blob = new Blob([byteArray], { type: mimeType })\r\n \r\n-    console.log('ğŸ“¤ ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯:', {\r\n-      filename,\r\n-      type: mimeType,\r\n-      size: `${(blob.size / 1024).toFixed(2)} KB`\r\n-    })\r\n+  console.log('ğŸ“¤ ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯:', {\r\n+    filename,\r\n+    type: mimeType,\r\n+    size: `${(blob.size / 1024).toFixed(2)} KB`\r\n+  })\r\n \r\n-    // ç›´è¿ä¸Šä¼ å›¾ç‰‡\r\n-    const formData = new FormData()\r\n-    formData.append('image', blob, filename)\r\n-    formData.append('type', 'input')\r\n-    formData.append('subfolder', '')\r\n-    formData.append('overwrite', 'false')\r\n+  // ç›´è¿ä¸Šä¼ å›¾ç‰‡\r\n+  const formData = new FormData()\r\n+  formData.append('image', blob, filename)\r\n+  formData.append('type', 'input')\r\n+  formData.append('subfolder', '')\r\n+  formData.append('overwrite', 'false')\r\n \r\n-    console.log('ğŸ”„ å¼€å§‹ä¸Šä¼ å›¾ç‰‡...')\r\n+  console.log('ğŸ”„ å¼€å§‹ä¸Šä¼ å›¾ç‰‡...')\r\n \r\n-    const response = await fetch(`${apiBaseUrl}/upload/image`, {\r\n-      method: 'POST',\r\n-      body: formData\r\n-    })\r\n+  const response = await fetch(`${apiBaseUrl}/upload/image`, {\r\n+    method: 'POST',\r\n+    body: formData\r\n+  })\r\n \r\n-    console.log('ğŸ“¥ ä¸Šä¼ å“åº”çŠ¶æ€:', response.status, response.statusText)\r\n+  console.log('ğŸ“¥ ä¸Šä¼ å“åº”çŠ¶æ€:', response.status, response.statusText)\r\n \r\n-    if (!response.ok) {\r\n-      const errorText = await response.text().catch(() => response.statusText)\r\n-      throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status} ${response.statusText} - ${errorText}`)\r\n-    }\r\n+  if (!response.ok) {\r\n+    const errorText = await response.text().catch(() => response.statusText)\r\n+    throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status} ${response.statusText} - ${errorText}`)\r\n+  }\r\n \r\n-    const result = await response.json()\r\n-    console.log('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', result)\r\n+  const result = await response.json()\r\n+  console.log('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', result)\r\n \r\n-    // éªŒè¯è¿”å›ç»“æœ\r\n-    if (!result.name) {\r\n-      throw new Error('ä¸Šä¼ å“åº”ä¸­ç¼ºå°‘æ–‡ä»¶å')\r\n-    }\r\n+  // éªŒè¯è¿”å›ç»“æœ\r\n+  if (!result.name) {\r\n+    throw new Error('ä¸Šä¼ å“åº”ä¸­ç¼ºå°‘æ–‡ä»¶å')\r\n+  }\r\n \r\n-    return result.name\r\n-  })\r\n+  return result.name\r\n }\r\n \r\n // åˆ›å»ºå·¥ä½œæµæç¤ºè¯ï¼Œå°†ç”¨æˆ·å›¾ç‰‡å…³è”åˆ°èŠ‚ç‚¹49\r\n function createUndressWorkflowPrompt(uploadedImageName) {\r\n"
                },
                {
                    "date": 1752555109595,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -330,55 +330,52 @@\n }\r\n \r\n // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n async function submitWorkflow(workflowPrompt) {\r\n-  // ä½¿ç”¨é‡è¯•æœºåˆ¶æäº¤å·¥ä½œæµ\r\n-  return await callWithRetry(async (excludeUrls = []) => {\r\n-    // ç¡®ä¿ WebSocket è¿æ¥\r\n-    await initializeWebSocket()\r\n+  // ç¡®ä¿ WebSocket è¿æ¥\r\n+  await initializeWebSocket()\r\n \r\n-    const config = getComfyUIConfig()\r\n-    const apiBaseUrl = await getApiBaseUrl(excludeUrls)\r\n-    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n-    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n+  const config = getComfyUIConfig()\r\n+  const apiBaseUrl = await getApiBaseUrl()\r\n+  console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n+  console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n \r\n-    // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n-    const requestBody = {\r\n-      client_id: config.CLIENT_ID,\r\n-      prompt: workflowPrompt\r\n-    }\r\n+  // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n+  const requestBody = {\r\n+    client_id: config.CLIENT_ID,\r\n+    prompt: workflowPrompt\r\n+  }\r\n \r\n-    // ç¬¬äºŒæ­¥APIè°ƒç”¨ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n-    const promptUrl = `${apiBaseUrl}/prompt`\r\n+  // ç¬¬äºŒæ­¥APIè°ƒç”¨ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n+  const promptUrl = `${apiBaseUrl}/prompt`\r\n \r\n-    const response = await fetch(promptUrl, {\r\n-      method: 'POST',\r\n-      headers: {\r\n-        'Content-Type': 'application/json',\r\n-        'Accept': '*/*',\r\n-        'comfy-user': config.CLIENT_ID,\r\n-        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'\r\n-      },\r\n-      body: JSON.stringify(requestBody),\r\n-      mode: 'cors',\r\n-      credentials: 'omit'\r\n-    })\r\n+  const response = await fetch(promptUrl, {\r\n+    method: 'POST',\r\n+    headers: {\r\n+      'Content-Type': 'application/json',\r\n+      'Accept': '*/*',\r\n+      'comfy-user': config.CLIENT_ID,\r\n+      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'\r\n+    },\r\n+    body: JSON.stringify(requestBody),\r\n+    mode: 'cors',\r\n+    credentials: 'omit'\r\n+  })\r\n \r\n-    if (!response.ok) {\r\n-      const errorText = await response.text()\r\n-      throw new Error(`å·¥ä½œæµæäº¤å¤±è´¥: ${response.status} ${response.statusText} - ${errorText}`)\r\n-    }\r\n+  if (!response.ok) {\r\n+    const errorText = await response.text()\r\n+    throw new Error(`å·¥ä½œæµæäº¤å¤±è´¥: ${response.status} ${response.statusText} - ${errorText}`)\r\n+  }\r\n \r\n-    const result = await response.json()\r\n+  const result = await response.json()\r\n \r\n-    // éªŒè¯è¿”å›ç»“æœ\r\n-    if (!result.prompt_id) {\r\n-      throw new Error('å·¥ä½œæµå“åº”ä¸­ç¼ºå°‘prompt_id')\r\n-    }\r\n+  // éªŒè¯è¿”å›ç»“æœ\r\n+  if (!result.prompt_id) {\r\n+    throw new Error('å·¥ä½œæµå“åº”ä¸­ç¼ºå°‘prompt_id')\r\n+  }\r\n \r\n-    console.log('âœ… å·¥ä½œæµæäº¤æˆåŠŸï¼Œä»»åŠ¡ID:', result.prompt_id)\r\n-    return result.prompt_id // è¿”å›ä»»åŠ¡ID\r\n-  })\r\n+  console.log('âœ… å·¥ä½œæµæäº¤æˆåŠŸï¼Œä»»åŠ¡ID:', result.prompt_id)\r\n+  return result.prompt_id // è¿”å›ä»»åŠ¡ID\r\n }\r\n \r\n // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n async function checkTaskStatus(promptId) {\r\n"
                },
                {
                    "date": 1752555137347,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -547,20 +547,10 @@\n async function initializeWebSocket(forceNewConnection = false) {\r\n   try {\r\n     // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°è¿æ¥\r\n     if (!forceNewConnection && wsConnection && wsConnection.readyState === WebSocket.OPEN) {\r\n-      // æ£€æŸ¥å½“å‰è¿æ¥çš„æœåŠ¡å™¨æ˜¯å¦ä»ç„¶æ˜¯æœ€ä¼˜é€‰æ‹©\r\n-      const currentOptimalServer = await getApiBaseUrl()\r\n-      if (currentWebSocketServer === currentOptimalServer) {\r\n-        console.log('ğŸ¯ WebSocket å·²è¿æ¥åˆ°æœ€ä¼˜æœåŠ¡å™¨ï¼Œæ— éœ€é‡æ–°åˆå§‹åŒ–')\r\n-        return true\r\n-      } else {\r\n-        console.log(`ğŸ”„ æœ€ä¼˜æœåŠ¡å™¨å·²å˜æ›´ (${currentWebSocketServer} â†’ ${currentOptimalServer})ï¼Œé‡æ–°è¿æ¥WebSocket`)\r\n-        // å…³é—­å½“å‰è¿æ¥\r\n-        if (wsConnection) {\r\n-          wsConnection.close()\r\n-        }\r\n-      }\r\n+      console.log('ğŸ¯ WebSocket å·²è¿æ¥ï¼Œæ— éœ€é‡æ–°åˆå§‹åŒ–')\r\n+      return true\r\n     }\r\n \r\n     const config = getComfyUIConfig()\r\n \r\n"
                },
                {
                    "date": 1752555179855,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -380,9 +380,9 @@\n // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n async function checkTaskStatus(promptId) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n-    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n+    const apiBaseUrl = await getApiBaseUrl()\r\n     console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`)\r\n     const response = await fetch(`${apiBaseUrl}/history/${promptId}`)\r\n \r\n     if (!response.ok) {\r\n@@ -393,22 +393,8 @@\n     return result[promptId] || null\r\n \r\n   } catch (error) {\r\n     console.error('çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', error)\r\n-\r\n-    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œè®°å½•å¤±è´¥\r\n-    if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('timeout')) {\r\n-      const currentServer = await getApiBaseUrl()\r\n-\r\n-      // ç¡®å®šé”™è¯¯ç±»å‹\r\n-      let errorType = 'status_check_error'\r\n-      if (error.message.includes('timeout')) errorType = 'timeout'\r\n-      else if (error.message.includes('network')) errorType = 'network'\r\n-      else if (error.message.includes('fetch')) errorType = 'connection'\r\n-\r\n-      await loadBalancer.recordFailure(currentServer, errorType)\r\n-    }\r\n-\r\n     throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${error.message}`)\r\n   }\r\n }\r\n \r\n"
                },
                {
                    "date": 1752555224500,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -401,9 +401,9 @@\n // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n async function getGeneratedImage(taskResult) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n-    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n+    const apiBaseUrl = await getApiBaseUrl()\r\n \r\n     // ä»ä»»åŠ¡ç»“æœä¸­æ‰¾åˆ°è¾“å‡ºå›¾ç‰‡\r\n     const outputs = taskResult.outputs\r\n     let imageInfo = null\r\n"
                },
                {
                    "date": 1752555240268,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -627,12 +627,9 @@\n         // åœæ­¢å¥åº·æ£€æŸ¥\r\n         stopWebSocketHealthCheck()\r\n \r\n         // æ¸…ç†WebSocketæœåŠ¡å™¨è®°å½•\r\n-        if (currentWebSocketServer) {\r\n-          console.log(`ğŸ”Œ WebSocketè¿æ¥å·²æ–­å¼€: ${currentWebSocketServer}`)\r\n-          currentWebSocketServer = null\r\n-        }\r\n+        currentWebSocketServer = null\r\n \r\n         // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n         showWebSocketStatusNotification('WebSocketè¿æ¥å·²æ–­å¼€', 'warning')\r\n \r\n"
                },
                {
                    "date": 1752555256475,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1234,11 +1234,9 @@\n     if (onProgress) onProgress('æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...', 5)\r\n \r\n     const serverStatus = await checkComfyUIServerStatus()\r\n     if (serverStatus.status === 'error') {\r\n-      console.warn('âš ï¸ æœåŠ¡å™¨çŠ¶æ€å¼‚å¸¸ï¼Œé‡æ–°è¯„ä¼°...')\r\n-      // å¼ºåˆ¶é‡æ–°è¯„ä¼°æœåŠ¡å™¨\r\n-      await getApiBaseUrl(true)\r\n+      throw new Error(`ComfyUIæœåŠ¡å™¨ä¸å¯ç”¨: ${serverStatus.error}`)\r\n     }\r\n \r\n     // æ£€æŸ¥ç§¯åˆ†ï¼ˆä¼˜å…ˆä½¿ç”¨ç­‰çº§å¡ç³»ç»Ÿï¼‰\r\n     if (onProgress) onProgress('æ­£åœ¨æ£€æŸ¥ç§¯åˆ†...', 10)\r\n"
                },
                {
                    "date": 1752555283173,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1338,9 +1338,9 @@\n \r\n // æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€ - ä½¿ç”¨ç»Ÿä¸€çš„å®˜æ–¹ç«¯ç‚¹é…ç½®\r\n async function checkComfyUIServerStatus() {\r\n   try {\r\n-    const apiBaseUrl = await getApiBaseUrl() // ç°åœ¨æ˜¯å¼‚æ­¥çš„\r\n+    const apiBaseUrl = await getApiBaseUrl()\r\n     const testEndpoints = comfyUIConfig.getHealthCheckEndpoints()\r\n \r\n     console.log('ğŸ” æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€:', apiBaseUrl)\r\n     console.log('ğŸ“‹ ä½¿ç”¨ç«¯ç‚¹åˆ—è¡¨:', testEndpoints)\r\n"
                },
                {
                    "date": 1752556173343,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -275,9 +275,9 @@\n   formData.append('overwrite', 'false')\r\n \r\n   console.log('ğŸ”„ å¼€å§‹ä¸Šä¼ å›¾ç‰‡...')\r\n \r\n-  const response = await fetch(`${apiBaseUrl}/upload/image`, {\r\n+  const response = await fetch(`${apiBaseUrl}/api/upload/image`, {\r\n     method: 'POST',\r\n     body: formData\r\n   })\r\n \r\n"
                },
                {
                    "date": 1752556188792,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -336,18 +336,18 @@\n \r\n   const config = getComfyUIConfig()\r\n   const apiBaseUrl = await getApiBaseUrl()\r\n   console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n-  console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n+  console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/api/prompt`)\r\n \r\n   // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n   const requestBody = {\r\n     client_id: config.CLIENT_ID,\r\n     prompt: workflowPrompt\r\n   }\r\n \r\n   // ç¬¬äºŒæ­¥APIè°ƒç”¨ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n-  const promptUrl = `${apiBaseUrl}/prompt`\r\n+  const promptUrl = `${apiBaseUrl}/api/prompt`\r\n \r\n   const response = await fetch(promptUrl, {\r\n     method: 'POST',\r\n     headers: {\r\n"
                },
                {
                    "date": 1752556203168,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -381,10 +381,10 @@\n async function checkTaskStatus(promptId) {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n     const apiBaseUrl = await getApiBaseUrl()\r\n-    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`)\r\n-    const response = await fetch(`${apiBaseUrl}/history/${promptId}`)\r\n+    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/api/history/${promptId}`)\r\n+    const response = await fetch(`${apiBaseUrl}/api/history/${promptId}`)\r\n \r\n     if (!response.ok) {\r\n       throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText}`)\r\n     }\r\n"
                },
                {
                    "date": 1752556218053,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -453,9 +453,9 @@\n       filename: imageInfo.filename,\r\n       type: imageInfo.type,\r\n       subfolder: imageInfo.subfolder || ''\r\n     })\r\n-    const imageUrl = `${apiBaseUrl}/view?${params.toString()}`\r\n+    const imageUrl = `${apiBaseUrl}/api/view?${params.toString()}`\r\n \r\n     console.log('ğŸŒ è·å–å›¾ç‰‡URL:', imageUrl)\r\n \r\n     // ä¿å­˜ ComfyUI åŸå§‹URLåˆ°å…¨å±€å˜é‡ï¼Œä¾›ç§¯åˆ†æ‰£é™¤æ—¶ä½¿ç”¨\r\n"
                },
                {
                    "date": 1752556233457,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1306,9 +1306,9 @@\n         subfolder: ''\r\n       })\r\n       const config = getComfyUIConfig()\r\n       const apiBaseUrl = await getApiBaseUrl()\r\n-      originalImage = `${apiBaseUrl}/view?${params.toString()}`\r\n+      originalImage = `${apiBaseUrl}/api/view?${params.toString()}`\r\n     } catch (error) {\r\n       console.warn('âš ï¸ è·å–åŸå›¾å¤±è´¥:', error)\r\n     }\r\n \r\n"
                },
                {
                    "date": 1752556763382,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -350,16 +350,11 @@\n \r\n   const response = await fetch(promptUrl, {\r\n     method: 'POST',\r\n     headers: {\r\n-      'Content-Type': 'application/json',\r\n-      'Accept': '*/*',\r\n-      'comfy-user': config.CLIENT_ID,\r\n-      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'\r\n+      'Content-Type': 'application/json'\r\n     },\r\n-    body: JSON.stringify(requestBody),\r\n-    mode: 'cors',\r\n-    credentials: 'omit'\r\n+    body: JSON.stringify(requestBody)\r\n   })\r\n \r\n   if (!response.ok) {\r\n     const errorText = await response.text()\r\n"
                },
                {
                    "date": 1752557291305,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -556,9 +556,8 @@\n       for (const endpoint of testEndpoints) {\r\n         try {\r\n           const testResponse = await fetch(`${baseUrl}${endpoint}`, {\r\n             method: 'GET',\r\n-            headers: comfyUIConfig.HEALTH_CHECK.HEADERS,\r\n             signal: AbortSignal.timeout(comfyUIConfig.HEALTH_CHECK.TIMEOUT / 2) // ä½¿ç”¨ä¸€åŠè¶…æ—¶æ—¶é—´\r\n           })\r\n \r\n           if (testResponse.ok) {\r\n"
                },
                {
                    "date": 1752557305272,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1342,9 +1342,8 @@\n     for (const endpoint of testEndpoints) {\r\n       try {\r\n         const response = await fetch(`${apiBaseUrl}${endpoint}`, {\r\n           method: 'GET',\r\n-          headers: comfyUIConfig.HEALTH_CHECK.HEADERS,\r\n           signal: AbortSignal.timeout(comfyUIConfig.HEALTH_CHECK.TIMEOUT)\r\n         })\r\n \r\n         if (response.ok) {\r\n"
                },
                {
                    "date": 1752561207986,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -524,9 +524,9 @@\n \r\n \r\n \r\n // åˆå§‹åŒ– WebSocket è¿æ¥\r\n-async function initializeWebSocket(forceNewConnection = false) {\r\n+async function initializeWebSocket(forceNewConnection = false, userId = 'anonymous') {\r\n   try {\r\n     // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°è¿æ¥\r\n     if (!forceNewConnection && wsConnection && wsConnection.readyState === WebSocket.OPEN) {\r\n       console.log('ğŸ¯ WebSocket å·²è¿æ¥ï¼Œæ— éœ€é‡æ–°åˆå§‹åŒ–')\r\n@@ -534,13 +534,17 @@\n     }\r\n \r\n     const config = getComfyUIConfig()\r\n \r\n-    // è·å–æœåŠ¡å™¨URLç”¨äºWebSocketè¿æ¥\r\n-    const baseUrl = await getApiBaseUrl()\r\n+    // è·å–ç”¨æˆ·çš„æœ€ä¼˜æœåŠ¡å™¨ï¼ˆæ”¯æŒç”¨æˆ·çº§é”å®šï¼‰\r\n+    const baseUrl = await loadBalancer.getOptimalServer(userId)\r\n     currentWebSocketServer = baseUrl\r\n-    console.log(`ğŸ”Œ å‡†å¤‡è¿æ¥WebSocketæœåŠ¡å™¨: ${baseUrl}`)\r\n+    console.log(`ğŸ”Œ ä¸ºç”¨æˆ·${userId}å‡†å¤‡è¿æ¥WebSocketæœåŠ¡å™¨: ${baseUrl}`)\r\n \r\n+    // é”å®šæœåŠ¡å™¨ç»™å½“å‰ç”¨æˆ·ï¼ˆWebSocketè¿æ¥æœŸé—´ï¼‰\r\n+    loadBalancer.lockServerForUser(userId, baseUrl)\r\n+    console.log(`ğŸ”’ ä¸ºç”¨æˆ·${userId}é”å®šæœåŠ¡å™¨: ${baseUrl}`)\r\n+\r\n     // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„WebSocket URLæ ¼å¼\r\n     let wsUrl\r\n     if (baseUrl.startsWith('https://')) {\r\n       wsUrl = baseUrl.replace('https://', 'wss://') + '/ws?clientId=' + config.CLIENT_ID\r\n"
                },
                {
                    "date": 1752561232487,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -624,8 +624,12 @@\n \r\n         // åœæ­¢å¥åº·æ£€æŸ¥\r\n         stopWebSocketHealthCheck()\r\n \r\n+        // è§£é”ç”¨æˆ·çš„æœåŠ¡å™¨ï¼ˆWebSocketè¿æ¥ç»“æŸï¼‰\r\n+        loadBalancer.unlockServerForUser(userId)\r\n+        console.log(`ğŸ”“ WebSocketå…³é—­ï¼Œä¸ºç”¨æˆ·${userId}è§£é”æœåŠ¡å™¨`)\r\n+\r\n         // æ¸…ç†WebSocketæœåŠ¡å™¨è®°å½•\r\n         currentWebSocketServer = null\r\n \r\n         // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n"
                },
                {
                    "date": 1752561275486,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -186,27 +186,27 @@\n function getCurrentConfig(forceRefresh = false) {\r\n   return getComfyUIConfig(forceRefresh)\r\n }\r\n \r\n-// è·å–APIåŸºç¡€URL - ä½¿ç”¨è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœ€ä¼˜æœåŠ¡å™¨\r\n-async function getApiBaseUrl() {\r\n+// è·å–APIåŸºç¡€URL - ä½¿ç”¨è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœ€ä¼˜æœåŠ¡å™¨ï¼ˆæ”¯æŒç”¨æˆ·çº§é”å®šï¼‰\r\n+async function getApiBaseUrl(userId = 'anonymous') {\r\n   try {\r\n-    console.log('ğŸ¯ ä½¿ç”¨è´Ÿè½½å‡è¡¡é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨...')\r\n+    console.log(`ğŸ¯ ä¸ºç”¨æˆ·${userId}ä½¿ç”¨è´Ÿè½½å‡è¡¡é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨...`)\r\n \r\n-    // ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\r\n-    const optimalServer = await loadBalancer.getOptimalServer()\r\n-    console.log('ğŸ¯ è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœåŠ¡å™¨:', optimalServer)\r\n+    // ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨ï¼ˆæ”¯æŒç”¨æˆ·çº§é”å®šï¼‰\r\n+    const optimalServer = await loadBalancer.getOptimalServer(userId)\r\n+    console.log(`ğŸ¯ ä¸ºç”¨æˆ·${userId}è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœåŠ¡å™¨:`, optimalServer)\r\n \r\n     // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n     let baseUrl = optimalServer\r\n     if (baseUrl && baseUrl.endsWith('/')) {\r\n       baseUrl = baseUrl.slice(0, -1)\r\n     }\r\n \r\n-    console.log(`ğŸ”— æœ€ç»ˆAPIåŸºç¡€URL: ${baseUrl}`)\r\n+    console.log(`ğŸ”— ç”¨æˆ·${userId}çš„æœ€ç»ˆAPIåŸºç¡€URL: ${baseUrl}`)\r\n     return baseUrl\r\n   } catch (error) {\r\n-    console.error('âŒ è·å–APIåŸºç¡€URLå¤±è´¥:', error)\r\n+    console.error(`âŒ ä¸ºç”¨æˆ·${userId}è·å–APIåŸºç¡€URLå¤±è´¥:`, error)\r\n \r\n     // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨é…ç½®ä¸­çš„é»˜è®¤æœåŠ¡å™¨\r\n     const config = getComfyUIConfig(true)\r\n     let baseUrl = config.COMFYUI_SERVER_URL\r\n"
                },
                {
                    "date": 1752561295044,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -329,15 +329,15 @@\n   }\r\n }\r\n \r\n // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n-async function submitWorkflow(workflowPrompt) {\r\n-  // ç¡®ä¿ WebSocket è¿æ¥\r\n-  await initializeWebSocket()\r\n+async function submitWorkflow(workflowPrompt, userId = 'anonymous') {\r\n+  // ç¡®ä¿ WebSocket è¿æ¥ï¼ˆä¼ é€’ç”¨æˆ·IDï¼‰\r\n+  await initializeWebSocket(false, userId)\r\n \r\n   const config = getComfyUIConfig()\r\n-  const apiBaseUrl = await getApiBaseUrl()\r\n-  console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n+  const apiBaseUrl = await getApiBaseUrl(userId)\r\n+  console.log(`ğŸ”„ ç¬¬äºŒæ­¥ï¼šä¸ºç”¨æˆ·${userId}æäº¤å·¥ä½œæµåˆ°ComfyUI`)\r\n   console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/api/prompt`)\r\n \r\n   // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n   const requestBody = {\r\n"
                },
                {
                    "date": 1752561312390,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -232,12 +232,12 @@\n   return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)\r\n }\r\n \r\n // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ Base64å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨å¹¶è·å–æ–‡ä»¶å\r\n-async function uploadImageToComfyUI(base64Image) {\r\n+async function uploadImageToComfyUI(base64Image, userId = 'anonymous') {\r\n   const config = getComfyUIConfig()\r\n-  const apiBaseUrl = await getApiBaseUrl()\r\n-  console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n+  const apiBaseUrl = await getApiBaseUrl(userId)\r\n+  console.log(`ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸ºç”¨æˆ·${userId}ä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨`)\r\n   console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n \r\n   // éªŒè¯base64æ ¼å¼\r\n   if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n"
                },
                {
                    "date": 1752561328511,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -372,13 +372,13 @@\n   return result.prompt_id // è¿”å›ä»»åŠ¡ID\r\n }\r\n \r\n // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n-async function checkTaskStatus(promptId) {\r\n+async function checkTaskStatus(promptId, userId = 'anonymous') {\r\n   try {\r\n     const config = getComfyUIConfig()\r\n-    const apiBaseUrl = await getApiBaseUrl()\r\n-    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/api/history/${promptId}`)\r\n+    const apiBaseUrl = await getApiBaseUrl(userId)\r\n+    console.log(`ğŸ” ä¸ºç”¨æˆ·${userId}æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:`, `${apiBaseUrl}/api/history/${promptId}`)\r\n     const response = await fetch(`${apiBaseUrl}/api/history/${promptId}`)\r\n \r\n     if (!response.ok) {\r\n       throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText}`)\r\n"
                },
                {
                    "date": 1752561372134,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1227,11 +1227,11 @@\n   }\r\n }\r\n \r\n // ä¸»è¦çš„æ¢è¡£APIå‡½æ•° - ä¸¤æ­¥æµç¨‹\r\n-async function processUndressImage(base64Image, onProgress = null) {\r\n+async function processUndressImage(base64Image, onProgress = null, userId = 'anonymous') {\r\n   try {\r\n-    console.log('ğŸš€ å¼€å§‹å¤„ç†æ¢è¡£è¯·æ±‚')\r\n+    console.log(`ğŸš€ ä¸ºç”¨æˆ·${userId}å¼€å§‹å¤„ç†æ¢è¡£è¯·æ±‚`)\r\n \r\n     // é¢„æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€\r\n     if (onProgress) onProgress('æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...', 5)\r\n \r\n@@ -1254,23 +1254,23 @@\n     if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n       throw new Error('æ— æ•ˆçš„å›¾ç‰‡æ•°æ®æ ¼å¼')\r\n     }\r\n \r\n-    // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨\r\n+    // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨ï¼ˆä¼ é€’ç”¨æˆ·IDï¼‰\r\n     if (onProgress) onProgress('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡åˆ°ComfyUI...', 20)\r\n \r\n-    const uploadedImageName = await uploadImageToComfyUI(base64Image)\r\n+    const uploadedImageName = await uploadImageToComfyUI(base64Image, userId)\r\n     console.log('âœ… å›¾ç‰‡ä¸Šä¼ å®Œæˆ:', uploadedImageName)\r\n \r\n     // åˆ›å»ºå·¥ä½œæµæç¤ºè¯ï¼Œå°†ä¸Šä¼ çš„å›¾ç‰‡å…³è”åˆ°èŠ‚ç‚¹49\r\n     if (onProgress) onProgress('æ­£åœ¨é…ç½®å·¥ä½œæµ...', 30)\r\n \r\n     const workflowPrompt = createUndressWorkflowPrompt(uploadedImageName)\r\n \r\n-    // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµ\r\n+    // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµï¼ˆä¼ é€’ç”¨æˆ·IDï¼‰\r\n     if (onProgress) onProgress('æ­£åœ¨æäº¤å·¥ä½œæµåˆ°ComfyUI...', 40)\r\n \r\n-    const promptId = await submitWorkflow(workflowPrompt)\r\n+    const promptId = await submitWorkflow(workflowPrompt, userId)\r\n     console.log('âœ… å·¥ä½œæµæäº¤å®Œæˆï¼Œä»»åŠ¡ID:', promptId)\r\n \r\n     // ç­‰å¾…ä»»åŠ¡å®Œæˆ - ä¼ é€’å‰ç«¯è¿›åº¦å›è°ƒ\r\n     if (onProgress) onProgress('æ­£åœ¨ç­‰å¾…ComfyUIå¤„ç†...', 50)\r\n"
                },
                {
                    "date": 1752561432868,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1383,11 +1383,11 @@\n   }\r\n }\r\n \r\n // æ¢è„¸å¤„ç†å‡½æ•°\r\n-async function processFaceSwapImage({ facePhotos, targetImage, onProgress }) {\r\n+async function processFaceSwapImage({ facePhotos, targetImage, onProgress, userId = 'anonymous' }) {\r\n   try {\r\n-    console.log('ğŸš€ å¼€å§‹æ¢è„¸å¤„ç†')\r\n+    console.log(`ğŸš€ ä¸ºç”¨æˆ·${userId}å¼€å§‹æ¢è„¸å¤„ç†`)\r\n \r\n     // æ£€æŸ¥ç§¯åˆ†ï¼ˆä¼˜å…ˆä½¿ç”¨ç­‰çº§å¡ç³»ç»Ÿï¼‰\r\n     const pointsStatus = await levelCardPointsManager.getPointsStatus()\r\n     if (!pointsStatus.canGenerate) {\r\n@@ -1420,22 +1420,22 @@\n     }\r\n \r\n     if (onProgress) onProgress('æ­£åœ¨ä¸Šä¼ äººè„¸ç…§ç‰‡...', 20)\r\n \r\n-    // ä¸Šä¼ 4å¼ äººè„¸ç…§ç‰‡\r\n+    // ä¸Šä¼ 4å¼ äººè„¸ç…§ç‰‡ï¼ˆä¼ é€’ç”¨æˆ·IDï¼‰\r\n     const uploadedFacePhotos = []\r\n     for (let i = 0; i < facePhotos.length; i++) {\r\n       const photo = facePhotos[i]\r\n       if (onProgress) onProgress(`æ­£åœ¨ä¸Šä¼ äººè„¸ç…§ç‰‡ ${i + 1}/4...`, 20 + (i * 10))\r\n \r\n-      const uploadedFilename = await uploadImageToComfyUI(photo)\r\n+      const uploadedFilename = await uploadImageToComfyUI(photo, userId)\r\n       uploadedFacePhotos.push(uploadedFilename)\r\n     }\r\n \r\n     if (onProgress) onProgress('æ­£åœ¨ä¸Šä¼ ç›®æ ‡å›¾ç‰‡...', 60)\r\n \r\n-    // ä¸Šä¼ ç›®æ ‡å›¾ç‰‡\r\n-    const targetUploadedFilename = await uploadImageToComfyUI(targetImage)\r\n+    // ä¸Šä¼ ç›®æ ‡å›¾ç‰‡ï¼ˆä¼ é€’ç”¨æˆ·IDï¼‰\r\n+    const targetUploadedFilename = await uploadImageToComfyUI(targetImage, userId)\r\n \r\n     if (onProgress) onProgress('æ­£åœ¨å‡†å¤‡æ¢è„¸å·¥ä½œæµ...', 70)\r\n \r\n     // å‡†å¤‡å·¥ä½œæµ\r\n"
                },
                {
                    "date": 1752561457924,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1467,10 +1467,10 @@\n     }\r\n \r\n     if (onProgress) onProgress('æ­£åœ¨æäº¤æ¢è„¸ä»»åŠ¡...', 80)\r\n \r\n-    // æäº¤å·¥ä½œæµ\r\n-    const promptId = await submitWorkflow(workflow)\r\n+    // æäº¤å·¥ä½œæµï¼ˆä¼ é€’ç”¨æˆ·IDï¼‰\r\n+    const promptId = await submitWorkflow(workflow, userId)\r\n \r\n     if (onProgress) onProgress('æ­£åœ¨å¤„ç†æ¢è„¸...', 85)\r\n \r\n     // ç­‰å¾…ä»»åŠ¡å®Œæˆ - æ¢è„¸éœ€è¦æ›´é•¿æ—¶é—´ï¼Œè®¾ç½®10åˆ†é’Ÿè¶…æ—¶\r\n"
                },
                {
                    "date": 1752561491486,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -231,8 +231,23 @@\n function generateClientId() {\r\n   return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)\r\n }\r\n \r\n+// ç”Ÿæˆç”¨æˆ·ä¼šè¯ID\r\n+function generateUserId() {\r\n+  // å°è¯•ä»localStorageè·å–æŒä¹…åŒ–çš„ç”¨æˆ·ID\r\n+  let userId = localStorage.getItem('comfyui_user_id')\r\n+  if (!userId) {\r\n+    // ç”Ÿæˆæ–°çš„ç”¨æˆ·IDï¼šæ—¶é—´æˆ³ + éšæœºå­—ç¬¦ä¸²\r\n+    userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8)\r\n+    localStorage.setItem('comfyui_user_id', userId)\r\n+    console.log(`ğŸ†” ç”Ÿæˆæ–°ç”¨æˆ·ID: ${userId}`)\r\n+  } else {\r\n+    console.log(`ğŸ†” ä½¿ç”¨ç°æœ‰ç”¨æˆ·ID: ${userId}`)\r\n+  }\r\n+  return userId\r\n+}\r\n+\r\n // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ Base64å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨å¹¶è·å–æ–‡ä»¶å\r\n async function uploadImageToComfyUI(base64Image, userId = 'anonymous') {\r\n   const config = getComfyUIConfig()\r\n   const apiBaseUrl = await getApiBaseUrl(userId)\r\n"
                },
                {
                    "date": 1752561509067,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1242,10 +1242,14 @@\n   }\r\n }\r\n \r\n // ä¸»è¦çš„æ¢è¡£APIå‡½æ•° - ä¸¤æ­¥æµç¨‹\r\n-async function processUndressImage(base64Image, onProgress = null, userId = 'anonymous') {\r\n+async function processUndressImage(base64Image, onProgress = null, userId = null) {\r\n   try {\r\n+    // å¦‚æœæ²¡æœ‰æä¾›ç”¨æˆ·IDï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª\r\n+    if (!userId) {\r\n+      userId = generateUserId()\r\n+    }\r\n     console.log(`ğŸš€ ä¸ºç”¨æˆ·${userId}å¼€å§‹å¤„ç†æ¢è¡£è¯·æ±‚`)\r\n \r\n     // é¢„æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€\r\n     if (onProgress) onProgress('æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...', 5)\r\n"
                },
                {
                    "date": 1752561522800,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1402,10 +1402,14 @@\n   }\r\n }\r\n \r\n // æ¢è„¸å¤„ç†å‡½æ•°\r\n-async function processFaceSwapImage({ facePhotos, targetImage, onProgress, userId = 'anonymous' }) {\r\n+async function processFaceSwapImage({ facePhotos, targetImage, onProgress, userId = null }) {\r\n   try {\r\n+    // å¦‚æœæ²¡æœ‰æä¾›ç”¨æˆ·IDï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª\r\n+    if (!userId) {\r\n+      userId = generateUserId()\r\n+    }\r\n     console.log(`ğŸš€ ä¸ºç”¨æˆ·${userId}å¼€å§‹æ¢è„¸å¤„ç†`)\r\n \r\n     // æ£€æŸ¥ç§¯åˆ†ï¼ˆä¼˜å…ˆä½¿ç”¨ç­‰çº§å¡ç³»ç»Ÿï¼‰\r\n     const pointsStatus = await levelCardPointsManager.getPointsStatus()\r\n"
                },
                {
                    "date": 1752561541260,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1540,8 +1540,9 @@\n   getCurrentConfig,\r\n   updateComfyUIConfig,\r\n   resetToDefaultConfig,\r\n   generateClientId,\r\n+  generateUserId,\r\n   getApiBaseUrl,\r\n   addConfigChangeListener,\r\n   removeConfigChangeListener,\r\n   processUndressImage,\r\n"
                },
                {
                    "date": 1752561690063,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -248,9 +248,8 @@\n }\r\n \r\n // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ Base64å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨å¹¶è·å–æ–‡ä»¶å\r\n async function uploadImageToComfyUI(base64Image, userId = 'anonymous') {\r\n-  const config = getComfyUIConfig()\r\n   const apiBaseUrl = await getApiBaseUrl(userId)\r\n   console.log(`ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸ºç”¨æˆ·${userId}ä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨`)\r\n   console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n \r\n"
                },
                {
                    "date": 1752561709312,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -388,9 +388,8 @@\n \r\n // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n async function checkTaskStatus(promptId, userId = 'anonymous') {\r\n   try {\r\n-    const config = getComfyUIConfig()\r\n     const apiBaseUrl = await getApiBaseUrl(userId)\r\n     console.log(`ğŸ” ä¸ºç”¨æˆ·${userId}æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:`, `${apiBaseUrl}/api/history/${promptId}`)\r\n     const response = await fetch(`${apiBaseUrl}/api/history/${promptId}`)\r\n \r\n"
                },
                {
                    "date": 1752561725606,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -408,9 +408,8 @@\n \r\n // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n async function getGeneratedImage(taskResult) {\r\n   try {\r\n-    const config = getComfyUIConfig()\r\n     const apiBaseUrl = await getApiBaseUrl()\r\n \r\n     // ä»ä»»åŠ¡ç»“æœä¸­æ‰¾åˆ°è¾“å‡ºå›¾ç‰‡\r\n     const outputs = taskResult.outputs\r\n"
                },
                {
                    "date": 1752561741376,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -983,9 +983,9 @@\n   }\r\n }\r\n \r\n // å¤„ç†çŠ¶æ€æ¶ˆæ¯ - é˜Ÿåˆ—çŠ¶æ€å˜åŒ–\r\n-function handleStatusMessage(data) {\r\n+function handleStatusMessage() {\r\n   // é˜Ÿåˆ—çŠ¶æ€æ¶ˆæ¯ï¼Œé€šå¸¸ç”¨äºç›‘æ§é˜Ÿåˆ—çŠ¶æ€\r\n   // è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ é˜Ÿåˆ—çŠ¶æ€å¤„ç†é€»è¾‘\r\n }\r\n \r\n"
                },
                {
                    "date": 1752561756327,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1322,9 +1322,8 @@\n         filename: uploadedImageName,\r\n         type: 'input',\r\n         subfolder: ''\r\n       })\r\n-      const config = getComfyUIConfig()\r\n       const apiBaseUrl = await getApiBaseUrl()\r\n       originalImage = `${apiBaseUrl}/api/view?${params.toString()}`\r\n     } catch (error) {\r\n       console.warn('âš ï¸ è·å–åŸå›¾å¤±è´¥:', error)\r\n"
                },
                {
                    "date": 1752562850547,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -231,23 +231,10 @@\n function generateClientId() {\r\n   return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)\r\n }\r\n \r\n-// ç”Ÿæˆç”¨æˆ·ä¼šè¯ID\r\n-function generateUserId() {\r\n-  // å°è¯•ä»localStorageè·å–æŒä¹…åŒ–çš„ç”¨æˆ·ID\r\n-  let userId = localStorage.getItem('comfyui_user_id')\r\n-  if (!userId) {\r\n-    // ç”Ÿæˆæ–°çš„ç”¨æˆ·IDï¼šæ—¶é—´æˆ³ + éšæœºå­—ç¬¦ä¸²\r\n-    userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8)\r\n-    localStorage.setItem('comfyui_user_id', userId)\r\n-    console.log(`ğŸ†” ç”Ÿæˆæ–°ç”¨æˆ·ID: ${userId}`)\r\n-  } else {\r\n-    console.log(`ğŸ†” ä½¿ç”¨ç°æœ‰ç”¨æˆ·ID: ${userId}`)\r\n-  }\r\n-  return userId\r\n-}\r\n \r\n+\r\n // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ Base64å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨å¹¶è·å–æ–‡ä»¶å\r\n async function uploadImageToComfyUI(base64Image, userId = 'anonymous') {\r\n   const apiBaseUrl = await getApiBaseUrl(userId)\r\n   console.log(`ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸ºç”¨æˆ·${userId}ä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨`)\r\n"
                },
                {
                    "date": 1752562874964,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -523,9 +523,9 @@\n \r\n \r\n \r\n // åˆå§‹åŒ– WebSocket è¿æ¥\r\n-async function initializeWebSocket(forceNewConnection = false, userId = 'anonymous') {\r\n+async function initializeWebSocket(forceNewConnection = false) {\r\n   try {\r\n     // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°è¿æ¥\r\n     if (!forceNewConnection && wsConnection && wsConnection.readyState === WebSocket.OPEN) {\r\n       console.log('ğŸ¯ WebSocket å·²è¿æ¥ï¼Œæ— éœ€é‡æ–°åˆå§‹åŒ–')\r\n@@ -533,17 +533,13 @@\n     }\r\n \r\n     const config = getComfyUIConfig()\r\n \r\n-    // è·å–ç”¨æˆ·çš„æœ€ä¼˜æœåŠ¡å™¨ï¼ˆæ”¯æŒç”¨æˆ·çº§é”å®šï¼‰\r\n-    const baseUrl = await loadBalancer.getOptimalServer(userId)\r\n+    // è·å–æœ€ä¼˜æœåŠ¡å™¨\r\n+    const baseUrl = await loadBalancer.getOptimalServer()\r\n     currentWebSocketServer = baseUrl\r\n-    console.log(`ğŸ”Œ ä¸ºç”¨æˆ·${userId}å‡†å¤‡è¿æ¥WebSocketæœåŠ¡å™¨: ${baseUrl}`)\r\n+    console.log(`ğŸ”Œ å‡†å¤‡è¿æ¥WebSocketæœåŠ¡å™¨: ${baseUrl}`)\r\n \r\n-    // é”å®šæœåŠ¡å™¨ç»™å½“å‰ç”¨æˆ·ï¼ˆWebSocketè¿æ¥æœŸé—´ï¼‰\r\n-    loadBalancer.lockServerForUser(userId, baseUrl)\r\n-    console.log(`ğŸ”’ ä¸ºç”¨æˆ·${userId}é”å®šæœåŠ¡å™¨: ${baseUrl}`)\r\n-\r\n     // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„WebSocket URLæ ¼å¼\r\n     let wsUrl\r\n     if (baseUrl.startsWith('https://')) {\r\n       wsUrl = baseUrl.replace('https://', 'wss://') + '/ws?clientId=' + config.CLIENT_ID\r\n"
                },
                {
                    "date": 1752562911498,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -619,12 +619,8 @@\n \r\n         // åœæ­¢å¥åº·æ£€æŸ¥\r\n         stopWebSocketHealthCheck()\r\n \r\n-        // è§£é”ç”¨æˆ·çš„æœåŠ¡å™¨ï¼ˆWebSocketè¿æ¥ç»“æŸï¼‰\r\n-        loadBalancer.unlockServerForUser(userId)\r\n-        console.log(`ğŸ”“ WebSocketå…³é—­ï¼Œä¸ºç”¨æˆ·${userId}è§£é”æœåŠ¡å™¨`)\r\n-\r\n         // æ¸…ç†WebSocketæœåŠ¡å™¨è®°å½•\r\n         currentWebSocketServer = null\r\n \r\n         // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n"
                },
                {
                    "date": 1752563038031,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -186,27 +186,27 @@\n function getCurrentConfig(forceRefresh = false) {\r\n   return getComfyUIConfig(forceRefresh)\r\n }\r\n \r\n-// è·å–APIåŸºç¡€URL - ä½¿ç”¨è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœ€ä¼˜æœåŠ¡å™¨ï¼ˆæ”¯æŒç”¨æˆ·çº§é”å®šï¼‰\r\n-async function getApiBaseUrl(userId = 'anonymous') {\r\n+// è·å–APIåŸºç¡€URL - ä½¿ç”¨è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœ€ä¼˜æœåŠ¡å™¨\r\n+async function getApiBaseUrl() {\r\n   try {\r\n-    console.log(`ğŸ¯ ä¸ºç”¨æˆ·${userId}ä½¿ç”¨è´Ÿè½½å‡è¡¡é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨...`)\r\n+    console.log('ğŸ¯ ä½¿ç”¨è´Ÿè½½å‡è¡¡é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨...')\r\n \r\n-    // ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨ï¼ˆæ”¯æŒç”¨æˆ·çº§é”å®šï¼‰\r\n-    const optimalServer = await loadBalancer.getOptimalServer(userId)\r\n-    console.log(`ğŸ¯ ä¸ºç”¨æˆ·${userId}è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœåŠ¡å™¨:`, optimalServer)\r\n+    // ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\r\n+    const optimalServer = await loadBalancer.getOptimalServer()\r\n+    console.log('ğŸ¯ è´Ÿè½½å‡è¡¡é€‰æ‹©çš„æœåŠ¡å™¨:', optimalServer)\r\n \r\n     // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n     let baseUrl = optimalServer\r\n     if (baseUrl && baseUrl.endsWith('/')) {\r\n       baseUrl = baseUrl.slice(0, -1)\r\n     }\r\n \r\n-    console.log(`ğŸ”— ç”¨æˆ·${userId}çš„æœ€ç»ˆAPIåŸºç¡€URL: ${baseUrl}`)\r\n+    console.log('ğŸ”— æœ€ç»ˆAPIåŸºç¡€URL:', baseUrl)\r\n     return baseUrl\r\n   } catch (error) {\r\n-    console.error(`âŒ ä¸ºç”¨æˆ·${userId}è·å–APIåŸºç¡€URLå¤±è´¥:`, error)\r\n+    console.error('âŒ è·å–APIåŸºç¡€URLå¤±è´¥:', error)\r\n \r\n     // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨é…ç½®ä¸­çš„é»˜è®¤æœåŠ¡å™¨\r\n     const config = getComfyUIConfig(true)\r\n     let baseUrl = config.COMFYUI_SERVER_URL\r\n"
                },
                {
                    "date": 1752563107439,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1218,15 +1218,11 @@\n   }\r\n }\r\n \r\n // ä¸»è¦çš„æ¢è¡£APIå‡½æ•° - ä¸¤æ­¥æµç¨‹\r\n-async function processUndressImage(base64Image, onProgress = null, userId = null) {\r\n+async function processUndressImage(base64Image, onProgress = null) {\r\n   try {\r\n-    // å¦‚æœæ²¡æœ‰æä¾›ç”¨æˆ·IDï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª\r\n-    if (!userId) {\r\n-      userId = generateUserId()\r\n-    }\r\n-    console.log(`ğŸš€ ä¸ºç”¨æˆ·${userId}å¼€å§‹å¤„ç†æ¢è¡£è¯·æ±‚`)\r\n+    console.log('ğŸš€ å¼€å§‹å¤„ç†æ¢è¡£è¯·æ±‚')\r\n \r\n     // é¢„æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€\r\n     if (onProgress) onProgress('æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...', 5)\r\n \r\n"
                },
                {
                    "date": 1752563140180,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1373,15 +1373,11 @@\n   }\r\n }\r\n \r\n // æ¢è„¸å¤„ç†å‡½æ•°\r\n-async function processFaceSwapImage({ facePhotos, targetImage, onProgress, userId = null }) {\r\n+async function processFaceSwapImage({ facePhotos, targetImage, onProgress }) {\r\n   try {\r\n-    // å¦‚æœæ²¡æœ‰æä¾›ç”¨æˆ·IDï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª\r\n-    if (!userId) {\r\n-      userId = generateUserId()\r\n-    }\r\n-    console.log(`ğŸš€ ä¸ºç”¨æˆ·${userId}å¼€å§‹æ¢è„¸å¤„ç†`)\r\n+    console.log('ğŸš€ å¼€å§‹æ¢è„¸å¤„ç†')\r\n \r\n     // æ£€æŸ¥ç§¯åˆ†ï¼ˆä¼˜å…ˆä½¿ç”¨ç­‰çº§å¡ç³»ç»Ÿï¼‰\r\n     const pointsStatus = await levelCardPointsManager.getPointsStatus()\r\n     if (!pointsStatus.canGenerate) {\r\n"
                },
                {
                    "date": 1752563154332,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1507,9 +1507,8 @@\n   getCurrentConfig,\r\n   updateComfyUIConfig,\r\n   resetToDefaultConfig,\r\n   generateClientId,\r\n-  generateUserId,\r\n   getApiBaseUrl,\r\n   addConfigChangeListener,\r\n   removeConfigChangeListener,\r\n   processUndressImage,\r\n"
                },
                {
                    "date": 1752563254302,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -485,10 +485,10 @@\n let wsHealthCheckTimer = null\r\n let lastMessageTime = Date.now()\r\n let connectionAttempts = 0\r\n let maxConnectionAttempts = 5\r\n-let currentWebSocketServer = null // è®°å½•å½“å‰WebSocketè¿æ¥çš„æœåŠ¡å™¨\r\n \r\n+\r\n // å‰ç«¯é€šçŸ¥å‡½æ•°\r\n function showWebSocketStatusNotification(message, type = 'info') {\r\n   try {\r\n     // åœ¨æ§åˆ¶å°æ˜¾ç¤ºæ˜æ˜¾æ ‡è®°\r\n"
                },
                {
                    "date": 1752563273149,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -535,9 +535,8 @@\n     const config = getComfyUIConfig()\r\n \r\n     // è·å–æœ€ä¼˜æœåŠ¡å™¨\r\n     const baseUrl = await loadBalancer.getOptimalServer()\r\n-    currentWebSocketServer = baseUrl\r\n     console.log(`ğŸ”Œ å‡†å¤‡è¿æ¥WebSocketæœåŠ¡å™¨: ${baseUrl}`)\r\n \r\n     // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„WebSocket URLæ ¼å¼\r\n     let wsUrl\r\n"
                },
                {
                    "date": 1752563302527,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -618,11 +618,8 @@\n \r\n         // åœæ­¢å¥åº·æ£€æŸ¥\r\n         stopWebSocketHealthCheck()\r\n \r\n-        // æ¸…ç†WebSocketæœåŠ¡å™¨è®°å½•\r\n-        currentWebSocketServer = null\r\n-\r\n         // æ˜¾ç¤ºå‰ç«¯é€šçŸ¥\r\n         showWebSocketStatusNotification('WebSocketè¿æ¥å·²æ–­å¼€', 'warning')\r\n \r\n         // åˆ†æå…³é—­åŸå› \r\n"
                },
                {
                    "date": 1752564178171,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -330,15 +330,15 @@\n   }\r\n }\r\n \r\n // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n-async function submitWorkflow(workflowPrompt, userId = 'anonymous') {\r\n-  // ç¡®ä¿ WebSocket è¿æ¥ï¼ˆä¼ é€’ç”¨æˆ·IDï¼‰\r\n-  await initializeWebSocket(false, userId)\r\n+async function submitWorkflow(workflowPrompt) {\r\n+  // ç¡®ä¿ WebSocket è¿æ¥\r\n+  await initializeWebSocket(false)\r\n \r\n   const config = getComfyUIConfig()\r\n-  const apiBaseUrl = await getApiBaseUrl(userId)\r\n-  console.log(`ğŸ”„ ç¬¬äºŒæ­¥ï¼šä¸ºç”¨æˆ·${userId}æäº¤å·¥ä½œæµåˆ°ComfyUI`)\r\n+  const apiBaseUrl = await getApiBaseUrl()\r\n+  console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n   console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/api/prompt`)\r\n \r\n   // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n   const requestBody = {\r\n"
                },
                {
                    "date": 1752564218328,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1241,23 +1241,23 @@\n     if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n       throw new Error('æ— æ•ˆçš„å›¾ç‰‡æ•°æ®æ ¼å¼')\r\n     }\r\n \r\n-    // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨ï¼ˆä¼ é€’ç”¨æˆ·IDï¼‰\r\n+    // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨\r\n     if (onProgress) onProgress('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡åˆ°ComfyUI...', 20)\r\n \r\n-    const uploadedImageName = await uploadImageToComfyUI(base64Image, userId)\r\n+    const uploadedImageName = await uploadImageToComfyUI(base64Image)\r\n     console.log('âœ… å›¾ç‰‡ä¸Šä¼ å®Œæˆ:', uploadedImageName)\r\n \r\n     // åˆ›å»ºå·¥ä½œæµæç¤ºè¯ï¼Œå°†ä¸Šä¼ çš„å›¾ç‰‡å…³è”åˆ°èŠ‚ç‚¹49\r\n     if (onProgress) onProgress('æ­£åœ¨é…ç½®å·¥ä½œæµ...', 30)\r\n \r\n     const workflowPrompt = createUndressWorkflowPrompt(uploadedImageName)\r\n \r\n-    // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµï¼ˆä¼ é€’ç”¨æˆ·IDï¼‰\r\n+    // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµ\r\n     if (onProgress) onProgress('æ­£åœ¨æäº¤å·¥ä½œæµåˆ°ComfyUI...', 40)\r\n \r\n-    const promptId = await submitWorkflow(workflowPrompt, userId)\r\n+    const promptId = await submitWorkflow(workflowPrompt)\r\n     console.log('âœ… å·¥ä½œæµæäº¤å®Œæˆï¼Œä»»åŠ¡ID:', promptId)\r\n \r\n     // ç­‰å¾…ä»»åŠ¡å®Œæˆ - ä¼ é€’å‰ç«¯è¿›åº¦å›è°ƒ\r\n     if (onProgress) onProgress('æ­£åœ¨ç­‰å¾…ComfyUIå¤„ç†...', 50)\r\n"
                },
                {
                    "date": 1752564282406,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -234,11 +234,11 @@\n \r\n \r\n \r\n // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ Base64å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨å¹¶è·å–æ–‡ä»¶å\r\n-async function uploadImageToComfyUI(base64Image, userId = 'anonymous') {\r\n-  const apiBaseUrl = await getApiBaseUrl(userId)\r\n-  console.log(`ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸ºç”¨æˆ·${userId}ä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨`)\r\n+async function uploadImageToComfyUI(base64Image) {\r\n+  const apiBaseUrl = await getApiBaseUrl()\r\n+  console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n   console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n \r\n   // éªŒè¯base64æ ¼å¼\r\n   if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n"
                },
                {
                    "date": 1752564355176,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1406,22 +1406,22 @@\n     }\r\n \r\n     if (onProgress) onProgress('æ­£åœ¨ä¸Šä¼ äººè„¸ç…§ç‰‡...', 20)\r\n \r\n-    // ä¸Šä¼ 4å¼ äººè„¸ç…§ç‰‡ï¼ˆä¼ é€’ç”¨æˆ·IDï¼‰\r\n+    // ä¸Šä¼ 4å¼ äººè„¸ç…§ç‰‡\r\n     const uploadedFacePhotos = []\r\n     for (let i = 0; i < facePhotos.length; i++) {\r\n       const photo = facePhotos[i]\r\n       if (onProgress) onProgress(`æ­£åœ¨ä¸Šä¼ äººè„¸ç…§ç‰‡ ${i + 1}/4...`, 20 + (i * 10))\r\n \r\n-      const uploadedFilename = await uploadImageToComfyUI(photo, userId)\r\n+      const uploadedFilename = await uploadImageToComfyUI(photo)\r\n       uploadedFacePhotos.push(uploadedFilename)\r\n     }\r\n \r\n     if (onProgress) onProgress('æ­£åœ¨ä¸Šä¼ ç›®æ ‡å›¾ç‰‡...', 60)\r\n \r\n-    // ä¸Šä¼ ç›®æ ‡å›¾ç‰‡ï¼ˆä¼ é€’ç”¨æˆ·IDï¼‰\r\n-    const targetUploadedFilename = await uploadImageToComfyUI(targetImage, userId)\r\n+    // ä¸Šä¼ ç›®æ ‡å›¾ç‰‡\r\n+    const targetUploadedFilename = await uploadImageToComfyUI(targetImage)\r\n \r\n     if (onProgress) onProgress('æ­£åœ¨å‡†å¤‡æ¢è„¸å·¥ä½œæµ...', 70)\r\n \r\n     // å‡†å¤‡å·¥ä½œæµ\r\n"
                },
                {
                    "date": 1752564455977,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1453,10 +1453,10 @@\n     }\r\n \r\n     if (onProgress) onProgress('æ­£åœ¨æäº¤æ¢è„¸ä»»åŠ¡...', 80)\r\n \r\n-    // æäº¤å·¥ä½œæµï¼ˆä¼ é€’ç”¨æˆ·IDï¼‰\r\n-    const promptId = await submitWorkflow(workflow, userId)\r\n+    // æäº¤å·¥ä½œæµ\r\n+    const promptId = await submitWorkflow(workflow)\r\n \r\n     if (onProgress) onProgress('æ­£åœ¨å¤„ç†æ¢è„¸...', 85)\r\n \r\n     // ç­‰å¾…ä»»åŠ¡å®Œæˆ - æ¢è„¸éœ€è¦æ›´é•¿æ—¶é—´ï¼Œè®¾ç½®10åˆ†é’Ÿè¶…æ—¶\r\n"
                },
                {
                    "date": 1752564589397,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -373,12 +373,12 @@\n   return result.prompt_id // è¿”å›ä»»åŠ¡ID\r\n }\r\n \r\n // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\n-async function checkTaskStatus(promptId, userId = 'anonymous') {\r\n+async function checkTaskStatus(promptId) {\r\n   try {\r\n-    const apiBaseUrl = await getApiBaseUrl(userId)\r\n-    console.log(`ğŸ” ä¸ºç”¨æˆ·${userId}æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:`, `${apiBaseUrl}/api/history/${promptId}`)\r\n+    const apiBaseUrl = await getApiBaseUrl()\r\n+    console.log(`ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:`, `${apiBaseUrl}/api/history/${promptId}`)\r\n     const response = await fetch(`${apiBaseUrl}/api/history/${promptId}`)\r\n \r\n     if (!response.ok) {\r\n       throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText}`)\r\n"
                }
            ],
            "date": 1752326450066,
            "name": "Commit-0",
            "content": "// ComfyUIå·¥ä½œæµæœåŠ¡ - åŠ¨æ€é…ç½®æ¨¡å¼\r\nimport undressWorkflow from '../workflows/undress.json'\r\nimport faceSwapWorkflow from '../workflows/faceswap2.0.json'\r\nimport comfyUIConfig from '../config/comfyui.config.js'\r\nimport pointsManager from '../utils/pointsManager.js'\r\n\r\n// è·å–åŠ¨æ€é…ç½®çš„é»˜è®¤å€¼\r\nasync function getDefaultConfig() {\r\n  try {\r\n    const config = await comfyUIConfig.getConfig();\r\n    return {\r\n      COMFYUI_SERVER_URL: config.BASE_URL,\r\n      CLIENT_ID: config.CLIENT_ID,\r\n      TIMEOUT: config.REQUEST_TIMEOUT,\r\n      BACKUP_SERVERS: config.BACKUP_SERVERS,\r\n      AUTO_SWITCH: config.AUTO_SWITCH,\r\n      MAX_RETRIES: config.MAX_RETRIES\r\n    };\r\n  } catch (error) {\r\n    console.warn('âš ï¸ è·å–æœåŠ¡å™¨é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¡¬ç¼–ç é»˜è®¤å€¼:', error);\r\n    return {\r\n      COMFYUI_SERVER_URL: 'https://hwf0p724ub-8188.cnb.run',\r\n      CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n      TIMEOUT: 300000,\r\n      BACKUP_SERVERS: [],\r\n      AUTO_SWITCH: true,\r\n      MAX_RETRIES: 3\r\n    };\r\n  }\r\n}\r\n\r\n// é…ç½®ç¼“å­˜\r\nlet configCache = null\r\n\r\n// ä»localStorageè·å–é…ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤é…ç½®\r\nfunction getComfyUIConfig(forceRefresh = false) {\r\n  // å¦‚æœå¼ºåˆ¶åˆ·æ–°æˆ–ç¼“å­˜ä¸ºç©ºï¼Œé‡æ–°è¯»å–é…ç½®\r\n  if (forceRefresh || !configCache) {\r\n    const savedConfig = localStorage.getItem('comfyui_config')\r\n    if (savedConfig) {\r\n      try {\r\n        const parsed = JSON.parse(savedConfig)\r\n        configCache = { ...DEFAULT_CONFIG, ...parsed }\r\n        console.log('ğŸ”„ é…ç½®å·²åˆ·æ–°:', configCache)\r\n      } catch (error) {\r\n        console.warn('è§£æä¿å­˜çš„é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error)\r\n        configCache = { ...DEFAULT_CONFIG }\r\n      }\r\n    } else {\r\n      configCache = { ...DEFAULT_CONFIG }\r\n    }\r\n  }\r\n  return { ...configCache }\r\n}\r\n\r\n// ä¿å­˜é…ç½®åˆ°localStorage\r\nfunction saveComfyUIConfig(config) {\r\n  try {\r\n    localStorage.setItem('comfyui_config', JSON.stringify(config))\r\n    // æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶ä¸‹æ¬¡è¯»å–æ—¶é‡æ–°åŠ è½½\r\n    configCache = null\r\n    console.log('ComfyUIé…ç½®å·²ä¿å­˜:', config)\r\n  } catch (error) {\r\n    console.error('ä¿å­˜é…ç½®å¤±è´¥:', error)\r\n  }\r\n}\r\n\r\n// æ›´æ–°ä»£ç†æœåŠ¡å™¨é…ç½®\r\nasync function updateProxyServerConfig(config) {\r\n  try {\r\n    // åªæœ‰åœ¨ä½¿ç”¨ä»£ç†æ—¶æ‰æ›´æ–°ä»£ç†æœåŠ¡å™¨é…ç½®\r\n    if (!config.USE_PROXY) {\r\n      console.log('ğŸ”§ ä¸ä½¿ç”¨ä»£ç†ï¼Œè·³è¿‡ä»£ç†æœåŠ¡å™¨é…ç½®æ›´æ–°')\r\n      return { success: true, message: 'ä¸ä½¿ç”¨ä»£ç†æ¨¡å¼' }\r\n    }\r\n\r\n    const proxyConfigUrl = config.PROXY_SERVER_URL.replace('/api', '/api/config')\r\n    console.log('ğŸ”§ æ›´æ–°ä»£ç†æœåŠ¡å™¨é…ç½®:', proxyConfigUrl)\r\n\r\n    const response = await fetch(proxyConfigUrl, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify({\r\n        COMFYUI_SERVER_URL: config.COMFYUI_SERVER_URL,\r\n        CLIENT_ID: config.CLIENT_ID\r\n      }),\r\n      timeout: 10000\r\n    })\r\n\r\n    if (response.ok) {\r\n      const result = await response.json()\r\n      console.log('âœ… ä»£ç†æœåŠ¡å™¨é…ç½®æ›´æ–°æˆåŠŸ:', result)\r\n      return { success: true, message: 'ä»£ç†æœåŠ¡å™¨é…ç½®æ›´æ–°æˆåŠŸ' }\r\n    } else {\r\n      console.warn('âš ï¸ ä»£ç†æœåŠ¡å™¨é…ç½®æ›´æ–°å¤±è´¥:', response.status)\r\n      return { success: false, message: `ä»£ç†æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status}` }\r\n    }\r\n  } catch (error) {\r\n    console.warn('âš ï¸ æ— æ³•è¿æ¥åˆ°ä»£ç†æœåŠ¡å™¨ï¼Œå¯èƒ½ä»£ç†æœåŠ¡å™¨æœªå¯åŠ¨:', error.message)\r\n    return { success: false, message: 'æ— æ³•è¿æ¥åˆ°ä»£ç†æœåŠ¡å™¨' }\r\n  }\r\n}\r\n\r\n// é…ç½®å˜æ›´ç›‘å¬å™¨\r\nconst configChangeListeners = []\r\n\r\n// æ·»åŠ é…ç½®å˜æ›´ç›‘å¬å™¨\r\nfunction addConfigChangeListener(listener) {\r\n  configChangeListeners.push(listener)\r\n}\r\n\r\n// ç§»é™¤é…ç½®å˜æ›´ç›‘å¬å™¨\r\nfunction removeConfigChangeListener(listener) {\r\n  const index = configChangeListeners.indexOf(listener)\r\n  if (index > -1) {\r\n    configChangeListeners.splice(index, 1)\r\n  }\r\n}\r\n\r\n// é€šçŸ¥é…ç½®å˜æ›´\r\nfunction notifyConfigChange(config) {\r\n  configChangeListeners.forEach(listener => {\r\n    try {\r\n      listener(config)\r\n    } catch (error) {\r\n      console.error('é…ç½®å˜æ›´ç›‘å¬å™¨æ‰§è¡Œå¤±è´¥:', error)\r\n    }\r\n  })\r\n}\r\n\r\n// æ›´æ–°é…ç½®\r\nasync function updateComfyUIConfig(newConfig) {\r\n  const currentConfig = getComfyUIConfig(true) // å¼ºåˆ¶åˆ·æ–°å½“å‰é…ç½®\r\n  const updatedConfig = { ...currentConfig, ...newConfig }\r\n\r\n  console.log('ğŸ”„ æ›´æ–°é…ç½®:', updatedConfig)\r\n\r\n  // ä¿å­˜åˆ°localStorageï¼ˆè¿™ä¼šæ¸…é™¤ç¼“å­˜ï¼‰\r\n  saveComfyUIConfig(updatedConfig)\r\n\r\n  // å¼ºåˆ¶åˆ·æ–°é…ç½®ç¼“å­˜\r\n  configCache = null\r\n\r\n  // é€šçŸ¥é…ç½®å˜æ›´\r\n  notifyConfigChange(updatedConfig)\r\n\r\n  // åŒæ—¶æ›´æ–°ä»£ç†æœåŠ¡å™¨é…ç½®\r\n  const proxyUpdateResult = await updateProxyServerConfig(updatedConfig)\r\n\r\n  console.log('âœ… é…ç½®æ›´æ–°å®Œæˆï¼Œæ–°é…ç½®å·²ç”Ÿæ•ˆ')\r\n\r\n  return {\r\n    config: updatedConfig,\r\n    proxyUpdate: proxyUpdateResult\r\n  }\r\n}\r\n\r\n// è·å–å½“å‰é…ç½®\r\nfunction getCurrentConfig(forceRefresh = false) {\r\n  return getComfyUIConfig(forceRefresh)\r\n}\r\n\r\n// è·å–APIåŸºç¡€URL - ç›´è¿æ¨¡å¼\r\nfunction getApiBaseUrl() {\r\n  const config = getComfyUIConfig(true)\r\n  console.log('ğŸ¯ ç›´è¿ComfyUIæœåŠ¡å™¨:', config.COMFYUI_SERVER_URL)\r\n\r\n  let baseUrl = config.COMFYUI_SERVER_URL\r\n\r\n  // ç¡®ä¿URLæ ¼å¼æ­£ç¡®ï¼Œç§»é™¤æœ«å°¾çš„æ–œæ \r\n  if (baseUrl && baseUrl.endsWith('/')) {\r\n    baseUrl = baseUrl.slice(0, -1)\r\n  }\r\n\r\n  return baseUrl\r\n}\r\n\r\n// é‡ç½®ä¸ºé»˜è®¤é…ç½®\r\nfunction resetToDefaultConfig() {\r\n  localStorage.removeItem('comfyui_config')\r\n  return { ...DEFAULT_CONFIG }\r\n}\r\n\r\n// ç”Ÿæˆéšæœºå®¢æˆ·ç«¯IDï¼ˆå¤‡ç”¨å‡½æ•°ï¼‰\r\nfunction generateClientId() {\r\n  return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)\r\n}\r\n\r\n// ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ Base64å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨å¹¶è·å–æ–‡ä»¶å\r\nasync function uploadImageToComfyUI(base64Image) {\r\n  try {\r\n    const config = getComfyUIConfig()\r\n    const apiBaseUrl = getApiBaseUrl()\r\n    console.log('ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨')\r\n    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/upload/image`)\r\n\r\n    // éªŒè¯base64æ ¼å¼\r\n    if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n      throw new Error('æ— æ•ˆçš„base64å›¾ç‰‡æ ¼å¼')\r\n    }\r\n\r\n    // ä»base64æ•°æ®ä¸­æå–å›¾ç‰‡ä¿¡æ¯\r\n    const base64Data = base64Image.split(',')[1]\r\n    const mimeType = base64Image.split(',')[0].split(':')[1].split(';')[0]\r\n    const extension = mimeType.split('/')[1] || 'jpg'\r\n\r\n    // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å\r\n    const filename = `upload_${Date.now()}_${Math.random().toString(36).substring(7)}.${extension}`\r\n\r\n    // å°†base64è½¬æ¢ä¸ºBlob\r\n    const byteCharacters = atob(base64Data)\r\n    const byteNumbers = new Array(byteCharacters.length)\r\n    for (let i = 0; i < byteCharacters.length; i++) {\r\n      byteNumbers[i] = byteCharacters.charCodeAt(i)\r\n    }\r\n    const byteArray = new Uint8Array(byteNumbers)\r\n    const blob = new Blob([byteArray], { type: mimeType })\r\n\r\n    console.log('ğŸ“¤ ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯:', {\r\n      filename,\r\n      type: mimeType,\r\n      size: `${(blob.size / 1024).toFixed(2)} KB`\r\n    })\r\n\r\n    // ç›´è¿ä¸Šä¼ å›¾ç‰‡\r\n    const formData = new FormData()\r\n    formData.append('image', blob, filename)\r\n    formData.append('type', 'input')\r\n    formData.append('subfolder', '')\r\n    formData.append('overwrite', 'false')\r\n\r\n    console.log('ğŸ”„ å¼€å§‹ä¸Šä¼ å›¾ç‰‡...')\r\n\r\n    const response = await fetch(`${apiBaseUrl}/upload/image`, {\r\n      method: 'POST',\r\n      body: formData\r\n    })\r\n\r\n    console.log('ğŸ“¥ ä¸Šä¼ å“åº”çŠ¶æ€:', response.status, response.statusText)\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text().catch(() => response.statusText)\r\n      throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status} ${response.statusText} - ${errorText}`)\r\n    }\r\n\r\n    const result = await response.json()\r\n    console.log('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', result)\r\n\r\n    // éªŒè¯è¿”å›ç»“æœ\r\n    if (!result.name) {\r\n      throw new Error('ä¸Šä¼ å“åº”ä¸­ç¼ºå°‘æ–‡ä»¶å')\r\n    }\r\n\r\n    return result.name\r\n\r\n  } catch (error) {\r\n    console.error('âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error)\r\n    throw new Error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`)\r\n  }\r\n}\r\n\r\n// åˆ›å»ºå·¥ä½œæµæç¤ºè¯ï¼Œå°†ç”¨æˆ·å›¾ç‰‡å…³è”åˆ°èŠ‚ç‚¹49\r\nfunction createUndressWorkflowPrompt(uploadedImageName) {\r\n  try {\r\n    // æ·±æ‹·è´å·¥ä½œæµ\r\n    const workflow = JSON.parse(JSON.stringify(undressWorkflow))\r\n\r\n    // å°†ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶åè®¾ç½®åˆ°èŠ‚ç‚¹49\r\n    if (workflow['49'] && workflow['49'].class_type === 'LoadImage') {\r\n      workflow['49'].inputs.image = uploadedImageName\r\n      console.log('èŠ‚ç‚¹49å›¾ç‰‡è®¾ç½®ä¸º:', uploadedImageName)\r\n    } else {\r\n      throw new Error('å·¥ä½œæµä¸­æœªæ‰¾åˆ°èŠ‚ç‚¹49æˆ–èŠ‚ç‚¹ç±»å‹ä¸æ­£ç¡®')\r\n    }\r\n\r\n    // éšæœºåŒ–ç§å­ä»¥è·å¾—ä¸åŒçš„ç»“æœ\r\n    if (workflow['174'] && workflow['174'].inputs) {\r\n      const newSeed = Math.floor(Math.random() * 1000000000000000)\r\n      workflow['174'].inputs.noise_seed = newSeed\r\n      console.log('éšæœºç§å­è®¾ç½®ä¸º:', newSeed)\r\n    }\r\n\r\n    console.log('å·¥ä½œæµé…ç½®å®Œæˆ')\r\n    return workflow\r\n\r\n  } catch (error) {\r\n    console.error('å·¥ä½œæµåˆ›å»ºå¤±è´¥:', error)\r\n    throw new Error(`å·¥ä½œæµåˆ›å»ºå¤±è´¥: ${error.message}`)\r\n  }\r\n}\r\n\r\n// ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\nasync function submitWorkflow(workflowPrompt) {\r\n  try {\r\n    const config = getComfyUIConfig()\r\n    const apiBaseUrl = getApiBaseUrl()\r\n    console.log('ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI')\r\n    console.log('ğŸ“¡ APIåœ°å€:', `${apiBaseUrl}/prompt`)\r\n    console.log('ğŸ”§ ä½¿ç”¨ä»£ç†:', config.USE_PROXY ? 'æ˜¯' : 'å¦')\r\n\r\n    // æ„å»ºè¯·æ±‚ä½“ï¼ŒæŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n    const requestBody = {\r\n      client_id: config.CLIENT_ID,\r\n      prompt: workflowPrompt\r\n    }\r\n\r\n    console.log('ğŸ“‹ è¯·æ±‚ä½“ç»“æ„:', {\r\n      client_id: requestBody.client_id,\r\n      prompt_keys: Object.keys(requestBody.prompt),\r\n      node_49_exists: !!requestBody.prompt['49'],\r\n      node_49_image: requestBody.prompt['49']?.inputs?.image\r\n    })\r\n\r\n    // ç¬¬äºŒæ­¥APIè°ƒç”¨ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI\r\n    const promptUrl = `${apiBaseUrl}/prompt`\r\n    console.log('ğŸŒ è°ƒç”¨å·¥ä½œæµAPI:', promptUrl)\r\n\r\n    const response = await fetch(promptUrl, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify(requestBody),\r\n      mode: 'cors',\r\n      credentials: 'omit'\r\n    })\r\n\r\n    console.log('ğŸ“¥ å·¥ä½œæµå“åº”çŠ¶æ€:', response.status, response.statusText)\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text()\r\n      console.error('âŒ å·¥ä½œæµæäº¤å¤±è´¥å“åº”:', errorText)\r\n      throw new Error(`å·¥ä½œæµæäº¤å¤±è´¥: ${response.status} ${response.statusText} - ${errorText}`)\r\n    }\r\n\r\n    const result = await response.json()\r\n    console.log('âœ… å·¥ä½œæµæäº¤æˆåŠŸ:', result)\r\n\r\n    // éªŒè¯è¿”å›ç»“æœ\r\n    if (!result.prompt_id) {\r\n      throw new Error('å·¥ä½œæµå“åº”ä¸­ç¼ºå°‘prompt_id')\r\n    }\r\n\r\n    return result.prompt_id // è¿”å›ä»»åŠ¡ID\r\n\r\n  } catch (error) {\r\n    console.error('âŒ å·¥ä½œæµæäº¤å¤±è´¥:', error)\r\n    throw new Error(`å·¥ä½œæµæäº¤å¤±è´¥: ${error.message}`)\r\n  }\r\n}\r\n\r\n// æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\r\nasync function checkTaskStatus(promptId) {\r\n  try {\r\n    const config = getComfyUIConfig()\r\n    const apiBaseUrl = getApiBaseUrl()\r\n    console.log('ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', `${apiBaseUrl}/history/${promptId}`)\r\n    const response = await fetch(`${apiBaseUrl}/history/${promptId}`)\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText}`)\r\n    }\r\n\r\n    const result = await response.json()\r\n    return result[promptId] || null\r\n\r\n  } catch (error) {\r\n    console.error('çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', error)\r\n    throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${error.message}`)\r\n  }\r\n}\r\n\r\n// è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\nasync function getGeneratedImage(taskResult) {\r\n  try {\r\n    const config = getComfyUIConfig()\r\n    const apiBaseUrl = getApiBaseUrl()\r\n\r\n    // ä»ä»»åŠ¡ç»“æœä¸­æ‰¾åˆ°è¾“å‡ºå›¾ç‰‡\r\n    const outputs = taskResult.outputs\r\n    let imageInfo = null\r\n\r\n    // ä¼˜å…ˆæŸ¥æ‰¾èŠ‚ç‚¹730çš„è¾“å‡ºå›¾ç‰‡ï¼ˆä¸€é”®æ¢è¡£å¤„ç†ç»“æœï¼‰\r\n    if (outputs['730'] && outputs['730'].images && outputs['730'].images.length > 0) {\r\n      imageInfo = outputs['730'].images[0]\r\n      console.log('ğŸ“· æ‰¾åˆ°èŠ‚ç‚¹730çš„ä¸€é”®æ¢è¡£å¤„ç†ç»“æœå›¾ç‰‡:', imageInfo)\r\n    } else if (outputs['812'] && outputs['812'].images && outputs['812'].images.length > 0) {\r\n      // å¤‡ç”¨ï¼šæŸ¥æ‰¾èŠ‚ç‚¹812çš„è¾“å‡ºå›¾ç‰‡ï¼ˆæ¢è„¸å¤„ç†ç»“æœï¼‰\r\n      imageInfo = outputs['812'].images[0]\r\n      console.log('ğŸ“· æ‰¾åˆ°èŠ‚ç‚¹812çš„æ¢è„¸å¤„ç†ç»“æœå›¾ç‰‡:', imageInfo)\r\n    } else if (outputs['813'] && outputs['813'].images && outputs['813'].images.length > 0) {\r\n      // å¤‡ç”¨ï¼šæŸ¥æ‰¾èŠ‚ç‚¹813çš„è¾“å‡ºå›¾ç‰‡ï¼ˆæ—§ç‰ˆæ¢è„¸ç»“æœï¼‰\r\n      imageInfo = outputs['813'].images[0]\r\n      console.log('ğŸ“· æ‰¾åˆ°èŠ‚ç‚¹813çš„æ¢è„¸å¤„ç†ç»“æœå›¾ç‰‡:', imageInfo)\r\n    } else if (outputs['746'] && outputs['746'].images && outputs['746'].images.length > 0) {\r\n      // å¤‡ç”¨ï¼šæŸ¥æ‰¾èŠ‚ç‚¹746çš„è¾“å‡ºå›¾ç‰‡ï¼ˆæ›´æ—§ç‰ˆæ¢è„¸ç»“æœï¼‰\r\n      imageInfo = outputs['746'].images[0]\r\n      console.log('ğŸ“· æ‰¾åˆ°èŠ‚ç‚¹746çš„æ¢è„¸å¤„ç†ç»“æœå›¾ç‰‡:', imageInfo)\r\n    } else if (outputs['710'] && outputs['710'].images && outputs['710'].images.length > 0) {\r\n      // å¤‡ç”¨ï¼šæŸ¥æ‰¾èŠ‚ç‚¹710çš„è¾“å‡ºå›¾ç‰‡ï¼ˆæ¢è¡£å¤„ç†ç»“æœï¼‰\r\n      imageInfo = outputs['710'].images[0]\r\n      console.log('ğŸ“· æ‰¾åˆ°èŠ‚ç‚¹710çš„å¤„ç†ç»“æœå›¾ç‰‡:', imageInfo)\r\n    } else {\r\n      // å¦‚æœä¸»è¦èŠ‚ç‚¹éƒ½æ²¡æœ‰è¾“å‡ºï¼Œåˆ™æŸ¥æ‰¾å…¶ä»–èŠ‚ç‚¹çš„è¾“å‡ºå›¾ç‰‡\r\n      console.log('âš ï¸ èŠ‚ç‚¹812ã€813ã€746å’Œ710éƒ½æ— è¾“å‡ºï¼ŒæŸ¥æ‰¾å…¶ä»–èŠ‚ç‚¹...')\r\n      for (const nodeId in outputs) {\r\n        const nodeOutput = outputs[nodeId]\r\n        if (nodeOutput.images && nodeOutput.images.length > 0) {\r\n          imageInfo = nodeOutput.images[0]\r\n          console.log(`ğŸ“· æ‰¾åˆ°èŠ‚ç‚¹${nodeId}çš„å›¾ç‰‡:`, imageInfo)\r\n          break\r\n        }\r\n      }\r\n    }\r\n\r\n    if (!imageInfo) {\r\n      console.error('âŒ æ‰€æœ‰èŠ‚ç‚¹è¾“å‡º:', JSON.stringify(outputs, null, 2))\r\n      throw new Error('æœªæ‰¾åˆ°ç”Ÿæˆçš„å›¾ç‰‡')\r\n    }\r\n\r\n    console.log('ğŸ“· æœ€ç»ˆé€‰æ‹©çš„å›¾ç‰‡:', imageInfo)\r\n\r\n    // æ„å»ºå›¾ç‰‡URL - æŒ‰ç…§ComfyUI APIæ–‡æ¡£æ ¼å¼\r\n    const params = new URLSearchParams({\r\n      filename: imageInfo.filename,\r\n      type: imageInfo.type,\r\n      subfolder: imageInfo.subfolder || ''\r\n    })\r\n    const imageUrl = `${apiBaseUrl}/view?${params.toString()}`\r\n\r\n    console.log('ğŸŒ è·å–å›¾ç‰‡URL:', imageUrl)\r\n\r\n    // è·å–å›¾ç‰‡æ•°æ®å¹¶è½¬æ¢ä¸ºbase64\r\n    const imageResponse = await fetch(imageUrl)\r\n    if (!imageResponse.ok) {\r\n      throw new Error(`å›¾ç‰‡è·å–å¤±è´¥: ${imageResponse.status}`)\r\n    }\r\n\r\n    const imageBlob = await imageResponse.blob()\r\n    return new Promise((resolve, reject) => {\r\n      const reader = new FileReader()\r\n      reader.onload = () => resolve(reader.result)\r\n      reader.onerror = reject\r\n      reader.readAsDataURL(imageBlob)\r\n    })\r\n\r\n  } catch (error) {\r\n    console.error('å›¾ç‰‡è·å–å¤±è´¥:', error)\r\n    throw new Error(`å›¾ç‰‡è·å–å¤±è´¥: ${error.message}`)\r\n  }\r\n}\r\n\r\n// ç­‰å¾…ä»»åŠ¡å®Œæˆ\r\nasync function waitForTaskCompletion(promptId, maxWaitTime = 300000) {\r\n  const startTime = Date.now()\r\n  const pollInterval = 2000 // 2ç§’è½®è¯¢ä¸€æ¬¡\r\n\r\n  while (Date.now() - startTime < maxWaitTime) {\r\n    const taskResult = await checkTaskStatus(promptId)\r\n\r\n    if (taskResult) {\r\n      if (taskResult.status && taskResult.status.completed) {\r\n        return taskResult\r\n      } else if (taskResult.status && taskResult.status.status_str === 'error') {\r\n        throw new Error(`ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${JSON.stringify(taskResult.status)}`)\r\n      }\r\n    }\r\n\r\n    // ç­‰å¾…ä¸‹æ¬¡è½®è¯¢\r\n    await new Promise(resolve => setTimeout(resolve, pollInterval))\r\n  }\r\n\r\n  throw new Error('ä»»åŠ¡æ‰§è¡Œè¶…æ—¶')\r\n}\r\n\r\n// ä¸»è¦çš„æ¢è¡£APIå‡½æ•° - ä¸¤æ­¥æµç¨‹\r\nasync function processUndressImage(base64Image) {\r\n  try {\r\n    console.log('ğŸš€ å¼€å§‹å¤„ç†æ¢è¡£è¯·æ±‚...')\r\n\r\n    // æ£€æŸ¥ä½“éªŒç‚¹\r\n    console.log('ğŸ’ æ£€æŸ¥ä½“éªŒç‚¹...')\r\n    if (!pointsManager.hasEnoughPoints()) {\r\n      const status = pointsManager.getPointsStatus()\r\n      throw new Error(`ä½“éªŒç‚¹ä¸è¶³ï¼å½“å‰ç‚¹æ•°: ${status.current}ï¼Œéœ€è¦: ${status.generationCost}`)\r\n    }\r\n\r\n    console.log('ğŸ“‹ æµç¨‹ï¼šç¬¬ä¸€æ­¥ä¸Šä¼ å›¾ç‰‡ â†’ ç¬¬äºŒæ­¥æäº¤å·¥ä½œæµ')\r\n\r\n    // éªŒè¯å›¾ç‰‡æ•°æ®æ ¼å¼\r\n    console.log('ğŸ” éªŒè¯å›¾ç‰‡æ•°æ®æ ¼å¼...')\r\n    if (!base64Image || !base64Image.startsWith('data:image/')) {\r\n      throw new Error('æ— æ•ˆçš„å›¾ç‰‡æ•°æ®æ ¼å¼')\r\n    }\r\n\r\n    // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨\r\n    console.log('ğŸ“¤ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ° /api/upload/image')\r\n    const uploadedImageName = await uploadImageToComfyUI(base64Image)\r\n    console.log('âœ… ç¬¬ä¸€æ­¥å®Œæˆï¼Œè·å¾—æ–‡ä»¶å:', uploadedImageName)\r\n\r\n    // åˆ›å»ºå·¥ä½œæµæç¤ºè¯ï¼Œå°†ä¸Šä¼ çš„å›¾ç‰‡å…³è”åˆ°èŠ‚ç‚¹49\r\n    console.log('ğŸ”§ é…ç½®å·¥ä½œæµï¼Œå…³è”å›¾ç‰‡åˆ°èŠ‚ç‚¹49...')\r\n    const workflowPrompt = createUndressWorkflowPrompt(uploadedImageName)\r\n\r\n    // ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµ\r\n    console.log('ğŸš€ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ° /api/prompt')\r\n    const promptId = await submitWorkflow(workflowPrompt)\r\n    console.log('âœ… ç¬¬äºŒæ­¥å®Œæˆï¼Œè·å¾—ä»»åŠ¡ID:', promptId)\r\n\r\n    // ç­‰å¾…ä»»åŠ¡å®Œæˆ\r\n    console.log('â³ ç­‰å¾…ComfyUIå¤„ç†ä»»åŠ¡...')\r\n    const taskResult = await waitForTaskCompletion(promptId)\r\n    console.log('âœ… ä»»åŠ¡å¤„ç†å®Œæˆ')\r\n\r\n    // è·å–ç”Ÿæˆçš„å›¾ç‰‡\r\n    console.log('ğŸ“¥ è·å–ç”Ÿæˆçš„å›¾ç‰‡...')\r\n    const resultImage = await getGeneratedImage(taskResult)\r\n    console.log('ğŸ‰ æ¢è¡£å¤„ç†å®Œå…¨æˆåŠŸï¼')\r\n\r\n    // æ¶ˆè€—ä½“éªŒç‚¹\r\n    console.log('ğŸ’ æ¶ˆè€—ä½“éªŒç‚¹...')\r\n    const pointsResult = pointsManager.consumePoints()\r\n    console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ä½“éªŒç‚¹ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n\r\n    // è·å–èŠ‚ç‚¹49çš„åŸå›¾ç”¨äºå¯¹æ¯”\r\n    let originalImage = null\r\n    try {\r\n      // æ„å»ºèŠ‚ç‚¹49åŸå›¾çš„URL\r\n      const params = new URLSearchParams({\r\n        filename: uploadedImageName,\r\n        type: 'input',\r\n        subfolder: ''\r\n      })\r\n      const config = getComfyUIConfig()\r\n      const apiBaseUrl = getApiBaseUrl()\r\n      originalImage = `${apiBaseUrl}/view?${params.toString()}`\r\n      console.log('ğŸ“· è·å–èŠ‚ç‚¹49åŸå›¾URL:', originalImage)\r\n    } catch (error) {\r\n      console.warn('âš ï¸ è·å–èŠ‚ç‚¹49åŸå›¾å¤±è´¥ï¼Œä½¿ç”¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡:', error)\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      resultImage: resultImage,\r\n      originalImage: originalImage, // æ–°å¢ï¼šèŠ‚ç‚¹49çš„åŸå›¾\r\n      promptId: promptId,\r\n      uploadedImageName: uploadedImageName,\r\n      pointsConsumed: pointsResult.consumed,\r\n      pointsRemaining: pointsResult.remaining,\r\n      message: 'æ¢è¡£å¤„ç†å®Œæˆ'\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('âŒ æ¢è¡£å¤„ç†å¤±è´¥:', error)\r\n    return {\r\n      success: false,\r\n      error: error.message,\r\n      message: 'æ¢è¡£å¤„ç†å¤±è´¥'\r\n    }\r\n  }\r\n}\r\n\r\n// æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€\r\nasync function checkComfyUIServerStatus() {\r\n  try {\r\n    const apiBaseUrl = getApiBaseUrl()\r\n    console.log('ğŸ” æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€:', apiBaseUrl)\r\n\r\n    const response = await fetch(`${apiBaseUrl}/system_stats`, {\r\n      method: 'GET',\r\n      signal: AbortSignal.timeout(10000) // 10ç§’è¶…æ—¶\r\n    })\r\n\r\n    if (response.ok) {\r\n      const stats = await response.json()\r\n      console.log('âœ… ComfyUIæœåŠ¡å™¨çŠ¶æ€æ­£å¸¸:', stats)\r\n      return { status: 'ok', stats }\r\n    } else {\r\n      console.warn('âš ï¸ ComfyUIæœåŠ¡å™¨å“åº”å¼‚å¸¸:', response.status)\r\n      return { status: 'error', code: response.status }\r\n    }\r\n  } catch (error) {\r\n    console.error('âŒ ComfyUIæœåŠ¡å™¨è¿æ¥å¤±è´¥:', error)\r\n    return { status: 'error', error: error.message }\r\n  }\r\n}\r\n\r\n// æ¢è„¸å¤„ç†å‡½æ•°\r\nasync function processFaceSwapImage({ facePhotos, targetImage, onProgress }) {\r\n  try {\r\n    console.log('ğŸš€ å¼€å§‹æ¢è„¸å¤„ç†')\r\n\r\n    // æ£€æŸ¥ä½“éªŒç‚¹\r\n    console.log('ğŸ’ æ£€æŸ¥ä½“éªŒç‚¹...')\r\n    if (!pointsManager.hasEnoughPoints()) {\r\n      const status = pointsManager.getPointsStatus()\r\n      throw new Error(`ä½“éªŒç‚¹ä¸è¶³ï¼å½“å‰ç‚¹æ•°: ${status.current}ï¼Œéœ€è¦: ${status.generationCost}`)\r\n    }\r\n\r\n    if (onProgress) onProgress('æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...', 5)\r\n\r\n    // æ£€æŸ¥ComfyUIæœåŠ¡å™¨çŠ¶æ€\r\n    const serverStatus = await checkComfyUIServerStatus()\r\n    if (serverStatus.status === 'error') {\r\n      throw new Error(`ComfyUIæœåŠ¡å™¨ä¸å¯ç”¨: ${serverStatus.error || serverStatus.code}`)\r\n    }\r\n\r\n    if (onProgress) onProgress('æ­£åœ¨å‡†å¤‡å·¥ä½œæµ...', 10)\r\n\r\n    // éªŒè¯è¾“å…¥\r\n    if (!facePhotos || facePhotos.length !== 4) {\r\n      throw new Error('éœ€è¦æä¾›4å¼ äººè„¸ç…§ç‰‡')\r\n    }\r\n\r\n    if (!targetImage) {\r\n      throw new Error('éœ€è¦æä¾›ç›®æ ‡å›¾ç‰‡')\r\n    }\r\n\r\n    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰äººè„¸ç…§ç‰‡éƒ½å·²ä¸Šä¼ \r\n    const validFacePhotos = facePhotos.filter(photo => photo !== null)\r\n    if (validFacePhotos.length !== 4) {\r\n      throw new Error('è¯·ä¸Šä¼ 4å¼ äººè„¸ç…§ç‰‡')\r\n    }\r\n\r\n    if (onProgress) onProgress('æ­£åœ¨ä¸Šä¼ äººè„¸ç…§ç‰‡...', 20)\r\n\r\n    // ä¸Šä¼ 4å¼ äººè„¸ç…§ç‰‡\r\n    const uploadedFacePhotos = []\r\n    for (let i = 0; i < facePhotos.length; i++) {\r\n      const photo = facePhotos[i]\r\n      if (onProgress) onProgress(`æ­£åœ¨ä¸Šä¼ äººè„¸ç…§ç‰‡ ${i + 1}/4...`, 20 + (i * 10))\r\n\r\n      const uploadedFilename = await uploadImageToComfyUI(photo)\r\n      uploadedFacePhotos.push(uploadedFilename)\r\n    }\r\n\r\n    if (onProgress) onProgress('æ­£åœ¨ä¸Šä¼ ç›®æ ‡å›¾ç‰‡...', 60)\r\n\r\n    // ä¸Šä¼ ç›®æ ‡å›¾ç‰‡\r\n    const targetUploadedFilename = await uploadImageToComfyUI(targetImage)\r\n\r\n    if (onProgress) onProgress('æ­£åœ¨å‡†å¤‡æ¢è„¸å·¥ä½œæµ...', 70)\r\n\r\n    // å‡†å¤‡å·¥ä½œæµ\r\n    const workflow = JSON.parse(JSON.stringify(faceSwapWorkflow))\r\n\r\n    // æ›´æ–°å·¥ä½œæµä¸­çš„å›¾ç‰‡èŠ‚ç‚¹\r\n    // æ ¹æ®æœ€æ–°å·¥ä½œæµï¼Œæ­£ç¡®çš„èŠ‚ç‚¹æ˜ å°„ï¼š\r\n    // èŠ‚ç‚¹670: ç¬¬ä¸€å¼ äººè„¸ç…§ç‰‡\r\n    // èŠ‚ç‚¹662: ç¬¬äºŒå¼ äººè„¸ç…§ç‰‡\r\n    // èŠ‚ç‚¹658: ç¬¬ä¸‰å¼ äººè„¸ç…§ç‰‡\r\n    // èŠ‚ç‚¹655: ç¬¬å››å¼ äººè„¸ç…§ç‰‡\r\n    // èŠ‚ç‚¹737: ç›®æ ‡å›¾ç‰‡\r\n    // èŠ‚ç‚¹812: å¤„ç†ç»“æœè¾“å‡ºï¼ˆæœ€æ–°ï¼‰\r\n\r\n    if (workflow['670']) {\r\n      workflow['670'].inputs.image = uploadedFacePhotos[0]\r\n      console.log('âœ… èŠ‚ç‚¹670è®¾ç½®ç¬¬ä¸€å¼ äººè„¸ç…§ç‰‡:', uploadedFacePhotos[0])\r\n    }\r\n    if (workflow['662']) {\r\n      workflow['662'].inputs.image = uploadedFacePhotos[1]\r\n      console.log('âœ… èŠ‚ç‚¹662è®¾ç½®ç¬¬äºŒå¼ äººè„¸ç…§ç‰‡:', uploadedFacePhotos[1])\r\n    }\r\n    if (workflow['658']) {\r\n      workflow['658'].inputs.image = uploadedFacePhotos[2]\r\n      console.log('âœ… èŠ‚ç‚¹658è®¾ç½®ç¬¬ä¸‰å¼ äººè„¸ç…§ç‰‡:', uploadedFacePhotos[2])\r\n    }\r\n    if (workflow['655']) {\r\n      workflow['655'].inputs.image = uploadedFacePhotos[3]\r\n      console.log('âœ… èŠ‚ç‚¹655è®¾ç½®ç¬¬å››å¼ äººè„¸ç…§ç‰‡:', uploadedFacePhotos[3])\r\n    }\r\n    if (workflow['737']) {\r\n      workflow['737'].inputs.image = targetUploadedFilename\r\n      console.log('âœ… èŠ‚ç‚¹737è®¾ç½®ç›®æ ‡å›¾ç‰‡:', targetUploadedFilename)\r\n    }\r\n\r\n    if (onProgress) onProgress('æ­£åœ¨æäº¤æ¢è„¸ä»»åŠ¡...', 80)\r\n\r\n    // æäº¤å·¥ä½œæµ\r\n    const promptId = await submitWorkflow(workflow)\r\n\r\n    if (onProgress) onProgress('æ­£åœ¨å¤„ç†æ¢è„¸...', 85)\r\n\r\n    // ç­‰å¾…ä»»åŠ¡å®Œæˆ - æ¢è„¸éœ€è¦æ›´é•¿æ—¶é—´ï¼Œè®¾ç½®10åˆ†é’Ÿè¶…æ—¶\r\n    const maxWaitTime = 600000 // 10åˆ†é’Ÿ\r\n    console.log(`â³ å¼€å§‹ç­‰å¾…æ¢è„¸ä»»åŠ¡å®Œæˆï¼Œä»»åŠ¡ID: ${promptId}ï¼Œæœ€å¤§ç­‰å¾…æ—¶é—´: ${maxWaitTime/1000}ç§’`)\r\n\r\n    const taskResult = await waitForTaskCompletion(promptId, maxWaitTime)\r\n    console.log('âœ… æ¢è„¸ä»»åŠ¡å¤„ç†å®Œæˆï¼Œç»“æœ:', taskResult)\r\n\r\n    if (onProgress) onProgress('æ­£åœ¨è·å–å¤„ç†ç»“æœ...', 95)\r\n\r\n    // è·å–ç»“æœå›¾ç‰‡\r\n    // æ ¹æ®æœ€æ–°å·¥ä½œæµï¼Œæœ€ç»ˆç»“æœåº”è¯¥åœ¨èŠ‚ç‚¹812çš„è¾“å‡º\r\n    console.log('ğŸ“¥ å¼€å§‹è·å–æ¢è„¸ç»“æœå›¾ç‰‡ï¼ŒæŸ¥æ‰¾èŠ‚ç‚¹812çš„è¾“å‡º...')\r\n    console.log('ğŸ” ä»»åŠ¡ç»“æœç»“æ„:', JSON.stringify(taskResult, null, 2))\r\n\r\n    const imageUrl = await getGeneratedImage(taskResult)\r\n    console.log('ğŸ–¼ï¸ æˆåŠŸè·å–æ¢è„¸ç»“æœå›¾ç‰‡URL')\r\n\r\n    // æ¶ˆè€—ä½“éªŒç‚¹\r\n    console.log('ğŸ’ æ¶ˆè€—ä½“éªŒç‚¹...')\r\n    const pointsResult = pointsManager.consumePoints()\r\n    console.log(`âœ… å·²æ¶ˆè€— ${pointsResult.consumed} ä½“éªŒç‚¹ï¼Œå‰©ä½™: ${pointsResult.remaining}`)\r\n\r\n    if (onProgress) onProgress('æ¢è„¸å®Œæˆï¼', 100)\r\n\r\n    console.log('âœ… æ¢è„¸å¤„ç†å®Œæˆ')\r\n    return {\r\n      success: true,\r\n      imageUrl: imageUrl,\r\n      targetImageUrl: targetImage, // è¿”å›ç›®æ ‡å›¾åƒç”¨äºå¯¹æ¯”\r\n      promptId: promptId,\r\n      pointsConsumed: pointsResult.consumed,\r\n      pointsRemaining: pointsResult.remaining,\r\n      message: 'æ¢è„¸å¤„ç†å®Œæˆ'\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('âŒ æ¢è„¸å¤„ç†å¤±è´¥:', error)\r\n    return {\r\n      success: false,\r\n      error: error.message,\r\n      message: 'æ¢è„¸å¤„ç†å¤±è´¥'\r\n    }\r\n  }\r\n}\r\n\r\n// å¯¼å‡ºæ‰€æœ‰å…¬å…±å‡½æ•°\r\nexport {\r\n  getCurrentConfig,\r\n  updateComfyUIConfig,\r\n  resetToDefaultConfig,\r\n  generateClientId,\r\n  getApiBaseUrl,\r\n  addConfigChangeListener,\r\n  removeConfigChangeListener,\r\n  processUndressImage,\r\n  processFaceSwapImage\r\n}\r\n"
        }
    ]
}