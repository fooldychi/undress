{
    "sourceFile": "client/src/services/api.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1752283330589,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752283685636,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -346,6 +346,84 @@\n     return localStorage.getItem('auth_token')\r\n   }\r\n }\r\n \r\n+// 积分API\r\n+export const pointsApi = {\r\n+  // 获取用户积分信息\r\n+  getUserPoints: async () => {\r\n+    try {\r\n+      const response = await makeBackendRequest('/api/level-cards/user-points', {\r\n+        method: 'GET'\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('获取积分信息失败:', error)\r\n+      throw error\r\n+    }\r\n+  },\r\n+\r\n+  // 获取积分使用记录\r\n+  getPointsHistory: async (page = 1, limit = 20, recent = false) => {\r\n+    try {\r\n+      const params = new URLSearchParams({\r\n+        page: page.toString(),\r\n+        limit: limit.toString(),\r\n+        recent: recent.toString()\r\n+      })\r\n+\r\n+      const response = await makeBackendRequest(`/api/level-cards/point-logs?${params}`, {\r\n+        method: 'GET'\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('获取积分记录失败:', error)\r\n+      throw error\r\n+    }\r\n+  },\r\n+\r\n+  // 获取用户绑定的等级卡信息\r\n+  getUserCards: async () => {\r\n+    try {\r\n+      const response = await makeBackendRequest('/api/level-cards/my-cards', {\r\n+        method: 'GET'\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('获取等级卡信息失败:', error)\r\n+      throw error\r\n+    }\r\n+  }\r\n+}\r\n+\r\n+// 用户API\r\n+export const userApi = {\r\n+  // 获取用户详细信息\r\n+  getUserProfile: async (userId) => {\r\n+    try {\r\n+      const response = await makeBackendRequest(`/api/users/${userId}`, {\r\n+        method: 'GET'\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('获取用户详细信息失败:', error)\r\n+      throw error\r\n+    }\r\n+  },\r\n+\r\n+  // 更新用户信息\r\n+  updateUserProfile: async (userId, userData) => {\r\n+    try {\r\n+      const response = await makeBackendRequest(`/api/users/${userId}`, {\r\n+        method: 'PUT',\r\n+        body: JSON.stringify(userData)\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('更新用户信息失败:', error)\r\n+      throw error\r\n+    }\r\n+  }\r\n+}\r\n+\r\n // 导出配置，方便其他地方使用\r\n export { API_CONFIG, BACKEND_API_CONFIG }\r\n"
                },
                {
                    "date": 1752284310050,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,10 +12,10 @@\n }\r\n \r\n // 后端API服务配置\r\n const BACKEND_API_CONFIG = {\r\n-  // 后端服务器URL\r\n-  BASE_URL: 'http://localhost:3006',\r\n+  // 后端服务器URL - 使用代理，开发环境下会自动转发到 http://localhost:3006\r\n+  BASE_URL: '',\r\n   // 请求超时时间（毫秒）\r\n   TIMEOUT: 30000 // 30秒\r\n }\r\n \r\n"
                },
                {
                    "date": 1752286274624,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -394,8 +394,64 @@\n     }\r\n   }\r\n }\r\n \r\n+// 等级卡API\r\n+export const levelCardApi = {\r\n+  // 获取等级卡类型列表\r\n+  getCardTypes: async () => {\r\n+    try {\r\n+      const response = await makeBackendRequest('/api/level-cards/types', {\r\n+        method: 'GET'\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('获取等级卡类型失败:', error)\r\n+      throw error\r\n+    }\r\n+  },\r\n+\r\n+  // 绑定等级卡\r\n+  bindCard: async (cardNumber, cardPassword) => {\r\n+    try {\r\n+      const response = await makeBackendRequest('/api/level-cards/bind', {\r\n+        method: 'POST',\r\n+        body: JSON.stringify({ cardNumber, cardPassword })\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('绑定等级卡失败:', error)\r\n+      throw error\r\n+    }\r\n+  },\r\n+\r\n+  // 获取用户绑定的等级卡列表\r\n+  getMyCards: async () => {\r\n+    try {\r\n+      const response = await makeBackendRequest('/api/level-cards/my-cards', {\r\n+        method: 'GET'\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('获取我的等级卡失败:', error)\r\n+      throw error\r\n+    }\r\n+  },\r\n+\r\n+  // 获取用户积分信息（基于等级卡）\r\n+  getUserPoints: async () => {\r\n+    try {\r\n+      const response = await makeBackendRequest('/api/level-cards/user-points', {\r\n+        method: 'GET'\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('获取用户积分失败:', error)\r\n+      throw error\r\n+    }\r\n+  }\r\n+}\r\n+\r\n // 用户API\r\n export const userApi = {\r\n   // 获取用户详细信息\r\n   getUserProfile: async (userId) => {\r\n"
                },
                {
                    "date": 1752286498154,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -391,8 +391,22 @@\n     } catch (error) {\r\n       console.error('获取等级卡信息失败:', error)\r\n       throw error\r\n     }\r\n+  },\r\n+\r\n+  // 消耗积分\r\n+  consumePoints: async (amount, description = '积分消费', mediaUrl = null) => {\r\n+    try {\r\n+      const response = await makeBackendRequest('/api/level-cards/consume-points', {\r\n+        method: 'POST',\r\n+        body: JSON.stringify({ amount, description, mediaUrl })\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('消耗积分失败:', error)\r\n+      throw error\r\n+    }\r\n   }\r\n }\r\n \r\n // 等级卡API\r\n"
                }
            ],
            "date": 1752283330589,
            "name": "Commit-0",
            "content": "// 导入ComfyUI工作流服务\r\nimport { processUndressImage } from './comfyui.js'\r\n\r\n// ComfyUI API服务配置\r\nconst API_CONFIG = {\r\n  // ComfyUI服务器URL\r\n  BASE_URL: 'https://dzqgp58z0s-8188.cnb.run',\r\n  // 客户端ID，用于标识请求来源\r\n  CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n  // 请求超时时间（毫秒）\r\n  TIMEOUT: 300000 // 5分钟\r\n}\r\n\r\n// 后端API服务配置\r\nconst BACKEND_API_CONFIG = {\r\n  // 后端服务器URL\r\n  BASE_URL: 'http://localhost:3006',\r\n  // 请求超时时间（毫秒）\r\n  TIMEOUT: 30000 // 30秒\r\n}\r\n\r\n// 通用请求函数\r\nasync function makeRequest(endpoint, options = {}) {\r\n  const url = `${API_CONFIG.BASE_URL}${endpoint}`\r\n\r\n  const defaultOptions = {\r\n    method: 'POST',\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n      ...(API_CONFIG.API_KEY && { 'Authorization': `Bearer ${API_CONFIG.API_KEY}` })\r\n    },\r\n    ...options\r\n  }\r\n\r\n  try {\r\n    const controller = new AbortController()\r\n    const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.TIMEOUT)\r\n\r\n    const response = await fetch(url, {\r\n      ...defaultOptions,\r\n      signal: controller.signal\r\n    })\r\n\r\n    clearTimeout(timeoutId)\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`HTTP error! status: ${response.status}`)\r\n    }\r\n\r\n    return await response.json()\r\n  } catch (error) {\r\n    if (error.name === 'AbortError') {\r\n      throw new Error('请求超时，请稍后重试')\r\n    }\r\n    throw new Error(`请求失败: ${error.message}`)\r\n  }\r\n}\r\n\r\n// 将Base64图片转换为Blob\r\nfunction base64ToBlob(base64Data) {\r\n  const byteCharacters = atob(base64Data.split(',')[1])\r\n  const byteNumbers = new Array(byteCharacters.length)\r\n\r\n  for (let i = 0; i < byteCharacters.length; i++) {\r\n    byteNumbers[i] = byteCharacters.charCodeAt(i)\r\n  }\r\n\r\n  const byteArray = new Uint8Array(byteNumbers)\r\n  return new Blob([byteArray], { type: 'image/jpeg' })\r\n}\r\n\r\n// 模拟API响应（用于开发测试）\r\nfunction createMockResponse(type) {\r\n  // 这里返回一个模拟的base64图片数据\r\n  // 在实际部署时，这些函数会被真实的API调用替换\r\n  const mockImageBase64 = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k='\r\n\r\n  return new Promise((resolve) => {\r\n    setTimeout(() => {\r\n      resolve({\r\n        success: true,\r\n        resultImage: mockImageBase64,\r\n        message: `${type}处理完成`\r\n      })\r\n    }, 2000) // 模拟2秒处理时间\r\n  })\r\n}\r\n\r\nexport const comfyApi = {\r\n  // 一键换衣API - 使用真实的ComfyUI工作流\r\n  clothesSwap: async (imageData) => {\r\n    try {\r\n      console.log('调用一键换衣API...')\r\n\r\n      // 调用ComfyUI工作流处理\r\n      const result = await processUndressImage(imageData)\r\n\r\n      if (result.success) {\r\n        return {\r\n          success: true,\r\n          resultImage: result.resultImage,\r\n          promptId: result.promptId,\r\n          message: result.message\r\n        }\r\n      } else {\r\n        throw new Error(result.error || '处理失败')\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('换衣API调用失败:', error)\r\n\r\n      // 如果是开发环境，回退到模拟响应\r\n      if (import.meta.env.DEV) {\r\n        console.log('回退到开发模式模拟响应')\r\n        return await createMockResponse('换衣')\r\n      }\r\n\r\n      throw error\r\n    }\r\n  },\r\n\r\n  // 文生图API\r\n  textToImage: async ({ prompt, size = '512x512', style = 'realistic' }) => {\r\n    try {\r\n      // 在开发环境中使用模拟响应\r\n      if (import.meta.env.DEV) {\r\n        console.log('开发模式：使用模拟文生图API', { prompt, size, style })\r\n        return await createMockResponse('文生图')\r\n      }\r\n\r\n      // 生产环境中的真实API调用\r\n      const [width, height] = size.split('x').map(Number)\r\n\r\n      const response = await makeRequest('/api/text-to-image', {\r\n        body: JSON.stringify({\r\n          prompt,\r\n          width,\r\n          height,\r\n          style,\r\n          // ComfyUI工作流参数\r\n          workflow_id: 'text_to_image_workflow',\r\n          parameters: {\r\n            steps: 20,\r\n            cfg_scale: 7.5,\r\n            sampler: 'euler_a',\r\n            seed: -1 // 随机种子\r\n          }\r\n        })\r\n      })\r\n\r\n      return response\r\n    } catch (error) {\r\n      console.error('文生图API调用失败:', error)\r\n      throw error\r\n    }\r\n  },\r\n\r\n  // 换脸API\r\n  faceSwap: async ({ sourceImage, targetImage, preserveExpression = true, enhanceQuality = false }) => {\r\n    try {\r\n      // 在开发环境中使用模拟响应\r\n      if (import.meta.env.DEV) {\r\n        console.log('开发模式：使用模拟换脸API', { preserveExpression, enhanceQuality })\r\n        return await createMockResponse('换脸')\r\n      }\r\n\r\n      // 生产环境中的真实API调用\r\n      const response = await makeRequest('/api/face-swap', {\r\n        body: JSON.stringify({\r\n          source_image: sourceImage,\r\n          target_image: targetImage,\r\n          // ComfyUI工作流参数\r\n          workflow_id: 'face_swap_workflow',\r\n          parameters: {\r\n            preserve_expression: preserveExpression,\r\n            enhance_quality: enhanceQuality,\r\n            blend_ratio: 0.8,\r\n            face_detection_threshold: 0.5\r\n          }\r\n        })\r\n      })\r\n\r\n      return response\r\n    } catch (error) {\r\n      console.error('换脸API调用失败:', error)\r\n      throw error\r\n    }\r\n  },\r\n\r\n  // 获取工作流状态\r\n  getWorkflowStatus: async (taskId) => {\r\n    try {\r\n      const response = await makeRequest(`/api/status/${taskId}`, {\r\n        method: 'GET'\r\n      })\r\n      return response\r\n    } catch (error) {\r\n      console.error('获取工作流状态失败:', error)\r\n      throw error\r\n    }\r\n  },\r\n\r\n  // 获取可用的工作流列表\r\n  getAvailableWorkflows: async () => {\r\n    try {\r\n      const response = await makeRequest('/api/workflows', {\r\n        method: 'GET'\r\n      })\r\n      return response\r\n    } catch (error) {\r\n      console.error('获取工作流列表失败:', error)\r\n      throw error\r\n    }\r\n  }\r\n}\r\n\r\n// 后端API请求函数\r\nasync function makeBackendRequest(endpoint, options = {}) {\r\n  const url = `${BACKEND_API_CONFIG.BASE_URL}${endpoint}`\r\n\r\n  const defaultOptions = {\r\n    method: 'POST',\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n    },\r\n    ...options\r\n  }\r\n\r\n  // 添加认证token（如果存在）\r\n  const token = localStorage.getItem('auth_token')\r\n  if (token) {\r\n    defaultOptions.headers.Authorization = `Bearer ${token}`\r\n  }\r\n\r\n  try {\r\n    const controller = new AbortController()\r\n    const timeoutId = setTimeout(() => controller.abort(), BACKEND_API_CONFIG.TIMEOUT)\r\n\r\n    const response = await fetch(url, {\r\n      ...defaultOptions,\r\n      signal: controller.signal\r\n    })\r\n\r\n    clearTimeout(timeoutId)\r\n\r\n    const data = await response.json()\r\n\r\n    if (!response.ok) {\r\n      throw new Error(data.message || `HTTP error! status: ${response.status}`)\r\n    }\r\n\r\n    return data\r\n  } catch (error) {\r\n    if (error.name === 'AbortError') {\r\n      throw new Error('请求超时，请稍后重试')\r\n    }\r\n    throw new Error(`请求失败: ${error.message}`)\r\n  }\r\n}\r\n\r\n// 认证API\r\nexport const authApi = {\r\n  // 用户注册\r\n  register: async (username, password) => {\r\n    try {\r\n      const response = await makeBackendRequest('/api/auth/register', {\r\n        method: 'POST',\r\n        body: JSON.stringify({ username, password })\r\n      })\r\n\r\n      // 注册成功后自动保存token\r\n      if (response.success && response.data.token) {\r\n        localStorage.setItem('auth_token', response.data.token)\r\n        localStorage.setItem('user_info', JSON.stringify(response.data.user))\r\n      }\r\n\r\n      return response\r\n    } catch (error) {\r\n      console.error('注册失败:', error)\r\n      throw error\r\n    }\r\n  },\r\n\r\n  // 用户登录\r\n  login: async (username, password) => {\r\n    try {\r\n      const response = await makeBackendRequest('/api/auth/login', {\r\n        method: 'POST',\r\n        body: JSON.stringify({ username, password })\r\n      })\r\n\r\n      // 登录成功后保存token和用户信息\r\n      if (response.success && response.data.token) {\r\n        localStorage.setItem('auth_token', response.data.token)\r\n        localStorage.setItem('user_info', JSON.stringify(response.data.user))\r\n      }\r\n\r\n      return response\r\n    } catch (error) {\r\n      console.error('登录失败:', error)\r\n      throw error\r\n    }\r\n  },\r\n\r\n  // 获取当前用户信息\r\n  getCurrentUser: async () => {\r\n    try {\r\n      const response = await makeBackendRequest('/api/auth/me', {\r\n        method: 'GET'\r\n      })\r\n\r\n      // 更新本地存储的用户信息\r\n      if (response.success && response.data.user) {\r\n        localStorage.setItem('user_info', JSON.stringify(response.data.user))\r\n      }\r\n\r\n      return response\r\n    } catch (error) {\r\n      console.error('获取用户信息失败:', error)\r\n      throw error\r\n    }\r\n  },\r\n\r\n  // 退出登录\r\n  logout: () => {\r\n    localStorage.removeItem('auth_token')\r\n    localStorage.removeItem('user_info')\r\n    return Promise.resolve({ success: true, message: '退出登录成功' })\r\n  },\r\n\r\n  // 检查是否已登录\r\n  isLoggedIn: () => {\r\n    const token = localStorage.getItem('auth_token')\r\n    const userInfo = localStorage.getItem('user_info')\r\n    return !!(token && userInfo)\r\n  },\r\n\r\n  // 获取本地存储的用户信息\r\n  getLocalUserInfo: () => {\r\n    const userInfo = localStorage.getItem('user_info')\r\n    return userInfo ? JSON.parse(userInfo) : null\r\n  },\r\n\r\n  // 获取认证token\r\n  getToken: () => {\r\n    return localStorage.getItem('auth_token')\r\n  }\r\n}\r\n\r\n// 导出配置，方便其他地方使用\r\nexport { API_CONFIG, BACKEND_API_CONFIG }\r\n"
        }
    ]
}