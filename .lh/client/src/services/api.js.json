{
    "sourceFile": "client/src/services/api.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 17,
            "patches": [
                {
                    "date": 1752283330589,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752283685636,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -346,6 +346,84 @@\n     return localStorage.getItem('auth_token')\r\n   }\r\n }\r\n \r\n+// ç§¯åˆ†API\r\n+export const pointsApi = {\r\n+  // è·å–ç”¨æˆ·ç§¯åˆ†ä¿¡æ¯\r\n+  getUserPoints: async () => {\r\n+    try {\r\n+      const response = await makeBackendRequest('/api/level-cards/user-points', {\r\n+        method: 'GET'\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('è·å–ç§¯åˆ†ä¿¡æ¯å¤±è´¥:', error)\r\n+      throw error\r\n+    }\r\n+  },\r\n+\r\n+  // è·å–ç§¯åˆ†ä½¿ç”¨è®°å½•\r\n+  getPointsHistory: async (page = 1, limit = 20, recent = false) => {\r\n+    try {\r\n+      const params = new URLSearchParams({\r\n+        page: page.toString(),\r\n+        limit: limit.toString(),\r\n+        recent: recent.toString()\r\n+      })\r\n+\r\n+      const response = await makeBackendRequest(`/api/level-cards/point-logs?${params}`, {\r\n+        method: 'GET'\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('è·å–ç§¯åˆ†è®°å½•å¤±è´¥:', error)\r\n+      throw error\r\n+    }\r\n+  },\r\n+\r\n+  // è·å–ç”¨æˆ·ç»‘å®šçš„ç­‰çº§å¡ä¿¡æ¯\r\n+  getUserCards: async () => {\r\n+    try {\r\n+      const response = await makeBackendRequest('/api/level-cards/my-cards', {\r\n+        method: 'GET'\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('è·å–ç­‰çº§å¡ä¿¡æ¯å¤±è´¥:', error)\r\n+      throw error\r\n+    }\r\n+  }\r\n+}\r\n+\r\n+// ç”¨æˆ·API\r\n+export const userApi = {\r\n+  // è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯\r\n+  getUserProfile: async (userId) => {\r\n+    try {\r\n+      const response = await makeBackendRequest(`/api/users/${userId}`, {\r\n+        method: 'GET'\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯å¤±è´¥:', error)\r\n+      throw error\r\n+    }\r\n+  },\r\n+\r\n+  // æ›´æ–°ç”¨æˆ·ä¿¡æ¯\r\n+  updateUserProfile: async (userId, userData) => {\r\n+    try {\r\n+      const response = await makeBackendRequest(`/api/users/${userId}`, {\r\n+        method: 'PUT',\r\n+        body: JSON.stringify(userData)\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error)\r\n+      throw error\r\n+    }\r\n+  }\r\n+}\r\n+\r\n // å¯¼å‡ºé…ç½®ï¼Œæ–¹ä¾¿å…¶ä»–åœ°æ–¹ä½¿ç”¨\r\n export { API_CONFIG, BACKEND_API_CONFIG }\r\n"
                },
                {
                    "date": 1752284310050,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,10 +12,10 @@\n }\r\n \r\n // åç«¯APIæœåŠ¡é…ç½®\r\n const BACKEND_API_CONFIG = {\r\n-  // åç«¯æœåŠ¡å™¨URL\r\n-  BASE_URL: 'http://localhost:3006',\r\n+  // åç«¯æœåŠ¡å™¨URL - ä½¿ç”¨ä»£ç†ï¼Œå¼€å‘ç¯å¢ƒä¸‹ä¼šè‡ªåŠ¨è½¬å‘åˆ° http://localhost:3006\r\n+  BASE_URL: '',\r\n   // è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰\r\n   TIMEOUT: 30000 // 30ç§’\r\n }\r\n \r\n"
                },
                {
                    "date": 1752286274624,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -394,8 +394,64 @@\n     }\r\n   }\r\n }\r\n \r\n+// ç­‰çº§å¡API\r\n+export const levelCardApi = {\r\n+  // è·å–ç­‰çº§å¡ç±»å‹åˆ—è¡¨\r\n+  getCardTypes: async () => {\r\n+    try {\r\n+      const response = await makeBackendRequest('/api/level-cards/types', {\r\n+        method: 'GET'\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥:', error)\r\n+      throw error\r\n+    }\r\n+  },\r\n+\r\n+  // ç»‘å®šç­‰çº§å¡\r\n+  bindCard: async (cardNumber, cardPassword) => {\r\n+    try {\r\n+      const response = await makeBackendRequest('/api/level-cards/bind', {\r\n+        method: 'POST',\r\n+        body: JSON.stringify({ cardNumber, cardPassword })\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('ç»‘å®šç­‰çº§å¡å¤±è´¥:', error)\r\n+      throw error\r\n+    }\r\n+  },\r\n+\r\n+  // è·å–ç”¨æˆ·ç»‘å®šçš„ç­‰çº§å¡åˆ—è¡¨\r\n+  getMyCards: async () => {\r\n+    try {\r\n+      const response = await makeBackendRequest('/api/level-cards/my-cards', {\r\n+        method: 'GET'\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('è·å–æˆ‘çš„ç­‰çº§å¡å¤±è´¥:', error)\r\n+      throw error\r\n+    }\r\n+  },\r\n+\r\n+  // è·å–ç”¨æˆ·ç§¯åˆ†ä¿¡æ¯ï¼ˆåŸºäºç­‰çº§å¡ï¼‰\r\n+  getUserPoints: async () => {\r\n+    try {\r\n+      const response = await makeBackendRequest('/api/level-cards/user-points', {\r\n+        method: 'GET'\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('è·å–ç”¨æˆ·ç§¯åˆ†å¤±è´¥:', error)\r\n+      throw error\r\n+    }\r\n+  }\r\n+}\r\n+\r\n // ç”¨æˆ·API\r\n export const userApi = {\r\n   // è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯\r\n   getUserProfile: async (userId) => {\r\n"
                },
                {
                    "date": 1752286498154,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -391,8 +391,22 @@\n     } catch (error) {\r\n       console.error('è·å–ç­‰çº§å¡ä¿¡æ¯å¤±è´¥:', error)\r\n       throw error\r\n     }\r\n+  },\r\n+\r\n+  // æ¶ˆè€—ç§¯åˆ†\r\n+  consumePoints: async (amount, description = 'ç§¯åˆ†æ¶ˆè´¹', mediaUrl = null) => {\r\n+    try {\r\n+      const response = await makeBackendRequest('/api/level-cards/consume-points', {\r\n+        method: 'POST',\r\n+        body: JSON.stringify({ amount, description, mediaUrl })\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('æ¶ˆè€—ç§¯åˆ†å¤±è´¥:', error)\r\n+      throw error\r\n+    }\r\n   }\r\n }\r\n \r\n // ç­‰çº§å¡API\r\n"
                },
                {
                    "date": 1752319600494,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -242,12 +242,30 @@\n     })\r\n \r\n     clearTimeout(timeoutId)\r\n \r\n-    const data = await response.json()\r\n+    // æ£€æŸ¥å“åº”æ˜¯å¦æœ‰å†…å®¹\r\n+    const contentType = response.headers.get('content-type')\r\n+    let data = null\r\n \r\n+    if (contentType && contentType.includes('application/json')) {\r\n+      const text = await response.text()\r\n+      if (text) {\r\n+        try {\r\n+          data = JSON.parse(text)\r\n+        } catch (parseError) {\r\n+          throw new Error(`JSONè§£æå¤±è´¥: ${parseError.message}`)\r\n+        }\r\n+      } else {\r\n+        throw new Error('æœåŠ¡å™¨è¿”å›ç©ºå“åº”')\r\n+      }\r\n+    } else {\r\n+      const text = await response.text()\r\n+      throw new Error(`æœåŠ¡å™¨è¿”å›éJSONå“åº”: ${text}`)\r\n+    }\r\n+\r\n     if (!response.ok) {\r\n-      throw new Error(data.message || `HTTP error! status: ${response.status}`)\r\n+      throw new Error(data?.message || `HTTP error! status: ${response.status}`)\r\n     }\r\n \r\n     return data\r\n   } catch (error) {\r\n"
                },
                {
                    "date": 1752326739765,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,15 +1,24 @@\n // å¯¼å…¥ComfyUIå·¥ä½œæµæœåŠ¡\r\n-import { processUndressImage } from './comfyui.js'\r\n+import { processUndressImage, getCurrentConfig } from './comfyui.js'\r\n \r\n-// ComfyUI APIæœåŠ¡é…ç½®\r\n-const API_CONFIG = {\r\n-  // ComfyUIæœåŠ¡å™¨URL\r\n-  BASE_URL: 'https://dzqgp58z0s-8188.cnb.run',\r\n-  // å®¢æˆ·ç«¯IDï¼Œç”¨äºæ ‡è¯†è¯·æ±‚æ¥æº\r\n-  CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n-  // è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰\r\n-  TIMEOUT: 300000 // 5åˆ†é’Ÿ\r\n+// åŠ¨æ€è·å–ComfyUI APIé…ç½®\r\n+async function getAPIConfig() {\r\n+  try {\r\n+    const config = await getCurrentConfig();\r\n+    return {\r\n+      BASE_URL: config.COMFYUI_SERVER_URL,\r\n+      CLIENT_ID: config.CLIENT_ID,\r\n+      TIMEOUT: config.TIMEOUT || 300000\r\n+    };\r\n+  } catch (error) {\r\n+    console.warn('âš ï¸ è·å–åŠ¨æ€é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error);\r\n+    return {\r\n+      BASE_URL: 'https://dzqgp58z0s-8188.cnb.run',\r\n+      CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n+      TIMEOUT: 300000\r\n+    };\r\n+  }\r\n }\r\n \r\n // åç«¯APIæœåŠ¡é…ç½®\r\n const BACKEND_API_CONFIG = {\r\n"
                },
                {
                    "date": 1752326760218,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,18 +29,19 @@\n }\r\n \r\n // é€šç”¨è¯·æ±‚å‡½æ•°\r\n async function makeRequest(endpoint, options = {}) {\r\n-  const url = `${API_CONFIG.BASE_URL}${endpoint}`\r\n+  const apiConfig = await getAPIConfig();\r\n+  const url = `${apiConfig.BASE_URL}${endpoint}`;\r\n \r\n   const defaultOptions = {\r\n     method: 'POST',\r\n     headers: {\r\n       'Content-Type': 'application/json',\r\n-      ...(API_CONFIG.API_KEY && { 'Authorization': `Bearer ${API_CONFIG.API_KEY}` })\r\n+      ...(apiConfig.API_KEY && { 'Authorization': `Bearer ${apiConfig.API_KEY}` })\r\n     },\r\n     ...options\r\n-  }\r\n+  };\r\n \r\n   try {\r\n     const controller = new AbortController()\r\n     const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.TIMEOUT)\r\n"
                },
                {
                    "date": 1752327165690,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -523,5 +523,5 @@\n   }\r\n }\r\n \r\n // å¯¼å‡ºé…ç½®ï¼Œæ–¹ä¾¿å…¶ä»–åœ°æ–¹ä½¿ç”¨\r\n-export { API_CONFIG, BACKEND_API_CONFIG }\r\n+export { getAPIConfig, BACKEND_API_CONFIG }\r\n"
                },
                {
                    "date": 1752327206043,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -43,9 +43,9 @@\n   };\r\n \r\n   try {\r\n     const controller = new AbortController()\r\n-    const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.TIMEOUT)\r\n+    const timeoutId = setTimeout(() => controller.abort(), apiConfig.TIMEOUT)\r\n \r\n     const response = await fetch(url, {\r\n       ...defaultOptions,\r\n       signal: controller.signal\r\n"
                },
                {
                    "date": 1752327454762,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,13 +10,13 @@\n       CLIENT_ID: config.CLIENT_ID,\r\n       TIMEOUT: config.TIMEOUT || 300000\r\n     };\r\n   } catch (error) {\r\n-    console.warn('âš ï¸ è·å–åŠ¨æ€é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error);\r\n+    console.warn('âš ï¸ è·å–åŠ¨æ€é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤é…ç½®:', error);\r\n     return {\r\n-      BASE_URL: 'https://dzqgp58z0s-8188.cnb.run',\r\n-      CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n-      TIMEOUT: 300000\r\n+      BASE_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://your-comfyui-server.com',\r\n+      CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'your-comfyui-client-id',\r\n+      TIMEOUT: parseInt(import.meta.env.VITE_COMFYUI_TIMEOUT) || 300000\r\n     };\r\n   }\r\n }\r\n \r\n"
                },
                {
                    "date": 1752328900503,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,24 +1,15 @@\n // å¯¼å…¥ComfyUIå·¥ä½œæµæœåŠ¡\r\n-import { processUndressImage, getCurrentConfig } from './comfyui.js'\r\n+import { processUndressImage } from './comfyui.js'\r\n \r\n-// åŠ¨æ€è·å–ComfyUI APIé…ç½®\r\n-async function getAPIConfig() {\r\n-  try {\r\n-    const config = await getCurrentConfig();\r\n-    return {\r\n-      BASE_URL: config.COMFYUI_SERVER_URL,\r\n-      CLIENT_ID: config.CLIENT_ID,\r\n-      TIMEOUT: config.TIMEOUT || 300000\r\n-    };\r\n-  } catch (error) {\r\n-    console.warn('âš ï¸ è·å–åŠ¨æ€é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤é…ç½®:', error);\r\n-    return {\r\n-      BASE_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://your-comfyui-server.com',\r\n-      CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'your-comfyui-client-id',\r\n-      TIMEOUT: parseInt(import.meta.env.VITE_COMFYUI_TIMEOUT) || 300000\r\n-    };\r\n-  }\r\n+// ComfyUI APIæœåŠ¡é…ç½®\r\n+const API_CONFIG = {\r\n+  // ComfyUIæœåŠ¡å™¨URL\r\n+  BASE_URL: 'https://dzqgp58z0s-8188.cnb.run',\r\n+  // å®¢æˆ·ç«¯IDï¼Œç”¨äºæ ‡è¯†è¯·æ±‚æ¥æº\r\n+  CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n+  // è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰\r\n+  TIMEOUT: 300000 // 5åˆ†é’Ÿ\r\n }\r\n \r\n // åç«¯APIæœåŠ¡é…ç½®\r\n const BACKEND_API_CONFIG = {\r\n@@ -29,23 +20,22 @@\n }\r\n \r\n // é€šç”¨è¯·æ±‚å‡½æ•°\r\n async function makeRequest(endpoint, options = {}) {\r\n-  const apiConfig = await getAPIConfig();\r\n-  const url = `${apiConfig.BASE_URL}${endpoint}`;\r\n+  const url = `${API_CONFIG.BASE_URL}${endpoint}`\r\n \r\n   const defaultOptions = {\r\n     method: 'POST',\r\n     headers: {\r\n       'Content-Type': 'application/json',\r\n-      ...(apiConfig.API_KEY && { 'Authorization': `Bearer ${apiConfig.API_KEY}` })\r\n+      ...(API_CONFIG.API_KEY && { 'Authorization': `Bearer ${API_CONFIG.API_KEY}` })\r\n     },\r\n     ...options\r\n-  };\r\n+  }\r\n \r\n   try {\r\n     const controller = new AbortController()\r\n-    const timeoutId = setTimeout(() => controller.abort(), apiConfig.TIMEOUT)\r\n+    const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.TIMEOUT)\r\n \r\n     const response = await fetch(url, {\r\n       ...defaultOptions,\r\n       signal: controller.signal\r\n@@ -523,5 +513,5 @@\n   }\r\n }\r\n \r\n // å¯¼å‡ºé…ç½®ï¼Œæ–¹ä¾¿å…¶ä»–åœ°æ–¹ä½¿ç”¨\r\n-export { getAPIConfig, BACKEND_API_CONFIG }\r\n+export { API_CONFIG, BACKEND_API_CONFIG }\r\n"
                },
                {
                    "date": 1752330137851,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,13 +1,13 @@\n // å¯¼å…¥ComfyUIå·¥ä½œæµæœåŠ¡\r\n import { processUndressImage } from './comfyui.js'\r\n \r\n-// ComfyUI APIæœåŠ¡é…ç½®\r\n+// ComfyUI APIæœåŠ¡é…ç½® - å°†ä½¿ç”¨åŠ¨æ€é…ç½®\r\n const API_CONFIG = {\r\n-  // ComfyUIæœåŠ¡å™¨URL\r\n-  BASE_URL: 'https://dzqgp58z0s-8188.cnb.run',\r\n+  // ComfyUIæœåŠ¡å™¨URL - å°†ä»é…ç½®æœåŠ¡è·å–\r\n+  BASE_URL: 'https://dzqgp58z0s-8188.cnb.run', // é»˜è®¤å€¼ï¼Œå°†è¢«é…ç½®æœåŠ¡è¦†ç›–\r\n   // å®¢æˆ·ç«¯IDï¼Œç”¨äºæ ‡è¯†è¯·æ±‚æ¥æº\r\n-  CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n+  CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b', // é»˜è®¤å€¼ï¼Œå°†è¢«é…ç½®æœåŠ¡è¦†ç›–\r\n   // è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰\r\n   TIMEOUT: 300000 // 5åˆ†é’Ÿ\r\n }\r\n \r\n"
                },
                {
                    "date": 1752330153488,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -512,6 +512,22 @@\n     }\r\n   }\r\n }\r\n \r\n+// æ›´æ–°APIé…ç½®çš„å‡½æ•°\r\n+export function updateAPIConfig(newConfig) {\r\n+  if (newConfig.COMFYUI_SERVER_URL) {\r\n+    API_CONFIG.BASE_URL = newConfig.COMFYUI_SERVER_URL\r\n+    console.log('ğŸ”„ API_CONFIG.BASE_URL å·²æ›´æ–°ä¸º:', API_CONFIG.BASE_URL)\r\n+  }\r\n+  if (newConfig.CLIENT_ID) {\r\n+    API_CONFIG.CLIENT_ID = newConfig.CLIENT_ID\r\n+    console.log('ğŸ”„ API_CONFIG.CLIENT_ID å·²æ›´æ–°ä¸º:', API_CONFIG.CLIENT_ID)\r\n+  }\r\n+  if (newConfig.TIMEOUT) {\r\n+    API_CONFIG.TIMEOUT = newConfig.TIMEOUT\r\n+    console.log('ğŸ”„ API_CONFIG.TIMEOUT å·²æ›´æ–°ä¸º:', API_CONFIG.TIMEOUT)\r\n+  }\r\n+}\r\n+\r\n // å¯¼å‡ºé…ç½®ï¼Œæ–¹ä¾¿å…¶ä»–åœ°æ–¹ä½¿ç”¨\r\n export { API_CONFIG, BACKEND_API_CONFIG }\r\n"
                },
                {
                    "date": 1752345878320,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -271,8 +271,22 @@\n   } catch (error) {\r\n     if (error.name === 'AbortError') {\r\n       throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•')\r\n     }\r\n+\r\n+    // å¤„ç†ç½‘ç»œè¿æ¥é”™è¯¯\r\n+    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {\r\n+      throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€')\r\n+    }\r\n+\r\n+    // å¤„ç†è®¤è¯é”™è¯¯\r\n+    if (error.message.includes('è®¤è¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯') || error.message.includes('401')) {\r\n+      // æ¸…é™¤æ— æ•ˆçš„token\r\n+      localStorage.removeItem('auth_token')\r\n+      localStorage.removeItem('user_info')\r\n+      throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•')\r\n+    }\r\n+\r\n     throw new Error(`è¯·æ±‚å¤±è´¥: ${error.message}`)\r\n   }\r\n }\r\n \r\n"
                },
                {
                    "date": 1752345930904,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -440,8 +440,24 @@\n     }\r\n   }\r\n }\r\n \r\n+// ç³»ç»ŸAPI\r\n+export const systemApi = {\r\n+  // å¥åº·æ£€æŸ¥\r\n+  healthCheck: async () => {\r\n+    try {\r\n+      const response = await makeBackendRequest('/api/level-cards/types', {\r\n+        method: 'GET'\r\n+      })\r\n+      return response\r\n+    } catch (error) {\r\n+      console.error('å¥åº·æ£€æŸ¥å¤±è´¥:', error)\r\n+      throw error\r\n+    }\r\n+  }\r\n+}\r\n+\r\n // ç­‰çº§å¡API\r\n export const levelCardApi = {\r\n   // è·å–ç­‰çº§å¡ç±»å‹åˆ—è¡¨\r\n   getCardTypes: async () => {\r\n"
                },
                {
                    "date": 1752345944319,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -213,10 +213,10 @@\n     }\r\n   }\r\n }\r\n \r\n-// åç«¯APIè¯·æ±‚å‡½æ•°\r\n-async function makeBackendRequest(endpoint, options = {}) {\r\n+// åç«¯APIè¯·æ±‚å‡½æ•°ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰\r\n+async function makeBackendRequest(endpoint, options = {}, retryCount = 0) {\r\n   const url = `${BACKEND_API_CONFIG.BASE_URL}${endpoint}`\r\n \r\n   const defaultOptions = {\r\n     method: 'POST',\r\n"
                },
                {
                    "date": 1752345962457,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -272,9 +272,15 @@\n     if (error.name === 'AbortError') {\r\n       throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•')\r\n     }\r\n \r\n-    // å¤„ç†ç½‘ç»œè¿æ¥é”™è¯¯\r\n+    // å¤„ç†ç½‘ç»œè¿æ¥é”™è¯¯ - å°è¯•é‡è¯•\r\n+    if ((error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) && retryCount < 2) {\r\n+      console.log(`ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•... (${retryCount + 1}/3)`)\r\n+      await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1))) // é€’å¢å»¶è¿Ÿ\r\n+      return makeBackendRequest(endpoint, options, retryCount + 1)\r\n+    }\r\n+\r\n     if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {\r\n       throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€')\r\n     }\r\n \r\n"
                }
            ],
            "date": 1752283330589,
            "name": "Commit-0",
            "content": "// å¯¼å…¥ComfyUIå·¥ä½œæµæœåŠ¡\r\nimport { processUndressImage } from './comfyui.js'\r\n\r\n// ComfyUI APIæœåŠ¡é…ç½®\r\nconst API_CONFIG = {\r\n  // ComfyUIæœåŠ¡å™¨URL\r\n  BASE_URL: 'https://dzqgp58z0s-8188.cnb.run',\r\n  // å®¢æˆ·ç«¯IDï¼Œç”¨äºæ ‡è¯†è¯·æ±‚æ¥æº\r\n  CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n  // è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰\r\n  TIMEOUT: 300000 // 5åˆ†é’Ÿ\r\n}\r\n\r\n// åç«¯APIæœåŠ¡é…ç½®\r\nconst BACKEND_API_CONFIG = {\r\n  // åç«¯æœåŠ¡å™¨URL\r\n  BASE_URL: 'http://localhost:3006',\r\n  // è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰\r\n  TIMEOUT: 30000 // 30ç§’\r\n}\r\n\r\n// é€šç”¨è¯·æ±‚å‡½æ•°\r\nasync function makeRequest(endpoint, options = {}) {\r\n  const url = `${API_CONFIG.BASE_URL}${endpoint}`\r\n\r\n  const defaultOptions = {\r\n    method: 'POST',\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n      ...(API_CONFIG.API_KEY && { 'Authorization': `Bearer ${API_CONFIG.API_KEY}` })\r\n    },\r\n    ...options\r\n  }\r\n\r\n  try {\r\n    const controller = new AbortController()\r\n    const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.TIMEOUT)\r\n\r\n    const response = await fetch(url, {\r\n      ...defaultOptions,\r\n      signal: controller.signal\r\n    })\r\n\r\n    clearTimeout(timeoutId)\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`HTTP error! status: ${response.status}`)\r\n    }\r\n\r\n    return await response.json()\r\n  } catch (error) {\r\n    if (error.name === 'AbortError') {\r\n      throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•')\r\n    }\r\n    throw new Error(`è¯·æ±‚å¤±è´¥: ${error.message}`)\r\n  }\r\n}\r\n\r\n// å°†Base64å›¾ç‰‡è½¬æ¢ä¸ºBlob\r\nfunction base64ToBlob(base64Data) {\r\n  const byteCharacters = atob(base64Data.split(',')[1])\r\n  const byteNumbers = new Array(byteCharacters.length)\r\n\r\n  for (let i = 0; i < byteCharacters.length; i++) {\r\n    byteNumbers[i] = byteCharacters.charCodeAt(i)\r\n  }\r\n\r\n  const byteArray = new Uint8Array(byteNumbers)\r\n  return new Blob([byteArray], { type: 'image/jpeg' })\r\n}\r\n\r\n// æ¨¡æ‹ŸAPIå“åº”ï¼ˆç”¨äºå¼€å‘æµ‹è¯•ï¼‰\r\nfunction createMockResponse(type) {\r\n  // è¿™é‡Œè¿”å›ä¸€ä¸ªæ¨¡æ‹Ÿçš„base64å›¾ç‰‡æ•°æ®\r\n  // åœ¨å®é™…éƒ¨ç½²æ—¶ï¼Œè¿™äº›å‡½æ•°ä¼šè¢«çœŸå®çš„APIè°ƒç”¨æ›¿æ¢\r\n  const mockImageBase64 = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k='\r\n\r\n  return new Promise((resolve) => {\r\n    setTimeout(() => {\r\n      resolve({\r\n        success: true,\r\n        resultImage: mockImageBase64,\r\n        message: `${type}å¤„ç†å®Œæˆ`\r\n      })\r\n    }, 2000) // æ¨¡æ‹Ÿ2ç§’å¤„ç†æ—¶é—´\r\n  })\r\n}\r\n\r\nexport const comfyApi = {\r\n  // ä¸€é”®æ¢è¡£API - ä½¿ç”¨çœŸå®çš„ComfyUIå·¥ä½œæµ\r\n  clothesSwap: async (imageData) => {\r\n    try {\r\n      console.log('è°ƒç”¨ä¸€é”®æ¢è¡£API...')\r\n\r\n      // è°ƒç”¨ComfyUIå·¥ä½œæµå¤„ç†\r\n      const result = await processUndressImage(imageData)\r\n\r\n      if (result.success) {\r\n        return {\r\n          success: true,\r\n          resultImage: result.resultImage,\r\n          promptId: result.promptId,\r\n          message: result.message\r\n        }\r\n      } else {\r\n        throw new Error(result.error || 'å¤„ç†å¤±è´¥')\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('æ¢è¡£APIè°ƒç”¨å¤±è´¥:', error)\r\n\r\n      // å¦‚æœæ˜¯å¼€å‘ç¯å¢ƒï¼Œå›é€€åˆ°æ¨¡æ‹Ÿå“åº”\r\n      if (import.meta.env.DEV) {\r\n        console.log('å›é€€åˆ°å¼€å‘æ¨¡å¼æ¨¡æ‹Ÿå“åº”')\r\n        return await createMockResponse('æ¢è¡£')\r\n      }\r\n\r\n      throw error\r\n    }\r\n  },\r\n\r\n  // æ–‡ç”Ÿå›¾API\r\n  textToImage: async ({ prompt, size = '512x512', style = 'realistic' }) => {\r\n    try {\r\n      // åœ¨å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨æ¨¡æ‹Ÿå“åº”\r\n      if (import.meta.env.DEV) {\r\n        console.log('å¼€å‘æ¨¡å¼ï¼šä½¿ç”¨æ¨¡æ‹Ÿæ–‡ç”Ÿå›¾API', { prompt, size, style })\r\n        return await createMockResponse('æ–‡ç”Ÿå›¾')\r\n      }\r\n\r\n      // ç”Ÿäº§ç¯å¢ƒä¸­çš„çœŸå®APIè°ƒç”¨\r\n      const [width, height] = size.split('x').map(Number)\r\n\r\n      const response = await makeRequest('/api/text-to-image', {\r\n        body: JSON.stringify({\r\n          prompt,\r\n          width,\r\n          height,\r\n          style,\r\n          // ComfyUIå·¥ä½œæµå‚æ•°\r\n          workflow_id: 'text_to_image_workflow',\r\n          parameters: {\r\n            steps: 20,\r\n            cfg_scale: 7.5,\r\n            sampler: 'euler_a',\r\n            seed: -1 // éšæœºç§å­\r\n          }\r\n        })\r\n      })\r\n\r\n      return response\r\n    } catch (error) {\r\n      console.error('æ–‡ç”Ÿå›¾APIè°ƒç”¨å¤±è´¥:', error)\r\n      throw error\r\n    }\r\n  },\r\n\r\n  // æ¢è„¸API\r\n  faceSwap: async ({ sourceImage, targetImage, preserveExpression = true, enhanceQuality = false }) => {\r\n    try {\r\n      // åœ¨å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨æ¨¡æ‹Ÿå“åº”\r\n      if (import.meta.env.DEV) {\r\n        console.log('å¼€å‘æ¨¡å¼ï¼šä½¿ç”¨æ¨¡æ‹Ÿæ¢è„¸API', { preserveExpression, enhanceQuality })\r\n        return await createMockResponse('æ¢è„¸')\r\n      }\r\n\r\n      // ç”Ÿäº§ç¯å¢ƒä¸­çš„çœŸå®APIè°ƒç”¨\r\n      const response = await makeRequest('/api/face-swap', {\r\n        body: JSON.stringify({\r\n          source_image: sourceImage,\r\n          target_image: targetImage,\r\n          // ComfyUIå·¥ä½œæµå‚æ•°\r\n          workflow_id: 'face_swap_workflow',\r\n          parameters: {\r\n            preserve_expression: preserveExpression,\r\n            enhance_quality: enhanceQuality,\r\n            blend_ratio: 0.8,\r\n            face_detection_threshold: 0.5\r\n          }\r\n        })\r\n      })\r\n\r\n      return response\r\n    } catch (error) {\r\n      console.error('æ¢è„¸APIè°ƒç”¨å¤±è´¥:', error)\r\n      throw error\r\n    }\r\n  },\r\n\r\n  // è·å–å·¥ä½œæµçŠ¶æ€\r\n  getWorkflowStatus: async (taskId) => {\r\n    try {\r\n      const response = await makeRequest(`/api/status/${taskId}`, {\r\n        method: 'GET'\r\n      })\r\n      return response\r\n    } catch (error) {\r\n      console.error('è·å–å·¥ä½œæµçŠ¶æ€å¤±è´¥:', error)\r\n      throw error\r\n    }\r\n  },\r\n\r\n  // è·å–å¯ç”¨çš„å·¥ä½œæµåˆ—è¡¨\r\n  getAvailableWorkflows: async () => {\r\n    try {\r\n      const response = await makeRequest('/api/workflows', {\r\n        method: 'GET'\r\n      })\r\n      return response\r\n    } catch (error) {\r\n      console.error('è·å–å·¥ä½œæµåˆ—è¡¨å¤±è´¥:', error)\r\n      throw error\r\n    }\r\n  }\r\n}\r\n\r\n// åç«¯APIè¯·æ±‚å‡½æ•°\r\nasync function makeBackendRequest(endpoint, options = {}) {\r\n  const url = `${BACKEND_API_CONFIG.BASE_URL}${endpoint}`\r\n\r\n  const defaultOptions = {\r\n    method: 'POST',\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n    },\r\n    ...options\r\n  }\r\n\r\n  // æ·»åŠ è®¤è¯tokenï¼ˆå¦‚æœå­˜åœ¨ï¼‰\r\n  const token = localStorage.getItem('auth_token')\r\n  if (token) {\r\n    defaultOptions.headers.Authorization = `Bearer ${token}`\r\n  }\r\n\r\n  try {\r\n    const controller = new AbortController()\r\n    const timeoutId = setTimeout(() => controller.abort(), BACKEND_API_CONFIG.TIMEOUT)\r\n\r\n    const response = await fetch(url, {\r\n      ...defaultOptions,\r\n      signal: controller.signal\r\n    })\r\n\r\n    clearTimeout(timeoutId)\r\n\r\n    const data = await response.json()\r\n\r\n    if (!response.ok) {\r\n      throw new Error(data.message || `HTTP error! status: ${response.status}`)\r\n    }\r\n\r\n    return data\r\n  } catch (error) {\r\n    if (error.name === 'AbortError') {\r\n      throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•')\r\n    }\r\n    throw new Error(`è¯·æ±‚å¤±è´¥: ${error.message}`)\r\n  }\r\n}\r\n\r\n// è®¤è¯API\r\nexport const authApi = {\r\n  // ç”¨æˆ·æ³¨å†Œ\r\n  register: async (username, password) => {\r\n    try {\r\n      const response = await makeBackendRequest('/api/auth/register', {\r\n        method: 'POST',\r\n        body: JSON.stringify({ username, password })\r\n      })\r\n\r\n      // æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨ä¿å­˜token\r\n      if (response.success && response.data.token) {\r\n        localStorage.setItem('auth_token', response.data.token)\r\n        localStorage.setItem('user_info', JSON.stringify(response.data.user))\r\n      }\r\n\r\n      return response\r\n    } catch (error) {\r\n      console.error('æ³¨å†Œå¤±è´¥:', error)\r\n      throw error\r\n    }\r\n  },\r\n\r\n  // ç”¨æˆ·ç™»å½•\r\n  login: async (username, password) => {\r\n    try {\r\n      const response = await makeBackendRequest('/api/auth/login', {\r\n        method: 'POST',\r\n        body: JSON.stringify({ username, password })\r\n      })\r\n\r\n      // ç™»å½•æˆåŠŸåä¿å­˜tokenå’Œç”¨æˆ·ä¿¡æ¯\r\n      if (response.success && response.data.token) {\r\n        localStorage.setItem('auth_token', response.data.token)\r\n        localStorage.setItem('user_info', JSON.stringify(response.data.user))\r\n      }\r\n\r\n      return response\r\n    } catch (error) {\r\n      console.error('ç™»å½•å¤±è´¥:', error)\r\n      throw error\r\n    }\r\n  },\r\n\r\n  // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯\r\n  getCurrentUser: async () => {\r\n    try {\r\n      const response = await makeBackendRequest('/api/auth/me', {\r\n        method: 'GET'\r\n      })\r\n\r\n      // æ›´æ–°æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯\r\n      if (response.success && response.data.user) {\r\n        localStorage.setItem('user_info', JSON.stringify(response.data.user))\r\n      }\r\n\r\n      return response\r\n    } catch (error) {\r\n      console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error)\r\n      throw error\r\n    }\r\n  },\r\n\r\n  // é€€å‡ºç™»å½•\r\n  logout: () => {\r\n    localStorage.removeItem('auth_token')\r\n    localStorage.removeItem('user_info')\r\n    return Promise.resolve({ success: true, message: 'é€€å‡ºç™»å½•æˆåŠŸ' })\r\n  },\r\n\r\n  // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•\r\n  isLoggedIn: () => {\r\n    const token = localStorage.getItem('auth_token')\r\n    const userInfo = localStorage.getItem('user_info')\r\n    return !!(token && userInfo)\r\n  },\r\n\r\n  // è·å–æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯\r\n  getLocalUserInfo: () => {\r\n    const userInfo = localStorage.getItem('user_info')\r\n    return userInfo ? JSON.parse(userInfo) : null\r\n  },\r\n\r\n  // è·å–è®¤è¯token\r\n  getToken: () => {\r\n    return localStorage.getItem('auth_token')\r\n  }\r\n}\r\n\r\n// å¯¼å‡ºé…ç½®ï¼Œæ–¹ä¾¿å…¶ä»–åœ°æ–¹ä½¿ç”¨\r\nexport { API_CONFIG, BACKEND_API_CONFIG }\r\n"
        }
    ]
}