{
    "sourceFile": "client/src/services/loadBalancer.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 134,
            "patches": [
                {
                    "date": 1752333548051,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752333570869,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -317,18 +317,36 @@\n       console.log(`ğŸ†˜ å¤‡ç”¨æœåŠ¡å™¨: ${fallbackServer}`)\n       return fallbackServer\n     }\n \n-    // å¦‚æœæ²¡æœ‰é…ç½®çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨é…ç½®æœåŠ¡çš„é»˜è®¤å€¼\n-    const config = await configService.getConfig()\n-    const defaultServer = config['comfyui.server_url']\n+    // å¦‚æœæ²¡æœ‰é…ç½®çš„æœåŠ¡å™¨ï¼Œå°è¯•å¤šç§æ–¹å¼è·å–é»˜è®¤å€¼\n+    try {\n+      const config = await configService.getConfig()\n+      const defaultServer = config['comfyui.server_url']\n \n-    if (defaultServer) {\n-      console.log(`ğŸ†˜ é»˜è®¤æœåŠ¡å™¨: ${defaultServer}`)\n-      return defaultServer\n+      if (defaultServer && defaultServer !== 'https://your-comfyui-server.com') {\n+        console.log(`ğŸ†˜ é…ç½®æœåŠ¡é»˜è®¤æœåŠ¡å™¨: ${defaultServer}`)\n+        return defaultServer\n+      }\n+    } catch (error) {\n+      console.warn('âš ï¸ æ— æ³•ä»é…ç½®æœåŠ¡è·å–é»˜è®¤æœåŠ¡å™¨:', error)\n     }\n \n-    throw new Error('æ²¡æœ‰å¯ç”¨çš„ ComfyUI æœåŠ¡å™¨')\n+    // ä»æœ¬åœ°å­˜å‚¨è·å–\n+    try {\n+      const localConfig = JSON.parse(localStorage.getItem('comfyui_config') || '{}')\n+      if (localConfig.COMFYUI_SERVER_URL) {\n+        console.log(`ğŸ†˜ æœ¬åœ°é…ç½®æœåŠ¡å™¨: ${localConfig.COMFYUI_SERVER_URL}`)\n+        return localConfig.COMFYUI_SERVER_URL\n+      }\n+    } catch (error) {\n+      console.warn('âš ï¸ æ— æ³•ä»æœ¬åœ°å­˜å‚¨è·å–æœåŠ¡å™¨é…ç½®:', error)\n+    }\n+\n+    // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆ\n+    const fallbackUrl = 'https://your-comfyui-server.com'\n+    console.log(`ğŸ†˜ ä½¿ç”¨æœ€åå¤‡ç”¨æœåŠ¡å™¨: ${fallbackUrl}`)\n+    return fallbackUrl\n   }\n \n   /**\n    * é”å®šæœåŠ¡å™¨\n"
                },
                {
                    "date": 1752411161286,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,12 +11,13 @@\n     this.serverLoads = new Map()\n     this.lockedServer = null\n     this.lastLockTime = 0\n     this.lockDuration = 30000 // 30ç§’é”å®šæ—¶é—´\n-    this.healthCheckTimeout = 10000 // 10ç§’å¥åº·æ£€æŸ¥è¶…æ—¶\n-    this.queueCheckTimeout = 5000 // 5ç§’é˜Ÿåˆ—æ£€æŸ¥è¶…æ—¶\n+    this.healthCheckTimeout = 15000 // 15ç§’å¥åº·æ£€æŸ¥è¶…æ—¶\n+    this.queueCheckTimeout = 8000 // 8ç§’é˜Ÿåˆ—æ£€æŸ¥è¶…æ—¶\n     this.lastUpdateTime = 0\n-    this.updateInterval = 15000 // 15ç§’æ›´æ–°é—´éš”\n+    this.updateInterval = 10000 // 10ç§’æ›´æ–°é—´éš”ï¼ˆæ›´é¢‘ç¹çš„æ›´æ–°ï¼‰\n+    this.forceUpdateThreshold = 30000 // 30ç§’å¼ºåˆ¶æ›´æ–°é˜ˆå€¼\n   }\n \n   /**\n    * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n"
                },
                {
                    "date": 1752411179957,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -90,17 +90,23 @@\n \n   /**\n    * æ›´æ–°æ‰€æœ‰æœåŠ¡å™¨çš„è´Ÿè½½ä¿¡æ¯\n    */\n-  async updateServerLoads() {\n+  async updateServerLoads(forceUpdate = false) {\n     const now = Date.now()\n \n-    // å¦‚æœè·ç¦»ä¸Šæ¬¡æ›´æ–°æ—¶é—´ä¸è¶³é—´éš”ï¼Œè·³è¿‡æ›´æ–°\n-    if (now - this.lastUpdateTime < this.updateInterval) {\n+    // å¦‚æœè·ç¦»ä¸Šæ¬¡æ›´æ–°æ—¶é—´ä¸è¶³é—´éš”ï¼Œè·³è¿‡æ›´æ–°ï¼ˆé™¤éå¼ºåˆ¶æ›´æ–°æˆ–è¶…è¿‡å¼ºåˆ¶æ›´æ–°é˜ˆå€¼ï¼‰\n+    if (!forceUpdate && now - this.lastUpdateTime < this.updateInterval && now - this.lastUpdateTime < this.forceUpdateThreshold) {\n       console.log('â­ï¸ è·³è¿‡è´Ÿè½½æ›´æ–°ï¼Œè·ç¦»ä¸Šæ¬¡æ›´æ–°æ—¶é—´ä¸è¶³')\n       return\n     }\n \n+    // å¦‚æœè¶…è¿‡å¼ºåˆ¶æ›´æ–°é˜ˆå€¼ï¼Œå¼ºåˆ¶æ›´æ–°\n+    if (now - this.lastUpdateTime > this.forceUpdateThreshold) {\n+      console.log('ğŸ”„ å¼ºåˆ¶æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯ï¼ˆè¶…è¿‡å¼ºåˆ¶æ›´æ–°é˜ˆå€¼ï¼‰')\n+      forceUpdate = true\n+    }\n+\n     console.log('ğŸ”„ æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯...')\n \n     const updatePromises = this.servers.map(async (server) => {\n       try {\n"
                },
                {
                    "date": 1752411196288,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -118,14 +118,18 @@\n \n         const health = healthResult.status === 'fulfilled' ? healthResult.value : { healthy: false }\n         const queue = queueResult.status === 'fulfilled' ? queueResult.value : { total: 999, healthy: false }\n \n+        // æ›´æ™ºèƒ½çš„å¥åº·çŠ¶æ€åˆ¤æ–­\n+        const isHealthy = this.determineServerHealth(health, queue, server)\n+\n         this.serverLoads.set(server.url, {\n           ...server,\n-          healthy: health.healthy && queue.healthy,\n+          healthy: isHealthy,\n           queue: queue,\n           lastCheck: now,\n-          responseTime: health.responseTime || 0\n+          responseTime: health.responseTime || 0,\n+          healthDetails: { health, queue }\n         })\n \n         console.log(`ğŸ“Š ${server.url}: å¥åº·=${health.healthy}, é˜Ÿåˆ—=${queue.total || 0}`)\n \n"
                },
                {
                    "date": 1752411215875,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -151,8 +151,33 @@\n     console.log('âœ… æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯æ›´æ–°å®Œæˆ')\n   }\n \n   /**\n+   * æ›´æ™ºèƒ½çš„æœåŠ¡å™¨å¥åº·çŠ¶æ€åˆ¤æ–­\n+   */\n+  determineServerHealth(health, queue, server) {\n+    // å¦‚æœå¥åº·æ£€æŸ¥å®Œå…¨å¤±è´¥ï¼Œæ ‡è®°ä¸ºä¸å¥åº·\n+    if (!health.healthy) {\n+      return false\n+    }\n+\n+    // å¦‚æœé˜Ÿåˆ—æ£€æŸ¥å¤±è´¥ä½†å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œä»ç„¶è®¤ä¸ºæœåŠ¡å™¨å¯ç”¨\n+    // è¿™æ ·å¯ä»¥é¿å…å› ä¸ºé˜Ÿåˆ—APIä¸å¯ç”¨è€Œé”™è¯¯åœ°æ ‡è®°æœåŠ¡å™¨ä¸ºä¸å¥åº·\n+    if (!queue.healthy) {\n+      console.log(`âš ï¸ æœåŠ¡å™¨ ${server.url} é˜Ÿåˆ—æ£€æŸ¥å¤±è´¥ï¼Œä½†å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œä»æ ‡è®°ä¸ºå¯ç”¨`)\n+      return true\n+    }\n+\n+    // å¦‚æœé˜Ÿåˆ—è¿‡é•¿ï¼ˆè¶…è¿‡10ä¸ªä»»åŠ¡ï¼‰ï¼Œé™ä½ä¼˜å…ˆçº§ä½†ä¸æ ‡è®°ä¸ºä¸å¥åº·\n+    if (queue.total > 10) {\n+      console.log(`âš ï¸ æœåŠ¡å™¨ ${server.url} é˜Ÿåˆ—è¾ƒé•¿ (${queue.total})ï¼Œä½†ä»å¯ç”¨`)\n+      return true\n+    }\n+\n+    return true\n+  }\n+\n+  /**\n    * æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€\n    */\n   async checkServerHealth(serverUrl) {\n     try {\n"
                },
                {
                    "date": 1752411238444,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -306,13 +306,13 @@\n           return lockedServer\n         }\n       }\n \n-      // æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n+      // æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯ï¼ˆå¦‚æœæ²¡æœ‰å¥åº·æœåŠ¡å™¨ï¼Œå¼ºåˆ¶æ›´æ–°ï¼‰\n       await this.updateServerLoads()\n \n       // è·å–æ‰€æœ‰å¥åº·çš„æœåŠ¡å™¨\n-      const healthyServers = Array.from(this.serverLoads.values())\n+      let healthyServers = Array.from(this.serverLoads.values())\n         .filter(server => server.healthy)\n         .sort((a, b) => {\n           // é¦–å…ˆæŒ‰é˜Ÿåˆ—æ•°é‡æ’åº\n           const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n@@ -321,10 +321,24 @@\n           // é˜Ÿåˆ—ç›¸åŒæ—¶æŒ‰ä¼˜å…ˆçº§æ’åº\n           return a.priority - b.priority\n         })\n \n+      // å¦‚æœæ²¡æœ‰å¥åº·æœåŠ¡å™¨ï¼Œå¼ºåˆ¶æ›´æ–°ä¸€æ¬¡å†è¯•\n       if (healthyServers.length === 0) {\n-        console.warn('âš ï¸ æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨')\n+        console.warn('âš ï¸ æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨ï¼Œå¼ºåˆ¶æ›´æ–°åé‡è¯•...')\n+        await this.updateServerLoads(true) // å¼ºåˆ¶æ›´æ–°\n+\n+        healthyServers = Array.from(this.serverLoads.values())\n+          .filter(server => server.healthy)\n+          .sort((a, b) => {\n+            const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n+            if (queueDiff !== 0) return queueDiff\n+            return a.priority - b.priority\n+          })\n+      }\n+\n+      if (healthyServers.length === 0) {\n+        console.warn('âš ï¸ å¼ºåˆ¶æ›´æ–°åä»æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨')\n         return await this.fallbackToAnyServer()\n       }\n \n       const selectedServer = healthyServers[0]\n"
                },
                {
                    "date": 1752411258535,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -360,9 +360,23 @@\n    */\n   async fallbackToAnyServer() {\n     console.log('ğŸ”„ ä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨é€‰æ‹©ç­–ç•¥...')\n \n-    // æŒ‰ä¼˜å…ˆçº§è¿”å›ç¬¬ä¸€ä¸ªæœåŠ¡å™¨\n+    // å°è¯•é€‰æ‹©å“åº”æ—¶é—´æœ€å¿«çš„æœåŠ¡å™¨ï¼ˆå³ä½¿é˜Ÿåˆ—è¾ƒé•¿ï¼‰\n+    const serversWithResponse = Array.from(this.serverLoads.values())\n+      .filter(server => server.responseTime > 0) // è‡³å°‘æœ‰å“åº”\n+      .sort((a, b) => {\n+        // æŒ‰å“åº”æ—¶é—´æ’åº\n+        return a.responseTime - b.responseTime\n+      })\n+\n+    if (serversWithResponse.length > 0) {\n+      const fastestServer = serversWithResponse[0]\n+      console.log(`ğŸ†˜ é€‰æ‹©å“åº”æœ€å¿«çš„æœåŠ¡å™¨: ${fastestServer.url} (å“åº”æ—¶é—´: ${fastestServer.responseTime}ms, é˜Ÿåˆ—: ${fastestServer.queue.total || 0})`)\n+      return fastestServer.url\n+    }\n+\n+    // å¦‚æœæ²¡æœ‰å“åº”æ•°æ®ï¼ŒæŒ‰ä¼˜å…ˆçº§è¿”å›ç¬¬ä¸€ä¸ªæœåŠ¡å™¨\n     if (this.servers.length > 0) {\n       const fallbackServer = this.servers[0].url\n       console.log(`ğŸ†˜ å¤‡ç”¨æœåŠ¡å™¨: ${fallbackServer}`)\n       return fallbackServer\n"
                },
                {
                    "date": 1752411277869,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -130,9 +130,10 @@\n           responseTime: health.responseTime || 0,\n           healthDetails: { health, queue }\n         })\n \n-        console.log(`ğŸ“Š ${server.url}: å¥åº·=${health.healthy}, é˜Ÿåˆ—=${queue.total || 0}`)\n+        const queueInfo = queue.healthy ? `é˜Ÿåˆ—=${queue.total || 0}(è¿è¡Œ:${queue.running || 0},ç­‰å¾…:${queue.pending || 0})` : `é˜Ÿåˆ—æ£€æŸ¥å¤±è´¥`\n+        console.log(`ğŸ“Š ${server.url}: å¥åº·=${health.healthy}, ${queueInfo}, å“åº”æ—¶é—´=${health.responseTime || 0}ms`)\n \n       } catch (error) {\n         console.error(`âŒ æ›´æ–°æœåŠ¡å™¨è´Ÿè½½å¤±è´¥ ${server.url}:`, error)\n         this.serverLoads.set(server.url, {\n"
                },
                {
                    "date": 1752411297072,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -491,12 +491,16 @@\n   logServerStatus() {\n     console.log('ğŸ“Š å½“å‰æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€:')\n     for (const [url, info] of this.serverLoads.entries()) {\n       const status = info.healthy ? 'âœ…' : 'âŒ'\n-      const queue = info.healthy ? `é˜Ÿåˆ—:${info.queue.total || 0}` : 'ä¸å¥åº·'\n+      const queueInfo = info.queue ?\n+        `é˜Ÿåˆ—:${info.queue.total || 0}(è¿è¡Œ:${info.queue.running || 0},ç­‰å¾…:${info.queue.pending || 0})` :\n+        'é˜Ÿåˆ—:æœªçŸ¥'\n       const locked = url === this.lockedServer ? 'ğŸ”’' : ''\n       const priority = `ä¼˜å…ˆçº§:${info.priority}`\n-      console.log(`   ${status} ${url} ${queue} ${priority} ${locked}`)\n+      const responseTime = info.responseTime ? `å“åº”:${info.responseTime}ms` : 'å“åº”:æœªçŸ¥'\n+      const lastCheck = info.lastCheck ? `æ£€æŸ¥:${Math.round((Date.now() - info.lastCheck) / 1000)}så‰` : 'æ£€æŸ¥:ä»æœª'\n+      console.log(`   ${status} ${url} ${queueInfo} ${priority} ${responseTime} ${lastCheck} ${locked}`)\n     }\n   }\n \n   /**\n"
                },
                {
                    "date": 1752411316946,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -485,8 +485,27 @@\n     return await this.selectServerByMinQueue()\n   }\n \n   /**\n+   * å¼ºåˆ¶é‡æ–°è¯„ä¼°æ‰€æœ‰æœåŠ¡å™¨\n+   */\n+  async forceReassessment() {\n+    console.log('ğŸ”„ å¼ºåˆ¶é‡æ–°è¯„ä¼°æ‰€æœ‰æœåŠ¡å™¨...')\n+\n+    // æ¸…é™¤é”å®šçŠ¶æ€\n+    this.lockedServer = null\n+    this.lastLockTime = 0\n+\n+    // å¼ºåˆ¶æ›´æ–°è´Ÿè½½ä¿¡æ¯\n+    await this.updateServerLoads(true)\n+\n+    // æ˜¾ç¤ºå½“å‰çŠ¶æ€\n+    this.logServerStatus()\n+\n+    console.log('âœ… æœåŠ¡å™¨é‡æ–°è¯„ä¼°å®Œæˆ')\n+  }\n+\n+  /**\n    * æ˜¾ç¤ºæœåŠ¡å™¨çŠ¶æ€\n    */\n   logServerStatus() {\n     console.log('ğŸ“Š å½“å‰æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€:')\n"
                },
                {
                    "date": 1752432824586,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -42,13 +42,19 @@\n       }\n \n       // å¤‡ç”¨æœåŠ¡å™¨\n       if (config['comfyui.backup_servers']) {\n-        const backupServers = config['comfyui.backup_servers']\n-          .split('\\n')\n+        let backupServersText = config['comfyui.backup_servers']\n+\n+        // æ”¯æŒå¤šç§åˆ†éš”ç¬¦ï¼šæ¢è¡Œç¬¦ã€é€—å·ã€åˆ†å·\n+        const backupServers = backupServersText\n+          .split(/[\\n,;]/)\n           .map(url => url.trim())\n           .filter(url => url && url.startsWith('http'))\n \n+        console.log(`ğŸ” è§£æå¤‡ç”¨æœåŠ¡å™¨é…ç½®: \"${backupServersText}\"`)\n+        console.log(`ğŸ“‹ è§£æå‡ºçš„å¤‡ç”¨æœåŠ¡å™¨:`, backupServers)\n+\n         backupServers.forEach((url, index) => {\n           this.servers.push({\n             url,\n             type: 'backup',\n"
                },
                {
                    "date": 1752432849289,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -163,8 +163,9 @@\n    */\n   determineServerHealth(health, queue, server) {\n     // å¦‚æœå¥åº·æ£€æŸ¥å®Œå…¨å¤±è´¥ï¼Œæ ‡è®°ä¸ºä¸å¥åº·\n     if (!health.healthy) {\n+      console.log(`âŒ æœåŠ¡å™¨ ${server.url} å¥åº·æ£€æŸ¥å¤±è´¥`)\n       return false\n     }\n \n     // å¦‚æœé˜Ÿåˆ—æ£€æŸ¥å¤±è´¥ä½†å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œä»ç„¶è®¤ä¸ºæœåŠ¡å™¨å¯ç”¨\n@@ -179,8 +180,9 @@\n       console.log(`âš ï¸ æœåŠ¡å™¨ ${server.url} é˜Ÿåˆ—è¾ƒé•¿ (${queue.total})ï¼Œä½†ä»å¯ç”¨`)\n       return true\n     }\n \n+    console.log(`âœ… æœåŠ¡å™¨ ${server.url} å¥åº·çŠ¶æ€è‰¯å¥½`)\n     return true\n   }\n \n   /**\n"
                },
                {
                    "date": 1752432865080,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -345,9 +345,9 @@\n           })\n       }\n \n       if (healthyServers.length === 0) {\n-        console.warn('âš ï¸ å¼ºåˆ¶æ›´æ–°åä»æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨')\n+        console.warn('âš ï¸ å¼ºåˆ¶æ›´æ–°åä»æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨ï¼Œå°è¯•å¤‡ç”¨æœåŠ¡å™¨é€‰æ‹©ç­–ç•¥')\n         return await this.fallbackToAnyServer()\n       }\n \n       const selectedServer = healthyServers[0]\n"
                },
                {
                    "date": 1752432889563,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -369,9 +369,9 @@\n    */\n   async fallbackToAnyServer() {\n     console.log('ğŸ”„ ä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨é€‰æ‹©ç­–ç•¥...')\n \n-    // å°è¯•é€‰æ‹©å“åº”æ—¶é—´æœ€å¿«çš„æœåŠ¡å™¨ï¼ˆå³ä½¿é˜Ÿåˆ—è¾ƒé•¿ï¼‰\n+    // é¦–å…ˆå°è¯•é€‰æ‹©æœ‰å“åº”çš„æœåŠ¡å™¨ï¼ˆæŒ‰å“åº”æ—¶é—´æ’åºï¼‰\n     const serversWithResponse = Array.from(this.serverLoads.values())\n       .filter(server => server.responseTime > 0) // è‡³å°‘æœ‰å“åº”\n       .sort((a, b) => {\n         // æŒ‰å“åº”æ—¶é—´æ’åº\n@@ -383,12 +383,27 @@\n       console.log(`ğŸ†˜ é€‰æ‹©å“åº”æœ€å¿«çš„æœåŠ¡å™¨: ${fastestServer.url} (å“åº”æ—¶é—´: ${fastestServer.responseTime}ms, é˜Ÿåˆ—: ${fastestServer.queue.total || 0})`)\n       return fastestServer.url\n     }\n \n-    // å¦‚æœæ²¡æœ‰å“åº”æ•°æ®ï¼ŒæŒ‰ä¼˜å…ˆçº§è¿”å›ç¬¬ä¸€ä¸ªæœåŠ¡å™¨\n+    // å¦‚æœæ²¡æœ‰å“åº”æ•°æ®ï¼Œå°è¯•æŒ‰ä¼˜å…ˆçº§é¡ºåºæµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨\n+    console.log('ğŸ” æ²¡æœ‰å“åº”æ•°æ®ï¼ŒæŒ‰ä¼˜å…ˆçº§æµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨...')\n+    for (const server of this.servers.sort((a, b) => a.priority - b.priority)) {\n+      console.log(`ğŸ§ª æµ‹è¯•æœåŠ¡å™¨: ${server.url}`)\n+      try {\n+        const health = await this.checkServerHealth(server.url)\n+        if (health.healthy) {\n+          console.log(`âœ… æ‰¾åˆ°å¯ç”¨æœåŠ¡å™¨: ${server.url}`)\n+          return server.url\n+        }\n+      } catch (error) {\n+        console.log(`âŒ æœåŠ¡å™¨ ${server.url} æµ‹è¯•å¤±è´¥: ${error.message}`)\n+      }\n+    }\n+\n+    // å¦‚æœæ‰€æœ‰æµ‹è¯•éƒ½å¤±è´¥ï¼Œè¿”å›ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨\n     if (this.servers.length > 0) {\n       const fallbackServer = this.servers[0].url\n-      console.log(`ğŸ†˜ å¤‡ç”¨æœåŠ¡å™¨: ${fallbackServer}`)\n+      console.log(`ğŸ†˜ æ‰€æœ‰æœåŠ¡å™¨æµ‹è¯•å¤±è´¥ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨: ${fallbackServer}`)\n       return fallbackServer\n     }\n \n     // å¦‚æœæ²¡æœ‰é…ç½®çš„æœåŠ¡å™¨ï¼Œå°è¯•å¤šç§æ–¹å¼è·å–é»˜è®¤å€¼\n"
                },
                {
                    "date": 1752432968790,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -42,19 +42,13 @@\n       }\n \n       // å¤‡ç”¨æœåŠ¡å™¨\n       if (config['comfyui.backup_servers']) {\n-        let backupServersText = config['comfyui.backup_servers']\n-\n-        // æ”¯æŒå¤šç§åˆ†éš”ç¬¦ï¼šæ¢è¡Œç¬¦ã€é€—å·ã€åˆ†å·\n-        const backupServers = backupServersText\n-          .split(/[\\n,;]/)\n+        const backupServers = config['comfyui.backup_servers']\n+          .split('\\n')\n           .map(url => url.trim())\n           .filter(url => url && url.startsWith('http'))\n \n-        console.log(`ğŸ” è§£æå¤‡ç”¨æœåŠ¡å™¨é…ç½®: \"${backupServersText}\"`)\n-        console.log(`ğŸ“‹ è§£æå‡ºçš„å¤‡ç”¨æœåŠ¡å™¨:`, backupServers)\n-\n         backupServers.forEach((url, index) => {\n           this.servers.push({\n             url,\n             type: 'backup',\n@@ -163,9 +157,8 @@\n    */\n   determineServerHealth(health, queue, server) {\n     // å¦‚æœå¥åº·æ£€æŸ¥å®Œå…¨å¤±è´¥ï¼Œæ ‡è®°ä¸ºä¸å¥åº·\n     if (!health.healthy) {\n-      console.log(`âŒ æœåŠ¡å™¨ ${server.url} å¥åº·æ£€æŸ¥å¤±è´¥`)\n       return false\n     }\n \n     // å¦‚æœé˜Ÿåˆ—æ£€æŸ¥å¤±è´¥ä½†å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œä»ç„¶è®¤ä¸ºæœåŠ¡å™¨å¯ç”¨\n@@ -180,9 +173,8 @@\n       console.log(`âš ï¸ æœåŠ¡å™¨ ${server.url} é˜Ÿåˆ—è¾ƒé•¿ (${queue.total})ï¼Œä½†ä»å¯ç”¨`)\n       return true\n     }\n \n-    console.log(`âœ… æœåŠ¡å™¨ ${server.url} å¥åº·çŠ¶æ€è‰¯å¥½`)\n     return true\n   }\n \n   /**\n@@ -345,9 +337,9 @@\n           })\n       }\n \n       if (healthyServers.length === 0) {\n-        console.warn('âš ï¸ å¼ºåˆ¶æ›´æ–°åä»æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨ï¼Œå°è¯•å¤‡ç”¨æœåŠ¡å™¨é€‰æ‹©ç­–ç•¥')\n+        console.warn('âš ï¸ å¼ºåˆ¶æ›´æ–°åä»æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨')\n         return await this.fallbackToAnyServer()\n       }\n \n       const selectedServer = healthyServers[0]\n@@ -369,9 +361,9 @@\n    */\n   async fallbackToAnyServer() {\n     console.log('ğŸ”„ ä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨é€‰æ‹©ç­–ç•¥...')\n \n-    // é¦–å…ˆå°è¯•é€‰æ‹©æœ‰å“åº”çš„æœåŠ¡å™¨ï¼ˆæŒ‰å“åº”æ—¶é—´æ’åºï¼‰\n+    // å°è¯•é€‰æ‹©å“åº”æ—¶é—´æœ€å¿«çš„æœåŠ¡å™¨ï¼ˆå³ä½¿é˜Ÿåˆ—è¾ƒé•¿ï¼‰\n     const serversWithResponse = Array.from(this.serverLoads.values())\n       .filter(server => server.responseTime > 0) // è‡³å°‘æœ‰å“åº”\n       .sort((a, b) => {\n         // æŒ‰å“åº”æ—¶é—´æ’åº\n@@ -383,27 +375,12 @@\n       console.log(`ğŸ†˜ é€‰æ‹©å“åº”æœ€å¿«çš„æœåŠ¡å™¨: ${fastestServer.url} (å“åº”æ—¶é—´: ${fastestServer.responseTime}ms, é˜Ÿåˆ—: ${fastestServer.queue.total || 0})`)\n       return fastestServer.url\n     }\n \n-    // å¦‚æœæ²¡æœ‰å“åº”æ•°æ®ï¼Œå°è¯•æŒ‰ä¼˜å…ˆçº§é¡ºåºæµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨\n-    console.log('ğŸ” æ²¡æœ‰å“åº”æ•°æ®ï¼ŒæŒ‰ä¼˜å…ˆçº§æµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨...')\n-    for (const server of this.servers.sort((a, b) => a.priority - b.priority)) {\n-      console.log(`ğŸ§ª æµ‹è¯•æœåŠ¡å™¨: ${server.url}`)\n-      try {\n-        const health = await this.checkServerHealth(server.url)\n-        if (health.healthy) {\n-          console.log(`âœ… æ‰¾åˆ°å¯ç”¨æœåŠ¡å™¨: ${server.url}`)\n-          return server.url\n-        }\n-      } catch (error) {\n-        console.log(`âŒ æœåŠ¡å™¨ ${server.url} æµ‹è¯•å¤±è´¥: ${error.message}`)\n-      }\n-    }\n-\n-    // å¦‚æœæ‰€æœ‰æµ‹è¯•éƒ½å¤±è´¥ï¼Œè¿”å›ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨\n+    // å¦‚æœæ²¡æœ‰å“åº”æ•°æ®ï¼ŒæŒ‰ä¼˜å…ˆçº§è¿”å›ç¬¬ä¸€ä¸ªæœåŠ¡å™¨\n     if (this.servers.length > 0) {\n       const fallbackServer = this.servers[0].url\n-      console.log(`ğŸ†˜ æ‰€æœ‰æœåŠ¡å™¨æµ‹è¯•å¤±è´¥ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨: ${fallbackServer}`)\n+      console.log(`ğŸ†˜ å¤‡ç”¨æœåŠ¡å™¨: ${fallbackServer}`)\n       return fallbackServer\n     }\n \n     // å¦‚æœæ²¡æœ‰é…ç½®çš„æœåŠ¡å™¨ï¼Œå°è¯•å¤šç§æ–¹å¼è·å–é»˜è®¤å€¼\n"
                },
                {
                    "date": 1752433073845,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,14 +10,19 @@\n     this.servers = []\n     this.serverLoads = new Map()\n     this.lockedServer = null\n     this.lastLockTime = 0\n-    this.lockDuration = 30000 // 30ç§’é”å®šæ—¶é—´\n-    this.healthCheckTimeout = 15000 // 15ç§’å¥åº·æ£€æŸ¥è¶…æ—¶\n-    this.queueCheckTimeout = 8000 // 8ç§’é˜Ÿåˆ—æ£€æŸ¥è¶…æ—¶\n+    this.lockDuration = 15000 // ç¼©çŸ­é”å®šæ—¶é—´åˆ°15ç§’\n+    this.healthCheckTimeout = 10000 // 10ç§’å¥åº·æ£€æŸ¥è¶…æ—¶\n+    this.queueCheckTimeout = 6000 // 6ç§’é˜Ÿåˆ—æ£€æŸ¥è¶…æ—¶\n     this.lastUpdateTime = 0\n-    this.updateInterval = 10000 // 10ç§’æ›´æ–°é—´éš”ï¼ˆæ›´é¢‘ç¹çš„æ›´æ–°ï¼‰\n-    this.forceUpdateThreshold = 30000 // 30ç§’å¼ºåˆ¶æ›´æ–°é˜ˆå€¼\n+    this.updateInterval = 8000 // 8ç§’æ›´æ–°é—´éš”ï¼ˆæ›´é¢‘ç¹çš„æ›´æ–°ï¼‰\n+    this.forceUpdateThreshold = 20000 // 20ç§’å¼ºåˆ¶æ›´æ–°é˜ˆå€¼\n+    this.failureThreshold = 2 // è¿ç»­å¤±è´¥2æ¬¡åæ ‡è®°ä¸ºä¸å¥åº·\n+    this.serverFailures = new Map() // è®°å½•æœåŠ¡å™¨å¤±è´¥æ¬¡æ•°\n+    this.autoFailoverEnabled = true // å¯ç”¨è‡ªåŠ¨æ•…éšœè½¬ç§»\n+    this.lastFailoverTime = 0\n+    this.failoverCooldown = 5000 // æ•…éšœè½¬ç§»å†·å´æ—¶é—´5ç§’\n   }\n \n   /**\n    * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n"
                },
                {
                    "date": 1752433101974,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -460,14 +460,21 @@\n \n   /**\n    * è®°å½•æœåŠ¡å™¨å¤±è´¥\n    */\n-  async recordFailure(serverUrl) {\n-    console.log(`ğŸ“ è®°å½•æœåŠ¡å™¨å¤±è´¥: ${serverUrl}`)\n+  async recordFailure(serverUrl, errorType = 'unknown') {\n+    console.log(`ğŸ“ è®°å½•æœåŠ¡å™¨å¤±è´¥: ${serverUrl}, é”™è¯¯ç±»å‹: ${errorType}`)\n \n-    // å¦‚æœå¤±è´¥çš„æ˜¯å½“å‰é”å®šçš„æœåŠ¡å™¨ï¼Œè§£é™¤é”å®š\n+    // å¢åŠ å¤±è´¥è®¡æ•°\n+    const currentFailures = this.serverFailures.get(serverUrl) || 0\n+    const newFailures = currentFailures + 1\n+    this.serverFailures.set(serverUrl, newFailures)\n+\n+    console.log(`âš ï¸ æœåŠ¡å™¨ ${serverUrl} å¤±è´¥æ¬¡æ•°: ${newFailures}/${this.failureThreshold}`)\n+\n+    // å¦‚æœå¤±è´¥çš„æ˜¯å½“å‰é”å®šçš„æœåŠ¡å™¨ï¼Œç«‹å³è§£é™¤é”å®š\n     if (this.lockedServer === serverUrl) {\n-      console.log('ğŸ”“ è§£é™¤å¤±è´¥æœåŠ¡å™¨çš„é”å®š')\n+      console.log('ğŸ”“ ç«‹å³è§£é™¤å¤±è´¥æœåŠ¡å™¨çš„é”å®š')\n       this.lockedServer = null\n       this.lastLockTime = 0\n     }\n \n@@ -475,16 +482,73 @@\n     if (this.serverLoads.has(serverUrl)) {\n       const serverInfo = this.serverLoads.get(serverUrl)\n       serverInfo.healthy = false\n       serverInfo.lastFailure = Date.now()\n+      serverInfo.failureCount = newFailures\n+      serverInfo.lastErrorType = errorType\n       this.serverLoads.set(serverUrl, serverInfo)\n     }\n \n+    // å¦‚æœè¾¾åˆ°å¤±è´¥é˜ˆå€¼ä¸”å¯ç”¨è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œè§¦å‘æ•…éšœè½¬ç§»\n+    if (newFailures >= this.failureThreshold && this.autoFailoverEnabled) {\n+      await this.triggerFailover(serverUrl)\n+    }\n+\n     // å¼ºåˆ¶æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n     this.lastUpdateTime = 0\n   }\n \n   /**\n+   * è§¦å‘æ•…éšœè½¬ç§»\n+   */\n+  async triggerFailover(failedServerUrl) {\n+    const now = Date.now()\n+\n+    // æ£€æŸ¥æ•…éšœè½¬ç§»å†·å´æ—¶é—´\n+    if (now - this.lastFailoverTime < this.failoverCooldown) {\n+      console.log('â³ æ•…éšœè½¬ç§»å†·å´ä¸­ï¼Œè·³è¿‡æ­¤æ¬¡è½¬ç§»')\n+      return\n+    }\n+\n+    console.log(`ğŸ”„ è§¦å‘æ•…éšœè½¬ç§»ï¼Œå¤±è´¥æœåŠ¡å™¨: ${failedServerUrl}`)\n+    this.lastFailoverTime = now\n+\n+    // å¼ºåˆ¶é‡æ–°è¯„ä¼°æ‰€æœ‰æœåŠ¡å™¨\n+    await this.forceReassessment()\n+\n+    // å°è¯•é€‰æ‹©æ–°çš„æœåŠ¡å™¨\n+    try {\n+      const newServer = await this.selectServerByMinQueue()\n+      if (newServer && newServer !== failedServerUrl) {\n+        console.log(`âœ… æ•…éšœè½¬ç§»æˆåŠŸï¼Œæ–°æœåŠ¡å™¨: ${newServer}`)\n+        return newServer\n+      } else {\n+        console.warn('âš ï¸ æ•…éšœè½¬ç§»å¤±è´¥ï¼Œæ²¡æœ‰å¯ç”¨çš„æ›¿ä»£æœåŠ¡å™¨')\n+      }\n+    } catch (error) {\n+      console.error('âŒ æ•…éšœè½¬ç§»è¿‡ç¨‹ä¸­å‡ºé”™:', error)\n+    }\n+  }\n+\n+  /**\n+   * é‡ç½®æœåŠ¡å™¨å¤±è´¥è®¡æ•°\n+   */\n+  resetFailureCount(serverUrl) {\n+    if (this.serverFailures.has(serverUrl)) {\n+      console.log(`ğŸ”„ é‡ç½®æœåŠ¡å™¨å¤±è´¥è®¡æ•°: ${serverUrl}`)\n+      this.serverFailures.delete(serverUrl)\n+\n+      // åŒæ—¶æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n+      if (this.serverLoads.has(serverUrl)) {\n+        const serverInfo = this.serverLoads.get(serverUrl)\n+        serverInfo.failureCount = 0\n+        delete serverInfo.lastErrorType\n+        this.serverLoads.set(serverUrl, serverInfo)\n+      }\n+    }\n+  }\n+\n+  /**\n    * è·å–æœ€ä¼˜æœåŠ¡å™¨ï¼ˆä¸»è¦æ¥å£ï¼‰\n    */\n   async getOptimalServer() {\n     return await this.selectServerByMinQueue()\n"
                },
                {
                    "date": 1752433121431,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -126,15 +126,22 @@\n \n         // æ›´æ™ºèƒ½çš„å¥åº·çŠ¶æ€åˆ¤æ–­\n         const isHealthy = this.determineServerHealth(health, queue, server)\n \n+        // å¦‚æœæœåŠ¡å™¨æ¢å¤å¥åº·ï¼Œé‡ç½®å¤±è´¥è®¡æ•°\n+        if (isHealthy && this.serverFailures.has(server.url)) {\n+          console.log(`âœ… æœåŠ¡å™¨ ${server.url} å·²æ¢å¤å¥åº·ï¼Œé‡ç½®å¤±è´¥è®¡æ•°`)\n+          this.resetFailureCount(server.url)\n+        }\n+\n         this.serverLoads.set(server.url, {\n           ...server,\n           healthy: isHealthy,\n           queue: queue,\n           lastCheck: now,\n           responseTime: health.responseTime || 0,\n-          healthDetails: { health, queue }\n+          healthDetails: { health, queue },\n+          failureCount: this.serverFailures.get(server.url) || 0\n         })\n \n         const queueInfo = queue.healthy ? `é˜Ÿåˆ—=${queue.total || 0}(è¿è¡Œ:${queue.running || 0},ç­‰å¾…:${queue.pending || 0})` : `é˜Ÿåˆ—æ£€æŸ¥å¤±è´¥`\n         console.log(`ğŸ“Š ${server.url}: å¥åº·=${health.healthy}, ${queueInfo}, å“åº”æ—¶é—´=${health.responseTime || 0}ms`)\n"
                },
                {
                    "date": 1752433140936,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -324,15 +324,32 @@\n       await this.updateServerLoads()\n \n       // è·å–æ‰€æœ‰å¥åº·çš„æœåŠ¡å™¨\n       let healthyServers = Array.from(this.serverLoads.values())\n-        .filter(server => server.healthy)\n+        .filter(server => {\n+          // è¿‡æ»¤æ‰å¥åº·çŠ¶æ€ä¸ºfalseçš„æœåŠ¡å™¨\n+          if (!server.healthy) return false\n+\n+          // è¿‡æ»¤æ‰å¤±è´¥æ¬¡æ•°è¿‡å¤šçš„æœåŠ¡å™¨\n+          const failures = this.serverFailures.get(server.url) || 0\n+          if (failures >= this.failureThreshold) {\n+            console.log(`âš ï¸ è·³è¿‡å¤±è´¥æ¬¡æ•°è¿‡å¤šçš„æœåŠ¡å™¨: ${server.url} (${failures}æ¬¡)`)\n+            return false\n+          }\n+\n+          return true\n+        })\n         .sort((a, b) => {\n-          // é¦–å…ˆæŒ‰é˜Ÿåˆ—æ•°é‡æ’åº\n+          // é¦–å…ˆæŒ‰å¤±è´¥æ¬¡æ•°æ’åºï¼ˆå¤±è´¥æ¬¡æ•°å°‘çš„ä¼˜å…ˆï¼‰\n+          const failureA = this.serverFailures.get(a.url) || 0\n+          const failureB = this.serverFailures.get(b.url) || 0\n+          if (failureA !== failureB) return failureA - failureB\n+\n+          // ç„¶åæŒ‰é˜Ÿåˆ—æ•°é‡æ’åº\n           const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n           if (queueDiff !== 0) return queueDiff\n \n-          // é˜Ÿåˆ—ç›¸åŒæ—¶æŒ‰ä¼˜å…ˆçº§æ’åº\n+          // æœ€åæŒ‰ä¼˜å…ˆçº§æ’åº\n           return a.priority - b.priority\n         })\n \n       // å¦‚æœæ²¡æœ‰å¥åº·æœåŠ¡å™¨ï¼Œå¼ºåˆ¶æ›´æ–°ä¸€æ¬¡å†è¯•\n"
                },
                {
                    "date": 1752433159045,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -587,8 +587,12 @@\n     // æ¸…é™¤é”å®šçŠ¶æ€\n     this.lockedServer = null\n     this.lastLockTime = 0\n \n+    // é‡ç½®æ‰€æœ‰æœåŠ¡å™¨çš„å¤±è´¥è®¡æ•°ï¼ˆç»™å®ƒä»¬ä¸€ä¸ªé‡æ–°å¼€å§‹çš„æœºä¼šï¼‰\n+    console.log('ğŸ”„ é‡ç½®æ‰€æœ‰æœåŠ¡å™¨å¤±è´¥è®¡æ•°')\n+    this.serverFailures.clear()\n+\n     // å¼ºåˆ¶æ›´æ–°è´Ÿè½½ä¿¡æ¯\n     await this.updateServerLoads(true)\n \n     // æ˜¾ç¤ºå½“å‰çŠ¶æ€\n"
                },
                {
                    "date": 1752433183172,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -614,9 +614,12 @@\n       const locked = url === this.lockedServer ? 'ğŸ”’' : ''\n       const priority = `ä¼˜å…ˆçº§:${info.priority}`\n       const responseTime = info.responseTime ? `å“åº”:${info.responseTime}ms` : 'å“åº”:æœªçŸ¥'\n       const lastCheck = info.lastCheck ? `æ£€æŸ¥:${Math.round((Date.now() - info.lastCheck) / 1000)}så‰` : 'æ£€æŸ¥:ä»æœª'\n-      console.log(`   ${status} ${url} ${queueInfo} ${priority} ${responseTime} ${lastCheck} ${locked}`)\n+      const failures = this.serverFailures.get(url) || 0\n+      const failureInfo = failures > 0 ? `å¤±è´¥:${failures}æ¬¡` : ''\n+      const errorType = info.lastErrorType ? `é”™è¯¯:${info.lastErrorType}` : ''\n+      console.log(`   ${status} ${url} ${queueInfo} ${priority} ${responseTime} ${lastCheck} ${failureInfo} ${errorType} ${locked}`)\n     }\n   }\n \n   /**\n"
                },
                {
                    "date": 1752433248550,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -21,8 +21,10 @@\n     this.serverFailures = new Map() // è®°å½•æœåŠ¡å™¨å¤±è´¥æ¬¡æ•°\n     this.autoFailoverEnabled = true // å¯ç”¨è‡ªåŠ¨æ•…éšœè½¬ç§»\n     this.lastFailoverTime = 0\n     this.failoverCooldown = 5000 // æ•…éšœè½¬ç§»å†·å´æ—¶é—´5ç§’\n+    this.healthMonitorInterval = null // å¥åº·ç›‘æ§å®šæ—¶å™¨\n+    this.healthMonitorFrequency = 30000 // 30ç§’æ£€æŸ¥ä¸€æ¬¡å¥åº·çŠ¶æ€\n   }\n \n   /**\n    * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n"
                },
                {
                    "date": 1752433264068,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -85,8 +85,11 @@\n \n       // åˆå§‹åŒ–æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n       await this.updateServerLoads()\n \n+      // å¯åŠ¨å¥åº·ç›‘æ§\n+      this.startHealthMonitoring()\n+\n       console.log('âœ… ComfyUI è´Ÿè½½å‡è¡¡å™¨åˆå§‹åŒ–å®Œæˆ')\n \n     } catch (error) {\n       console.error('âŒ è´Ÿè½½å‡è¡¡å™¨åˆå§‹åŒ–å¤±è´¥:', error)\n"
                },
                {
                    "date": 1752433286725,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -652,8 +652,80 @@\n     }\n \n     return stats\n   }\n+\n+  /**\n+   * å¯åŠ¨å¥åº·ç›‘æ§\n+   */\n+  startHealthMonitoring() {\n+    if (this.healthMonitorInterval) {\n+      clearInterval(this.healthMonitorInterval)\n+    }\n+\n+    console.log(`ğŸ¥ å¯åŠ¨å¥åº·ç›‘æ§ï¼Œæ£€æŸ¥é¢‘ç‡: ${this.healthMonitorFrequency / 1000}ç§’`)\n+\n+    this.healthMonitorInterval = setInterval(async () => {\n+      try {\n+        await this.performHealthMonitoring()\n+      } catch (error) {\n+        console.error('âŒ å¥åº·ç›‘æ§å‡ºé”™:', error)\n+      }\n+    }, this.healthMonitorFrequency)\n+  }\n+\n+  /**\n+   * åœæ­¢å¥åº·ç›‘æ§\n+   */\n+  stopHealthMonitoring() {\n+    if (this.healthMonitorInterval) {\n+      console.log('ğŸ›‘ åœæ­¢å¥åº·ç›‘æ§')\n+      clearInterval(this.healthMonitorInterval)\n+      this.healthMonitorInterval = null\n+    }\n+  }\n+\n+  /**\n+   * æ‰§è¡Œå¥åº·ç›‘æ§\n+   */\n+  async performHealthMonitoring() {\n+    console.log('ğŸ¥ æ‰§è¡Œå®šæœŸå¥åº·æ£€æŸ¥...')\n+\n+    // æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n+    await this.updateServerLoads()\n+\n+    // æ£€æŸ¥å½“å‰é”å®šçš„æœåŠ¡å™¨æ˜¯å¦ä»ç„¶å¥åº·\n+    if (this.lockedServer) {\n+      const lockedServerInfo = this.serverLoads.get(this.lockedServer)\n+      if (lockedServerInfo && !lockedServerInfo.healthy) {\n+        console.warn(`âš ï¸ é”å®šçš„æœåŠ¡å™¨ ${this.lockedServer} ä¸å¥åº·ï¼Œè§£é™¤é”å®š`)\n+        this.lockedServer = null\n+        this.lastLockTime = 0\n+      }\n+    }\n+\n+    // æ£€æŸ¥æ˜¯å¦æœ‰æœåŠ¡å™¨ä»æ•…éšœä¸­æ¢å¤\n+    const healthyServers = Array.from(this.serverLoads.values())\n+      .filter(server => server.healthy)\n+\n+    if (healthyServers.length > 0) {\n+      console.log(`âœ… å¥åº·ç›‘æ§å®Œæˆï¼Œå‘ç° ${healthyServers.length} ä¸ªå¥åº·æœåŠ¡å™¨`)\n+    } else {\n+      console.warn('âš ï¸ å¥åº·ç›‘æ§è­¦å‘Šï¼šæ²¡æœ‰å‘ç°å¥åº·çš„æœåŠ¡å™¨')\n+    }\n+  }\n+\n+  /**\n+   * é”€æ¯è´Ÿè½½å‡è¡¡å™¨\n+   */\n+  destroy() {\n+    this.stopHealthMonitoring()\n+    this.servers = []\n+    this.serverLoads.clear()\n+    this.serverFailures.clear()\n+    this.lockedServer = null\n+    console.log('ğŸ—‘ï¸ è´Ÿè½½å‡è¡¡å™¨å·²é”€æ¯')\n+  }\n }\n \n // åˆ›å»ºå•ä¾‹å®ä¾‹\n const loadBalancer = new ComfyUILoadBalancer()\n"
                },
                {
                    "date": 1752433308913,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -583,8 +583,56 @@\n     return await this.selectServerByMinQueue()\n   }\n \n   /**\n+   * æ‰‹åŠ¨è§¦å‘æœåŠ¡å™¨åˆ‡æ¢\n+   */\n+  async switchToNextServer() {\n+    console.log('ğŸ”„ æ‰‹åŠ¨è§¦å‘æœåŠ¡å™¨åˆ‡æ¢...')\n+\n+    // å¦‚æœå½“å‰æœ‰é”å®šçš„æœåŠ¡å™¨ï¼Œå°†å…¶æ ‡è®°ä¸ºå¤±è´¥\n+    if (this.lockedServer) {\n+      console.log(`ğŸ“ æ ‡è®°å½“å‰æœåŠ¡å™¨ä¸ºå¤±è´¥: ${this.lockedServer}`)\n+      await this.recordFailure(this.lockedServer, 'manual_switch')\n+    }\n+\n+    // å¼ºåˆ¶é‡æ–°è¯„ä¼°å¹¶é€‰æ‹©æ–°æœåŠ¡å™¨\n+    await this.forceReassessment()\n+    const newServer = await this.selectServerByMinQueue()\n+\n+    console.log(`âœ… æ‰‹åŠ¨åˆ‡æ¢å®Œæˆï¼Œæ–°æœåŠ¡å™¨: ${newServer}`)\n+    return newServer\n+  }\n+\n+  /**\n+   * è·å–ä¸‹ä¸€ä¸ªå¯ç”¨æœåŠ¡å™¨ï¼ˆä¸é”å®šï¼‰\n+   */\n+  async getNextAvailableServer(excludeUrls = []) {\n+    await this.updateServerLoads()\n+\n+    const availableServers = Array.from(this.serverLoads.values())\n+      .filter(server => {\n+        if (!server.healthy) return false\n+        if (excludeUrls.includes(server.url)) return false\n+\n+        const failures = this.serverFailures.get(server.url) || 0\n+        return failures < this.failureThreshold\n+      })\n+      .sort((a, b) => {\n+        const failureA = this.serverFailures.get(a.url) || 0\n+        const failureB = this.serverFailures.get(b.url) || 0\n+        if (failureA !== failureB) return failureA - failureB\n+\n+        const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n+        if (queueDiff !== 0) return queueDiff\n+\n+        return a.priority - b.priority\n+      })\n+\n+    return availableServers.length > 0 ? availableServers[0].url : null\n+  }\n+\n+  /**\n    * å¼ºåˆ¶é‡æ–°è¯„ä¼°æ‰€æœ‰æœåŠ¡å™¨\n    */\n   async forceReassessment() {\n     console.log('ğŸ”„ å¼ºåˆ¶é‡æ–°è¯„ä¼°æ‰€æœ‰æœåŠ¡å™¨...')\n"
                },
                {
                    "date": 1752459661531,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,11 +18,8 @@\n     this.updateInterval = 8000 // 8ç§’æ›´æ–°é—´éš”ï¼ˆæ›´é¢‘ç¹çš„æ›´æ–°ï¼‰\n     this.forceUpdateThreshold = 20000 // 20ç§’å¼ºåˆ¶æ›´æ–°é˜ˆå€¼\n     this.failureThreshold = 2 // è¿ç»­å¤±è´¥2æ¬¡åæ ‡è®°ä¸ºä¸å¥åº·\n     this.serverFailures = new Map() // è®°å½•æœåŠ¡å™¨å¤±è´¥æ¬¡æ•°\n-    this.autoFailoverEnabled = true // å¯ç”¨è‡ªåŠ¨æ•…éšœè½¬ç§»\n-    this.lastFailoverTime = 0\n-    this.failoverCooldown = 5000 // æ•…éšœè½¬ç§»å†·å´æ—¶é—´5ç§’\n     this.healthMonitorInterval = null // å¥åº·ç›‘æ§å®šæ—¶å™¨\n     this.healthMonitorFrequency = 30000 // 30ç§’æ£€æŸ¥ä¸€æ¬¡å¥åº·çŠ¶æ€\n   }\n \n"
                },
                {
                    "date": 1752459681684,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -513,12 +513,9 @@\n       serverInfo.lastErrorType = errorType\n       this.serverLoads.set(serverUrl, serverInfo)\n     }\n \n-    // å¦‚æœè¾¾åˆ°å¤±è´¥é˜ˆå€¼ä¸”å¯ç”¨è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œè§¦å‘æ•…éšœè½¬ç§»\n-    if (newFailures >= this.failureThreshold && this.autoFailoverEnabled) {\n-      await this.triggerFailover(serverUrl)\n-    }\n+    // è®°å½•å¤±è´¥ä½†ä¸è‡ªåŠ¨åˆ‡æ¢ï¼Œç”±ç”¨æˆ·æ‰‹åŠ¨å†³å®š\n \n     // å¼ºåˆ¶æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n     this.lastUpdateTime = 0\n   }\n"
                },
                {
                    "date": 1752459701776,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -519,40 +519,10 @@\n     // å¼ºåˆ¶æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n     this.lastUpdateTime = 0\n   }\n \n-  /**\n-   * è§¦å‘æ•…éšœè½¬ç§»\n-   */\n-  async triggerFailover(failedServerUrl) {\n-    const now = Date.now()\n \n-    // æ£€æŸ¥æ•…éšœè½¬ç§»å†·å´æ—¶é—´\n-    if (now - this.lastFailoverTime < this.failoverCooldown) {\n-      console.log('â³ æ•…éšœè½¬ç§»å†·å´ä¸­ï¼Œè·³è¿‡æ­¤æ¬¡è½¬ç§»')\n-      return\n-    }\n \n-    console.log(`ğŸ”„ è§¦å‘æ•…éšœè½¬ç§»ï¼Œå¤±è´¥æœåŠ¡å™¨: ${failedServerUrl}`)\n-    this.lastFailoverTime = now\n-\n-    // å¼ºåˆ¶é‡æ–°è¯„ä¼°æ‰€æœ‰æœåŠ¡å™¨\n-    await this.forceReassessment()\n-\n-    // å°è¯•é€‰æ‹©æ–°çš„æœåŠ¡å™¨\n-    try {\n-      const newServer = await this.selectServerByMinQueue()\n-      if (newServer && newServer !== failedServerUrl) {\n-        console.log(`âœ… æ•…éšœè½¬ç§»æˆåŠŸï¼Œæ–°æœåŠ¡å™¨: ${newServer}`)\n-        return newServer\n-      } else {\n-        console.warn('âš ï¸ æ•…éšœè½¬ç§»å¤±è´¥ï¼Œæ²¡æœ‰å¯ç”¨çš„æ›¿ä»£æœåŠ¡å™¨')\n-      }\n-    } catch (error) {\n-      console.error('âŒ æ•…éšœè½¬ç§»è¿‡ç¨‹ä¸­å‡ºé”™:', error)\n-    }\n-  }\n-\n   /**\n    * é‡ç½®æœåŠ¡å™¨å¤±è´¥è®¡æ•°\n    */\n   resetFailureCount(serverUrl) {\n"
                },
                {
                    "date": 1752469902720,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -20,8 +20,13 @@\n     this.failureThreshold = 2 // è¿ç»­å¤±è´¥2æ¬¡åæ ‡è®°ä¸ºä¸å¥åº·\n     this.serverFailures = new Map() // è®°å½•æœåŠ¡å™¨å¤±è´¥æ¬¡æ•°\n     this.healthMonitorInterval = null // å¥åº·ç›‘æ§å®šæ—¶å™¨\n     this.healthMonitorFrequency = 30000 // 30ç§’æ£€æŸ¥ä¸€æ¬¡å¥åº·çŠ¶æ€\n+\n+    // WebSocketä¸“ç”¨é”å®šæœºåˆ¶\n+    this.webSocketLockedServer = null\n+    this.webSocketLockTime = 0\n+    this.webSocketLockDuration = 300000 // WebSocketé”å®š5åˆ†é’Ÿï¼Œå› ä¸ºæ˜¯é•¿è¿æ¥\n   }\n \n   /**\n    * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n"
                },
                {
                    "date": 1752469927232,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -449,9 +449,9 @@\n     return fallbackUrl\n   }\n \n   /**\n-   * é”å®šæœåŠ¡å™¨\n+   * é”å®šæœåŠ¡å™¨ï¼ˆæ™®é€šHTTPè¯·æ±‚ï¼‰\n    */\n   lockServer(serverUrl) {\n     this.lockedServer = serverUrl\n     this.lastLockTime = Date.now()\n@@ -461,8 +461,59 @@\n     this.logServerStatus()\n   }\n \n   /**\n+   * é”å®šæœåŠ¡å™¨ç”¨äºWebSocketè¿æ¥\n+   */\n+  lockServerForWebSocket(serverUrl) {\n+    this.webSocketLockedServer = serverUrl\n+    this.webSocketLockTime = Date.now()\n+    console.log(`ğŸ”’ğŸŒ é”å®šæœåŠ¡å™¨ç”¨äºWebSocket: ${serverUrl}, æŒç»­ ${this.webSocketLockDuration / 1000} ç§’`)\n+\n+    // åŒæ—¶è®¾ç½®æ™®é€šé”å®šï¼Œç¡®ä¿ä¸€è‡´æ€§\n+    this.lockServer(serverUrl)\n+  }\n+\n+  /**\n+   * é‡Šæ”¾WebSocketæœåŠ¡å™¨é”å®š\n+   */\n+  unlockWebSocketServer() {\n+    if (this.webSocketLockedServer) {\n+      console.log(`ğŸ”“ğŸŒ é‡Šæ”¾WebSocketæœåŠ¡å™¨é”å®š: ${this.webSocketLockedServer}`)\n+      this.webSocketLockedServer = null\n+      this.webSocketLockTime = 0\n+    }\n+  }\n+\n+  /**\n+   * æ£€æŸ¥WebSocketæœåŠ¡å™¨æ˜¯å¦è¢«é”å®š\n+   */\n+  isWebSocketServerLocked() {\n+    if (!this.webSocketLockedServer) return false\n+\n+    const now = Date.now()\n+    const isLocked = (now - this.webSocketLockTime) < this.webSocketLockDuration\n+\n+    if (!isLocked) {\n+      console.log('ğŸ”“ğŸŒ WebSocketæœåŠ¡å™¨é”å®šå·²è¿‡æœŸ')\n+      this.webSocketLockedServer = null\n+      this.webSocketLockTime = 0\n+    }\n+\n+    return isLocked\n+  }\n+\n+  /**\n+   * è·å–WebSocketé”å®šçš„æœåŠ¡å™¨\n+   */\n+  getWebSocketLockedServer() {\n+    if (this.isWebSocketServerLocked()) {\n+      return this.webSocketLockedServer\n+    }\n+    return null\n+  }\n+\n+  /**\n    * æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¢«é”å®š\n    */\n   isServerLocked() {\n     if (!this.lockedServer) return false\n"
                },
                {
                    "date": 1752469945266,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -317,9 +317,18 @@\n   async selectServerByMinQueue() {\n     try {\n       console.log('ğŸ¯ å¼€å§‹é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨...')\n \n-      // æ£€æŸ¥æ˜¯å¦æœ‰é”å®šçš„æœåŠ¡å™¨\n+      // ä¼˜å…ˆæ£€æŸ¥WebSocketé”å®šçš„æœåŠ¡å™¨\n+      if (this.isWebSocketServerLocked()) {\n+        const webSocketServer = this.getWebSocketLockedServer()\n+        if (webSocketServer) {\n+          console.log(`ğŸ”’ğŸŒ ä½¿ç”¨WebSocketé”å®šçš„æœåŠ¡å™¨: ${webSocketServer}`)\n+          return webSocketServer\n+        }\n+      }\n+\n+      // æ£€æŸ¥æ˜¯å¦æœ‰æ™®é€šé”å®šçš„æœåŠ¡å™¨\n       if (this.isServerLocked()) {\n         const lockedServer = this.getLockedServer()\n         if (lockedServer) {\n           console.log(`ğŸ”’ ä½¿ç”¨é”å®šçš„æœåŠ¡å™¨: ${lockedServer}`)\n"
                },
                {
                    "date": 1752508063038,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -32,10 +32,8 @@\n    * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n    */\n   async initialize() {\n     try {\n-      console.log('ğŸš€ åˆå§‹åŒ– ComfyUI è´Ÿè½½å‡è¡¡å™¨...')\n-\n       // è·å–æœåŠ¡å™¨é…ç½®\n       const config = await configService.getConfig()\n \n       // æ„å»ºæœåŠ¡å™¨åˆ—è¡¨\n@@ -67,9 +65,8 @@\n       }\n \n       // å¦‚æœæ²¡æœ‰é…ç½®æœåŠ¡å™¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®\n       if (this.servers.length === 0) {\n-        console.warn('âš ï¸ æœªæ‰¾åˆ°é…ç½®çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®')\n         // ä»æœ¬åœ°é…ç½®è·å–é»˜è®¤æœåŠ¡å™¨\n         const localConfig = JSON.parse(localStorage.getItem('comfyui_config') || '{}')\n         const defaultUrl = localConfig.COMFYUI_SERVER_URL || 'https://your-comfyui-server.com'\n \n@@ -79,25 +76,17 @@\n           priority: 1\n         })\n       }\n \n-      console.log(`âœ… å‘ç° ${this.servers.length} ä¸ª ComfyUI æœåŠ¡å™¨:`)\n-      this.servers.forEach((server, index) => {\n-        console.log(`   ${index + 1}. ${server.url} (${server.type})`)\n-      })\n-\n       // åˆå§‹åŒ–æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n       await this.updateServerLoads()\n \n       // å¯åŠ¨å¥åº·ç›‘æ§\n       this.startHealthMonitoring()\n \n-      console.log('âœ… ComfyUI è´Ÿè½½å‡è¡¡å™¨åˆå§‹åŒ–å®Œæˆ')\n-\n     } catch (error) {\n-      console.error('âŒ è´Ÿè½½å‡è¡¡å™¨åˆå§‹åŒ–å¤±è´¥:', error)\n+      console.error('è´Ÿè½½å‡è¡¡å™¨åˆå§‹åŒ–å¤±è´¥:', error)\n       // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸åº”ç”¨ç»§ç»­è¿è¡Œ\n-      console.log('ğŸ”„ ä½¿ç”¨é™çº§æ¨¡å¼ï¼Œå°†ä½¿ç”¨å•æœåŠ¡å™¨é…ç½®')\n     }\n   }\n \n   /**\n"
                },
                {
                    "date": 1752508506549,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -96,20 +96,16 @@\n     const now = Date.now()\n \n     // å¦‚æœè·ç¦»ä¸Šæ¬¡æ›´æ–°æ—¶é—´ä¸è¶³é—´éš”ï¼Œè·³è¿‡æ›´æ–°ï¼ˆé™¤éå¼ºåˆ¶æ›´æ–°æˆ–è¶…è¿‡å¼ºåˆ¶æ›´æ–°é˜ˆå€¼ï¼‰\n     if (!forceUpdate && now - this.lastUpdateTime < this.updateInterval && now - this.lastUpdateTime < this.forceUpdateThreshold) {\n-      console.log('â­ï¸ è·³è¿‡è´Ÿè½½æ›´æ–°ï¼Œè·ç¦»ä¸Šæ¬¡æ›´æ–°æ—¶é—´ä¸è¶³')\n       return\n     }\n \n     // å¦‚æœè¶…è¿‡å¼ºåˆ¶æ›´æ–°é˜ˆå€¼ï¼Œå¼ºåˆ¶æ›´æ–°\n     if (now - this.lastUpdateTime > this.forceUpdateThreshold) {\n-      console.log('ğŸ”„ å¼ºåˆ¶æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯ï¼ˆè¶…è¿‡å¼ºåˆ¶æ›´æ–°é˜ˆå€¼ï¼‰')\n       forceUpdate = true\n     }\n \n-    console.log('ğŸ”„ æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯...')\n-\n     const updatePromises = this.servers.map(async (server) => {\n       try {\n         // å¹¶è¡Œæ£€æŸ¥å¥åº·çŠ¶æ€å’Œé˜Ÿåˆ—ä¿¡æ¯\n         const [healthResult, queueResult] = await Promise.allSettled([\n"
                },
                {
                    "date": 1752508528269,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -120,9 +120,8 @@\n         const isHealthy = this.determineServerHealth(health, queue, server)\n \n         // å¦‚æœæœåŠ¡å™¨æ¢å¤å¥åº·ï¼Œé‡ç½®å¤±è´¥è®¡æ•°\n         if (isHealthy && this.serverFailures.has(server.url)) {\n-          console.log(`âœ… æœåŠ¡å™¨ ${server.url} å·²æ¢å¤å¥åº·ï¼Œé‡ç½®å¤±è´¥è®¡æ•°`)\n           this.resetFailureCount(server.url)\n         }\n \n         this.serverLoads.set(server.url, {\n@@ -134,11 +133,8 @@\n           healthDetails: { health, queue },\n           failureCount: this.serverFailures.get(server.url) || 0\n         })\n \n-        const queueInfo = queue.healthy ? `é˜Ÿåˆ—=${queue.total || 0}(è¿è¡Œ:${queue.running || 0},ç­‰å¾…:${queue.pending || 0})` : `é˜Ÿåˆ—æ£€æŸ¥å¤±è´¥`\n-        console.log(`ğŸ“Š ${server.url}: å¥åº·=${health.healthy}, ${queueInfo}, å“åº”æ—¶é—´=${health.responseTime || 0}ms`)\n-\n       } catch (error) {\n         console.error(`âŒ æ›´æ–°æœåŠ¡å™¨è´Ÿè½½å¤±è´¥ ${server.url}:`, error)\n         this.serverLoads.set(server.url, {\n           ...server,\n"
                },
                {
                    "date": 1752510457366,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -134,9 +134,8 @@\n           failureCount: this.serverFailures.get(server.url) || 0\n         })\n \n       } catch (error) {\n-        console.error(`âŒ æ›´æ–°æœåŠ¡å™¨è´Ÿè½½å¤±è´¥ ${server.url}:`, error)\n         this.serverLoads.set(server.url, {\n           ...server,\n           healthy: false,\n           queue: { total: 999, healthy: false },\n"
                },
                {
                    "date": 1752510740858,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -203,9 +203,8 @@\n         return { healthy: false, responseTime, status: response.status }\n       }\n \n     } catch (error) {\n-      console.warn(`âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ ${serverUrl}:`, error.message)\n       return { healthy: false, error: error.message }\n     }\n   }\n \n"
                },
                {
                    "date": 1752510756620,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -246,9 +246,8 @@\n         return await this.getServerQueueInfoFallback(serverUrl)\n       }\n \n     } catch (error) {\n-      console.warn(`âš ï¸ é˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥ ${serverUrl}:`, error.message)\n       return await this.getServerQueueInfoFallback(serverUrl)\n     }\n   }\n \n"
                },
                {
                    "date": 1752510769668,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -325,9 +325,8 @@\n \n           // è¿‡æ»¤æ‰å¤±è´¥æ¬¡æ•°è¿‡å¤šçš„æœåŠ¡å™¨\n           const failures = this.serverFailures.get(server.url) || 0\n           if (failures >= this.failureThreshold) {\n-            console.log(`âš ï¸ è·³è¿‡å¤±è´¥æ¬¡æ•°è¿‡å¤šçš„æœåŠ¡å™¨: ${server.url} (${failures}æ¬¡)`)\n             return false\n           }\n \n           return true\n"
                },
                {
                    "date": 1752510840077,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -410,29 +410,26 @@\n       const config = await configService.getConfig()\n       const defaultServer = config['comfyui.server_url']\n \n       if (defaultServer && defaultServer !== 'https://your-comfyui-server.com') {\n-        console.log(`ğŸ†˜ é…ç½®æœåŠ¡é»˜è®¤æœåŠ¡å™¨: ${defaultServer}`)\n         return defaultServer\n       }\n     } catch (error) {\n-      console.warn('âš ï¸ æ— æ³•ä»é…ç½®æœåŠ¡è·å–é»˜è®¤æœåŠ¡å™¨:', error)\n+      // å¿½ç•¥é…ç½®æœåŠ¡é”™è¯¯\n     }\n \n     // ä»æœ¬åœ°å­˜å‚¨è·å–\n     try {\n       const localConfig = JSON.parse(localStorage.getItem('comfyui_config') || '{}')\n       if (localConfig.COMFYUI_SERVER_URL) {\n-        console.log(`ğŸ†˜ æœ¬åœ°é…ç½®æœåŠ¡å™¨: ${localConfig.COMFYUI_SERVER_URL}`)\n         return localConfig.COMFYUI_SERVER_URL\n       }\n     } catch (error) {\n-      console.warn('âš ï¸ æ— æ³•ä»æœ¬åœ°å­˜å‚¨è·å–æœåŠ¡å™¨é…ç½®:', error)\n+      // å¿½ç•¥æœ¬åœ°å­˜å‚¨é”™è¯¯\n     }\n \n     // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆ\n     const fallbackUrl = 'https://your-comfyui-server.com'\n-    console.log(`ğŸ†˜ ä½¿ç”¨æœ€åå¤‡ç”¨æœåŠ¡å™¨: ${fallbackUrl}`)\n     return fallbackUrl\n   }\n \n   /**\n"
                },
                {
                    "date": 1752511013565,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -437,12 +437,8 @@\n    */\n   lockServer(serverUrl) {\n     this.lockedServer = serverUrl\n     this.lastLockTime = Date.now()\n-    console.log(`ğŸ”’ é”å®šæœåŠ¡å™¨: ${serverUrl}, æŒç»­ ${this.lockDuration / 1000} ç§’`)\n-\n-    // æ˜¾ç¤ºå½“å‰æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€\n-    this.logServerStatus()\n   }\n \n   /**\n    * é”å®šæœåŠ¡å™¨ç”¨äºWebSocketè¿æ¥\n"
                },
                {
                    "date": 1752511030024,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -522,20 +522,15 @@\n   /**\n    * è®°å½•æœåŠ¡å™¨å¤±è´¥\n    */\n   async recordFailure(serverUrl, errorType = 'unknown') {\n-    console.log(`ğŸ“ è®°å½•æœåŠ¡å™¨å¤±è´¥: ${serverUrl}, é”™è¯¯ç±»å‹: ${errorType}`)\n-\n     // å¢åŠ å¤±è´¥è®¡æ•°\n     const currentFailures = this.serverFailures.get(serverUrl) || 0\n     const newFailures = currentFailures + 1\n     this.serverFailures.set(serverUrl, newFailures)\n \n-    console.log(`âš ï¸ æœåŠ¡å™¨ ${serverUrl} å¤±è´¥æ¬¡æ•°: ${newFailures}/${this.failureThreshold}`)\n-\n     // å¦‚æœå¤±è´¥çš„æ˜¯å½“å‰é”å®šçš„æœåŠ¡å™¨ï¼Œç«‹å³è§£é™¤é”å®š\n     if (this.lockedServer === serverUrl) {\n-      console.log('ğŸ”“ ç«‹å³è§£é™¤å¤±è´¥æœåŠ¡å™¨çš„é”å®š')\n       this.lockedServer = null\n       this.lastLockTime = 0\n     }\n \n"
                },
                {
                    "date": 1752511051247,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -729,18 +729,15 @@\n   /**\n    * æ‰§è¡Œå¥åº·ç›‘æ§\n    */\n   async performHealthMonitoring() {\n-    console.log('ğŸ¥ æ‰§è¡Œå®šæœŸå¥åº·æ£€æŸ¥...')\n-\n     // æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n     await this.updateServerLoads()\n \n     // æ£€æŸ¥å½“å‰é”å®šçš„æœåŠ¡å™¨æ˜¯å¦ä»ç„¶å¥åº·\n     if (this.lockedServer) {\n       const lockedServerInfo = this.serverLoads.get(this.lockedServer)\n       if (lockedServerInfo && !lockedServerInfo.healthy) {\n-        console.warn(`âš ï¸ é”å®šçš„æœåŠ¡å™¨ ${this.lockedServer} ä¸å¥åº·ï¼Œè§£é™¤é”å®š`)\n         this.lockedServer = null\n         this.lastLockTime = 0\n       }\n     }\n@@ -748,12 +745,11 @@\n     // æ£€æŸ¥æ˜¯å¦æœ‰æœåŠ¡å™¨ä»æ•…éšœä¸­æ¢å¤\n     const healthyServers = Array.from(this.serverLoads.values())\n       .filter(server => server.healthy)\n \n-    if (healthyServers.length > 0) {\n-      console.log(`âœ… å¥åº·ç›‘æ§å®Œæˆï¼Œå‘ç° ${healthyServers.length} ä¸ªå¥åº·æœåŠ¡å™¨`)\n-    } else {\n-      console.warn('âš ï¸ å¥åº·ç›‘æ§è­¦å‘Šï¼šæ²¡æœ‰å‘ç°å¥åº·çš„æœåŠ¡å™¨')\n+    // åªåœ¨æ²¡æœ‰å¥åº·æœåŠ¡å™¨æ—¶è¾“å‡ºè­¦å‘Š\n+    if (healthyServers.length === 0) {\n+      console.warn('è­¦å‘Šï¼šæ²¡æœ‰å‘ç°å¥åº·çš„ComfyUIæœåŠ¡å™¨')\n     }\n   }\n \n   /**\n"
                },
                {
                    "date": 1752511069436,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -760,9 +760,8 @@\n     this.servers = []\n     this.serverLoads.clear()\n     this.serverFailures.clear()\n     this.lockedServer = null\n-    console.log('ğŸ—‘ï¸ è´Ÿè½½å‡è¡¡å™¨å·²é”€æ¯')\n   }\n }\n \n // åˆ›å»ºå•ä¾‹å®ä¾‹\n"
                },
                {
                    "date": 1752512395604,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,32 +1,16 @@\n-// ComfyUI è´Ÿè½½å‡è¡¡å™¨ - åŸºäºä»»åŠ¡é˜Ÿåˆ—çš„æ™ºèƒ½é€‰æ‹©\n+// ComfyUI æç®€è´Ÿè½½å‡è¡¡å™¨\n import configService from './configService.js'\n \n /**\n- * ComfyUI è´Ÿè½½å‡è¡¡å™¨\n- * æ ¹æ®æœåŠ¡å™¨ä»»åŠ¡é˜Ÿåˆ—æƒ…å†µé€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n+ * ComfyUI æç®€è´Ÿè½½å‡è¡¡å™¨\n+ * åªåœ¨ç”¨æˆ·å‘èµ·è¯·æ±‚æ—¶é€‰æ‹©é˜Ÿåˆ—æœ€å°‘çš„å¯ç”¨æœåŠ¡å™¨\n  */\n class ComfyUILoadBalancer {\n   constructor() {\n-    this.servers = []\n-    this.serverLoads = new Map()\n-    this.lockedServer = null\n-    this.lastLockTime = 0\n-    this.lockDuration = 15000 // ç¼©çŸ­é”å®šæ—¶é—´åˆ°15ç§’\n-    this.healthCheckTimeout = 10000 // 10ç§’å¥åº·æ£€æŸ¥è¶…æ—¶\n-    this.queueCheckTimeout = 6000 // 6ç§’é˜Ÿåˆ—æ£€æŸ¥è¶…æ—¶\n-    this.lastUpdateTime = 0\n-    this.updateInterval = 8000 // 8ç§’æ›´æ–°é—´éš”ï¼ˆæ›´é¢‘ç¹çš„æ›´æ–°ï¼‰\n-    this.forceUpdateThreshold = 20000 // 20ç§’å¼ºåˆ¶æ›´æ–°é˜ˆå€¼\n-    this.failureThreshold = 2 // è¿ç»­å¤±è´¥2æ¬¡åæ ‡è®°ä¸ºä¸å¥åº·\n-    this.serverFailures = new Map() // è®°å½•æœåŠ¡å™¨å¤±è´¥æ¬¡æ•°\n-    this.healthMonitorInterval = null // å¥åº·ç›‘æ§å®šæ—¶å™¨\n-    this.healthMonitorFrequency = 30000 // 30ç§’æ£€æŸ¥ä¸€æ¬¡å¥åº·çŠ¶æ€\n-\n-    // WebSocketä¸“ç”¨é”å®šæœºåˆ¶\n-    this.webSocketLockedServer = null\n-    this.webSocketLockTime = 0\n-    this.webSocketLockDuration = 300000 // WebSocketé”å®š5åˆ†é’Ÿï¼Œå› ä¸ºæ˜¯é•¿è¿æ¥\n+    this.queueCheckTimeout = 5000 // 5ç§’é˜Ÿåˆ—æ£€æŸ¥è¶…æ—¶\n+    this.healthCheckTimeout = 5000 // 5ç§’å¥åº·æ£€æŸ¥è¶…æ—¶\n+    this.initialized = false\n   }\n \n   /**\n    * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n"
                },
                {
                    "date": 1752513381012,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,184 +12,113 @@\n     this.initialized = false\n   }\n \n   /**\n-   * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n+   * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨ï¼ˆä»…åœ¨é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰\n    */\n   async initialize() {\n+    if (this.initialized) {\n+      return\n+    }\n+\n     try {\n-      // è·å–æœåŠ¡å™¨é…ç½®\n+      console.log('ğŸ”„ åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨...')\n+      this.initialized = true\n+      console.log('âœ… è´Ÿè½½å‡è¡¡å™¨åˆå§‹åŒ–å®Œæˆ')\n+    } catch (error) {\n+      console.error('âŒ è´Ÿè½½å‡è¡¡å™¨åˆå§‹åŒ–å¤±è´¥:', error)\n+      this.initialized = false\n+    }\n+  }\n+\n+  /**\n+   * è·å–æœ€æ–°çš„æœåŠ¡å™¨åˆ—è¡¨ï¼ˆä»æ•°æ®åº“/é…ç½®ä¸­è·å–ï¼‰\n+   */\n+  async getLatestServerList() {\n+    try {\n+      console.log('ğŸ”„ è·å–æœ€æ–°æœåŠ¡å™¨åˆ—è¡¨...')\n+\n+      // ä»é…ç½®æœåŠ¡è·å–æœ€æ–°é…ç½®\n       const config = await configService.getConfig()\n+      const servers = []\n \n-      // æ„å»ºæœåŠ¡å™¨åˆ—è¡¨\n-      this.servers = []\n-\n       // ä¸»æœåŠ¡å™¨\n       if (config['comfyui.server_url']) {\n-        this.servers.push({\n+        servers.push({\n           url: config['comfyui.server_url'],\n           type: 'primary',\n           priority: 1\n         })\n       }\n \n-      // å¤‡ç”¨æœåŠ¡å™¨\n+      // å¤‡ç”¨æœåŠ¡å™¨ - æ”¯æŒæ¢è¡Œç¬¦å’Œé€—å·ä¸¤ç§åˆ†éš”æ–¹å¼\n       if (config['comfyui.backup_servers']) {\n         const backupServers = config['comfyui.backup_servers']\n+          .replace(/\\s*,\\s*/g, '\\n') // å°†é€—å·æ›¿æ¢ä¸ºæ¢è¡Œç¬¦\n           .split('\\n')\n           .map(url => url.trim())\n           .filter(url => url && url.startsWith('http'))\n \n         backupServers.forEach((url, index) => {\n-          this.servers.push({\n+          servers.push({\n             url,\n             type: 'backup',\n             priority: index + 2\n           })\n         })\n       }\n \n       // å¦‚æœæ²¡æœ‰é…ç½®æœåŠ¡å™¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®\n-      if (this.servers.length === 0) {\n-        // ä»æœ¬åœ°é…ç½®è·å–é»˜è®¤æœåŠ¡å™¨\n+      if (servers.length === 0) {\n         const localConfig = JSON.parse(localStorage.getItem('comfyui_config') || '{}')\n         const defaultUrl = localConfig.COMFYUI_SERVER_URL || 'https://your-comfyui-server.com'\n \n-        this.servers.push({\n+        servers.push({\n           url: defaultUrl,\n           type: 'primary',\n           priority: 1\n         })\n       }\n \n-      // åˆå§‹åŒ–æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n-      await this.updateServerLoads()\n+      console.log(`âœ… è·å–åˆ° ${servers.length} ä¸ªæœåŠ¡å™¨:`, servers.map(s => s.url))\n+      return servers\n \n-      // å¯åŠ¨å¥åº·ç›‘æ§\n-      this.startHealthMonitoring()\n-\n     } catch (error) {\n-      console.error('è´Ÿè½½å‡è¡¡å™¨åˆå§‹åŒ–å¤±è´¥:', error)\n-      // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸åº”ç”¨ç»§ç»­è¿è¡Œ\n+      console.error('âŒ è·å–æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥:', error)\n+      return []\n     }\n   }\n \n   /**\n-   * æ›´æ–°æ‰€æœ‰æœåŠ¡å™¨çš„è´Ÿè½½ä¿¡æ¯\n-   */\n-  async updateServerLoads(forceUpdate = false) {\n-    const now = Date.now()\n-\n-    // å¦‚æœè·ç¦»ä¸Šæ¬¡æ›´æ–°æ—¶é—´ä¸è¶³é—´éš”ï¼Œè·³è¿‡æ›´æ–°ï¼ˆé™¤éå¼ºåˆ¶æ›´æ–°æˆ–è¶…è¿‡å¼ºåˆ¶æ›´æ–°é˜ˆå€¼ï¼‰\n-    if (!forceUpdate && now - this.lastUpdateTime < this.updateInterval && now - this.lastUpdateTime < this.forceUpdateThreshold) {\n-      return\n-    }\n-\n-    // å¦‚æœè¶…è¿‡å¼ºåˆ¶æ›´æ–°é˜ˆå€¼ï¼Œå¼ºåˆ¶æ›´æ–°\n-    if (now - this.lastUpdateTime > this.forceUpdateThreshold) {\n-      forceUpdate = true\n-    }\n-\n-    const updatePromises = this.servers.map(async (server) => {\n-      try {\n-        // å¹¶è¡Œæ£€æŸ¥å¥åº·çŠ¶æ€å’Œé˜Ÿåˆ—ä¿¡æ¯\n-        const [healthResult, queueResult] = await Promise.allSettled([\n-          this.checkServerHealth(server.url),\n-          this.getServerQueueInfo(server.url)\n-        ])\n-\n-        const health = healthResult.status === 'fulfilled' ? healthResult.value : { healthy: false }\n-        const queue = queueResult.status === 'fulfilled' ? queueResult.value : { total: 999, healthy: false }\n-\n-        // æ›´æ™ºèƒ½çš„å¥åº·çŠ¶æ€åˆ¤æ–­\n-        const isHealthy = this.determineServerHealth(health, queue, server)\n-\n-        // å¦‚æœæœåŠ¡å™¨æ¢å¤å¥åº·ï¼Œé‡ç½®å¤±è´¥è®¡æ•°\n-        if (isHealthy && this.serverFailures.has(server.url)) {\n-          this.resetFailureCount(server.url)\n-        }\n-\n-        this.serverLoads.set(server.url, {\n-          ...server,\n-          healthy: isHealthy,\n-          queue: queue,\n-          lastCheck: now,\n-          responseTime: health.responseTime || 0,\n-          healthDetails: { health, queue },\n-          failureCount: this.serverFailures.get(server.url) || 0\n-        })\n-\n-      } catch (error) {\n-        this.serverLoads.set(server.url, {\n-          ...server,\n-          healthy: false,\n-          queue: { total: 999, healthy: false },\n-          lastCheck: now,\n-          error: error.message\n-        })\n-      }\n-    })\n-\n-    await Promise.allSettled(updatePromises)\n-    this.lastUpdateTime = now\n-\n-    console.log('âœ… æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯æ›´æ–°å®Œæˆ')\n-  }\n-\n-  /**\n-   * æ›´æ™ºèƒ½çš„æœåŠ¡å™¨å¥åº·çŠ¶æ€åˆ¤æ–­\n-   */\n-  determineServerHealth(health, queue, server) {\n-    // å¦‚æœå¥åº·æ£€æŸ¥å®Œå…¨å¤±è´¥ï¼Œæ ‡è®°ä¸ºä¸å¥åº·\n-    if (!health.healthy) {\n-      return false\n-    }\n-\n-    // å¦‚æœé˜Ÿåˆ—æ£€æŸ¥å¤±è´¥ä½†å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œä»ç„¶è®¤ä¸ºæœåŠ¡å™¨å¯ç”¨\n-    // è¿™æ ·å¯ä»¥é¿å…å› ä¸ºé˜Ÿåˆ—APIä¸å¯ç”¨è€Œé”™è¯¯åœ°æ ‡è®°æœåŠ¡å™¨ä¸ºä¸å¥åº·\n-    if (!queue.healthy) {\n-      console.log(`âš ï¸ æœåŠ¡å™¨ ${server.url} é˜Ÿåˆ—æ£€æŸ¥å¤±è´¥ï¼Œä½†å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œä»æ ‡è®°ä¸ºå¯ç”¨`)\n-      return true\n-    }\n-\n-    // å¦‚æœé˜Ÿåˆ—è¿‡é•¿ï¼ˆè¶…è¿‡10ä¸ªä»»åŠ¡ï¼‰ï¼Œé™ä½ä¼˜å…ˆçº§ä½†ä¸æ ‡è®°ä¸ºä¸å¥åº·\n-    if (queue.total > 10) {\n-      console.log(`âš ï¸ æœåŠ¡å™¨ ${server.url} é˜Ÿåˆ—è¾ƒé•¿ (${queue.total})ï¼Œä½†ä»å¯ç”¨`)\n-      return true\n-    }\n-\n-    return true\n-  }\n-\n-  /**\n    * æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€\n    */\n   async checkServerHealth(serverUrl) {\n     try {\n-      const startTime = Date.now()\n-\n       const controller = new AbortController()\n       const timeoutId = setTimeout(() => controller.abort(), this.healthCheckTimeout)\n \n+      const startTime = Date.now()\n       const response = await fetch(`${serverUrl}/system_stats`, {\n         method: 'GET',\n         signal: controller.signal,\n         headers: {\n-          'Content-Type': 'application/json'\n+          'Cache-Control': 'no-cache'\n         }\n       })\n+      const endTime = Date.now()\n \n       clearTimeout(timeoutId)\n-      const responseTime = Date.now() - startTime\n \n-      if (response.ok) {\n-        return { healthy: true, responseTime, status: response.status }\n-      } else {\n-        return { healthy: false, responseTime, status: response.status }\n+      return {\n+        healthy: response.ok,\n+        responseTime: endTime - startTime,\n+        status: response.status\n       }\n-\n     } catch (error) {\n-      return { healthy: false, error: error.message }\n+      return {\n+        healthy: false,\n+        error: error.message\n+      }\n     }\n   }\n \n   /**\n@@ -203,16 +132,18 @@\n       const response = await fetch(`${serverUrl}/queue`, {\n         method: 'GET',\n         signal: controller.signal,\n         headers: {\n-          'Content-Type': 'application/json'\n+          'Content-Type': 'application/json',\n+          'Cache-Control': 'no-cache'\n         }\n       })\n \n       clearTimeout(timeoutId)\n \n       if (response.ok) {\n         const queueData = await response.json()\n+        console.log(`ğŸ“Š æœåŠ¡å™¨ ${serverUrl} é˜Ÿåˆ—æ•°æ®:`, queueData)\n \n         // ComfyUI é˜Ÿåˆ— API è¿”å›æ ¼å¼: { queue_running: [...], queue_pending: [...] }\n         const running = queueData.queue_running ? queueData.queue_running.length : 0\n         const pending = queueData.queue_pending ? queueData.queue_pending.length : 0\n@@ -221,532 +152,150 @@\n         return {\n           running,\n           pending,\n           total,\n-          healthy: true,\n-          supportsQueueAPI: true\n+          healthy: true\n         }\n       } else {\n-        // å¦‚æœé˜Ÿåˆ— API ä¸å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨ç³»ç»ŸçŠ¶æ€ä½œä¸ºå¤‡ç”¨\n-        return await this.getServerQueueInfoFallback(serverUrl)\n-      }\n-\n-    } catch (error) {\n-      return await this.getServerQueueInfoFallback(serverUrl)\n-    }\n-  }\n-\n-  /**\n-   * å¤‡ç”¨é˜Ÿåˆ—ä¿¡æ¯è·å–æ–¹æ³•\n-   */\n-  async getServerQueueInfoFallback(serverUrl) {\n-    try {\n-      const controller = new AbortController()\n-      const timeoutId = setTimeout(() => controller.abort(), this.queueCheckTimeout)\n-\n-      const response = await fetch(`${serverUrl}/system_stats`, {\n-        method: 'GET',\n-        signal: controller.signal\n-      })\n-\n-      clearTimeout(timeoutId)\n-\n-      if (response.ok) {\n-        // å¦‚æœæ— æ³•è·å–ç²¾ç¡®é˜Ÿåˆ—ä¿¡æ¯ï¼Œå‡è®¾æœåŠ¡å™¨å¯ç”¨ä½†é˜Ÿåˆ—æœªçŸ¥\n+        console.warn(`âš ï¸ æœåŠ¡å™¨ ${serverUrl} é˜Ÿåˆ—APIè¿”å›çŠ¶æ€ç : ${response.status}`)\n         return {\n           running: 0,\n           pending: 0,\n-          total: 0,\n+          total: 1, // ä½¿ç”¨1è€Œä¸æ˜¯0ï¼Œé¿å…æ‰€æœ‰ç”¨æˆ·éƒ½é€‰æ‹©è¿™ä¸ªæœåŠ¡å™¨\n           healthy: true,\n-          supportsQueueAPI: false\n+          isEstimate: true\n         }\n       }\n+\n     } catch (error) {\n-      // å¿½ç•¥é”™è¯¯\n+      console.warn(`âš ï¸ è·å–æœåŠ¡å™¨ ${serverUrl} é˜Ÿåˆ—ä¿¡æ¯å¤±è´¥:`, error.message)\n+      return {\n+        running: 0,\n+        pending: 0,\n+        total: 999, // é«˜å€¼è¡¨ç¤ºä¸å¯ç”¨\n+        healthy: false\n+      }\n     }\n-\n-    return {\n-      running: 0,\n-      pending: 0,\n-      total: 999, // é«˜å€¼è¡¨ç¤ºä¸å¯ç”¨\n-      healthy: false,\n-      supportsQueueAPI: false\n-    }\n   }\n \n   /**\n-   * æ ¹æ®æœ€å°é˜Ÿåˆ—é€‰æ‹©æœåŠ¡å™¨\n+   * é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨ï¼ˆä¸»è¦æ¥å£ï¼‰\n+   * åªåœ¨ç”¨æˆ·å‘èµ·ç”Ÿå›¾è¯·æ±‚æ—¶è°ƒç”¨\n    */\n-  async selectServerByMinQueue() {\n+  async getOptimalServer() {\n     try {\n       console.log('ğŸ¯ å¼€å§‹é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨...')\n \n-      // ä¼˜å…ˆæ£€æŸ¥WebSocketé”å®šçš„æœåŠ¡å™¨\n-      if (this.isWebSocketServerLocked()) {\n-        const webSocketServer = this.getWebSocketLockedServer()\n-        if (webSocketServer) {\n-          console.log(`ğŸ”’ğŸŒ ä½¿ç”¨WebSocketé”å®šçš„æœåŠ¡å™¨: ${webSocketServer}`)\n-          return webSocketServer\n-        }\n-      }\n+      // 1. è·å–æœ€æ–°çš„æœåŠ¡å™¨åˆ—è¡¨\n+      const servers = await this.getLatestServerList()\n \n-      // æ£€æŸ¥æ˜¯å¦æœ‰æ™®é€šé”å®šçš„æœåŠ¡å™¨\n-      if (this.isServerLocked()) {\n-        const lockedServer = this.getLockedServer()\n-        if (lockedServer) {\n-          console.log(`ğŸ”’ ä½¿ç”¨é”å®šçš„æœåŠ¡å™¨: ${lockedServer}`)\n-          return lockedServer\n-        }\n+      if (servers.length === 0) {\n+        throw new Error('æ²¡æœ‰å¯ç”¨çš„æœåŠ¡å™¨é…ç½®')\n       }\n \n-      // æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯ï¼ˆå¦‚æœæ²¡æœ‰å¥åº·æœåŠ¡å™¨ï¼Œå¼ºåˆ¶æ›´æ–°ï¼‰\n-      await this.updateServerLoads()\n+      // 2. å¹¶è¡Œæ£€æŸ¥æ‰€æœ‰æœåŠ¡å™¨çš„å¥åº·çŠ¶æ€å’Œé˜Ÿåˆ—ä¿¡æ¯\n+      console.log('ğŸ” æ£€æŸ¥æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€...')\n+      const serverChecks = servers.map(async (server) => {\n+        try {\n+          const [healthResult, queueResult] = await Promise.allSettled([\n+            this.checkServerHealth(server.url),\n+            this.getServerQueueInfo(server.url)\n+          ])\n \n-      // è·å–æ‰€æœ‰å¥åº·çš„æœåŠ¡å™¨\n-      let healthyServers = Array.from(this.serverLoads.values())\n-        .filter(server => {\n-          // è¿‡æ»¤æ‰å¥åº·çŠ¶æ€ä¸ºfalseçš„æœåŠ¡å™¨\n-          if (!server.healthy) return false\n+          const health = healthResult.status === 'fulfilled' ? healthResult.value : { healthy: false }\n+          const queue = queueResult.status === 'fulfilled' ? queueResult.value : { total: 999, healthy: false }\n \n-          // è¿‡æ»¤æ‰å¤±è´¥æ¬¡æ•°è¿‡å¤šçš„æœåŠ¡å™¨\n-          const failures = this.serverFailures.get(server.url) || 0\n-          if (failures >= this.failureThreshold) {\n-            return false\n+          return {\n+            ...server,\n+            healthy: health.healthy,\n+            queue: queue,\n+            responseTime: health.responseTime || 0\n           }\n+        } catch (error) {\n+          console.error(`âŒ æ£€æŸ¥æœåŠ¡å™¨ ${server.url} å¤±è´¥:`, error)\n+          return {\n+            ...server,\n+            healthy: false,\n+            queue: { total: 999, healthy: false },\n+            responseTime: 0\n+          }\n+        }\n+      })\n \n-          return true\n-        })\n+      const serverResults = await Promise.all(serverChecks)\n+\n+      // 3. è¿‡æ»¤å¥åº·çš„æœåŠ¡å™¨å¹¶æŒ‰é˜Ÿåˆ—é•¿åº¦æ’åº\n+      const healthyServers = serverResults\n+        .filter(server => server.healthy)\n         .sort((a, b) => {\n-          // é¦–å…ˆæŒ‰å¤±è´¥æ¬¡æ•°æ’åºï¼ˆå¤±è´¥æ¬¡æ•°å°‘çš„ä¼˜å…ˆï¼‰\n-          const failureA = this.serverFailures.get(a.url) || 0\n-          const failureB = this.serverFailures.get(b.url) || 0\n-          if (failureA !== failureB) return failureA - failureB\n-\n-          // ç„¶åæŒ‰é˜Ÿåˆ—æ•°é‡æ’åº\n+          // æŒ‰é˜Ÿåˆ—æ•°é‡æ’åº\n           const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n           if (queueDiff !== 0) return queueDiff\n \n-          // æœ€åæŒ‰ä¼˜å…ˆçº§æ’åº\n+          // å¦‚æœé˜Ÿåˆ—ç›¸åŒï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº\n           return a.priority - b.priority\n         })\n \n-      // å¦‚æœæ²¡æœ‰å¥åº·æœåŠ¡å™¨ï¼Œå¼ºåˆ¶æ›´æ–°ä¸€æ¬¡å†è¯•\n+      // 4. é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n       if (healthyServers.length === 0) {\n-        console.warn('âš ï¸ æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨ï¼Œå¼ºåˆ¶æ›´æ–°åé‡è¯•...')\n-        await this.updateServerLoads(true) // å¼ºåˆ¶æ›´æ–°\n+        console.warn('âš ï¸ æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨å“åº”æœ€å¿«çš„æœåŠ¡å™¨')\n \n-        healthyServers = Array.from(this.serverLoads.values())\n-          .filter(server => server.healthy)\n-          .sort((a, b) => {\n-            const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n-            if (queueDiff !== 0) return queueDiff\n-            return a.priority - b.priority\n-          })\n-      }\n+        // å¦‚æœæ²¡æœ‰å¥åº·æœåŠ¡å™¨ï¼Œé€‰æ‹©å“åº”æ—¶é—´æœ€å¿«çš„\n+        const fastestServer = serverResults\n+          .filter(server => server.responseTime > 0)\n+          .sort((a, b) => a.responseTime - b.responseTime)[0]\n \n-      if (healthyServers.length === 0) {\n-        console.warn('âš ï¸ å¼ºåˆ¶æ›´æ–°åä»æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨')\n-        return await this.fallbackToAnyServer()\n+        if (fastestServer) {\n+          console.log(`ğŸ†˜ é€‰æ‹©å“åº”æœ€å¿«çš„æœåŠ¡å™¨: ${fastestServer.url} (å“åº”æ—¶é—´: ${fastestServer.responseTime}ms)`)\n+          return fastestServer.url\n+        }\n+\n+        // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼šè¿”å›ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨\n+        console.log(`ğŸ†˜ ä½¿ç”¨ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨: ${servers[0].url}`)\n+        return servers[0].url\n       }\n \n       const selectedServer = healthyServers[0]\n-      console.log(`âœ… é€‰æ‹©æœåŠ¡å™¨: ${selectedServer.url} (é˜Ÿåˆ—: ${selectedServer.queue.total || 0})`)\n+      console.log(`âœ… é€‰æ‹©æœåŠ¡å™¨: ${selectedServer.url} (é˜Ÿåˆ—: ${selectedServer.queue.total || 0}, ä¼˜å…ˆçº§: ${selectedServer.priority})`)\n \n-      // é”å®šé€‰ä¸­çš„æœåŠ¡å™¨\n-      this.lockServer(selectedServer.url)\n+      // 5. è®°å½•æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•ï¼‰\n+      this.logServerStatus(serverResults)\n \n       return selectedServer.url\n \n     } catch (error) {\n       console.error('âŒ æœåŠ¡å™¨é€‰æ‹©å¤±è´¥:', error)\n-      return await this.fallbackToAnyServer()\n-    }\n-  }\n \n-  /**\n-   * å¤‡ç”¨æœåŠ¡å™¨é€‰æ‹©\n-   */\n-  async fallbackToAnyServer() {\n-    console.log('ğŸ”„ ä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨é€‰æ‹©ç­–ç•¥...')\n-\n-    // å°è¯•é€‰æ‹©å“åº”æ—¶é—´æœ€å¿«çš„æœåŠ¡å™¨ï¼ˆå³ä½¿é˜Ÿåˆ—è¾ƒé•¿ï¼‰\n-    const serversWithResponse = Array.from(this.serverLoads.values())\n-      .filter(server => server.responseTime > 0) // è‡³å°‘æœ‰å“åº”\n-      .sort((a, b) => {\n-        // æŒ‰å“åº”æ—¶é—´æ’åº\n-        return a.responseTime - b.responseTime\n-      })\n-\n-    if (serversWithResponse.length > 0) {\n-      const fastestServer = serversWithResponse[0]\n-      console.log(`ğŸ†˜ é€‰æ‹©å“åº”æœ€å¿«çš„æœåŠ¡å™¨: ${fastestServer.url} (å“åº”æ—¶é—´: ${fastestServer.responseTime}ms, é˜Ÿåˆ—: ${fastestServer.queue.total || 0})`)\n-      return fastestServer.url\n-    }\n-\n-    // å¦‚æœæ²¡æœ‰å“åº”æ•°æ®ï¼ŒæŒ‰ä¼˜å…ˆçº§è¿”å›ç¬¬ä¸€ä¸ªæœåŠ¡å™¨\n-    if (this.servers.length > 0) {\n-      const fallbackServer = this.servers[0].url\n-      console.log(`ğŸ†˜ å¤‡ç”¨æœåŠ¡å™¨: ${fallbackServer}`)\n-      return fallbackServer\n-    }\n-\n-    // å¦‚æœæ²¡æœ‰é…ç½®çš„æœåŠ¡å™¨ï¼Œå°è¯•å¤šç§æ–¹å¼è·å–é»˜è®¤å€¼\n-    try {\n-      const config = await configService.getConfig()\n-      const defaultServer = config['comfyui.server_url']\n-\n-      if (defaultServer && defaultServer !== 'https://your-comfyui-server.com') {\n-        return defaultServer\n-      }\n-    } catch (error) {\n-      // å¿½ç•¥é…ç½®æœåŠ¡é”™è¯¯\n-    }\n-\n-    // ä»æœ¬åœ°å­˜å‚¨è·å–\n-    try {\n-      const localConfig = JSON.parse(localStorage.getItem('comfyui_config') || '{}')\n-      if (localConfig.COMFYUI_SERVER_URL) {\n-        return localConfig.COMFYUI_SERVER_URL\n-      }\n-    } catch (error) {\n-      // å¿½ç•¥æœ¬åœ°å­˜å‚¨é”™è¯¯\n-    }\n-\n-    // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆ\n-    const fallbackUrl = 'https://your-comfyui-server.com'\n-    return fallbackUrl\n-  }\n-\n-  /**\n-   * é”å®šæœåŠ¡å™¨ï¼ˆæ™®é€šHTTPè¯·æ±‚ï¼‰\n-   */\n-  lockServer(serverUrl) {\n-    this.lockedServer = serverUrl\n-    this.lastLockTime = Date.now()\n-  }\n-\n-  /**\n-   * é”å®šæœåŠ¡å™¨ç”¨äºWebSocketè¿æ¥\n-   */\n-  lockServerForWebSocket(serverUrl) {\n-    this.webSocketLockedServer = serverUrl\n-    this.webSocketLockTime = Date.now()\n-    console.log(`ğŸ”’ğŸŒ é”å®šæœåŠ¡å™¨ç”¨äºWebSocket: ${serverUrl}, æŒç»­ ${this.webSocketLockDuration / 1000} ç§’`)\n-\n-    // åŒæ—¶è®¾ç½®æ™®é€šé”å®šï¼Œç¡®ä¿ä¸€è‡´æ€§\n-    this.lockServer(serverUrl)\n-  }\n-\n-  /**\n-   * é‡Šæ”¾WebSocketæœåŠ¡å™¨é”å®š\n-   */\n-  unlockWebSocketServer() {\n-    if (this.webSocketLockedServer) {\n-      console.log(`ğŸ”“ğŸŒ é‡Šæ”¾WebSocketæœåŠ¡å™¨é”å®š: ${this.webSocketLockedServer}`)\n-      this.webSocketLockedServer = null\n-      this.webSocketLockTime = 0\n-    }\n-  }\n-\n-  /**\n-   * æ£€æŸ¥WebSocketæœåŠ¡å™¨æ˜¯å¦è¢«é”å®š\n-   */\n-  isWebSocketServerLocked() {\n-    if (!this.webSocketLockedServer) return false\n-\n-    const now = Date.now()\n-    const isLocked = (now - this.webSocketLockTime) < this.webSocketLockDuration\n-\n-    if (!isLocked) {\n-      console.log('ğŸ”“ğŸŒ WebSocketæœåŠ¡å™¨é”å®šå·²è¿‡æœŸ')\n-      this.webSocketLockedServer = null\n-      this.webSocketLockTime = 0\n-    }\n-\n-    return isLocked\n-  }\n-\n-  /**\n-   * è·å–WebSocketé”å®šçš„æœåŠ¡å™¨\n-   */\n-  getWebSocketLockedServer() {\n-    if (this.isWebSocketServerLocked()) {\n-      return this.webSocketLockedServer\n-    }\n-    return null\n-  }\n-\n-  /**\n-   * æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¢«é”å®š\n-   */\n-  isServerLocked() {\n-    if (!this.lockedServer) return false\n-\n-    const now = Date.now()\n-    const isLocked = (now - this.lastLockTime) < this.lockDuration\n-\n-    if (!isLocked) {\n-      console.log('ğŸ”“ æœåŠ¡å™¨é”å®šå·²è¿‡æœŸ')\n-      this.lockedServer = null\n-      this.lastLockTime = 0\n-    }\n-\n-    return isLocked\n-  }\n-\n-  /**\n-   * è·å–é”å®šçš„æœåŠ¡å™¨\n-   */\n-  getLockedServer() {\n-    if (this.isServerLocked()) {\n-      return this.lockedServer\n-    }\n-    return null\n-  }\n-\n-  /**\n-   * è®°å½•æœåŠ¡å™¨å¤±è´¥\n-   */\n-  async recordFailure(serverUrl, errorType = 'unknown') {\n-    // å¢åŠ å¤±è´¥è®¡æ•°\n-    const currentFailures = this.serverFailures.get(serverUrl) || 0\n-    const newFailures = currentFailures + 1\n-    this.serverFailures.set(serverUrl, newFailures)\n-\n-    // å¦‚æœå¤±è´¥çš„æ˜¯å½“å‰é”å®šçš„æœåŠ¡å™¨ï¼Œç«‹å³è§£é™¤é”å®š\n-    if (this.lockedServer === serverUrl) {\n-      this.lockedServer = null\n-      this.lastLockTime = 0\n-    }\n-\n-    // æ ‡è®°æœåŠ¡å™¨ä¸ºä¸å¥åº·\n-    if (this.serverLoads.has(serverUrl)) {\n-      const serverInfo = this.serverLoads.get(serverUrl)\n-      serverInfo.healthy = false\n-      serverInfo.lastFailure = Date.now()\n-      serverInfo.failureCount = newFailures\n-      serverInfo.lastErrorType = errorType\n-      this.serverLoads.set(serverUrl, serverInfo)\n-    }\n-\n-    // è®°å½•å¤±è´¥ä½†ä¸è‡ªåŠ¨åˆ‡æ¢ï¼Œç”±ç”¨æˆ·æ‰‹åŠ¨å†³å®š\n-\n-    // å¼ºåˆ¶æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n-    this.lastUpdateTime = 0\n-  }\n-\n-\n-\n-  /**\n-   * é‡ç½®æœåŠ¡å™¨å¤±è´¥è®¡æ•°\n-   */\n-  resetFailureCount(serverUrl) {\n-    if (this.serverFailures.has(serverUrl)) {\n-      console.log(`ğŸ”„ é‡ç½®æœåŠ¡å™¨å¤±è´¥è®¡æ•°: ${serverUrl}`)\n-      this.serverFailures.delete(serverUrl)\n-\n-      // åŒæ—¶æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n-      if (this.serverLoads.has(serverUrl)) {\n-        const serverInfo = this.serverLoads.get(serverUrl)\n-        serverInfo.failureCount = 0\n-        delete serverInfo.lastErrorType\n-        this.serverLoads.set(serverUrl, serverInfo)\n-      }\n-    }\n-  }\n-\n-  /**\n-   * è·å–æœ€ä¼˜æœåŠ¡å™¨ï¼ˆä¸»è¦æ¥å£ï¼‰\n-   */\n-  async getOptimalServer() {\n-    return await this.selectServerByMinQueue()\n-  }\n-\n-  /**\n-   * æ‰‹åŠ¨è§¦å‘æœåŠ¡å™¨åˆ‡æ¢\n-   */\n-  async switchToNextServer() {\n-    console.log('ğŸ”„ æ‰‹åŠ¨è§¦å‘æœåŠ¡å™¨åˆ‡æ¢...')\n-\n-    // å¦‚æœå½“å‰æœ‰é”å®šçš„æœåŠ¡å™¨ï¼Œå°†å…¶æ ‡è®°ä¸ºå¤±è´¥\n-    if (this.lockedServer) {\n-      console.log(`ğŸ“ æ ‡è®°å½“å‰æœåŠ¡å™¨ä¸ºå¤±è´¥: ${this.lockedServer}`)\n-      await this.recordFailure(this.lockedServer, 'manual_switch')\n-    }\n-\n-    // å¼ºåˆ¶é‡æ–°è¯„ä¼°å¹¶é€‰æ‹©æ–°æœåŠ¡å™¨\n-    await this.forceReassessment()\n-    const newServer = await this.selectServerByMinQueue()\n-\n-    console.log(`âœ… æ‰‹åŠ¨åˆ‡æ¢å®Œæˆï¼Œæ–°æœåŠ¡å™¨: ${newServer}`)\n-    return newServer\n-  }\n-\n-  /**\n-   * è·å–ä¸‹ä¸€ä¸ªå¯ç”¨æœåŠ¡å™¨ï¼ˆä¸é”å®šï¼‰\n-   */\n-  async getNextAvailableServer(excludeUrls = []) {\n-    await this.updateServerLoads()\n-\n-    const availableServers = Array.from(this.serverLoads.values())\n-      .filter(server => {\n-        if (!server.healthy) return false\n-        if (excludeUrls.includes(server.url)) return false\n-\n-        const failures = this.serverFailures.get(server.url) || 0\n-        return failures < this.failureThreshold\n-      })\n-      .sort((a, b) => {\n-        const failureA = this.serverFailures.get(a.url) || 0\n-        const failureB = this.serverFailures.get(b.url) || 0\n-        if (failureA !== failureB) return failureA - failureB\n-\n-        const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n-        if (queueDiff !== 0) return queueDiff\n-\n-        return a.priority - b.priority\n-      })\n-\n-    return availableServers.length > 0 ? availableServers[0].url : null\n-  }\n-\n-  /**\n-   * å¼ºåˆ¶é‡æ–°è¯„ä¼°æ‰€æœ‰æœåŠ¡å™¨\n-   */\n-  async forceReassessment() {\n-    console.log('ğŸ”„ å¼ºåˆ¶é‡æ–°è¯„ä¼°æ‰€æœ‰æœåŠ¡å™¨...')\n-\n-    // æ¸…é™¤é”å®šçŠ¶æ€\n-    this.lockedServer = null\n-    this.lastLockTime = 0\n-\n-    // é‡ç½®æ‰€æœ‰æœåŠ¡å™¨çš„å¤±è´¥è®¡æ•°ï¼ˆç»™å®ƒä»¬ä¸€ä¸ªé‡æ–°å¼€å§‹çš„æœºä¼šï¼‰\n-    console.log('ğŸ”„ é‡ç½®æ‰€æœ‰æœåŠ¡å™¨å¤±è´¥è®¡æ•°')\n-    this.serverFailures.clear()\n-\n-    // å¼ºåˆ¶æ›´æ–°è´Ÿè½½ä¿¡æ¯\n-    await this.updateServerLoads(true)\n-\n-    // æ˜¾ç¤ºå½“å‰çŠ¶æ€\n-    this.logServerStatus()\n-\n-    console.log('âœ… æœåŠ¡å™¨é‡æ–°è¯„ä¼°å®Œæˆ')\n-  }\n-\n-  /**\n-   * æ˜¾ç¤ºæœåŠ¡å™¨çŠ¶æ€\n-   */\n-  logServerStatus() {\n-    console.log('ğŸ“Š å½“å‰æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€:')\n-    for (const [url, info] of this.serverLoads.entries()) {\n-      const status = info.healthy ? 'âœ…' : 'âŒ'\n-      const queueInfo = info.queue ?\n-        `é˜Ÿåˆ—:${info.queue.total || 0}(è¿è¡Œ:${info.queue.running || 0},ç­‰å¾…:${info.queue.pending || 0})` :\n-        'é˜Ÿåˆ—:æœªçŸ¥'\n-      const locked = url === this.lockedServer ? 'ğŸ”’' : ''\n-      const priority = `ä¼˜å…ˆçº§:${info.priority}`\n-      const responseTime = info.responseTime ? `å“åº”:${info.responseTime}ms` : 'å“åº”:æœªçŸ¥'\n-      const lastCheck = info.lastCheck ? `æ£€æŸ¥:${Math.round((Date.now() - info.lastCheck) / 1000)}så‰` : 'æ£€æŸ¥:ä»æœª'\n-      const failures = this.serverFailures.get(url) || 0\n-      const failureInfo = failures > 0 ? `å¤±è´¥:${failures}æ¬¡` : ''\n-      const errorType = info.lastErrorType ? `é”™è¯¯:${info.lastErrorType}` : ''\n-      console.log(`   ${status} ${url} ${queueInfo} ${priority} ${responseTime} ${lastCheck} ${failureInfo} ${errorType} ${locked}`)\n-    }\n-  }\n-\n-  /**\n-   * è·å–æœåŠ¡å™¨ç»Ÿè®¡ä¿¡æ¯\n-   */\n-  getServerStats() {\n-    const stats = {\n-      total: this.servers.length,\n-      healthy: 0,\n-      locked: this.lockedServer,\n-      servers: []\n-    }\n-\n-    for (const [url, info] of this.serverLoads.entries()) {\n-      if (info.healthy) stats.healthy++\n-\n-      stats.servers.push({\n-        url,\n-        healthy: info.healthy,\n-        queue: info.queue.total || 0,\n-        priority: info.priority,\n-        type: info.type,\n-        locked: url === this.lockedServer\n-      })\n-    }\n-\n-    return stats\n-  }\n-\n-  /**\n-   * å¯åŠ¨å¥åº·ç›‘æ§\n-   */\n-  startHealthMonitoring() {\n-    if (this.healthMonitorInterval) {\n-      clearInterval(this.healthMonitorInterval)\n-    }\n-\n-    console.log(`ğŸ¥ å¯åŠ¨å¥åº·ç›‘æ§ï¼Œæ£€æŸ¥é¢‘ç‡: ${this.healthMonitorFrequency / 1000}ç§’`)\n-\n-    this.healthMonitorInterval = setInterval(async () => {\n+      // é”™è¯¯æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ\n       try {\n-        await this.performHealthMonitoring()\n-      } catch (error) {\n-        console.error('âŒ å¥åº·ç›‘æ§å‡ºé”™:', error)\n+        const config = await configService.getConfig()\n+        const fallbackUrl = config['comfyui.server_url'] || 'https://your-comfyui-server.com'\n+        console.log(`ğŸ†˜ ä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨: ${fallbackUrl}`)\n+        return fallbackUrl\n+      } catch (configError) {\n+        console.error('âŒ è·å–å¤‡ç”¨æœåŠ¡å™¨é…ç½®å¤±è´¥:', configError)\n+        return 'https://your-comfyui-server.com'\n       }\n-    }, this.healthMonitorFrequency)\n-  }\n-\n-  /**\n-   * åœæ­¢å¥åº·ç›‘æ§\n-   */\n-  stopHealthMonitoring() {\n-    if (this.healthMonitorInterval) {\n-      console.log('ğŸ›‘ åœæ­¢å¥åº·ç›‘æ§')\n-      clearInterval(this.healthMonitorInterval)\n-      this.healthMonitorInterval = null\n     }\n   }\n \n   /**\n-   * æ‰§è¡Œå¥åº·ç›‘æ§\n+   * è®°å½•æœåŠ¡å™¨çŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•ï¼‰\n    */\n-  async performHealthMonitoring() {\n-    // æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n-    await this.updateServerLoads()\n+  logServerStatus(servers) {\n+    console.log('ğŸ“Š æœåŠ¡å™¨çŠ¶æ€è¯¦æƒ…:')\n+    console.log('   çŠ¶æ€ | æœåŠ¡å™¨URL | é˜Ÿåˆ— | ä¼˜å…ˆçº§ | å“åº”æ—¶é—´')\n+    console.log('   -----|-----------|------|--------|----------')\n \n-    // æ£€æŸ¥å½“å‰é”å®šçš„æœåŠ¡å™¨æ˜¯å¦ä»ç„¶å¥åº·\n-    if (this.lockedServer) {\n-      const lockedServerInfo = this.serverLoads.get(this.lockedServer)\n-      if (lockedServerInfo && !lockedServerInfo.healthy) {\n-        this.lockedServer = null\n-        this.lastLockTime = 0\n-      }\n-    }\n+    servers.forEach(server => {\n+      const status = server.healthy ? 'âœ…' : 'âŒ'\n+      const queueInfo = server.queue ? `${server.queue.total || 0}` : 'N/A'\n+      const priority = server.priority || 'N/A'\n+      const responseTime = server.responseTime ? `${server.responseTime}ms` : 'N/A'\n \n-    // æ£€æŸ¥æ˜¯å¦æœ‰æœåŠ¡å™¨ä»æ•…éšœä¸­æ¢å¤\n-    const healthyServers = Array.from(this.serverLoads.values())\n-      .filter(server => server.healthy)\n-\n-    // åªåœ¨æ²¡æœ‰å¥åº·æœåŠ¡å™¨æ—¶è¾“å‡ºè­¦å‘Š\n-    if (healthyServers.length === 0) {\n-      console.warn('è­¦å‘Šï¼šæ²¡æœ‰å‘ç°å¥åº·çš„ComfyUIæœåŠ¡å™¨')\n-    }\n+      console.log(`   ${status} | ${server.url} | ${queueInfo} | ${priority} | ${responseTime}`)\n+    })\n   }\n-\n-  /**\n-   * é”€æ¯è´Ÿè½½å‡è¡¡å™¨\n-   */\n-  destroy() {\n-    this.stopHealthMonitoring()\n-    this.servers = []\n-    this.serverLoads.clear()\n-    this.serverFailures.clear()\n-    this.lockedServer = null\n-  }\n }\n \n // åˆ›å»ºå•ä¾‹å®ä¾‹\n const loadBalancer = new ComfyUILoadBalancer()\n"
                },
                {
                    "date": 1752513434979,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -191,10 +191,15 @@\n       if (servers.length === 0) {\n         throw new Error('æ²¡æœ‰å¯ç”¨çš„æœåŠ¡å™¨é…ç½®')\n       }\n \n+      console.log(`ğŸ“‹ å‘ç° ${servers.length} ä¸ªé…ç½®çš„æœåŠ¡å™¨:`)\n+      servers.forEach((server, index) => {\n+        console.log(`   ${index + 1}. ${server.url} (${server.type}, ä¼˜å…ˆçº§: ${server.priority})`)\n+      })\n+\n       // 2. å¹¶è¡Œæ£€æŸ¥æ‰€æœ‰æœåŠ¡å™¨çš„å¥åº·çŠ¶æ€å’Œé˜Ÿåˆ—ä¿¡æ¯\n-      console.log('ğŸ” æ£€æŸ¥æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€...')\n+      console.log('ğŸ” æ­£åœ¨æµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨çš„å¥åº·çŠ¶æ€å’Œé˜Ÿåˆ—ä¿¡æ¯...')\n       const serverChecks = servers.map(async (server) => {\n         try {\n           const [healthResult, queueResult] = await Promise.allSettled([\n             this.checkServerHealth(server.url),\n@@ -203,21 +208,30 @@\n \n           const health = healthResult.status === 'fulfilled' ? healthResult.value : { healthy: false }\n           const queue = queueResult.status === 'fulfilled' ? queueResult.value : { total: 999, healthy: false }\n \n+          // è¾“å‡ºæ¯ä¸ªæœåŠ¡å™¨çš„æµ‹è¯•ç»“æœ\n+          if (health.healthy) {\n+            console.log(`âœ… ${server.url} - å¥åº· (å“åº”æ—¶é—´: ${health.responseTime}ms, é˜Ÿåˆ—: ${queue.total || 0})`)\n+          } else {\n+            console.log(`âŒ ${server.url} - ä¸å¯ç”¨ (${health.error || 'è¿æ¥å¤±è´¥'})`)\n+          }\n+\n           return {\n             ...server,\n             healthy: health.healthy,\n             queue: queue,\n-            responseTime: health.responseTime || 0\n+            responseTime: health.responseTime || 0,\n+            error: health.error\n           }\n         } catch (error) {\n           console.error(`âŒ æ£€æŸ¥æœåŠ¡å™¨ ${server.url} å¤±è´¥:`, error)\n           return {\n             ...server,\n             healthy: false,\n             queue: { total: 999, healthy: false },\n-            responseTime: 0\n+            responseTime: 0,\n+            error: error.message\n           }\n         }\n       })\n \n"
                },
                {
                    "date": 1752513464083,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -236,9 +236,15 @@\n       })\n \n       const serverResults = await Promise.all(serverChecks)\n \n-      // 3. è¿‡æ»¤å¥åº·çš„æœåŠ¡å™¨å¹¶æŒ‰é˜Ÿåˆ—é•¿åº¦æ’åº\n+      // 3. æ˜¾ç¤ºæµ‹è¯•ç»“æœæ±‡æ€»\n+      const healthyCount = serverResults.filter(s => s.healthy).length\n+      const unhealthyCount = serverResults.length - healthyCount\n+\n+      console.log(`ğŸ“Š æœåŠ¡å™¨æµ‹è¯•ç»“æœæ±‡æ€»: ${healthyCount} ä¸ªå¥åº·, ${unhealthyCount} ä¸ªä¸å¯ç”¨`)\n+\n+      // 4. è¿‡æ»¤å¥åº·çš„æœåŠ¡å™¨å¹¶æŒ‰é˜Ÿåˆ—é•¿åº¦æ’åº\n       const healthyServers = serverResults\n         .filter(server => server.healthy)\n         .sort((a, b) => {\n           // æŒ‰é˜Ÿåˆ—æ•°é‡æ’åº\n@@ -248,9 +254,9 @@\n           // å¦‚æœé˜Ÿåˆ—ç›¸åŒï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº\n           return a.priority - b.priority\n         })\n \n-      // 4. é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n+      // 5. é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n       if (healthyServers.length === 0) {\n         console.warn('âš ï¸ æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨å“åº”æœ€å¿«çš„æœåŠ¡å™¨')\n \n         // å¦‚æœæ²¡æœ‰å¥åº·æœåŠ¡å™¨ï¼Œé€‰æ‹©å“åº”æ—¶é—´æœ€å¿«çš„\n@@ -258,21 +264,29 @@\n           .filter(server => server.responseTime > 0)\n           .sort((a, b) => a.responseTime - b.responseTime)[0]\n \n         if (fastestServer) {\n-          console.log(`ğŸ†˜ é€‰æ‹©å“åº”æœ€å¿«çš„æœåŠ¡å™¨: ${fastestServer.url} (å“åº”æ—¶é—´: ${fastestServer.responseTime}ms)`)\n+          console.log(`ğŸ†˜ æœ€ç»ˆé€‰æ‹©: ${fastestServer.url}`)\n+          console.log(`   åŸå› : å“åº”æœ€å¿«çš„æœåŠ¡å™¨ (${fastestServer.responseTime}ms)`)\n+          console.log(`   çŠ¶æ€: å¯èƒ½ä¸ç¨³å®šï¼Œå»ºè®®æ£€æŸ¥æœåŠ¡å™¨é…ç½®`)\n           return fastestServer.url\n         }\n \n         // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼šè¿”å›ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨\n-        console.log(`ğŸ†˜ ä½¿ç”¨ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨: ${servers[0].url}`)\n+        console.log(`ğŸ†˜ æœ€ç»ˆé€‰æ‹©: ${servers[0].url}`)\n+        console.log(`   åŸå› : å¤‡ç”¨æ–¹æ¡ˆ - ä½¿ç”¨ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨`)\n+        console.log(`   çŠ¶æ€: æœªçŸ¥ï¼Œå¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œ`)\n         return servers[0].url\n       }\n \n       const selectedServer = healthyServers[0]\n-      console.log(`âœ… é€‰æ‹©æœåŠ¡å™¨: ${selectedServer.url} (é˜Ÿåˆ—: ${selectedServer.queue.total || 0}, ä¼˜å…ˆçº§: ${selectedServer.priority})`)\n+      console.log(`ğŸ¯ æœ€ç»ˆé€‰æ‹©: ${selectedServer.url}`)\n+      console.log(`   ç±»å‹: ${selectedServer.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨æœåŠ¡å™¨'}`)\n+      console.log(`   é˜Ÿåˆ—æ•°: ${selectedServer.queue.total || 0} (è¿è¡Œä¸­: ${selectedServer.queue.running || 0}, ç­‰å¾…ä¸­: ${selectedServer.queue.pending || 0})`)\n+      console.log(`   å“åº”æ—¶é—´: ${selectedServer.responseTime}ms`)\n+      console.log(`   ä¼˜å…ˆçº§: ${selectedServer.priority}`)\n \n-      // 5. è®°å½•æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•ï¼‰\n+      // 6. è®°å½•æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•ï¼‰\n       this.logServerStatus(serverResults)\n \n       return selectedServer.url\n \n"
                },
                {
                    "date": 1752513482671,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -309,20 +309,26 @@\n   /**\n    * è®°å½•æœåŠ¡å™¨çŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•ï¼‰\n    */\n   logServerStatus(servers) {\n-    console.log('ğŸ“Š æœåŠ¡å™¨çŠ¶æ€è¯¦æƒ…:')\n-    console.log('   çŠ¶æ€ | æœåŠ¡å™¨URL | é˜Ÿåˆ— | ä¼˜å…ˆçº§ | å“åº”æ—¶é—´')\n-    console.log('   -----|-----------|------|--------|----------')\n+    console.log('ğŸ“Š è¯¦ç»†æœåŠ¡å™¨çŠ¶æ€æŠ¥å‘Š:')\n+    console.log('   çŠ¶æ€ | ç±»å‹ | æœåŠ¡å™¨URL | é˜Ÿåˆ—(è¿è¡Œ/ç­‰å¾…/æ€»è®¡) | ä¼˜å…ˆçº§ | å“åº”æ—¶é—´ | é”™è¯¯ä¿¡æ¯')\n+    console.log('   -----|------|-----------|-------------------|--------|----------|----------')\n \n     servers.forEach(server => {\n       const status = server.healthy ? 'âœ…' : 'âŒ'\n-      const queueInfo = server.queue ? `${server.queue.total || 0}` : 'N/A'\n+      const type = server.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨'\n+      const queueInfo = server.queue ?\n+        `${server.queue.running || 0}/${server.queue.pending || 0}/${server.queue.total || 0}` :\n+        'N/A'\n       const priority = server.priority || 'N/A'\n       const responseTime = server.responseTime ? `${server.responseTime}ms` : 'N/A'\n+      const error = server.error ? server.error.substring(0, 20) + '...' : ''\n \n-      console.log(`   ${status} | ${server.url} | ${queueInfo} | ${priority} | ${responseTime}`)\n+      console.log(`   ${status} | ${type} | ${server.url} | ${queueInfo} | ${priority} | ${responseTime} | ${error}`)\n     })\n+\n+    console.log('') // ç©ºè¡Œåˆ†éš”\n   }\n }\n \n // åˆ›å»ºå•ä¾‹å®ä¾‹\n"
                },
                {
                    "date": 1752513513334,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -306,8 +306,87 @@\n     }\n   }\n \n   /**\n+   * é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æœåŠ¡å™¨è¿æ¥æµ‹è¯•\n+   * æä¾›è¯¦ç»†çš„æœåŠ¡å™¨çŠ¶æ€åé¦ˆ\n+   */\n+  async initializeServerConnection() {\n+    try {\n+      console.log('ğŸš€ æ­£åœ¨åˆå§‹åŒ– ComfyUI æœåŠ¡å™¨è¿æ¥...')\n+\n+      // è·å–æœåŠ¡å™¨åˆ—è¡¨\n+      const servers = await this.getLatestServerList()\n+\n+      if (servers.length === 0) {\n+        console.warn('âš ï¸ æœªæ‰¾åˆ°ä»»ä½•é…ç½®çš„æœåŠ¡å™¨')\n+        return null\n+      }\n+\n+      console.log(`ğŸ“‹ å‘ç° ${servers.length} ä¸ªé…ç½®çš„æœåŠ¡å™¨ï¼Œå¼€å§‹è¿æ¥æµ‹è¯•...`)\n+\n+      // æµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨\n+      const serverChecks = servers.map(async (server) => {\n+        console.log(`ğŸ” æµ‹è¯•æœåŠ¡å™¨: ${server.url}`)\n+\n+        try {\n+          const [healthResult, queueResult] = await Promise.allSettled([\n+            this.checkServerHealth(server.url),\n+            this.getServerQueueInfo(server.url)\n+          ])\n+\n+          const health = healthResult.status === 'fulfilled' ? healthResult.value : { healthy: false }\n+          const queue = queueResult.status === 'fulfilled' ? queueResult.value : { total: 999, healthy: false }\n+\n+          return {\n+            ...server,\n+            healthy: health.healthy,\n+            queue: queue,\n+            responseTime: health.responseTime || 0,\n+            error: health.error\n+          }\n+        } catch (error) {\n+          return {\n+            ...server,\n+            healthy: false,\n+            queue: { total: 999, healthy: false },\n+            responseTime: 0,\n+            error: error.message\n+          }\n+        }\n+      })\n+\n+      const serverResults = await Promise.all(serverChecks)\n+\n+      // è¾“å‡ºæµ‹è¯•ç»“æœ\n+      const healthyServers = serverResults.filter(s => s.healthy)\n+      console.log(`âœ… æœåŠ¡å™¨è¿æ¥æµ‹è¯•å®Œæˆ: ${healthyServers.length}/${serverResults.length} ä¸ªæœåŠ¡å™¨å¯ç”¨`)\n+\n+      // é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n+      if (healthyServers.length > 0) {\n+        const bestServer = healthyServers.sort((a, b) => {\n+          const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n+          if (queueDiff !== 0) return queueDiff\n+          return a.priority - b.priority\n+        })[0]\n+\n+        console.log(`ğŸ¯ æ¨èæœåŠ¡å™¨: ${bestServer.url}`)\n+        console.log(`   é˜Ÿåˆ—çŠ¶æ€: ${bestServer.queue.total || 0} ä¸ªä»»åŠ¡ (è¿è¡Œä¸­: ${bestServer.queue.running || 0}, ç­‰å¾…ä¸­: ${bestServer.queue.pending || 0})`)\n+        console.log(`   å“åº”æ—¶é—´: ${bestServer.responseTime}ms`)\n+\n+        return bestServer.url\n+      } else {\n+        console.warn('âŒ æ‰€æœ‰æœåŠ¡å™¨éƒ½ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®')\n+        return null\n+      }\n+\n+    } catch (error) {\n+      console.error('âŒ æœåŠ¡å™¨åˆå§‹åŒ–å¤±è´¥:', error)\n+      return null\n+    }\n+  }\n+\n+  /**\n    * è®°å½•æœåŠ¡å™¨çŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•ï¼‰\n    */\n   logServerStatus(servers) {\n     console.log('ğŸ“Š è¯¦ç»†æœåŠ¡å™¨çŠ¶æ€æŠ¥å‘Š:')\n"
                },
                {
                    "date": 1752514056455,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -89,37 +89,68 @@\n   }\n \n   /**\n    * æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€\n+   * å°è¯•å¤šä¸ªç«¯ç‚¹æ¥ç¡®ä¿å‡†ç¡®æ£€æµ‹\n    */\n   async checkServerHealth(serverUrl) {\n-    try {\n-      const controller = new AbortController()\n-      const timeoutId = setTimeout(() => controller.abort(), this.healthCheckTimeout)\n+    // è¦æµ‹è¯•çš„ç«¯ç‚¹åˆ—è¡¨ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº\n+    const testEndpoints = [\n+      '/queue',        // ComfyUI é˜Ÿåˆ—ç«¯ç‚¹ï¼Œæœ€å¸¸ç”¨\n+      '/system_stats', // ComfyUI ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n+      '/history',      // ComfyUI å†å²è®°å½•ç«¯ç‚¹\n+      '/'              // æ ¹è·¯å¾„ï¼Œæœ€åå°è¯•\n+    ]\n \n-      const startTime = Date.now()\n-      const response = await fetch(`${serverUrl}/system_stats`, {\n-        method: 'GET',\n-        signal: controller.signal,\n-        headers: {\n-          'Cache-Control': 'no-cache'\n-        }\n-      })\n-      const endTime = Date.now()\n+    let lastError = null\n+    const startTime = Date.now()\n \n-      clearTimeout(timeoutId)\n+    for (const endpoint of testEndpoints) {\n+      try {\n+        const controller = new AbortController()\n+        const timeoutId = setTimeout(() => controller.abort(), this.healthCheckTimeout)\n \n-      return {\n-        healthy: response.ok,\n-        responseTime: endTime - startTime,\n-        status: response.status\n+        console.log(`ğŸ” æµ‹è¯•ç«¯ç‚¹: ${serverUrl}${endpoint}`)\n+\n+        const response = await fetch(`${serverUrl}${endpoint}`, {\n+          method: 'GET',\n+          signal: controller.signal,\n+          headers: {\n+            'Cache-Control': 'no-cache',\n+            'Accept': 'application/json, text/plain, */*'\n+          }\n+        })\n+\n+        clearTimeout(timeoutId)\n+        const endTime = Date.now()\n+\n+        // å¦‚æœå“åº”æˆåŠŸï¼Œè®¤ä¸ºæœåŠ¡å™¨å¥åº·\n+        if (response.ok) {\n+          console.log(`âœ… ç«¯ç‚¹ ${endpoint} å“åº”æˆåŠŸ (${response.status})`)\n+          return {\n+            healthy: true,\n+            responseTime: endTime - startTime,\n+            status: response.status,\n+            endpoint: endpoint\n+          }\n+        } else {\n+          console.log(`âš ï¸ ç«¯ç‚¹ ${endpoint} å“åº”å¤±è´¥ (${response.status})`)\n+          lastError = `HTTP ${response.status}`\n+        }\n+      } catch (error) {\n+        console.log(`âŒ ç«¯ç‚¹ ${endpoint} è¿æ¥å¤±è´¥: ${error.message}`)\n+        lastError = error.message\n+        continue\n       }\n-    } catch (error) {\n-      return {\n-        healthy: false,\n-        error: error.message\n-      }\n     }\n+\n+    // æ‰€æœ‰ç«¯ç‚¹éƒ½å¤±è´¥\n+    const endTime = Date.now()\n+    return {\n+      healthy: false,\n+      responseTime: endTime - startTime,\n+      error: lastError || 'æ‰€æœ‰ç«¯ç‚¹éƒ½æ— æ³•è®¿é—®'\n+    }\n   }\n \n   /**\n    * è·å–æœåŠ¡å™¨é˜Ÿåˆ—ä¿¡æ¯\n"
                },
                {
                    "date": 1752514084198,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -159,36 +159,53 @@\n     try {\n       const controller = new AbortController()\n       const timeoutId = setTimeout(() => controller.abort(), this.queueCheckTimeout)\n \n+      console.log(`ğŸ“Š è·å–æœåŠ¡å™¨é˜Ÿåˆ—ä¿¡æ¯: ${serverUrl}/queue`)\n+\n       const response = await fetch(`${serverUrl}/queue`, {\n         method: 'GET',\n         signal: controller.signal,\n         headers: {\n-          'Content-Type': 'application/json',\n+          'Accept': 'application/json, text/plain, */*',\n           'Cache-Control': 'no-cache'\n         }\n       })\n \n       clearTimeout(timeoutId)\n \n       if (response.ok) {\n-        const queueData = await response.json()\n-        console.log(`ğŸ“Š æœåŠ¡å™¨ ${serverUrl} é˜Ÿåˆ—æ•°æ®:`, queueData)\n+        try {\n+          const queueData = await response.json()\n+          console.log(`ğŸ“Š æœåŠ¡å™¨ ${serverUrl} é˜Ÿåˆ—æ•°æ®:`, queueData)\n \n-        // ComfyUI é˜Ÿåˆ— API è¿”å›æ ¼å¼: { queue_running: [...], queue_pending: [...] }\n-        const running = queueData.queue_running ? queueData.queue_running.length : 0\n-        const pending = queueData.queue_pending ? queueData.queue_pending.length : 0\n-        const total = running + pending\n+          // ComfyUI é˜Ÿåˆ— API è¿”å›æ ¼å¼: { queue_running: [...], queue_pending: [...] }\n+          const running = queueData.queue_running ? queueData.queue_running.length : 0\n+          const pending = queueData.queue_pending ? queueData.queue_pending.length : 0\n+          const total = running + pending\n \n-        return {\n-          running,\n-          pending,\n-          total,\n-          healthy: true\n+          console.log(`ğŸ“Š é˜Ÿåˆ—ç»Ÿè®¡ - è¿è¡Œä¸­: ${running}, ç­‰å¾…ä¸­: ${pending}, æ€»è®¡: ${total}`)\n+\n+          return {\n+            running,\n+            pending,\n+            total,\n+            healthy: true\n+          }\n+        } catch (parseError) {\n+          console.warn(`âš ï¸ è§£æé˜Ÿåˆ—æ•°æ®å¤±è´¥:`, parseError.message)\n+          // å¦‚æœèƒ½è¿æ¥ä½†æ— æ³•è§£æJSONï¼Œè¯´æ˜æœåŠ¡å™¨å¯ç”¨ä½†å¯èƒ½è¿”å›äº†éæ ‡å‡†æ ¼å¼\n+          return {\n+            running: 0,\n+            pending: 0,\n+            total: 1, // ä½¿ç”¨1è€Œä¸æ˜¯0ï¼Œé¿å…æ‰€æœ‰ç”¨æˆ·éƒ½é€‰æ‹©è¿™ä¸ªæœåŠ¡å™¨\n+            healthy: true,\n+            isEstimate: true\n+          }\n         }\n       } else {\n         console.warn(`âš ï¸ æœåŠ¡å™¨ ${serverUrl} é˜Ÿåˆ—APIè¿”å›çŠ¶æ€ç : ${response.status}`)\n+        // å¦‚æœé˜Ÿåˆ—APIä¸å¯ç”¨ä½†æœåŠ¡å™¨å¯è¾¾ï¼Œä½¿ç”¨ä¼°ç®—å€¼\n         return {\n           running: 0,\n           pending: 0,\n           total: 1, // ä½¿ç”¨1è€Œä¸æ˜¯0ï¼Œé¿å…æ‰€æœ‰ç”¨æˆ·éƒ½é€‰æ‹©è¿™ä¸ªæœåŠ¡å™¨\n@@ -202,9 +219,10 @@\n       return {\n         running: 0,\n         pending: 0,\n         total: 999, // é«˜å€¼è¡¨ç¤ºä¸å¯ç”¨\n-        healthy: false\n+        healthy: false,\n+        error: error.message\n       }\n     }\n   }\n \n"
                },
                {
                    "date": 1752514111667,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -385,14 +385,18 @@\n \n           const health = healthResult.status === 'fulfilled' ? healthResult.value : { healthy: false }\n           const queue = queueResult.status === 'fulfilled' ? queueResult.value : { total: 999, healthy: false }\n \n+          // æ›´æ™ºèƒ½çš„å¥åº·åˆ¤æ–­ï¼šå¦‚æœå¥åº·æ£€æŸ¥é€šè¿‡ï¼Œå³ä½¿é˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥ä¹Ÿè®¤ä¸ºæœåŠ¡å™¨å¯ç”¨\n+          const isHealthy = health.healthy || (health.responseTime > 0 && health.responseTime < 30000)\n+\n           return {\n             ...server,\n-            healthy: health.healthy,\n+            healthy: isHealthy,\n             queue: queue,\n             responseTime: health.responseTime || 0,\n-            error: health.error\n+            error: health.error,\n+            healthCheckEndpoint: health.endpoint\n           }\n         } catch (error) {\n           return {\n             ...server,\n"
                },
                {
                    "date": 1752514996447,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -68,16 +68,25 @@\n       }\n \n       // å¦‚æœæ²¡æœ‰é…ç½®æœåŠ¡å™¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®\n       if (servers.length === 0) {\n-        const localConfig = JSON.parse(localStorage.getItem('comfyui_config') || '{}')\n-        const defaultUrl = localConfig.COMFYUI_SERVER_URL || 'https://your-comfyui-server.com'\n+        console.warn('âš ï¸ æœªæ‰¾åˆ°é…ç½®çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨é»˜è®¤æœåŠ¡å™¨åˆ—è¡¨')\n \n-        servers.push({\n-          url: defaultUrl,\n-          type: 'primary',\n-          priority: 1\n-        })\n+        // ä½¿ç”¨æ›´æ–°åçš„é»˜è®¤æœåŠ¡å™¨åˆ—è¡¨\n+        const defaultServers = [\n+          {\n+            url: 'https://l9s75ay3rp-8188.cnb.run',\n+            type: 'primary',\n+            priority: 1\n+          },\n+          {\n+            url: 'https://0rv00xh2vg-8188.cnb.run',\n+            type: 'backup',\n+            priority: 2\n+          }\n+        ]\n+\n+        servers.push(...defaultServers)\n       }\n \n       console.log(`âœ… è·å–åˆ° ${servers.length} ä¸ªæœåŠ¡å™¨:`, servers.map(s => s.url))\n       return servers\n"
                },
                {
                    "date": 1752515252979,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -224,13 +224,15 @@\n       }\n \n     } catch (error) {\n       console.warn(`âš ï¸ è·å–æœåŠ¡å™¨ ${serverUrl} é˜Ÿåˆ—ä¿¡æ¯å¤±è´¥:`, error.message)\n+      // å¦‚æœé˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥ï¼Œä½†æœåŠ¡å™¨å¯èƒ½ä»ç„¶å¥åº·ï¼Œä½¿ç”¨ä¼°ç®—å€¼\n       return {\n         running: 0,\n         pending: 0,\n-        total: 999, // é«˜å€¼è¡¨ç¤ºä¸å¯ç”¨\n-        healthy: false,\n+        total: 1, // ä½¿ç”¨è¾ƒä½çš„ä¼°ç®—å€¼ï¼Œé¿å…å½±å“æœåŠ¡å™¨é€‰æ‹©\n+        healthy: true, // é˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥ä¸ä»£è¡¨æœåŠ¡å™¨ä¸å¥åº·\n+        isEstimate: true,\n         error: error.message\n       }\n     }\n   }\n"
                },
                {
                    "date": 1752515273206,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -394,13 +394,24 @@\n             this.getServerQueueInfo(server.url)\n           ])\n \n           const health = healthResult.status === 'fulfilled' ? healthResult.value : { healthy: false }\n-          const queue = queueResult.status === 'fulfilled' ? queueResult.value : { total: 999, healthy: false }\n+          const queue = queueResult.status === 'fulfilled' ? queueResult.value : {\n+            total: 1,\n+            running: 0,\n+            pending: 0,\n+            healthy: true,\n+            isEstimate: true\n+          }\n \n-          // æ›´æ™ºèƒ½çš„å¥åº·åˆ¤æ–­ï¼šå¦‚æœå¥åº·æ£€æŸ¥é€šè¿‡ï¼Œå³ä½¿é˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥ä¹Ÿè®¤ä¸ºæœåŠ¡å™¨å¯ç”¨\n-          const isHealthy = health.healthy || (health.responseTime > 0 && health.responseTime < 30000)\n+          // æœåŠ¡å™¨å¥åº·çŠ¶æ€ä¸»è¦åŸºäºå¥åº·æ£€æŸ¥ç»“æœ\n+          const isHealthy = health.healthy\n \n+          // å¦‚æœé˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥ä½†æœåŠ¡å™¨å¥åº·ï¼Œç»™å‡ºè­¦å‘Šä½†ä¸å½±å“é€‰æ‹©\n+          if (isHealthy && queue.isEstimate) {\n+            console.warn(`âš ï¸ ${server.url} å¥åº·ä½†é˜Ÿåˆ—ä¿¡æ¯ä¸å¯ç”¨ï¼Œä½¿ç”¨ä¼°ç®—å€¼`)\n+          }\n+\n           return {\n             ...server,\n             healthy: isHealthy,\n             queue: queue,\n"
                },
                {
                    "date": 1752515450042,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -183,16 +183,52 @@\n       clearTimeout(timeoutId)\n \n       if (response.ok) {\n         try {\n-          const queueData = await response.json()\n-          console.log(`ğŸ“Š æœåŠ¡å™¨ ${serverUrl} é˜Ÿåˆ—æ•°æ®:`, queueData)\n+          const responseText = await response.text()\n+          console.log(`ğŸ“Š é˜Ÿåˆ—APIåŸå§‹å“åº”: ${responseText.substring(0, 200)}...`)\n \n-          // ComfyUI é˜Ÿåˆ— API è¿”å›æ ¼å¼: { queue_running: [...], queue_pending: [...] }\n-          const running = queueData.queue_running ? queueData.queue_running.length : 0\n-          const pending = queueData.queue_pending ? queueData.queue_pending.length : 0\n+          const queueData = JSON.parse(responseText)\n+          console.log(`ğŸ“Š æœåŠ¡å™¨ ${serverUrl} é˜Ÿåˆ—æ•°æ®ç»“æ„:`, Object.keys(queueData))\n+\n+          // å°è¯•å¤šç§å¯èƒ½çš„æ•°æ®æ ¼å¼\n+          let running = 0\n+          let pending = 0\n+\n+          // æ ‡å‡† ComfyUI æ ¼å¼\n+          if (queueData.queue_running !== undefined && queueData.queue_pending !== undefined) {\n+            running = Array.isArray(queueData.queue_running) ? queueData.queue_running.length :\n+                     (typeof queueData.queue_running === 'number' ? queueData.queue_running : 0)\n+            pending = Array.isArray(queueData.queue_pending) ? queueData.queue_pending.length :\n+                     (typeof queueData.queue_pending === 'number' ? queueData.queue_pending : 0)\n+          }\n+          // å…¶ä»–å¯èƒ½çš„æ ¼å¼\n+          else if (queueData.running !== undefined && queueData.pending !== undefined) {\n+            running = typeof queueData.running === 'number' ? queueData.running : 0\n+            pending = typeof queueData.pending === 'number' ? queueData.pending : 0\n+          }\n+          // å¦‚æœæœ‰ exec_info\n+          else if (queueData.exec_info) {\n+            running = queueData.exec_info.queue_remaining || 0\n+            pending = 0\n+          }\n+          // ç®€å•çš„æ•°å­—æ ¼å¼\n+          else if (typeof queueData === 'number') {\n+            running = 0\n+            pending = queueData\n+          }\n+          // å¦‚æœæœ‰ queue å­—æ®µ\n+          else if (queueData.queue) {\n+            if (Array.isArray(queueData.queue)) {\n+              pending = queueData.queue.length\n+              running = 0\n+            } else if (typeof queueData.queue === 'number') {\n+              pending = queueData.queue\n+              running = 0\n+            }\n+          }\n+\n           const total = running + pending\n-\n           console.log(`ğŸ“Š é˜Ÿåˆ—ç»Ÿè®¡ - è¿è¡Œä¸­: ${running}, ç­‰å¾…ä¸­: ${pending}, æ€»è®¡: ${total}`)\n \n           return {\n             running,\n"
                },
                {
                    "date": 1752515705165,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -98,16 +98,17 @@\n   }\n \n   /**\n    * æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€\n-   * å°è¯•å¤šä¸ªç«¯ç‚¹æ¥ç¡®ä¿å‡†ç¡®æ£€æµ‹\n+   * åŸºäº ComfyUI å®˜æ–¹æ–‡æ¡£çš„ç«¯ç‚¹è¿›è¡Œæ£€æµ‹\n    */\n   async checkServerHealth(serverUrl) {\n-    // è¦æµ‹è¯•çš„ç«¯ç‚¹åˆ—è¡¨ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº\n+    // åŸºäºå®˜æ–¹æ–‡æ¡£çš„ç«¯ç‚¹åˆ—è¡¨ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº\n     const testEndpoints = [\n-      '/queue',        // ComfyUI é˜Ÿåˆ—ç«¯ç‚¹ï¼Œæœ€å¸¸ç”¨\n-      '/system_stats', // ComfyUI ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n-      '/history',      // ComfyUI å†å²è®°å½•ç«¯ç‚¹\n+      '/system_stats', // å®˜æ–¹æ¨èçš„ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n+      '/queue',        // é˜Ÿåˆ—çŠ¶æ€ç«¯ç‚¹\n+      '/object_info',  // èŠ‚ç‚¹ä¿¡æ¯ç«¯ç‚¹\n+      '/prompt',       // æç¤ºçŠ¶æ€ç«¯ç‚¹\n       '/'              // æ ¹è·¯å¾„ï¼Œæœ€åå°è¯•\n     ]\n \n     let lastError = null\n"
                },
                {
                    "date": 1752515722092,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -124,10 +124,11 @@\n         const response = await fetch(`${serverUrl}${endpoint}`, {\n           method: 'GET',\n           signal: controller.signal,\n           headers: {\n+            'Accept': 'application/json, text/html, text/plain, */*',\n             'Cache-Control': 'no-cache',\n-            'Accept': 'application/json, text/plain, */*'\n+            'User-Agent': 'ComfyUI-LoadBalancer/1.0'\n           }\n         })\n \n         clearTimeout(timeoutId)\n"
                },
                {
                    "date": 1752515737613,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -176,10 +176,11 @@\n       const response = await fetch(`${serverUrl}/queue`, {\n         method: 'GET',\n         signal: controller.signal,\n         headers: {\n-          'Accept': 'application/json, text/plain, */*',\n-          'Cache-Control': 'no-cache'\n+          'Accept': 'application/json, text/html, text/plain, */*',\n+          'Cache-Control': 'no-cache',\n+          'User-Agent': 'ComfyUI-LoadBalancer/1.0'\n         }\n       })\n \n       clearTimeout(timeoutId)\n"
                },
                {
                    "date": 1752516060851,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -101,15 +101,17 @@\n    * æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€\n    * åŸºäº ComfyUI å®˜æ–¹æ–‡æ¡£çš„ç«¯ç‚¹è¿›è¡Œæ£€æµ‹\n    */\n   async checkServerHealth(serverUrl) {\n-    // åŸºäºå®˜æ–¹æ–‡æ¡£çš„ç«¯ç‚¹åˆ—è¡¨ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº\n+    // åŸºäºå®é™…æœåŠ¡å™¨çš„ç«¯ç‚¹åˆ—è¡¨ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº\n     const testEndpoints = [\n-      '/system_stats', // å®˜æ–¹æ¨èçš„ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n-      '/queue',        // é˜Ÿåˆ—çŠ¶æ€ç«¯ç‚¹\n-      '/object_info',  // èŠ‚ç‚¹ä¿¡æ¯ç«¯ç‚¹\n-      '/prompt',       // æç¤ºçŠ¶æ€ç«¯ç‚¹\n-      '/'              // æ ¹è·¯å¾„ï¼Œæœ€åå°è¯•\n+      '/api/queue',        // å®é™…çš„é˜Ÿåˆ—ç«¯ç‚¹è·¯å¾„\n+      '/api/system_stats', // ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n+      '/api/object_info',  // èŠ‚ç‚¹ä¿¡æ¯ç«¯ç‚¹\n+      '/api/prompt',       // æç¤ºçŠ¶æ€ç«¯ç‚¹\n+      '/queue',            // å¤‡ç”¨æ ‡å‡†è·¯å¾„\n+      '/system_stats',     // å¤‡ç”¨æ ‡å‡†è·¯å¾„\n+      '/'                  // æ ¹è·¯å¾„ï¼Œæœ€åå°è¯•\n     ]\n \n     let lastError = null\n     const startTime = Date.now()\n"
                },
                {
                    "date": 1752516082605,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -126,11 +126,12 @@\n         const response = await fetch(`${serverUrl}${endpoint}`, {\n           method: 'GET',\n           signal: controller.signal,\n           headers: {\n-            'Accept': 'application/json, text/html, text/plain, */*',\n-            'Cache-Control': 'no-cache',\n-            'User-Agent': 'ComfyUI-LoadBalancer/1.0'\n+            'Accept': '*/*',\n+            'Cache-Control': 'max-age=0',\n+            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36',\n+            'comfy-user': 'loadbalancer-client'\n           }\n         })\n \n         clearTimeout(timeoutId)\n"
                },
                {
                    "date": 1752516100266,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -175,15 +175,16 @@\n       const timeoutId = setTimeout(() => controller.abort(), this.queueCheckTimeout)\n \n       console.log(`ğŸ“Š è·å–æœåŠ¡å™¨é˜Ÿåˆ—ä¿¡æ¯: ${serverUrl}/queue`)\n \n-      const response = await fetch(`${serverUrl}/queue`, {\n+      const response = await fetch(`${serverUrl}/api/queue`, {\n         method: 'GET',\n         signal: controller.signal,\n         headers: {\n-          'Accept': 'application/json, text/html, text/plain, */*',\n-          'Cache-Control': 'no-cache',\n-          'User-Agent': 'ComfyUI-LoadBalancer/1.0'\n+          'Accept': '*/*',\n+          'Cache-Control': 'max-age=0',\n+          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36',\n+          'comfy-user': 'loadbalancer-client'\n         }\n       })\n \n       clearTimeout(timeoutId)\n"
                },
                {
                    "date": 1752517076730,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -280,8 +280,157 @@\n     }\n   }\n \n   /**\n+   * é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æœåŠ¡å™¨è¿æ¥æµ‹è¯•\n+   * æä¾›è¯¦ç»†çš„æœåŠ¡å™¨çŠ¶æ€åé¦ˆ\n+   */\n+  async initializeServerConnection() {\n+    try {\n+      console.log('ğŸš€ æ­£åœ¨åˆå§‹åŒ– ComfyUI æœåŠ¡å™¨è¿æ¥...')\n+      console.log('=' .repeat(60))\n+\n+      // è·å–æœåŠ¡å™¨åˆ—è¡¨\n+      const servers = await this.getLatestServerList()\n+\n+      if (servers.length === 0) {\n+        console.warn('âš ï¸ æœªæ‰¾åˆ°ä»»ä½•é…ç½®çš„æœåŠ¡å™¨')\n+        return null\n+      }\n+\n+      console.log(`ğŸ“‹ å‘ç° ${servers.length} ä¸ªé…ç½®çš„æœåŠ¡å™¨:`)\n+      servers.forEach((server, index) => {\n+        console.log(`   ${index + 1}. ${server.url} (${server.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨æœåŠ¡å™¨'}, ä¼˜å…ˆçº§: ${server.priority})`)\n+      })\n+      console.log('')\n+\n+      console.log('ğŸ” å¼€å§‹æœåŠ¡å™¨è¿æ¥å’Œé˜Ÿåˆ—æµ‹è¯•...')\n+      console.log('-' .repeat(60))\n+\n+      // æµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨\n+      const serverChecks = servers.map(async (server) => {\n+        console.log(`\\nğŸ–¥ï¸  æµ‹è¯•æœåŠ¡å™¨: ${server.url}`)\n+        console.log(`   ç±»å‹: ${server.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨æœåŠ¡å™¨'} | ä¼˜å…ˆçº§: ${server.priority}`)\n+\n+        try {\n+          const [healthResult, queueResult] = await Promise.allSettled([\n+            this.checkServerHealth(server.url),\n+            this.getServerQueueInfo(server.url)\n+          ])\n+\n+          const health = healthResult.status === 'fulfilled' ? healthResult.value : { healthy: false }\n+          const queue = queueResult.status === 'fulfilled' ? queueResult.value : { total: 999, healthy: false }\n+\n+          // æ›´æ™ºèƒ½çš„å¥åº·åˆ¤æ–­\n+          const isHealthy = health.healthy || (health.responseTime > 0 && health.responseTime < 30000)\n+\n+          // è¯¦ç»†è¾“å‡ºæµ‹è¯•ç»“æœ\n+          if (isHealthy) {\n+            console.log(`   âœ… å¥åº·æ£€æŸ¥: é€šè¿‡ (${health.responseTime}ms)`)\n+            if (health.endpoint) {\n+              console.log(`   ğŸ”— å¯ç”¨ç«¯ç‚¹: ${health.endpoint}`)\n+            }\n+          } else {\n+            console.log(`   âŒ å¥åº·æ£€æŸ¥: å¤±è´¥ (${health.error || 'è¿æ¥å¤±è´¥'})`)\n+          }\n+\n+          // é˜Ÿåˆ—ä¿¡æ¯è¯¦ç»†è¾“å‡º\n+          if (queue.healthy) {\n+            console.log(`   ğŸ“Š é˜Ÿåˆ—ä¿¡æ¯: è¿è¡Œä¸­ ${queue.running || 0} | ç­‰å¾…ä¸­ ${queue.pending || 0} | æ€»è®¡ ${queue.total || 0}`)\n+            if (queue.isEstimate) {\n+              console.log(`   âš ï¸  é˜Ÿåˆ—æ•°æ®ä¸ºä¼°ç®—å€¼`)\n+            }\n+          } else {\n+            console.log(`   âŒ é˜Ÿåˆ—ä¿¡æ¯: è·å–å¤±è´¥ (${queue.error || 'è¿æ¥å¤±è´¥'})`)\n+          }\n+\n+          // æœåŠ¡å™¨çŠ¶æ€æ€»ç»“\n+          if (isHealthy) {\n+            const queueStatus = queue.total === 0 ? 'ğŸŸ¢ ç©ºé—²' :\n+                              queue.running > 0 ? 'ğŸŸ¡ ç¹å¿™' : 'ğŸ”´ é˜Ÿåˆ—æ»¡'\n+            console.log(`   ğŸ“ˆ æœåŠ¡å™¨çŠ¶æ€: ${queueStatus}`)\n+          } else {\n+            console.log(`   ğŸ“ˆ æœåŠ¡å™¨çŠ¶æ€: ğŸ”´ ä¸å¯ç”¨`)\n+          }\n+\n+          return {\n+            ...server,\n+            healthy: isHealthy,\n+            queue: queue,\n+            responseTime: health.responseTime || 0,\n+            error: health.error,\n+            healthCheckEndpoint: health.endpoint\n+          }\n+        } catch (error) {\n+          console.log(`   âŒ æµ‹è¯•å¤±è´¥: ${error.message}`)\n+          return {\n+            ...server,\n+            healthy: false,\n+            queue: { total: 999, healthy: false },\n+            responseTime: 0,\n+            error: error.message\n+          }\n+        }\n+      })\n+\n+      const serverResults = await Promise.all(serverChecks)\n+\n+      // è¾“å‡ºæµ‹è¯•ç»“æœæ±‡æ€»\n+      console.log('\\n' + '=' .repeat(60))\n+      const healthyServers = serverResults.filter(s => s.healthy)\n+      console.log(`ğŸ“Š æœåŠ¡å™¨è¿æ¥æµ‹è¯•å®Œæˆ: ${healthyServers.length}/${serverResults.length} ä¸ªæœåŠ¡å™¨å¯ç”¨`)\n+\n+      // è¯¦ç»†çš„æœåŠ¡å™¨çŠ¶æ€è¡¨æ ¼\n+      console.log('\\nğŸ“‹ æœåŠ¡å™¨çŠ¶æ€æ±‡æ€»:')\n+      console.log('   çŠ¶æ€ | ç±»å‹     | æœåŠ¡å™¨URL                    | é˜Ÿåˆ—(è¿è¡Œ/ç­‰å¾…/æ€»è®¡) | å“åº”æ—¶é—´')\n+      console.log('   -----|----------|------------------------------|---------------------|----------')\n+\n+      serverResults.forEach(server => {\n+        const status = server.healthy ? 'âœ…' : 'âŒ'\n+        const type = server.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨    '\n+        const url = server.url.length > 28 ? server.url.substring(0, 25) + '...' : server.url.padEnd(28)\n+        const queueInfo = server.queue ?\n+          `${(server.queue.running || 0).toString().padStart(2)}/${(server.queue.pending || 0).toString().padStart(2)}/${(server.queue.total || 0).toString().padStart(2)}`.padEnd(19) :\n+          'N/A'.padEnd(19)\n+        const responseTime = server.responseTime ? `${server.responseTime}ms` : 'N/A'\n+\n+        console.log(`   ${status} | ${type} | ${url} | ${queueInfo} | ${responseTime}`)\n+      })\n+\n+      // é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n+      if (healthyServers.length > 0) {\n+        const bestServer = healthyServers.sort((a, b) => {\n+          const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n+          if (queueDiff !== 0) return queueDiff\n+          return a.priority - b.priority\n+        })[0]\n+\n+        console.log('\\nğŸ¯ æœ€ä¼˜æœåŠ¡å™¨é€‰æ‹©ç»“æœ:')\n+        console.log(`   é€‰æ‹©æœåŠ¡å™¨: ${bestServer.url}`)\n+        console.log(`   é€‰æ‹©åŸå› : ${bestServer.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨æœåŠ¡å™¨'} | é˜Ÿåˆ—æœ€å°‘ (${bestServer.queue.total || 0} ä¸ªä»»åŠ¡)`)\n+        console.log(`   é˜Ÿåˆ—è¯¦æƒ…: è¿è¡Œä¸­ ${bestServer.queue.running || 0} | ç­‰å¾…ä¸­ ${bestServer.queue.pending || 0}`)\n+        console.log(`   å“åº”æ—¶é—´: ${bestServer.responseTime}ms`)\n+        console.log(`   ä¼˜å…ˆçº§: ${bestServer.priority}`)\n+\n+        console.log('\\nâœ… æœåŠ¡å™¨åˆå§‹åŒ–å®Œæˆï¼Œç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼')\n+        console.log('=' .repeat(60))\n+\n+        return bestServer.url\n+      } else {\n+        console.log('\\nâŒ æœåŠ¡å™¨é€‰æ‹©ç»“æœ: æ‰€æœ‰æœåŠ¡å™¨éƒ½ä¸å¯ç”¨')\n+        console.log('ğŸ’¡ å»ºè®®: è¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®æˆ–ç½‘ç»œè¿æ¥')\n+        console.log('=' .repeat(60))\n+        return null\n+      }\n+\n+    } catch (error) {\n+      console.error('\\nâŒ æœåŠ¡å™¨åˆå§‹åŒ–å¤±è´¥:', error)\n+      console.log('=' .repeat(60))\n+      return null\n+    }\n+  }\n+\n+  /**\n    * é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨ï¼ˆä¸»è¦æ¥å£ï¼‰\n    * åªåœ¨ç”¨æˆ·å‘èµ·ç”Ÿå›¾è¯·æ±‚æ—¶è°ƒç”¨\n    */\n   async getOptimalServer() {\n"
                },
                {
                    "date": 1752517124766,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -434,24 +434,18 @@\n    * åªåœ¨ç”¨æˆ·å‘èµ·ç”Ÿå›¾è¯·æ±‚æ—¶è°ƒç”¨\n    */\n   async getOptimalServer() {\n     try {\n-      console.log('ğŸ¯ å¼€å§‹é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨...')\n+      console.log('ğŸ¯ é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨ (ç”¨äºç”Ÿå›¾è¯·æ±‚)...')\n \n       // 1. è·å–æœ€æ–°çš„æœåŠ¡å™¨åˆ—è¡¨\n       const servers = await this.getLatestServerList()\n \n       if (servers.length === 0) {\n         throw new Error('æ²¡æœ‰å¯ç”¨çš„æœåŠ¡å™¨é…ç½®')\n       }\n \n-      console.log(`ğŸ“‹ å‘ç° ${servers.length} ä¸ªé…ç½®çš„æœåŠ¡å™¨:`)\n-      servers.forEach((server, index) => {\n-        console.log(`   ${index + 1}. ${server.url} (${server.type}, ä¼˜å…ˆçº§: ${server.priority})`)\n-      })\n-\n       // 2. å¹¶è¡Œæ£€æŸ¥æ‰€æœ‰æœåŠ¡å™¨çš„å¥åº·çŠ¶æ€å’Œé˜Ÿåˆ—ä¿¡æ¯\n-      console.log('ğŸ” æ­£åœ¨æµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨çš„å¥åº·çŠ¶æ€å’Œé˜Ÿåˆ—ä¿¡æ¯...')\n       const serverChecks = servers.map(async (server) => {\n         try {\n           const [healthResult, queueResult] = await Promise.allSettled([\n             this.checkServerHealth(server.url),\n@@ -460,24 +454,20 @@\n \n           const health = healthResult.status === 'fulfilled' ? healthResult.value : { healthy: false }\n           const queue = queueResult.status === 'fulfilled' ? queueResult.value : { total: 999, healthy: false }\n \n-          // è¾“å‡ºæ¯ä¸ªæœåŠ¡å™¨çš„æµ‹è¯•ç»“æœ\n-          if (health.healthy) {\n-            console.log(`âœ… ${server.url} - å¥åº· (å“åº”æ—¶é—´: ${health.responseTime}ms, é˜Ÿåˆ—: ${queue.total || 0})`)\n-          } else {\n-            console.log(`âŒ ${server.url} - ä¸å¯ç”¨ (${health.error || 'è¿æ¥å¤±è´¥'})`)\n-          }\n+          // æ›´æ™ºèƒ½çš„å¥åº·åˆ¤æ–­\n+          const isHealthy = health.healthy || (health.responseTime > 0 && health.responseTime < 30000)\n \n           return {\n             ...server,\n-            healthy: health.healthy,\n+            healthy: isHealthy,\n             queue: queue,\n             responseTime: health.responseTime || 0,\n-            error: health.error\n+            error: health.error,\n+            healthCheckEndpoint: health.endpoint\n           }\n         } catch (error) {\n-          console.error(`âŒ æ£€æŸ¥æœåŠ¡å™¨ ${server.url} å¤±è´¥:`, error)\n           return {\n             ...server,\n             healthy: false,\n             queue: { total: 999, healthy: false },\n@@ -488,15 +478,9 @@\n       })\n \n       const serverResults = await Promise.all(serverChecks)\n \n-      // 3. æ˜¾ç¤ºæµ‹è¯•ç»“æœæ±‡æ€»\n-      const healthyCount = serverResults.filter(s => s.healthy).length\n-      const unhealthyCount = serverResults.length - healthyCount\n-\n-      console.log(`ğŸ“Š æœåŠ¡å™¨æµ‹è¯•ç»“æœæ±‡æ€»: ${healthyCount} ä¸ªå¥åº·, ${unhealthyCount} ä¸ªä¸å¯ç”¨`)\n-\n-      // 4. è¿‡æ»¤å¥åº·çš„æœåŠ¡å™¨å¹¶æŒ‰é˜Ÿåˆ—é•¿åº¦æ’åº\n+      // 3. è¿‡æ»¤å¥åº·çš„æœåŠ¡å™¨å¹¶æŒ‰é˜Ÿåˆ—é•¿åº¦æ’åº\n       const healthyServers = serverResults\n         .filter(server => server.healthy)\n         .sort((a, b) => {\n           // æŒ‰é˜Ÿåˆ—æ•°é‡æ’åº\n@@ -506,9 +490,9 @@\n           // å¦‚æœé˜Ÿåˆ—ç›¸åŒï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº\n           return a.priority - b.priority\n         })\n \n-      // 5. é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n+      // 4. é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n       if (healthyServers.length === 0) {\n         console.warn('âš ï¸ æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨å“åº”æœ€å¿«çš„æœåŠ¡å™¨')\n \n         // å¦‚æœæ²¡æœ‰å¥åº·æœåŠ¡å™¨ï¼Œé€‰æ‹©å“åº”æ—¶é—´æœ€å¿«çš„\n@@ -516,31 +500,20 @@\n           .filter(server => server.responseTime > 0)\n           .sort((a, b) => a.responseTime - b.responseTime)[0]\n \n         if (fastestServer) {\n-          console.log(`ğŸ†˜ æœ€ç»ˆé€‰æ‹©: ${fastestServer.url}`)\n-          console.log(`   åŸå› : å“åº”æœ€å¿«çš„æœåŠ¡å™¨ (${fastestServer.responseTime}ms)`)\n-          console.log(`   çŠ¶æ€: å¯èƒ½ä¸ç¨³å®šï¼Œå»ºè®®æ£€æŸ¥æœåŠ¡å™¨é…ç½®`)\n+          console.log(`ğŸ†˜ é€‰æ‹©å“åº”æœ€å¿«çš„æœåŠ¡å™¨: ${fastestServer.url} (${fastestServer.responseTime}ms)`)\n           return fastestServer.url\n         }\n \n         // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼šè¿”å›ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨\n-        console.log(`ğŸ†˜ æœ€ç»ˆé€‰æ‹©: ${servers[0].url}`)\n-        console.log(`   åŸå› : å¤‡ç”¨æ–¹æ¡ˆ - ä½¿ç”¨ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨`)\n-        console.log(`   çŠ¶æ€: æœªçŸ¥ï¼Œå¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œ`)\n+        console.log(`ğŸ†˜ ä½¿ç”¨ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨: ${servers[0].url}`)\n         return servers[0].url\n       }\n \n       const selectedServer = healthyServers[0]\n-      console.log(`ğŸ¯ æœ€ç»ˆé€‰æ‹©: ${selectedServer.url}`)\n-      console.log(`   ç±»å‹: ${selectedServer.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨æœåŠ¡å™¨'}`)\n-      console.log(`   é˜Ÿåˆ—æ•°: ${selectedServer.queue.total || 0} (è¿è¡Œä¸­: ${selectedServer.queue.running || 0}, ç­‰å¾…ä¸­: ${selectedServer.queue.pending || 0})`)\n-      console.log(`   å“åº”æ—¶é—´: ${selectedServer.responseTime}ms`)\n-      console.log(`   ä¼˜å…ˆçº§: ${selectedServer.priority}`)\n+      console.log(`ğŸ¯ é€‰æ‹©æœåŠ¡å™¨: ${selectedServer.url} (é˜Ÿåˆ—: ${selectedServer.queue.total || 0}, å“åº”æ—¶é—´: ${selectedServer.responseTime}ms)`)\n \n-      // 6. è®°å½•æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•ï¼‰\n-      this.logServerStatus(serverResults)\n-\n       return selectedServer.url\n \n     } catch (error) {\n       console.error('âŒ æœåŠ¡å™¨é€‰æ‹©å¤±è´¥:', error)\n"
                },
                {
                    "date": 1752517847163,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -319,10 +319,10 @@\n \n           const health = healthResult.status === 'fulfilled' ? healthResult.value : { healthy: false }\n           const queue = queueResult.status === 'fulfilled' ? queueResult.value : { total: 999, healthy: false }\n \n-          // æ›´æ™ºèƒ½çš„å¥åº·åˆ¤æ–­\n-          const isHealthy = health.healthy || (health.responseTime > 0 && health.responseTime < 30000)\n+          // å¥åº·åˆ¤æ–­ï¼šåªæœ‰æ˜ç¡®è¿”å› healthy: true æ‰è®¤ä¸ºå¥åº·\n+          const isHealthy = health.healthy === true\n \n           // è¯¦ç»†è¾“å‡ºæµ‹è¯•ç»“æœ\n           if (isHealthy) {\n             console.log(`   âœ… å¥åº·æ£€æŸ¥: é€šè¿‡ (${health.responseTime}ms)`)\n"
                },
                {
                    "date": 1752517862947,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -454,10 +454,10 @@\n \n           const health = healthResult.status === 'fulfilled' ? healthResult.value : { healthy: false }\n           const queue = queueResult.status === 'fulfilled' ? queueResult.value : { total: 999, healthy: false }\n \n-          // æ›´æ™ºèƒ½çš„å¥åº·åˆ¤æ–­\n-          const isHealthy = health.healthy || (health.responseTime > 0 && health.responseTime < 30000)\n+          // å¥åº·åˆ¤æ–­ï¼šåªæœ‰æ˜ç¡®è¿”å› healthy: true æ‰è®¤ä¸ºå¥åº·\n+          const isHealthy = health.healthy === true\n \n           return {\n             ...server,\n             healthy: isHealthy,\n"
                },
                {
                    "date": 1752517945786,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -267,15 +267,14 @@\n       }\n \n     } catch (error) {\n       console.warn(`âš ï¸ è·å–æœåŠ¡å™¨ ${serverUrl} é˜Ÿåˆ—ä¿¡æ¯å¤±è´¥:`, error.message)\n-      // å¦‚æœé˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥ï¼Œä½†æœåŠ¡å™¨å¯èƒ½ä»ç„¶å¥åº·ï¼Œä½¿ç”¨ä¼°ç®—å€¼\n+      // å¦‚æœé˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥ï¼Œè¯´æ˜æœåŠ¡å™¨å¯èƒ½ä¸å¯ç”¨\n       return {\n         running: 0,\n         pending: 0,\n-        total: 1, // ä½¿ç”¨è¾ƒä½çš„ä¼°ç®—å€¼ï¼Œé¿å…å½±å“æœåŠ¡å™¨é€‰æ‹©\n-        healthy: true, // é˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥ä¸ä»£è¡¨æœåŠ¡å™¨ä¸å¥åº·\n-        isEstimate: true,\n+        total: 999, // ä½¿ç”¨é«˜å€¼ï¼Œé¿å…é€‰æ‹©è¿™ä¸ªæœåŠ¡å™¨\n+        healthy: false, // é˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥è¯´æ˜æœåŠ¡å™¨å¯èƒ½æœ‰é—®é¢˜\n         error: error.message\n       }\n     }\n   }\n"
                },
                {
                    "date": 1752517964443,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -255,15 +255,15 @@\n           }\n         }\n       } else {\n         console.warn(`âš ï¸ æœåŠ¡å™¨ ${serverUrl} é˜Ÿåˆ—APIè¿”å›çŠ¶æ€ç : ${response.status}`)\n-        // å¦‚æœé˜Ÿåˆ—APIä¸å¯ç”¨ä½†æœåŠ¡å™¨å¯è¾¾ï¼Œä½¿ç”¨ä¼°ç®—å€¼\n+        // å¦‚æœé˜Ÿåˆ—APIè¿”å›é”™è¯¯çŠ¶æ€ç ï¼Œè¯´æ˜æœåŠ¡å™¨å¯èƒ½æœ‰é—®é¢˜\n         return {\n           running: 0,\n           pending: 0,\n-          total: 1, // ä½¿ç”¨1è€Œä¸æ˜¯0ï¼Œé¿å…æ‰€æœ‰ç”¨æˆ·éƒ½é€‰æ‹©è¿™ä¸ªæœåŠ¡å™¨\n-          healthy: true,\n-          isEstimate: true\n+          total: 999, // ä½¿ç”¨é«˜å€¼ï¼Œé¿å…é€‰æ‹©è¿™ä¸ªæœåŠ¡å™¨\n+          healthy: false,\n+          error: `HTTP ${response.status}`\n         }\n       }\n \n     } catch (error) {\n"
                },
                {
                    "date": 1752518240043,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,16 +1,11 @@\n-// ComfyUI æç®€è´Ÿè½½å‡è¡¡å™¨\n-import configService from './configService.js'\n-\n /**\n- * ComfyUI æç®€è´Ÿè½½å‡è¡¡å™¨\n- * åªåœ¨ç”¨æˆ·å‘èµ·è¯·æ±‚æ—¶é€‰æ‹©é˜Ÿåˆ—æœ€å°‘çš„å¯ç”¨æœåŠ¡å™¨\n+ * ComfyUI è´Ÿè½½å‡è¡¡å™¨ - é‡å†™ç‰ˆæœ¬\n+ * ä½¿ç”¨ç›´æ¥è¿æ¥æµ‹è¯•ä½œä¸ºå¥åº·åˆ¤æ–­æ ‡å‡†\n  */\n-class ComfyUILoadBalancer {\n+class LoadBalancer {\n   constructor() {\n-    this.queueCheckTimeout = 5000 // 5ç§’é˜Ÿåˆ—æ£€æŸ¥è¶…æ—¶\n-    this.healthCheckTimeout = 5000 // 5ç§’å¥åº·æ£€æŸ¥è¶…æ—¶\n-    this.initialized = false\n+    this.connectionTimeout = 10000 // 10ç§’è¿æ¥è¶…æ—¶\n   }\n \n   /**\n    * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨ï¼ˆä»…åœ¨é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰\n"
                },
                {
                    "date": 1752518259328,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,23 +7,13 @@\n     this.connectionTimeout = 10000 // 10ç§’è¿æ¥è¶…æ—¶\n   }\n \n   /**\n-   * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨ï¼ˆä»…åœ¨é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰\n+   * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n    */\n   async initialize() {\n-    if (this.initialized) {\n-      return\n-    }\n-\n-    try {\n-      console.log('ğŸ”„ åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨...')\n-      this.initialized = true\n-      console.log('âœ… è´Ÿè½½å‡è¡¡å™¨åˆå§‹åŒ–å®Œæˆ')\n-    } catch (error) {\n-      console.error('âŒ è´Ÿè½½å‡è¡¡å™¨åˆå§‹åŒ–å¤±è´¥:', error)\n-      this.initialized = false\n-    }\n+    console.log('ğŸ”§ åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨...')\n+    return true\n   }\n \n   /**\n    * è·å–æœ€æ–°çš„æœåŠ¡å™¨åˆ—è¡¨ï¼ˆä»æ•°æ®åº“/é…ç½®ä¸­è·å–ï¼‰\n"
                },
                {
                    "date": 1752518284230,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,72 +15,42 @@\n     return true\n   }\n \n   /**\n-   * è·å–æœ€æ–°çš„æœåŠ¡å™¨åˆ—è¡¨ï¼ˆä»æ•°æ®åº“/é…ç½®ä¸­è·å–ï¼‰\n+   * è·å–æœåŠ¡å™¨åˆ—è¡¨\n    */\n-  async getLatestServerList() {\n-    try {\n-      console.log('ğŸ”„ è·å–æœ€æ–°æœåŠ¡å™¨åˆ—è¡¨...')\n+  async getServerList() {\n+    const servers = []\n \n-      // ä»é…ç½®æœåŠ¡è·å–æœ€æ–°é…ç½®\n-      const config = await configService.getConfig()\n-      const servers = []\n+    // ä¸»æœåŠ¡å™¨\n+    const primaryServer = window.getConfig?.('comfyui.server_url')\n+    if (primaryServer && primaryServer.trim()) {\n+      servers.push({\n+        url: primaryServer.trim(),\n+        type: 'primary',\n+        priority: 1\n+      })\n+    }\n \n-      // ä¸»æœåŠ¡å™¨\n-      if (config['comfyui.server_url']) {\n+    // å¤‡ç”¨æœåŠ¡å™¨\n+    const backupServersConfig = window.getConfig?.('comfyui.backup_servers')\n+    if (backupServersConfig && backupServersConfig.trim()) {\n+      const backupServers = backupServersConfig\n+        .replace(/\\s*,\\s*/g, '\\n')\n+        .split('\\n')\n+        .map(url => url.trim())\n+        .filter(url => url && url.startsWith('http'))\n+\n+      backupServers.forEach((url, index) => {\n         servers.push({\n-          url: config['comfyui.server_url'],\n-          type: 'primary',\n-          priority: 1\n+          url,\n+          type: 'backup',\n+          priority: index + 2\n         })\n-      }\n+      })\n+    }\n \n-      // å¤‡ç”¨æœåŠ¡å™¨ - æ”¯æŒæ¢è¡Œç¬¦å’Œé€—å·ä¸¤ç§åˆ†éš”æ–¹å¼\n-      if (config['comfyui.backup_servers']) {\n-        const backupServers = config['comfyui.backup_servers']\n-          .replace(/\\s*,\\s*/g, '\\n') // å°†é€—å·æ›¿æ¢ä¸ºæ¢è¡Œç¬¦\n-          .split('\\n')\n-          .map(url => url.trim())\n-          .filter(url => url && url.startsWith('http'))\n-\n-        backupServers.forEach((url, index) => {\n-          servers.push({\n-            url,\n-            type: 'backup',\n-            priority: index + 2\n-          })\n-        })\n-      }\n-\n-      // å¦‚æœæ²¡æœ‰é…ç½®æœåŠ¡å™¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®\n-      if (servers.length === 0) {\n-        console.warn('âš ï¸ æœªæ‰¾åˆ°é…ç½®çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨é»˜è®¤æœåŠ¡å™¨åˆ—è¡¨')\n-\n-        // ä½¿ç”¨æ›´æ–°åçš„é»˜è®¤æœåŠ¡å™¨åˆ—è¡¨\n-        const defaultServers = [\n-          {\n-            url: 'https://l9s75ay3rp-8188.cnb.run',\n-            type: 'primary',\n-            priority: 1\n-          },\n-          {\n-            url: 'https://0rv00xh2vg-8188.cnb.run',\n-            type: 'backup',\n-            priority: 2\n-          }\n-        ]\n-\n-        servers.push(...defaultServers)\n-      }\n-\n-      console.log(`âœ… è·å–åˆ° ${servers.length} ä¸ªæœåŠ¡å™¨:`, servers.map(s => s.url))\n-      return servers\n-\n-    } catch (error) {\n-      console.error('âŒ è·å–æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥:', error)\n-      return []\n-    }\n+    return servers\n   }\n \n   /**\n    * æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€\n"
                },
                {
                    "date": 1752518311193,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -52,74 +52,42 @@\n     return servers\n   }\n \n   /**\n-   * æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€\n-   * åŸºäº ComfyUI å®˜æ–¹æ–‡æ¡£çš„ç«¯ç‚¹è¿›è¡Œæ£€æµ‹\n+   * ç›´æ¥è¿æ¥æµ‹è¯• - ç®€å•æœ‰æ•ˆçš„å¥åº·æ£€æŸ¥\n    */\n-  async checkServerHealth(serverUrl) {\n-    // åŸºäºå®é™…æœåŠ¡å™¨çš„ç«¯ç‚¹åˆ—è¡¨ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº\n-    const testEndpoints = [\n-      '/api/queue',        // å®é™…çš„é˜Ÿåˆ—ç«¯ç‚¹è·¯å¾„\n-      '/api/system_stats', // ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n-      '/api/object_info',  // èŠ‚ç‚¹ä¿¡æ¯ç«¯ç‚¹\n-      '/api/prompt',       // æç¤ºçŠ¶æ€ç«¯ç‚¹\n-      '/queue',            // å¤‡ç”¨æ ‡å‡†è·¯å¾„\n-      '/system_stats',     // å¤‡ç”¨æ ‡å‡†è·¯å¾„\n-      '/'                  // æ ¹è·¯å¾„ï¼Œæœ€åå°è¯•\n-    ]\n+  async testDirectConnection(serverUrl) {\n+    try {\n+      const controller = new AbortController()\n+      const timeoutId = setTimeout(() => controller.abort(), this.connectionTimeout)\n \n-    let lastError = null\n-    const startTime = Date.now()\n+      const startTime = Date.now()\n+      const response = await fetch(serverUrl, {\n+        method: 'HEAD',\n+        signal: controller.signal,\n+        headers: {\n+          'Accept': '*/*',\n+          'Cache-Control': 'no-cache'\n+        }\n+      })\n \n-    for (const endpoint of testEndpoints) {\n-      try {\n-        const controller = new AbortController()\n-        const timeoutId = setTimeout(() => controller.abort(), this.healthCheckTimeout)\n+      clearTimeout(timeoutId)\n+      const responseTime = Date.now() - startTime\n \n-        console.log(`ğŸ” æµ‹è¯•ç«¯ç‚¹: ${serverUrl}${endpoint}`)\n+      // åªè¦èƒ½è¿æ¥å°±è®¤ä¸ºå¥åº·ï¼Œä¸ç®¡è¿”å›ä»€ä¹ˆçŠ¶æ€ç \n+      return {\n+        healthy: true,\n+        responseTime,\n+        status: response.status\n+      }\n \n-        const response = await fetch(`${serverUrl}${endpoint}`, {\n-          method: 'GET',\n-          signal: controller.signal,\n-          headers: {\n-            'Accept': '*/*',\n-            'Cache-Control': 'max-age=0',\n-            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36',\n-            'comfy-user': 'loadbalancer-client'\n-          }\n-        })\n-\n-        clearTimeout(timeoutId)\n-        const endTime = Date.now()\n-\n-        // å¦‚æœå“åº”æˆåŠŸï¼Œè®¤ä¸ºæœåŠ¡å™¨å¥åº·\n-        if (response.ok) {\n-          console.log(`âœ… ç«¯ç‚¹ ${endpoint} å“åº”æˆåŠŸ (${response.status})`)\n-          return {\n-            healthy: true,\n-            responseTime: endTime - startTime,\n-            status: response.status,\n-            endpoint: endpoint\n-          }\n-        } else {\n-          console.log(`âš ï¸ ç«¯ç‚¹ ${endpoint} å“åº”å¤±è´¥ (${response.status})`)\n-          lastError = `HTTP ${response.status}`\n-        }\n-      } catch (error) {\n-        console.log(`âŒ ç«¯ç‚¹ ${endpoint} è¿æ¥å¤±è´¥: ${error.message}`)\n-        lastError = error.message\n-        continue\n+    } catch (error) {\n+      // åªæœ‰çœŸæ­£çš„è¿æ¥å¤±è´¥æ‰è®¤ä¸ºä¸å¥åº·\n+      return {\n+        healthy: false,\n+        error: error.message\n       }\n     }\n-\n-    // æ‰€æœ‰ç«¯ç‚¹éƒ½å¤±è´¥\n-    const endTime = Date.now()\n-    return {\n-      healthy: false,\n-      responseTime: endTime - startTime,\n-      error: lastError || 'æ‰€æœ‰ç«¯ç‚¹éƒ½æ— æ³•è®¿é—®'\n-    }\n   }\n \n   /**\n    * è·å–æœåŠ¡å™¨é˜Ÿåˆ—ä¿¡æ¯\n"
                },
                {
                    "date": 1752518345043,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -89,117 +89,47 @@\n     }\n   }\n \n   /**\n-   * è·å–æœåŠ¡å™¨é˜Ÿåˆ—ä¿¡æ¯\n+   * è·å–é˜Ÿåˆ—ä¿¡æ¯\n    */\n-  async getServerQueueInfo(serverUrl) {\n+  async getQueueInfo(serverUrl) {\n     try {\n       const controller = new AbortController()\n-      const timeoutId = setTimeout(() => controller.abort(), this.queueCheckTimeout)\n+      const timeoutId = setTimeout(() => controller.abort(), this.connectionTimeout)\n \n-      console.log(`ğŸ“Š è·å–æœåŠ¡å™¨é˜Ÿåˆ—ä¿¡æ¯: ${serverUrl}/queue`)\n-\n       const response = await fetch(`${serverUrl}/api/queue`, {\n         method: 'GET',\n         signal: controller.signal,\n         headers: {\n           'Accept': '*/*',\n           'Cache-Control': 'max-age=0',\n-          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36',\n+          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',\n           'comfy-user': 'loadbalancer-client'\n         }\n       })\n \n       clearTimeout(timeoutId)\n \n       if (response.ok) {\n-        try {\n-          const responseText = await response.text()\n-          console.log(`ğŸ“Š é˜Ÿåˆ—APIåŸå§‹å“åº”: ${responseText.substring(0, 200)}...`)\n+        const data = await response.json()\n \n-          const queueData = JSON.parse(responseText)\n-          console.log(`ğŸ“Š æœåŠ¡å™¨ ${serverUrl} é˜Ÿåˆ—æ•°æ®ç»“æ„:`, Object.keys(queueData))\n+        // è§£æé˜Ÿåˆ—æ•°æ®\n+        let running = 0, pending = 0, total = 0\n \n-          // å°è¯•å¤šç§å¯èƒ½çš„æ•°æ®æ ¼å¼\n-          let running = 0\n-          let pending = 0\n+        if (data.queue_running !== undefined && data.queue_pending !== undefined) {\n+          running = Array.isArray(data.queue_running) ? data.queue_running.length : data.queue_running\n+          pending = Array.isArray(data.queue_pending) ? data.queue_pending.length : data.queue_pending\n+          total = running + pending\n+        }\n \n-          // æ ‡å‡† ComfyUI æ ¼å¼\n-          if (queueData.queue_running !== undefined && queueData.queue_pending !== undefined) {\n-            running = Array.isArray(queueData.queue_running) ? queueData.queue_running.length :\n-                     (typeof queueData.queue_running === 'number' ? queueData.queue_running : 0)\n-            pending = Array.isArray(queueData.queue_pending) ? queueData.queue_pending.length :\n-                     (typeof queueData.queue_pending === 'number' ? queueData.queue_pending : 0)\n-          }\n-          // å…¶ä»–å¯èƒ½çš„æ ¼å¼\n-          else if (queueData.running !== undefined && queueData.pending !== undefined) {\n-            running = typeof queueData.running === 'number' ? queueData.running : 0\n-            pending = typeof queueData.pending === 'number' ? queueData.pending : 0\n-          }\n-          // å¦‚æœæœ‰ exec_info\n-          else if (queueData.exec_info) {\n-            running = queueData.exec_info.queue_remaining || 0\n-            pending = 0\n-          }\n-          // ç®€å•çš„æ•°å­—æ ¼å¼\n-          else if (typeof queueData === 'number') {\n-            running = 0\n-            pending = queueData\n-          }\n-          // å¦‚æœæœ‰ queue å­—æ®µ\n-          else if (queueData.queue) {\n-            if (Array.isArray(queueData.queue)) {\n-              pending = queueData.queue.length\n-              running = 0\n-            } else if (typeof queueData.queue === 'number') {\n-              pending = queueData.queue\n-              running = 0\n-            }\n-          }\n-\n-          const total = running + pending\n-          console.log(`ğŸ“Š é˜Ÿåˆ—ç»Ÿè®¡ - è¿è¡Œä¸­: ${running}, ç­‰å¾…ä¸­: ${pending}, æ€»è®¡: ${total}`)\n-\n-          return {\n-            running,\n-            pending,\n-            total,\n-            healthy: true\n-          }\n-        } catch (parseError) {\n-          console.warn(`âš ï¸ è§£æé˜Ÿåˆ—æ•°æ®å¤±è´¥:`, parseError.message)\n-          // å¦‚æœèƒ½è¿æ¥ä½†æ— æ³•è§£æJSONï¼Œè¯´æ˜æœåŠ¡å™¨å¯ç”¨ä½†å¯èƒ½è¿”å›äº†éæ ‡å‡†æ ¼å¼\n-          return {\n-            running: 0,\n-            pending: 0,\n-            total: 1, // ä½¿ç”¨1è€Œä¸æ˜¯0ï¼Œé¿å…æ‰€æœ‰ç”¨æˆ·éƒ½é€‰æ‹©è¿™ä¸ªæœåŠ¡å™¨\n-            healthy: true,\n-            isEstimate: true\n-          }\n-        }\n+        return { running, pending, total, success: true }\n       } else {\n-        console.warn(`âš ï¸ æœåŠ¡å™¨ ${serverUrl} é˜Ÿåˆ—APIè¿”å›çŠ¶æ€ç : ${response.status}`)\n-        // å¦‚æœé˜Ÿåˆ—APIè¿”å›é”™è¯¯çŠ¶æ€ç ï¼Œè¯´æ˜æœåŠ¡å™¨å¯èƒ½æœ‰é—®é¢˜\n-        return {\n-          running: 0,\n-          pending: 0,\n-          total: 999, // ä½¿ç”¨é«˜å€¼ï¼Œé¿å…é€‰æ‹©è¿™ä¸ªæœåŠ¡å™¨\n-          healthy: false,\n-          error: `HTTP ${response.status}`\n-        }\n+        return { running: 0, pending: 0, total: 1, success: false, error: `HTTP ${response.status}` }\n       }\n \n     } catch (error) {\n-      console.warn(`âš ï¸ è·å–æœåŠ¡å™¨ ${serverUrl} é˜Ÿåˆ—ä¿¡æ¯å¤±è´¥:`, error.message)\n-      // å¦‚æœé˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥ï¼Œè¯´æ˜æœåŠ¡å™¨å¯èƒ½ä¸å¯ç”¨\n-      return {\n-        running: 0,\n-        pending: 0,\n-        total: 999, // ä½¿ç”¨é«˜å€¼ï¼Œé¿å…é€‰æ‹©è¿™ä¸ªæœåŠ¡å™¨\n-        healthy: false, // é˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥è¯´æ˜æœåŠ¡å™¨å¯èƒ½æœ‰é—®é¢˜\n-        error: error.message\n-      }\n+      return { running: 0, pending: 0, total: 1, success: false, error: error.message }\n     }\n   }\n \n   /**\n"
                },
                {
                    "date": 1752518384766,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -133,11 +133,133 @@\n   }\n \n   /**\n    * é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æœåŠ¡å™¨è¿æ¥æµ‹è¯•\n-   * æä¾›è¯¦ç»†çš„æœåŠ¡å™¨çŠ¶æ€åé¦ˆ\n    */\n   async initializeServerConnection() {\n+    console.log('ğŸš€ æ­£åœ¨åˆå§‹åŒ– ComfyUI æœåŠ¡å™¨è¿æ¥...')\n+    console.log('=' .repeat(60))\n+\n+    const servers = await this.getServerList()\n+\n+    if (servers.length === 0) {\n+      console.warn('âš ï¸ æœªæ‰¾åˆ°ä»»ä½•é…ç½®çš„æœåŠ¡å™¨')\n+      return null\n+    }\n+\n+    console.log(`ğŸ“‹ å‘ç° ${servers.length} ä¸ªé…ç½®çš„æœåŠ¡å™¨:`)\n+    servers.forEach((server, index) => {\n+      console.log(`   ${index + 1}. ${server.url} (${server.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨æœåŠ¡å™¨'}, ä¼˜å…ˆçº§: ${server.priority})`)\n+    })\n+    console.log('')\n+\n+    console.log('ğŸ” å¼€å§‹æœåŠ¡å™¨è¿æ¥æµ‹è¯•...')\n+    console.log('-' .repeat(60))\n+\n+    const serverResults = []\n+\n+    for (const server of servers) {\n+      console.log(`\\nğŸ–¥ï¸  æµ‹è¯•æœåŠ¡å™¨: ${server.url}`)\n+      console.log(`   ç±»å‹: ${server.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨æœåŠ¡å™¨'} | ä¼˜å…ˆçº§: ${server.priority}`)\n+\n+      // ç›´æ¥è¿æ¥æµ‹è¯•\n+      const healthResult = await this.testDirectConnection(server.url)\n+\n+      if (healthResult.healthy) {\n+        console.log(`   âœ… è¿æ¥æµ‹è¯•: æˆåŠŸ (${healthResult.responseTime}ms, çŠ¶æ€ç : ${healthResult.status})`)\n+\n+        // è·å–é˜Ÿåˆ—ä¿¡æ¯\n+        const queueResult = await this.getQueueInfo(server.url)\n+\n+        if (queueResult.success) {\n+          console.log(`   ğŸ“Š é˜Ÿåˆ—ä¿¡æ¯: è¿è¡Œä¸­ ${queueResult.running} | ç­‰å¾…ä¸­ ${queueResult.pending} | æ€»è®¡ ${queueResult.total}`)\n+\n+          const queueStatus = queueResult.total === 0 ? 'ğŸŸ¢ ç©ºé—²' :\n+                            queueResult.running > 0 ? 'ğŸŸ¡ ç¹å¿™' : 'ğŸ”´ é˜Ÿåˆ—æ»¡'\n+          console.log(`   ğŸ“ˆ æœåŠ¡å™¨çŠ¶æ€: ${queueStatus}`)\n+\n+          serverResults.push({\n+            ...server,\n+            healthy: true,\n+            responseTime: healthResult.responseTime,\n+            queue: queueResult\n+          })\n+        } else {\n+          console.log(`   âš ï¸ é˜Ÿåˆ—ä¿¡æ¯: è·å–å¤±è´¥ (${queueResult.error})`)\n+          console.log(`   ğŸ“ˆ æœåŠ¡å™¨çŠ¶æ€: ğŸŸ¡ å¯ç”¨ä½†é˜Ÿåˆ—ä¿¡æ¯æœªçŸ¥`)\n+\n+          serverResults.push({\n+            ...server,\n+            healthy: true,\n+            responseTime: healthResult.responseTime,\n+            queue: { running: 0, pending: 0, total: 1, success: false }\n+          })\n+        }\n+      } else {\n+        console.log(`   âŒ è¿æ¥æµ‹è¯•: å¤±è´¥ (${healthResult.error})`)\n+        console.log(`   ğŸ“ˆ æœåŠ¡å™¨çŠ¶æ€: ğŸ”´ ä¸å¯ç”¨`)\n+\n+        serverResults.push({\n+          ...server,\n+          healthy: false,\n+          error: healthResult.error\n+        })\n+      }\n+    }\n+\n+    // è¾“å‡ºæµ‹è¯•ç»“æœæ±‡æ€»\n+    console.log('\\n' + '=' .repeat(60))\n+    const healthyServers = serverResults.filter(s => s.healthy)\n+    console.log(`ğŸ“Š æœåŠ¡å™¨è¿æ¥æµ‹è¯•å®Œæˆ: ${healthyServers.length}/${serverResults.length} ä¸ªæœåŠ¡å™¨å¯ç”¨`)\n+\n+    // è¯¦ç»†çš„æœåŠ¡å™¨çŠ¶æ€è¡¨æ ¼\n+    console.log('\\nğŸ“‹ æœåŠ¡å™¨çŠ¶æ€æ±‡æ€»:')\n+    console.log('   çŠ¶æ€ | ç±»å‹     | æœåŠ¡å™¨URL                    | é˜Ÿåˆ—(è¿è¡Œ/ç­‰å¾…/æ€»è®¡) | å“åº”æ—¶é—´')\n+    console.log('   -----|----------|------------------------------|---------------------|----------')\n+\n+    serverResults.forEach(server => {\n+      const status = server.healthy ? 'âœ…' : 'âŒ'\n+      const type = server.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨    '\n+      const url = server.url.length > 28 ? server.url.substring(0, 25) + '...' : server.url.padEnd(28)\n+      const queueInfo = server.queue ?\n+        `${(server.queue.running || 0).toString().padStart(2)}/${(server.queue.pending || 0).toString().padStart(2)}/${(server.queue.total || 0).toString().padStart(2)}`.padEnd(19) :\n+        'N/A'.padEnd(19)\n+      const responseTime = server.responseTime ? `${server.responseTime}ms` : 'N/A'\n+\n+      console.log(`   ${status} | ${type} | ${url} | ${queueInfo} | ${responseTime}`)\n+    })\n+\n+    // é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n+    if (healthyServers.length > 0) {\n+      const bestServer = healthyServers.sort((a, b) => {\n+        const queueDiff = (a.queue?.total || 0) - (b.queue?.total || 0)\n+        if (queueDiff !== 0) return queueDiff\n+        return a.priority - b.priority\n+      })[0]\n+\n+      console.log('\\nğŸ¯ æœ€ä¼˜æœåŠ¡å™¨é€‰æ‹©ç»“æœ:')\n+      console.log(`   é€‰æ‹©æœåŠ¡å™¨: ${bestServer.url}`)\n+      console.log(`   é€‰æ‹©åŸå› : ${bestServer.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨æœåŠ¡å™¨'} | é˜Ÿåˆ—æœ€å°‘ (${bestServer.queue?.total || 0} ä¸ªä»»åŠ¡)`)\n+      console.log(`   é˜Ÿåˆ—è¯¦æƒ…: è¿è¡Œä¸­ ${bestServer.queue?.running || 0} | ç­‰å¾…ä¸­ ${bestServer.queue?.pending || 0}`)\n+      console.log(`   å“åº”æ—¶é—´: ${bestServer.responseTime}ms`)\n+      console.log(`   ä¼˜å…ˆçº§: ${bestServer.priority}`)\n+\n+      console.log('\\nâœ… æœåŠ¡å™¨åˆå§‹åŒ–å®Œæˆï¼Œç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼')\n+      console.log('=' .repeat(60))\n+\n+      return bestServer.url\n+    } else {\n+      console.log('\\nâŒ æœåŠ¡å™¨é€‰æ‹©ç»“æœ: æ‰€æœ‰æœåŠ¡å™¨éƒ½ä¸å¯ç”¨')\n+      console.log('ğŸ’¡ å»ºè®®: è¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®æˆ–ç½‘ç»œè¿æ¥')\n+      console.log('=' .repeat(60))\n+      return null\n+    }\n+  }\n+\n+  /**\n+   * é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨ï¼ˆç”¨äºç”Ÿå›¾è¯·æ±‚ï¼‰\n+   */\n+  async getOptimalServer() {\n     try {\n       console.log('ğŸš€ æ­£åœ¨åˆå§‹åŒ– ComfyUI æœåŠ¡å™¨è¿æ¥...')\n       console.log('=' .repeat(60))\n \n"
                },
                {
                    "date": 1752518407239,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -258,14 +258,11 @@\n   /**\n    * é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨ï¼ˆç”¨äºç”Ÿå›¾è¯·æ±‚ï¼‰\n    */\n   async getOptimalServer() {\n-    try {\n-      console.log('ğŸš€ æ­£åœ¨åˆå§‹åŒ– ComfyUI æœåŠ¡å™¨è¿æ¥...')\n-      console.log('=' .repeat(60))\n+    console.log('ğŸ¯ é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨ (ç”¨äºç”Ÿå›¾è¯·æ±‚)...')\n \n-      // è·å–æœåŠ¡å™¨åˆ—è¡¨\n-      const servers = await this.getLatestServerList()\n+    const servers = await this.getServerList()\n \n       if (servers.length === 0) {\n         console.warn('âš ï¸ æœªæ‰¾åˆ°ä»»ä½•é…ç½®çš„æœåŠ¡å™¨')\n         return null\n"
                },
                {
                    "date": 1752518430963,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -262,39 +262,54 @@\n     console.log('ğŸ¯ é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨ (ç”¨äºç”Ÿå›¾è¯·æ±‚)...')\n \n     const servers = await this.getServerList()\n \n-      if (servers.length === 0) {\n-        console.warn('âš ï¸ æœªæ‰¾åˆ°ä»»ä½•é…ç½®çš„æœåŠ¡å™¨')\n-        return null\n+    if (servers.length === 0) {\n+      throw new Error('æ²¡æœ‰å¯ç”¨çš„æœåŠ¡å™¨é…ç½®')\n+    }\n+\n+    const serverResults = []\n+\n+    for (const server of servers) {\n+      // ç›´æ¥è¿æ¥æµ‹è¯•\n+      const healthResult = await this.testDirectConnection(server.url)\n+\n+      if (healthResult.healthy) {\n+        // è·å–é˜Ÿåˆ—ä¿¡æ¯\n+        const queueResult = await this.getQueueInfo(server.url)\n+\n+        serverResults.push({\n+          ...server,\n+          healthy: true,\n+          responseTime: healthResult.responseTime,\n+          queue: queueResult\n+        })\n+      } else {\n+        serverResults.push({\n+          ...server,\n+          healthy: false,\n+          error: healthResult.error\n+        })\n       }\n+    }\n \n-      console.log(`ğŸ“‹ å‘ç° ${servers.length} ä¸ªé…ç½®çš„æœåŠ¡å™¨:`)\n-      servers.forEach((server, index) => {\n-        console.log(`   ${index + 1}. ${server.url} (${server.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨æœåŠ¡å™¨'}, ä¼˜å…ˆçº§: ${server.priority})`)\n-      })\n-      console.log('')\n+    const healthyServers = serverResults.filter(s => s.healthy)\n \n-      console.log('ğŸ” å¼€å§‹æœåŠ¡å™¨è¿æ¥å’Œé˜Ÿåˆ—æµ‹è¯•...')\n-      console.log('-' .repeat(60))\n+    if (healthyServers.length === 0) {\n+      console.warn('âš ï¸ æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨')\n+      return servers[0]?.url || null\n+    }\n \n-      // æµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨\n-      const serverChecks = servers.map(async (server) => {\n-        console.log(`\\nğŸ–¥ï¸  æµ‹è¯•æœåŠ¡å™¨: ${server.url}`)\n-        console.log(`   ç±»å‹: ${server.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨æœåŠ¡å™¨'} | ä¼˜å…ˆçº§: ${server.priority}`)\n+    const bestServer = healthyServers.sort((a, b) => {\n+      const queueDiff = (a.queue?.total || 0) - (b.queue?.total || 0)\n+      if (queueDiff !== 0) return queueDiff\n+      return a.priority - b.priority\n+    })[0]\n \n-        try {\n-          const [healthResult, queueResult] = await Promise.allSettled([\n-            this.checkServerHealth(server.url),\n-            this.getServerQueueInfo(server.url)\n-          ])\n+    console.log(`ğŸ¯ é€‰æ‹©æœåŠ¡å™¨: ${bestServer.url} (é˜Ÿåˆ—: ${bestServer.queue?.total || 0}, å“åº”æ—¶é—´: ${bestServer.responseTime}ms)`)\n \n-          const health = healthResult.status === 'fulfilled' ? healthResult.value : { healthy: false }\n-          const queue = queueResult.status === 'fulfilled' ? queueResult.value : { total: 999, healthy: false }\n+    return bestServer.url\n \n-          // å¥åº·åˆ¤æ–­ï¼šåªæœ‰æ˜ç¡®è¿”å› healthy: true æ‰è®¤ä¸ºå¥åº·\n-          const isHealthy = health.healthy === true\n-\n           // è¯¦ç»†è¾“å‡ºæµ‹è¯•ç»“æœ\n           if (isHealthy) {\n             console.log(`   âœ… å¥åº·æ£€æŸ¥: é€šè¿‡ (${health.responseTime}ms)`)\n             if (health.endpoint) {\n"
                },
                {
                    "date": 1752518778222,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -307,336 +307,11 @@\n \n     console.log(`ğŸ¯ é€‰æ‹©æœåŠ¡å™¨: ${bestServer.url} (é˜Ÿåˆ—: ${bestServer.queue?.total || 0}, å“åº”æ—¶é—´: ${bestServer.responseTime}ms)`)\n \n     return bestServer.url\n-\n-          // è¯¦ç»†è¾“å‡ºæµ‹è¯•ç»“æœ\n-          if (isHealthy) {\n-            console.log(`   âœ… å¥åº·æ£€æŸ¥: é€šè¿‡ (${health.responseTime}ms)`)\n-            if (health.endpoint) {\n-              console.log(`   ğŸ”— å¯ç”¨ç«¯ç‚¹: ${health.endpoint}`)\n-            }\n-          } else {\n-            console.log(`   âŒ å¥åº·æ£€æŸ¥: å¤±è´¥ (${health.error || 'è¿æ¥å¤±è´¥'})`)\n-          }\n-\n-          // é˜Ÿåˆ—ä¿¡æ¯è¯¦ç»†è¾“å‡º\n-          if (queue.healthy) {\n-            console.log(`   ğŸ“Š é˜Ÿåˆ—ä¿¡æ¯: è¿è¡Œä¸­ ${queue.running || 0} | ç­‰å¾…ä¸­ ${queue.pending || 0} | æ€»è®¡ ${queue.total || 0}`)\n-            if (queue.isEstimate) {\n-              console.log(`   âš ï¸  é˜Ÿåˆ—æ•°æ®ä¸ºä¼°ç®—å€¼`)\n-            }\n-          } else {\n-            console.log(`   âŒ é˜Ÿåˆ—ä¿¡æ¯: è·å–å¤±è´¥ (${queue.error || 'è¿æ¥å¤±è´¥'})`)\n-          }\n-\n-          // æœåŠ¡å™¨çŠ¶æ€æ€»ç»“\n-          if (isHealthy) {\n-            const queueStatus = queue.total === 0 ? 'ğŸŸ¢ ç©ºé—²' :\n-                              queue.running > 0 ? 'ğŸŸ¡ ç¹å¿™' : 'ğŸ”´ é˜Ÿåˆ—æ»¡'\n-            console.log(`   ğŸ“ˆ æœåŠ¡å™¨çŠ¶æ€: ${queueStatus}`)\n-          } else {\n-            console.log(`   ğŸ“ˆ æœåŠ¡å™¨çŠ¶æ€: ğŸ”´ ä¸å¯ç”¨`)\n-          }\n-\n-          return {\n-            ...server,\n-            healthy: isHealthy,\n-            queue: queue,\n-            responseTime: health.responseTime || 0,\n-            error: health.error,\n-            healthCheckEndpoint: health.endpoint\n-          }\n-        } catch (error) {\n-          console.log(`   âŒ æµ‹è¯•å¤±è´¥: ${error.message}`)\n-          return {\n-            ...server,\n-            healthy: false,\n-            queue: { total: 999, healthy: false },\n-            responseTime: 0,\n-            error: error.message\n-          }\n-        }\n-      })\n-\n-      const serverResults = await Promise.all(serverChecks)\n-\n-      // è¾“å‡ºæµ‹è¯•ç»“æœæ±‡æ€»\n-      console.log('\\n' + '=' .repeat(60))\n-      const healthyServers = serverResults.filter(s => s.healthy)\n-      console.log(`ğŸ“Š æœåŠ¡å™¨è¿æ¥æµ‹è¯•å®Œæˆ: ${healthyServers.length}/${serverResults.length} ä¸ªæœåŠ¡å™¨å¯ç”¨`)\n-\n-      // è¯¦ç»†çš„æœåŠ¡å™¨çŠ¶æ€è¡¨æ ¼\n-      console.log('\\nğŸ“‹ æœåŠ¡å™¨çŠ¶æ€æ±‡æ€»:')\n-      console.log('   çŠ¶æ€ | ç±»å‹     | æœåŠ¡å™¨URL                    | é˜Ÿåˆ—(è¿è¡Œ/ç­‰å¾…/æ€»è®¡) | å“åº”æ—¶é—´')\n-      console.log('   -----|----------|------------------------------|---------------------|----------')\n-\n-      serverResults.forEach(server => {\n-        const status = server.healthy ? 'âœ…' : 'âŒ'\n-        const type = server.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨    '\n-        const url = server.url.length > 28 ? server.url.substring(0, 25) + '...' : server.url.padEnd(28)\n-        const queueInfo = server.queue ?\n-          `${(server.queue.running || 0).toString().padStart(2)}/${(server.queue.pending || 0).toString().padStart(2)}/${(server.queue.total || 0).toString().padStart(2)}`.padEnd(19) :\n-          'N/A'.padEnd(19)\n-        const responseTime = server.responseTime ? `${server.responseTime}ms` : 'N/A'\n-\n-        console.log(`   ${status} | ${type} | ${url} | ${queueInfo} | ${responseTime}`)\n-      })\n-\n-      // é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n-      if (healthyServers.length > 0) {\n-        const bestServer = healthyServers.sort((a, b) => {\n-          const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n-          if (queueDiff !== 0) return queueDiff\n-          return a.priority - b.priority\n-        })[0]\n-\n-        console.log('\\nğŸ¯ æœ€ä¼˜æœåŠ¡å™¨é€‰æ‹©ç»“æœ:')\n-        console.log(`   é€‰æ‹©æœåŠ¡å™¨: ${bestServer.url}`)\n-        console.log(`   é€‰æ‹©åŸå› : ${bestServer.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨æœåŠ¡å™¨'} | é˜Ÿåˆ—æœ€å°‘ (${bestServer.queue.total || 0} ä¸ªä»»åŠ¡)`)\n-        console.log(`   é˜Ÿåˆ—è¯¦æƒ…: è¿è¡Œä¸­ ${bestServer.queue.running || 0} | ç­‰å¾…ä¸­ ${bestServer.queue.pending || 0}`)\n-        console.log(`   å“åº”æ—¶é—´: ${bestServer.responseTime}ms`)\n-        console.log(`   ä¼˜å…ˆçº§: ${bestServer.priority}`)\n-\n-        console.log('\\nâœ… æœåŠ¡å™¨åˆå§‹åŒ–å®Œæˆï¼Œç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼')\n-        console.log('=' .repeat(60))\n-\n-        return bestServer.url\n-      } else {\n-        console.log('\\nâŒ æœåŠ¡å™¨é€‰æ‹©ç»“æœ: æ‰€æœ‰æœåŠ¡å™¨éƒ½ä¸å¯ç”¨')\n-        console.log('ğŸ’¡ å»ºè®®: è¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®æˆ–ç½‘ç»œè¿æ¥')\n-        console.log('=' .repeat(60))\n-        return null\n-      }\n-\n-    } catch (error) {\n-      console.error('\\nâŒ æœåŠ¡å™¨åˆå§‹åŒ–å¤±è´¥:', error)\n-      console.log('=' .repeat(60))\n-      return null\n-    }\n   }\n-\n-  /**\n-   * é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨ï¼ˆä¸»è¦æ¥å£ï¼‰\n-   * åªåœ¨ç”¨æˆ·å‘èµ·ç”Ÿå›¾è¯·æ±‚æ—¶è°ƒç”¨\n-   */\n-  async getOptimalServer() {\n-    try {\n-      console.log('ğŸ¯ é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨ (ç”¨äºç”Ÿå›¾è¯·æ±‚)...')\n-\n-      // 1. è·å–æœ€æ–°çš„æœåŠ¡å™¨åˆ—è¡¨\n-      const servers = await this.getLatestServerList()\n-\n-      if (servers.length === 0) {\n-        throw new Error('æ²¡æœ‰å¯ç”¨çš„æœåŠ¡å™¨é…ç½®')\n-      }\n-\n-      // 2. å¹¶è¡Œæ£€æŸ¥æ‰€æœ‰æœåŠ¡å™¨çš„å¥åº·çŠ¶æ€å’Œé˜Ÿåˆ—ä¿¡æ¯\n-      const serverChecks = servers.map(async (server) => {\n-        try {\n-          const [healthResult, queueResult] = await Promise.allSettled([\n-            this.checkServerHealth(server.url),\n-            this.getServerQueueInfo(server.url)\n-          ])\n-\n-          const health = healthResult.status === 'fulfilled' ? healthResult.value : { healthy: false }\n-          const queue = queueResult.status === 'fulfilled' ? queueResult.value : { total: 999, healthy: false }\n-\n-          // å¥åº·åˆ¤æ–­ï¼šåªæœ‰æ˜ç¡®è¿”å› healthy: true æ‰è®¤ä¸ºå¥åº·\n-          const isHealthy = health.healthy === true\n-\n-          return {\n-            ...server,\n-            healthy: isHealthy,\n-            queue: queue,\n-            responseTime: health.responseTime || 0,\n-            error: health.error,\n-            healthCheckEndpoint: health.endpoint\n-          }\n-        } catch (error) {\n-          return {\n-            ...server,\n-            healthy: false,\n-            queue: { total: 999, healthy: false },\n-            responseTime: 0,\n-            error: error.message\n-          }\n-        }\n-      })\n-\n-      const serverResults = await Promise.all(serverChecks)\n-\n-      // 3. è¿‡æ»¤å¥åº·çš„æœåŠ¡å™¨å¹¶æŒ‰é˜Ÿåˆ—é•¿åº¦æ’åº\n-      const healthyServers = serverResults\n-        .filter(server => server.healthy)\n-        .sort((a, b) => {\n-          // æŒ‰é˜Ÿåˆ—æ•°é‡æ’åº\n-          const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n-          if (queueDiff !== 0) return queueDiff\n-\n-          // å¦‚æœé˜Ÿåˆ—ç›¸åŒï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº\n-          return a.priority - b.priority\n-        })\n-\n-      // 4. é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n-      if (healthyServers.length === 0) {\n-        console.warn('âš ï¸ æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨å“åº”æœ€å¿«çš„æœåŠ¡å™¨')\n-\n-        // å¦‚æœæ²¡æœ‰å¥åº·æœåŠ¡å™¨ï¼Œé€‰æ‹©å“åº”æ—¶é—´æœ€å¿«çš„\n-        const fastestServer = serverResults\n-          .filter(server => server.responseTime > 0)\n-          .sort((a, b) => a.responseTime - b.responseTime)[0]\n-\n-        if (fastestServer) {\n-          console.log(`ğŸ†˜ é€‰æ‹©å“åº”æœ€å¿«çš„æœåŠ¡å™¨: ${fastestServer.url} (${fastestServer.responseTime}ms)`)\n-          return fastestServer.url\n-        }\n-\n-        // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼šè¿”å›ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨\n-        console.log(`ğŸ†˜ ä½¿ç”¨ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨: ${servers[0].url}`)\n-        return servers[0].url\n-      }\n-\n-      const selectedServer = healthyServers[0]\n-      console.log(`ğŸ¯ é€‰æ‹©æœåŠ¡å™¨: ${selectedServer.url} (é˜Ÿåˆ—: ${selectedServer.queue.total || 0}, å“åº”æ—¶é—´: ${selectedServer.responseTime}ms)`)\n-\n-      return selectedServer.url\n-\n-    } catch (error) {\n-      console.error('âŒ æœåŠ¡å™¨é€‰æ‹©å¤±è´¥:', error)\n-\n-      // é”™è¯¯æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ\n-      try {\n-        const config = await configService.getConfig()\n-        const fallbackUrl = config['comfyui.server_url'] || 'https://your-comfyui-server.com'\n-        console.log(`ğŸ†˜ ä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨: ${fallbackUrl}`)\n-        return fallbackUrl\n-      } catch (configError) {\n-        console.error('âŒ è·å–å¤‡ç”¨æœåŠ¡å™¨é…ç½®å¤±è´¥:', configError)\n-        return 'https://your-comfyui-server.com'\n-      }\n-    }\n-  }\n-\n-  /**\n-   * é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æœåŠ¡å™¨è¿æ¥æµ‹è¯•\n-   * æä¾›è¯¦ç»†çš„æœåŠ¡å™¨çŠ¶æ€åé¦ˆ\n-   */\n-  async initializeServerConnection() {\n-    try {\n-      console.log('ğŸš€ æ­£åœ¨åˆå§‹åŒ– ComfyUI æœåŠ¡å™¨è¿æ¥...')\n-\n-      // è·å–æœåŠ¡å™¨åˆ—è¡¨\n-      const servers = await this.getLatestServerList()\n-\n-      if (servers.length === 0) {\n-        console.warn('âš ï¸ æœªæ‰¾åˆ°ä»»ä½•é…ç½®çš„æœåŠ¡å™¨')\n-        return null\n-      }\n-\n-      console.log(`ğŸ“‹ å‘ç° ${servers.length} ä¸ªé…ç½®çš„æœåŠ¡å™¨ï¼Œå¼€å§‹è¿æ¥æµ‹è¯•...`)\n-\n-      // æµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨\n-      const serverChecks = servers.map(async (server) => {\n-        console.log(`ğŸ” æµ‹è¯•æœåŠ¡å™¨: ${server.url}`)\n-\n-        try {\n-          const [healthResult, queueResult] = await Promise.allSettled([\n-            this.checkServerHealth(server.url),\n-            this.getServerQueueInfo(server.url)\n-          ])\n-\n-          const health = healthResult.status === 'fulfilled' ? healthResult.value : { healthy: false }\n-          const queue = queueResult.status === 'fulfilled' ? queueResult.value : {\n-            total: 1,\n-            running: 0,\n-            pending: 0,\n-            healthy: true,\n-            isEstimate: true\n-          }\n-\n-          // æœåŠ¡å™¨å¥åº·çŠ¶æ€ä¸»è¦åŸºäºå¥åº·æ£€æŸ¥ç»“æœ\n-          const isHealthy = health.healthy\n-\n-          // å¦‚æœé˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥ä½†æœåŠ¡å™¨å¥åº·ï¼Œç»™å‡ºè­¦å‘Šä½†ä¸å½±å“é€‰æ‹©\n-          if (isHealthy && queue.isEstimate) {\n-            console.warn(`âš ï¸ ${server.url} å¥åº·ä½†é˜Ÿåˆ—ä¿¡æ¯ä¸å¯ç”¨ï¼Œä½¿ç”¨ä¼°ç®—å€¼`)\n-          }\n-\n-          return {\n-            ...server,\n-            healthy: isHealthy,\n-            queue: queue,\n-            responseTime: health.responseTime || 0,\n-            error: health.error,\n-            healthCheckEndpoint: health.endpoint\n-          }\n-        } catch (error) {\n-          return {\n-            ...server,\n-            healthy: false,\n-            queue: { total: 999, healthy: false },\n-            responseTime: 0,\n-            error: error.message\n-          }\n-        }\n-      })\n-\n-      const serverResults = await Promise.all(serverChecks)\n-\n-      // è¾“å‡ºæµ‹è¯•ç»“æœ\n-      const healthyServers = serverResults.filter(s => s.healthy)\n-      console.log(`âœ… æœåŠ¡å™¨è¿æ¥æµ‹è¯•å®Œæˆ: ${healthyServers.length}/${serverResults.length} ä¸ªæœåŠ¡å™¨å¯ç”¨`)\n-\n-      // é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n-      if (healthyServers.length > 0) {\n-        const bestServer = healthyServers.sort((a, b) => {\n-          const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n-          if (queueDiff !== 0) return queueDiff\n-          return a.priority - b.priority\n-        })[0]\n-\n-        console.log(`ğŸ¯ æ¨èæœåŠ¡å™¨: ${bestServer.url}`)\n-        console.log(`   é˜Ÿåˆ—çŠ¶æ€: ${bestServer.queue.total || 0} ä¸ªä»»åŠ¡ (è¿è¡Œä¸­: ${bestServer.queue.running || 0}, ç­‰å¾…ä¸­: ${bestServer.queue.pending || 0})`)\n-        console.log(`   å“åº”æ—¶é—´: ${bestServer.responseTime}ms`)\n-\n-        return bestServer.url\n-      } else {\n-        console.warn('âŒ æ‰€æœ‰æœåŠ¡å™¨éƒ½ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®')\n-        return null\n-      }\n-\n-    } catch (error) {\n-      console.error('âŒ æœåŠ¡å™¨åˆå§‹åŒ–å¤±è´¥:', error)\n-      return null\n-    }\n-  }\n-\n-  /**\n-   * è®°å½•æœåŠ¡å™¨çŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•ï¼‰\n-   */\n-  logServerStatus(servers) {\n-    console.log('ğŸ“Š è¯¦ç»†æœåŠ¡å™¨çŠ¶æ€æŠ¥å‘Š:')\n-    console.log('   çŠ¶æ€ | ç±»å‹ | æœåŠ¡å™¨URL | é˜Ÿåˆ—(è¿è¡Œ/ç­‰å¾…/æ€»è®¡) | ä¼˜å…ˆçº§ | å“åº”æ—¶é—´ | é”™è¯¯ä¿¡æ¯')\n-    console.log('   -----|------|-----------|-------------------|--------|----------|----------')\n-\n-    servers.forEach(server => {\n-      const status = server.healthy ? 'âœ…' : 'âŒ'\n-      const type = server.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨'\n-      const queueInfo = server.queue ?\n-        `${server.queue.running || 0}/${server.queue.pending || 0}/${server.queue.total || 0}` :\n-        'N/A'\n-      const priority = server.priority || 'N/A'\n-      const responseTime = server.responseTime ? `${server.responseTime}ms` : 'N/A'\n-      const error = server.error ? server.error.substring(0, 20) + '...' : ''\n-\n-      console.log(`   ${status} | ${type} | ${server.url} | ${queueInfo} | ${priority} | ${responseTime} | ${error}`)\n-    })\n-\n-    console.log('') // ç©ºè¡Œåˆ†éš”\n-  }\n }\n \n // åˆ›å»ºå•ä¾‹å®ä¾‹\n-const loadBalancer = new ComfyUILoadBalancer()\n+const loadBalancer = new LoadBalancer()\n \n export default loadBalancer\n"
                },
                {
                    "date": 1752520085551,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -89,24 +89,69 @@\n     }\n   }\n \n   /**\n-   * è·å–é˜Ÿåˆ—ä¿¡æ¯\n+   * æ£€æµ‹æœåŠ¡å™¨APIå‰ç¼€\n    */\n+  async detectApiPrefix(serverUrl) {\n+    const testEndpoints = ['/api/queue', '/queue']\n+\n+    for (const endpoint of testEndpoints) {\n+      try {\n+        const controller = new AbortController()\n+        const timeoutId = setTimeout(() => controller.abort(), 3000)\n+\n+        const response = await fetch(`${serverUrl.replace(/\\/$/, '')}${endpoint}`, {\n+          method: 'GET',\n+          signal: controller.signal,\n+          headers: {\n+            'Accept': '*/*',\n+            'comfy-user': 'prefix-detector'\n+          },\n+          mode: 'cors',\n+          credentials: 'omit'\n+        })\n+\n+        clearTimeout(timeoutId)\n+\n+        if (response.ok) {\n+          const apiPrefix = endpoint.startsWith('/api/') ? '/api' : ''\n+          console.log(`ğŸ” æ£€æµ‹åˆ°APIå‰ç¼€: ${apiPrefix || '(æ— å‰ç¼€)'}`)\n+          return apiPrefix\n+        }\n+      } catch (error) {\n+        // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªç«¯ç‚¹\n+        continue\n+      }\n+    }\n+\n+    console.log('ğŸ” æ— æ³•æ£€æµ‹APIå‰ç¼€ï¼Œä½¿ç”¨é»˜è®¤')\n+    return '' // é»˜è®¤æ— å‰ç¼€\n+  }\n+\n+  /**\n+   * è·å–é˜Ÿåˆ—ä¿¡æ¯ - æ”¯æŒAPIå‰ç¼€è‡ªåŠ¨æ£€æµ‹\n+   */\n   async getQueueInfo(serverUrl) {\n     try {\n+      // æ£€æµ‹APIå‰ç¼€\n+      const apiPrefix = await this.detectApiPrefix(serverUrl)\n+\n       const controller = new AbortController()\n       const timeoutId = setTimeout(() => controller.abort(), this.connectionTimeout)\n \n-      const response = await fetch(`${serverUrl}/api/queue`, {\n+      const queueUrl = `${serverUrl.replace(/\\/$/, '')}${apiPrefix}/queue`\n+      const response = await fetch(queueUrl, {\n         method: 'GET',\n         signal: controller.signal,\n         headers: {\n           'Accept': '*/*',\n           'Cache-Control': 'max-age=0',\n           'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',\n           'comfy-user': 'loadbalancer-client'\n-        }\n+        },\n+        mode: 'cors',\n+        credentials: 'omit'\n       })\n \n       clearTimeout(timeoutId)\n \n@@ -121,9 +166,16 @@\n           pending = Array.isArray(data.queue_pending) ? data.queue_pending.length : data.queue_pending\n           total = running + pending\n         }\n \n-        return { running, pending, total, success: true }\n+        return {\n+          running,\n+          pending,\n+          total,\n+          success: true,\n+          apiPrefix,\n+          endpoint: queueUrl\n+        }\n       } else {\n         return { running: 0, pending: 0, total: 1, success: false, error: `HTTP ${response.status}` }\n       }\n \n"
                },
                {
                    "date": 1752520105099,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -223,8 +223,9 @@\n         const queueResult = await this.getQueueInfo(server.url)\n \n         if (queueResult.success) {\n           console.log(`   ğŸ“Š é˜Ÿåˆ—ä¿¡æ¯: è¿è¡Œä¸­ ${queueResult.running} | ç­‰å¾…ä¸­ ${queueResult.pending} | æ€»è®¡ ${queueResult.total}`)\n+          console.log(`   ğŸ”— é˜Ÿåˆ—ç«¯ç‚¹: ${queueResult.endpoint}`)\n \n           const queueStatus = queueResult.total === 0 ? 'ğŸŸ¢ ç©ºé—²' :\n                             queueResult.running > 0 ? 'ğŸŸ¡ ç¹å¿™' : 'ğŸ”´ é˜Ÿåˆ—æ»¡'\n           console.log(`   ğŸ“ˆ æœåŠ¡å™¨çŠ¶æ€: ${queueStatus}`)\n"
                },
                {
                    "date": 1752520832460,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,11 +1,11 @@\n /**\n- * ComfyUI è´Ÿè½½å‡è¡¡å™¨ - é‡å†™ç‰ˆæœ¬\n- * ä½¿ç”¨ç›´æ¥è¿æ¥æµ‹è¯•ä½œä¸ºå¥åº·åˆ¤æ–­æ ‡å‡†\n+ * ComfyUI è´Ÿè½½å‡è¡¡å™¨ - å®Œå…¨é‡å†™ç‰ˆæœ¬\n+ * ç®€å•ç›´æ¥çš„é€»è¾‘ï¼šé€‰æ‹©å¯ç›´è¿ä¸”é˜Ÿåˆ—æœ€å°‘çš„æœåŠ¡å™¨\n  */\n class LoadBalancer {\n   constructor() {\n-    this.connectionTimeout = 10000 // 10ç§’è¿æ¥è¶…æ—¶\n+    this.connectionTimeout = 8000 // 8ç§’è¿æ¥è¶…æ—¶\n   }\n \n   /**\n    * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n@@ -15,41 +15,31 @@\n     return true\n   }\n \n   /**\n-   * è·å–æœåŠ¡å™¨åˆ—è¡¨\n+   * è·å–æ‰€æœ‰é…ç½®çš„æœåŠ¡å™¨åˆ—è¡¨\n    */\n   async getServerList() {\n     const servers = []\n \n     // ä¸»æœåŠ¡å™¨\n     const primaryServer = window.getConfig?.('comfyui.server_url')\n     if (primaryServer && primaryServer.trim()) {\n-      servers.push({\n-        url: primaryServer.trim(),\n-        type: 'primary',\n-        priority: 1\n-      })\n+      servers.push(primaryServer.trim())\n     }\n \n-    // å¤‡ç”¨æœåŠ¡å™¨\n+    // å¤‡ç”¨æœåŠ¡å™¨ï¼ˆæ¢è¡Œç¬¦åˆ†éš”ï¼‰\n     const backupServersConfig = window.getConfig?.('comfyui.backup_servers')\n     if (backupServersConfig && backupServersConfig.trim()) {\n       const backupServers = backupServersConfig\n-        .replace(/\\s*,\\s*/g, '\\n')\n         .split('\\n')\n         .map(url => url.trim())\n         .filter(url => url && url.startsWith('http'))\n \n-      backupServers.forEach((url, index) => {\n-        servers.push({\n-          url,\n-          type: 'backup',\n-          priority: index + 2\n-        })\n-      })\n+      servers.push(...backupServers)\n     }\n \n+    console.log(`ğŸ“‹ é…ç½®çš„æœåŠ¡å™¨åˆ—è¡¨ (${servers.length}ä¸ª):`, servers)\n     return servers\n   }\n \n   /**\n"
                },
                {
                    "date": 1752520851796,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -42,12 +42,14 @@\n     return servers\n   }\n \n   /**\n-   * ç›´æ¥è¿æ¥æµ‹è¯• - ç®€å•æœ‰æ•ˆçš„å¥åº·æ£€æŸ¥\n+   * æµ‹è¯•æœåŠ¡å™¨æ˜¯å¦å¯ç›´è¿\n    */\n-  async testDirectConnection(serverUrl) {\n+  async testConnection(serverUrl) {\n     try {\n+      console.log(`ğŸ” æµ‹è¯•è¿æ¥: ${serverUrl}`)\n+\n       const controller = new AbortController()\n       const timeoutId = setTimeout(() => controller.abort(), this.connectionTimeout)\n \n       const startTime = Date.now()\n@@ -62,19 +64,19 @@\n \n       clearTimeout(timeoutId)\n       const responseTime = Date.now() - startTime\n \n-      // åªè¦èƒ½è¿æ¥å°±è®¤ä¸ºå¥åº·ï¼Œä¸ç®¡è¿”å›ä»€ä¹ˆçŠ¶æ€ç \n+      console.log(`âœ… è¿æ¥æˆåŠŸ: ${serverUrl} (${responseTime}ms, çŠ¶æ€: ${response.status})`)\n       return {\n-        healthy: true,\n+        success: true,\n         responseTime,\n         status: response.status\n       }\n \n     } catch (error) {\n-      // åªæœ‰çœŸæ­£çš„è¿æ¥å¤±è´¥æ‰è®¤ä¸ºä¸å¥åº·\n+      console.log(`âŒ è¿æ¥å¤±è´¥: ${serverUrl} - ${error.message}`)\n       return {\n-        healthy: false,\n+        success: false,\n         error: error.message\n       }\n     }\n   }\n"
                },
                {
                    "date": 1752520880792,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -81,99 +81,66 @@\n     }\n   }\n \n   /**\n-   * æ£€æµ‹æœåŠ¡å™¨APIå‰ç¼€\n+   * è·å–æœåŠ¡å™¨é˜Ÿåˆ—ä¿¡æ¯\n    */\n-  async detectApiPrefix(serverUrl) {\n-    const testEndpoints = ['/api/queue', '/queue']\n+  async getQueueInfo(serverUrl) {\n+    // å°è¯•ä¸¤ç§å¯èƒ½çš„ç«¯ç‚¹\n+    const endpoints = ['/api/queue', '/queue']\n \n-    for (const endpoint of testEndpoints) {\n+    for (const endpoint of endpoints) {\n       try {\n+        console.log(`ğŸ“Š è·å–é˜Ÿåˆ—ä¿¡æ¯: ${serverUrl}${endpoint}`)\n+\n         const controller = new AbortController()\n-        const timeoutId = setTimeout(() => controller.abort(), 3000)\n+        const timeoutId = setTimeout(() => controller.abort(), this.connectionTimeout)\n \n-        const response = await fetch(`${serverUrl.replace(/\\/$/, '')}${endpoint}`, {\n+        const response = await fetch(`${serverUrl}${endpoint}`, {\n           method: 'GET',\n           signal: controller.signal,\n           headers: {\n             'Accept': '*/*',\n-            'comfy-user': 'prefix-detector'\n-          },\n-          mode: 'cors',\n-          credentials: 'omit'\n+            'comfy-user': 'loadbalancer-client'\n+          }\n         })\n \n         clearTimeout(timeoutId)\n \n         if (response.ok) {\n-          const apiPrefix = endpoint.startsWith('/api/') ? '/api' : ''\n-          console.log(`ğŸ” æ£€æµ‹åˆ°APIå‰ç¼€: ${apiPrefix || '(æ— å‰ç¼€)'}`)\n-          return apiPrefix\n+          const data = await response.json()\n+\n+          // è§£æé˜Ÿåˆ—æ•°æ®\n+          let running = 0, pending = 0, total = 0\n+\n+          if (data.queue_running !== undefined && data.queue_pending !== undefined) {\n+            running = Array.isArray(data.queue_running) ? data.queue_running.length : data.queue_running\n+            pending = Array.isArray(data.queue_pending) ? data.queue_pending.length : data.queue_pending\n+            total = running + pending\n+          }\n+\n+          console.log(`âœ… é˜Ÿåˆ—ä¿¡æ¯è·å–æˆåŠŸ: ${serverUrl}${endpoint} - è¿è¡Œ:${running}, ç­‰å¾…:${pending}, æ€»è®¡:${total}`)\n+          return {\n+            running,\n+            pending,\n+            total,\n+            success: true,\n+            endpoint: `${serverUrl}${endpoint}`\n+          }\n         }\n       } catch (error) {\n-        // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªç«¯ç‚¹\n+        console.log(`âŒ é˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥: ${serverUrl}${endpoint} - ${error.message}`)\n         continue\n       }\n     }\n \n-    console.log('ğŸ” æ— æ³•æ£€æµ‹APIå‰ç¼€ï¼Œä½¿ç”¨é»˜è®¤')\n-    return '' // é»˜è®¤æ— å‰ç¼€\n-  }\n-\n-  /**\n-   * è·å–é˜Ÿåˆ—ä¿¡æ¯ - æ”¯æŒAPIå‰ç¼€è‡ªåŠ¨æ£€æµ‹\n-   */\n-  async getQueueInfo(serverUrl) {\n-    try {\n-      // æ£€æµ‹APIå‰ç¼€\n-      const apiPrefix = await this.detectApiPrefix(serverUrl)\n-\n-      const controller = new AbortController()\n-      const timeoutId = setTimeout(() => controller.abort(), this.connectionTimeout)\n-\n-      const queueUrl = `${serverUrl.replace(/\\/$/, '')}${apiPrefix}/queue`\n-      const response = await fetch(queueUrl, {\n-        method: 'GET',\n-        signal: controller.signal,\n-        headers: {\n-          'Accept': '*/*',\n-          'Cache-Control': 'max-age=0',\n-          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',\n-          'comfy-user': 'loadbalancer-client'\n-        },\n-        mode: 'cors',\n-        credentials: 'omit'\n-      })\n-\n-      clearTimeout(timeoutId)\n-\n-      if (response.ok) {\n-        const data = await response.json()\n-\n-        // è§£æé˜Ÿåˆ—æ•°æ®\n-        let running = 0, pending = 0, total = 0\n-\n-        if (data.queue_running !== undefined && data.queue_pending !== undefined) {\n-          running = Array.isArray(data.queue_running) ? data.queue_running.length : data.queue_running\n-          pending = Array.isArray(data.queue_pending) ? data.queue_pending.length : data.queue_pending\n-          total = running + pending\n-        }\n-\n-        return {\n-          running,\n-          pending,\n-          total,\n-          success: true,\n-          apiPrefix,\n-          endpoint: queueUrl\n-        }\n-      } else {\n-        return { running: 0, pending: 0, total: 1, success: false, error: `HTTP ${response.status}` }\n-      }\n-\n-    } catch (error) {\n-      return { running: 0, pending: 0, total: 1, success: false, error: error.message }\n+    console.log(`âš ï¸ æ‰€æœ‰é˜Ÿåˆ—ç«¯ç‚¹éƒ½å¤±è´¥: ${serverUrl}`)\n+    return {\n+      running: 0,\n+      pending: 0,\n+      total: 999, // è®¾ç½®ä¸€ä¸ªå¾ˆå¤§çš„å€¼ï¼Œè®©è¿™ä¸ªæœåŠ¡å™¨ä¼˜å…ˆçº§é™ä½\n+      success: false,\n+      error: 'æ— æ³•è·å–é˜Ÿåˆ—ä¿¡æ¯'\n     }\n   }\n \n   /**\n"
                },
                {
                    "date": 1752520924360,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -143,125 +143,77 @@\n     }\n   }\n \n   /**\n-   * é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æœåŠ¡å™¨è¿æ¥æµ‹è¯•\n+   * æ ¸å¿ƒæ–¹æ³•ï¼šé€‰æ‹©å¯ç”¨çš„æœ€ä¼˜æœåŠ¡å™¨\n    */\n-  async initializeServerConnection() {\n-    console.log('ğŸš€ æ­£åœ¨åˆå§‹åŒ– ComfyUI æœåŠ¡å™¨è¿æ¥...')\n-    console.log('=' .repeat(60))\n+  async selectOptimalServer() {\n+    console.log('ğŸ¯ å¼€å§‹é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨...')\n \n-    const servers = await this.getServerList()\n-\n-    if (servers.length === 0) {\n-      console.warn('âš ï¸ æœªæ‰¾åˆ°ä»»ä½•é…ç½®çš„æœåŠ¡å™¨')\n-      return null\n+    // 1. è·å–æ‰€æœ‰é…ç½®çš„æœåŠ¡å™¨\n+    const allServers = await this.getServerList()\n+    if (allServers.length === 0) {\n+      throw new Error('æ²¡æœ‰é…ç½®ä»»ä½•æœåŠ¡å™¨')\n     }\n \n-    console.log(`ğŸ“‹ å‘ç° ${servers.length} ä¸ªé…ç½®çš„æœåŠ¡å™¨:`)\n-    servers.forEach((server, index) => {\n-      console.log(`   ${index + 1}. ${server.url} (${server.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨æœåŠ¡å™¨'}, ä¼˜å…ˆçº§: ${server.priority})`)\n-    })\n-    console.log('')\n+    console.log(`ğŸ“‹ æ€»å…± ${allServers.length} ä¸ªæœåŠ¡å™¨éœ€è¦æµ‹è¯•`)\n \n-    console.log('ğŸ” å¼€å§‹æœåŠ¡å™¨è¿æ¥æµ‹è¯•...')\n-    console.log('-' .repeat(60))\n+    // 2. æµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨çš„è¿æ¥æ€§\n+    const availableServers = []\n \n-    const serverResults = []\n+    for (const serverUrl of allServers) {\n+      const connectionResult = await this.testConnection(serverUrl)\n \n-    for (const server of servers) {\n-      console.log(`\\nğŸ–¥ï¸  æµ‹è¯•æœåŠ¡å™¨: ${server.url}`)\n-      console.log(`   ç±»å‹: ${server.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨æœåŠ¡å™¨'} | ä¼˜å…ˆçº§: ${server.priority}`)\n+      if (connectionResult.success) {\n+        // è¿æ¥æˆåŠŸï¼Œè·å–é˜Ÿåˆ—ä¿¡æ¯\n+        const queueInfo = await this.getQueueInfo(serverUrl)\n \n-      // ç›´æ¥è¿æ¥æµ‹è¯•\n-      const healthResult = await this.testDirectConnection(server.url)\n-\n-      if (healthResult.healthy) {\n-        console.log(`   âœ… è¿æ¥æµ‹è¯•: æˆåŠŸ (${healthResult.responseTime}ms, çŠ¶æ€ç : ${healthResult.status})`)\n-\n-        // è·å–é˜Ÿåˆ—ä¿¡æ¯\n-        const queueResult = await this.getQueueInfo(server.url)\n-\n-        if (queueResult.success) {\n-          console.log(`   ğŸ“Š é˜Ÿåˆ—ä¿¡æ¯: è¿è¡Œä¸­ ${queueResult.running} | ç­‰å¾…ä¸­ ${queueResult.pending} | æ€»è®¡ ${queueResult.total}`)\n-          console.log(`   ğŸ”— é˜Ÿåˆ—ç«¯ç‚¹: ${queueResult.endpoint}`)\n-\n-          const queueStatus = queueResult.total === 0 ? 'ğŸŸ¢ ç©ºé—²' :\n-                            queueResult.running > 0 ? 'ğŸŸ¡ ç¹å¿™' : 'ğŸ”´ é˜Ÿåˆ—æ»¡'\n-          console.log(`   ğŸ“ˆ æœåŠ¡å™¨çŠ¶æ€: ${queueStatus}`)\n-\n-          serverResults.push({\n-            ...server,\n-            healthy: true,\n-            responseTime: healthResult.responseTime,\n-            queue: queueResult\n-          })\n-        } else {\n-          console.log(`   âš ï¸ é˜Ÿåˆ—ä¿¡æ¯: è·å–å¤±è´¥ (${queueResult.error})`)\n-          console.log(`   ğŸ“ˆ æœåŠ¡å™¨çŠ¶æ€: ğŸŸ¡ å¯ç”¨ä½†é˜Ÿåˆ—ä¿¡æ¯æœªçŸ¥`)\n-\n-          serverResults.push({\n-            ...server,\n-            healthy: true,\n-            responseTime: healthResult.responseTime,\n-            queue: { running: 0, pending: 0, total: 1, success: false }\n-          })\n-        }\n-      } else {\n-        console.log(`   âŒ è¿æ¥æµ‹è¯•: å¤±è´¥ (${healthResult.error})`)\n-        console.log(`   ğŸ“ˆ æœåŠ¡å™¨çŠ¶æ€: ğŸ”´ ä¸å¯ç”¨`)\n-\n-        serverResults.push({\n-          ...server,\n-          healthy: false,\n-          error: healthResult.error\n+        availableServers.push({\n+          url: serverUrl,\n+          responseTime: connectionResult.responseTime,\n+          queue: queueInfo\n         })\n       }\n     }\n \n-    // è¾“å‡ºæµ‹è¯•ç»“æœæ±‡æ€»\n-    console.log('\\n' + '=' .repeat(60))\n-    const healthyServers = serverResults.filter(s => s.healthy)\n-    console.log(`ğŸ“Š æœåŠ¡å™¨è¿æ¥æµ‹è¯•å®Œæˆ: ${healthyServers.length}/${serverResults.length} ä¸ªæœåŠ¡å™¨å¯ç”¨`)\n+    console.log(`âœ… å¯è¿æ¥çš„æœåŠ¡å™¨: ${availableServers.length}/${allServers.length}`)\n \n-    // è¯¦ç»†çš„æœåŠ¡å™¨çŠ¶æ€è¡¨æ ¼\n-    console.log('\\nğŸ“‹ æœåŠ¡å™¨çŠ¶æ€æ±‡æ€»:')\n-    console.log('   çŠ¶æ€ | ç±»å‹     | æœåŠ¡å™¨URL                    | é˜Ÿåˆ—(è¿è¡Œ/ç­‰å¾…/æ€»è®¡) | å“åº”æ—¶é—´')\n-    console.log('   -----|----------|------------------------------|---------------------|----------')\n+    // 3. å¦‚æœæ²¡æœ‰å¯ç”¨æœåŠ¡å™¨ï¼ŒæŠ›å‡ºé”™è¯¯\n+    if (availableServers.length === 0) {\n+      throw new Error('æ²¡æœ‰å¯è¿æ¥çš„æœåŠ¡å™¨')\n+    }\n \n-    serverResults.forEach(server => {\n-      const status = server.healthy ? 'âœ…' : 'âŒ'\n-      const type = server.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨    '\n-      const url = server.url.length > 28 ? server.url.substring(0, 25) + '...' : server.url.padEnd(28)\n-      const queueInfo = server.queue ?\n-        `${(server.queue.running || 0).toString().padStart(2)}/${(server.queue.pending || 0).toString().padStart(2)}/${(server.queue.total || 0).toString().padStart(2)}`.padEnd(19) :\n-        'N/A'.padEnd(19)\n-      const responseTime = server.responseTime ? `${server.responseTime}ms` : 'N/A'\n-\n-      console.log(`   ${status} | ${type} | ${url} | ${queueInfo} | ${responseTime}`)\n+    // 4. æŒ‰é˜Ÿåˆ—æ•°é‡æ’åºï¼Œé€‰æ‹©é˜Ÿåˆ—æœ€å°‘çš„æœåŠ¡å™¨\n+    const sortedServers = availableServers.sort((a, b) => {\n+      return a.queue.total - b.queue.total\n     })\n \n-    // é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n-    if (healthyServers.length > 0) {\n-      const bestServer = healthyServers.sort((a, b) => {\n-        const queueDiff = (a.queue?.total || 0) - (b.queue?.total || 0)\n-        if (queueDiff !== 0) return queueDiff\n-        return a.priority - b.priority\n-      })[0]\n+    const selectedServer = sortedServers[0]\n \n-      console.log('\\nğŸ¯ æœ€ä¼˜æœåŠ¡å™¨é€‰æ‹©ç»“æœ:')\n-      console.log(`   é€‰æ‹©æœåŠ¡å™¨: ${bestServer.url}`)\n-      console.log(`   é€‰æ‹©åŸå› : ${bestServer.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨æœåŠ¡å™¨'} | é˜Ÿåˆ—æœ€å°‘ (${bestServer.queue?.total || 0} ä¸ªä»»åŠ¡)`)\n-      console.log(`   é˜Ÿåˆ—è¯¦æƒ…: è¿è¡Œä¸­ ${bestServer.queue?.running || 0} | ç­‰å¾…ä¸­ ${bestServer.queue?.pending || 0}`)\n-      console.log(`   å“åº”æ—¶é—´: ${bestServer.responseTime}ms`)\n-      console.log(`   ä¼˜å…ˆçº§: ${bestServer.priority}`)\n+    console.log('ğŸ¯ æœåŠ¡å™¨é€‰æ‹©ç»“æœ:')\n+    console.log(`   é€‰æ‹©çš„æœåŠ¡å™¨: ${selectedServer.url}`)\n+    console.log(`   é˜Ÿåˆ—ä¿¡æ¯: è¿è¡Œä¸­ ${selectedServer.queue.running} | ç­‰å¾…ä¸­ ${selectedServer.queue.pending} | æ€»è®¡ ${selectedServer.queue.total}`)\n+    console.log(`   å“åº”æ—¶é—´: ${selectedServer.responseTime}ms`)\n \n+    return selectedServer.url\n+  }\n+\n+  /**\n+   * é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æœåŠ¡å™¨è¿æ¥æµ‹è¯•\n+   */\n+  async initializeServerConnection() {\n+    console.log('ğŸš€ æ­£åœ¨åˆå§‹åŒ– ComfyUI æœåŠ¡å™¨è¿æ¥...')\n+    console.log('=' .repeat(60))\n+\n+    try {\n+      const selectedServer = await this.selectOptimalServer()\n+\n       console.log('\\nâœ… æœåŠ¡å™¨åˆå§‹åŒ–å®Œæˆï¼Œç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼')\n       console.log('=' .repeat(60))\n \n-      return bestServer.url\n-    } else {\n-      console.log('\\nâŒ æœåŠ¡å™¨é€‰æ‹©ç»“æœ: æ‰€æœ‰æœåŠ¡å™¨éƒ½ä¸å¯ç”¨')\n+      return selectedServer\n+    } catch (error) {\n+      console.log('\\nâŒ æœåŠ¡å™¨é€‰æ‹©å¤±è´¥:', error.message)\n       console.log('ğŸ’¡ å»ºè®®: è¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®æˆ–ç½‘ç»œè¿æ¥')\n       console.log('=' .repeat(60))\n       return null\n     }\n"
                },
                {
                    "date": 1752520944954,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -219,60 +219,27 @@\n     }\n   }\n \n   /**\n-   * é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨ï¼ˆç”¨äºç”Ÿå›¾è¯·æ±‚ï¼‰\n+   * è·å–æœ€ä¼˜æœåŠ¡å™¨ï¼ˆç”¨äºç”Ÿå›¾è¯·æ±‚ï¼‰\n    */\n   async getOptimalServer() {\n-    console.log('ğŸ¯ é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨ (ç”¨äºç”Ÿå›¾è¯·æ±‚)...')\n+    console.log('ğŸ¯ è·å–æœ€ä¼˜æœåŠ¡å™¨ (ç”¨äºç”Ÿå›¾è¯·æ±‚)...')\n \n-    const servers = await this.getServerList()\n+    try {\n+      return await this.selectOptimalServer()\n+    } catch (error) {\n+      console.error('âŒ è·å–æœ€ä¼˜æœåŠ¡å™¨å¤±è´¥:', error.message)\n \n-    if (servers.length === 0) {\n-      throw new Error('æ²¡æœ‰å¯ç”¨çš„æœåŠ¡å™¨é…ç½®')\n-    }\n-\n-    const serverResults = []\n-\n-    for (const server of servers) {\n-      // ç›´æ¥è¿æ¥æµ‹è¯•\n-      const healthResult = await this.testDirectConnection(server.url)\n-\n-      if (healthResult.healthy) {\n-        // è·å–é˜Ÿåˆ—ä¿¡æ¯\n-        const queueResult = await this.getQueueInfo(server.url)\n-\n-        serverResults.push({\n-          ...server,\n-          healthy: true,\n-          responseTime: healthResult.responseTime,\n-          queue: queueResult\n-        })\n-      } else {\n-        serverResults.push({\n-          ...server,\n-          healthy: false,\n-          error: healthResult.error\n-        })\n+      // å¤‡ç”¨æ–¹æ¡ˆï¼šè¿”å›ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨\n+      const servers = await this.getServerList()\n+      if (servers.length > 0) {\n+        console.log(`âš ï¸ ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼Œè¿”å›ç¬¬ä¸€ä¸ªæœåŠ¡å™¨: ${servers[0]}`)\n+        return servers[0]\n       }\n-    }\n \n-    const healthyServers = serverResults.filter(s => s.healthy)\n-\n-    if (healthyServers.length === 0) {\n-      console.warn('âš ï¸ æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨')\n-      return servers[0]?.url || null\n+      throw new Error('æ²¡æœ‰å¯ç”¨çš„æœåŠ¡å™¨')\n     }\n-\n-    const bestServer = healthyServers.sort((a, b) => {\n-      const queueDiff = (a.queue?.total || 0) - (b.queue?.total || 0)\n-      if (queueDiff !== 0) return queueDiff\n-      return a.priority - b.priority\n-    })[0]\n-\n-    console.log(`ğŸ¯ é€‰æ‹©æœåŠ¡å™¨: ${bestServer.url} (é˜Ÿåˆ—: ${bestServer.queue?.total || 0}, å“åº”æ—¶é—´: ${bestServer.responseTime}ms)`)\n-\n-    return bestServer.url\n   }\n }\n \n // åˆ›å»ºå•ä¾‹å®ä¾‹\n"
                },
                {
                    "date": 1752544154145,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -42,9 +42,9 @@\n     return servers\n   }\n \n   /**\n-   * æµ‹è¯•æœåŠ¡å™¨æ˜¯å¦å¯ç›´è¿\n+   * æµ‹è¯•æœåŠ¡å™¨æ˜¯å¦å¯ç›´è¿ - ä½¿ç”¨æ­£ç¡®çš„ComfyUIç«¯ç‚¹\n    */\n   async testConnection(serverUrl) {\n     try {\n       console.log(`ğŸ” æµ‹è¯•è¿æ¥: ${serverUrl}`)\n@@ -52,15 +52,23 @@\n       const controller = new AbortController()\n       const timeoutId = setTimeout(() => controller.abort(), this.connectionTimeout)\n \n       const startTime = Date.now()\n-      const response = await fetch(serverUrl, {\n+\n+      // æ¸…ç†URLï¼Œç¡®ä¿æ²¡æœ‰å°¾éƒ¨æ–œæ \n+      const cleanUrl = serverUrl.replace(/\\/$/, '')\n+\n+      const response = await fetch(cleanUrl, {\n         method: 'HEAD',\n         signal: controller.signal,\n         headers: {\n           'Accept': '*/*',\n-          'Cache-Control': 'no-cache'\n-        }\n+          'Cache-Control': 'no-cache',\n+          'comfy-user': 'loadbalancer-client',\n+          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'\n+        },\n+        mode: 'cors',\n+        credentials: 'omit'\n       })\n \n       clearTimeout(timeoutId)\n       const responseTime = Date.now() - startTime\n"
                },
                {
                    "date": 1752544181669,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -89,60 +89,69 @@\n     }\n   }\n \n   /**\n-   * è·å–æœåŠ¡å™¨é˜Ÿåˆ—ä¿¡æ¯\n+   * è·å–æœåŠ¡å™¨é˜Ÿåˆ—ä¿¡æ¯ - ä½¿ç”¨æ­£ç¡®çš„ComfyUI APIç«¯ç‚¹\n    */\n   async getQueueInfo(serverUrl) {\n-    // å°è¯•ä¸¤ç§å¯èƒ½çš„ç«¯ç‚¹\n+    // å°è¯•ä¸¤ç§å¯èƒ½çš„ç«¯ç‚¹ï¼Œä¼˜å…ˆä½¿ç”¨/api/queue\n     const endpoints = ['/api/queue', '/queue']\n \n+    // æ¸…ç†URLï¼Œç¡®ä¿æ²¡æœ‰å°¾éƒ¨æ–œæ \n+    const cleanUrl = serverUrl.replace(/\\/$/, '')\n+\n     for (const endpoint of endpoints) {\n       try {\n-        console.log(`ğŸ“Š è·å–é˜Ÿåˆ—ä¿¡æ¯: ${serverUrl}${endpoint}`)\n+        const fullUrl = `${cleanUrl}${endpoint}`\n+        console.log(`ğŸ“Š è·å–é˜Ÿåˆ—ä¿¡æ¯: ${fullUrl}`)\n \n         const controller = new AbortController()\n         const timeoutId = setTimeout(() => controller.abort(), this.connectionTimeout)\n \n-        const response = await fetch(`${serverUrl}${endpoint}`, {\n+        const response = await fetch(fullUrl, {\n           method: 'GET',\n           signal: controller.signal,\n           headers: {\n             'Accept': '*/*',\n-            'comfy-user': 'loadbalancer-client'\n-          }\n+            'Cache-Control': 'max-age=0',\n+            'comfy-user': 'loadbalancer-client',\n+            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'\n+          },\n+          mode: 'cors',\n+          credentials: 'omit'\n         })\n \n         clearTimeout(timeoutId)\n \n         if (response.ok) {\n           const data = await response.json()\n \n-          // è§£æé˜Ÿåˆ—æ•°æ®\n+          // è§£æé˜Ÿåˆ—æ•°æ® - æ ¹æ®ComfyUI APIæ–‡æ¡£\n           let running = 0, pending = 0, total = 0\n \n           if (data.queue_running !== undefined && data.queue_pending !== undefined) {\n             running = Array.isArray(data.queue_running) ? data.queue_running.length : data.queue_running\n             pending = Array.isArray(data.queue_pending) ? data.queue_pending.length : data.queue_pending\n             total = running + pending\n           }\n \n-          console.log(`âœ… é˜Ÿåˆ—ä¿¡æ¯è·å–æˆåŠŸ: ${serverUrl}${endpoint} - è¿è¡Œ:${running}, ç­‰å¾…:${pending}, æ€»è®¡:${total}`)\n+          console.log(`âœ… é˜Ÿåˆ—ä¿¡æ¯è·å–æˆåŠŸ: ${fullUrl} - è¿è¡Œ:${running}, ç­‰å¾…:${pending}, æ€»è®¡:${total}`)\n           return {\n             running,\n             pending,\n             total,\n             success: true,\n-            endpoint: `${serverUrl}${endpoint}`\n+            endpoint: fullUrl,\n+            apiPrefix: endpoint.startsWith('/api/') ? '/api' : ''\n           }\n         }\n       } catch (error) {\n-        console.log(`âŒ é˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥: ${serverUrl}${endpoint} - ${error.message}`)\n+        console.log(`âŒ é˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥: ${fullUrl} - ${error.message}`)\n         continue\n       }\n     }\n \n-    console.log(`âš ï¸ æ‰€æœ‰é˜Ÿåˆ—ç«¯ç‚¹éƒ½å¤±è´¥: ${serverUrl}`)\n+    console.log(`âš ï¸ æ‰€æœ‰é˜Ÿåˆ—ç«¯ç‚¹éƒ½å¤±è´¥: ${cleanUrl}`)\n     return {\n       running: 0,\n       pending: 0,\n       total: 999, // è®¾ç½®ä¸€ä¸ªå¾ˆå¤§çš„å€¼ï¼Œè®©è¿™ä¸ªæœåŠ¡å™¨ä¼˜å…ˆçº§é™ä½\n"
                },
                {
                    "date": 1752544292221,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,18 +1,19 @@\n /**\n- * ComfyUI è´Ÿè½½å‡è¡¡å™¨ - å®Œå…¨é‡å†™ç‰ˆæœ¬\n- * ç®€å•ç›´æ¥çš„é€»è¾‘ï¼šé€‰æ‹©å¯ç›´è¿ä¸”é˜Ÿåˆ—æœ€å°‘çš„æœåŠ¡å™¨\n+ * ComfyUI æœåŠ¡å™¨å¥åº·ç›‘æµ‹å™¨\n+ * ä¸“æ³¨äºåŸºç¡€çš„æœåŠ¡å™¨è¿æ¥æµ‹è¯•ï¼Œç§»é™¤å¤æ‚çš„è´Ÿè½½å‡è¡¡ç­–ç•¥\n  */\n-class LoadBalancer {\n+class ServerHealthMonitor {\n   constructor() {\n-    this.connectionTimeout = 8000 // 8ç§’è¿æ¥è¶…æ—¶\n+    this.connectionTimeout = 10000 // 10ç§’è¿æ¥è¶…æ—¶\n+    this.healthCheckResults = new Map() // ç¼“å­˜å¥åº·æ£€æŸ¥ç»“æœ\n   }\n \n   /**\n-   * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n+   * åˆå§‹åŒ–å¥åº·ç›‘æµ‹å™¨\n    */\n   async initialize() {\n-    console.log('ğŸ”§ åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨...')\n+    console.log('ğŸ”§ åˆå§‹åŒ–æœåŠ¡å™¨å¥åº·ç›‘æµ‹å™¨...')\n     return true\n   }\n \n   /**\n"
                },
                {
                    "date": 1752544317266,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -43,50 +43,81 @@\n     return servers\n   }\n \n   /**\n-   * æµ‹è¯•æœåŠ¡å™¨æ˜¯å¦å¯ç›´è¿ - ä½¿ç”¨æ­£ç¡®çš„ComfyUIç«¯ç‚¹\n+   * æµ‹è¯•æœåŠ¡å™¨åŸºç¡€è¿æ¥ - ä½¿ç”¨å¤šç§æ–¹æ³•ç¡®ä¿å‡†ç¡®æ€§\n    */\n-  async testConnection(serverUrl) {\n+  async testBasicConnection(serverUrl) {\n+    const cleanUrl = serverUrl.replace(/\\/$/, '')\n+    console.log(`ğŸ” æµ‹è¯•åŸºç¡€è¿æ¥: ${cleanUrl}`)\n+\n+    // æ–¹æ³•1: å°è¯•æ ¹è·¯å¾„\n     try {\n-      console.log(`ğŸ” æµ‹è¯•è¿æ¥: ${serverUrl}`)\n-\n       const controller = new AbortController()\n       const timeoutId = setTimeout(() => controller.abort(), this.connectionTimeout)\n \n       const startTime = Date.now()\n-\n-      // æ¸…ç†URLï¼Œç¡®ä¿æ²¡æœ‰å°¾éƒ¨æ–œæ \n-      const cleanUrl = serverUrl.replace(/\\/$/, '')\n-\n       const response = await fetch(cleanUrl, {\n         method: 'HEAD',\n         signal: controller.signal,\n         headers: {\n           'Accept': '*/*',\n           'Cache-Control': 'no-cache',\n-          'comfy-user': 'loadbalancer-client',\n-          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'\n+          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'\n         },\n         mode: 'cors',\n         credentials: 'omit'\n       })\n \n       clearTimeout(timeoutId)\n       const responseTime = Date.now() - startTime\n \n-      console.log(`âœ… è¿æ¥æˆåŠŸ: ${serverUrl} (${responseTime}ms, çŠ¶æ€: ${response.status})`)\n+      if (response.ok || response.status === 404) { // 404ä¹Ÿç®—è¿æ¥æˆåŠŸ\n+        console.log(`âœ… åŸºç¡€è¿æ¥æˆåŠŸ: ${cleanUrl} (${responseTime}ms, çŠ¶æ€: ${response.status})`)\n+        return {\n+          success: true,\n+          responseTime,\n+          status: response.status,\n+          method: 'HEAD /'\n+        }\n+      }\n+    } catch (error) {\n+      console.log(`âš ï¸ HEADè¯·æ±‚å¤±è´¥: ${error.message}`)\n+    }\n+\n+    // æ–¹æ³•2: å°è¯•GETè¯·æ±‚æ ¹è·¯å¾„\n+    try {\n+      const controller = new AbortController()\n+      const timeoutId = setTimeout(() => controller.abort(), this.connectionTimeout)\n+\n+      const startTime = Date.now()\n+      const response = await fetch(cleanUrl, {\n+        method: 'GET',\n+        signal: controller.signal,\n+        headers: {\n+          'Accept': '*/*',\n+          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'\n+        },\n+        mode: 'cors',\n+        credentials: 'omit'\n+      })\n+\n+      clearTimeout(timeoutId)\n+      const responseTime = Date.now() - startTime\n+\n+      console.log(`âœ… GETè¿æ¥æˆåŠŸ: ${cleanUrl} (${responseTime}ms, çŠ¶æ€: ${response.status})`)\n       return {\n         success: true,\n         responseTime,\n-        status: response.status\n+        status: response.status,\n+        method: 'GET /'\n       }\n-\n     } catch (error) {\n-      console.log(`âŒ è¿æ¥å¤±è´¥: ${serverUrl} - ${error.message}`)\n+      console.log(`âŒ è¿æ¥å®Œå…¨å¤±è´¥: ${cleanUrl} - ${error.message}`)\n       return {\n         success: false,\n-        error: error.message\n+        error: error.message,\n+        method: 'ALL_FAILED'\n       }\n     }\n   }\n \n"
                },
                {
                    "date": 1752544375595,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -121,75 +121,71 @@\n     }\n   }\n \n   /**\n-   * è·å–æœåŠ¡å™¨é˜Ÿåˆ—ä¿¡æ¯ - ä½¿ç”¨æ­£ç¡®çš„ComfyUI APIç«¯ç‚¹\n+   * æµ‹è¯•ComfyUI APIç«¯ç‚¹ - ä¸“é—¨æµ‹è¯•é˜Ÿåˆ—ç«¯ç‚¹çš„å¯ç”¨æ€§\n    */\n-  async getQueueInfo(serverUrl) {\n-    // å°è¯•ä¸¤ç§å¯èƒ½çš„ç«¯ç‚¹ï¼Œä¼˜å…ˆä½¿ç”¨/api/queue\n-    const endpoints = ['/api/queue', '/queue']\n-\n-    // æ¸…ç†URLï¼Œç¡®ä¿æ²¡æœ‰å°¾éƒ¨æ–œæ \n+  async testComfyUIEndpoints(serverUrl) {\n     const cleanUrl = serverUrl.replace(/\\/$/, '')\n+    const endpoints = ['/api/queue', '/queue'] // ä¼˜å…ˆæµ‹è¯• /api/queue\n \n+    console.log(`ğŸ” æµ‹è¯•ComfyUIç«¯ç‚¹: ${cleanUrl}`)\n+\n     for (const endpoint of endpoints) {\n       try {\n         const fullUrl = `${cleanUrl}${endpoint}`\n-        console.log(`ğŸ“Š è·å–é˜Ÿåˆ—ä¿¡æ¯: ${fullUrl}`)\n+        console.log(`   æµ‹è¯•ç«¯ç‚¹: ${endpoint}`)\n \n         const controller = new AbortController()\n         const timeoutId = setTimeout(() => controller.abort(), this.connectionTimeout)\n \n         const response = await fetch(fullUrl, {\n           method: 'GET',\n           signal: controller.signal,\n           headers: {\n-            'Accept': '*/*',\n-            'Cache-Control': 'max-age=0',\n-            'comfy-user': 'loadbalancer-client',\n-            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'\n+            'Accept': 'application/json, */*',\n+            'Cache-Control': 'no-cache',\n+            'comfy-user': 'health-monitor',\n+            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'\n           },\n           mode: 'cors',\n           credentials: 'omit'\n         })\n \n         clearTimeout(timeoutId)\n \n         if (response.ok) {\n-          const data = await response.json()\n+          // å°è¯•è§£æJSONå“åº”\n+          try {\n+            const data = await response.json()\n+            console.log(`âœ… ComfyUIç«¯ç‚¹å¯ç”¨: ${endpoint}`)\n+            console.log(`   å“åº”æ•°æ®ç»“æ„:`, Object.keys(data))\n \n-          // è§£æé˜Ÿåˆ—æ•°æ® - æ ¹æ®ComfyUI APIæ–‡æ¡£\n-          let running = 0, pending = 0, total = 0\n-\n-          if (data.queue_running !== undefined && data.queue_pending !== undefined) {\n-            running = Array.isArray(data.queue_running) ? data.queue_running.length : data.queue_running\n-            pending = Array.isArray(data.queue_pending) ? data.queue_pending.length : data.queue_pending\n-            total = running + pending\n+            return {\n+              success: true,\n+              endpoint,\n+              fullUrl,\n+              status: response.status,\n+              hasQueueData: !!(data.queue_running !== undefined || data.queue_pending !== undefined),\n+              apiPrefix: endpoint.startsWith('/api/') ? '/api' : '',\n+              data: data\n+            }\n+          } catch (jsonError) {\n+            console.log(`âš ï¸ ç«¯ç‚¹å“åº”ä½†JSONè§£æå¤±è´¥: ${endpoint} - ${jsonError.message}`)\n+            continue\n           }\n-\n-          console.log(`âœ… é˜Ÿåˆ—ä¿¡æ¯è·å–æˆåŠŸ: ${fullUrl} - è¿è¡Œ:${running}, ç­‰å¾…:${pending}, æ€»è®¡:${total}`)\n-          return {\n-            running,\n-            pending,\n-            total,\n-            success: true,\n-            endpoint: fullUrl,\n-            apiPrefix: endpoint.startsWith('/api/') ? '/api' : ''\n-          }\n+        } else {\n+          console.log(`âš ï¸ ç«¯ç‚¹å“åº”é”™è¯¯: ${endpoint} (çŠ¶æ€: ${response.status})`)\n         }\n       } catch (error) {\n-        console.log(`âŒ é˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥: ${fullUrl} - ${error.message}`)\n+        console.log(`âŒ ç«¯ç‚¹æµ‹è¯•å¤±è´¥: ${endpoint} - ${error.message}`)\n         continue\n       }\n     }\n \n-    console.log(`âš ï¸ æ‰€æœ‰é˜Ÿåˆ—ç«¯ç‚¹éƒ½å¤±è´¥: ${cleanUrl}`)\n     return {\n-      running: 0,\n-      pending: 0,\n-      total: 999, // è®¾ç½®ä¸€ä¸ªå¾ˆå¤§çš„å€¼ï¼Œè®©è¿™ä¸ªæœåŠ¡å™¨ä¼˜å…ˆçº§é™ä½\n       success: false,\n-      error: 'æ— æ³•è·å–é˜Ÿåˆ—ä¿¡æ¯'\n+      error: 'æ‰€æœ‰ComfyUIç«¯ç‚¹éƒ½ä¸å¯ç”¨'\n     }\n   }\n \n   /**\n"
                },
                {
                    "date": 1752544401822,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -188,59 +188,61 @@\n     }\n   }\n \n   /**\n-   * æ ¸å¿ƒæ–¹æ³•ï¼šé€‰æ‹©å¯ç”¨çš„æœ€ä¼˜æœåŠ¡å™¨\n+   * æ‰§è¡Œå®Œæ•´çš„æœåŠ¡å™¨å¥åº·æ£€æŸ¥\n    */\n-  async selectOptimalServer() {\n-    console.log('ğŸ¯ å¼€å§‹é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨...')\n+  async performHealthCheck(serverUrl) {\n+    console.log(`\\nğŸ¥ å¼€å§‹å¥åº·æ£€æŸ¥: ${serverUrl}`)\n+    console.log('=' .repeat(50))\n \n-    // 1. è·å–æ‰€æœ‰é…ç½®çš„æœåŠ¡å™¨\n-    const allServers = await this.getServerList()\n-    if (allServers.length === 0) {\n-      throw new Error('æ²¡æœ‰é…ç½®ä»»ä½•æœåŠ¡å™¨')\n+    const healthResult = {\n+      url: serverUrl,\n+      timestamp: new Date().toISOString(),\n+      basicConnection: null,\n+      comfyuiEndpoints: null,\n+      overall: false,\n+      errors: []\n     }\n \n-    console.log(`ğŸ“‹ æ€»å…± ${allServers.length} ä¸ªæœåŠ¡å™¨éœ€è¦æµ‹è¯•`)\n+    try {\n+      // 1. åŸºç¡€è¿æ¥æµ‹è¯•\n+      console.log('1ï¸âƒ£ æµ‹è¯•åŸºç¡€è¿æ¥...')\n+      healthResult.basicConnection = await this.testBasicConnection(serverUrl)\n \n-    // 2. æµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨çš„è¿æ¥æ€§\n-    const availableServers = []\n+      if (!healthResult.basicConnection.success) {\n+        healthResult.errors.push('åŸºç¡€è¿æ¥å¤±è´¥')\n+        console.log('âŒ åŸºç¡€è¿æ¥å¤±è´¥ï¼Œè·³è¿‡åç»­æµ‹è¯•')\n+        return healthResult\n+      }\n \n-    for (const serverUrl of allServers) {\n-      const connectionResult = await this.testConnection(serverUrl)\n+      // 2. ComfyUIç«¯ç‚¹æµ‹è¯•\n+      console.log('2ï¸âƒ£ æµ‹è¯•ComfyUIç«¯ç‚¹...')\n+      healthResult.comfyuiEndpoints = await this.testComfyUIEndpoints(serverUrl)\n \n-      if (connectionResult.success) {\n-        // è¿æ¥æˆåŠŸï¼Œè·å–é˜Ÿåˆ—ä¿¡æ¯\n-        const queueInfo = await this.getQueueInfo(serverUrl)\n-\n-        availableServers.push({\n-          url: serverUrl,\n-          responseTime: connectionResult.responseTime,\n-          queue: queueInfo\n-        })\n+      if (!healthResult.comfyuiEndpoints.success) {\n+        healthResult.errors.push('ComfyUIç«¯ç‚¹ä¸å¯ç”¨')\n       }\n-    }\n \n-    console.log(`âœ… å¯è¿æ¥çš„æœåŠ¡å™¨: ${availableServers.length}/${allServers.length}`)\n+      // 3. ç»¼åˆè¯„ä¼°\n+      healthResult.overall = healthResult.basicConnection.success && healthResult.comfyuiEndpoints.success\n \n-    // 3. å¦‚æœæ²¡æœ‰å¯ç”¨æœåŠ¡å™¨ï¼ŒæŠ›å‡ºé”™è¯¯\n-    if (availableServers.length === 0) {\n-      throw new Error('æ²¡æœ‰å¯è¿æ¥çš„æœåŠ¡å™¨')\n-    }\n+      console.log(`\\nğŸ“Š å¥åº·æ£€æŸ¥ç»“æœ: ${healthResult.overall ? 'âœ… å¥åº·' : 'âŒ ä¸å¥åº·'}`)\n+      if (healthResult.errors.length > 0) {\n+        console.log(`âš ï¸ é—®é¢˜: ${healthResult.errors.join(', ')}`)\n+      }\n+      console.log('=' .repeat(50))\n \n-    // 4. æŒ‰é˜Ÿåˆ—æ•°é‡æ’åºï¼Œé€‰æ‹©é˜Ÿåˆ—æœ€å°‘çš„æœåŠ¡å™¨\n-    const sortedServers = availableServers.sort((a, b) => {\n-      return a.queue.total - b.queue.total\n-    })\n+      // ç¼“å­˜ç»“æœ\n+      this.healthCheckResults.set(serverUrl, healthResult)\n \n-    const selectedServer = sortedServers[0]\n+      return healthResult\n \n-    console.log('ğŸ¯ æœåŠ¡å™¨é€‰æ‹©ç»“æœ:')\n-    console.log(`   é€‰æ‹©çš„æœåŠ¡å™¨: ${selectedServer.url}`)\n-    console.log(`   é˜Ÿåˆ—ä¿¡æ¯: è¿è¡Œä¸­ ${selectedServer.queue.running} | ç­‰å¾…ä¸­ ${selectedServer.queue.pending} | æ€»è®¡ ${selectedServer.queue.total}`)\n-    console.log(`   å“åº”æ—¶é—´: ${selectedServer.responseTime}ms`)\n-\n-    return selectedServer.url\n+    } catch (error) {\n+      console.error(`âŒ å¥åº·æ£€æŸ¥å¼‚å¸¸: ${error.message}`)\n+      healthResult.errors.push(`æ£€æŸ¥å¼‚å¸¸: ${error.message}`)\n+      return healthResult\n+    }\n   }\n \n   /**\n    * é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æœåŠ¡å™¨è¿æ¥æµ‹è¯•\n"
                },
                {
                    "date": 1752544427433,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -244,49 +244,74 @@\n     }\n   }\n \n   /**\n-   * é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æœåŠ¡å™¨è¿æ¥æµ‹è¯•\n+   * æ£€æŸ¥æ‰€æœ‰é…ç½®çš„æœåŠ¡å™¨å¥åº·çŠ¶æ€\n    */\n-  async initializeServerConnection() {\n-    console.log('ğŸš€ æ­£åœ¨åˆå§‹åŒ– ComfyUI æœåŠ¡å™¨è¿æ¥...')\n-    console.log('=' .repeat(60))\n+  async checkAllServers() {\n+    console.log('\\nğŸš€ å¼€å§‹æ£€æŸ¥æ‰€æœ‰æœåŠ¡å™¨å¥åº·çŠ¶æ€...')\n \n-    try {\n-      const selectedServer = await this.selectOptimalServer()\n+    const servers = await this.getServerList()\n+    if (servers.length === 0) {\n+      console.log('âŒ æ²¡æœ‰é…ç½®ä»»ä½•æœåŠ¡å™¨')\n+      return []\n+    }\n \n-      console.log('\\nâœ… æœåŠ¡å™¨åˆå§‹åŒ–å®Œæˆï¼Œç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼')\n-      console.log('=' .repeat(60))\n+    console.log(`ğŸ“‹ å‘ç° ${servers.length} ä¸ªé…ç½®çš„æœåŠ¡å™¨`)\n \n-      return selectedServer\n-    } catch (error) {\n-      console.log('\\nâŒ æœåŠ¡å™¨é€‰æ‹©å¤±è´¥:', error.message)\n-      console.log('ğŸ’¡ å»ºè®®: è¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®æˆ–ç½‘ç»œè¿æ¥')\n-      console.log('=' .repeat(60))\n-      return null\n+    const results = []\n+    for (const serverUrl of servers) {\n+      const healthResult = await this.performHealthCheck(serverUrl)\n+      results.push(healthResult)\n     }\n+\n+    // æ±‡æ€»ç»“æœ\n+    const healthyServers = results.filter(r => r.overall)\n+    const unhealthyServers = results.filter(r => !r.overall)\n+\n+    console.log('\\nğŸ“Š å¥åº·æ£€æŸ¥æ±‡æ€»:')\n+    console.log(`âœ… å¥åº·æœåŠ¡å™¨: ${healthyServers.length}`)\n+    console.log(`âŒ ä¸å¥åº·æœåŠ¡å™¨: ${unhealthyServers.length}`)\n+\n+    if (healthyServers.length > 0) {\n+      console.log('\\nğŸŸ¢ å¥åº·çš„æœåŠ¡å™¨:')\n+      healthyServers.forEach(server => {\n+        console.log(`   âœ… ${server.url}`)\n+        if (server.comfyuiEndpoints?.success) {\n+          console.log(`      - ComfyUIç«¯ç‚¹: ${server.comfyuiEndpoints.endpoint}`)\n+          console.log(`      - APIå‰ç¼€: ${server.comfyuiEndpoints.apiPrefix || 'æ— '}`)\n+        }\n+      })\n+    }\n+\n+    if (unhealthyServers.length > 0) {\n+      console.log('\\nğŸ”´ ä¸å¥åº·çš„æœåŠ¡å™¨:')\n+      unhealthyServers.forEach(server => {\n+        console.log(`   âŒ ${server.url}`)\n+        console.log(`      - é—®é¢˜: ${server.errors.join(', ')}`)\n+      })\n+    }\n+\n+    return results\n   }\n \n   /**\n-   * è·å–æœ€ä¼˜æœåŠ¡å™¨ï¼ˆç”¨äºç”Ÿå›¾è¯·æ±‚ï¼‰\n+   * è·å–ç¬¬ä¸€ä¸ªå¥åº·çš„æœåŠ¡å™¨ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰\n    */\n-  async getOptimalServer() {\n-    console.log('ğŸ¯ è·å–æœ€ä¼˜æœåŠ¡å™¨ (ç”¨äºç”Ÿå›¾è¯·æ±‚)...')\n+  async getFirstHealthyServer() {\n+    console.log('ğŸ¯ è·å–ç¬¬ä¸€ä¸ªå¥åº·çš„æœåŠ¡å™¨...')\n \n-    try {\n-      return await this.selectOptimalServer()\n-    } catch (error) {\n-      console.error('âŒ è·å–æœ€ä¼˜æœåŠ¡å™¨å¤±è´¥:', error.message)\n+    const results = await this.checkAllServers()\n+    const healthyServers = results.filter(r => r.overall)\n \n-      // å¤‡ç”¨æ–¹æ¡ˆï¼šè¿”å›ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨\n-      const servers = await this.getServerList()\n-      if (servers.length > 0) {\n-        console.log(`âš ï¸ ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼Œè¿”å›ç¬¬ä¸€ä¸ªæœåŠ¡å™¨: ${servers[0]}`)\n-        return servers[0]\n-      }\n+    if (healthyServers.length === 0) {\n+      throw new Error('æ²¡æœ‰æ‰¾åˆ°å¥åº·çš„æœåŠ¡å™¨')\n+    }\n \n-      throw new Error('æ²¡æœ‰å¯ç”¨çš„æœåŠ¡å™¨')\n-    }\n+    const selectedServer = healthyServers[0]\n+    console.log(`âœ… é€‰æ‹©æœåŠ¡å™¨: ${selectedServer.url}`)\n+\n+    return selectedServer.url\n   }\n }\n \n // åˆ›å»ºå•ä¾‹å®ä¾‹\n"
                },
                {
                    "date": 1752544438934,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -314,7 +314,7 @@\n   }\n }\n \n // åˆ›å»ºå•ä¾‹å®ä¾‹\n-const loadBalancer = new LoadBalancer()\n+const serverHealthMonitor = new ServerHealthMonitor()\n \n-export default loadBalancer\n+export default serverHealthMonitor\n"
                },
                {
                    "date": 1752545456827,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -121,13 +121,19 @@\n     }\n   }\n \n   /**\n-   * æµ‹è¯•ComfyUI APIç«¯ç‚¹ - ä¸“é—¨æµ‹è¯•é˜Ÿåˆ—ç«¯ç‚¹çš„å¯ç”¨æ€§\n+   * æµ‹è¯•ComfyUI APIç«¯ç‚¹ - åŸºäºå®˜æ–¹æ–‡æ¡£çš„ç«¯ç‚¹æ£€æµ‹\n    */\n   async testComfyUIEndpoints(serverUrl) {\n     const cleanUrl = serverUrl.replace(/\\/$/, '')\n-    const endpoints = ['/api/queue', '/queue'] // ä¼˜å…ˆæµ‹è¯• /api/queue\n+    // åŸºäºComfyUIå®˜æ–¹æ–‡æ¡£çš„ç«¯ç‚¹åˆ—è¡¨ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº\n+    const endpoints = [\n+      '/api/queue',        // ComfyUIå®˜æ–¹é˜Ÿåˆ—ç«¯ç‚¹\n+      '/api/system_stats', // ComfyUIå®˜æ–¹ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n+      '/queue',            // å¤‡ç”¨é˜Ÿåˆ—ç«¯ç‚¹\n+      '/system_stats'      // å¤‡ç”¨ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n+    ]\n \n     console.log(`ğŸ” æµ‹è¯•ComfyUIç«¯ç‚¹: ${cleanUrl}`)\n \n     for (const endpoint of endpoints) {\n@@ -142,11 +148,12 @@\n           method: 'GET',\n           signal: controller.signal,\n           headers: {\n             'Accept': 'application/json, */*',\n+            'Accept-Language': 'zh-CN,zh;q=0.9',\n             'Cache-Control': 'no-cache',\n             'comfy-user': 'health-monitor',\n-            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'\n+            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0 Safari/537.36'\n           },\n           mode: 'cors',\n           credentials: 'omit'\n         })\n"
                },
                {
                    "date": 1752545471345,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -94,9 +94,11 @@\n         method: 'GET',\n         signal: controller.signal,\n         headers: {\n           'Accept': '*/*',\n-          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'\n+          'Accept-Language': 'zh-CN,zh;q=0.9',\n+          'Cache-Control': 'max-age=0',\n+          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0 Safari/537.36'\n         },\n         mode: 'cors',\n         credentials: 'omit'\n       })\n"
                },
                {
                    "date": 1752547442869,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,4 +1,12 @@\n+import {\n+  COMFYUI_HEALTH_CONFIG,\n+  COMFYUI_HEADERS,\n+  HEALTH_STATUS,\n+  validateComfyUIResponse,\n+  getApiPrefix\n+} from '../constants/comfyui-health.js'\n+\n /**\n  * ComfyUI æœåŠ¡å™¨å¥åº·ç›‘æµ‹å™¨\n  * ä¸“æ³¨äºåŸºç¡€çš„æœåŠ¡å™¨è¿æ¥æµ‹è¯•ï¼Œç§»é™¤å¤æ‚çš„è´Ÿè½½å‡è¡¡ç­–ç•¥\n  */\n"
                },
                {
                    "date": 1752547530163,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,19 +1,13 @@\n-import {\n-  COMFYUI_HEALTH_CONFIG,\n-  COMFYUI_HEADERS,\n-  HEALTH_STATUS,\n-  validateComfyUIResponse,\n-  getApiPrefix\n-} from '../constants/comfyui-health.js'\n+import comfyUIConfig from '../config/comfyui.config.js'\n \n /**\n  * ComfyUI æœåŠ¡å™¨å¥åº·ç›‘æµ‹å™¨\n- * ä¸“æ³¨äºåŸºç¡€çš„æœåŠ¡å™¨è¿æ¥æµ‹è¯•ï¼Œç§»é™¤å¤æ‚çš„è´Ÿè½½å‡è¡¡ç­–ç•¥\n+ * ä½¿ç”¨ç»Ÿä¸€çš„å®˜æ–¹ç«¯ç‚¹é…ç½®è¿›è¡Œå¥åº·æ£€æµ‹\n  */\n class ServerHealthMonitor {\n   constructor() {\n-    this.connectionTimeout = 10000 // 10ç§’è¿æ¥è¶…æ—¶\n+    this.connectionTimeout = comfyUIConfig.HEALTH_CHECK.TIMEOUT\n     this.healthCheckResults = new Map() // ç¼“å­˜å¥åº·æ£€æŸ¥ç»“æœ\n   }\n \n   /**\n"
                },
                {
                    "date": 1752547542982,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -14,8 +14,9 @@\n    * åˆå§‹åŒ–å¥åº·ç›‘æµ‹å™¨\n    */\n   async initialize() {\n     console.log('ğŸ”§ åˆå§‹åŒ–æœåŠ¡å™¨å¥åº·ç›‘æµ‹å™¨...')\n+    console.log('ğŸ“‹ ä½¿ç”¨å®˜æ–¹ç«¯ç‚¹é…ç½®:', comfyUIConfig.getHealthCheckEndpoints())\n     return true\n   }\n \n   /**\n"
                },
                {
                    "date": 1752547561263,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -95,14 +95,9 @@\n       const startTime = Date.now()\n       const response = await fetch(cleanUrl, {\n         method: 'GET',\n         signal: controller.signal,\n-        headers: {\n-          'Accept': '*/*',\n-          'Accept-Language': 'zh-CN,zh;q=0.9',\n-          'Cache-Control': 'max-age=0',\n-          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0 Safari/537.36'\n-        },\n+        headers: comfyUIConfig.HEALTH_CHECK.HEADERS,\n         mode: 'cors',\n         credentials: 'omit'\n       })\n \n"
                },
                {
                    "date": 1752547588513,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -121,21 +121,16 @@\n     }\n   }\n \n   /**\n-   * æµ‹è¯•ComfyUI APIç«¯ç‚¹ - åŸºäºå®˜æ–¹æ–‡æ¡£çš„ç«¯ç‚¹æ£€æµ‹\n+   * æµ‹è¯•ComfyUI APIç«¯ç‚¹ - ä½¿ç”¨ç»Ÿä¸€çš„å®˜æ–¹ç«¯ç‚¹é…ç½®\n    */\n   async testComfyUIEndpoints(serverUrl) {\n     const cleanUrl = serverUrl.replace(/\\/$/, '')\n-    // åŸºäºComfyUIå®˜æ–¹æ–‡æ¡£çš„ç«¯ç‚¹åˆ—è¡¨ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº\n-    const endpoints = [\n-      '/api/queue',        // ComfyUIå®˜æ–¹é˜Ÿåˆ—ç«¯ç‚¹\n-      '/api/system_stats', // ComfyUIå®˜æ–¹ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n-      '/queue',            // å¤‡ç”¨é˜Ÿåˆ—ç«¯ç‚¹\n-      '/system_stats'      // å¤‡ç”¨ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n-    ]\n+    const endpoints = comfyUIConfig.getHealthCheckEndpoints()\n \n     console.log(`ğŸ” æµ‹è¯•ComfyUIç«¯ç‚¹: ${cleanUrl}`)\n+    console.log(`ğŸ“‹ ä½¿ç”¨ç«¯ç‚¹åˆ—è¡¨:`, endpoints)\n \n     for (const endpoint of endpoints) {\n       try {\n         const fullUrl = `${cleanUrl}${endpoint}`\n@@ -146,15 +141,9 @@\n \n         const response = await fetch(fullUrl, {\n           method: 'GET',\n           signal: controller.signal,\n-          headers: {\n-            'Accept': 'application/json, */*',\n-            'Accept-Language': 'zh-CN,zh;q=0.9',\n-            'Cache-Control': 'no-cache',\n-            'comfy-user': 'health-monitor',\n-            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0 Safari/537.36'\n-          },\n+          headers: comfyUIConfig.HEALTH_CHECK.HEADERS,\n           mode: 'cors',\n           credentials: 'omit'\n         })\n \n"
                },
                {
                    "date": 1752547612064,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -152,19 +152,29 @@\n         if (response.ok) {\n           // å°è¯•è§£æJSONå“åº”\n           try {\n             const data = await response.json()\n-            console.log(`âœ… ComfyUIç«¯ç‚¹å¯ç”¨: ${endpoint}`)\n-            console.log(`   å“åº”æ•°æ®ç»“æ„:`, Object.keys(data))\n \n-            return {\n-              success: true,\n-              endpoint,\n-              fullUrl,\n-              status: response.status,\n-              hasQueueData: !!(data.queue_running !== undefined || data.queue_pending !== undefined),\n-              apiPrefix: endpoint.startsWith('/api/') ? '/api' : '',\n-              data: data\n+            // ä½¿ç”¨ç»Ÿä¸€çš„å“åº”éªŒè¯\n+            const isValidResponse = comfyUIConfig.validateResponse(endpoint, data)\n+\n+            if (isValidResponse) {\n+              console.log(`âœ… ComfyUIç«¯ç‚¹å¯ç”¨: ${endpoint}`)\n+              console.log(`   å“åº”æ•°æ®ç»“æ„:`, Object.keys(data))\n+\n+              return {\n+                success: true,\n+                endpoint,\n+                fullUrl,\n+                status: response.status,\n+                hasQueueData: !!(data.queue_running !== undefined || data.queue_pending !== undefined),\n+                apiPrefix: endpoint.startsWith('/api/') ? '/api' : '',\n+                data: data,\n+                validated: true\n+              }\n+            } else {\n+              console.log(`âš ï¸ ç«¯ç‚¹å“åº”ä½†éªŒè¯å¤±è´¥: ${endpoint} - ä¸æ˜¯æœ‰æ•ˆçš„ComfyUIå“åº”`)\n+              continue\n             }\n           } catch (jsonError) {\n             console.log(`âš ï¸ ç«¯ç‚¹å“åº”ä½†JSONè§£æå¤±è´¥: ${endpoint} - ${jsonError.message}`)\n             continue\n"
                },
                {
                    "date": 1752548666532,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,14 +1,18 @@\n import comfyUIConfig from '../config/comfyui.config.js'\n+import configService from './configService.js'\n \n /**\n- * ComfyUI æœåŠ¡å™¨å¥åº·ç›‘æµ‹å™¨\n- * ä½¿ç”¨ç»Ÿä¸€çš„å®˜æ–¹ç«¯ç‚¹é…ç½®è¿›è¡Œå¥åº·æ£€æµ‹\n+ * ComfyUI è´Ÿè½½å‡è¡¡å™¨\n+ * ä½¿ç”¨ç»Ÿä¸€çš„å®˜æ–¹ç«¯ç‚¹é…ç½®è¿›è¡Œå¥åº·æ£€æµ‹å’ŒæœåŠ¡å™¨é€‰æ‹©\n  */\n-class ServerHealthMonitor {\n+class LoadBalancer {\n   constructor() {\n     this.connectionTimeout = comfyUIConfig.HEALTH_CHECK.TIMEOUT\n     this.healthCheckResults = new Map() // ç¼“å­˜å¥åº·æ£€æŸ¥ç»“æœ\n+    this.serverList = [] // æœåŠ¡å™¨åˆ—è¡¨\n+    this.lastHealthCheck = 0 // ä¸Šæ¬¡å¥åº·æ£€æŸ¥æ—¶é—´\n+    this.healthCheckInterval = 30000 // 30ç§’æ£€æŸ¥ä¸€æ¬¡\n   }\n \n   /**\n    * åˆå§‹åŒ–å¥åº·ç›‘æµ‹å™¨\n"
                },
                {
                    "date": 1752548684116,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -14,17 +14,75 @@\n     this.healthCheckInterval = 30000 // 30ç§’æ£€æŸ¥ä¸€æ¬¡\n   }\n \n   /**\n-   * åˆå§‹åŒ–å¥åº·ç›‘æµ‹å™¨\n+   * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n    */\n   async initialize() {\n-    console.log('ğŸ”§ åˆå§‹åŒ–æœåŠ¡å™¨å¥åº·ç›‘æµ‹å™¨...')\n+    console.log('ğŸ”§ åˆå§‹åŒ–ComfyUIè´Ÿè½½å‡è¡¡å™¨...')\n     console.log('ğŸ“‹ ä½¿ç”¨å®˜æ–¹ç«¯ç‚¹é…ç½®:', comfyUIConfig.getHealthCheckEndpoints())\n+\n+    // è·å–æœåŠ¡å™¨åˆ—è¡¨\n+    await this.loadServerList()\n+\n     return true\n   }\n \n   /**\n+   * åŠ è½½æœåŠ¡å™¨åˆ—è¡¨\n+   */\n+  async loadServerList() {\n+    try {\n+      // ä»é…ç½®æœåŠ¡è·å–æœåŠ¡å™¨åˆ—è¡¨\n+      const config = await configService.getConfig()\n+\n+      this.serverList = []\n+\n+      // ä¸»æœåŠ¡å™¨\n+      if (config['comfyui.server_url']) {\n+        this.serverList.push({\n+          url: config['comfyui.server_url'],\n+          type: 'primary',\n+          healthy: null,\n+          lastCheck: 0\n+        })\n+      }\n+\n+      // å¤‡ç”¨æœåŠ¡å™¨\n+      if (config['comfyui.backup_servers']) {\n+        const backupServers = config['comfyui.backup_servers']\n+          .split(/[,\\n]/)\n+          .map(url => url.trim())\n+          .filter(url => url && url.startsWith('http'))\n+\n+        backupServers.forEach(url => {\n+          this.serverList.push({\n+            url,\n+            type: 'backup',\n+            healthy: null,\n+            lastCheck: 0\n+          })\n+        })\n+      }\n+\n+      console.log(`ğŸ“Š åŠ è½½äº† ${this.serverList.length} ä¸ªæœåŠ¡å™¨:`)\n+      this.serverList.forEach((server, index) => {\n+        console.log(`   ${index + 1}. ${server.type}: ${server.url}`)\n+      })\n+\n+    } catch (error) {\n+      console.error('âŒ åŠ è½½æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥:', error)\n+      // ä½¿ç”¨é»˜è®¤æœåŠ¡å™¨\n+      this.serverList = [{\n+        url: comfyUIConfig.BASE_URL,\n+        type: 'default',\n+        healthy: null,\n+        lastCheck: 0\n+      }]\n+    }\n+  }\n+\n+  /**\n    * è·å–æ‰€æœ‰é…ç½®çš„æœåŠ¡å™¨åˆ—è¡¨\n    */\n   async getServerList() {\n     const servers = []\n"
                },
                {
                    "date": 1752548694981,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -382,7 +382,7 @@\n   }\n }\n \n // åˆ›å»ºå•ä¾‹å®ä¾‹\n-const serverHealthMonitor = new ServerHealthMonitor()\n+const loadBalancer = new LoadBalancer()\n \n-export default serverHealthMonitor\n+export default loadBalancer\n"
                },
                {
                    "date": 1752548714452,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -108,8 +108,83 @@\n     return servers\n   }\n \n   /**\n+   * è·å–æœ€ä¼˜æœåŠ¡å™¨\n+   */\n+  async getOptimalServer() {\n+    // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°å¥åº·çŠ¶æ€\n+    const now = Date.now()\n+    if (now - this.lastHealthCheck > this.healthCheckInterval) {\n+      await this.refreshHealthStatus()\n+      this.lastHealthCheck = now\n+    }\n+\n+    // ä¼˜å…ˆè¿”å›å¥åº·çš„ä¸»æœåŠ¡å™¨\n+    const primaryServers = this.serverList.filter(s => s.type === 'primary' && s.healthy === true)\n+    if (primaryServers.length > 0) {\n+      return primaryServers[0].url\n+    }\n+\n+    // ç„¶åè¿”å›å¥åº·çš„å¤‡ç”¨æœåŠ¡å™¨\n+    const backupServers = this.serverList.filter(s => s.type === 'backup' && s.healthy === true)\n+    if (backupServers.length > 0) {\n+      return backupServers[0].url\n+    }\n+\n+    // å¦‚æœæ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨ï¼Œè¿”å›ç¬¬ä¸€ä¸ªæœåŠ¡å™¨ï¼ˆå¯èƒ½æ˜¯é»˜è®¤æœåŠ¡å™¨ï¼‰\n+    if (this.serverList.length > 0) {\n+      console.warn('âš ï¸ æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæœåŠ¡å™¨')\n+      return this.serverList[0].url\n+    }\n+\n+    // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆ\n+    console.warn('âš ï¸ æ²¡æœ‰é…ç½®çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®')\n+    return comfyUIConfig.BASE_URL\n+  }\n+\n+  /**\n+   * åˆ·æ–°æ‰€æœ‰æœåŠ¡å™¨çš„å¥åº·çŠ¶æ€\n+   */\n+  async refreshHealthStatus() {\n+    console.log('ğŸ”„ åˆ·æ–°æœåŠ¡å™¨å¥åº·çŠ¶æ€...')\n+\n+    const promises = this.serverList.map(async (server) => {\n+      try {\n+        const result = await this.testComfyUIEndpoints(server.url)\n+        server.healthy = result.success\n+        server.lastCheck = Date.now()\n+\n+        if (result.success) {\n+          console.log(`âœ… æœåŠ¡å™¨å¥åº·: ${server.url}`)\n+        } else {\n+          console.log(`âŒ æœåŠ¡å™¨å¼‚å¸¸: ${server.url}`)\n+        }\n+      } catch (error) {\n+        server.healthy = false\n+        server.lastCheck = Date.now()\n+        console.log(`âŒ æœåŠ¡å™¨æ£€æŸ¥å¤±è´¥: ${server.url} - ${error.message}`)\n+      }\n+    })\n+\n+    await Promise.all(promises)\n+  }\n+\n+  /**\n+   * è®°å½•æœåŠ¡å™¨å¤±è´¥\n+   */\n+  async recordFailure(serverUrl, errorType = 'unknown') {\n+    console.log(`ğŸ“ è®°å½•æœåŠ¡å™¨å¤±è´¥: ${serverUrl} (${errorType})`)\n+\n+    // æ‰¾åˆ°å¯¹åº”çš„æœåŠ¡å™¨å¹¶æ ‡è®°ä¸ºä¸å¥åº·\n+    const server = this.serverList.find(s => s.url === serverUrl)\n+    if (server) {\n+      server.healthy = false\n+      server.lastCheck = Date.now()\n+    }\n+  }\n+\n+  /**\n    * æµ‹è¯•æœåŠ¡å™¨åŸºç¡€è¿æ¥ - ä½¿ç”¨å¤šç§æ–¹æ³•ç¡®ä¿å‡†ç¡®æ€§\n    */\n   async testBasicConnection(serverUrl) {\n     const cleanUrl = serverUrl.replace(/\\/$/, '')\n"
                },
                {
                    "date": 1752548979128,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,5 @@\n import comfyUIConfig from '../config/comfyui.config.js'\n-import configService from './configService.js'\n \n /**\n  * ComfyUI è´Ÿè½½å‡è¡¡å™¨\n  * ä½¿ç”¨ç»Ÿä¸€çš„å®˜æ–¹ç«¯ç‚¹é…ç½®è¿›è¡Œå¥åº·æ£€æµ‹å’ŒæœåŠ¡å™¨é€‰æ‹©\n"
                },
                {
                    "date": 1752549007788,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,17 +30,18 @@\n    * åŠ è½½æœåŠ¡å™¨åˆ—è¡¨\n    */\n   async loadServerList() {\n     try {\n-      // ä»é…ç½®æœåŠ¡è·å–æœåŠ¡å™¨åˆ—è¡¨\n+      // åŠ¨æ€å¯¼å…¥é…ç½®æœåŠ¡ä»¥é¿å…å¾ªç¯ä¾èµ–\n+      const { default: configService } = await import('./configService.js')\n       const config = await configService.getConfig()\n \n       this.serverList = []\n \n       // ä¸»æœåŠ¡å™¨\n       if (config['comfyui.server_url']) {\n         this.serverList.push({\n-          url: config['comfyui.server_url'],\n+          url: config['comfyui.server_url'].replace(/\\/$/, ''),\n           type: 'primary',\n           healthy: null,\n           lastCheck: 0\n         })\n@@ -49,9 +50,9 @@\n       // å¤‡ç”¨æœåŠ¡å™¨\n       if (config['comfyui.backup_servers']) {\n         const backupServers = config['comfyui.backup_servers']\n           .split(/[,\\n]/)\n-          .map(url => url.trim())\n+          .map(url => url.trim().replace(/\\/$/, ''))\n           .filter(url => url && url.startsWith('http'))\n \n         backupServers.forEach(url => {\n           this.serverList.push({\n@@ -71,13 +72,14 @@\n     } catch (error) {\n       console.error('âŒ åŠ è½½æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥:', error)\n       // ä½¿ç”¨é»˜è®¤æœåŠ¡å™¨\n       this.serverList = [{\n-        url: comfyUIConfig.BASE_URL,\n+        url: comfyUIConfig.BASE_URL.replace(/\\/$/, ''),\n         type: 'default',\n         healthy: null,\n         lastCheck: 0\n       }]\n+      console.log('ğŸ“Š ä½¿ç”¨é»˜è®¤æœåŠ¡å™¨:', this.serverList[0].url)\n     }\n   }\n \n   /**\n"
                },
                {
                    "date": 1752549023391,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -109,8 +109,17 @@\n     return servers\n   }\n \n   /**\n+   * åˆå§‹åŒ–æœåŠ¡å™¨è¿æ¥ï¼ˆå…¼å®¹æ—§æ¥å£ï¼‰\n+   */\n+  async initializeServerConnection() {\n+    console.log('ğŸ”— åˆå§‹åŒ–æœåŠ¡å™¨è¿æ¥...')\n+    await this.loadServerList()\n+    await this.refreshHealthStatus()\n+  }\n+\n+  /**\n    * è·å–æœ€ä¼˜æœåŠ¡å™¨\n    */\n   async getOptimalServer() {\n     // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°å¥åº·çŠ¶æ€\n"
                },
                {
                    "date": 1752550402084,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -290,9 +290,10 @@\n           method: 'GET',\n           signal: controller.signal,\n           headers: comfyUIConfig.HEALTH_CHECK.HEADERS,\n           mode: 'cors',\n-          credentials: 'omit'\n+          credentials: 'omit',\n+          cache: 'no-cache'\n         })\n \n         clearTimeout(timeoutId)\n \n"
                },
                {
                    "date": 1752550421554,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -331,8 +331,23 @@\n           console.log(`âš ï¸ ç«¯ç‚¹å“åº”é”™è¯¯: ${endpoint} (çŠ¶æ€: ${response.status})`)\n         }\n       } catch (error) {\n         console.log(`âŒ ç«¯ç‚¹æµ‹è¯•å¤±è´¥: ${endpoint} - ${error.message}`)\n+\n+        // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œå°è¯•ç®€åŒ–çš„è¯·æ±‚\n+        if (error.message.includes('Failed to fetch') || error.message.includes('ERR_FAILED')) {\n+          console.log(`ğŸ”„ å°è¯•ç®€åŒ–è¯·æ±‚: ${endpoint}`)\n+          try {\n+            const simpleResponse = await this.testSimpleEndpoint(fullUrl)\n+            if (simpleResponse.success) {\n+              console.log(`âœ… ç®€åŒ–è¯·æ±‚æˆåŠŸ: ${endpoint}`)\n+              return simpleResponse\n+            }\n+          } catch (simpleError) {\n+            console.log(`âŒ ç®€åŒ–è¯·æ±‚ä¹Ÿå¤±è´¥: ${simpleError.message}`)\n+          }\n+        }\n+\n         continue\n       }\n     }\n \n"
                },
                {
                    "date": 1752550442974,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -193,8 +193,48 @@\n     }\n   }\n \n   /**\n+   * ç®€åŒ–çš„ç«¯ç‚¹æµ‹è¯• - ç”¨äºCORSé—®é¢˜çš„å¤‡ç”¨æ–¹æ¡ˆ\n+   */\n+  async testSimpleEndpoint(url) {\n+    try {\n+      console.log(`ğŸ” ç®€åŒ–æµ‹è¯•: ${url}`)\n+\n+      const controller = new AbortController()\n+      const timeoutId = setTimeout(() => controller.abort(), 5000) // 5ç§’è¶…æ—¶\n+\n+      const response = await fetch(url, {\n+        method: 'GET',\n+        signal: controller.signal,\n+        mode: 'no-cors', // ä½¿ç”¨no-corsæ¨¡å¼é¿å…CORSé—®é¢˜\n+        cache: 'no-cache'\n+      })\n+\n+      clearTimeout(timeoutId)\n+\n+      // no-corsæ¨¡å¼ä¸‹ï¼Œresponse.okæ€»æ˜¯falseï¼Œä½†å¦‚æœæ²¡æœ‰æŠ›å‡ºé”™è¯¯å°±è¯´æ˜è¿æ¥æˆåŠŸ\n+      console.log(`âœ… ç®€åŒ–æµ‹è¯•è¿æ¥æˆåŠŸ: ${url}`)\n+\n+      return {\n+        success: true,\n+        endpoint: url.split('/').pop(),\n+        fullUrl: url,\n+        status: 'unknown', // no-corsæ¨¡å¼ä¸‹æ— æ³•è·å–çŠ¶æ€ç \n+        note: 'ç®€åŒ–æ¨¡å¼è¿æ¥æˆåŠŸ',\n+        validated: false // æ— æ³•éªŒè¯å“åº”å†…å®¹\n+      }\n+\n+    } catch (error) {\n+      console.log(`âŒ ç®€åŒ–æµ‹è¯•å¤±è´¥: ${url} - ${error.message}`)\n+      return {\n+        success: false,\n+        error: error.message\n+      }\n+    }\n+  }\n+\n+  /**\n    * æµ‹è¯•æœåŠ¡å™¨åŸºç¡€è¿æ¥ - ä½¿ç”¨å¤šç§æ–¹æ³•ç¡®ä¿å‡†ç¡®æ€§\n    */\n   async testBasicConnection(serverUrl) {\n     const cleanUrl = serverUrl.replace(/\\/$/, '')\n"
                },
                {
                    "date": 1752550456489,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -202,18 +202,18 @@\n \n       const controller = new AbortController()\n       const timeoutId = setTimeout(() => controller.abort(), 5000) // 5ç§’è¶…æ—¶\n \n-      const response = await fetch(url, {\n+      await fetch(url, {\n         method: 'GET',\n         signal: controller.signal,\n         mode: 'no-cors', // ä½¿ç”¨no-corsæ¨¡å¼é¿å…CORSé—®é¢˜\n         cache: 'no-cache'\n       })\n \n       clearTimeout(timeoutId)\n \n-      // no-corsæ¨¡å¼ä¸‹ï¼Œresponse.okæ€»æ˜¯falseï¼Œä½†å¦‚æœæ²¡æœ‰æŠ›å‡ºé”™è¯¯å°±è¯´æ˜è¿æ¥æˆåŠŸ\n+      // no-corsæ¨¡å¼ä¸‹ï¼Œå¦‚æœæ²¡æœ‰æŠ›å‡ºé”™è¯¯å°±è¯´æ˜è¿æ¥æˆåŠŸ\n       console.log(`âœ… ç®€åŒ–æµ‹è¯•è¿æ¥æˆåŠŸ: ${url}`)\n \n       return {\n         success: true,\n"
                },
                {
                    "date": 1752551082574,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,8 +10,9 @@\n     this.healthCheckResults = new Map() // ç¼“å­˜å¥åº·æ£€æŸ¥ç»“æœ\n     this.serverList = [] // æœåŠ¡å™¨åˆ—è¡¨\n     this.lastHealthCheck = 0 // ä¸Šæ¬¡å¥åº·æ£€æŸ¥æ—¶é—´\n     this.healthCheckInterval = 30000 // 30ç§’æ£€æŸ¥ä¸€æ¬¡\n+    this.verboseLogging = false // è¯¦ç»†æ—¥å¿—å¼€å…³\n   }\n \n   /**\n    * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n"
                },
                {
                    "date": 1752551120948,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,9 +18,8 @@\n    * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n    */\n   async initialize() {\n     console.log('ğŸ”§ åˆå§‹åŒ–ComfyUIè´Ÿè½½å‡è¡¡å™¨...')\n-    console.log('ğŸ“‹ ä½¿ç”¨å®˜æ–¹ç«¯ç‚¹é…ç½®:', comfyUIConfig.getHealthCheckEndpoints())\n \n     // è·å–æœåŠ¡å™¨åˆ—è¡¨\n     await this.loadServerList()\n \n"
                },
                {
                    "date": 1752551138273,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -42,9 +42,11 @@\n         this.serverList.push({\n           url: config['comfyui.server_url'].replace(/\\/$/, ''),\n           type: 'primary',\n           healthy: null,\n-          lastCheck: 0\n+          lastCheck: 0,\n+          queueInfo: { running: 0, pending: 0, total: 0 },\n+          systemInfo: null\n         })\n       }\n \n       // å¤‡ç”¨æœåŠ¡å™¨\n"
                },
                {
                    "date": 1752551153519,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -60,9 +60,11 @@\n           this.serverList.push({\n             url,\n             type: 'backup',\n             healthy: null,\n-            lastCheck: 0\n+            lastCheck: 0,\n+            queueInfo: { running: 0, pending: 0, total: 0 },\n+            systemInfo: null\n           })\n         })\n       }\n \n"
                },
                {
                    "date": 1752551171754,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -67,12 +67,9 @@\n           })\n         })\n       }\n \n-      console.log(`ğŸ“Š åŠ è½½äº† ${this.serverList.length} ä¸ªæœåŠ¡å™¨:`)\n-      this.serverList.forEach((server, index) => {\n-        console.log(`   ${index + 1}. ${server.type}: ${server.url}`)\n-      })\n+      console.log(`ğŸ“Š åŠ è½½äº† ${this.serverList.length} ä¸ªæœåŠ¡å™¨`)\n \n     } catch (error) {\n       console.error('âŒ åŠ è½½æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥:', error)\n       // ä½¿ç”¨é»˜è®¤æœåŠ¡å™¨\n"
                },
                {
                    "date": 1752551189500,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -76,9 +76,11 @@\n       this.serverList = [{\n         url: comfyUIConfig.BASE_URL.replace(/\\/$/, ''),\n         type: 'default',\n         healthy: null,\n-        lastCheck: 0\n+        lastCheck: 0,\n+        queueInfo: { running: 0, pending: 0, total: 0 },\n+        systemInfo: null\n       }]\n       console.log('ğŸ“Š ä½¿ç”¨é»˜è®¤æœåŠ¡å™¨:', this.serverList[0].url)\n     }\n   }\n"
                },
                {
                    "date": 1752551214922,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -121,9 +121,9 @@\n     await this.refreshHealthStatus()\n   }\n \n   /**\n-   * è·å–æœ€ä¼˜æœåŠ¡å™¨\n+   * è·å–æœ€ä¼˜æœåŠ¡å™¨ - åŸºäºé˜Ÿåˆ—æ•°é‡çš„è´Ÿè½½å‡è¡¡\n    */\n   async getOptimalServer() {\n     // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°å¥åº·çŠ¶æ€\n     const now = Date.now()\n@@ -131,29 +131,34 @@\n       await this.refreshHealthStatus()\n       this.lastHealthCheck = now\n     }\n \n-    // ä¼˜å…ˆè¿”å›å¥åº·çš„ä¸»æœåŠ¡å™¨\n-    const primaryServers = this.serverList.filter(s => s.type === 'primary' && s.healthy === true)\n-    if (primaryServers.length > 0) {\n-      return primaryServers[0].url\n-    }\n+    // è·å–æ‰€æœ‰å¥åº·çš„æœåŠ¡å™¨\n+    const healthyServers = this.serverList.filter(s => s.healthy === true)\n \n-    // ç„¶åè¿”å›å¥åº·çš„å¤‡ç”¨æœåŠ¡å™¨\n-    const backupServers = this.serverList.filter(s => s.type === 'backup' && s.healthy === true)\n-    if (backupServers.length > 0) {\n-      return backupServers[0].url\n+    if (healthyServers.length === 0) {\n+      console.warn('âš ï¸ æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæœåŠ¡å™¨')\n+      return this.serverList.length > 0 ? this.serverList[0].url : comfyUIConfig.BASE_URL\n     }\n \n-    // å¦‚æœæ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨ï¼Œè¿”å›ç¬¬ä¸€ä¸ªæœåŠ¡å™¨ï¼ˆå¯èƒ½æ˜¯é»˜è®¤æœåŠ¡å™¨ï¼‰\n-    if (this.serverList.length > 0) {\n-      console.warn('âš ï¸ æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæœåŠ¡å™¨')\n-      return this.serverList[0].url\n+    // æŒ‰ä¼˜å…ˆçº§å’Œé˜Ÿåˆ—æ•°é‡æ’åºé€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n+    const sortedServers = healthyServers.sort((a, b) => {\n+      // 1. ä¼˜å…ˆçº§ï¼šprimary > backup > default\n+      const priorityOrder = { 'primary': 0, 'backup': 1, 'default': 2 }\n+      const priorityDiff = priorityOrder[a.type] - priorityOrder[b.type]\n+      if (priorityDiff !== 0) return priorityDiff\n+\n+      // 2. ç›¸åŒä¼˜å…ˆçº§ä¸‹ï¼Œé€‰æ‹©é˜Ÿåˆ—æœ€å°‘çš„æœåŠ¡å™¨\n+      return a.queueInfo.total - b.queueInfo.total\n+    })\n+\n+    const selectedServer = sortedServers[0]\n+\n+    if (this.verboseLogging) {\n+      console.log(`ğŸ¯ é€‰æ‹©æœåŠ¡å™¨: ${selectedServer.url} (é˜Ÿåˆ—: ${selectedServer.queueInfo.total})`)\n     }\n \n-    // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆ\n-    console.warn('âš ï¸ æ²¡æœ‰é…ç½®çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®')\n-    return comfyUIConfig.BASE_URL\n+    return selectedServer.url\n   }\n \n   /**\n    * åˆ·æ–°æ‰€æœ‰æœåŠ¡å™¨çš„å¥åº·çŠ¶æ€\n"
                },
                {
                    "date": 1752551237157,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -163,29 +163,41 @@\n   /**\n    * åˆ·æ–°æ‰€æœ‰æœåŠ¡å™¨çš„å¥åº·çŠ¶æ€\n    */\n   async refreshHealthStatus() {\n-    console.log('ğŸ”„ åˆ·æ–°æœåŠ¡å™¨å¥åº·çŠ¶æ€...')\n+    if (this.verboseLogging) {\n+      console.log('ğŸ”„ åˆ·æ–°æœåŠ¡å™¨å¥åº·çŠ¶æ€...')\n+    }\n \n     const promises = this.serverList.map(async (server) => {\n       try {\n         const result = await this.testComfyUIEndpoints(server.url)\n         server.healthy = result.success\n         server.lastCheck = Date.now()\n \n-        if (result.success) {\n-          console.log(`âœ… æœåŠ¡å™¨å¥åº·: ${server.url}`)\n-        } else {\n-          console.log(`âŒ æœåŠ¡å™¨å¼‚å¸¸: ${server.url}`)\n+        // æ›´æ–°é˜Ÿåˆ—å’Œç³»ç»Ÿä¿¡æ¯\n+        if (result.success && result.data) {\n+          if (result.endpoint.includes('queue')) {\n+            server.queueInfo = comfyUIConfig.parseQueueInfo(result.data)\n+          } else if (result.endpoint.includes('system_stats')) {\n+            server.systemInfo = comfyUIConfig.parseSystemInfo(result.data)\n+          }\n         }\n+\n       } catch (error) {\n         server.healthy = false\n         server.lastCheck = Date.now()\n-        console.log(`âŒ æœåŠ¡å™¨æ£€æŸ¥å¤±è´¥: ${server.url} - ${error.message}`)\n+        server.queueInfo = { running: 0, pending: 0, total: 0 }\n+        if (this.verboseLogging) {\n+          console.log(`âŒ æœåŠ¡å™¨æ£€æŸ¥å¤±è´¥: ${server.url} - ${error.message}`)\n+        }\n       }\n     })\n \n     await Promise.all(promises)\n+\n+    // æ˜¾ç¤ºç®€åŒ–çš„æœåŠ¡å™¨çŠ¶æ€\n+    this.logServerStatus()\n   }\n \n   /**\n    * è®°å½•æœåŠ¡å™¨å¤±è´¥\n"
                },
                {
                    "date": 1752551257210,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -199,8 +199,52 @@\n     this.logServerStatus()\n   }\n \n   /**\n+   * æ˜¾ç¤ºç®€åŒ–çš„æœåŠ¡å™¨çŠ¶æ€æ—¥å¿—\n+   */\n+  logServerStatus() {\n+    const healthyServers = this.serverList.filter(s => s.healthy === true)\n+    const totalServers = this.serverList.length\n+\n+    if (healthyServers.length === 0) {\n+      console.warn(`âš ï¸ æœåŠ¡å™¨çŠ¶æ€: 0/${totalServers} å¯ç”¨`)\n+      return\n+    }\n+\n+    console.log(`âœ… æœåŠ¡å™¨çŠ¶æ€: ${healthyServers.length}/${totalServers} å¯ç”¨`)\n+\n+    // æ˜¾ç¤ºå¯ç”¨æœåŠ¡å™¨çš„é˜Ÿåˆ—ä¿¡æ¯\n+    healthyServers.forEach(server => {\n+      const queueText = server.queueInfo.total > 0\n+        ? `é˜Ÿåˆ—: ${server.queueInfo.running}è¿è¡Œ/${server.queueInfo.pending}ç­‰å¾…`\n+        : 'é˜Ÿåˆ—: ç©ºé—²'\n+\n+      console.log(`  ğŸ“Š ${server.type}: ${queueText}`)\n+    })\n+  }\n+\n+  /**\n+   * è·å–æœåŠ¡å™¨çŠ¶æ€æ‘˜è¦\n+   */\n+  getServerStatusSummary() {\n+    const healthyServers = this.serverList.filter(s => s.healthy === true)\n+    const totalQueue = healthyServers.reduce((sum, server) => sum + server.queueInfo.total, 0)\n+\n+    return {\n+      total: this.serverList.length,\n+      healthy: healthyServers.length,\n+      totalQueue,\n+      servers: healthyServers.map(server => ({\n+        url: server.url,\n+        type: server.type,\n+        queueInfo: server.queueInfo,\n+        systemInfo: server.systemInfo\n+      }))\n+    }\n+  }\n+\n+  /**\n    * è®°å½•æœåŠ¡å™¨å¤±è´¥\n    */\n   async recordFailure(serverUrl, errorType = 'unknown') {\n     console.log(`ğŸ“ è®°å½•æœåŠ¡å™¨å¤±è´¥: ${serverUrl} (${errorType})`)\n"
                },
                {
                    "date": 1752551274429,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -378,10 +378,11 @@\n   async testComfyUIEndpoints(serverUrl) {\n     const cleanUrl = serverUrl.replace(/\\/$/, '')\n     const endpoints = comfyUIConfig.getHealthCheckEndpoints()\n \n-    console.log(`ğŸ” æµ‹è¯•ComfyUIç«¯ç‚¹: ${cleanUrl}`)\n-    console.log(`ğŸ“‹ ä½¿ç”¨ç«¯ç‚¹åˆ—è¡¨:`, endpoints)\n+    if (this.verboseLogging) {\n+      console.log(`ğŸ” æµ‹è¯•ComfyUIç«¯ç‚¹: ${cleanUrl}`)\n+    }\n \n     for (const endpoint of endpoints) {\n       try {\n         const fullUrl = `${cleanUrl}${endpoint}`\n"
                },
                {
                    "date": 1752551291071,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -385,9 +385,11 @@\n \n     for (const endpoint of endpoints) {\n       try {\n         const fullUrl = `${cleanUrl}${endpoint}`\n-        console.log(`   æµ‹è¯•ç«¯ç‚¹: ${endpoint}`)\n+        if (this.verboseLogging) {\n+          console.log(`   æµ‹è¯•ç«¯ç‚¹: ${endpoint}`)\n+        }\n \n         const controller = new AbortController()\n         const timeoutId = setTimeout(() => controller.abort(), this.connectionTimeout)\n \n"
                },
                {
                    "date": 1752551311322,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -412,10 +412,12 @@\n             // ä½¿ç”¨ç»Ÿä¸€çš„å“åº”éªŒè¯\n             const isValidResponse = comfyUIConfig.validateResponse(endpoint, data)\n \n             if (isValidResponse) {\n-              console.log(`âœ… ComfyUIç«¯ç‚¹å¯ç”¨: ${endpoint}`)\n-              console.log(`   å“åº”æ•°æ®ç»“æ„:`, Object.keys(data))\n+              if (this.verboseLogging) {\n+                console.log(`âœ… ComfyUIç«¯ç‚¹å¯ç”¨: ${endpoint}`)\n+                console.log(`   å“åº”æ•°æ®ç»“æ„:`, Object.keys(data))\n+              }\n \n               return {\n                 success: true,\n                 endpoint,\n@@ -426,9 +428,11 @@\n                 data: data,\n                 validated: true\n               }\n             } else {\n-              console.log(`âš ï¸ ç«¯ç‚¹å“åº”ä½†éªŒè¯å¤±è´¥: ${endpoint} - ä¸æ˜¯æœ‰æ•ˆçš„ComfyUIå“åº”`)\n+              if (this.verboseLogging) {\n+                console.log(`âš ï¸ ç«¯ç‚¹å“åº”ä½†éªŒè¯å¤±è´¥: ${endpoint} - ä¸æ˜¯æœ‰æ•ˆçš„ComfyUIå“åº”`)\n+              }\n               continue\n             }\n           } catch (jsonError) {\n             console.log(`âš ï¸ ç«¯ç‚¹å“åº”ä½†JSONè§£æå¤±è´¥: ${endpoint} - ${jsonError.message}`)\n"
                },
                {
                    "date": 1752551327864,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -434,9 +434,11 @@\n               }\n               continue\n             }\n           } catch (jsonError) {\n-            console.log(`âš ï¸ ç«¯ç‚¹å“åº”ä½†JSONè§£æå¤±è´¥: ${endpoint} - ${jsonError.message}`)\n+            if (this.verboseLogging) {\n+              console.log(`âš ï¸ ç«¯ç‚¹å“åº”ä½†JSONè§£æå¤±è´¥: ${endpoint} - ${jsonError.message}`)\n+            }\n             continue\n           }\n         } else {\n           console.log(`âš ï¸ ç«¯ç‚¹å“åº”é”™è¯¯: ${endpoint} (çŠ¶æ€: ${response.status})`)\n"
                },
                {
                    "date": 1752551364869,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -440,9 +440,11 @@\n             }\n             continue\n           }\n         } else {\n-          console.log(`âš ï¸ ç«¯ç‚¹å“åº”é”™è¯¯: ${endpoint} (çŠ¶æ€: ${response.status})`)\n+          if (this.verboseLogging) {\n+            console.log(`âš ï¸ ç«¯ç‚¹å“åº”é”™è¯¯: ${endpoint} (çŠ¶æ€: ${response.status})`)\n+          }\n         }\n       } catch (error) {\n         console.log(`âŒ ç«¯ç‚¹æµ‹è¯•å¤±è´¥: ${endpoint} - ${error.message}`)\n \n"
                },
                {
                    "date": 1752551384376,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -445,21 +445,29 @@\n             console.log(`âš ï¸ ç«¯ç‚¹å“åº”é”™è¯¯: ${endpoint} (çŠ¶æ€: ${response.status})`)\n           }\n         }\n       } catch (error) {\n-        console.log(`âŒ ç«¯ç‚¹æµ‹è¯•å¤±è´¥: ${endpoint} - ${error.message}`)\n+        if (this.verboseLogging) {\n+          console.log(`âŒ ç«¯ç‚¹æµ‹è¯•å¤±è´¥: ${endpoint} - ${error.message}`)\n+        }\n \n         // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œå°è¯•ç®€åŒ–çš„è¯·æ±‚\n         if (error.message.includes('Failed to fetch') || error.message.includes('ERR_FAILED')) {\n-          console.log(`ğŸ”„ å°è¯•ç®€åŒ–è¯·æ±‚: ${endpoint}`)\n+          if (this.verboseLogging) {\n+            console.log(`ğŸ”„ å°è¯•ç®€åŒ–è¯·æ±‚: ${endpoint}`)\n+          }\n           try {\n             const simpleResponse = await this.testSimpleEndpoint(fullUrl)\n             if (simpleResponse.success) {\n-              console.log(`âœ… ç®€åŒ–è¯·æ±‚æˆåŠŸ: ${endpoint}`)\n+              if (this.verboseLogging) {\n+                console.log(`âœ… ç®€åŒ–è¯·æ±‚æˆåŠŸ: ${endpoint}`)\n+              }\n               return simpleResponse\n             }\n           } catch (simpleError) {\n-            console.log(`âŒ ç®€åŒ–è¯·æ±‚ä¹Ÿå¤±è´¥: ${simpleError.message}`)\n+            if (this.verboseLogging) {\n+              console.log(`âŒ ç®€åŒ–è¯·æ±‚ä¹Ÿå¤±è´¥: ${simpleError.message}`)\n+            }\n           }\n         }\n \n         continue\n"
                },
                {
                    "date": 1752551400733,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -112,8 +112,16 @@\n     return servers\n   }\n \n   /**\n+   * å¯ç”¨/ç¦ç”¨è¯¦ç»†æ—¥å¿—\n+   */\n+  setVerboseLogging(enabled) {\n+    this.verboseLogging = enabled\n+    console.log(`ğŸ“ è¯¦ç»†æ—¥å¿—å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`)\n+  }\n+\n+  /**\n    * åˆå§‹åŒ–æœåŠ¡å™¨è¿æ¥ï¼ˆå…¼å®¹æ—§æ¥å£ï¼‰\n    */\n   async initializeServerConnection() {\n     console.log('ğŸ”— åˆå§‹åŒ–æœåŠ¡å™¨è¿æ¥...')\n"
                },
                {
                    "date": 1752553464817,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -130,22 +130,30 @@\n   }\n \n   /**\n    * è·å–æœ€ä¼˜æœåŠ¡å™¨ - åŸºäºé˜Ÿåˆ—æ•°é‡çš„è´Ÿè½½å‡è¡¡\n+   * @param {Array} excludeUrls - è¦æ’é™¤çš„æœåŠ¡å™¨URLåˆ—è¡¨\n    */\n-  async getOptimalServer() {\n+  async getOptimalServer(excludeUrls = []) {\n     // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°å¥åº·çŠ¶æ€\n     const now = Date.now()\n     if (now - this.lastHealthCheck > this.healthCheckInterval) {\n       await this.refreshHealthStatus()\n       this.lastHealthCheck = now\n     }\n \n-    // è·å–æ‰€æœ‰å¥åº·çš„æœåŠ¡å™¨\n-    const healthyServers = this.serverList.filter(s => s.healthy === true)\n+    // è·å–æ‰€æœ‰å¥åº·çš„æœåŠ¡å™¨ï¼Œæ’é™¤æŒ‡å®šçš„æœåŠ¡å™¨\n+    const healthyServers = this.serverList.filter(s =>\n+      s.healthy === true && !excludeUrls.includes(s.url)\n+    )\n \n     if (healthyServers.length === 0) {\n-      console.warn('âš ï¸ æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæœåŠ¡å™¨')\n+      console.warn('âš ï¸ æ²¡æœ‰å¯ç”¨çš„å¥åº·æœåŠ¡å™¨ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæœåŠ¡å™¨')\n+      // å¦‚æœæ‰€æœ‰æœåŠ¡å™¨éƒ½è¢«æ’é™¤ï¼Œåˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªæœªè¢«æ’é™¤çš„æœåŠ¡å™¨\n+      const fallbackServers = this.serverList.filter(s => !excludeUrls.includes(s.url))\n+      if (fallbackServers.length > 0) {\n+        return fallbackServers[0].url\n+      }\n       return this.serverList.length > 0 ? this.serverList[0].url : comfyUIConfig.BASE_URL\n     }\n \n     // æŒ‰ä¼˜å…ˆçº§å’Œé˜Ÿåˆ—æ•°é‡æ’åºé€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n@@ -162,8 +170,11 @@\n     const selectedServer = sortedServers[0]\n \n     if (this.verboseLogging) {\n       console.log(`ğŸ¯ é€‰æ‹©æœåŠ¡å™¨: ${selectedServer.url} (é˜Ÿåˆ—: ${selectedServer.queueInfo.total})`)\n+      if (excludeUrls.length > 0) {\n+        console.log(`ğŸš« æ’é™¤çš„æœåŠ¡å™¨: ${excludeUrls.join(', ')}`)\n+      }\n     }\n \n     return selectedServer.url\n   }\n"
                },
                {
                    "date": 1752553580032,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -262,8 +262,27 @@\n     }\n   }\n \n   /**\n+   * æ˜¾ç¤ºå½“å‰è´Ÿè½½å‡è¡¡çŠ¶æ€ï¼ˆé¡µé¢åŠ è½½æ—¶è°ƒç”¨ï¼‰\n+   */\n+  async showLoadBalancingStatus() {\n+    console.log('ğŸ¯ è´Ÿè½½å‡è¡¡çŠ¶æ€æ£€æŸ¥...')\n+\n+    // åˆ·æ–°æœåŠ¡å™¨çŠ¶æ€\n+    await this.refreshHealthStatus()\n+\n+    // è·å–æœ€ä¼˜æœåŠ¡å™¨\n+    const optimalServer = await this.getOptimalServer()\n+\n+    console.log('ğŸ“Š è´Ÿè½½å‡è¡¡ç»“æœ:')\n+    console.log(`ğŸ¯ å½“å‰æœ€ä¼˜æœåŠ¡å™¨: ${optimalServer}`)\n+\n+    // æ˜¾ç¤ºæ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€\n+    this.logServerStatus()\n+  }\n+\n+  /**\n    * è®°å½•æœåŠ¡å™¨å¤±è´¥\n    */\n   async recordFailure(serverUrl, errorType = 'unknown') {\n     console.log(`ğŸ“ è®°å½•æœåŠ¡å™¨å¤±è´¥: ${serverUrl} (${errorType})`)\n"
                },
                {
                    "date": 1752555358670,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -130,30 +130,22 @@\n   }\n \n   /**\n    * è·å–æœ€ä¼˜æœåŠ¡å™¨ - åŸºäºé˜Ÿåˆ—æ•°é‡çš„è´Ÿè½½å‡è¡¡\n-   * @param {Array} excludeUrls - è¦æ’é™¤çš„æœåŠ¡å™¨URLåˆ—è¡¨\n    */\n-  async getOptimalServer(excludeUrls = []) {\n+  async getOptimalServer() {\n     // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°å¥åº·çŠ¶æ€\n     const now = Date.now()\n     if (now - this.lastHealthCheck > this.healthCheckInterval) {\n       await this.refreshHealthStatus()\n       this.lastHealthCheck = now\n     }\n \n-    // è·å–æ‰€æœ‰å¥åº·çš„æœåŠ¡å™¨ï¼Œæ’é™¤æŒ‡å®šçš„æœåŠ¡å™¨\n-    const healthyServers = this.serverList.filter(s =>\n-      s.healthy === true && !excludeUrls.includes(s.url)\n-    )\n+    // è·å–æ‰€æœ‰å¥åº·çš„æœåŠ¡å™¨\n+    const healthyServers = this.serverList.filter(s => s.healthy === true)\n \n     if (healthyServers.length === 0) {\n       console.warn('âš ï¸ æ²¡æœ‰å¯ç”¨çš„å¥åº·æœåŠ¡å™¨ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæœåŠ¡å™¨')\n-      // å¦‚æœæ‰€æœ‰æœåŠ¡å™¨éƒ½è¢«æ’é™¤ï¼Œåˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªæœªè¢«æ’é™¤çš„æœåŠ¡å™¨\n-      const fallbackServers = this.serverList.filter(s => !excludeUrls.includes(s.url))\n-      if (fallbackServers.length > 0) {\n-        return fallbackServers[0].url\n-      }\n       return this.serverList.length > 0 ? this.serverList[0].url : comfyUIConfig.BASE_URL\n     }\n \n     // æŒ‰ä¼˜å…ˆçº§å’Œé˜Ÿåˆ—æ•°é‡æ’åºé€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n@@ -168,14 +160,9 @@\n     })\n \n     const selectedServer = sortedServers[0]\n \n-    if (this.verboseLogging) {\n-      console.log(`ğŸ¯ é€‰æ‹©æœåŠ¡å™¨: ${selectedServer.url} (é˜Ÿåˆ—: ${selectedServer.queueInfo.total})`)\n-      if (excludeUrls.length > 0) {\n-        console.log(`ğŸš« æ’é™¤çš„æœåŠ¡å™¨: ${excludeUrls.join(', ')}`)\n-      }\n-    }\n+    console.log(`ğŸ¯ é€‰æ‹©æœåŠ¡å™¨: ${selectedServer.url} (é˜Ÿåˆ—: ${selectedServer.queueInfo.total})`)\n \n     return selectedServer.url\n   }\n \n"
                },
                {
                    "date": 1752557175474,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -336,16 +336,9 @@\n \n       const startTime = Date.now()\n       const response = await fetch(cleanUrl, {\n         method: 'HEAD',\n-        signal: controller.signal,\n-        headers: {\n-          'Accept': '*/*',\n-          'Cache-Control': 'no-cache',\n-          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'\n-        },\n-        mode: 'cors',\n-        credentials: 'omit'\n+        signal: controller.signal\n       })\n \n       clearTimeout(timeoutId)\n       const responseTime = Date.now() - startTime\n"
                },
                {
                    "date": 1752557205220,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -363,12 +363,9 @@\n \n       const startTime = Date.now()\n       const response = await fetch(cleanUrl, {\n         method: 'GET',\n-        signal: controller.signal,\n-        headers: comfyUIConfig.HEALTH_CHECK.HEADERS,\n-        mode: 'cors',\n-        credentials: 'omit'\n+        signal: controller.signal\n       })\n \n       clearTimeout(timeoutId)\n       const responseTime = Date.now() - startTime\n"
                },
                {
                    "date": 1752557236822,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -409,13 +409,9 @@\n         const timeoutId = setTimeout(() => controller.abort(), this.connectionTimeout)\n \n         const response = await fetch(fullUrl, {\n           method: 'GET',\n-          signal: controller.signal,\n-          headers: comfyUIConfig.HEALTH_CHECK.HEADERS,\n-          mode: 'cors',\n-          credentials: 'omit',\n-          cache: 'no-cache'\n+          signal: controller.signal\n         })\n \n         clearTimeout(timeoutId)\n \n"
                },
                {
                    "date": 1752557254956,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -293,11 +293,9 @@\n       const timeoutId = setTimeout(() => controller.abort(), 5000) // 5ç§’è¶…æ—¶\n \n       await fetch(url, {\n         method: 'GET',\n-        signal: controller.signal,\n-        mode: 'no-cors', // ä½¿ç”¨no-corsæ¨¡å¼é¿å…CORSé—®é¢˜\n-        cache: 'no-cache'\n+        signal: controller.signal\n       })\n \n       clearTimeout(timeoutId)\n \n"
                }
            ],
            "date": 1752333548051,
            "name": "Commit-0",
            "content": "// ComfyUI è´Ÿè½½å‡è¡¡å™¨ - åŸºäºä»»åŠ¡é˜Ÿåˆ—çš„æ™ºèƒ½é€‰æ‹©\nimport configService from './configService.js'\n\n/**\n * ComfyUI è´Ÿè½½å‡è¡¡å™¨\n * æ ¹æ®æœåŠ¡å™¨ä»»åŠ¡é˜Ÿåˆ—æƒ…å†µé€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n */\nclass ComfyUILoadBalancer {\n  constructor() {\n    this.servers = []\n    this.serverLoads = new Map()\n    this.lockedServer = null\n    this.lastLockTime = 0\n    this.lockDuration = 30000 // 30ç§’é”å®šæ—¶é—´\n    this.healthCheckTimeout = 10000 // 10ç§’å¥åº·æ£€æŸ¥è¶…æ—¶\n    this.queueCheckTimeout = 5000 // 5ç§’é˜Ÿåˆ—æ£€æŸ¥è¶…æ—¶\n    this.lastUpdateTime = 0\n    this.updateInterval = 15000 // 15ç§’æ›´æ–°é—´éš”\n  }\n\n  /**\n   * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n   */\n  async initialize() {\n    try {\n      console.log('ğŸš€ åˆå§‹åŒ– ComfyUI è´Ÿè½½å‡è¡¡å™¨...')\n\n      // è·å–æœåŠ¡å™¨é…ç½®\n      const config = await configService.getConfig()\n\n      // æ„å»ºæœåŠ¡å™¨åˆ—è¡¨\n      this.servers = []\n\n      // ä¸»æœåŠ¡å™¨\n      if (config['comfyui.server_url']) {\n        this.servers.push({\n          url: config['comfyui.server_url'],\n          type: 'primary',\n          priority: 1\n        })\n      }\n\n      // å¤‡ç”¨æœåŠ¡å™¨\n      if (config['comfyui.backup_servers']) {\n        const backupServers = config['comfyui.backup_servers']\n          .split('\\n')\n          .map(url => url.trim())\n          .filter(url => url && url.startsWith('http'))\n\n        backupServers.forEach((url, index) => {\n          this.servers.push({\n            url,\n            type: 'backup',\n            priority: index + 2\n          })\n        })\n      }\n\n      // å¦‚æœæ²¡æœ‰é…ç½®æœåŠ¡å™¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®\n      if (this.servers.length === 0) {\n        console.warn('âš ï¸ æœªæ‰¾åˆ°é…ç½®çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®')\n        // ä»æœ¬åœ°é…ç½®è·å–é»˜è®¤æœåŠ¡å™¨\n        const localConfig = JSON.parse(localStorage.getItem('comfyui_config') || '{}')\n        const defaultUrl = localConfig.COMFYUI_SERVER_URL || 'https://your-comfyui-server.com'\n\n        this.servers.push({\n          url: defaultUrl,\n          type: 'primary',\n          priority: 1\n        })\n      }\n\n      console.log(`âœ… å‘ç° ${this.servers.length} ä¸ª ComfyUI æœåŠ¡å™¨:`)\n      this.servers.forEach((server, index) => {\n        console.log(`   ${index + 1}. ${server.url} (${server.type})`)\n      })\n\n      // åˆå§‹åŒ–æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n      await this.updateServerLoads()\n\n      console.log('âœ… ComfyUI è´Ÿè½½å‡è¡¡å™¨åˆå§‹åŒ–å®Œæˆ')\n\n    } catch (error) {\n      console.error('âŒ è´Ÿè½½å‡è¡¡å™¨åˆå§‹åŒ–å¤±è´¥:', error)\n      // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸åº”ç”¨ç»§ç»­è¿è¡Œ\n      console.log('ğŸ”„ ä½¿ç”¨é™çº§æ¨¡å¼ï¼Œå°†ä½¿ç”¨å•æœåŠ¡å™¨é…ç½®')\n    }\n  }\n\n  /**\n   * æ›´æ–°æ‰€æœ‰æœåŠ¡å™¨çš„è´Ÿè½½ä¿¡æ¯\n   */\n  async updateServerLoads() {\n    const now = Date.now()\n\n    // å¦‚æœè·ç¦»ä¸Šæ¬¡æ›´æ–°æ—¶é—´ä¸è¶³é—´éš”ï¼Œè·³è¿‡æ›´æ–°\n    if (now - this.lastUpdateTime < this.updateInterval) {\n      console.log('â­ï¸ è·³è¿‡è´Ÿè½½æ›´æ–°ï¼Œè·ç¦»ä¸Šæ¬¡æ›´æ–°æ—¶é—´ä¸è¶³')\n      return\n    }\n\n    console.log('ğŸ”„ æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯...')\n\n    const updatePromises = this.servers.map(async (server) => {\n      try {\n        // å¹¶è¡Œæ£€æŸ¥å¥åº·çŠ¶æ€å’Œé˜Ÿåˆ—ä¿¡æ¯\n        const [healthResult, queueResult] = await Promise.allSettled([\n          this.checkServerHealth(server.url),\n          this.getServerQueueInfo(server.url)\n        ])\n\n        const health = healthResult.status === 'fulfilled' ? healthResult.value : { healthy: false }\n        const queue = queueResult.status === 'fulfilled' ? queueResult.value : { total: 999, healthy: false }\n\n        this.serverLoads.set(server.url, {\n          ...server,\n          healthy: health.healthy && queue.healthy,\n          queue: queue,\n          lastCheck: now,\n          responseTime: health.responseTime || 0\n        })\n\n        console.log(`ğŸ“Š ${server.url}: å¥åº·=${health.healthy}, é˜Ÿåˆ—=${queue.total || 0}`)\n\n      } catch (error) {\n        console.error(`âŒ æ›´æ–°æœåŠ¡å™¨è´Ÿè½½å¤±è´¥ ${server.url}:`, error)\n        this.serverLoads.set(server.url, {\n          ...server,\n          healthy: false,\n          queue: { total: 999, healthy: false },\n          lastCheck: now,\n          error: error.message\n        })\n      }\n    })\n\n    await Promise.allSettled(updatePromises)\n    this.lastUpdateTime = now\n\n    console.log('âœ… æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯æ›´æ–°å®Œæˆ')\n  }\n\n  /**\n   * æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€\n   */\n  async checkServerHealth(serverUrl) {\n    try {\n      const startTime = Date.now()\n\n      const controller = new AbortController()\n      const timeoutId = setTimeout(() => controller.abort(), this.healthCheckTimeout)\n\n      const response = await fetch(`${serverUrl}/system_stats`, {\n        method: 'GET',\n        signal: controller.signal,\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      })\n\n      clearTimeout(timeoutId)\n      const responseTime = Date.now() - startTime\n\n      if (response.ok) {\n        return { healthy: true, responseTime, status: response.status }\n      } else {\n        return { healthy: false, responseTime, status: response.status }\n      }\n\n    } catch (error) {\n      console.warn(`âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ ${serverUrl}:`, error.message)\n      return { healthy: false, error: error.message }\n    }\n  }\n\n  /**\n   * è·å–æœåŠ¡å™¨é˜Ÿåˆ—ä¿¡æ¯\n   */\n  async getServerQueueInfo(serverUrl) {\n    try {\n      const controller = new AbortController()\n      const timeoutId = setTimeout(() => controller.abort(), this.queueCheckTimeout)\n\n      const response = await fetch(`${serverUrl}/queue`, {\n        method: 'GET',\n        signal: controller.signal,\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      })\n\n      clearTimeout(timeoutId)\n\n      if (response.ok) {\n        const queueData = await response.json()\n\n        // ComfyUI é˜Ÿåˆ— API è¿”å›æ ¼å¼: { queue_running: [...], queue_pending: [...] }\n        const running = queueData.queue_running ? queueData.queue_running.length : 0\n        const pending = queueData.queue_pending ? queueData.queue_pending.length : 0\n        const total = running + pending\n\n        return {\n          running,\n          pending,\n          total,\n          healthy: true,\n          supportsQueueAPI: true\n        }\n      } else {\n        // å¦‚æœé˜Ÿåˆ— API ä¸å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨ç³»ç»ŸçŠ¶æ€ä½œä¸ºå¤‡ç”¨\n        return await this.getServerQueueInfoFallback(serverUrl)\n      }\n\n    } catch (error) {\n      console.warn(`âš ï¸ é˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥ ${serverUrl}:`, error.message)\n      return await this.getServerQueueInfoFallback(serverUrl)\n    }\n  }\n\n  /**\n   * å¤‡ç”¨é˜Ÿåˆ—ä¿¡æ¯è·å–æ–¹æ³•\n   */\n  async getServerQueueInfoFallback(serverUrl) {\n    try {\n      const controller = new AbortController()\n      const timeoutId = setTimeout(() => controller.abort(), this.queueCheckTimeout)\n\n      const response = await fetch(`${serverUrl}/system_stats`, {\n        method: 'GET',\n        signal: controller.signal\n      })\n\n      clearTimeout(timeoutId)\n\n      if (response.ok) {\n        // å¦‚æœæ— æ³•è·å–ç²¾ç¡®é˜Ÿåˆ—ä¿¡æ¯ï¼Œå‡è®¾æœåŠ¡å™¨å¯ç”¨ä½†é˜Ÿåˆ—æœªçŸ¥\n        return {\n          running: 0,\n          pending: 0,\n          total: 0,\n          healthy: true,\n          supportsQueueAPI: false\n        }\n      }\n    } catch (error) {\n      // å¿½ç•¥é”™è¯¯\n    }\n\n    return {\n      running: 0,\n      pending: 0,\n      total: 999, // é«˜å€¼è¡¨ç¤ºä¸å¯ç”¨\n      healthy: false,\n      supportsQueueAPI: false\n    }\n  }\n\n  /**\n   * æ ¹æ®æœ€å°é˜Ÿåˆ—é€‰æ‹©æœåŠ¡å™¨\n   */\n  async selectServerByMinQueue() {\n    try {\n      console.log('ğŸ¯ å¼€å§‹é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨...')\n\n      // æ£€æŸ¥æ˜¯å¦æœ‰é”å®šçš„æœåŠ¡å™¨\n      if (this.isServerLocked()) {\n        const lockedServer = this.getLockedServer()\n        if (lockedServer) {\n          console.log(`ğŸ”’ ä½¿ç”¨é”å®šçš„æœåŠ¡å™¨: ${lockedServer}`)\n          return lockedServer\n        }\n      }\n\n      // æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n      await this.updateServerLoads()\n\n      // è·å–æ‰€æœ‰å¥åº·çš„æœåŠ¡å™¨\n      const healthyServers = Array.from(this.serverLoads.values())\n        .filter(server => server.healthy)\n        .sort((a, b) => {\n          // é¦–å…ˆæŒ‰é˜Ÿåˆ—æ•°é‡æ’åº\n          const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n          if (queueDiff !== 0) return queueDiff\n\n          // é˜Ÿåˆ—ç›¸åŒæ—¶æŒ‰ä¼˜å…ˆçº§æ’åº\n          return a.priority - b.priority\n        })\n\n      if (healthyServers.length === 0) {\n        console.warn('âš ï¸ æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨')\n        return await this.fallbackToAnyServer()\n      }\n\n      const selectedServer = healthyServers[0]\n      console.log(`âœ… é€‰æ‹©æœåŠ¡å™¨: ${selectedServer.url} (é˜Ÿåˆ—: ${selectedServer.queue.total || 0})`)\n\n      // é”å®šé€‰ä¸­çš„æœåŠ¡å™¨\n      this.lockServer(selectedServer.url)\n\n      return selectedServer.url\n\n    } catch (error) {\n      console.error('âŒ æœåŠ¡å™¨é€‰æ‹©å¤±è´¥:', error)\n      return await this.fallbackToAnyServer()\n    }\n  }\n\n  /**\n   * å¤‡ç”¨æœåŠ¡å™¨é€‰æ‹©\n   */\n  async fallbackToAnyServer() {\n    console.log('ğŸ”„ ä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨é€‰æ‹©ç­–ç•¥...')\n\n    // æŒ‰ä¼˜å…ˆçº§è¿”å›ç¬¬ä¸€ä¸ªæœåŠ¡å™¨\n    if (this.servers.length > 0) {\n      const fallbackServer = this.servers[0].url\n      console.log(`ğŸ†˜ å¤‡ç”¨æœåŠ¡å™¨: ${fallbackServer}`)\n      return fallbackServer\n    }\n\n    // å¦‚æœæ²¡æœ‰é…ç½®çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨é…ç½®æœåŠ¡çš„é»˜è®¤å€¼\n    const config = await configService.getConfig()\n    const defaultServer = config['comfyui.server_url']\n\n    if (defaultServer) {\n      console.log(`ğŸ†˜ é»˜è®¤æœåŠ¡å™¨: ${defaultServer}`)\n      return defaultServer\n    }\n\n    throw new Error('æ²¡æœ‰å¯ç”¨çš„ ComfyUI æœåŠ¡å™¨')\n  }\n\n  /**\n   * é”å®šæœåŠ¡å™¨\n   */\n  lockServer(serverUrl) {\n    this.lockedServer = serverUrl\n    this.lastLockTime = Date.now()\n    console.log(`ğŸ”’ é”å®šæœåŠ¡å™¨: ${serverUrl}, æŒç»­ ${this.lockDuration / 1000} ç§’`)\n\n    // æ˜¾ç¤ºå½“å‰æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€\n    this.logServerStatus()\n  }\n\n  /**\n   * æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¢«é”å®š\n   */\n  isServerLocked() {\n    if (!this.lockedServer) return false\n\n    const now = Date.now()\n    const isLocked = (now - this.lastLockTime) < this.lockDuration\n\n    if (!isLocked) {\n      console.log('ğŸ”“ æœåŠ¡å™¨é”å®šå·²è¿‡æœŸ')\n      this.lockedServer = null\n      this.lastLockTime = 0\n    }\n\n    return isLocked\n  }\n\n  /**\n   * è·å–é”å®šçš„æœåŠ¡å™¨\n   */\n  getLockedServer() {\n    if (this.isServerLocked()) {\n      return this.lockedServer\n    }\n    return null\n  }\n\n  /**\n   * è®°å½•æœåŠ¡å™¨å¤±è´¥\n   */\n  async recordFailure(serverUrl) {\n    console.log(`ğŸ“ è®°å½•æœåŠ¡å™¨å¤±è´¥: ${serverUrl}`)\n\n    // å¦‚æœå¤±è´¥çš„æ˜¯å½“å‰é”å®šçš„æœåŠ¡å™¨ï¼Œè§£é™¤é”å®š\n    if (this.lockedServer === serverUrl) {\n      console.log('ğŸ”“ è§£é™¤å¤±è´¥æœåŠ¡å™¨çš„é”å®š')\n      this.lockedServer = null\n      this.lastLockTime = 0\n    }\n\n    // æ ‡è®°æœåŠ¡å™¨ä¸ºä¸å¥åº·\n    if (this.serverLoads.has(serverUrl)) {\n      const serverInfo = this.serverLoads.get(serverUrl)\n      serverInfo.healthy = false\n      serverInfo.lastFailure = Date.now()\n      this.serverLoads.set(serverUrl, serverInfo)\n    }\n\n    // å¼ºåˆ¶æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n    this.lastUpdateTime = 0\n  }\n\n  /**\n   * è·å–æœ€ä¼˜æœåŠ¡å™¨ï¼ˆä¸»è¦æ¥å£ï¼‰\n   */\n  async getOptimalServer() {\n    return await this.selectServerByMinQueue()\n  }\n\n  /**\n   * æ˜¾ç¤ºæœåŠ¡å™¨çŠ¶æ€\n   */\n  logServerStatus() {\n    console.log('ğŸ“Š å½“å‰æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€:')\n    for (const [url, info] of this.serverLoads.entries()) {\n      const status = info.healthy ? 'âœ…' : 'âŒ'\n      const queue = info.healthy ? `é˜Ÿåˆ—:${info.queue.total || 0}` : 'ä¸å¥åº·'\n      const locked = url === this.lockedServer ? 'ğŸ”’' : ''\n      const priority = `ä¼˜å…ˆçº§:${info.priority}`\n      console.log(`   ${status} ${url} ${queue} ${priority} ${locked}`)\n    }\n  }\n\n  /**\n   * è·å–æœåŠ¡å™¨ç»Ÿè®¡ä¿¡æ¯\n   */\n  getServerStats() {\n    const stats = {\n      total: this.servers.length,\n      healthy: 0,\n      locked: this.lockedServer,\n      servers: []\n    }\n\n    for (const [url, info] of this.serverLoads.entries()) {\n      if (info.healthy) stats.healthy++\n\n      stats.servers.push({\n        url,\n        healthy: info.healthy,\n        queue: info.queue.total || 0,\n        priority: info.priority,\n        type: info.type,\n        locked: url === this.lockedServer\n      })\n    }\n\n    return stats\n  }\n}\n\n// åˆ›å»ºå•ä¾‹å®ä¾‹\nconst loadBalancer = new ComfyUILoadBalancer()\n\nexport default loadBalancer\n"
        }
    ]
}