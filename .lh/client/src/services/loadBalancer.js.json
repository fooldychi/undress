{
    "sourceFile": "client/src/services/loadBalancer.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 28,
            "patches": [
                {
                    "date": 1752333548051,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752333570869,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -317,18 +317,36 @@\n       console.log(`ğŸ†˜ å¤‡ç”¨æœåŠ¡å™¨: ${fallbackServer}`)\n       return fallbackServer\n     }\n \n-    // å¦‚æœæ²¡æœ‰é…ç½®çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨é…ç½®æœåŠ¡çš„é»˜è®¤å€¼\n-    const config = await configService.getConfig()\n-    const defaultServer = config['comfyui.server_url']\n+    // å¦‚æœæ²¡æœ‰é…ç½®çš„æœåŠ¡å™¨ï¼Œå°è¯•å¤šç§æ–¹å¼è·å–é»˜è®¤å€¼\n+    try {\n+      const config = await configService.getConfig()\n+      const defaultServer = config['comfyui.server_url']\n \n-    if (defaultServer) {\n-      console.log(`ğŸ†˜ é»˜è®¤æœåŠ¡å™¨: ${defaultServer}`)\n-      return defaultServer\n+      if (defaultServer && defaultServer !== 'https://your-comfyui-server.com') {\n+        console.log(`ğŸ†˜ é…ç½®æœåŠ¡é»˜è®¤æœåŠ¡å™¨: ${defaultServer}`)\n+        return defaultServer\n+      }\n+    } catch (error) {\n+      console.warn('âš ï¸ æ— æ³•ä»é…ç½®æœåŠ¡è·å–é»˜è®¤æœåŠ¡å™¨:', error)\n     }\n \n-    throw new Error('æ²¡æœ‰å¯ç”¨çš„ ComfyUI æœåŠ¡å™¨')\n+    // ä»æœ¬åœ°å­˜å‚¨è·å–\n+    try {\n+      const localConfig = JSON.parse(localStorage.getItem('comfyui_config') || '{}')\n+      if (localConfig.COMFYUI_SERVER_URL) {\n+        console.log(`ğŸ†˜ æœ¬åœ°é…ç½®æœåŠ¡å™¨: ${localConfig.COMFYUI_SERVER_URL}`)\n+        return localConfig.COMFYUI_SERVER_URL\n+      }\n+    } catch (error) {\n+      console.warn('âš ï¸ æ— æ³•ä»æœ¬åœ°å­˜å‚¨è·å–æœåŠ¡å™¨é…ç½®:', error)\n+    }\n+\n+    // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆ\n+    const fallbackUrl = 'https://your-comfyui-server.com'\n+    console.log(`ğŸ†˜ ä½¿ç”¨æœ€åå¤‡ç”¨æœåŠ¡å™¨: ${fallbackUrl}`)\n+    return fallbackUrl\n   }\n \n   /**\n    * é”å®šæœåŠ¡å™¨\n"
                },
                {
                    "date": 1752411161286,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,12 +11,13 @@\n     this.serverLoads = new Map()\n     this.lockedServer = null\n     this.lastLockTime = 0\n     this.lockDuration = 30000 // 30ç§’é”å®šæ—¶é—´\n-    this.healthCheckTimeout = 10000 // 10ç§’å¥åº·æ£€æŸ¥è¶…æ—¶\n-    this.queueCheckTimeout = 5000 // 5ç§’é˜Ÿåˆ—æ£€æŸ¥è¶…æ—¶\n+    this.healthCheckTimeout = 15000 // 15ç§’å¥åº·æ£€æŸ¥è¶…æ—¶\n+    this.queueCheckTimeout = 8000 // 8ç§’é˜Ÿåˆ—æ£€æŸ¥è¶…æ—¶\n     this.lastUpdateTime = 0\n-    this.updateInterval = 15000 // 15ç§’æ›´æ–°é—´éš”\n+    this.updateInterval = 10000 // 10ç§’æ›´æ–°é—´éš”ï¼ˆæ›´é¢‘ç¹çš„æ›´æ–°ï¼‰\n+    this.forceUpdateThreshold = 30000 // 30ç§’å¼ºåˆ¶æ›´æ–°é˜ˆå€¼\n   }\n \n   /**\n    * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n"
                },
                {
                    "date": 1752411179957,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -90,17 +90,23 @@\n \n   /**\n    * æ›´æ–°æ‰€æœ‰æœåŠ¡å™¨çš„è´Ÿè½½ä¿¡æ¯\n    */\n-  async updateServerLoads() {\n+  async updateServerLoads(forceUpdate = false) {\n     const now = Date.now()\n \n-    // å¦‚æœè·ç¦»ä¸Šæ¬¡æ›´æ–°æ—¶é—´ä¸è¶³é—´éš”ï¼Œè·³è¿‡æ›´æ–°\n-    if (now - this.lastUpdateTime < this.updateInterval) {\n+    // å¦‚æœè·ç¦»ä¸Šæ¬¡æ›´æ–°æ—¶é—´ä¸è¶³é—´éš”ï¼Œè·³è¿‡æ›´æ–°ï¼ˆé™¤éå¼ºåˆ¶æ›´æ–°æˆ–è¶…è¿‡å¼ºåˆ¶æ›´æ–°é˜ˆå€¼ï¼‰\n+    if (!forceUpdate && now - this.lastUpdateTime < this.updateInterval && now - this.lastUpdateTime < this.forceUpdateThreshold) {\n       console.log('â­ï¸ è·³è¿‡è´Ÿè½½æ›´æ–°ï¼Œè·ç¦»ä¸Šæ¬¡æ›´æ–°æ—¶é—´ä¸è¶³')\n       return\n     }\n \n+    // å¦‚æœè¶…è¿‡å¼ºåˆ¶æ›´æ–°é˜ˆå€¼ï¼Œå¼ºåˆ¶æ›´æ–°\n+    if (now - this.lastUpdateTime > this.forceUpdateThreshold) {\n+      console.log('ğŸ”„ å¼ºåˆ¶æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯ï¼ˆè¶…è¿‡å¼ºåˆ¶æ›´æ–°é˜ˆå€¼ï¼‰')\n+      forceUpdate = true\n+    }\n+\n     console.log('ğŸ”„ æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯...')\n \n     const updatePromises = this.servers.map(async (server) => {\n       try {\n"
                },
                {
                    "date": 1752411196288,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -118,14 +118,18 @@\n \n         const health = healthResult.status === 'fulfilled' ? healthResult.value : { healthy: false }\n         const queue = queueResult.status === 'fulfilled' ? queueResult.value : { total: 999, healthy: false }\n \n+        // æ›´æ™ºèƒ½çš„å¥åº·çŠ¶æ€åˆ¤æ–­\n+        const isHealthy = this.determineServerHealth(health, queue, server)\n+\n         this.serverLoads.set(server.url, {\n           ...server,\n-          healthy: health.healthy && queue.healthy,\n+          healthy: isHealthy,\n           queue: queue,\n           lastCheck: now,\n-          responseTime: health.responseTime || 0\n+          responseTime: health.responseTime || 0,\n+          healthDetails: { health, queue }\n         })\n \n         console.log(`ğŸ“Š ${server.url}: å¥åº·=${health.healthy}, é˜Ÿåˆ—=${queue.total || 0}`)\n \n"
                },
                {
                    "date": 1752411215875,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -151,8 +151,33 @@\n     console.log('âœ… æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯æ›´æ–°å®Œæˆ')\n   }\n \n   /**\n+   * æ›´æ™ºèƒ½çš„æœåŠ¡å™¨å¥åº·çŠ¶æ€åˆ¤æ–­\n+   */\n+  determineServerHealth(health, queue, server) {\n+    // å¦‚æœå¥åº·æ£€æŸ¥å®Œå…¨å¤±è´¥ï¼Œæ ‡è®°ä¸ºä¸å¥åº·\n+    if (!health.healthy) {\n+      return false\n+    }\n+\n+    // å¦‚æœé˜Ÿåˆ—æ£€æŸ¥å¤±è´¥ä½†å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œä»ç„¶è®¤ä¸ºæœåŠ¡å™¨å¯ç”¨\n+    // è¿™æ ·å¯ä»¥é¿å…å› ä¸ºé˜Ÿåˆ—APIä¸å¯ç”¨è€Œé”™è¯¯åœ°æ ‡è®°æœåŠ¡å™¨ä¸ºä¸å¥åº·\n+    if (!queue.healthy) {\n+      console.log(`âš ï¸ æœåŠ¡å™¨ ${server.url} é˜Ÿåˆ—æ£€æŸ¥å¤±è´¥ï¼Œä½†å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œä»æ ‡è®°ä¸ºå¯ç”¨`)\n+      return true\n+    }\n+\n+    // å¦‚æœé˜Ÿåˆ—è¿‡é•¿ï¼ˆè¶…è¿‡10ä¸ªä»»åŠ¡ï¼‰ï¼Œé™ä½ä¼˜å…ˆçº§ä½†ä¸æ ‡è®°ä¸ºä¸å¥åº·\n+    if (queue.total > 10) {\n+      console.log(`âš ï¸ æœåŠ¡å™¨ ${server.url} é˜Ÿåˆ—è¾ƒé•¿ (${queue.total})ï¼Œä½†ä»å¯ç”¨`)\n+      return true\n+    }\n+\n+    return true\n+  }\n+\n+  /**\n    * æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€\n    */\n   async checkServerHealth(serverUrl) {\n     try {\n"
                },
                {
                    "date": 1752411238444,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -306,13 +306,13 @@\n           return lockedServer\n         }\n       }\n \n-      // æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n+      // æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯ï¼ˆå¦‚æœæ²¡æœ‰å¥åº·æœåŠ¡å™¨ï¼Œå¼ºåˆ¶æ›´æ–°ï¼‰\n       await this.updateServerLoads()\n \n       // è·å–æ‰€æœ‰å¥åº·çš„æœåŠ¡å™¨\n-      const healthyServers = Array.from(this.serverLoads.values())\n+      let healthyServers = Array.from(this.serverLoads.values())\n         .filter(server => server.healthy)\n         .sort((a, b) => {\n           // é¦–å…ˆæŒ‰é˜Ÿåˆ—æ•°é‡æ’åº\n           const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n@@ -321,10 +321,24 @@\n           // é˜Ÿåˆ—ç›¸åŒæ—¶æŒ‰ä¼˜å…ˆçº§æ’åº\n           return a.priority - b.priority\n         })\n \n+      // å¦‚æœæ²¡æœ‰å¥åº·æœåŠ¡å™¨ï¼Œå¼ºåˆ¶æ›´æ–°ä¸€æ¬¡å†è¯•\n       if (healthyServers.length === 0) {\n-        console.warn('âš ï¸ æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨')\n+        console.warn('âš ï¸ æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨ï¼Œå¼ºåˆ¶æ›´æ–°åé‡è¯•...')\n+        await this.updateServerLoads(true) // å¼ºåˆ¶æ›´æ–°\n+\n+        healthyServers = Array.from(this.serverLoads.values())\n+          .filter(server => server.healthy)\n+          .sort((a, b) => {\n+            const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n+            if (queueDiff !== 0) return queueDiff\n+            return a.priority - b.priority\n+          })\n+      }\n+\n+      if (healthyServers.length === 0) {\n+        console.warn('âš ï¸ å¼ºåˆ¶æ›´æ–°åä»æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨')\n         return await this.fallbackToAnyServer()\n       }\n \n       const selectedServer = healthyServers[0]\n"
                },
                {
                    "date": 1752411258535,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -360,9 +360,23 @@\n    */\n   async fallbackToAnyServer() {\n     console.log('ğŸ”„ ä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨é€‰æ‹©ç­–ç•¥...')\n \n-    // æŒ‰ä¼˜å…ˆçº§è¿”å›ç¬¬ä¸€ä¸ªæœåŠ¡å™¨\n+    // å°è¯•é€‰æ‹©å“åº”æ—¶é—´æœ€å¿«çš„æœåŠ¡å™¨ï¼ˆå³ä½¿é˜Ÿåˆ—è¾ƒé•¿ï¼‰\n+    const serversWithResponse = Array.from(this.serverLoads.values())\n+      .filter(server => server.responseTime > 0) // è‡³å°‘æœ‰å“åº”\n+      .sort((a, b) => {\n+        // æŒ‰å“åº”æ—¶é—´æ’åº\n+        return a.responseTime - b.responseTime\n+      })\n+\n+    if (serversWithResponse.length > 0) {\n+      const fastestServer = serversWithResponse[0]\n+      console.log(`ğŸ†˜ é€‰æ‹©å“åº”æœ€å¿«çš„æœåŠ¡å™¨: ${fastestServer.url} (å“åº”æ—¶é—´: ${fastestServer.responseTime}ms, é˜Ÿåˆ—: ${fastestServer.queue.total || 0})`)\n+      return fastestServer.url\n+    }\n+\n+    // å¦‚æœæ²¡æœ‰å“åº”æ•°æ®ï¼ŒæŒ‰ä¼˜å…ˆçº§è¿”å›ç¬¬ä¸€ä¸ªæœåŠ¡å™¨\n     if (this.servers.length > 0) {\n       const fallbackServer = this.servers[0].url\n       console.log(`ğŸ†˜ å¤‡ç”¨æœåŠ¡å™¨: ${fallbackServer}`)\n       return fallbackServer\n"
                },
                {
                    "date": 1752411277869,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -130,9 +130,10 @@\n           responseTime: health.responseTime || 0,\n           healthDetails: { health, queue }\n         })\n \n-        console.log(`ğŸ“Š ${server.url}: å¥åº·=${health.healthy}, é˜Ÿåˆ—=${queue.total || 0}`)\n+        const queueInfo = queue.healthy ? `é˜Ÿåˆ—=${queue.total || 0}(è¿è¡Œ:${queue.running || 0},ç­‰å¾…:${queue.pending || 0})` : `é˜Ÿåˆ—æ£€æŸ¥å¤±è´¥`\n+        console.log(`ğŸ“Š ${server.url}: å¥åº·=${health.healthy}, ${queueInfo}, å“åº”æ—¶é—´=${health.responseTime || 0}ms`)\n \n       } catch (error) {\n         console.error(`âŒ æ›´æ–°æœåŠ¡å™¨è´Ÿè½½å¤±è´¥ ${server.url}:`, error)\n         this.serverLoads.set(server.url, {\n"
                },
                {
                    "date": 1752411297072,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -491,12 +491,16 @@\n   logServerStatus() {\n     console.log('ğŸ“Š å½“å‰æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€:')\n     for (const [url, info] of this.serverLoads.entries()) {\n       const status = info.healthy ? 'âœ…' : 'âŒ'\n-      const queue = info.healthy ? `é˜Ÿåˆ—:${info.queue.total || 0}` : 'ä¸å¥åº·'\n+      const queueInfo = info.queue ?\n+        `é˜Ÿåˆ—:${info.queue.total || 0}(è¿è¡Œ:${info.queue.running || 0},ç­‰å¾…:${info.queue.pending || 0})` :\n+        'é˜Ÿåˆ—:æœªçŸ¥'\n       const locked = url === this.lockedServer ? 'ğŸ”’' : ''\n       const priority = `ä¼˜å…ˆçº§:${info.priority}`\n-      console.log(`   ${status} ${url} ${queue} ${priority} ${locked}`)\n+      const responseTime = info.responseTime ? `å“åº”:${info.responseTime}ms` : 'å“åº”:æœªçŸ¥'\n+      const lastCheck = info.lastCheck ? `æ£€æŸ¥:${Math.round((Date.now() - info.lastCheck) / 1000)}så‰` : 'æ£€æŸ¥:ä»æœª'\n+      console.log(`   ${status} ${url} ${queueInfo} ${priority} ${responseTime} ${lastCheck} ${locked}`)\n     }\n   }\n \n   /**\n"
                },
                {
                    "date": 1752411316946,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -485,8 +485,27 @@\n     return await this.selectServerByMinQueue()\n   }\n \n   /**\n+   * å¼ºåˆ¶é‡æ–°è¯„ä¼°æ‰€æœ‰æœåŠ¡å™¨\n+   */\n+  async forceReassessment() {\n+    console.log('ğŸ”„ å¼ºåˆ¶é‡æ–°è¯„ä¼°æ‰€æœ‰æœåŠ¡å™¨...')\n+\n+    // æ¸…é™¤é”å®šçŠ¶æ€\n+    this.lockedServer = null\n+    this.lastLockTime = 0\n+\n+    // å¼ºåˆ¶æ›´æ–°è´Ÿè½½ä¿¡æ¯\n+    await this.updateServerLoads(true)\n+\n+    // æ˜¾ç¤ºå½“å‰çŠ¶æ€\n+    this.logServerStatus()\n+\n+    console.log('âœ… æœåŠ¡å™¨é‡æ–°è¯„ä¼°å®Œæˆ')\n+  }\n+\n+  /**\n    * æ˜¾ç¤ºæœåŠ¡å™¨çŠ¶æ€\n    */\n   logServerStatus() {\n     console.log('ğŸ“Š å½“å‰æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€:')\n"
                },
                {
                    "date": 1752432824586,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -42,13 +42,19 @@\n       }\n \n       // å¤‡ç”¨æœåŠ¡å™¨\n       if (config['comfyui.backup_servers']) {\n-        const backupServers = config['comfyui.backup_servers']\n-          .split('\\n')\n+        let backupServersText = config['comfyui.backup_servers']\n+\n+        // æ”¯æŒå¤šç§åˆ†éš”ç¬¦ï¼šæ¢è¡Œç¬¦ã€é€—å·ã€åˆ†å·\n+        const backupServers = backupServersText\n+          .split(/[\\n,;]/)\n           .map(url => url.trim())\n           .filter(url => url && url.startsWith('http'))\n \n+        console.log(`ğŸ” è§£æå¤‡ç”¨æœåŠ¡å™¨é…ç½®: \"${backupServersText}\"`)\n+        console.log(`ğŸ“‹ è§£æå‡ºçš„å¤‡ç”¨æœåŠ¡å™¨:`, backupServers)\n+\n         backupServers.forEach((url, index) => {\n           this.servers.push({\n             url,\n             type: 'backup',\n"
                },
                {
                    "date": 1752432849289,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -163,8 +163,9 @@\n    */\n   determineServerHealth(health, queue, server) {\n     // å¦‚æœå¥åº·æ£€æŸ¥å®Œå…¨å¤±è´¥ï¼Œæ ‡è®°ä¸ºä¸å¥åº·\n     if (!health.healthy) {\n+      console.log(`âŒ æœåŠ¡å™¨ ${server.url} å¥åº·æ£€æŸ¥å¤±è´¥`)\n       return false\n     }\n \n     // å¦‚æœé˜Ÿåˆ—æ£€æŸ¥å¤±è´¥ä½†å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œä»ç„¶è®¤ä¸ºæœåŠ¡å™¨å¯ç”¨\n@@ -179,8 +180,9 @@\n       console.log(`âš ï¸ æœåŠ¡å™¨ ${server.url} é˜Ÿåˆ—è¾ƒé•¿ (${queue.total})ï¼Œä½†ä»å¯ç”¨`)\n       return true\n     }\n \n+    console.log(`âœ… æœåŠ¡å™¨ ${server.url} å¥åº·çŠ¶æ€è‰¯å¥½`)\n     return true\n   }\n \n   /**\n"
                },
                {
                    "date": 1752432865080,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -345,9 +345,9 @@\n           })\n       }\n \n       if (healthyServers.length === 0) {\n-        console.warn('âš ï¸ å¼ºåˆ¶æ›´æ–°åä»æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨')\n+        console.warn('âš ï¸ å¼ºåˆ¶æ›´æ–°åä»æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨ï¼Œå°è¯•å¤‡ç”¨æœåŠ¡å™¨é€‰æ‹©ç­–ç•¥')\n         return await this.fallbackToAnyServer()\n       }\n \n       const selectedServer = healthyServers[0]\n"
                },
                {
                    "date": 1752432889563,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -369,9 +369,9 @@\n    */\n   async fallbackToAnyServer() {\n     console.log('ğŸ”„ ä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨é€‰æ‹©ç­–ç•¥...')\n \n-    // å°è¯•é€‰æ‹©å“åº”æ—¶é—´æœ€å¿«çš„æœåŠ¡å™¨ï¼ˆå³ä½¿é˜Ÿåˆ—è¾ƒé•¿ï¼‰\n+    // é¦–å…ˆå°è¯•é€‰æ‹©æœ‰å“åº”çš„æœåŠ¡å™¨ï¼ˆæŒ‰å“åº”æ—¶é—´æ’åºï¼‰\n     const serversWithResponse = Array.from(this.serverLoads.values())\n       .filter(server => server.responseTime > 0) // è‡³å°‘æœ‰å“åº”\n       .sort((a, b) => {\n         // æŒ‰å“åº”æ—¶é—´æ’åº\n@@ -383,12 +383,27 @@\n       console.log(`ğŸ†˜ é€‰æ‹©å“åº”æœ€å¿«çš„æœåŠ¡å™¨: ${fastestServer.url} (å“åº”æ—¶é—´: ${fastestServer.responseTime}ms, é˜Ÿåˆ—: ${fastestServer.queue.total || 0})`)\n       return fastestServer.url\n     }\n \n-    // å¦‚æœæ²¡æœ‰å“åº”æ•°æ®ï¼ŒæŒ‰ä¼˜å…ˆçº§è¿”å›ç¬¬ä¸€ä¸ªæœåŠ¡å™¨\n+    // å¦‚æœæ²¡æœ‰å“åº”æ•°æ®ï¼Œå°è¯•æŒ‰ä¼˜å…ˆçº§é¡ºåºæµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨\n+    console.log('ğŸ” æ²¡æœ‰å“åº”æ•°æ®ï¼ŒæŒ‰ä¼˜å…ˆçº§æµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨...')\n+    for (const server of this.servers.sort((a, b) => a.priority - b.priority)) {\n+      console.log(`ğŸ§ª æµ‹è¯•æœåŠ¡å™¨: ${server.url}`)\n+      try {\n+        const health = await this.checkServerHealth(server.url)\n+        if (health.healthy) {\n+          console.log(`âœ… æ‰¾åˆ°å¯ç”¨æœåŠ¡å™¨: ${server.url}`)\n+          return server.url\n+        }\n+      } catch (error) {\n+        console.log(`âŒ æœåŠ¡å™¨ ${server.url} æµ‹è¯•å¤±è´¥: ${error.message}`)\n+      }\n+    }\n+\n+    // å¦‚æœæ‰€æœ‰æµ‹è¯•éƒ½å¤±è´¥ï¼Œè¿”å›ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨\n     if (this.servers.length > 0) {\n       const fallbackServer = this.servers[0].url\n-      console.log(`ğŸ†˜ å¤‡ç”¨æœåŠ¡å™¨: ${fallbackServer}`)\n+      console.log(`ğŸ†˜ æ‰€æœ‰æœåŠ¡å™¨æµ‹è¯•å¤±è´¥ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨: ${fallbackServer}`)\n       return fallbackServer\n     }\n \n     // å¦‚æœæ²¡æœ‰é…ç½®çš„æœåŠ¡å™¨ï¼Œå°è¯•å¤šç§æ–¹å¼è·å–é»˜è®¤å€¼\n"
                },
                {
                    "date": 1752432968790,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -42,19 +42,13 @@\n       }\n \n       // å¤‡ç”¨æœåŠ¡å™¨\n       if (config['comfyui.backup_servers']) {\n-        let backupServersText = config['comfyui.backup_servers']\n-\n-        // æ”¯æŒå¤šç§åˆ†éš”ç¬¦ï¼šæ¢è¡Œç¬¦ã€é€—å·ã€åˆ†å·\n-        const backupServers = backupServersText\n-          .split(/[\\n,;]/)\n+        const backupServers = config['comfyui.backup_servers']\n+          .split('\\n')\n           .map(url => url.trim())\n           .filter(url => url && url.startsWith('http'))\n \n-        console.log(`ğŸ” è§£æå¤‡ç”¨æœåŠ¡å™¨é…ç½®: \"${backupServersText}\"`)\n-        console.log(`ğŸ“‹ è§£æå‡ºçš„å¤‡ç”¨æœåŠ¡å™¨:`, backupServers)\n-\n         backupServers.forEach((url, index) => {\n           this.servers.push({\n             url,\n             type: 'backup',\n@@ -163,9 +157,8 @@\n    */\n   determineServerHealth(health, queue, server) {\n     // å¦‚æœå¥åº·æ£€æŸ¥å®Œå…¨å¤±è´¥ï¼Œæ ‡è®°ä¸ºä¸å¥åº·\n     if (!health.healthy) {\n-      console.log(`âŒ æœåŠ¡å™¨ ${server.url} å¥åº·æ£€æŸ¥å¤±è´¥`)\n       return false\n     }\n \n     // å¦‚æœé˜Ÿåˆ—æ£€æŸ¥å¤±è´¥ä½†å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œä»ç„¶è®¤ä¸ºæœåŠ¡å™¨å¯ç”¨\n@@ -180,9 +173,8 @@\n       console.log(`âš ï¸ æœåŠ¡å™¨ ${server.url} é˜Ÿåˆ—è¾ƒé•¿ (${queue.total})ï¼Œä½†ä»å¯ç”¨`)\n       return true\n     }\n \n-    console.log(`âœ… æœåŠ¡å™¨ ${server.url} å¥åº·çŠ¶æ€è‰¯å¥½`)\n     return true\n   }\n \n   /**\n@@ -345,9 +337,9 @@\n           })\n       }\n \n       if (healthyServers.length === 0) {\n-        console.warn('âš ï¸ å¼ºåˆ¶æ›´æ–°åä»æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨ï¼Œå°è¯•å¤‡ç”¨æœåŠ¡å™¨é€‰æ‹©ç­–ç•¥')\n+        console.warn('âš ï¸ å¼ºåˆ¶æ›´æ–°åä»æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨')\n         return await this.fallbackToAnyServer()\n       }\n \n       const selectedServer = healthyServers[0]\n@@ -369,9 +361,9 @@\n    */\n   async fallbackToAnyServer() {\n     console.log('ğŸ”„ ä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨é€‰æ‹©ç­–ç•¥...')\n \n-    // é¦–å…ˆå°è¯•é€‰æ‹©æœ‰å“åº”çš„æœåŠ¡å™¨ï¼ˆæŒ‰å“åº”æ—¶é—´æ’åºï¼‰\n+    // å°è¯•é€‰æ‹©å“åº”æ—¶é—´æœ€å¿«çš„æœåŠ¡å™¨ï¼ˆå³ä½¿é˜Ÿåˆ—è¾ƒé•¿ï¼‰\n     const serversWithResponse = Array.from(this.serverLoads.values())\n       .filter(server => server.responseTime > 0) // è‡³å°‘æœ‰å“åº”\n       .sort((a, b) => {\n         // æŒ‰å“åº”æ—¶é—´æ’åº\n@@ -383,27 +375,12 @@\n       console.log(`ğŸ†˜ é€‰æ‹©å“åº”æœ€å¿«çš„æœåŠ¡å™¨: ${fastestServer.url} (å“åº”æ—¶é—´: ${fastestServer.responseTime}ms, é˜Ÿåˆ—: ${fastestServer.queue.total || 0})`)\n       return fastestServer.url\n     }\n \n-    // å¦‚æœæ²¡æœ‰å“åº”æ•°æ®ï¼Œå°è¯•æŒ‰ä¼˜å…ˆçº§é¡ºåºæµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨\n-    console.log('ğŸ” æ²¡æœ‰å“åº”æ•°æ®ï¼ŒæŒ‰ä¼˜å…ˆçº§æµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨...')\n-    for (const server of this.servers.sort((a, b) => a.priority - b.priority)) {\n-      console.log(`ğŸ§ª æµ‹è¯•æœåŠ¡å™¨: ${server.url}`)\n-      try {\n-        const health = await this.checkServerHealth(server.url)\n-        if (health.healthy) {\n-          console.log(`âœ… æ‰¾åˆ°å¯ç”¨æœåŠ¡å™¨: ${server.url}`)\n-          return server.url\n-        }\n-      } catch (error) {\n-        console.log(`âŒ æœåŠ¡å™¨ ${server.url} æµ‹è¯•å¤±è´¥: ${error.message}`)\n-      }\n-    }\n-\n-    // å¦‚æœæ‰€æœ‰æµ‹è¯•éƒ½å¤±è´¥ï¼Œè¿”å›ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨\n+    // å¦‚æœæ²¡æœ‰å“åº”æ•°æ®ï¼ŒæŒ‰ä¼˜å…ˆçº§è¿”å›ç¬¬ä¸€ä¸ªæœåŠ¡å™¨\n     if (this.servers.length > 0) {\n       const fallbackServer = this.servers[0].url\n-      console.log(`ğŸ†˜ æ‰€æœ‰æœåŠ¡å™¨æµ‹è¯•å¤±è´¥ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªé…ç½®çš„æœåŠ¡å™¨: ${fallbackServer}`)\n+      console.log(`ğŸ†˜ å¤‡ç”¨æœåŠ¡å™¨: ${fallbackServer}`)\n       return fallbackServer\n     }\n \n     // å¦‚æœæ²¡æœ‰é…ç½®çš„æœåŠ¡å™¨ï¼Œå°è¯•å¤šç§æ–¹å¼è·å–é»˜è®¤å€¼\n"
                },
                {
                    "date": 1752433073845,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,14 +10,19 @@\n     this.servers = []\n     this.serverLoads = new Map()\n     this.lockedServer = null\n     this.lastLockTime = 0\n-    this.lockDuration = 30000 // 30ç§’é”å®šæ—¶é—´\n-    this.healthCheckTimeout = 15000 // 15ç§’å¥åº·æ£€æŸ¥è¶…æ—¶\n-    this.queueCheckTimeout = 8000 // 8ç§’é˜Ÿåˆ—æ£€æŸ¥è¶…æ—¶\n+    this.lockDuration = 15000 // ç¼©çŸ­é”å®šæ—¶é—´åˆ°15ç§’\n+    this.healthCheckTimeout = 10000 // 10ç§’å¥åº·æ£€æŸ¥è¶…æ—¶\n+    this.queueCheckTimeout = 6000 // 6ç§’é˜Ÿåˆ—æ£€æŸ¥è¶…æ—¶\n     this.lastUpdateTime = 0\n-    this.updateInterval = 10000 // 10ç§’æ›´æ–°é—´éš”ï¼ˆæ›´é¢‘ç¹çš„æ›´æ–°ï¼‰\n-    this.forceUpdateThreshold = 30000 // 30ç§’å¼ºåˆ¶æ›´æ–°é˜ˆå€¼\n+    this.updateInterval = 8000 // 8ç§’æ›´æ–°é—´éš”ï¼ˆæ›´é¢‘ç¹çš„æ›´æ–°ï¼‰\n+    this.forceUpdateThreshold = 20000 // 20ç§’å¼ºåˆ¶æ›´æ–°é˜ˆå€¼\n+    this.failureThreshold = 2 // è¿ç»­å¤±è´¥2æ¬¡åæ ‡è®°ä¸ºä¸å¥åº·\n+    this.serverFailures = new Map() // è®°å½•æœåŠ¡å™¨å¤±è´¥æ¬¡æ•°\n+    this.autoFailoverEnabled = true // å¯ç”¨è‡ªåŠ¨æ•…éšœè½¬ç§»\n+    this.lastFailoverTime = 0\n+    this.failoverCooldown = 5000 // æ•…éšœè½¬ç§»å†·å´æ—¶é—´5ç§’\n   }\n \n   /**\n    * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n"
                },
                {
                    "date": 1752433101974,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -460,14 +460,21 @@\n \n   /**\n    * è®°å½•æœåŠ¡å™¨å¤±è´¥\n    */\n-  async recordFailure(serverUrl) {\n-    console.log(`ğŸ“ è®°å½•æœåŠ¡å™¨å¤±è´¥: ${serverUrl}`)\n+  async recordFailure(serverUrl, errorType = 'unknown') {\n+    console.log(`ğŸ“ è®°å½•æœåŠ¡å™¨å¤±è´¥: ${serverUrl}, é”™è¯¯ç±»å‹: ${errorType}`)\n \n-    // å¦‚æœå¤±è´¥çš„æ˜¯å½“å‰é”å®šçš„æœåŠ¡å™¨ï¼Œè§£é™¤é”å®š\n+    // å¢åŠ å¤±è´¥è®¡æ•°\n+    const currentFailures = this.serverFailures.get(serverUrl) || 0\n+    const newFailures = currentFailures + 1\n+    this.serverFailures.set(serverUrl, newFailures)\n+\n+    console.log(`âš ï¸ æœåŠ¡å™¨ ${serverUrl} å¤±è´¥æ¬¡æ•°: ${newFailures}/${this.failureThreshold}`)\n+\n+    // å¦‚æœå¤±è´¥çš„æ˜¯å½“å‰é”å®šçš„æœåŠ¡å™¨ï¼Œç«‹å³è§£é™¤é”å®š\n     if (this.lockedServer === serverUrl) {\n-      console.log('ğŸ”“ è§£é™¤å¤±è´¥æœåŠ¡å™¨çš„é”å®š')\n+      console.log('ğŸ”“ ç«‹å³è§£é™¤å¤±è´¥æœåŠ¡å™¨çš„é”å®š')\n       this.lockedServer = null\n       this.lastLockTime = 0\n     }\n \n@@ -475,16 +482,73 @@\n     if (this.serverLoads.has(serverUrl)) {\n       const serverInfo = this.serverLoads.get(serverUrl)\n       serverInfo.healthy = false\n       serverInfo.lastFailure = Date.now()\n+      serverInfo.failureCount = newFailures\n+      serverInfo.lastErrorType = errorType\n       this.serverLoads.set(serverUrl, serverInfo)\n     }\n \n+    // å¦‚æœè¾¾åˆ°å¤±è´¥é˜ˆå€¼ä¸”å¯ç”¨è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œè§¦å‘æ•…éšœè½¬ç§»\n+    if (newFailures >= this.failureThreshold && this.autoFailoverEnabled) {\n+      await this.triggerFailover(serverUrl)\n+    }\n+\n     // å¼ºåˆ¶æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n     this.lastUpdateTime = 0\n   }\n \n   /**\n+   * è§¦å‘æ•…éšœè½¬ç§»\n+   */\n+  async triggerFailover(failedServerUrl) {\n+    const now = Date.now()\n+\n+    // æ£€æŸ¥æ•…éšœè½¬ç§»å†·å´æ—¶é—´\n+    if (now - this.lastFailoverTime < this.failoverCooldown) {\n+      console.log('â³ æ•…éšœè½¬ç§»å†·å´ä¸­ï¼Œè·³è¿‡æ­¤æ¬¡è½¬ç§»')\n+      return\n+    }\n+\n+    console.log(`ğŸ”„ è§¦å‘æ•…éšœè½¬ç§»ï¼Œå¤±è´¥æœåŠ¡å™¨: ${failedServerUrl}`)\n+    this.lastFailoverTime = now\n+\n+    // å¼ºåˆ¶é‡æ–°è¯„ä¼°æ‰€æœ‰æœåŠ¡å™¨\n+    await this.forceReassessment()\n+\n+    // å°è¯•é€‰æ‹©æ–°çš„æœåŠ¡å™¨\n+    try {\n+      const newServer = await this.selectServerByMinQueue()\n+      if (newServer && newServer !== failedServerUrl) {\n+        console.log(`âœ… æ•…éšœè½¬ç§»æˆåŠŸï¼Œæ–°æœåŠ¡å™¨: ${newServer}`)\n+        return newServer\n+      } else {\n+        console.warn('âš ï¸ æ•…éšœè½¬ç§»å¤±è´¥ï¼Œæ²¡æœ‰å¯ç”¨çš„æ›¿ä»£æœåŠ¡å™¨')\n+      }\n+    } catch (error) {\n+      console.error('âŒ æ•…éšœè½¬ç§»è¿‡ç¨‹ä¸­å‡ºé”™:', error)\n+    }\n+  }\n+\n+  /**\n+   * é‡ç½®æœåŠ¡å™¨å¤±è´¥è®¡æ•°\n+   */\n+  resetFailureCount(serverUrl) {\n+    if (this.serverFailures.has(serverUrl)) {\n+      console.log(`ğŸ”„ é‡ç½®æœåŠ¡å™¨å¤±è´¥è®¡æ•°: ${serverUrl}`)\n+      this.serverFailures.delete(serverUrl)\n+\n+      // åŒæ—¶æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n+      if (this.serverLoads.has(serverUrl)) {\n+        const serverInfo = this.serverLoads.get(serverUrl)\n+        serverInfo.failureCount = 0\n+        delete serverInfo.lastErrorType\n+        this.serverLoads.set(serverUrl, serverInfo)\n+      }\n+    }\n+  }\n+\n+  /**\n    * è·å–æœ€ä¼˜æœåŠ¡å™¨ï¼ˆä¸»è¦æ¥å£ï¼‰\n    */\n   async getOptimalServer() {\n     return await this.selectServerByMinQueue()\n"
                },
                {
                    "date": 1752433121431,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -126,15 +126,22 @@\n \n         // æ›´æ™ºèƒ½çš„å¥åº·çŠ¶æ€åˆ¤æ–­\n         const isHealthy = this.determineServerHealth(health, queue, server)\n \n+        // å¦‚æœæœåŠ¡å™¨æ¢å¤å¥åº·ï¼Œé‡ç½®å¤±è´¥è®¡æ•°\n+        if (isHealthy && this.serverFailures.has(server.url)) {\n+          console.log(`âœ… æœåŠ¡å™¨ ${server.url} å·²æ¢å¤å¥åº·ï¼Œé‡ç½®å¤±è´¥è®¡æ•°`)\n+          this.resetFailureCount(server.url)\n+        }\n+\n         this.serverLoads.set(server.url, {\n           ...server,\n           healthy: isHealthy,\n           queue: queue,\n           lastCheck: now,\n           responseTime: health.responseTime || 0,\n-          healthDetails: { health, queue }\n+          healthDetails: { health, queue },\n+          failureCount: this.serverFailures.get(server.url) || 0\n         })\n \n         const queueInfo = queue.healthy ? `é˜Ÿåˆ—=${queue.total || 0}(è¿è¡Œ:${queue.running || 0},ç­‰å¾…:${queue.pending || 0})` : `é˜Ÿåˆ—æ£€æŸ¥å¤±è´¥`\n         console.log(`ğŸ“Š ${server.url}: å¥åº·=${health.healthy}, ${queueInfo}, å“åº”æ—¶é—´=${health.responseTime || 0}ms`)\n"
                },
                {
                    "date": 1752433140936,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -324,15 +324,32 @@\n       await this.updateServerLoads()\n \n       // è·å–æ‰€æœ‰å¥åº·çš„æœåŠ¡å™¨\n       let healthyServers = Array.from(this.serverLoads.values())\n-        .filter(server => server.healthy)\n+        .filter(server => {\n+          // è¿‡æ»¤æ‰å¥åº·çŠ¶æ€ä¸ºfalseçš„æœåŠ¡å™¨\n+          if (!server.healthy) return false\n+\n+          // è¿‡æ»¤æ‰å¤±è´¥æ¬¡æ•°è¿‡å¤šçš„æœåŠ¡å™¨\n+          const failures = this.serverFailures.get(server.url) || 0\n+          if (failures >= this.failureThreshold) {\n+            console.log(`âš ï¸ è·³è¿‡å¤±è´¥æ¬¡æ•°è¿‡å¤šçš„æœåŠ¡å™¨: ${server.url} (${failures}æ¬¡)`)\n+            return false\n+          }\n+\n+          return true\n+        })\n         .sort((a, b) => {\n-          // é¦–å…ˆæŒ‰é˜Ÿåˆ—æ•°é‡æ’åº\n+          // é¦–å…ˆæŒ‰å¤±è´¥æ¬¡æ•°æ’åºï¼ˆå¤±è´¥æ¬¡æ•°å°‘çš„ä¼˜å…ˆï¼‰\n+          const failureA = this.serverFailures.get(a.url) || 0\n+          const failureB = this.serverFailures.get(b.url) || 0\n+          if (failureA !== failureB) return failureA - failureB\n+\n+          // ç„¶åæŒ‰é˜Ÿåˆ—æ•°é‡æ’åº\n           const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n           if (queueDiff !== 0) return queueDiff\n \n-          // é˜Ÿåˆ—ç›¸åŒæ—¶æŒ‰ä¼˜å…ˆçº§æ’åº\n+          // æœ€åæŒ‰ä¼˜å…ˆçº§æ’åº\n           return a.priority - b.priority\n         })\n \n       // å¦‚æœæ²¡æœ‰å¥åº·æœåŠ¡å™¨ï¼Œå¼ºåˆ¶æ›´æ–°ä¸€æ¬¡å†è¯•\n"
                },
                {
                    "date": 1752433159045,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -587,8 +587,12 @@\n     // æ¸…é™¤é”å®šçŠ¶æ€\n     this.lockedServer = null\n     this.lastLockTime = 0\n \n+    // é‡ç½®æ‰€æœ‰æœåŠ¡å™¨çš„å¤±è´¥è®¡æ•°ï¼ˆç»™å®ƒä»¬ä¸€ä¸ªé‡æ–°å¼€å§‹çš„æœºä¼šï¼‰\n+    console.log('ğŸ”„ é‡ç½®æ‰€æœ‰æœåŠ¡å™¨å¤±è´¥è®¡æ•°')\n+    this.serverFailures.clear()\n+\n     // å¼ºåˆ¶æ›´æ–°è´Ÿè½½ä¿¡æ¯\n     await this.updateServerLoads(true)\n \n     // æ˜¾ç¤ºå½“å‰çŠ¶æ€\n"
                },
                {
                    "date": 1752433183172,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -614,9 +614,12 @@\n       const locked = url === this.lockedServer ? 'ğŸ”’' : ''\n       const priority = `ä¼˜å…ˆçº§:${info.priority}`\n       const responseTime = info.responseTime ? `å“åº”:${info.responseTime}ms` : 'å“åº”:æœªçŸ¥'\n       const lastCheck = info.lastCheck ? `æ£€æŸ¥:${Math.round((Date.now() - info.lastCheck) / 1000)}så‰` : 'æ£€æŸ¥:ä»æœª'\n-      console.log(`   ${status} ${url} ${queueInfo} ${priority} ${responseTime} ${lastCheck} ${locked}`)\n+      const failures = this.serverFailures.get(url) || 0\n+      const failureInfo = failures > 0 ? `å¤±è´¥:${failures}æ¬¡` : ''\n+      const errorType = info.lastErrorType ? `é”™è¯¯:${info.lastErrorType}` : ''\n+      console.log(`   ${status} ${url} ${queueInfo} ${priority} ${responseTime} ${lastCheck} ${failureInfo} ${errorType} ${locked}`)\n     }\n   }\n \n   /**\n"
                },
                {
                    "date": 1752433248550,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -21,8 +21,10 @@\n     this.serverFailures = new Map() // è®°å½•æœåŠ¡å™¨å¤±è´¥æ¬¡æ•°\n     this.autoFailoverEnabled = true // å¯ç”¨è‡ªåŠ¨æ•…éšœè½¬ç§»\n     this.lastFailoverTime = 0\n     this.failoverCooldown = 5000 // æ•…éšœè½¬ç§»å†·å´æ—¶é—´5ç§’\n+    this.healthMonitorInterval = null // å¥åº·ç›‘æ§å®šæ—¶å™¨\n+    this.healthMonitorFrequency = 30000 // 30ç§’æ£€æŸ¥ä¸€æ¬¡å¥åº·çŠ¶æ€\n   }\n \n   /**\n    * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n"
                },
                {
                    "date": 1752433264068,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -85,8 +85,11 @@\n \n       // åˆå§‹åŒ–æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n       await this.updateServerLoads()\n \n+      // å¯åŠ¨å¥åº·ç›‘æ§\n+      this.startHealthMonitoring()\n+\n       console.log('âœ… ComfyUI è´Ÿè½½å‡è¡¡å™¨åˆå§‹åŒ–å®Œæˆ')\n \n     } catch (error) {\n       console.error('âŒ è´Ÿè½½å‡è¡¡å™¨åˆå§‹åŒ–å¤±è´¥:', error)\n"
                },
                {
                    "date": 1752433286725,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -652,8 +652,80 @@\n     }\n \n     return stats\n   }\n+\n+  /**\n+   * å¯åŠ¨å¥åº·ç›‘æ§\n+   */\n+  startHealthMonitoring() {\n+    if (this.healthMonitorInterval) {\n+      clearInterval(this.healthMonitorInterval)\n+    }\n+\n+    console.log(`ğŸ¥ å¯åŠ¨å¥åº·ç›‘æ§ï¼Œæ£€æŸ¥é¢‘ç‡: ${this.healthMonitorFrequency / 1000}ç§’`)\n+\n+    this.healthMonitorInterval = setInterval(async () => {\n+      try {\n+        await this.performHealthMonitoring()\n+      } catch (error) {\n+        console.error('âŒ å¥åº·ç›‘æ§å‡ºé”™:', error)\n+      }\n+    }, this.healthMonitorFrequency)\n+  }\n+\n+  /**\n+   * åœæ­¢å¥åº·ç›‘æ§\n+   */\n+  stopHealthMonitoring() {\n+    if (this.healthMonitorInterval) {\n+      console.log('ğŸ›‘ åœæ­¢å¥åº·ç›‘æ§')\n+      clearInterval(this.healthMonitorInterval)\n+      this.healthMonitorInterval = null\n+    }\n+  }\n+\n+  /**\n+   * æ‰§è¡Œå¥åº·ç›‘æ§\n+   */\n+  async performHealthMonitoring() {\n+    console.log('ğŸ¥ æ‰§è¡Œå®šæœŸå¥åº·æ£€æŸ¥...')\n+\n+    // æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n+    await this.updateServerLoads()\n+\n+    // æ£€æŸ¥å½“å‰é”å®šçš„æœåŠ¡å™¨æ˜¯å¦ä»ç„¶å¥åº·\n+    if (this.lockedServer) {\n+      const lockedServerInfo = this.serverLoads.get(this.lockedServer)\n+      if (lockedServerInfo && !lockedServerInfo.healthy) {\n+        console.warn(`âš ï¸ é”å®šçš„æœåŠ¡å™¨ ${this.lockedServer} ä¸å¥åº·ï¼Œè§£é™¤é”å®š`)\n+        this.lockedServer = null\n+        this.lastLockTime = 0\n+      }\n+    }\n+\n+    // æ£€æŸ¥æ˜¯å¦æœ‰æœåŠ¡å™¨ä»æ•…éšœä¸­æ¢å¤\n+    const healthyServers = Array.from(this.serverLoads.values())\n+      .filter(server => server.healthy)\n+\n+    if (healthyServers.length > 0) {\n+      console.log(`âœ… å¥åº·ç›‘æ§å®Œæˆï¼Œå‘ç° ${healthyServers.length} ä¸ªå¥åº·æœåŠ¡å™¨`)\n+    } else {\n+      console.warn('âš ï¸ å¥åº·ç›‘æ§è­¦å‘Šï¼šæ²¡æœ‰å‘ç°å¥åº·çš„æœåŠ¡å™¨')\n+    }\n+  }\n+\n+  /**\n+   * é”€æ¯è´Ÿè½½å‡è¡¡å™¨\n+   */\n+  destroy() {\n+    this.stopHealthMonitoring()\n+    this.servers = []\n+    this.serverLoads.clear()\n+    this.serverFailures.clear()\n+    this.lockedServer = null\n+    console.log('ğŸ—‘ï¸ è´Ÿè½½å‡è¡¡å™¨å·²é”€æ¯')\n+  }\n }\n \n // åˆ›å»ºå•ä¾‹å®ä¾‹\n const loadBalancer = new ComfyUILoadBalancer()\n"
                },
                {
                    "date": 1752433308913,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -583,8 +583,56 @@\n     return await this.selectServerByMinQueue()\n   }\n \n   /**\n+   * æ‰‹åŠ¨è§¦å‘æœåŠ¡å™¨åˆ‡æ¢\n+   */\n+  async switchToNextServer() {\n+    console.log('ğŸ”„ æ‰‹åŠ¨è§¦å‘æœåŠ¡å™¨åˆ‡æ¢...')\n+\n+    // å¦‚æœå½“å‰æœ‰é”å®šçš„æœåŠ¡å™¨ï¼Œå°†å…¶æ ‡è®°ä¸ºå¤±è´¥\n+    if (this.lockedServer) {\n+      console.log(`ğŸ“ æ ‡è®°å½“å‰æœåŠ¡å™¨ä¸ºå¤±è´¥: ${this.lockedServer}`)\n+      await this.recordFailure(this.lockedServer, 'manual_switch')\n+    }\n+\n+    // å¼ºåˆ¶é‡æ–°è¯„ä¼°å¹¶é€‰æ‹©æ–°æœåŠ¡å™¨\n+    await this.forceReassessment()\n+    const newServer = await this.selectServerByMinQueue()\n+\n+    console.log(`âœ… æ‰‹åŠ¨åˆ‡æ¢å®Œæˆï¼Œæ–°æœåŠ¡å™¨: ${newServer}`)\n+    return newServer\n+  }\n+\n+  /**\n+   * è·å–ä¸‹ä¸€ä¸ªå¯ç”¨æœåŠ¡å™¨ï¼ˆä¸é”å®šï¼‰\n+   */\n+  async getNextAvailableServer(excludeUrls = []) {\n+    await this.updateServerLoads()\n+\n+    const availableServers = Array.from(this.serverLoads.values())\n+      .filter(server => {\n+        if (!server.healthy) return false\n+        if (excludeUrls.includes(server.url)) return false\n+\n+        const failures = this.serverFailures.get(server.url) || 0\n+        return failures < this.failureThreshold\n+      })\n+      .sort((a, b) => {\n+        const failureA = this.serverFailures.get(a.url) || 0\n+        const failureB = this.serverFailures.get(b.url) || 0\n+        if (failureA !== failureB) return failureA - failureB\n+\n+        const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n+        if (queueDiff !== 0) return queueDiff\n+\n+        return a.priority - b.priority\n+      })\n+\n+    return availableServers.length > 0 ? availableServers[0].url : null\n+  }\n+\n+  /**\n    * å¼ºåˆ¶é‡æ–°è¯„ä¼°æ‰€æœ‰æœåŠ¡å™¨\n    */\n   async forceReassessment() {\n     console.log('ğŸ”„ å¼ºåˆ¶é‡æ–°è¯„ä¼°æ‰€æœ‰æœåŠ¡å™¨...')\n"
                },
                {
                    "date": 1752459661531,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,11 +18,8 @@\n     this.updateInterval = 8000 // 8ç§’æ›´æ–°é—´éš”ï¼ˆæ›´é¢‘ç¹çš„æ›´æ–°ï¼‰\n     this.forceUpdateThreshold = 20000 // 20ç§’å¼ºåˆ¶æ›´æ–°é˜ˆå€¼\n     this.failureThreshold = 2 // è¿ç»­å¤±è´¥2æ¬¡åæ ‡è®°ä¸ºä¸å¥åº·\n     this.serverFailures = new Map() // è®°å½•æœåŠ¡å™¨å¤±è´¥æ¬¡æ•°\n-    this.autoFailoverEnabled = true // å¯ç”¨è‡ªåŠ¨æ•…éšœè½¬ç§»\n-    this.lastFailoverTime = 0\n-    this.failoverCooldown = 5000 // æ•…éšœè½¬ç§»å†·å´æ—¶é—´5ç§’\n     this.healthMonitorInterval = null // å¥åº·ç›‘æ§å®šæ—¶å™¨\n     this.healthMonitorFrequency = 30000 // 30ç§’æ£€æŸ¥ä¸€æ¬¡å¥åº·çŠ¶æ€\n   }\n \n"
                },
                {
                    "date": 1752459681684,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -513,12 +513,9 @@\n       serverInfo.lastErrorType = errorType\n       this.serverLoads.set(serverUrl, serverInfo)\n     }\n \n-    // å¦‚æœè¾¾åˆ°å¤±è´¥é˜ˆå€¼ä¸”å¯ç”¨è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œè§¦å‘æ•…éšœè½¬ç§»\n-    if (newFailures >= this.failureThreshold && this.autoFailoverEnabled) {\n-      await this.triggerFailover(serverUrl)\n-    }\n+    // è®°å½•å¤±è´¥ä½†ä¸è‡ªåŠ¨åˆ‡æ¢ï¼Œç”±ç”¨æˆ·æ‰‹åŠ¨å†³å®š\n \n     // å¼ºåˆ¶æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n     this.lastUpdateTime = 0\n   }\n"
                },
                {
                    "date": 1752459701776,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -519,40 +519,10 @@\n     // å¼ºåˆ¶æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n     this.lastUpdateTime = 0\n   }\n \n-  /**\n-   * è§¦å‘æ•…éšœè½¬ç§»\n-   */\n-  async triggerFailover(failedServerUrl) {\n-    const now = Date.now()\n \n-    // æ£€æŸ¥æ•…éšœè½¬ç§»å†·å´æ—¶é—´\n-    if (now - this.lastFailoverTime < this.failoverCooldown) {\n-      console.log('â³ æ•…éšœè½¬ç§»å†·å´ä¸­ï¼Œè·³è¿‡æ­¤æ¬¡è½¬ç§»')\n-      return\n-    }\n \n-    console.log(`ğŸ”„ è§¦å‘æ•…éšœè½¬ç§»ï¼Œå¤±è´¥æœåŠ¡å™¨: ${failedServerUrl}`)\n-    this.lastFailoverTime = now\n-\n-    // å¼ºåˆ¶é‡æ–°è¯„ä¼°æ‰€æœ‰æœåŠ¡å™¨\n-    await this.forceReassessment()\n-\n-    // å°è¯•é€‰æ‹©æ–°çš„æœåŠ¡å™¨\n-    try {\n-      const newServer = await this.selectServerByMinQueue()\n-      if (newServer && newServer !== failedServerUrl) {\n-        console.log(`âœ… æ•…éšœè½¬ç§»æˆåŠŸï¼Œæ–°æœåŠ¡å™¨: ${newServer}`)\n-        return newServer\n-      } else {\n-        console.warn('âš ï¸ æ•…éšœè½¬ç§»å¤±è´¥ï¼Œæ²¡æœ‰å¯ç”¨çš„æ›¿ä»£æœåŠ¡å™¨')\n-      }\n-    } catch (error) {\n-      console.error('âŒ æ•…éšœè½¬ç§»è¿‡ç¨‹ä¸­å‡ºé”™:', error)\n-    }\n-  }\n-\n   /**\n    * é‡ç½®æœåŠ¡å™¨å¤±è´¥è®¡æ•°\n    */\n   resetFailureCount(serverUrl) {\n"
                }
            ],
            "date": 1752333548051,
            "name": "Commit-0",
            "content": "// ComfyUI è´Ÿè½½å‡è¡¡å™¨ - åŸºäºä»»åŠ¡é˜Ÿåˆ—çš„æ™ºèƒ½é€‰æ‹©\nimport configService from './configService.js'\n\n/**\n * ComfyUI è´Ÿè½½å‡è¡¡å™¨\n * æ ¹æ®æœåŠ¡å™¨ä»»åŠ¡é˜Ÿåˆ—æƒ…å†µé€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n */\nclass ComfyUILoadBalancer {\n  constructor() {\n    this.servers = []\n    this.serverLoads = new Map()\n    this.lockedServer = null\n    this.lastLockTime = 0\n    this.lockDuration = 30000 // 30ç§’é”å®šæ—¶é—´\n    this.healthCheckTimeout = 10000 // 10ç§’å¥åº·æ£€æŸ¥è¶…æ—¶\n    this.queueCheckTimeout = 5000 // 5ç§’é˜Ÿåˆ—æ£€æŸ¥è¶…æ—¶\n    this.lastUpdateTime = 0\n    this.updateInterval = 15000 // 15ç§’æ›´æ–°é—´éš”\n  }\n\n  /**\n   * åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨\n   */\n  async initialize() {\n    try {\n      console.log('ğŸš€ åˆå§‹åŒ– ComfyUI è´Ÿè½½å‡è¡¡å™¨...')\n\n      // è·å–æœåŠ¡å™¨é…ç½®\n      const config = await configService.getConfig()\n\n      // æ„å»ºæœåŠ¡å™¨åˆ—è¡¨\n      this.servers = []\n\n      // ä¸»æœåŠ¡å™¨\n      if (config['comfyui.server_url']) {\n        this.servers.push({\n          url: config['comfyui.server_url'],\n          type: 'primary',\n          priority: 1\n        })\n      }\n\n      // å¤‡ç”¨æœåŠ¡å™¨\n      if (config['comfyui.backup_servers']) {\n        const backupServers = config['comfyui.backup_servers']\n          .split('\\n')\n          .map(url => url.trim())\n          .filter(url => url && url.startsWith('http'))\n\n        backupServers.forEach((url, index) => {\n          this.servers.push({\n            url,\n            type: 'backup',\n            priority: index + 2\n          })\n        })\n      }\n\n      // å¦‚æœæ²¡æœ‰é…ç½®æœåŠ¡å™¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®\n      if (this.servers.length === 0) {\n        console.warn('âš ï¸ æœªæ‰¾åˆ°é…ç½®çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®')\n        // ä»æœ¬åœ°é…ç½®è·å–é»˜è®¤æœåŠ¡å™¨\n        const localConfig = JSON.parse(localStorage.getItem('comfyui_config') || '{}')\n        const defaultUrl = localConfig.COMFYUI_SERVER_URL || 'https://your-comfyui-server.com'\n\n        this.servers.push({\n          url: defaultUrl,\n          type: 'primary',\n          priority: 1\n        })\n      }\n\n      console.log(`âœ… å‘ç° ${this.servers.length} ä¸ª ComfyUI æœåŠ¡å™¨:`)\n      this.servers.forEach((server, index) => {\n        console.log(`   ${index + 1}. ${server.url} (${server.type})`)\n      })\n\n      // åˆå§‹åŒ–æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n      await this.updateServerLoads()\n\n      console.log('âœ… ComfyUI è´Ÿè½½å‡è¡¡å™¨åˆå§‹åŒ–å®Œæˆ')\n\n    } catch (error) {\n      console.error('âŒ è´Ÿè½½å‡è¡¡å™¨åˆå§‹åŒ–å¤±è´¥:', error)\n      // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸åº”ç”¨ç»§ç»­è¿è¡Œ\n      console.log('ğŸ”„ ä½¿ç”¨é™çº§æ¨¡å¼ï¼Œå°†ä½¿ç”¨å•æœåŠ¡å™¨é…ç½®')\n    }\n  }\n\n  /**\n   * æ›´æ–°æ‰€æœ‰æœåŠ¡å™¨çš„è´Ÿè½½ä¿¡æ¯\n   */\n  async updateServerLoads() {\n    const now = Date.now()\n\n    // å¦‚æœè·ç¦»ä¸Šæ¬¡æ›´æ–°æ—¶é—´ä¸è¶³é—´éš”ï¼Œè·³è¿‡æ›´æ–°\n    if (now - this.lastUpdateTime < this.updateInterval) {\n      console.log('â­ï¸ è·³è¿‡è´Ÿè½½æ›´æ–°ï¼Œè·ç¦»ä¸Šæ¬¡æ›´æ–°æ—¶é—´ä¸è¶³')\n      return\n    }\n\n    console.log('ğŸ”„ æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯...')\n\n    const updatePromises = this.servers.map(async (server) => {\n      try {\n        // å¹¶è¡Œæ£€æŸ¥å¥åº·çŠ¶æ€å’Œé˜Ÿåˆ—ä¿¡æ¯\n        const [healthResult, queueResult] = await Promise.allSettled([\n          this.checkServerHealth(server.url),\n          this.getServerQueueInfo(server.url)\n        ])\n\n        const health = healthResult.status === 'fulfilled' ? healthResult.value : { healthy: false }\n        const queue = queueResult.status === 'fulfilled' ? queueResult.value : { total: 999, healthy: false }\n\n        this.serverLoads.set(server.url, {\n          ...server,\n          healthy: health.healthy && queue.healthy,\n          queue: queue,\n          lastCheck: now,\n          responseTime: health.responseTime || 0\n        })\n\n        console.log(`ğŸ“Š ${server.url}: å¥åº·=${health.healthy}, é˜Ÿåˆ—=${queue.total || 0}`)\n\n      } catch (error) {\n        console.error(`âŒ æ›´æ–°æœåŠ¡å™¨è´Ÿè½½å¤±è´¥ ${server.url}:`, error)\n        this.serverLoads.set(server.url, {\n          ...server,\n          healthy: false,\n          queue: { total: 999, healthy: false },\n          lastCheck: now,\n          error: error.message\n        })\n      }\n    })\n\n    await Promise.allSettled(updatePromises)\n    this.lastUpdateTime = now\n\n    console.log('âœ… æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯æ›´æ–°å®Œæˆ')\n  }\n\n  /**\n   * æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€\n   */\n  async checkServerHealth(serverUrl) {\n    try {\n      const startTime = Date.now()\n\n      const controller = new AbortController()\n      const timeoutId = setTimeout(() => controller.abort(), this.healthCheckTimeout)\n\n      const response = await fetch(`${serverUrl}/system_stats`, {\n        method: 'GET',\n        signal: controller.signal,\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      })\n\n      clearTimeout(timeoutId)\n      const responseTime = Date.now() - startTime\n\n      if (response.ok) {\n        return { healthy: true, responseTime, status: response.status }\n      } else {\n        return { healthy: false, responseTime, status: response.status }\n      }\n\n    } catch (error) {\n      console.warn(`âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ ${serverUrl}:`, error.message)\n      return { healthy: false, error: error.message }\n    }\n  }\n\n  /**\n   * è·å–æœåŠ¡å™¨é˜Ÿåˆ—ä¿¡æ¯\n   */\n  async getServerQueueInfo(serverUrl) {\n    try {\n      const controller = new AbortController()\n      const timeoutId = setTimeout(() => controller.abort(), this.queueCheckTimeout)\n\n      const response = await fetch(`${serverUrl}/queue`, {\n        method: 'GET',\n        signal: controller.signal,\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      })\n\n      clearTimeout(timeoutId)\n\n      if (response.ok) {\n        const queueData = await response.json()\n\n        // ComfyUI é˜Ÿåˆ— API è¿”å›æ ¼å¼: { queue_running: [...], queue_pending: [...] }\n        const running = queueData.queue_running ? queueData.queue_running.length : 0\n        const pending = queueData.queue_pending ? queueData.queue_pending.length : 0\n        const total = running + pending\n\n        return {\n          running,\n          pending,\n          total,\n          healthy: true,\n          supportsQueueAPI: true\n        }\n      } else {\n        // å¦‚æœé˜Ÿåˆ— API ä¸å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨ç³»ç»ŸçŠ¶æ€ä½œä¸ºå¤‡ç”¨\n        return await this.getServerQueueInfoFallback(serverUrl)\n      }\n\n    } catch (error) {\n      console.warn(`âš ï¸ é˜Ÿåˆ—ä¿¡æ¯è·å–å¤±è´¥ ${serverUrl}:`, error.message)\n      return await this.getServerQueueInfoFallback(serverUrl)\n    }\n  }\n\n  /**\n   * å¤‡ç”¨é˜Ÿåˆ—ä¿¡æ¯è·å–æ–¹æ³•\n   */\n  async getServerQueueInfoFallback(serverUrl) {\n    try {\n      const controller = new AbortController()\n      const timeoutId = setTimeout(() => controller.abort(), this.queueCheckTimeout)\n\n      const response = await fetch(`${serverUrl}/system_stats`, {\n        method: 'GET',\n        signal: controller.signal\n      })\n\n      clearTimeout(timeoutId)\n\n      if (response.ok) {\n        // å¦‚æœæ— æ³•è·å–ç²¾ç¡®é˜Ÿåˆ—ä¿¡æ¯ï¼Œå‡è®¾æœåŠ¡å™¨å¯ç”¨ä½†é˜Ÿåˆ—æœªçŸ¥\n        return {\n          running: 0,\n          pending: 0,\n          total: 0,\n          healthy: true,\n          supportsQueueAPI: false\n        }\n      }\n    } catch (error) {\n      // å¿½ç•¥é”™è¯¯\n    }\n\n    return {\n      running: 0,\n      pending: 0,\n      total: 999, // é«˜å€¼è¡¨ç¤ºä¸å¯ç”¨\n      healthy: false,\n      supportsQueueAPI: false\n    }\n  }\n\n  /**\n   * æ ¹æ®æœ€å°é˜Ÿåˆ—é€‰æ‹©æœåŠ¡å™¨\n   */\n  async selectServerByMinQueue() {\n    try {\n      console.log('ğŸ¯ å¼€å§‹é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨...')\n\n      // æ£€æŸ¥æ˜¯å¦æœ‰é”å®šçš„æœåŠ¡å™¨\n      if (this.isServerLocked()) {\n        const lockedServer = this.getLockedServer()\n        if (lockedServer) {\n          console.log(`ğŸ”’ ä½¿ç”¨é”å®šçš„æœåŠ¡å™¨: ${lockedServer}`)\n          return lockedServer\n        }\n      }\n\n      // æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n      await this.updateServerLoads()\n\n      // è·å–æ‰€æœ‰å¥åº·çš„æœåŠ¡å™¨\n      const healthyServers = Array.from(this.serverLoads.values())\n        .filter(server => server.healthy)\n        .sort((a, b) => {\n          // é¦–å…ˆæŒ‰é˜Ÿåˆ—æ•°é‡æ’åº\n          const queueDiff = (a.queue.total || 0) - (b.queue.total || 0)\n          if (queueDiff !== 0) return queueDiff\n\n          // é˜Ÿåˆ—ç›¸åŒæ—¶æŒ‰ä¼˜å…ˆçº§æ’åº\n          return a.priority - b.priority\n        })\n\n      if (healthyServers.length === 0) {\n        console.warn('âš ï¸ æ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨å¯ç”¨')\n        return await this.fallbackToAnyServer()\n      }\n\n      const selectedServer = healthyServers[0]\n      console.log(`âœ… é€‰æ‹©æœåŠ¡å™¨: ${selectedServer.url} (é˜Ÿåˆ—: ${selectedServer.queue.total || 0})`)\n\n      // é”å®šé€‰ä¸­çš„æœåŠ¡å™¨\n      this.lockServer(selectedServer.url)\n\n      return selectedServer.url\n\n    } catch (error) {\n      console.error('âŒ æœåŠ¡å™¨é€‰æ‹©å¤±è´¥:', error)\n      return await this.fallbackToAnyServer()\n    }\n  }\n\n  /**\n   * å¤‡ç”¨æœåŠ¡å™¨é€‰æ‹©\n   */\n  async fallbackToAnyServer() {\n    console.log('ğŸ”„ ä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨é€‰æ‹©ç­–ç•¥...')\n\n    // æŒ‰ä¼˜å…ˆçº§è¿”å›ç¬¬ä¸€ä¸ªæœåŠ¡å™¨\n    if (this.servers.length > 0) {\n      const fallbackServer = this.servers[0].url\n      console.log(`ğŸ†˜ å¤‡ç”¨æœåŠ¡å™¨: ${fallbackServer}`)\n      return fallbackServer\n    }\n\n    // å¦‚æœæ²¡æœ‰é…ç½®çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨é…ç½®æœåŠ¡çš„é»˜è®¤å€¼\n    const config = await configService.getConfig()\n    const defaultServer = config['comfyui.server_url']\n\n    if (defaultServer) {\n      console.log(`ğŸ†˜ é»˜è®¤æœåŠ¡å™¨: ${defaultServer}`)\n      return defaultServer\n    }\n\n    throw new Error('æ²¡æœ‰å¯ç”¨çš„ ComfyUI æœåŠ¡å™¨')\n  }\n\n  /**\n   * é”å®šæœåŠ¡å™¨\n   */\n  lockServer(serverUrl) {\n    this.lockedServer = serverUrl\n    this.lastLockTime = Date.now()\n    console.log(`ğŸ”’ é”å®šæœåŠ¡å™¨: ${serverUrl}, æŒç»­ ${this.lockDuration / 1000} ç§’`)\n\n    // æ˜¾ç¤ºå½“å‰æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€\n    this.logServerStatus()\n  }\n\n  /**\n   * æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¢«é”å®š\n   */\n  isServerLocked() {\n    if (!this.lockedServer) return false\n\n    const now = Date.now()\n    const isLocked = (now - this.lastLockTime) < this.lockDuration\n\n    if (!isLocked) {\n      console.log('ğŸ”“ æœåŠ¡å™¨é”å®šå·²è¿‡æœŸ')\n      this.lockedServer = null\n      this.lastLockTime = 0\n    }\n\n    return isLocked\n  }\n\n  /**\n   * è·å–é”å®šçš„æœåŠ¡å™¨\n   */\n  getLockedServer() {\n    if (this.isServerLocked()) {\n      return this.lockedServer\n    }\n    return null\n  }\n\n  /**\n   * è®°å½•æœåŠ¡å™¨å¤±è´¥\n   */\n  async recordFailure(serverUrl) {\n    console.log(`ğŸ“ è®°å½•æœåŠ¡å™¨å¤±è´¥: ${serverUrl}`)\n\n    // å¦‚æœå¤±è´¥çš„æ˜¯å½“å‰é”å®šçš„æœåŠ¡å™¨ï¼Œè§£é™¤é”å®š\n    if (this.lockedServer === serverUrl) {\n      console.log('ğŸ”“ è§£é™¤å¤±è´¥æœåŠ¡å™¨çš„é”å®š')\n      this.lockedServer = null\n      this.lastLockTime = 0\n    }\n\n    // æ ‡è®°æœåŠ¡å™¨ä¸ºä¸å¥åº·\n    if (this.serverLoads.has(serverUrl)) {\n      const serverInfo = this.serverLoads.get(serverUrl)\n      serverInfo.healthy = false\n      serverInfo.lastFailure = Date.now()\n      this.serverLoads.set(serverUrl, serverInfo)\n    }\n\n    // å¼ºåˆ¶æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n    this.lastUpdateTime = 0\n  }\n\n  /**\n   * è·å–æœ€ä¼˜æœåŠ¡å™¨ï¼ˆä¸»è¦æ¥å£ï¼‰\n   */\n  async getOptimalServer() {\n    return await this.selectServerByMinQueue()\n  }\n\n  /**\n   * æ˜¾ç¤ºæœåŠ¡å™¨çŠ¶æ€\n   */\n  logServerStatus() {\n    console.log('ğŸ“Š å½“å‰æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€:')\n    for (const [url, info] of this.serverLoads.entries()) {\n      const status = info.healthy ? 'âœ…' : 'âŒ'\n      const queue = info.healthy ? `é˜Ÿåˆ—:${info.queue.total || 0}` : 'ä¸å¥åº·'\n      const locked = url === this.lockedServer ? 'ğŸ”’' : ''\n      const priority = `ä¼˜å…ˆçº§:${info.priority}`\n      console.log(`   ${status} ${url} ${queue} ${priority} ${locked}`)\n    }\n  }\n\n  /**\n   * è·å–æœåŠ¡å™¨ç»Ÿè®¡ä¿¡æ¯\n   */\n  getServerStats() {\n    const stats = {\n      total: this.servers.length,\n      healthy: 0,\n      locked: this.lockedServer,\n      servers: []\n    }\n\n    for (const [url, info] of this.serverLoads.entries()) {\n      if (info.healthy) stats.healthy++\n\n      stats.servers.push({\n        url,\n        healthy: info.healthy,\n        queue: info.queue.total || 0,\n        priority: info.priority,\n        type: info.type,\n        locked: url === this.lockedServer\n      })\n    }\n\n    return stats\n  }\n}\n\n// åˆ›å»ºå•ä¾‹å®ä¾‹\nconst loadBalancer = new ComfyUILoadBalancer()\n\nexport default loadBalancer\n"
        }
    ]
}