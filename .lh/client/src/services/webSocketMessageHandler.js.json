{
    "sourceFile": "client/src/services/webSocketMessageHandler.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1753506659483,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1753506659483,
            "name": "Commit-0",
            "content": "// WebSocket æ¶ˆæ¯å¤„ç†å™¨ - ç‹¬ç«‹æ¨¡å—\n// è´Ÿè´£æ‰€æœ‰ WebSocket æ¶ˆæ¯çš„è§£æã€è·¯ç”±å’Œå¤„ç†é€»è¾‘\n\nimport webSocketManager, { WINDOW_ID, WINDOW_CLIENT_ID } from './webSocketManager.js'\n\n/**\n * WebSocket æ¶ˆæ¯å¤„ç†å™¨ç±»\n * å¤„ç†æ‰€æœ‰ç±»å‹çš„ WebSocket æ¶ˆæ¯\n */\nclass WebSocketMessageHandler {\n  constructor(manager) {\n    this.manager = manager\n  }\n\n  // ğŸ”¥ é˜²æŠ–æœºåˆ¶ï¼šé¿å…é¢‘ç¹çš„è¿›åº¦å›è°ƒè§¦å‘é€’å½’æ›´æ–°\n  safeProgressCallback(promptId, task, message, percent) {\n    if (!task.onProgress) return\n\n    // é˜²æŠ–ï¼šåŒä¸€ä»»åŠ¡çš„è¿›åº¦å›è°ƒé—´éš”è‡³å°‘100ms\n    const lastCallTime = this.manager.progressCallbackDebounce.get(promptId) || 0\n    const now = Date.now()\n\n    if (now - lastCallTime < 100) {\n      console.log(`ğŸš« [${WINDOW_ID}] è¿›åº¦å›è°ƒé˜²æŠ–: ${promptId} (${percent}%)`)\n      return\n    }\n\n    this.manager.progressCallbackDebounce.set(promptId, now)\n\n    try {\n      // ä½¿ç”¨queueMicrotaské¿å…é€’å½’æ›´æ–°\n      queueMicrotask(() => {\n        try {\n          task.onProgress(message, percent)\n        } catch (callbackError) {\n          console.error(`âŒ [${WINDOW_ID}] è¿›åº¦å›è°ƒæ‰§è¡Œå¤±è´¥: ${promptId}`, callbackError)\n\n          // å¦‚æœæ˜¯é€’å½’æ›´æ–°é”™è¯¯ï¼Œåœæ­¢åç»­å›è°ƒ\n          if (callbackError.message?.includes('Maximum recursive updates')) {\n            console.error(`ğŸ”¥ [${WINDOW_ID}] æ£€æµ‹åˆ°é€’å½’æ›´æ–°ï¼Œç¦ç”¨è¿›åº¦å›è°ƒ: ${promptId}`)\n            task.onProgress = null\n          }\n        }\n      })\n    } catch (error) {\n      console.error(`âŒ [${WINDOW_ID}] å®‰å…¨è¿›åº¦å›è°ƒå¤±è´¥: ${promptId}`, error)\n    }\n  }\n\n  // ğŸ”¥ è·¨æœåŠ¡å™¨éš”ç¦»çš„WebSocketæ¶ˆæ¯å¤„ç† - åŸºäºå®˜æ–¹APIæ–‡æ¡£é‡æ„\n  handleWebSocketMessage(message) {\n    try {\n      if (!message || typeof message !== 'object') {\n        return\n      }\n\n      const { type, data } = message\n\n      // é™é»˜å¤„ç†crystools.monitoræ¶ˆæ¯ï¼Œé¿å…å¹²æ‰°æ­£å¸¸æ¶ˆæ¯å¤„ç†\n      if (type === 'crystools.monitor') {\n        // é™é»˜å¿½ç•¥crystoolsæ’ä»¶çš„ç›‘æ§æ¶ˆæ¯\n        return\n      }\n\n      // ğŸ”¥ ç®€åŒ–æ¶ˆæ¯è¿‡æ»¤ï¼šå¦‚æœæ‰¾åˆ°ä»»åŠ¡å°±å¤„ç†ï¼Œä¸ä¸¥æ ¼é™åˆ¶çª—å£å½’å±\n      if (data && data.prompt_id) {\n        const task = this.manager.getWindowTask(data.prompt_id)\n        if (!task) {\n          // ä»»åŠ¡ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯å…¶ä»–çª—å£çš„æ¶ˆæ¯ï¼Œé™é»˜å¿½ç•¥\n          return\n        }\n\n        // ğŸ”¥ éªŒè¯æ¶ˆæ¯æ¥æºæœåŠ¡å™¨ä¸€è‡´æ€§\n        const currentLock = this.manager.getWindowServerLock()\n        if (currentLock && task.executionServer && task.executionServer !== currentLock.server) {\n          console.warn(`âš ï¸ [${WINDOW_ID}] è·¨æœåŠ¡å™¨æ¶ˆæ¯æ£€æµ‹: ä»»åŠ¡åœ¨ ${task.executionServer}, å½“å‰é”å®š ${currentLock.server}`)\n          // ä»ç„¶å¤„ç†æ¶ˆæ¯ï¼Œä½†è®°å½•è­¦å‘Šä»¥ä¾¿è°ƒè¯•\n        }\n\n        // ğŸ”¥ è®°å½•æ¶ˆæ¯å¤„ç†æ—¥å¿—ï¼ˆç”¨äºè·¨æœåŠ¡å™¨è°ƒè¯•ï¼‰\n        console.log(`ğŸ“¨ [${WINDOW_ID}] å¤„ç†æ¶ˆæ¯: ${type} (prompt_id: ${data.prompt_id}, æœåŠ¡å™¨: ${task.executionServer || 'æœªçŸ¥'})`)\n      }\n\n      // ğŸ”¥ æ–°å¢ï¼šå¤„ç†progress_stateæ¶ˆæ¯\n      if (type === 'progress_state' && data?.prompt_id) {\n        console.log(`ğŸ“Š [${WINDOW_ID}] progress_stateæ¶ˆæ¯: ${data.prompt_id}`)\n        this.handleProgressStateMessage(data)\n        return\n      }\n\n      // æ ¹æ®å®˜æ–¹WebSocket APIæ–‡æ¡£å¤„ç†æ‰€æœ‰æ ‡å‡†æ¶ˆæ¯ç±»å‹\n      switch (type) {\n        case 'status':\n          // æœåŠ¡å™¨çŠ¶æ€å’Œé˜Ÿåˆ—ä¿¡æ¯\n          this.handleStatusMessage(data)\n          break\n\n        case 'execution_start':\n          // ä»»åŠ¡å¼€å§‹æ‰§è¡Œ - å®˜æ–¹æ ‡å‡†çŠ¶æ€æ£€æµ‹\n          this.handleExecutionStartMessage(data)\n          break\n\n        case 'executing':\n          // èŠ‚ç‚¹æ‰§è¡ŒçŠ¶æ€ - å®˜æ–¹æ ‡å‡†å®Œæˆæ£€æµ‹\n          this.handleExecutingMessage(data)\n          break\n\n        case 'progress':\n          // èŠ‚ç‚¹æ‰§è¡Œè¿›åº¦\n          this.handleProgressMessage(data)\n          break\n\n        case 'executed':\n          // èŠ‚ç‚¹æ‰§è¡Œå®Œæˆ\n          this.handleExecutedMessage(data)\n          break\n\n        case 'execution_cached':\n          // èŠ‚ç‚¹ç¼“å­˜å‘½ä¸­\n          this.handleExecutionCachedMessage(data)\n          break\n\n        case 'execution_error':\n          // æ‰§è¡Œé”™è¯¯\n          this.handleExecutionErrorMessage(data)\n          break\n\n        case 'execution_interrupted':\n          // æ‰§è¡Œä¸­æ–­\n          this.handleExecutionInterruptedMessage(data)\n          break\n\n        default:\n          // è®°å½•æœªçŸ¥æ¶ˆæ¯ç±»å‹ç”¨äºè°ƒè¯•\n          console.log(`ğŸ” [OFFICIAL] æœªçŸ¥æ¶ˆæ¯ç±»å‹: ${type}`, data)\n      }\n\n    } catch (error) {\n      console.error('âŒ [OFFICIAL] WebSocketæ¶ˆæ¯å¤„ç†å¤±è´¥:', error)\n    }\n  }\n\n  // ğŸ”¥ æ–°å¢ï¼šå¤„ç†progress_stateæ¶ˆæ¯\n  handleProgressStateMessage(data) {\n    const { prompt_id, nodes } = data\n    const task = this.manager.getWindowTask(prompt_id)\n\n    if (!task) {\n      console.log(`âš ï¸ [${WINDOW_ID}] progress_state: æœªæ‰¾åˆ°ä»»åŠ¡ ${prompt_id}`)\n      return\n    }\n\n    console.log(`ğŸ“Š [${WINDOW_ID}] å¤„ç†progress_state: ${prompt_id}`)\n\n    // åˆ†æèŠ‚ç‚¹çŠ¶æ€ï¼Œè®¡ç®—æ•´ä½“è¿›åº¦\n    let completedNodes = 0\n    let totalNodes = 0\n\n    for (const nodeId in nodes) {\n      totalNodes++\n      const nodeState = nodes[nodeId]\n\n      // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å®Œæˆï¼ˆæ ¹æ®å®é™…çŠ¶æ€å­—æ®µè°ƒæ•´ï¼‰\n      if (nodeState.completed || nodeState.status === 'completed') {\n        completedNodes++\n      }\n    }\n\n    // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”\n    const progressPercent = totalNodes > 0 ? Math.round((completedNodes / totalNodes) * 100) : 0\n\n    console.log(`ğŸ“Š [${WINDOW_ID}] èŠ‚ç‚¹è¿›åº¦: ${completedNodes}/${totalNodes} (${progressPercent}%)`)\n\n    // æ›´æ–°ä»»åŠ¡è¿›åº¦\n    if (progressPercent > 85) {\n      this.safeProgressCallback(prompt_id, task, `å¤„ç†ä¸­... (${completedNodes}/${totalNodes} èŠ‚ç‚¹)`, progressPercent)\n    }\n\n    // å¦‚æœæ‰€æœ‰èŠ‚ç‚¹éƒ½å®Œæˆï¼Œè§¦å‘ä»»åŠ¡å®Œæˆ\n    if (completedNodes === totalNodes && totalNodes > 0) {\n      console.log(`âœ… [${WINDOW_ID}] progress_stateæ£€æµ‹åˆ°ä»»åŠ¡å®Œæˆ: ${prompt_id}`)\n      queueMicrotask(() => {\n        this.handleTaskCompletion(prompt_id)\n      })\n    }\n  }\n\n  // ğŸ”¥ å¤„ç†æœåŠ¡å™¨çŠ¶æ€æ¶ˆæ¯ - å®˜æ–¹æ ‡å‡†é˜Ÿåˆ—æ£€æµ‹ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n  handleStatusMessage(data) {\n    if (!data || !data.status) {\n      return\n    }\n\n    const execInfo = data.status.exec_info\n    if (!execInfo) {\n      return\n    }\n\n    const queueRemaining = execInfo.queue_remaining || 0\n    console.log(`ğŸ“Š [${WINDOW_ID}] æœåŠ¡å™¨é˜Ÿåˆ—çŠ¶æ€: ${queueRemaining} ä¸ªä»»åŠ¡ç­‰å¾…`)\n\n    // ğŸ”§ åªæ›´æ–°å±äºå½“å‰çª—å£çš„ç­‰å¾…ä¸­ä»»åŠ¡çŠ¶æ€\n    this.manager.windowTasks.forEach((task, promptId) => {\n      // ç¡®ä¿ä»»åŠ¡å±äºå½“å‰çª—å£\n      if (task.windowId === WINDOW_ID && task.status === this.manager.TASK_STATUS.WAITING) {\n        if (queueRemaining > 1) {\n          // å¤šä¸ªä»»åŠ¡ç­‰å¾…æ—¶æ˜¾ç¤ºå…·ä½“æ•°é‡\n          this.safeProgressCallback(promptId, task, `é˜Ÿåˆ—ä¸­è¿˜æœ‰ ${queueRemaining} ä¸ªä»»åŠ¡ç­‰å¾…`, 8)\n        } else if (queueRemaining === 1) {\n          // åªæœ‰ä¸€ä¸ªä»»åŠ¡ç­‰å¾…æ—¶çš„æç¤º\n          this.safeProgressCallback(promptId, task, 'é˜Ÿåˆ—ä¸­è¿˜æœ‰ 1 ä¸ªä»»åŠ¡ç­‰å¾…', 10)\n        } else {\n          // é˜Ÿåˆ—ä¸ºç©ºï¼Œå³å°†å¼€å§‹å¤„ç†\n          this.safeProgressCallback(promptId, task, 'å³å°†å¼€å§‹å¤„ç†...', 12)\n        }\n      }\n    })\n  }\n\n  // ğŸ”¥ å¤„ç†ä»»åŠ¡å¼€å§‹æ‰§è¡Œæ¶ˆæ¯ - å®˜æ–¹æ ‡å‡†çŠ¶æ€æ£€æµ‹ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n  handleExecutionStartMessage(data) {\n    if (!data || !data.prompt_id) {\n      return\n    }\n\n    const promptId = data.prompt_id\n\n    // ğŸ”§ åªå¤„ç†å±äºå½“å‰çª—å£çš„ä»»åŠ¡\n    const task = this.manager.getWindowTask(promptId)\n    if (!task) {\n      console.log(`ğŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„æ‰§è¡Œå¼€å§‹æ¶ˆæ¯: ${promptId}`)\n      return\n    }\n\n    console.log(`ğŸš€ [${WINDOW_ID}] ä»»åŠ¡å¼€å§‹æ‰§è¡Œ: ${promptId}`)\n\n    // åŸå­æ€§çŠ¶æ€æ›´æ–°ï¼šwaiting â†’ executing\n    const updated = this.manager.updateTaskStatus(promptId, this.manager.TASK_STATUS.EXECUTING, {\n      executionStartTime: Date.now(),\n      currentNode: null,\n      completedNodes: []\n    })\n\n    if (updated) {\n      // ğŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›è°ƒ\n      this.safeProgressCallback(promptId, task, 'ä»»åŠ¡å¼€å§‹æ‰§è¡Œ...', 15)\n    }\n  }\n\n  // ğŸ”¥ å¤„ç†èŠ‚ç‚¹ç¼“å­˜å‘½ä¸­æ¶ˆæ¯ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n  handleExecutionCachedMessage(data) {\n    if (!data || !data.prompt_id || !data.nodes) {\n      return\n    }\n\n    const promptId = data.prompt_id\n\n    // ğŸ”§ åªå¤„ç†å±äºå½“å‰çª—å£çš„ä»»åŠ¡\n    const task = this.manager.getWindowTask(promptId)\n    if (!task) {\n      console.log(`ğŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„ç¼“å­˜å‘½ä¸­æ¶ˆæ¯: ${promptId}`)\n      return\n    }\n\n    console.log(`âš¡ [${WINDOW_ID}] ç¼“å­˜å‘½ä¸­: ${promptId}, èŠ‚ç‚¹: [${data.nodes.join(', ')}]`)\n\n    // ğŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›è°ƒ\n    this.safeProgressCallback(promptId, task, `ç¼“å­˜å‘½ä¸­ ${data.nodes.length} ä¸ªèŠ‚ç‚¹`, 25)\n  }\n\n  // ğŸ”¥ å¤„ç†æ‰§è¡Œé”™è¯¯æ¶ˆæ¯ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n  handleExecutionErrorMessage(data) {\n    if (!data || !data.prompt_id) {\n      return\n    }\n\n    const promptId = data.prompt_id\n\n    // ğŸ”§ åªå¤„ç†å±äºå½“å‰çª—å£çš„ä»»åŠ¡\n    const task = this.manager.getWindowTask(promptId)\n    if (!task) {\n      console.log(`ğŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„æ‰§è¡Œé”™è¯¯æ¶ˆæ¯: ${promptId}`)\n      return\n    }\n\n    console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡æ‰§è¡Œé”™è¯¯: ${promptId}`, data)\n\n    // åŸå­æ€§çŠ¶æ€æ›´æ–°ï¼š* â†’ error\n    const updated = this.manager.updateTaskStatus(promptId, this.manager.TASK_STATUS.ERROR, {\n      errorTime: Date.now(),\n      errorData: data\n    })\n\n    if (updated) {\n      // æ¸…ç†ä»»åŠ¡\n      this.manager.removeWindowTask(promptId)\n\n      if (task.onError) {\n        const error = new Error(`æ‰§è¡Œé”™è¯¯: ${data.exception_message || 'æœªçŸ¥é”™è¯¯'}`)\n        error.details = data\n        task.onError(error)\n      }\n    }\n  }\n\n  // ğŸ”¥ å¤„ç†æ‰§è¡Œä¸­æ–­æ¶ˆæ¯ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n  handleExecutionInterruptedMessage(data) {\n    if (!data || !data.prompt_id) {\n      return\n    }\n\n    const promptId = data.prompt_id\n\n    // ğŸ”§ åªå¤„ç†å±äºå½“å‰çª—å£çš„ä»»åŠ¡\n    const task = this.manager.getWindowTask(promptId)\n    if (!task) {\n      console.log(`ğŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„æ‰§è¡Œä¸­æ–­æ¶ˆæ¯: ${promptId}`)\n      return\n    }\n\n    console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡è¢«ä¸­æ–­: ${promptId}`)\n\n    // åŸå­æ€§çŠ¶æ€æ›´æ–°ï¼š* â†’ interrupted\n    const updated = this.manager.updateTaskStatus(promptId, this.manager.TASK_STATUS.INTERRUPTED, {\n      interruptTime: Date.now()\n    })\n\n    if (updated) {\n      // æ¸…ç†ä»»åŠ¡\n      this.manager.removeWindowTask(promptId)\n\n      if (task.onError) {\n        task.onError(new Error('ä»»åŠ¡æ‰§è¡Œè¢«ä¸­æ–­'))\n      }\n    }\n  }\n\n  // ğŸ”¥ å¤„ç†èŠ‚ç‚¹æ‰§è¡Œå®Œæˆæ¶ˆæ¯ - é‡æ„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n  handleExecutedMessage(data) {\n    if (!data || !data.prompt_id || !data.node) {\n      return\n    }\n\n    const promptId = data.prompt_id\n\n    // ğŸ”§ åªå¤„ç†å±äºå½“å‰çª—å£çš„ä»»åŠ¡\n    const task = this.manager.getWindowTask(promptId)\n    if (!task || task.status !== this.manager.TASK_STATUS.EXECUTING) {\n      if (!task) {\n        console.log(`ğŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„èŠ‚ç‚¹å®Œæˆæ¶ˆæ¯: ${promptId}`)\n      }\n      return\n    }\n\n    console.log(`âœ… [${WINDOW_ID}] èŠ‚ç‚¹å®Œæˆ: ${data.node} (ä»»åŠ¡: ${promptId})`)\n\n    // è®°å½•å®Œæˆçš„èŠ‚ç‚¹\n    if (!task.completedNodes) {\n      task.completedNodes = []\n    }\n    task.completedNodes.push(data.node)\n\n    // ğŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›è°ƒ\n    this.safeProgressCallback(promptId, task, `èŠ‚ç‚¹ ${data.node} å®Œæˆ`, 60)\n  }\n\n  // ğŸ”¥ å¤„ç†èŠ‚ç‚¹æ‰§è¡Œè¿›åº¦æ¶ˆæ¯ - é‡æ„ç‰ˆæœ¬ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n  handleProgressMessage(data) {\n    if (!data || !data.prompt_id) {\n      return\n    }\n\n    const promptId = data.prompt_id\n\n    // ğŸ”§ åªå¤„ç†å±äºå½“å‰çª—å£çš„ä»»åŠ¡\n    const task = this.manager.getWindowTask(promptId)\n    if (!task || task.status !== this.manager.TASK_STATUS.EXECUTING) {\n      if (!task) {\n        console.log(`ğŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„è¿›åº¦æ¶ˆæ¯: ${promptId}`)\n      }\n      return\n    }\n\n    if (data.value !== undefined && data.max !== undefined) {\n      const progress = Math.round((data.value / data.max) * 100)\n      const overallProgress = 40 + (progress * 0.5) // 40-90%åŒºé—´\n\n      console.log(`ğŸ“ˆ [${WINDOW_ID}] è¿›åº¦æ›´æ–°: ${promptId} - ${data.value}/${data.max} (${progress}%)`)\n\n      // ğŸ”§ ä½¿ç”¨å®‰å…¨è¿›åº¦å›è°ƒ\n      this.safeProgressCallback(promptId, task, `å¤„ç†è¿›åº¦: ${data.value}/${data.max}`, overallProgress)\n    }\n  }\n\n  // ğŸ”¥ å¤„ç†èŠ‚ç‚¹æ‰§è¡ŒçŠ¶æ€æ¶ˆæ¯ - å®˜æ–¹æ ‡å‡†å®Œæˆæ£€æµ‹ï¼ˆçª—å£éš”ç¦»ç‰ˆæœ¬ï¼‰\n  handleExecutingMessage(data) {\n    if (!data || !data.prompt_id) {\n      return\n    }\n\n    const promptId = data.prompt_id\n\n    // ğŸ”§ åªå¤„ç†å±äºå½“å‰çª—å£çš„ä»»åŠ¡\n    const task = this.manager.getWindowTask(promptId)\n    if (!task) {\n      console.log(`ğŸ” [${WINDOW_ID}] å¿½ç•¥å…¶ä»–çª—å£çš„æ‰§è¡ŒçŠ¶æ€æ¶ˆæ¯: ${promptId}`)\n      return\n    }\n\n    // å®˜æ–¹æ ‡å‡†åŒé‡æ¡ä»¶æ£€æµ‹ï¼šdata.node === null && data.prompt_id === promptId\n    if (data.node === null && data.prompt_id === promptId) {\n      console.log(`ğŸ¯ [${WINDOW_ID}] ä»»åŠ¡æ‰§è¡Œå®Œæˆ: ${promptId}`)\n\n      // åŸå­æ€§çŠ¶æ€æ›´æ–°ï¼šexecuting â†’ completed\n      this.manager.updateTaskStatus(promptId, this.manager.TASK_STATUS.COMPLETED, {\n        completionTime: Date.now()\n      })\n\n      // ç«‹å³å¤„ç†ä»»åŠ¡å®Œæˆ\n      this.handleTaskCompletion(promptId)\n\n    } else if (data.node !== null) {\n      // æ­£åœ¨æ‰§è¡ŒæŸä¸ªèŠ‚ç‚¹\n      console.log(`âš™ï¸ [${WINDOW_ID}] æ‰§è¡ŒèŠ‚ç‚¹: ${data.node} (ä»»åŠ¡: ${promptId})`)\n\n      // æ›´æ–°å½“å‰æ‰§è¡ŒèŠ‚ç‚¹\n      if (task.status === this.manager.TASK_STATUS.EXECUTING) {\n        task.currentNode = data.node\n\n        if (task.onProgress) {\n          task.onProgress(`æ­£åœ¨æ‰§è¡Œ: ${data.node}`, 40)\n        }\n      }\n    }\n  }\n\n  // ğŸ”¥ è·¨æœåŠ¡å™¨ä»»åŠ¡å®Œæˆå¤„ç† - ç«‹å³å“åº”ç‰ˆæœ¬ï¼ˆæ¶ˆé™¤å»¶è¿Ÿï¼‰\n  async handleTaskCompletion(promptId) {\n    // ğŸ”§ åªå¤„ç†å±äºå½“å‰çª—å£çš„ä»»åŠ¡\n    const task = this.manager.getWindowTask(promptId)\n    if (!task) {\n      console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡æœªæ‰¾åˆ°æˆ–ä¸å±äºå½“å‰çª—å£: ${promptId}`)\n      return\n    }\n\n    console.log(`ğŸš€ [${WINDOW_ID}] å¼€å§‹ç«‹å³å¤„ç†ä»»åŠ¡å®Œæˆ: ${promptId} (æœåŠ¡å™¨: ${task.executionServer || 'æœªçŸ¥'})`)\n\n    try {\n      // ğŸ”§ ç«‹å³æ›´æ–°è¿›åº¦åˆ°98%ï¼Œè¡¨ç¤ºæ­£åœ¨è·å–ç»“æœ\n      if (task.onProgress) {\n        task.onProgress('æ­£åœ¨è·å–å¤„ç†ç»“æœ...', 98)\n      }\n\n      console.log(`ğŸ” [${WINDOW_ID}] ç«‹å³è·å–ä»»åŠ¡å†å²è®°å½•: ${promptId} (æœåŠ¡å™¨: ${task.executionServer || 'æœªçŸ¥'})`)\n\n      // è¿™é‡Œéœ€è¦è°ƒç”¨å¤–éƒ¨çš„å†å²è®°å½•è·å–å‡½æ•°\n      // ç”±äºè¿™æ˜¯ç‹¬ç«‹æ¨¡å—ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡å›è°ƒæˆ–äº‹ä»¶æ¥å¤„ç†\n      if (task.onComplete) {\n        // ğŸ”§ ç«‹å³æ›´æ–°è¿›åº¦åˆ°100%\n        if (task.onProgress) {\n          task.onProgress('å¤„ç†å®Œæˆ', 100)\n        }\n\n        // ğŸ”§ ç«‹å³æ¸…ç†ä»»åŠ¡å¹¶è°ƒç”¨å®Œæˆå›è°ƒ\n        this.manager.removeWindowTask(promptId)\n        console.log(`ğŸ§¹ [${WINDOW_ID}] ä»»åŠ¡æ¸…ç†å®Œæˆ: ${promptId}`)\n\n        // ğŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n        this.manager.checkServerUnlockCondition()\n\n        console.log(`ğŸ‰ [${WINDOW_ID}] ç«‹å³è°ƒç”¨å®Œæˆå›è°ƒ: ${promptId}`)\n        // ğŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿å›è°ƒç«‹å³æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n        setTimeout(() => {\n          // è¿™é‡Œéœ€è¦ä¼ é€’ä¸€ä¸ªåŸºæœ¬çš„ç»“æœå¯¹è±¡ï¼Œå®é™…çš„ç»“æœè·å–ç”±å¤–éƒ¨å¤„ç†\n          task.onComplete({ promptId, executionServer: task.executionServer })\n        }, 0)\n      }\n\n    } catch (error) {\n      console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡å®Œæˆå¤„ç†å¤±è´¥: ${promptId}`, error.message)\n\n      // ç«‹å³æ¸…ç†ä»»åŠ¡å¹¶è°ƒç”¨é”™è¯¯å›è°ƒ\n      this.manager.removeWindowTask(promptId)\n\n      // ğŸ”§ æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æœåŠ¡å™¨\n      this.manager.checkServerUnlockCondition()\n\n      if (task.onError) {\n        // ğŸ”§ ä½¿ç”¨setTimeout(0)ç¡®ä¿é”™è¯¯å›è°ƒç«‹å³æ‰§è¡Œï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰\n        setTimeout(() => {\n          task.onError(error.message)\n        }, 0)\n      }\n    }\n  }\n}\n\n// åˆ›å»ºæ¶ˆæ¯å¤„ç†å™¨å®ä¾‹\nconst messageHandler = new WebSocketMessageHandler(webSocketManager)\n\n// å°†æ¶ˆæ¯å¤„ç†æ–¹æ³•æ·»åŠ åˆ°ä¸»ç®¡ç†å™¨\nwebSocketManager.handleWebSocketMessage = messageHandler.handleWebSocketMessage.bind(messageHandler)\nwebSocketManager.safeProgressCallback = messageHandler.safeProgressCallback.bind(messageHandler)\n\nexport default messageHandler\nexport { messageHandler }\n"
        }
    ]
}