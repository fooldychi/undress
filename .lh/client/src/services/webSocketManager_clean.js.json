{
    "sourceFile": "client/src/services/webSocketManager_clean.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1753522050924,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1753522050924,
            "name": "Commit-0",
            "content": "// æç®€ç‰ˆ WebSocket ç®¡ç†å™¨ - åŸºäºå®˜æ–¹ websockets_api_example.py\n// æ”¯æŒå¤šç”¨æˆ·å¤šçª—å£ã€æœåŠ¡å™¨é€‰æ‹©ã€ä»»åŠ¡é”å®šæœºåˆ¶\n\nimport loadBalancer from './loadBalancer.js'\n\n// ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦\nfunction generateId() {\n  return `${Date.now()}_${Math.random().toString(36).substring(2, 11)}`\n}\n\n// çª—å£å”¯ä¸€æ ‡è¯†\nconst WINDOW_ID = generateId()\nconst CLIENT_ID = generateId()\n\nconsole.log(`ğŸªŸ çª—å£ID: ${WINDOW_ID}`)\nconsole.log(`ğŸ”‘ å®¢æˆ·ç«¯ID: ${CLIENT_ID}`)\n\n/**\n * æç®€ç‰ˆ WebSocket ç®¡ç†å™¨\n * åŸºäºå®˜æ–¹ websockets_api_example.py çš„æ ¸å¿ƒé€»è¾‘\n */\nclass SimpleWebSocketManager {\n  constructor() {\n    // WebSocket è¿æ¥\n    this.ws = null\n    this.isConnected = false\n    this.currentServer = null\n\n    // ä»»åŠ¡ç®¡ç† - åªä¿ç•™å½“å‰çª—å£çš„ä»»åŠ¡\n    this.tasks = new Map() // promptId -> { onComplete, onError, onProgress, server }\n\n    // æœåŠ¡å™¨é”å®š - ç®€åŒ–ä¸ºçª—å£çº§åˆ«\n    this.lockedServer = null\n    this.lockTimestamp = null\n\n    // åˆå§‹åŒ–çª—å£äº‹ä»¶\n    this._initWindowEvents()\n  }\n\n  // çª—å£å…³é—­æ¸…ç†\n  _initWindowEvents() {\n    window.addEventListener('beforeunload', () => {\n      console.log(`ğŸšª [${WINDOW_ID}] çª—å£å…³é—­ï¼Œæ¸…ç†èµ„æº`)\n      this._cleanup()\n    })\n  }\n\n  // æ¸…ç†èµ„æº\n  _cleanup() {\n    if (this.ws) {\n      this.ws.close()\n      this.ws = null\n    }\n    this.tasks.clear()\n    this.lockedServer = null\n    this.isConnected = false\n  }\n\n  // è¿æ¥åˆ°æŒ‡å®šæœåŠ¡å™¨\n  async connectToServer(serverUrl) {\n    if (this.ws && this.isConnected && this.currentServer === serverUrl) {\n      console.log(`âœ… [${WINDOW_ID}] å·²è¿æ¥åˆ°æœåŠ¡å™¨: ${serverUrl}`)\n      return true\n    }\n\n    // å…³é—­ç°æœ‰è¿æ¥\n    if (this.ws) {\n      this.ws.close()\n    }\n\n    try {\n      const wsUrl = `${serverUrl.replace('http', 'ws')}/ws?clientId=${CLIENT_ID}`\n      console.log(`ğŸ”Œ [${WINDOW_ID}] è¿æ¥åˆ°: ${wsUrl}`)\n\n      this.ws = new WebSocket(wsUrl)\n      this.currentServer = serverUrl\n\n      return new Promise((resolve, reject) => {\n        const timeout = setTimeout(() => {\n          reject(new Error('è¿æ¥è¶…æ—¶'))\n        }, 10000)\n\n        this.ws.onopen = () => {\n          this.isConnected = true\n          clearTimeout(timeout)\n          console.log(`âœ… [${WINDOW_ID}] WebSocketè¿æ¥æˆåŠŸ: ${serverUrl}`)\n          resolve(true)\n        }\n\n        this.ws.onerror = (error) => {\n          this.isConnected = false\n          clearTimeout(timeout)\n          console.error(`âŒ [${WINDOW_ID}] WebSocketè¿æ¥å¤±è´¥:`, error)\n          reject(error)\n        }\n\n        this.ws.onclose = () => {\n          this.isConnected = false\n          console.log(`ğŸ”Œ [${WINDOW_ID}] WebSocketè¿æ¥å…³é—­`)\n        }\n\n        // æ ¸å¿ƒæ¶ˆæ¯å¤„ç† - åŸºäºå®˜æ–¹æ ·ä¾‹\n        this.ws.onmessage = (event) => {\n          try {\n            // å¿½ç•¥ Blob ç±»å‹æ¶ˆæ¯ï¼ˆå›¾ç‰‡é¢„è§ˆç­‰äºŒè¿›åˆ¶æ•°æ®ï¼‰\n            if (event.data instanceof Blob) {\n              return\n            }\n\n            const message = JSON.parse(event.data)\n            this._handleMessage(message)\n          } catch (error) {\n            console.error(`âŒ [${WINDOW_ID}] æ¶ˆæ¯è§£æå¤±è´¥:`, error)\n          }\n        }\n      })\n    } catch (error) {\n      console.error(`âŒ [${WINDOW_ID}] è¿æ¥å¤±è´¥:`, error)\n      throw error\n    }\n  }\n\n  // æ¶ˆæ¯å¤„ç† - åŸºäºå®˜æ–¹ websockets_api_example.py ç¬¬37-40è¡Œ\n  _handleMessage(message) {\n    const { type, data } = message\n\n    // åªå¤„ç† executing æ¶ˆæ¯ï¼Œæ£€æµ‹ä»»åŠ¡å®Œæˆ\n    if (type === 'executing' && data) {\n      const { node, prompt_id } = data\n\n      // ä»»åŠ¡å®Œæˆæ£€æµ‹ï¼šnode ä¸º null è¡¨ç¤ºæ‰§è¡Œå®Œæˆ\n      if (node === null && prompt_id) {\n        this._handleTaskCompletion(prompt_id)\n      } else if (node && prompt_id) {\n        // ä»»åŠ¡æ‰§è¡Œä¸­ï¼Œæ›´æ–°è¿›åº¦\n        this._handleTaskProgress(prompt_id, `æ‰§è¡ŒèŠ‚ç‚¹: ${node}`, 50)\n      }\n    }\n\n    // å¤„ç†å…¶ä»–æ¶ˆæ¯ç±»å‹\n    if (type === 'progress' && data && data.prompt_id) {\n      this._handleTaskProgress(data.prompt_id, 'å¤„ç†ä¸­...', data.value || 0)\n    }\n\n    if (type === 'execution_error' && data && data.prompt_id) {\n      this._handleTaskError(data.prompt_id, data.exception_message || 'æ‰§è¡Œé”™è¯¯')\n    }\n  }\n\n  // ä»»åŠ¡è¿›åº¦å¤„ç†\n  _handleTaskProgress(promptId, message, progress) {\n    const task = this.tasks.get(promptId)\n    if (task && task.onProgress) {\n      task.onProgress(message, progress)\n    }\n  }\n\n  // ä»»åŠ¡å®Œæˆå¤„ç† - åŸºäºå®˜æ–¹æ ·ä¾‹ç¬¬47-56è¡Œ\n  async _handleTaskCompletion(promptId) {\n    const task = this.tasks.get(promptId)\n    if (!task) {\n      console.warn(`âš ï¸ [${WINDOW_ID}] ä»»åŠ¡ä¸å­˜åœ¨: ${promptId}`)\n      return\n    }\n\n    try {\n      // è·å–ä»»åŠ¡å†å² - åŸºäºå®˜æ–¹æ ·ä¾‹ç¬¬47è¡Œ\n      const history = await this._getHistory(promptId)\n\n      // æå–ç»“æœ - åŸºäºå®˜æ–¹æ ·ä¾‹ç¬¬48-56è¡Œ\n      const result = this._extractResults(history, promptId)\n\n      // ä¿å­˜ä»»åŠ¡æ‰§è¡ŒæœåŠ¡å™¨ä¿¡æ¯\n      if (result && task && task.server) {\n        result.executionServer = task.server\n        result.promptId = promptId\n        result.taskStartTime = task.startTime\n      } else {\n        // å°è¯•ä»å½“å‰é”å®šæœåŠ¡å™¨è·å–\n        const currentLock = this.getWindowServerLock()\n        if (currentLock && currentLock.server) {\n          result.executionServer = currentLock.server\n          result.promptId = promptId\n        }\n      }\n\n      // è°ƒç”¨å®Œæˆå›è°ƒ\n      if (task.onComplete) {\n        task.onComplete(result)\n      }\n    } catch (error) {\n      console.error(`âŒ [${WINDOW_ID}] ä»»åŠ¡ç»“æœè·å–å¤±è´¥: ${promptId}`, error)\n      if (task.onError) {\n        task.onError(error)\n      }\n    } finally {\n      // æ¸…ç†ä»»åŠ¡\n      this.tasks.delete(promptId)\n\n      // æ£€æŸ¥æ˜¯å¦éœ€è¦è§£é”æœåŠ¡å™¨\n      this._checkUnlock()\n    }\n  }\n\n  // ä»»åŠ¡é”™è¯¯å¤„ç†\n  _handleTaskError(promptId, errorMessage) {\n    const task = this.tasks.get(promptId)\n    if (task && task.onError) {\n      task.onError(new Error(errorMessage))\n    }\n    this.tasks.delete(promptId)\n    this._checkUnlock()\n  }\n\n  // è·å–ä»»åŠ¡å†å² - åŸºäºå®˜æ–¹æ ·ä¾‹ç¬¬25-27è¡Œ\n  async _getHistory(promptId) {\n    const response = await fetch(`${this.currentServer}/api/history/${promptId}`)\n    if (!response.ok) {\n      throw new Error(`è·å–å†å²å¤±è´¥: ${response.status}`)\n    }\n    return await response.json()\n  }\n\n  // æå–ç»“æœ - åŸºäºå®˜æ–¹æ ·ä¾‹ç¬¬47-56è¡Œ\n  _extractResults(history, promptId) {\n    const taskData = history[promptId]\n    if (!taskData || !taskData.outputs) {\n      return { outputs: {} }\n    }\n\n    // ä¿ç•™å®Œæ•´çš„è¾“å‡ºæ•°æ®ç»“æ„\n    const results = {\n      outputs: taskData.outputs,\n      promptId: promptId,\n      status: taskData.status,\n      meta: taskData.meta || {}\n    }\n\n    return results\n  }\n\n  // é€‰æ‹©æœ€ä½³æœåŠ¡å™¨\n  async _selectBestServer() {\n    try {\n      const bestServer = await loadBalancer.getBestServer()\n      return bestServer\n    } catch (error) {\n      console.error(`âŒ [${WINDOW_ID}] æœåŠ¡å™¨é€‰æ‹©å¤±è´¥:`, error)\n      throw error\n    }\n  }\n\n  // é”å®šæœåŠ¡å™¨\n  _lockServer(serverUrl) {\n    if (!this.lockedServer) {\n      this.lockedServer = serverUrl\n      this.lockTimestamp = Date.now()\n    }\n  }\n\n  // æ£€æŸ¥è§£é”æ¡ä»¶\n  _checkUnlock() {\n    if (this.tasks.size === 0 && this.lockedServer) {\n      this.lockedServer = null\n      this.lockTimestamp = null\n    }\n  }\n\n  // æäº¤ä»»åŠ¡ - åŸºäºå®˜æ–¹æ ·ä¾‹ç¬¬13-17è¡Œ\n  async submitTask(workflow, promptId, callbacks = {}) {\n    try {\n      // é€‰æ‹©æœåŠ¡å™¨\n      const serverUrl = this.lockedServer || await this._selectBestServer()\n\n      // è¿æ¥åˆ°æœåŠ¡å™¨\n      await this.connectToServer(serverUrl)\n\n      // é”å®šæœåŠ¡å™¨\n      this._lockServer(serverUrl)\n\n      // æ³¨å†Œä»»åŠ¡\n      this.tasks.set(promptId, {\n        ...callbacks,\n        server: serverUrl,\n        startTime: Date.now()\n      })\n\n      // æäº¤å·¥ä½œæµ - åŸºäºå®˜æ–¹æ ·ä¾‹ç¬¬14-17è¡Œ\n      const requestBody = {\n        prompt: workflow,\n        client_id: CLIENT_ID,\n        prompt_id: promptId\n      }\n\n      const response = await fetch(`${serverUrl}/api/prompt`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(requestBody)\n      })\n\n      if (!response.ok) {\n        throw new Error(`æäº¤å¤±è´¥: ${response.status}`)\n      }\n\n      console.log(`âœ… [${WINDOW_ID}] ä»»åŠ¡æäº¤æˆåŠŸ: ${promptId}`)\n      return promptId\n\n    } catch (error) {\n      // æ¸…ç†å¤±è´¥çš„ä»»åŠ¡\n      this.tasks.delete(promptId)\n      this._checkUnlock()\n      throw error\n    }\n  }\n\n  // ç­‰å¾…ä»»åŠ¡å®Œæˆ - åŸºäºå®˜æ–¹æ ·ä¾‹ç¬¬33-40è¡Œçš„ while True é€»è¾‘\n  async waitForCompletion(promptId, callbacks = {}) {\n    return new Promise((resolve, reject) => {\n      const task = this.tasks.get(promptId)\n      if (!task) {\n        reject(new Error(`ä»»åŠ¡ä¸å­˜åœ¨: ${promptId}`))\n        return\n      }\n\n      // æ›´æ–°å›è°ƒ\n      task.onComplete = resolve\n      task.onError = reject\n      task.onProgress = callbacks.onProgress || (() => {})\n\n      console.log(`â³ [${WINDOW_ID}] ç­‰å¾…ä»»åŠ¡å®Œæˆ: ${promptId}`)\n    })\n  }\n\n  // è·å–çŠ¶æ€ä¿¡æ¯\n  getStatus() {\n    return {\n      windowId: WINDOW_ID,\n      clientId: CLIENT_ID,\n      connected: this.isConnected,\n      server: this.currentServer,\n      lockedServer: this.lockedServer,\n      taskCount: this.tasks.size\n    }\n  }\n\n  // ==================== å…¼å®¹æ€§æ–¹æ³• ====================\n\n  // å…¼å®¹åŸæœ‰æ¥å£\n  async initializeWebSocket(targetServer = null) {\n    const serverUrl = targetServer || this.lockedServer || await this._selectBestServer()\n    return await this.connectToServer(serverUrl)\n  }\n\n  async ensureWebSocketConnection(taskServer = null) {\n    const serverUrl = taskServer || this.currentServer\n    if (serverUrl && this.isConnected && this.currentServer === serverUrl) {\n      return true\n    }\n    return await this.connectToServer(serverUrl || await this._selectBestServer())\n  }\n\n  // ä»»åŠ¡ç®¡ç†å…¼å®¹æ–¹æ³•\n  registerWindowTask(promptId, task) {\n    this.tasks.set(promptId, task)\n    console.log(`ğŸ“ [${WINDOW_ID}] ä»»åŠ¡å·²æ³¨å†Œ: ${promptId}`)\n  }\n\n  getWindowTask(promptId) {\n    return this.tasks.get(promptId)\n  }\n\n  removeWindowTask(promptId) {\n    const removed = this.tasks.delete(promptId)\n    if (removed) {\n      console.log(`ğŸ—‘ï¸ [${WINDOW_ID}] ä»»åŠ¡å·²ç§»é™¤: ${promptId}`)\n      this._checkUnlock()\n    }\n    return removed\n  }\n\n  // æœåŠ¡å™¨é”å®šå…¼å®¹æ–¹æ³•\n  lockServerForWindow(serverUrl) {\n    this._lockServer(serverUrl)\n  }\n\n  unlockServerForWindow() {\n    console.log(`ğŸ”“ [${WINDOW_ID}] æ‰‹åŠ¨è§£é”æœåŠ¡å™¨: ${this.lockedServer}`)\n    this.lockedServer = null\n    this.lockTimestamp = null\n  }\n\n  getWindowServerLock() {\n    if (this.lockedServer) {\n      return {\n        server: this.lockedServer,\n        timestamp: this.lockTimestamp,\n        windowId: WINDOW_ID\n      }\n    }\n    return null\n  }\n\n  // ä»»åŠ¡å®Œæˆå¤„ç† - ä¾›å¤–éƒ¨è°ƒç”¨\n  async handleTaskCompletion(promptId) {\n    await this._handleTaskCompletion(promptId)\n  }\n\n  // è¿›åº¦å›è°ƒå®‰å…¨åŒ…è£…\n  safeProgressCallback(task, message, progress) {\n    if (task && task.onProgress) {\n      try {\n        task.onProgress(message, progress)\n      } catch (error) {\n        console.error(`âŒ [${WINDOW_ID}] è¿›åº¦å›è°ƒé”™è¯¯:`, error)\n      }\n    }\n  }\n\n  // è·å–ä»»åŠ¡ç»‘å®šçš„æœåŠ¡å™¨\n  getTaskBoundServer(promptId) {\n    const task = this.tasks.get(promptId)\n    return task ? task.server : null\n  }\n\n  // æ£€æŸ¥æœåŠ¡å™¨è§£é”æ¡ä»¶\n  checkServerUnlockCondition() {\n    this._checkUnlock()\n  }\n\n  // çª—å£ä»»åŠ¡å±æ€§ï¼ˆå…¼å®¹æ€§ï¼‰\n  get windowTasks() {\n    return this.tasks\n  }\n\n  // ä»»åŠ¡çŠ¶æ€æšä¸¾ï¼ˆå…¼å®¹æ€§ï¼‰\n  get TASK_STATUS() {\n    return {\n      WAITING: 'waiting',\n      EXECUTING: 'executing',\n      COMPLETED: 'completed',\n      ERROR: 'error',\n      INTERRUPTED: 'interrupted'\n    }\n  }\n\n  // å…¼å®¹æ€§å±æ€§\n  get wsConnection() {\n    return this.ws\n  }\n\n  get isWsConnected() {\n    return this.isConnected\n  }\n\n  get currentWebSocketServer() {\n    return this.currentServer\n  }\n}\n\n// åˆ›å»ºå…¨å±€å®ä¾‹\nconst webSocketManager = new SimpleWebSocketManager()\n\n// å…¨å±€å…¼å®¹æ€§è®¾ç½®\nif (typeof window !== 'undefined') {\n  // ä¿æŒåŸæœ‰çš„å…¨å±€å˜é‡å…¼å®¹æ€§\n  window.pendingTasks = webSocketManager.tasks\n\n  // å…¼å®¹åŸæœ‰çš„å…¨å±€å‡½æ•°\n  window.getWindowTask = webSocketManager.getWindowTask.bind(webSocketManager)\n  window.removeWindowTask = webSocketManager.removeWindowTask.bind(webSocketManager)\n\n  console.log(`ğŸ”§ [${WINDOW_ID}] å…¼å®¹æ€§æ¥å£å·²è®¾ç½®`)\n}\n\n// å¯¼å‡º\nexport default webSocketManager\nexport { WINDOW_ID, CLIENT_ID, CLIENT_ID as WINDOW_CLIENT_ID }\n"
        }
    ]
}