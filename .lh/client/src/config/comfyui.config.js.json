{
    "sourceFile": "client/src/config/comfyui.config.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 14,
            "patches": [
                {
                    "date": 1752326421095,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752327511240,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,11 +2,11 @@\n class ComfyUIConfig {\r\n   constructor() {\r\n     // é»˜è®¤é…ç½®ï¼ˆä½œä¸ºåå¤‡ï¼‰\r\n     this.defaultConfig = {\r\n-      BASE_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://hwf0p724ub-8188.cnb.run',\r\n-      CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'abc1373d4ad648a3a81d0587fbe5534b',\r\n-      REQUEST_TIMEOUT: 30000,\r\n+      BASE_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://your-comfyui-server.com',\r\n+      CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'your-comfyui-client-id',\r\n+      REQUEST_TIMEOUT: parseInt(import.meta.env.VITE_COMFYUI_TIMEOUT) || 30000,\r\n       HEALTH_CHECK_TIMEOUT: 10000,\r\n       AUTO_SWITCH: true,\r\n       MAX_RETRIES: 3,\r\n       BACKUP_SERVERS: []\r\n"
                },
                {
                    "date": 1752327542066,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -42,9 +42,9 @@\n       if (result.success && result.data) {\r\n         const serverConfig = {\r\n           BASE_URL: result.data['comfyui.server_url'] || this.defaultConfig.BASE_URL,\r\n           CLIENT_ID: result.data['comfyui.client_id'] || this.defaultConfig.CLIENT_ID,\r\n-          REQUEST_TIMEOUT: parseInt(result.data['comfyui.request_timeout']) || this.defaultConfig.REQUEST_TIMEOUT,\r\n+          REQUEST_TIMEOUT: parseInt(result.data['comfyui.timeout']) || parseInt(result.data['comfyui.request_timeout']) || this.defaultConfig.REQUEST_TIMEOUT,\r\n           HEALTH_CHECK_TIMEOUT: parseInt(result.data['comfyui.health_check_timeout']) || this.defaultConfig.HEALTH_CHECK_TIMEOUT,\r\n           AUTO_SWITCH: result.data['comfyui.auto_switch'] === 'true' || result.data['comfyui.auto_switch'] === true,\r\n           MAX_RETRIES: parseInt(result.data['comfyui.max_retries']) || this.defaultConfig.MAX_RETRIES,\r\n           BACKUP_SERVERS: this.parseBackupServers(result.data['comfyui.backup_servers'])\r\n"
                },
                {
                    "date": 1752328795454,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -81,11 +81,49 @@\n     // åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼\r\n     return import.meta.env.VITE_API_BASE_URL || window.location.origin;\r\n   }\r\n \r\n+  // æ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®\r\n+  cleanupOldHardcodedConfig() {\r\n+    const savedConfig = localStorage.getItem('comfyui_config');\r\n+    if (savedConfig) {\r\n+      try {\r\n+        const parsed = JSON.parse(savedConfig);\r\n+        const hardcodedUrls = [\r\n+          'https://5gke5y9mzc-8188.cnb.run',\r\n+          'https://hwf0p724ub-8188.cnb.run',\r\n+          'https://dzqgp58z0s-8188.cnb.run'\r\n+        ];\r\n+        const hardcodedIds = [\r\n+          'abc1373d4ad648a3a81d0587fbe5534b'\r\n+        ];\r\n+\r\n+        // æ£€æŸ¥æ˜¯å¦åŒ…å«ç¡¬ç¼–ç é…ç½®\r\n+        const hasHardcodedUrl = hardcodedUrls.includes(parsed.COMFYUI_SERVER_URL || parsed.BASE_URL);\r\n+        const hasHardcodedId = hardcodedIds.includes(parsed.CLIENT_ID);\r\n+\r\n+        if (hasHardcodedUrl || hasHardcodedId) {\r\n+          console.warn('ğŸ§¹ æ£€æµ‹åˆ°æ—§çš„ç¡¬ç¼–ç é…ç½®ï¼Œæ­£åœ¨æ¸…ç†...');\r\n+          console.warn('æ—§é…ç½®:', parsed);\r\n+          localStorage.removeItem('comfyui_config');\r\n+          console.log('âœ… å·²æ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®');\r\n+          return true;\r\n+        }\r\n+      } catch (error) {\r\n+        console.warn('è§£ælocalStorageé…ç½®å¤±è´¥ï¼Œæ¸…ç†é…ç½®:', error);\r\n+        localStorage.removeItem('comfyui_config');\r\n+        return true;\r\n+      }\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n   // è·å–é…ç½®ï¼ˆå¼‚æ­¥ï¼‰\r\n   async getConfig() {\r\n-    if (this.configLoaded && this.currentConfig) {\r\n+    // é¦–å…ˆæ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®\r\n+    const wasCleanedUp = this.cleanupOldHardcodedConfig();\r\n+\r\n+    if (this.configLoaded && this.currentConfig && !wasCleanedUp) {\r\n       return this.currentConfig;\r\n     }\r\n \r\n     // å¦‚æœæ­£åœ¨åŠ è½½é…ç½®ï¼Œç­‰å¾…åŠ è½½å®Œæˆ\r\n"
                },
                {
                    "date": 1752328900395,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,192 +1,13 @@\n-// ComfyUIé…ç½® - åŠ¨æ€é…ç½®æ¨¡å¼\r\n-class ComfyUIConfig {\r\n-  constructor() {\r\n-    // é»˜è®¤é…ç½®ï¼ˆä½œä¸ºåå¤‡ï¼‰\r\n-    this.defaultConfig = {\r\n-      BASE_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://your-comfyui-server.com',\r\n-      CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'your-comfyui-client-id',\r\n-      REQUEST_TIMEOUT: parseInt(import.meta.env.VITE_COMFYUI_TIMEOUT) || 30000,\r\n-      HEALTH_CHECK_TIMEOUT: 10000,\r\n-      AUTO_SWITCH: true,\r\n-      MAX_RETRIES: 3,\r\n-      BACKUP_SERVERS: []\r\n-    };\r\n+// ComfyUIé…ç½® - ç›´è¿æ¨¡å¼\r\n+const config = {\r\n+  // ComfyUIæœåŠ¡å™¨URLï¼ˆæ”¯æŒç¯å¢ƒå˜é‡é…ç½®ï¼‰\r\n+  BASE_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://hwf0p724ub-8188.cnb.run',\r\n+  CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'abc1373d4ad648a3a81d0587fbe5534b',\r\n \r\n-    // å½“å‰é…ç½®ç¼“å­˜\r\n-    this.currentConfig = null;\r\n-    this.configLoaded = false;\r\n-    this.configPromise = null;\r\n+  // è·å–API URLï¼ˆç›´è¿æ¨¡å¼ï¼‰\r\n+  getApiUrl() {\r\n+    return this.BASE_URL;\r\n   }\r\n+};\r\n \r\n-  // ä»æœåŠ¡å™¨è·å–é…ç½®\r\n-  async fetchConfigFromServer() {\r\n-    try {\r\n-      console.log('ğŸ”„ ä»æœåŠ¡å™¨è·å–ComfyUIé…ç½®...');\r\n-\r\n-      // è·å–åç«¯APIåŸºç¡€URL\r\n-      const apiBaseUrl = this.getBackendApiUrl();\r\n-      const response = await fetch(`${apiBaseUrl}/api/config`, {\r\n-        method: 'GET',\r\n-        headers: {\r\n-          'Content-Type': 'application/json'\r\n-        },\r\n-        timeout: 10000\r\n-      });\r\n-\r\n-      if (!response.ok) {\r\n-        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n-      }\r\n-\r\n-      const result = await response.json();\r\n-\r\n-      if (result.success && result.data) {\r\n-        const serverConfig = {\r\n-          BASE_URL: result.data['comfyui.server_url'] || this.defaultConfig.BASE_URL,\r\n-          CLIENT_ID: result.data['comfyui.client_id'] || this.defaultConfig.CLIENT_ID,\r\n-          REQUEST_TIMEOUT: parseInt(result.data['comfyui.timeout']) || parseInt(result.data['comfyui.request_timeout']) || this.defaultConfig.REQUEST_TIMEOUT,\r\n-          HEALTH_CHECK_TIMEOUT: parseInt(result.data['comfyui.health_check_timeout']) || this.defaultConfig.HEALTH_CHECK_TIMEOUT,\r\n-          AUTO_SWITCH: result.data['comfyui.auto_switch'] === 'true' || result.data['comfyui.auto_switch'] === true,\r\n-          MAX_RETRIES: parseInt(result.data['comfyui.max_retries']) || this.defaultConfig.MAX_RETRIES,\r\n-          BACKUP_SERVERS: this.parseBackupServers(result.data['comfyui.backup_servers'])\r\n-        };\r\n-\r\n-        console.log('âœ… æˆåŠŸè·å–æœåŠ¡å™¨é…ç½®:', serverConfig);\r\n-        return serverConfig;\r\n-      } else {\r\n-        throw new Error('æœåŠ¡å™¨è¿”å›çš„é…ç½®æ•°æ®æ ¼å¼é”™è¯¯');\r\n-      }\r\n-    } catch (error) {\r\n-      console.warn('âš ï¸ è·å–æœåŠ¡å™¨é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error.message);\r\n-      return this.defaultConfig;\r\n-    }\r\n-  }\r\n-\r\n-  // è§£æå¤‡ç”¨æœåŠ¡å™¨åˆ—è¡¨\r\n-  parseBackupServers(backupServersString) {\r\n-    if (!backupServersString) return [];\r\n-\r\n-    return backupServersString\r\n-      .split('\\n')\r\n-      .map(server => server.trim())\r\n-      .filter(server => server && server.startsWith('http'));\r\n-  }\r\n-\r\n-  // è·å–åç«¯APIåŸºç¡€URL\r\n-  getBackendApiUrl() {\r\n-    // åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨ä»£ç†\r\n-    if (import.meta.env.DEV) {\r\n-      return '';  // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œç”±Viteä»£ç†å¤„ç†\r\n-    }\r\n-\r\n-    // åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼\r\n-    return import.meta.env.VITE_API_BASE_URL || window.location.origin;\r\n-  }\r\n-\r\n-  // æ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®\r\n-  cleanupOldHardcodedConfig() {\r\n-    const savedConfig = localStorage.getItem('comfyui_config');\r\n-    if (savedConfig) {\r\n-      try {\r\n-        const parsed = JSON.parse(savedConfig);\r\n-        const hardcodedUrls = [\r\n-          'https://5gke5y9mzc-8188.cnb.run',\r\n-          'https://hwf0p724ub-8188.cnb.run',\r\n-          'https://dzqgp58z0s-8188.cnb.run'\r\n-        ];\r\n-        const hardcodedIds = [\r\n-          'abc1373d4ad648a3a81d0587fbe5534b'\r\n-        ];\r\n-\r\n-        // æ£€æŸ¥æ˜¯å¦åŒ…å«ç¡¬ç¼–ç é…ç½®\r\n-        const hasHardcodedUrl = hardcodedUrls.includes(parsed.COMFYUI_SERVER_URL || parsed.BASE_URL);\r\n-        const hasHardcodedId = hardcodedIds.includes(parsed.CLIENT_ID);\r\n-\r\n-        if (hasHardcodedUrl || hasHardcodedId) {\r\n-          console.warn('ğŸ§¹ æ£€æµ‹åˆ°æ—§çš„ç¡¬ç¼–ç é…ç½®ï¼Œæ­£åœ¨æ¸…ç†...');\r\n-          console.warn('æ—§é…ç½®:', parsed);\r\n-          localStorage.removeItem('comfyui_config');\r\n-          console.log('âœ… å·²æ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®');\r\n-          return true;\r\n-        }\r\n-      } catch (error) {\r\n-        console.warn('è§£ælocalStorageé…ç½®å¤±è´¥ï¼Œæ¸…ç†é…ç½®:', error);\r\n-        localStorage.removeItem('comfyui_config');\r\n-        return true;\r\n-      }\r\n-    }\r\n-    return false;\r\n-  }\r\n-\r\n-  // è·å–é…ç½®ï¼ˆå¼‚æ­¥ï¼‰\r\n-  async getConfig() {\r\n-    // é¦–å…ˆæ¸…ç†æ—§çš„ç¡¬ç¼–ç é…ç½®\r\n-    const wasCleanedUp = this.cleanupOldHardcodedConfig();\r\n-\r\n-    if (this.configLoaded && this.currentConfig && !wasCleanedUp) {\r\n-      return this.currentConfig;\r\n-    }\r\n-\r\n-    // å¦‚æœæ­£åœ¨åŠ è½½é…ç½®ï¼Œç­‰å¾…åŠ è½½å®Œæˆ\r\n-    if (this.configPromise) {\r\n-      return await this.configPromise;\r\n-    }\r\n-\r\n-    // å¼€å§‹åŠ è½½é…ç½®\r\n-    this.configPromise = this.fetchConfigFromServer();\r\n-\r\n-    try {\r\n-      this.currentConfig = await this.configPromise;\r\n-      this.configLoaded = true;\r\n-      console.log('ğŸ¯ ComfyUIé…ç½®åŠ è½½å®Œæˆ:', this.currentConfig);\r\n-      return this.currentConfig;\r\n-    } catch (error) {\r\n-      console.error('âŒ åŠ è½½ComfyUIé…ç½®å¤±è´¥:', error);\r\n-      this.currentConfig = this.defaultConfig;\r\n-      this.configLoaded = true;\r\n-      return this.currentConfig;\r\n-    } finally {\r\n-      this.configPromise = null;\r\n-    }\r\n-  }\r\n-\r\n-  // è·å–API URLï¼ˆå¼‚æ­¥ï¼‰\r\n-  async getApiUrl() {\r\n-    const config = await this.getConfig();\r\n-    return config.BASE_URL;\r\n-  }\r\n-\r\n-  // è·å–å®¢æˆ·ç«¯IDï¼ˆå¼‚æ­¥ï¼‰\r\n-  async getClientId() {\r\n-    const config = await this.getConfig();\r\n-    return config.CLIENT_ID;\r\n-  }\r\n-\r\n-  // è·å–è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆå¼‚æ­¥ï¼‰\r\n-  async getRequestTimeout() {\r\n-    const config = await this.getConfig();\r\n-    return config.REQUEST_TIMEOUT;\r\n-  }\r\n-\r\n-  // è·å–å¤‡ç”¨æœåŠ¡å™¨åˆ—è¡¨ï¼ˆå¼‚æ­¥ï¼‰\r\n-  async getBackupServers() {\r\n-    const config = await this.getConfig();\r\n-    return config.BACKUP_SERVERS;\r\n-  }\r\n-\r\n-  // åˆ·æ–°é…ç½®\r\n-  async refreshConfig() {\r\n-    this.configLoaded = false;\r\n-    this.currentConfig = null;\r\n-    return await this.getConfig();\r\n-  }\r\n-\r\n-  // åŒæ­¥è·å–é…ç½®ï¼ˆå¦‚æœå·²åŠ è½½ï¼‰\r\n\\ No newline at end of file\n-  getCurrentConfig() {\r\n-    return this.currentConfig || this.defaultConfig;\r\n-  }\r\n-}\r\n-\r\n-// åˆ›å»ºå•ä¾‹å®ä¾‹\r\n-const comfyUIConfig = new ComfyUIConfig();\r\n-\r\n-export default comfyUIConfig;\n+export default config;\n\\ No newline at end of file\n"
                },
                {
                    "date": 1752514253914,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,8 @@\n // ComfyUIé…ç½® - ç›´è¿æ¨¡å¼\r\n const config = {\r\n   // ComfyUIæœåŠ¡å™¨URLï¼ˆæ”¯æŒç¯å¢ƒå˜é‡é…ç½®ï¼‰\r\n-  BASE_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://hwf0p724ub-8188.cnb.run',\r\n+  BASE_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://l9s75ay3rp-8188.cnb.run',\r\n   CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'abc1373d4ad648a3a81d0587fbe5534b',\r\n \r\n   // è·å–API URLï¼ˆç›´è¿æ¨¡å¼ï¼‰\r\n   getApiUrl() {\r\n"
                },
                {
                    "date": 1752547513315,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,11 +3,85 @@\n   // ComfyUIæœåŠ¡å™¨URLï¼ˆæ”¯æŒç¯å¢ƒå˜é‡é…ç½®ï¼‰\r\n   BASE_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://l9s75ay3rp-8188.cnb.run',\r\n   CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'abc1373d4ad648a3a81d0587fbe5534b',\r\n \r\n+  // ComfyUIå®˜æ–¹å¥åº·æ£€æµ‹ç«¯ç‚¹é…ç½®\r\n+  HEALTH_CHECK: {\r\n+    // ä¸»è¦ç«¯ç‚¹ - ComfyUIå®˜æ–¹æ¨èï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰\r\n+    PRIMARY_ENDPOINTS: [\r\n+      '/api/queue',        // é˜Ÿåˆ—çŠ¶æ€ç«¯ç‚¹ - æœ€é‡è¦çš„å¥åº·æŒ‡æ ‡\r\n+      '/api/system_stats', // ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹ - æœåŠ¡å™¨ä¿¡æ¯\r\n+    ],\r\n+\r\n+    // å¤‡ç”¨ç«¯ç‚¹ - å…¼å®¹æ—§ç‰ˆæœ¬ComfyUI\r\n+    FALLBACK_ENDPOINTS: [\r\n+      '/queue',            // å¤‡ç”¨é˜Ÿåˆ—ç«¯ç‚¹\r\n+      '/system_stats',     // å¤‡ç”¨ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\r\n+    ],\r\n+\r\n+    // æ‰©å±•ç«¯ç‚¹ - é¢å¤–åŠŸèƒ½æ£€æµ‹ï¼ˆå¯é€‰ï¼‰\r\n+    EXTENDED_ENDPOINTS: [\r\n+      '/object_info',      // èŠ‚ç‚¹ä¿¡æ¯ç«¯ç‚¹\r\n+      '/prompt',           // æç¤ºçŠ¶æ€ç«¯ç‚¹\r\n+      '/history',          // å†å²è®°å½•ç«¯ç‚¹\r\n+    ],\r\n+\r\n+    // æ ‡å‡†è¯·æ±‚å¤´é…ç½®\r\n+    HEADERS: {\r\n+      'Accept': 'application/json, */*',\r\n+      'Accept-Language': 'zh-CN,zh;q=0.9',\r\n+      'Cache-Control': 'no-cache',\r\n+      'comfy-user': 'health-monitor',\r\n+      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0 Safari/537.36'\r\n+    },\r\n+\r\n+    // è¶…æ—¶é…ç½®\r\n+    TIMEOUT: 10000, // 10ç§’\r\n+\r\n+    // å“åº”éªŒè¯é…ç½®\r\n+    VALIDATION: {\r\n+      // é˜Ÿåˆ—ç«¯ç‚¹çš„æœ‰æ•ˆå“åº”ç‰¹å¾\r\n+      QUEUE_INDICATORS: ['queue_running', 'queue_pending', 'exec_info'],\r\n+      // ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹çš„æœ‰æ•ˆå“åº”ç‰¹å¾\r\n+      STATS_INDICATORS: ['system', 'devices', 'python_version'],\r\n+    }\r\n+  },\r\n+\r\n   // è·å–API URLï¼ˆç›´è¿æ¨¡å¼ï¼‰\r\n   getApiUrl() {\r\n     return this.BASE_URL;\r\n+  },\r\n+\r\n+  // è·å–å¥åº·æ£€æµ‹ç«¯ç‚¹åˆ—è¡¨ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰\r\n+  getHealthCheckEndpoints() {\r\n+    return [\r\n+      ...this.HEALTH_CHECK.PRIMARY_ENDPOINTS,\r\n+      ...this.HEALTH_CHECK.FALLBACK_ENDPOINTS\r\n+    ];\r\n+  },\r\n+\r\n+  // éªŒè¯ComfyUIå“åº”æ˜¯å¦æœ‰æ•ˆ\r\n+  validateResponse(endpoint, data) {\r\n+    if (!data || typeof data !== 'object') {\r\n+      return false;\r\n+    }\r\n+\r\n+    // éªŒè¯é˜Ÿåˆ—ç«¯ç‚¹å“åº”\r\n+    if (endpoint.includes('queue')) {\r\n+      return this.HEALTH_CHECK.VALIDATION.QUEUE_INDICATORS.some(\r\n+        indicator => data.hasOwnProperty(indicator)\r\n+      );\r\n+    }\r\n+\r\n+    // éªŒè¯ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹å“åº”\r\n+    if (endpoint.includes('system_stats')) {\r\n+      return this.HEALTH_CHECK.VALIDATION.STATS_INDICATORS.some(\r\n+        indicator => data.hasOwnProperty(indicator)\r\n+      );\r\n+    }\r\n+\r\n+    // å…¶ä»–ç«¯ç‚¹åªè¦æ˜¯æœ‰æ•ˆJSONå°±è®¤ä¸ºæ­£å¸¸\r\n+    return true;\r\n   }\r\n };\r\n \r\n export default config;\n\\ No newline at end of file\n"
                },
                {
                    "date": 1752547967814,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,27 +5,14 @@\n   CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'abc1373d4ad648a3a81d0587fbe5534b',\r\n \r\n   // ComfyUIå®˜æ–¹å¥åº·æ£€æµ‹ç«¯ç‚¹é…ç½®\r\n   HEALTH_CHECK: {\r\n-    // ä¸»è¦ç«¯ç‚¹ - ComfyUIå®˜æ–¹æ¨èï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰\r\n-    PRIMARY_ENDPOINTS: [\r\n+    // å®˜æ–¹ç«¯ç‚¹ - ComfyUIå®˜æ–¹æ¨èï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰\r\n+    ENDPOINTS: [\r\n       '/api/queue',        // é˜Ÿåˆ—çŠ¶æ€ç«¯ç‚¹ - æœ€é‡è¦çš„å¥åº·æŒ‡æ ‡\r\n       '/api/system_stats', // ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹ - æœåŠ¡å™¨ä¿¡æ¯\r\n     ],\r\n \r\n-    // å¤‡ç”¨ç«¯ç‚¹ - å…¼å®¹æ—§ç‰ˆæœ¬ComfyUI\r\n-    FALLBACK_ENDPOINTS: [\r\n-      '/queue',            // å¤‡ç”¨é˜Ÿåˆ—ç«¯ç‚¹\r\n-      '/system_stats',     // å¤‡ç”¨ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\r\n-    ],\r\n-\r\n-    // æ‰©å±•ç«¯ç‚¹ - é¢å¤–åŠŸèƒ½æ£€æµ‹ï¼ˆå¯é€‰ï¼‰\r\n-    EXTENDED_ENDPOINTS: [\r\n-      '/object_info',      // èŠ‚ç‚¹ä¿¡æ¯ç«¯ç‚¹\r\n-      '/prompt',           // æç¤ºçŠ¶æ€ç«¯ç‚¹\r\n-      '/history',          // å†å²è®°å½•ç«¯ç‚¹\r\n-    ],\r\n-\r\n     // æ ‡å‡†è¯·æ±‚å¤´é…ç½®\r\n     HEADERS: {\r\n       'Accept': 'application/json, */*',\r\n       'Accept-Language': 'zh-CN,zh;q=0.9',\r\n"
                },
                {
                    "date": 1752547981011,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -39,12 +39,9 @@\n   },\r\n \r\n   // è·å–å¥åº·æ£€æµ‹ç«¯ç‚¹åˆ—è¡¨ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰\r\n   getHealthCheckEndpoints() {\r\n-    return [\r\n-      ...this.HEALTH_CHECK.PRIMARY_ENDPOINTS,\r\n-      ...this.HEALTH_CHECK.FALLBACK_ENDPOINTS\r\n-    ];\r\n+    return [...this.HEALTH_CHECK.ENDPOINTS];\r\n   },\r\n \r\n   // éªŒè¯ComfyUIå“åº”æ˜¯å¦æœ‰æ•ˆ\r\n   validateResponse(endpoint, data) {\r\n"
                },
                {
                    "date": 1752550384009,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,15 +11,12 @@\n       '/api/queue',        // é˜Ÿåˆ—çŠ¶æ€ç«¯ç‚¹ - æœ€é‡è¦çš„å¥åº·æŒ‡æ ‡\r\n       '/api/system_stats', // ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹ - æœåŠ¡å™¨ä¿¡æ¯\r\n     ],\r\n \r\n-    // æ ‡å‡†è¯·æ±‚å¤´é…ç½®\r\n+    // æ ‡å‡†è¯·æ±‚å¤´é…ç½® - ç®€åŒ–ä»¥é¿å…CORSé—®é¢˜\r\n     HEADERS: {\r\n-      'Accept': 'application/json, */*',\r\n-      'Accept-Language': 'zh-CN,zh;q=0.9',\r\n-      'Cache-Control': 'no-cache',\r\n-      'comfy-user': 'health-monitor',\r\n-      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0 Safari/537.36'\r\n+      'Accept': 'application/json',\r\n+      'comfy-user': 'health-monitor'\r\n     },\r\n \r\n     // è¶…æ—¶é…ç½®\r\n     TIMEOUT: 10000, // 10ç§’\r\n"
                },
                {
                    "date": 1752550589880,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,12 +11,11 @@\n       '/api/queue',        // é˜Ÿåˆ—çŠ¶æ€ç«¯ç‚¹ - æœ€é‡è¦çš„å¥åº·æŒ‡æ ‡\r\n       '/api/system_stats', // ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹ - æœåŠ¡å™¨ä¿¡æ¯\r\n     ],\r\n \r\n-    // æ ‡å‡†è¯·æ±‚å¤´é…ç½® - ç®€åŒ–ä»¥é¿å…CORSé—®é¢˜\r\n+    // æ ‡å‡†è¯·æ±‚å¤´é…ç½® - åªä½¿ç”¨æœåŠ¡å™¨å…è®¸çš„å¤´éƒ¨\r\n     HEADERS: {\r\n-      'Accept': 'application/json',\r\n-      'comfy-user': 'health-monitor'\r\n+      'Accept': 'application/json'\r\n     },\r\n \r\n     // è¶…æ—¶é…ç½®\r\n     TIMEOUT: 10000, // 10ç§’\r\n"
                },
                {
                    "date": 1752551064408,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -60,8 +60,41 @@\n     }\r\n \r\n     // å…¶ä»–ç«¯ç‚¹åªè¦æ˜¯æœ‰æ•ˆJSONå°±è®¤ä¸ºæ­£å¸¸\r\n     return true;\r\n+  },\r\n+\r\n+  // è§£æé˜Ÿåˆ—ä¿¡æ¯\r\n+  parseQueueInfo(data) {\r\n+    if (!data || typeof data !== 'object') {\r\n+      return { running: 0, pending: 0, total: 0 };\r\n+    }\r\n+\r\n+    const running = Array.isArray(data.queue_running) ? data.queue_running.length : 0;\r\n+    const pending = Array.isArray(data.queue_pending) ? data.queue_pending.length : 0;\r\n+\r\n+    return {\r\n+      running,\r\n+      pending,\r\n+      total: running + pending\r\n+    };\r\n+  },\r\n+\r\n+  // è§£æç³»ç»Ÿä¿¡æ¯\r\n+  parseSystemInfo(data) {\r\n+    if (!data || !data.system) {\r\n+      return null;\r\n+    }\r\n+\r\n+    return {\r\n+      os: data.system.os,\r\n+      comfyui_version: data.system.comfyui_version,\r\n+      python_version: data.system.python_version,\r\n+      pytorch_version: data.system.pytorch_version,\r\n+      ram_total: data.system.ram_total,\r\n+      ram_free: data.system.ram_free,\r\n+      devices: data.devices || []\r\n+    };\r\n   }\r\n };\r\n \r\n export default config;\n\\ No newline at end of file\n"
                },
                {
                    "date": 1752556086149,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,12 +5,12 @@\n   CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'abc1373d4ad648a3a81d0587fbe5534b',\r\n \r\n   // ComfyUIå®˜æ–¹å¥åº·æ£€æµ‹ç«¯ç‚¹é…ç½®\r\n   HEALTH_CHECK: {\r\n-    // å®˜æ–¹ç«¯ç‚¹ - ComfyUIå®˜æ–¹æ¨èï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰\r\n+    // å®˜æ–¹ç«¯ç‚¹ - æ ¹æ®ComfyUIå®˜æ–¹æ–‡æ¡£ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰\r\n     ENDPOINTS: [\r\n-      '/api/queue',        // é˜Ÿåˆ—çŠ¶æ€ç«¯ç‚¹ - æœ€é‡è¦çš„å¥åº·æŒ‡æ ‡\r\n-      '/api/system_stats', // ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹ - æœåŠ¡å™¨ä¿¡æ¯\r\n+      '/queue',        // é˜Ÿåˆ—çŠ¶æ€ç«¯ç‚¹ - æœ€é‡è¦çš„å¥åº·æŒ‡æ ‡\r\n+      '/system_stats', // ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹ - æœåŠ¡å™¨ä¿¡æ¯\r\n     ],\r\n \r\n     // æ ‡å‡†è¯·æ±‚å¤´é…ç½® - åªä½¿ç”¨æœåŠ¡å™¨å…è®¸çš„å¤´éƒ¨\r\n     HEADERS: {\r\n"
                },
                {
                    "date": 1752556250787,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,10 +7,10 @@\n   // ComfyUIå®˜æ–¹å¥åº·æ£€æµ‹ç«¯ç‚¹é…ç½®\r\n   HEALTH_CHECK: {\r\n     // å®˜æ–¹ç«¯ç‚¹ - æ ¹æ®ComfyUIå®˜æ–¹æ–‡æ¡£ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰\r\n     ENDPOINTS: [\r\n-      '/queue',        // é˜Ÿåˆ—çŠ¶æ€ç«¯ç‚¹ - æœ€é‡è¦çš„å¥åº·æŒ‡æ ‡\r\n-      '/system_stats', // ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹ - æœåŠ¡å™¨ä¿¡æ¯\r\n+      '/api/queue',        // é˜Ÿåˆ—çŠ¶æ€ç«¯ç‚¹ - æœ€é‡è¦çš„å¥åº·æŒ‡æ ‡\r\n+      '/api/system_stats', // ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹ - æœåŠ¡å™¨ä¿¡æ¯\r\n     ],\r\n \r\n     // æ ‡å‡†è¯·æ±‚å¤´é…ç½® - åªä½¿ç”¨æœåŠ¡å™¨å…è®¸çš„å¤´éƒ¨\r\n     HEADERS: {\r\n"
                },
                {
                    "date": 1752557150442,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,12 +11,10 @@\n       '/api/queue',        // é˜Ÿåˆ—çŠ¶æ€ç«¯ç‚¹ - æœ€é‡è¦çš„å¥åº·æŒ‡æ ‡\r\n       '/api/system_stats', // ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹ - æœåŠ¡å™¨ä¿¡æ¯\r\n     ],\r\n \r\n-    // æ ‡å‡†è¯·æ±‚å¤´é…ç½® - åªä½¿ç”¨æœåŠ¡å™¨å…è®¸çš„å¤´éƒ¨\r\n-    HEADERS: {\r\n-      'Accept': 'application/json'\r\n-    },\r\n+    // æ ‡å‡†è¯·æ±‚å¤´é…ç½® - æœ€ç®€åŒ–é…ç½®\r\n+    HEADERS: {},\r\n \r\n     // è¶…æ—¶é…ç½®\r\n     TIMEOUT: 10000, // 10ç§’\r\n \r\n"
                }
            ],
            "date": 1752326421095,
            "name": "Commit-0",
            "content": "// ComfyUIé…ç½® - åŠ¨æ€é…ç½®æ¨¡å¼\r\nclass ComfyUIConfig {\r\n  constructor() {\r\n    // é»˜è®¤é…ç½®ï¼ˆä½œä¸ºåå¤‡ï¼‰\r\n    this.defaultConfig = {\r\n      BASE_URL: import.meta.env.VITE_COMFYUI_SERVER_URL || 'https://hwf0p724ub-8188.cnb.run',\r\n      CLIENT_ID: import.meta.env.VITE_COMFYUI_CLIENT_ID || 'abc1373d4ad648a3a81d0587fbe5534b',\r\n      REQUEST_TIMEOUT: 30000,\r\n      HEALTH_CHECK_TIMEOUT: 10000,\r\n      AUTO_SWITCH: true,\r\n      MAX_RETRIES: 3,\r\n      BACKUP_SERVERS: []\r\n    };\r\n\r\n    // å½“å‰é…ç½®ç¼“å­˜\r\n    this.currentConfig = null;\r\n    this.configLoaded = false;\r\n    this.configPromise = null;\r\n  }\r\n\r\n  // ä»æœåŠ¡å™¨è·å–é…ç½®\r\n  async fetchConfigFromServer() {\r\n    try {\r\n      console.log('ğŸ”„ ä»æœåŠ¡å™¨è·å–ComfyUIé…ç½®...');\r\n\r\n      // è·å–åç«¯APIåŸºç¡€URL\r\n      const apiBaseUrl = this.getBackendApiUrl();\r\n      const response = await fetch(`${apiBaseUrl}/api/config`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        timeout: 10000\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n      }\r\n\r\n      const result = await response.json();\r\n\r\n      if (result.success && result.data) {\r\n        const serverConfig = {\r\n          BASE_URL: result.data['comfyui.server_url'] || this.defaultConfig.BASE_URL,\r\n          CLIENT_ID: result.data['comfyui.client_id'] || this.defaultConfig.CLIENT_ID,\r\n          REQUEST_TIMEOUT: parseInt(result.data['comfyui.request_timeout']) || this.defaultConfig.REQUEST_TIMEOUT,\r\n          HEALTH_CHECK_TIMEOUT: parseInt(result.data['comfyui.health_check_timeout']) || this.defaultConfig.HEALTH_CHECK_TIMEOUT,\r\n          AUTO_SWITCH: result.data['comfyui.auto_switch'] === 'true' || result.data['comfyui.auto_switch'] === true,\r\n          MAX_RETRIES: parseInt(result.data['comfyui.max_retries']) || this.defaultConfig.MAX_RETRIES,\r\n          BACKUP_SERVERS: this.parseBackupServers(result.data['comfyui.backup_servers'])\r\n        };\r\n\r\n        console.log('âœ… æˆåŠŸè·å–æœåŠ¡å™¨é…ç½®:', serverConfig);\r\n        return serverConfig;\r\n      } else {\r\n        throw new Error('æœåŠ¡å™¨è¿”å›çš„é…ç½®æ•°æ®æ ¼å¼é”™è¯¯');\r\n      }\r\n    } catch (error) {\r\n      console.warn('âš ï¸ è·å–æœåŠ¡å™¨é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error.message);\r\n      return this.defaultConfig;\r\n    }\r\n  }\r\n\r\n  // è§£æå¤‡ç”¨æœåŠ¡å™¨åˆ—è¡¨\r\n  parseBackupServers(backupServersString) {\r\n    if (!backupServersString) return [];\r\n\r\n    return backupServersString\r\n      .split('\\n')\r\n      .map(server => server.trim())\r\n      .filter(server => server && server.startsWith('http'));\r\n  }\r\n\r\n  // è·å–åç«¯APIåŸºç¡€URL\r\n  getBackendApiUrl() {\r\n    // åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨ä»£ç†\r\n    if (import.meta.env.DEV) {\r\n      return '';  // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œç”±Viteä»£ç†å¤„ç†\r\n    }\r\n\r\n    // åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼\r\n    return import.meta.env.VITE_API_BASE_URL || window.location.origin;\r\n  }\r\n\r\n  // è·å–é…ç½®ï¼ˆå¼‚æ­¥ï¼‰\r\n  async getConfig() {\r\n    if (this.configLoaded && this.currentConfig) {\r\n      return this.currentConfig;\r\n    }\r\n\r\n    // å¦‚æœæ­£åœ¨åŠ è½½é…ç½®ï¼Œç­‰å¾…åŠ è½½å®Œæˆ\r\n    if (this.configPromise) {\r\n      return await this.configPromise;\r\n    }\r\n\r\n    // å¼€å§‹åŠ è½½é…ç½®\r\n    this.configPromise = this.fetchConfigFromServer();\r\n\r\n    try {\r\n      this.currentConfig = await this.configPromise;\r\n      this.configLoaded = true;\r\n      console.log('ğŸ¯ ComfyUIé…ç½®åŠ è½½å®Œæˆ:', this.currentConfig);\r\n      return this.currentConfig;\r\n    } catch (error) {\r\n      console.error('âŒ åŠ è½½ComfyUIé…ç½®å¤±è´¥:', error);\r\n      this.currentConfig = this.defaultConfig;\r\n      this.configLoaded = true;\r\n      return this.currentConfig;\r\n    } finally {\r\n      this.configPromise = null;\r\n    }\r\n  }\r\n\r\n  // è·å–API URLï¼ˆå¼‚æ­¥ï¼‰\r\n  async getApiUrl() {\r\n    const config = await this.getConfig();\r\n    return config.BASE_URL;\r\n  }\r\n\r\n  // è·å–å®¢æˆ·ç«¯IDï¼ˆå¼‚æ­¥ï¼‰\r\n  async getClientId() {\r\n    const config = await this.getConfig();\r\n    return config.CLIENT_ID;\r\n  }\r\n\r\n  // è·å–è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆå¼‚æ­¥ï¼‰\r\n  async getRequestTimeout() {\r\n    const config = await this.getConfig();\r\n    return config.REQUEST_TIMEOUT;\r\n  }\r\n\r\n  // è·å–å¤‡ç”¨æœåŠ¡å™¨åˆ—è¡¨ï¼ˆå¼‚æ­¥ï¼‰\r\n  async getBackupServers() {\r\n    const config = await this.getConfig();\r\n    return config.BACKUP_SERVERS;\r\n  }\r\n\r\n  // åˆ·æ–°é…ç½®\r\n  async refreshConfig() {\r\n    this.configLoaded = false;\r\n    this.currentConfig = null;\r\n    return await this.getConfig();\r\n  }\r\n\r\n  // åŒæ­¥è·å–é…ç½®ï¼ˆå¦‚æœå·²åŠ è½½ï¼‰\r\n  getCurrentConfig() {\r\n    return this.currentConfig || this.defaultConfig;\r\n  }\r\n}\r\n\r\n// åˆ›å»ºå•ä¾‹å®ä¾‹\r\nconst comfyUIConfig = new ComfyUIConfig();\r\n\r\nexport default comfyUIConfig;"
        }
    ]
}