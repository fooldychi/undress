{
    "sourceFile": "client/src/test-server-consistency-fix.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1752953607125,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752953625603,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -272,10 +272,18 @@\n   await testTaskServerBinding()\n   await testImageUrlWithBoundServer()\n   await testMultiWindowIsolation()\n   await testCompleteImageUrlFlow()\n+  await testExtractTaskResultsOfficialFix()\n \n   console.log('\\nğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼')\n+  console.log('\\nğŸ“‹ ä¿®å¤æ€»ç»“:')\n+  console.log('âœ… processUndressImage() ä½¿ç”¨ getTaskBoundImageUrl()')\n+  console.log('âœ… processFaceSwapImage() ä½¿ç”¨ getTaskBoundImageUrl()')\n+  console.log('âœ… registerWindowTask() è®°å½•æ‰§è¡ŒæœåŠ¡å™¨')\n+  console.log('âœ… buildImageUrlWithServer() æ­£ç¡®å¤„ç†èŠ‚ç‚¹é…ç½®')\n+  console.log('âœ… extractTaskResultsOfficial() ä½¿ç”¨ä»»åŠ¡ç»‘å®šæœåŠ¡å™¨')\n+  console.log('\\nğŸ¯ ç»“æœ: å¤šçª—å£æœåŠ¡å™¨ä¸€è‡´æ€§é—®é¢˜å·²å½»åº•è§£å†³ï¼')\n }\n \n // å¦‚æœç›´æ¥è¿è¡Œæ­¤æ–‡ä»¶ï¼Œæ‰§è¡Œæµ‹è¯•\n if (import.meta.url === `file://${process.argv[1]}`) {\n@@ -285,6 +293,7 @@\n export {\n   testTaskServerBinding,\n   testImageUrlWithBoundServer,\n   testMultiWindowIsolation,\n-  testCompleteImageUrlFlow\n+  testCompleteImageUrlFlow,\n+  testExtractTaskResultsOfficialFix\n }\n"
                }
            ],
            "date": 1752953607125,
            "name": "Commit-0",
            "content": "/**\n * å¤šçª—å£æœåŠ¡å™¨ä¸€è‡´æ€§ä¿®å¤æµ‹è¯•\n * éªŒè¯å›¾ç‰‡URLç”Ÿæˆæ˜¯å¦ä½¿ç”¨æ­£ç¡®çš„æœåŠ¡å™¨åœ°å€\n */\n\nimport {\n  getTaskBoundImageUrl,\n  buildImageUrlWithServer,\n  registerWindowTask,\n  getWindowTask,\n  removeWindowTask,\n  windowTasks,\n  WINDOW_ID\n} from './services/comfyui.js'\n\n// æ¨¡æ‹ŸæœåŠ¡å™¨åœ°å€\nconst mockServers = [\n  'http://192.168.1.100:8188',\n  'http://192.168.1.101:8188',\n  'http://192.168.1.102:8188'\n]\n\n// æ¨¡æ‹Ÿä»»åŠ¡ç»“æœ\nconst mockTaskResult = {\n  outputs: {\n    \"730\": {\n      images: [\n        {\n          filename: \"ComfyUI_00001_.png\",\n          subfolder: \"\",\n          type: \"output\"\n        }\n      ]\n    },\n    \"812\": {\n      images: [\n        {\n          filename: \"ComfyUI_00002_.png\",\n          subfolder: \"\",\n          type: \"output\"\n        }\n      ]\n    }\n  }\n}\n\n// æ¨¡æ‹ŸèŠ‚ç‚¹é…ç½®\nconst mockNodeConfig = {\n  outputNodes: {\n    primary: \"730\",\n    secondary: [\"812\", \"813\", \"746\"]\n  }\n}\n\n// æµ‹è¯•1: éªŒè¯ä»»åŠ¡ç»‘å®šæœåŠ¡å™¨è®°å½•\nasync function testTaskServerBinding() {\n  console.log('\\nğŸ§ª æµ‹è¯•1: ä»»åŠ¡ç»‘å®šæœåŠ¡å™¨è®°å½•')\n\n  try {\n    const promptId = 'test-prompt-001'\n    const mockTask = {\n      workflowType: 'undress',\n      createdAt: new Date().toISOString(),\n      onProgress: null,\n      onComplete: null,\n      onError: null\n    }\n\n    // æ¨¡æ‹Ÿçª—å£é”å®šæœåŠ¡å™¨\n    window.windowLockedServer = mockServers[0]\n\n    // æ³¨å†Œä»»åŠ¡\n    registerWindowTask(promptId, mockTask)\n\n    // éªŒè¯ä»»åŠ¡æ˜¯å¦æ­£ç¡®è®°å½•äº†æ‰§è¡ŒæœåŠ¡å™¨\n    const registeredTask = getWindowTask(promptId)\n\n    if (registeredTask && registeredTask.executionServer === mockServers[0]) {\n      console.log('âœ… æµ‹è¯•1é€šè¿‡: ä»»åŠ¡æ­£ç¡®è®°å½•äº†æ‰§è¡ŒæœåŠ¡å™¨')\n      console.log(`   ç»‘å®šæœåŠ¡å™¨: ${registeredTask.executionServer}`)\n    } else {\n      console.error('âŒ æµ‹è¯•1å¤±è´¥: ä»»åŠ¡æœªæ­£ç¡®è®°å½•æ‰§è¡ŒæœåŠ¡å™¨')\n      console.error(`   æœŸæœ›: ${mockServers[0]}`)\n      console.error(`   å®é™…: ${registeredTask?.executionServer}`)\n    }\n\n    // æ¸…ç†\n    removeWindowTask(promptId)\n\n  } catch (error) {\n    console.error('âŒ æµ‹è¯•1å¼‚å¸¸:', error)\n  }\n}\n\n// æµ‹è¯•2: éªŒè¯å›¾ç‰‡URLä½¿ç”¨ä»»åŠ¡ç»‘å®šçš„æœåŠ¡å™¨\nasync function testImageUrlWithBoundServer() {\n  console.log('\\nğŸ§ª æµ‹è¯•2: å›¾ç‰‡URLä½¿ç”¨ä»»åŠ¡ç»‘å®šçš„æœåŠ¡å™¨')\n\n  try {\n    const promptId = 'test-prompt-002'\n    const mockTask = {\n      workflowType: 'undress',\n      executionServer: mockServers[1], // æ‰‹åŠ¨è®¾ç½®ç»‘å®šæœåŠ¡å™¨\n      createdAt: new Date().toISOString()\n    }\n\n    // æ³¨å†Œä»»åŠ¡\n    windowTasks.set(promptId, mockTask)\n\n    // æ¨¡æ‹Ÿ buildImageUrlWithServer å‡½æ•°\n    const expectedUrl = `${mockServers[1]}/api/view?filename=ComfyUI_00001_.png&type=output&subfolder=`\n\n    // éªŒè¯URLæ„å»º\n    const imageUrl = await buildImageUrlWithServer(mockServers[1], mockTaskResult, 'undress')\n    console.log(`ğŸŒ ç”Ÿæˆçš„å›¾ç‰‡URL: ${imageUrl}`)\n\n    if (imageUrl.includes(mockServers[1])) {\n      console.log('âœ… æµ‹è¯•2é€šè¿‡: å›¾ç‰‡URLä½¿ç”¨äº†ä»»åŠ¡ç»‘å®šçš„æœåŠ¡å™¨')\n    } else {\n      console.error('âŒ æµ‹è¯•2å¤±è´¥: å›¾ç‰‡URLæœªä½¿ç”¨ç»‘å®šæœåŠ¡å™¨')\n      console.error(`   æœŸæœ›åŒ…å«: ${mockServers[1]}`)\n      console.error(`   å®é™…URL: ${imageUrl}`)\n    }\n\n    // æ¸…ç†\n    windowTasks.delete(promptId)\n\n  } catch (error) {\n    console.error('âŒ æµ‹è¯•2å¼‚å¸¸:', error)\n  }\n}\n\n// æµ‹è¯•3: éªŒè¯å¤šçª—å£éš”ç¦»\nasync function testMultiWindowIsolation() {\n  console.log('\\nğŸ§ª æµ‹è¯•3: å¤šçª—å£éš”ç¦»éªŒè¯')\n\n  try {\n    const promptId1 = 'test-prompt-003'\n    const promptId2 = 'test-prompt-004'\n\n    // æ¨¡æ‹Ÿä¸¤ä¸ªä¸åŒçš„ä»»åŠ¡ç»‘å®šä¸åŒæœåŠ¡å™¨\n    const task1 = {\n      workflowType: 'undress',\n      executionServer: mockServers[0],\n      windowId: WINDOW_ID,\n      createdAt: new Date().toISOString()\n    }\n\n    const task2 = {\n      workflowType: 'faceswap',\n      executionServer: mockServers[1],\n      windowId: 'other-window-id',\n      createdAt: new Date().toISOString()\n    }\n\n    // æ³¨å†Œä»»åŠ¡\n    windowTasks.set(promptId1, task1)\n    windowTasks.set(promptId2, task2)\n\n    // éªŒè¯åªèƒ½è·å–å½“å‰çª—å£çš„ä»»åŠ¡\n    const retrievedTask1 = getWindowTask(promptId1)\n    const retrievedTask2 = getWindowTask(promptId2)\n\n    if (retrievedTask1 && !retrievedTask2) {\n      console.log('âœ… æµ‹è¯•3é€šè¿‡: å¤šçª—å£ä»»åŠ¡æ­£ç¡®éš”ç¦»')\n      console.log(`   å½“å‰çª—å£ä»»åŠ¡: ${promptId1} -> ${retrievedTask1.executionServer}`)\n      console.log(`   å…¶ä»–çª—å£ä»»åŠ¡: ${promptId2} -> å·²éš”ç¦»`)\n    } else {\n      console.error('âŒ æµ‹è¯•3å¤±è´¥: å¤šçª—å£éš”ç¦»ä¸æ­£ç¡®')\n    }\n\n    // æ¸…ç†\n    windowTasks.delete(promptId1)\n    windowTasks.delete(promptId2)\n\n  } catch (error) {\n    console.error('âŒ æµ‹è¯•3å¼‚å¸¸:', error)\n  }\n}\n\n// æµ‹è¯•4: éªŒè¯getTaskBoundImageUrlå®Œæ•´æµç¨‹\nasync function testCompleteImageUrlFlow() {\n  console.log('\\nğŸ§ª æµ‹è¯•4: å®Œæ•´å›¾ç‰‡URLè·å–æµç¨‹')\n\n  try {\n    const promptId = 'test-prompt-005'\n    const mockTask = {\n      workflowType: 'undress',\n      executionServer: mockServers[2],\n      windowId: WINDOW_ID,\n      createdAt: new Date().toISOString()\n    }\n\n    // æ³¨å†Œä»»åŠ¡\n    windowTasks.set(promptId, mockTask)\n\n    // æµ‹è¯•å®Œæ•´çš„getTaskBoundImageUrlæµç¨‹\n    const imageUrl = await getTaskBoundImageUrl(promptId, mockTaskResult, 'undress')\n\n    if (imageUrl && imageUrl.includes(mockServers[2])) {\n      console.log('âœ… æµ‹è¯•4é€šè¿‡: å®Œæ•´æµç¨‹æ­£ç¡®ä½¿ç”¨ä»»åŠ¡ç»‘å®šæœåŠ¡å™¨')\n      console.log(`   æœ€ç»ˆå›¾ç‰‡URL: ${imageUrl}`)\n    } else {\n      console.error('âŒ æµ‹è¯•4å¤±è´¥: å®Œæ•´æµç¨‹æœªä½¿ç”¨æ­£ç¡®æœåŠ¡å™¨')\n      console.error(`   æœŸæœ›åŒ…å«: ${mockServers[2]}`)\n      console.error(`   å®é™…URL: ${imageUrl}`)\n    }\n\n    // æ¸…ç†\n    windowTasks.delete(promptId)\n\n  } catch (error) {\n    console.error('âŒ æµ‹è¯•4å¼‚å¸¸:', error)\n  }\n}\n\n// æµ‹è¯•5: éªŒè¯extractTaskResultsOfficialä¿®å¤\nasync function testExtractTaskResultsOfficialFix() {\n  console.log('\\nğŸ§ª æµ‹è¯•5: extractTaskResultsOfficialæœåŠ¡å™¨ä¸€è‡´æ€§ä¿®å¤')\n\n  try {\n    const promptId = 'test-prompt-006'\n    const mockTask = {\n      workflowType: 'faceswap',\n      executionServer: mockServers[1],\n      windowId: WINDOW_ID,\n      createdAt: new Date().toISOString()\n    }\n\n    // æ³¨å†Œä»»åŠ¡\n    windowTasks.set(promptId, mockTask)\n\n    // æ¨¡æ‹Ÿå†å²è®°å½•æ•°æ®\n    const mockHistory = {\n      outputs: mockTaskResult.outputs\n    }\n\n    // æµ‹è¯•extractTaskResultsOfficialæ˜¯å¦ä½¿ç”¨ä»»åŠ¡ç»‘å®šçš„æœåŠ¡å™¨\n    const results = await extractTaskResultsOfficial(mockHistory, promptId)\n\n    // æ£€æŸ¥è¾“å‡ºå›¾ç‰‡çš„URLæ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„æœåŠ¡å™¨\n    let allUrlsCorrect = true\n    for (const nodeId in results.outputImages) {\n      const images = results.outputImages[nodeId]\n      for (const image of images) {\n        if (image.url && !image.url.includes(mockServers[1])) {\n          allUrlsCorrect = false\n          console.error(`âŒ èŠ‚ç‚¹${nodeId}å›¾ç‰‡URLæœªä½¿ç”¨ç»‘å®šæœåŠ¡å™¨: ${image.url}`)\n        }\n      }\n    }\n\n    if (allUrlsCorrect) {\n      console.log('âœ… æµ‹è¯•5é€šè¿‡: extractTaskResultsOfficialæ­£ç¡®ä½¿ç”¨ä»»åŠ¡ç»‘å®šæœåŠ¡å™¨')\n      console.log(`   ç»‘å®šæœåŠ¡å™¨: ${mockServers[1]}`)\n    } else {\n      console.error('âŒ æµ‹è¯•5å¤±è´¥: extractTaskResultsOfficialæœªä½¿ç”¨æ­£ç¡®æœåŠ¡å™¨')\n    }\n\n    // æ¸…ç†\n    windowTasks.delete(promptId)\n\n  } catch (error) {\n    console.error('âŒ æµ‹è¯•5å¼‚å¸¸:', error)\n  }\n}\n\n// è¿è¡Œæ‰€æœ‰æµ‹è¯•\nexport async function runServerConsistencyTests() {\n  console.log('ğŸš€ å¼€å§‹å¤šçª—å£æœåŠ¡å™¨ä¸€è‡´æ€§ä¿®å¤æµ‹è¯•...')\n\n  await testTaskServerBinding()\n  await testImageUrlWithBoundServer()\n  await testMultiWindowIsolation()\n  await testCompleteImageUrlFlow()\n\n  console.log('\\nğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼')\n}\n\n// å¦‚æœç›´æ¥è¿è¡Œæ­¤æ–‡ä»¶ï¼Œæ‰§è¡Œæµ‹è¯•\nif (import.meta.url === `file://${process.argv[1]}`) {\n  runServerConsistencyTests()\n}\n\nexport {\n  testTaskServerBinding,\n  testImageUrlWithBoundServer,\n  testMultiWindowIsolation,\n  testCompleteImageUrlFlow\n}\n"
        }
    ]
}