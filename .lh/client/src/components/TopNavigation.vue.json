{
    "sourceFile": "client/src/components/TopNavigation.vue",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 3,
            "patches": [
                {
                    "date": 1752290874113,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752290897253,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -84,10 +84,13 @@\n let statusUpdateTimer = null\n \n // Êõ¥Êñ∞ÁßØÂàÜÁä∂ÊÄÅ\n const updatePointsStatus = async () => {\n+  console.log('üîÑ Êõ¥Êñ∞ÁßØÂàÜÁä∂ÊÄÅÔºåÂΩìÂâçÁôªÂΩïÁä∂ÊÄÅ:', levelCardPointsManager.isLoggedIn(), isLoggedIn.value)\n+\n   // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÔºåÂ¶ÇÊûúÊú™ÁôªÂΩïÂàô‰∏çÂèëÈÄÅAPIËØ∑Ê±Ç\n-  if (!levelCardPointsManager.isLoggedIn()) {\n+  if (!levelCardPointsManager.isLoggedIn() || !isLoggedIn.value) {\n+    console.log('‚ùå Êú™ÁôªÂΩïÔºåËÆæÁΩÆÈªòËÆ§ÁßØÂàÜÁä∂ÊÄÅ')\n     Object.assign(pointsStatus, {\n       current: 0,\n       total_points: 0,\n       cards_count: 0,\n@@ -98,14 +101,17 @@\n     return\n   }\n \n   try {\n+    console.log('üöÄ ÂèëÈÄÅÁßØÂàÜAPIËØ∑Ê±Ç...')\n     const newStatus = await levelCardPointsManager.getPointsStatus()\n+    console.log('‚úÖ ÁßØÂàÜÁä∂ÊÄÅÊõ¥Êñ∞ÊàêÂäü:', newStatus)\n     Object.assign(pointsStatus, newStatus)\n   } catch (error) {\n-    console.error('Êõ¥Êñ∞ÁßØÂàÜÁä∂ÊÄÅÂ§±Ë¥•:', error)\n+    console.error('‚ùå Êõ¥Êñ∞ÁßØÂàÜÁä∂ÊÄÅÂ§±Ë¥•:', error)\n     // ËÆ§ËØÅÈîôËØØÂ§ÑÁêÜ\n     if (error.message && (error.message.includes('‰ª§Áâå') || error.message.includes('401'))) {\n+      console.log('üîí ËÆ§ËØÅÈîôËØØÔºåÈáçÁΩÆÁßØÂàÜÁä∂ÊÄÅ')\n       Object.assign(pointsStatus, {\n         current: 0,\n         total_points: 0,\n         cards_count: 0,\n"
                },
                {
                    "date": 1752290912678,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -167,21 +167,24 @@\n }\n \n // ÂàùÂßãÂåñÁî®Êà∑‰ø°ÊÅØ\n const initUserInfo = () => {\n-  console.log('ÂàùÂßãÂåñÁî®Êà∑‰ø°ÊÅØ...')\n+  console.log('üîÑ ÂàùÂßãÂåñÁî®Êà∑‰ø°ÊÅØ...')\n   const token = authApi.getToken()\n   const localUserInfo = authApi.getLocalUserInfo()\n \n   console.log('TokenÂ≠òÂú®:', !!token)\n   console.log('Êú¨Âú∞Áî®Êà∑‰ø°ÊÅØ:', localUserInfo)\n \n   if (token && localUserInfo) {\n     userInfo.value = localUserInfo\n-    console.log('ËÆæÁΩÆÁî®Êà∑‰ø°ÊÅØ:', userInfo.value)\n+    pointsStatus.isLoggedIn = true\n+    console.log('‚úÖ ËÆæÁΩÆÁî®Êà∑‰ø°ÊÅØ:', userInfo.value)\n+    console.log('‚úÖ ËÆæÁΩÆÁôªÂΩïÁä∂ÊÄÅ‰∏∫true')\n   } else {\n-    console.log('Êú™ÊâæÂà∞ÊúâÊïàÁöÑÁôªÂΩï‰ø°ÊÅØ')\n+    console.log('‚ùå Êú™ÊâæÂà∞ÊúâÊïàÁöÑÁôªÂΩï‰ø°ÊÅØ')\n     userInfo.value = null\n+    pointsStatus.isLoggedIn = false\n   }\n }\n \n // ÁõëÂê¨localStorageÂèòÂåñ\n"
                },
                {
                    "date": 1752290981271,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -220,9 +220,13 @@\n // Êö¥Èú≤ÁªôÁà∂ÁªÑ‰ª∂ÁöÑÊñπÊ≥ï\n defineExpose({\n   updatePointsStatus,\n   getCurrentPoints: () => pointsStatus.current,\n-  hasEnoughPoints: () => pointsStatus.canGenerate\n+  hasEnoughPoints: () => pointsStatus.canGenerate,\n+  showLoginModal: () => {\n+    authMode.value = 'login'\n+    showAuthModal.value = true\n+  }\n })\n </script>\n \n <style scoped>\n"
                }
            ],
            "date": 1752290874113,
            "name": "Commit-0",
            "content": "<template>\n  <div class=\"top-navigation\">\n    <!-- ÁßØÂàÜÊòæÁ§∫ÔºàÂ∑¶ËæπÔºâ -->\n    <div class=\"nav-item nav-points\" @click=\"showPointsModal = true\" title=\"ÁÇπÂáªÊü•ÁúãÁßØÂàÜËØ¶ÊÉÖ\">\n      <div class=\"nav-icon\">\n        <van-icon name=\"diamond-o\" size=\"18\" />\n      </div>\n      <span class=\"nav-text\">{{ pointsStatus.current }}</span>\n    </div>\n\n    <!-- Áî®Êà∑‰ø°ÊÅØÔºàÂè≥ËæπÔºâ -->\n    <div class=\"nav-item nav-user\">\n      <!-- Êú™ÁôªÂΩïÁä∂ÊÄÅ -->\n      <div v-if=\"!isLoggedIn\" class=\"nav-login\" @click=\"showLoginModal\" title=\"ÁÇπÂáªÁôªÂΩï\">\n        <div class=\"nav-icon\">\n          <van-icon name=\"user-o\" size=\"18\" />\n        </div>\n        <span class=\"nav-text\">ÁôªÂΩï</span>\n      </div>\n\n      <!-- Â∑≤ÁôªÂΩïÁä∂ÊÄÅ -->\n      <div v-else class=\"nav-avatar\" @click=\"goToProfile\" title=\"ÁÇπÂáªËøõÂÖ•‰∏™‰∫∫‰∏≠ÂøÉ\">\n        <div class=\"nav-icon\">\n          <van-icon name=\"user-o\" size=\"18\" />\n        </div>\n      </div>\n    </div>\n\n    <!-- ÁßØÂàÜÂºπÁ™ó -->\n    <PointsModal\n      v-model:show=\"showPointsModal\"\n      @points-updated=\"handlePointsUpdated\"\n    />\n\n    <!-- ÁôªÂΩïÊ≥®ÂÜåÂºπÁ™ó -->\n    <AuthModal\n      v-model:show=\"showAuthModal\"\n      :default-mode=\"authMode\"\n      @success=\"handleAuthSuccess\"\n    />\n  </div>\n</template>\n\n<script setup>\nimport { ref, reactive, computed, onMounted, onUnmounted } from 'vue'\nimport { useRouter } from 'vue-router'\nimport { Toast } from 'vant'\nimport { authApi } from '../services/api.js'\nimport levelCardPointsManager from '../utils/levelCardPointsManager.js'\nimport PointsModal from './PointsModal.vue'\nimport AuthModal from './AuthModal.vue'\n\n// ÂÆö‰πâ‰∫ã‰ª∂\nconst emit = defineEmits(['login', 'logout'])\n\n// Ë∑ØÁî±\nconst router = useRouter()\n\n// ÂìçÂ∫îÂºèÊï∞ÊçÆ\nconst showPointsModal = ref(false)\nconst showAuthModal = ref(false)\nconst authMode = ref('login')\nconst loading = ref(false)\n\n// Áî®Êà∑‰ø°ÊÅØ\nconst userInfo = ref(null)\nconst isLoggedIn = computed(() => {\n  const hasToken = authApi.isLoggedIn()\n  const hasUserInfo = !!userInfo.value\n  return hasToken && hasUserInfo\n})\n\n// ÁßØÂàÜÁä∂ÊÄÅ\nconst pointsStatus = reactive({\n  current: 0,\n  total_points: 0,\n  cards_count: 0,\n  canGenerate: false,\n  generationCost: 20,\n  isLoggedIn: false\n})\n\n// ÂÆöÊó∂Âô®\nlet statusUpdateTimer = null\n\n// Êõ¥Êñ∞ÁßØÂàÜÁä∂ÊÄÅ\nconst updatePointsStatus = async () => {\n  // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÔºåÂ¶ÇÊûúÊú™ÁôªÂΩïÂàô‰∏çÂèëÈÄÅAPIËØ∑Ê±Ç\n  if (!levelCardPointsManager.isLoggedIn()) {\n    Object.assign(pointsStatus, {\n      current: 0,\n      total_points: 0,\n      cards_count: 0,\n      canGenerate: false,\n      generationCost: 20,\n      isLoggedIn: false\n    })\n    return\n  }\n\n  try {\n    const newStatus = await levelCardPointsManager.getPointsStatus()\n    Object.assign(pointsStatus, newStatus)\n  } catch (error) {\n    console.error('Êõ¥Êñ∞ÁßØÂàÜÁä∂ÊÄÅÂ§±Ë¥•:', error)\n    // ËÆ§ËØÅÈîôËØØÂ§ÑÁêÜ\n    if (error.message && (error.message.includes('‰ª§Áâå') || error.message.includes('401'))) {\n      Object.assign(pointsStatus, {\n        current: 0,\n        total_points: 0,\n        cards_count: 0,\n        canGenerate: false,\n        generationCost: 20,\n        isLoggedIn: false\n      })\n    }\n  }\n}\n\n// ÊòæÁ§∫ÁôªÂΩïÂºπÁ™ó\nconst showLoginModal = () => {\n  authMode.value = 'login'\n  showAuthModal.value = true\n}\n\n// Â§ÑÁêÜËÆ§ËØÅÊàêÂäü\nconst handleAuthSuccess = (data) => {\n  console.log('ËÆ§ËØÅÊàêÂäüÔºåÊõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØ:', data)\n\n  // Á´ãÂç≥Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØ\n  userInfo.value = data.user\n\n  // Á°Æ‰øùlocalStorage‰∏≠ÁöÑÊï∞ÊçÆÊòØÊúÄÊñ∞ÁöÑ\n  if (data.user) {\n    localStorage.setItem('user_info', JSON.stringify(data.user))\n  }\n\n  // Á´ãÂç≥Êõ¥Êñ∞ÁßØÂàÜÁä∂ÊÄÅ‰∏≠ÁöÑÁôªÂΩïÁä∂ÊÄÅ\n  pointsStatus.isLoggedIn = true\n\n  // Ëß¶ÂèëÁà∂ÁªÑ‰ª∂ÁöÑÁôªÂΩï‰∫ã‰ª∂\n  emit('login', data)\n\n  // Âª∂ËøüÊõ¥Êñ∞ÁßØÂàÜÁä∂ÊÄÅÔºåÁ°Æ‰øùÁôªÂΩïÁä∂ÊÄÅÂ∑≤ÂêåÊ≠•\n  setTimeout(() => {\n    updatePointsStatus()\n  }, 100)\n\n  // ÂÖ≥Èó≠ÂºπÁ™ó\n  showAuthModal.value = false\n}\n\n// Ë∑≥ËΩ¨Âà∞‰∏™‰∫∫‰∏≠ÂøÉ\nconst goToProfile = () => {\n  router.push('/profile')\n}\n\n// Â§ÑÁêÜÁßØÂàÜÊõ¥Êñ∞\nconst handlePointsUpdated = () => {\n  updatePointsStatus()\n}\n\n// ÂàùÂßãÂåñÁî®Êà∑‰ø°ÊÅØ\nconst initUserInfo = () => {\n  console.log('ÂàùÂßãÂåñÁî®Êà∑‰ø°ÊÅØ...')\n  const token = authApi.getToken()\n  const localUserInfo = authApi.getLocalUserInfo()\n\n  console.log('TokenÂ≠òÂú®:', !!token)\n  console.log('Êú¨Âú∞Áî®Êà∑‰ø°ÊÅØ:', localUserInfo)\n\n  if (token && localUserInfo) {\n    userInfo.value = localUserInfo\n    console.log('ËÆæÁΩÆÁî®Êà∑‰ø°ÊÅØ:', userInfo.value)\n  } else {\n    console.log('Êú™ÊâæÂà∞ÊúâÊïàÁöÑÁôªÂΩï‰ø°ÊÅØ')\n    userInfo.value = null\n  }\n}\n\n// ÁõëÂê¨localStorageÂèòÂåñ\nconst handleStorageChange = (event) => {\n  console.log('localStorageÂèòÂåñ:', event)\n  if (event.key === 'auth_token' || event.key === 'user_info') {\n    console.log('ËÆ§ËØÅÁõ∏ÂÖ≥Êï∞ÊçÆÂèòÂåñÔºåÈáçÊñ∞ÂàùÂßãÂåñ')\n    initUserInfo()\n    updatePointsStatus()\n  }\n}\n\n// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂ÂàùÂßãÂåñ\nonMounted(() => {\n  initUserInfo()\n  updatePointsStatus()\n\n  // ÁõëÂê¨storage‰∫ã‰ª∂ÔºàË∑®Ê†áÁ≠æÈ°µÂêåÊ≠•Ôºâ\n  window.addEventListener('storage', handleStorageChange)\n\n  // ÊØè30ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°Áä∂ÊÄÅ\n  statusUpdateTimer = setInterval(updatePointsStatus, 30000)\n})\n\n// ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ\nonUnmounted(() => {\n  window.removeEventListener('storage', handleStorageChange)\n  if (statusUpdateTimer) {\n    clearInterval(statusUpdateTimer)\n  }\n})\n\n// Êö¥Èú≤ÁªôÁà∂ÁªÑ‰ª∂ÁöÑÊñπÊ≥ï\ndefineExpose({\n  updatePointsStatus,\n  getCurrentPoints: () => pointsStatus.current,\n  hasEnoughPoints: () => pointsStatus.canGenerate\n})\n</script>\n\n<style scoped>\n.top-navigation {\n  position: fixed;\n  top: 20px;\n  right: 20px;\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  z-index: 1000;\n}\n\n.nav-item {\n  display: flex;\n  align-items: center;\n  gap: 6px;\n  padding: 8px 12px;\n  background: rgba(255, 255, 255, 0.95);\n  backdrop-filter: blur(10px);\n  border: 1px solid rgba(255, 255, 255, 0.2);\n  border-radius: 20px;\n  cursor: pointer;\n  transition: all 0.3s ease;\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n}\n\n.nav-item:hover {\n  background: rgba(255, 255, 255, 1);\n  border-color: #1989fa;\n  box-shadow: 0 4px 12px rgba(25, 137, 250, 0.2);\n  transform: translateY(-1px);\n}\n\n.nav-icon {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  width: 24px;\n  height: 24px;\n  color: #1989fa;\n}\n\n.nav-text {\n  font-size: 14px;\n  font-weight: 500;\n  color: #323233;\n  white-space: nowrap;\n}\n\n.nav-points {\n  order: 1; /* ÁßØÂàÜÂú®Â∑¶Ëæπ */\n}\n\n.nav-user {\n  order: 2; /* Áî®Êà∑Âú®Âè≥Ëæπ */\n}\n\n.nav-login {\n  display: flex;\n  align-items: center;\n  gap: 6px;\n}\n\n.nav-avatar {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  width: 32px;\n  height: 32px;\n  background: linear-gradient(135deg, #1989fa, #1976d2);\n  border-radius: 50%;\n  color: white;\n  margin: -4px;\n}\n\n.nav-avatar:hover {\n  background: linear-gradient(135deg, #1976d2, #1565c0);\n  transform: scale(1.05);\n}\n\n/* Ê∑±Ëâ≤‰∏ªÈ¢òÈÄÇÈÖç */\n@media (prefers-color-scheme: dark) {\n  .nav-item {\n    background: rgba(30, 30, 30, 0.95);\n    border-color: rgba(255, 255, 255, 0.1);\n  }\n\n  .nav-item:hover {\n    background: rgba(40, 40, 40, 1);\n    border-color: #1989fa;\n  }\n\n  .nav-text {\n    color: #ffffff;\n  }\n}\n\n/* ÂìçÂ∫îÂºèËÆæËÆ° */\n@media (max-width: 768px) {\n  .top-navigation {\n    top: 15px;\n    right: 15px;\n    gap: 8px;\n  }\n\n  .nav-item {\n    padding: 6px 10px;\n  }\n\n  .nav-text {\n    font-size: 13px;\n  }\n\n  .nav-icon {\n    width: 20px;\n    height: 20px;\n  }\n}\n</style>\n"
        }
    ]
}