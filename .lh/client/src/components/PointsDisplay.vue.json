{
    "sourceFile": "client/src/components/PointsDisplay.vue",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 13,
            "patches": [
                {
                    "date": 1752286351267,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752286385556,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -282,8 +282,14 @@\n           </div>\r\n         </div>\r\n       </div>\r\n     </van-popup>\r\n+\r\n+    <!-- ç§¯åˆ†å¼¹çª— -->\r\n+    <PointsModal\r\n+      v-model:show=\"showPointsModal\"\r\n+      @points-updated=\"handlePointsUpdated\"\r\n+    />\r\n   </div>\r\n </template>\r\n \r\n <script setup>\r\n"
                },
                {
                    "date": 1752286398454,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -295,8 +295,9 @@\n <script setup>\r\n import { ref, reactive, onMounted, onUnmounted } from 'vue'\r\n import { Toast } from 'vant'\r\n import pointsManager from '../utils/pointsManager.js'\r\n+import PointsModal from './PointsModal.vue'\r\n \r\n // Props\r\n const props = defineProps({\r\n   compact: {\r\n"
                },
                {
                    "date": 1752286412508,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -313,8 +313,9 @@\n const pointsStatus = reactive(pointsManager.getPointsStatus())\r\n const showPurchaseModal = ref(false)\r\n const showPaymentModal = ref(false)\r\n const showDetailsModal = ref(false)\r\n+const showPointsModal = ref(false)\r\n const selectedPayment = ref('wechat')\r\n const generating = ref(false)\r\n const checkingPayment = ref(false)\r\n const currentOrderId = ref('')\r\n"
                },
                {
                    "date": 1752286435787,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -449,8 +449,21 @@\n   paymentStatusText.value = 'ç­‰å¾…æ”¯ä»˜...'\r\n   checkingPayment.value = false\r\n }\r\n \r\n+// å¤„ç†ç§¯åˆ†æ›´æ–°ï¼ˆç­‰çº§å¡ç»‘å®šæˆåŠŸåï¼‰\r\n+const handlePointsUpdated = (data) => {\r\n+  console.log('ç§¯åˆ†å·²æ›´æ–°:', data)\r\n+\r\n+  // æ›´æ–°æœ¬åœ°ç§¯åˆ†çŠ¶æ€\r\n+  updatePointsStatus()\r\n+\r\n+  // æ˜¾ç¤ºæˆåŠŸæç¤º\r\n+  if (data.pointsAdded) {\r\n+    Toast.success(`ç»‘å®šæˆåŠŸï¼è·å¾— ${data.pointsAdded} ç§¯åˆ†`)\r\n+  }\r\n+}\r\n+\r\n // æ ¼å¼åŒ–æ—¥æœŸ\r\n const formatDate = (timestamp) => {\r\n   const date = new Date(timestamp)\r\n   return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`\r\n"
                },
                {
                    "date": 1752286511133,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -294,9 +294,9 @@\n \r\n <script setup>\r\n import { ref, reactive, onMounted, onUnmounted } from 'vue'\r\n import { Toast } from 'vant'\r\n-import pointsManager from '../utils/pointsManager.js'\r\n+import levelCardPointsManager from '../utils/levelCardPointsManager.js'\r\n import PointsModal from './PointsModal.vue'\r\n \r\n // Props\r\n const props = defineProps({\r\n"
                },
                {
                    "date": 1752286525302,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -309,9 +309,16 @@\n // è®¡ç®—æ˜¯å¦ä¸ºç´§å‡‘æ¨¡å¼\r\n const isCompact = ref(props.compact)\r\n \r\n // å“åº”å¼æ•°æ®\r\n-const pointsStatus = reactive(pointsManager.getPointsStatus())\r\n+const pointsStatus = reactive({\r\n+  current: 0,\r\n+  total_points: 0,\r\n+  cards_count: 0,\r\n+  canGenerate: false,\r\n+  generationCost: 20,\r\n+  isLoggedIn: false\r\n+})\r\n const showPurchaseModal = ref(false)\r\n const showPaymentModal = ref(false)\r\n const showDetailsModal = ref(false)\r\n const showPointsModal = ref(false)\r\n"
                },
                {
                    "date": 1752286555236,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -349,11 +349,15 @@\n   }\r\n })\r\n \r\n // æ›´æ–°ç‚¹æ•°çŠ¶æ€\r\n-const updatePointsStatus = () => {\r\n-  const newStatus = pointsManager.getPointsStatus()\r\n-  Object.assign(pointsStatus, newStatus)\r\n+const updatePointsStatus = async () => {\r\n+  try {\r\n+    const newStatus = await levelCardPointsManager.getPointsStatus()\r\n+    Object.assign(pointsStatus, newStatus)\r\n+  } catch (error) {\r\n+    console.error('æ›´æ–°ç§¯åˆ†çŠ¶æ€å¤±è´¥:', error)\r\n+  }\r\n }\r\n \r\n // ç”Ÿæˆä»˜æ¬¾ç \r\n const generatePaymentCode = async () => {\r\n"
                },
                {
                    "date": 1752286866474,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -422,29 +422,27 @@\n   }\r\n }\r\n \r\n // å¤„ç†æ”¯ä»˜æˆåŠŸ\r\n-const handlePaymentSuccess = () => {\r\n+const handlePaymentSuccess = async () => {\r\n   try {\r\n-    const result = pointsManager.addExperienceCardPoints()\r\n-\r\n     // æ¸…ç†å®šæ—¶å™¨\r\n     if (paymentCheckTimer) {\r\n       clearInterval(paymentCheckTimer)\r\n       paymentCheckTimer = null\r\n     }\r\n \r\n     // æ›´æ–°çŠ¶æ€\r\n-    updatePointsStatus()\r\n+    await updatePointsStatus()\r\n \r\n     // å…³é—­æ¨¡æ€æ¡†\r\n     closePaymentModal()\r\n \r\n     // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯\r\n-    Toast.success(`å……å€¼æˆåŠŸï¼è·å¾— ${result.added} ä½“éªŒç‚¹`)\r\n+    Toast.success('æ”¯ä»˜æˆåŠŸï¼è¯·ä½¿ç”¨ç­‰çº§å¡ç»‘å®šåŠŸèƒ½è·å¾—ç§¯åˆ†')\r\n \r\n   } catch (error) {\r\n-    Toast.fail('å……å€¼å¤±è´¥ï¼Œè¯·è”ç³»å®¢æœ')\r\n+    Toast.fail('å¤„ç†æ”¯ä»˜å¤±è´¥ï¼Œè¯·è”ç³»å®¢æœ')\r\n   }\r\n }\r\n \r\n // å…³é—­æ”¯ä»˜æ¨¡æ€æ¡†\r\n"
                },
                {
                    "date": 1752286884477,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -459,13 +459,13 @@\n   checkingPayment.value = false\r\n }\r\n \r\n // å¤„ç†ç§¯åˆ†æ›´æ–°ï¼ˆç­‰çº§å¡ç»‘å®šæˆåŠŸåï¼‰\r\n-const handlePointsUpdated = (data) => {\r\n+const handlePointsUpdated = async (data) => {\r\n   console.log('ç§¯åˆ†å·²æ›´æ–°:', data)\r\n \r\n   // æ›´æ–°æœ¬åœ°ç§¯åˆ†çŠ¶æ€\r\n-  updatePointsStatus()\r\n+  await updatePointsStatus()\r\n \r\n   // æ˜¾ç¤ºæˆåŠŸæç¤º\r\n   if (data.pointsAdded) {\r\n     Toast.success(`ç»‘å®šæˆåŠŸï¼è·å¾— ${data.pointsAdded} ç§¯åˆ†`)\r\n"
                },
                {
                    "date": 1752286899820,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -481,9 +481,19 @@\n // æš´éœ²ç»™çˆ¶ç»„ä»¶çš„æ–¹æ³•\r\n defineExpose({\r\n   updatePointsStatus,\r\n   getCurrentPoints: () => pointsStatus.current,\r\n-  hasEnoughPoints: () => pointsStatus.canGenerate\r\n+  hasEnoughPoints: () => pointsStatus.canGenerate,\r\n+  consumePoints: async (amount, description) => {\r\n+    try {\r\n+      await levelCardPointsManager.consumePoints(amount, description)\r\n+      await updatePointsStatus()\r\n+      return true\r\n+    } catch (error) {\r\n+      console.error('æ¶ˆè€—ç§¯åˆ†å¤±è´¥:', error)\r\n+      throw error\r\n+    }\r\n+  }\r\n })\r\n </script>\r\n \r\n <style scoped>\r\n"
                },
                {
                    "date": 1752288005621,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -355,8 +355,19 @@\n     const newStatus = await levelCardPointsManager.getPointsStatus()\r\n     Object.assign(pointsStatus, newStatus)\r\n   } catch (error) {\r\n     console.error('æ›´æ–°ç§¯åˆ†çŠ¶æ€å¤±è´¥:', error)\r\n+    // å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼Œé‡ç½®ä¸ºæœªç™»å½•çŠ¶æ€\r\n+    if (error.message && (error.message.includes('ä»¤ç‰Œ') || error.message.includes('401'))) {\r\n+      Object.assign(pointsStatus, {\r\n+        current: 0,\r\n+        total_points: 0,\r\n+        cards_count: 0,\r\n+        canGenerate: false,\r\n+        generationCost: 20,\r\n+        isLoggedIn: false\r\n+      })\r\n+    }\r\n   }\r\n }\r\n \r\n // ç”Ÿæˆä»˜æ¬¾ç \r\n"
                },
                {
                    "date": 1752288488658,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -350,8 +350,21 @@\n })\r\n \r\n // æ›´æ–°ç‚¹æ•°çŠ¶æ€\r\n const updatePointsStatus = async () => {\r\n+  // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œå¦‚æœæœªç™»å½•åˆ™ä¸å‘é€APIè¯·æ±‚\r\n+  if (!levelCardPointsManager.isLoggedIn()) {\r\n+    Object.assign(pointsStatus, {\r\n+      current: 0,\r\n+      total_points: 0,\r\n+      cards_count: 0,\r\n+      canGenerate: false,\r\n+      generationCost: 20,\r\n+      isLoggedIn: false\r\n+    })\r\n+    return\r\n+  }\r\n+\r\n   try {\r\n     const newStatus = await levelCardPointsManager.getPointsStatus()\r\n     Object.assign(pointsStatus, newStatus)\r\n   } catch (error) {\r\n"
                },
                {
                    "date": 1752288804814,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,11 +5,8 @@\n       <div class=\"compact-main\">\r\n         <span class=\"points-icon\">ğŸ’</span>\r\n         <span class=\"points-value\">{{ pointsStatus.current }}</span>\r\n       </div>\r\n-      <div class=\"compact-status\" v-if=\"!pointsStatus.canGenerate\">\r\n-        <span class=\"status-text\">ç‚¹æ•°ä¸è¶³</span>\r\n-      </div>\r\n     </div>\r\n \r\n     <!-- å®Œæ•´æ¨¡å¼ï¼šåŸæœ‰æ˜¾ç¤º -->\r\n     <template v-else>\r\n"
                }
            ],
            "date": 1752286351267,
            "name": "Commit-0",
            "content": "<template>\r\n  <div class=\"points-display\" :class=\"{ 'compact': isCompact }\">\r\n    <!-- ç´§å‡‘æ¨¡å¼ï¼šå³ä¸Šè§’æ˜¾ç¤º -->\r\n    <div v-if=\"isCompact\" class=\"points-compact\" @click=\"showPointsModal = true\" title=\"ç‚¹å‡»æŸ¥çœ‹ç§¯åˆ†è¯¦æƒ…\">\r\n      <div class=\"compact-main\">\r\n        <span class=\"points-icon\">ğŸ’</span>\r\n        <span class=\"points-value\">{{ pointsStatus.current }}</span>\r\n      </div>\r\n      <div class=\"compact-status\" v-if=\"!pointsStatus.canGenerate\">\r\n        <span class=\"status-text\">ç‚¹æ•°ä¸è¶³</span>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- å®Œæ•´æ¨¡å¼ï¼šåŸæœ‰æ˜¾ç¤º -->\r\n    <template v-else>\r\n      <div class=\"points-info\">\r\n        <div class=\"points-main\">\r\n          <span class=\"points-icon\">ğŸ’</span>\r\n          <span class=\"points-value\">{{ pointsStatus.current }}</span>\r\n          <span class=\"points-label\">ä½“éªŒç‚¹</span>\r\n        </div>\r\n\r\n        <div class=\"points-details\">\r\n          <div class=\"daily-info\">\r\n            <span class=\"daily-label\">ä»Šæ—¥å…è´¹:</span>\r\n            <span class=\"daily-value\">{{ pointsStatus.dailyRemaining }}/{{ pointsStatus.dailyFreePoints }}</span>\r\n          </div>\r\n\r\n          <div class=\"cost-info\">\r\n            <span class=\"cost-label\">æ¯æ¬¡æ¶ˆè€—:</span>\r\n            <span class=\"cost-value\">{{ pointsStatus.generationCost }}ç‚¹</span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"points-actions\">\r\n        <van-button\r\n          v-if=\"!pointsStatus.canGenerate\"\r\n          @click=\"showPurchaseModal = true\"\r\n          type=\"primary\"\r\n          size=\"small\"\r\n          round\r\n          class=\"recharge-btn\"\r\n        >\r\n          <span class=\"btn-icon\">ğŸ«</span>\r\n          å……å€¼ä½“éªŒå¡\r\n        </van-button>\r\n\r\n        <van-button\r\n          v-else\r\n          @click=\"showDetailsModal = true\"\r\n          type=\"default\"\r\n          size=\"small\"\r\n          plain\r\n          round\r\n          class=\"details-btn\"\r\n        >\r\n          è¯¦æƒ…\r\n        </van-button>\r\n      </div>\r\n    </template>\r\n\r\n    <!-- è´­ä¹°ä½“éªŒå¡æ¨¡æ€æ¡† -->\r\n    <van-popup\r\n      v-model:show=\"showPurchaseModal\"\r\n      position=\"center\"\r\n      :style=\"{ width: '90%', maxWidth: '400px' }\"\r\n      round\r\n    >\r\n      <div class=\"purchase-modal\">\r\n        <div class=\"modal-header\">\r\n          <h3 class=\"modal-title\">\r\n            <span class=\"title-icon\">ğŸ«</span>\r\n            è´­ä¹°ä½“éªŒå¡\r\n          </h3>\r\n          <van-icon\r\n            name=\"cross\"\r\n            @click=\"showPurchaseModal = false\"\r\n            class=\"close-btn\"\r\n          />\r\n        </div>\r\n\r\n        <div class=\"modal-content\">\r\n          <div class=\"card-info\">\r\n            <div class=\"card-item\">\r\n              <span class=\"card-icon\">ğŸ’</span>\r\n              <div class=\"card-details\">\r\n                <div class=\"card-title\">ä½“éªŒå¡</div>\r\n                <div class=\"card-desc\">è·å¾— {{ pointsStatus.experienceCardPoints }} ä½“éªŒç‚¹</div>\r\n              </div>\r\n              <div class=\"card-price\">Â¥{{ pointsStatus.experienceCardPrice }}</div>\r\n            </div>\r\n          </div>\r\n\r\n          <div class=\"payment-section\">\r\n            <h4 class=\"payment-title\">æ”¯ä»˜æ–¹å¼</h4>\r\n            <div class=\"payment-methods\">\r\n              <div\r\n                class=\"payment-method\"\r\n                :class=\"{ active: selectedPayment === 'wechat' }\"\r\n                @click=\"selectedPayment = 'wechat'\"\r\n              >\r\n                <span class=\"payment-icon\">ğŸ’š</span>\r\n                <span class=\"payment-name\">å¾®ä¿¡æ”¯ä»˜</span>\r\n              </div>\r\n              <div\r\n                class=\"payment-method\"\r\n                :class=\"{ active: selectedPayment === 'alipay' }\"\r\n                @click=\"selectedPayment = 'alipay'\"\r\n              >\r\n                <span class=\"payment-icon\">ğŸ’™</span>\r\n                <span class=\"payment-name\">æ”¯ä»˜å®</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div class=\"modal-actions\">\r\n            <van-button\r\n              @click=\"generatePaymentCode\"\r\n              type=\"primary\"\r\n              size=\"large\"\r\n              round\r\n              block\r\n              :loading=\"generating\"\r\n            >\r\n              {{ generating ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆä»˜æ¬¾ç ' }}\r\n            </van-button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </van-popup>\r\n\r\n    <!-- ä»˜æ¬¾ç æ¨¡æ€æ¡† -->\r\n    <van-popup\r\n      v-model:show=\"showPaymentModal\"\r\n      position=\"center\"\r\n      :style=\"{ width: '90%', maxWidth: '350px' }\"\r\n      round\r\n    >\r\n      <div class=\"payment-modal\">\r\n        <div class=\"modal-header\">\r\n          <h3 class=\"modal-title\">\r\n            <span class=\"title-icon\">{{ selectedPayment === 'wechat' ? 'ğŸ’š' : 'ğŸ’™' }}</span>\r\n            {{ selectedPayment === 'wechat' ? 'å¾®ä¿¡æ”¯ä»˜' : 'æ”¯ä»˜å®' }}\r\n          </h3>\r\n          <van-icon\r\n            name=\"cross\"\r\n            @click=\"closePaymentModal\"\r\n            class=\"close-btn\"\r\n          />\r\n        </div>\r\n\r\n        <div class=\"modal-content\">\r\n          <div class=\"qr-section\">\r\n            <div class=\"qr-code\">\r\n              <div class=\"qr-placeholder\">\r\n                <span class=\"qr-icon\">ğŸ“±</span>\r\n                <div class=\"qr-text\">\r\n                  <div>è¯·ä½¿ç”¨{{ selectedPayment === 'wechat' ? 'å¾®ä¿¡' : 'æ”¯ä»˜å®' }}æ‰«ç æ”¯ä»˜</div>\r\n                  <div class=\"qr-amount\">Â¥{{ pointsStatus.experienceCardPrice }}</div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div class=\"payment-info\">\r\n            <div class=\"info-item\">\r\n              <span class=\"info-label\">å•†å“:</span>\r\n              <span class=\"info-value\">ä½“éªŒå¡ ({{ pointsStatus.experienceCardPoints }}ç‚¹)</span>\r\n            </div>\r\n            <div class=\"info-item\">\r\n              <span class=\"info-label\">é‡‘é¢:</span>\r\n              <span class=\"info-value\">Â¥{{ pointsStatus.experienceCardPrice }}</span>\r\n            </div>\r\n            <div class=\"info-item\">\r\n              <span class=\"info-label\">è®¢å•å·:</span>\r\n              <span class=\"info-value\">{{ currentOrderId }}</span>\r\n            </div>\r\n          </div>\r\n\r\n          <div class=\"payment-status\">\r\n            <van-loading v-if=\"checkingPayment\" size=\"20px\" />\r\n            <span class=\"status-text\">{{ paymentStatusText }}</span>\r\n          </div>\r\n\r\n          <div class=\"modal-actions\">\r\n            <van-button\r\n              @click=\"checkPaymentStatus\"\r\n              type=\"primary\"\r\n              size=\"normal\"\r\n              round\r\n              :loading=\"checkingPayment\"\r\n            >\r\n              {{ checkingPayment ? 'æ£€æŸ¥ä¸­...' : 'æˆ‘å·²æ”¯ä»˜' }}\r\n            </van-button>\r\n            <van-button\r\n              @click=\"closePaymentModal\"\r\n              type=\"default\"\r\n              size=\"normal\"\r\n              round\r\n            >\r\n              å–æ¶ˆæ”¯ä»˜\r\n            </van-button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </van-popup>\r\n\r\n    <!-- ç‚¹æ•°è¯¦æƒ…æ¨¡æ€æ¡† -->\r\n    <van-popup\r\n      v-model:show=\"showDetailsModal\"\r\n      position=\"center\"\r\n      :style=\"{ width: '90%', maxWidth: '400px' }\"\r\n      round\r\n    >\r\n      <div class=\"details-modal\">\r\n        <div class=\"modal-header\">\r\n          <h3 class=\"modal-title\">\r\n            <span class=\"title-icon\">ğŸ’</span>\r\n            ä½“éªŒç‚¹è¯¦æƒ…\r\n          </h3>\r\n          <van-icon\r\n            name=\"cross\"\r\n            @click=\"showDetailsModal = false\"\r\n            class=\"close-btn\"\r\n          />\r\n        </div>\r\n\r\n        <div class=\"modal-content\">\r\n          <div class=\"status-overview\">\r\n            <div class=\"status-item\">\r\n              <div class=\"status-value\">{{ pointsStatus.current }}</div>\r\n              <div class=\"status-label\">å½“å‰ç‚¹æ•°</div>\r\n            </div>\r\n            <div class=\"status-item\">\r\n              <div class=\"status-value\">{{ pointsStatus.dailyRemaining }}</div>\r\n              <div class=\"status-label\">ä»Šæ—¥å…è´¹å‰©ä½™</div>\r\n            </div>\r\n            <div class=\"status-item\">\r\n              <div class=\"status-value\">{{ pointsStatus.totalUsedToday }}</div>\r\n              <div class=\"status-label\">ä»Šæ—¥å·²ç”¨</div>\r\n            </div>\r\n          </div>\r\n\r\n          <div class=\"rules-section\">\r\n            <h4 class=\"rules-title\">ä½¿ç”¨è§„åˆ™</h4>\r\n            <ul class=\"rules-list\">\r\n              <li>æ¯æ—¥å…è´¹è·å¾— {{ pointsStatus.dailyFreePoints }} ä½“éªŒç‚¹</li>\r\n              <li>æ¯æ¬¡ç”Ÿæˆå›¾ç‰‡æ¶ˆè€— {{ pointsStatus.generationCost }} ä½“éªŒç‚¹</li>\r\n              <li>ä½“éªŒå¡å¯è·å¾— {{ pointsStatus.experienceCardPoints }} ä½“éªŒç‚¹</li>\r\n              <li>å…è´¹ç‚¹æ•°æ¯æ—¥0ç‚¹é‡ç½®ï¼Œè´­ä¹°ç‚¹æ•°æ°¸ä¹…æœ‰æ•ˆ</li>\r\n            </ul>\r\n          </div>\r\n\r\n          <div class=\"purchase-history\" v-if=\"pointsStatus.purchaseHistory.length > 0\">\r\n            <h4 class=\"history-title\">è´­ä¹°è®°å½•</h4>\r\n            <div class=\"history-list\">\r\n              <div\r\n                v-for=\"item in pointsStatus.purchaseHistory.slice(-3)\"\r\n                :key=\"item.id\"\r\n                class=\"history-item\"\r\n              >\r\n                <div class=\"history-info\">\r\n                  <div class=\"history-type\">ä½“éªŒå¡</div>\r\n                  <div class=\"history-date\">{{ formatDate(item.timestamp) }}</div>\r\n                </div>\r\n                <div class=\"history-points\">+{{ item.points }}ç‚¹</div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div class=\"modal-actions\">\r\n            <van-button\r\n              @click=\"showPurchaseModal = true; showDetailsModal = false\"\r\n              type=\"primary\"\r\n              size=\"normal\"\r\n              round\r\n              block\r\n            >\r\n              è´­ä¹°ä½“éªŒå¡\r\n            </van-button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </van-popup>\r\n  </div>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref, reactive, onMounted, onUnmounted } from 'vue'\r\nimport { Toast } from 'vant'\r\nimport pointsManager from '../utils/pointsManager.js'\r\n\r\n// Props\r\nconst props = defineProps({\r\n  compact: {\r\n    type: Boolean,\r\n    default: false\r\n  }\r\n})\r\n\r\n// è®¡ç®—æ˜¯å¦ä¸ºç´§å‡‘æ¨¡å¼\r\nconst isCompact = ref(props.compact)\r\n\r\n// å“åº”å¼æ•°æ®\r\nconst pointsStatus = reactive(pointsManager.getPointsStatus())\r\nconst showPurchaseModal = ref(false)\r\nconst showPaymentModal = ref(false)\r\nconst showDetailsModal = ref(false)\r\nconst selectedPayment = ref('wechat')\r\nconst generating = ref(false)\r\nconst checkingPayment = ref(false)\r\nconst currentOrderId = ref('')\r\nconst paymentStatusText = ref('ç­‰å¾…æ”¯ä»˜...')\r\n\r\n// å®šæ—¶å™¨\r\nlet statusUpdateTimer = null\r\nlet paymentCheckTimer = null\r\n\r\n// ç»„ä»¶æŒ‚è½½æ—¶å¯åŠ¨å®šæ—¶å™¨\r\nonMounted(() => {\r\n  updatePointsStatus()\r\n  // æ¯30ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€\r\n  statusUpdateTimer = setInterval(updatePointsStatus, 30000)\r\n})\r\n\r\n// ç»„ä»¶å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨\r\nonUnmounted(() => {\r\n  if (statusUpdateTimer) {\r\n    clearInterval(statusUpdateTimer)\r\n  }\r\n  if (paymentCheckTimer) {\r\n    clearInterval(paymentCheckTimer)\r\n  }\r\n})\r\n\r\n// æ›´æ–°ç‚¹æ•°çŠ¶æ€\r\nconst updatePointsStatus = () => {\r\n  const newStatus = pointsManager.getPointsStatus()\r\n  Object.assign(pointsStatus, newStatus)\r\n}\r\n\r\n// ç”Ÿæˆä»˜æ¬¾ç \r\nconst generatePaymentCode = async () => {\r\n  generating.value = true\r\n\r\n  try {\r\n    // æ¨¡æ‹Ÿç”Ÿæˆè®¢å•\r\n    await new Promise(resolve => setTimeout(resolve, 1000))\r\n\r\n    currentOrderId.value = `EXP${Date.now()}`\r\n    paymentStatusText.value = 'ç­‰å¾…æ”¯ä»˜...'\r\n\r\n    showPurchaseModal.value = false\r\n    showPaymentModal.value = true\r\n\r\n    // å¼€å§‹æ£€æŸ¥æ”¯ä»˜çŠ¶æ€\r\n    startPaymentCheck()\r\n\r\n  } catch (error) {\r\n    Toast.fail('ç”Ÿæˆä»˜æ¬¾ç å¤±è´¥ï¼Œè¯·é‡è¯•')\r\n  } finally {\r\n    generating.value = false\r\n  }\r\n}\r\n\r\n// å¼€å§‹æ”¯ä»˜çŠ¶æ€æ£€æŸ¥\r\nconst startPaymentCheck = () => {\r\n  // æ¨¡æ‹Ÿæ”¯ä»˜æ£€æŸ¥ï¼Œå®é™…åº”è¯¥è°ƒç”¨åç«¯API\r\n  paymentCheckTimer = setInterval(() => {\r\n    // è¿™é‡Œåº”è¯¥è°ƒç”¨çœŸå®çš„æ”¯ä»˜çŠ¶æ€æ£€æŸ¥API\r\n    // ç°åœ¨æ¨¡æ‹Ÿ30ç§’åæ”¯ä»˜æˆåŠŸ\r\n    if (Date.now() - parseInt(currentOrderId.value.replace('EXP', '')) > 30000) {\r\n      handlePaymentSuccess()\r\n    }\r\n  }, 3000)\r\n}\r\n\r\n// æ£€æŸ¥æ”¯ä»˜çŠ¶æ€\r\nconst checkPaymentStatus = async () => {\r\n  checkingPayment.value = true\r\n  paymentStatusText.value = 'æ£€æŸ¥æ”¯ä»˜çŠ¶æ€...'\r\n\r\n  try {\r\n    // æ¨¡æ‹Ÿæ£€æŸ¥æ”¯ä»˜çŠ¶æ€\r\n    await new Promise(resolve => setTimeout(resolve, 2000))\r\n\r\n    // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸï¼ˆå®é™…åº”è¯¥è°ƒç”¨åç«¯APIï¼‰\r\n    const isSuccess = Math.random() > 0.3 // 70%æ¦‚ç‡æˆåŠŸ\r\n\r\n    if (isSuccess) {\r\n      handlePaymentSuccess()\r\n    } else {\r\n      paymentStatusText.value = 'æœªæ£€æµ‹åˆ°æ”¯ä»˜ï¼Œè¯·ç¡®è®¤æ”¯ä»˜åé‡è¯•'\r\n      Toast.fail('æœªæ£€æµ‹åˆ°æ”¯ä»˜')\r\n    }\r\n\r\n  } catch (error) {\r\n    paymentStatusText.value = 'æ£€æŸ¥å¤±è´¥ï¼Œè¯·é‡è¯•'\r\n    Toast.fail('æ£€æŸ¥æ”¯ä»˜çŠ¶æ€å¤±è´¥')\r\n  } finally {\r\n    checkingPayment.value = false\r\n  }\r\n}\r\n\r\n// å¤„ç†æ”¯ä»˜æˆåŠŸ\r\nconst handlePaymentSuccess = () => {\r\n  try {\r\n    const result = pointsManager.addExperienceCardPoints()\r\n\r\n    // æ¸…ç†å®šæ—¶å™¨\r\n    if (paymentCheckTimer) {\r\n      clearInterval(paymentCheckTimer)\r\n      paymentCheckTimer = null\r\n    }\r\n\r\n    // æ›´æ–°çŠ¶æ€\r\n    updatePointsStatus()\r\n\r\n    // å…³é—­æ¨¡æ€æ¡†\r\n    closePaymentModal()\r\n\r\n    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯\r\n    Toast.success(`å……å€¼æˆåŠŸï¼è·å¾— ${result.added} ä½“éªŒç‚¹`)\r\n\r\n  } catch (error) {\r\n    Toast.fail('å……å€¼å¤±è´¥ï¼Œè¯·è”ç³»å®¢æœ')\r\n  }\r\n}\r\n\r\n// å…³é—­æ”¯ä»˜æ¨¡æ€æ¡†\r\nconst closePaymentModal = () => {\r\n  showPaymentModal.value = false\r\n\r\n  if (paymentCheckTimer) {\r\n    clearInterval(paymentCheckTimer)\r\n    paymentCheckTimer = null\r\n  }\r\n\r\n  currentOrderId.value = ''\r\n  paymentStatusText.value = 'ç­‰å¾…æ”¯ä»˜...'\r\n  checkingPayment.value = false\r\n}\r\n\r\n// æ ¼å¼åŒ–æ—¥æœŸ\r\nconst formatDate = (timestamp) => {\r\n  const date = new Date(timestamp)\r\n  return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`\r\n}\r\n\r\n// æš´éœ²ç»™çˆ¶ç»„ä»¶çš„æ–¹æ³•\r\ndefineExpose({\r\n  updatePointsStatus,\r\n  getCurrentPoints: () => pointsStatus.current,\r\n  hasEnoughPoints: () => pointsStatus.canGenerate\r\n})\r\n</script>\r\n\r\n<style scoped>\r\n.points-display {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: space-between;\r\n  background: var(--bg-card);\r\n  border: 1px solid var(--border-color);\r\n  border-radius: 12px;\r\n  padding: 12px 16px;\r\n  margin-bottom: 16px;\r\n}\r\n\r\n.points-info {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 16px;\r\n}\r\n\r\n.points-main {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n\r\n.points-icon {\r\n  font-size: 1.2rem;\r\n}\r\n\r\n.points-value {\r\n  font-size: 1.5rem;\r\n  font-weight: 600;\r\n  color: var(--primary-color);\r\n}\r\n\r\n.points-label {\r\n  color: var(--text-light);\r\n  font-size: 0.9rem;\r\n}\r\n\r\n.points-details {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 4px;\r\n  font-size: 0.8rem;\r\n  color: var(--text-light);\r\n}\r\n\r\n.daily-info, .cost-info {\r\n  display: flex;\r\n  gap: 4px;\r\n}\r\n\r\n.daily-value, .cost-value {\r\n  color: var(--text-color);\r\n  font-weight: 500;\r\n}\r\n\r\n.points-actions {\r\n  flex-shrink: 0;\r\n}\r\n\r\n.recharge-btn {\r\n  background: linear-gradient(135deg, var(--primary-color) 0%, var(--success-color) 100%);\r\n  border: none;\r\n}\r\n\r\n.btn-icon {\r\n  margin-right: 4px;\r\n}\r\n\r\n/* ç´§å‡‘æ¨¡å¼æ ·å¼ */\r\n.points-display.compact {\r\n  margin-bottom: 0;\r\n  padding: 0;\r\n  background: transparent;\r\n  border: none;\r\n}\r\n\r\n.points-compact {\r\n  background: var(--bg-card);\r\n  border: 1px solid var(--border-color);\r\n  border-radius: 20px;\r\n  padding: 8px 12px;\r\n  cursor: pointer;\r\n  transition: all 0.3s ease;\r\n  backdrop-filter: blur(10px);\r\n  box-shadow: var(--shadow-md);\r\n}\r\n\r\n.points-compact:hover {\r\n  background: var(--bg-secondary);\r\n  border-color: var(--primary-color);\r\n  transform: translateY(-2px);\r\n  box-shadow: var(--shadow-lg);\r\n}\r\n\r\n.compact-main {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n}\r\n\r\n.compact-main .points-icon {\r\n  font-size: 1rem;\r\n}\r\n\r\n.compact-main .points-value {\r\n  font-size: 1.2rem;\r\n  font-weight: 600;\r\n  color: var(--primary-color);\r\n}\r\n\r\n.compact-status {\r\n  margin-top: 2px;\r\n  text-align: center;\r\n}\r\n\r\n.status-text {\r\n  font-size: 0.7rem;\r\n  color: var(--error-color);\r\n  font-weight: 500;\r\n}\r\n\r\n/* æ¨¡æ€æ¡†æ ·å¼ */\r\n.purchase-modal,\r\n.payment-modal,\r\n.details-modal {\r\n  background: var(--bg-card);\r\n  border-radius: 16px;\r\n  overflow: hidden;\r\n}\r\n\r\n.modal-header {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: space-between;\r\n  padding: 20px;\r\n  border-bottom: 1px solid var(--border-color);\r\n}\r\n\r\n.modal-title {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  margin: 0;\r\n  color: var(--text-color);\r\n  font-size: 1.1rem;\r\n  font-weight: 600;\r\n}\r\n\r\n.title-icon {\r\n  font-size: 1.2rem;\r\n}\r\n\r\n.close-btn {\r\n  color: var(--text-light);\r\n  font-size: 1.2rem;\r\n  cursor: pointer;\r\n  padding: 4px;\r\n  border-radius: 4px;\r\n  transition: var(--transition);\r\n}\r\n\r\n.close-btn:hover {\r\n  background: var(--bg-hover);\r\n  color: var(--text-color);\r\n}\r\n\r\n.modal-content {\r\n  padding: 20px;\r\n}\r\n\r\n/* ä½“éªŒå¡ä¿¡æ¯ */\r\n.card-info {\r\n  margin-bottom: 24px;\r\n}\r\n\r\n.card-item {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 12px;\r\n  padding: 16px;\r\n  background: var(--bg-secondary);\r\n  border-radius: 12px;\r\n  border: 2px solid var(--primary-color);\r\n}\r\n\r\n.card-icon {\r\n  font-size: 1.5rem;\r\n}\r\n\r\n.card-details {\r\n  flex: 1;\r\n}\r\n\r\n.card-title {\r\n  color: var(--text-color);\r\n  font-weight: 600;\r\n  margin-bottom: 4px;\r\n}\r\n\r\n.card-desc {\r\n  color: var(--text-light);\r\n  font-size: 0.9rem;\r\n}\r\n\r\n.card-price {\r\n  color: var(--primary-color);\r\n  font-size: 1.2rem;\r\n  font-weight: 600;\r\n}\r\n\r\n/* æ”¯ä»˜æ–¹å¼ */\r\n.payment-section {\r\n  margin-bottom: 24px;\r\n}\r\n\r\n.payment-title {\r\n  color: var(--text-color);\r\n  margin: 0 0 12px 0;\r\n  font-size: 1rem;\r\n  font-weight: 600;\r\n}\r\n\r\n.payment-methods {\r\n  display: grid;\r\n  grid-template-columns: 1fr 1fr;\r\n  gap: 12px;\r\n}\r\n\r\n.payment-method {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  padding: 12px;\r\n  background: var(--bg-secondary);\r\n  border: 2px solid var(--border-color);\r\n  border-radius: 8px;\r\n  cursor: pointer;\r\n  transition: var(--transition);\r\n}\r\n\r\n.payment-method.active {\r\n  border-color: var(--primary-color);\r\n  background: rgba(var(--primary-color-rgb), 0.1);\r\n}\r\n\r\n.payment-icon {\r\n  font-size: 1.2rem;\r\n}\r\n\r\n.payment-name {\r\n  color: var(--text-color);\r\n  font-weight: 500;\r\n}\r\n\r\n/* äºŒç»´ç åŒºåŸŸ */\r\n.qr-section {\r\n  margin-bottom: 20px;\r\n}\r\n\r\n.qr-code {\r\n  display: flex;\r\n  justify-content: center;\r\n  margin-bottom: 16px;\r\n}\r\n\r\n.qr-placeholder {\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 200px;\r\n  height: 200px;\r\n  background: var(--bg-secondary);\r\n  border: 2px dashed var(--border-color);\r\n  border-radius: 12px;\r\n  text-align: center;\r\n}\r\n\r\n.qr-icon {\r\n  font-size: 3rem;\r\n  margin-bottom: 12px;\r\n}\r\n\r\n.qr-text {\r\n  color: var(--text-light);\r\n  font-size: 0.9rem;\r\n  line-height: 1.4;\r\n}\r\n\r\n.qr-amount {\r\n  color: var(--primary-color);\r\n  font-size: 1.2rem;\r\n  font-weight: 600;\r\n  margin-top: 8px;\r\n}\r\n\r\n/* æ”¯ä»˜ä¿¡æ¯ */\r\n.payment-info {\r\n  margin-bottom: 20px;\r\n}\r\n\r\n.info-item {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  padding: 8px 0;\r\n  border-bottom: 1px solid var(--border-color);\r\n}\r\n\r\n.info-item:last-child {\r\n  border-bottom: none;\r\n}\r\n\r\n.info-label {\r\n  color: var(--text-light);\r\n}\r\n\r\n.info-value {\r\n  color: var(--text-color);\r\n  font-weight: 500;\r\n}\r\n\r\n/* æ”¯ä»˜çŠ¶æ€ */\r\n.payment-status {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  gap: 8px;\r\n  padding: 12px;\r\n  background: var(--bg-secondary);\r\n  border-radius: 8px;\r\n  margin-bottom: 20px;\r\n}\r\n\r\n.status-text {\r\n  color: var(--text-light);\r\n  font-size: 0.9rem;\r\n}\r\n\r\n/* çŠ¶æ€æ¦‚è§ˆ */\r\n.status-overview {\r\n  display: grid;\r\n  grid-template-columns: repeat(3, 1fr);\r\n  gap: 16px;\r\n  margin-bottom: 24px;\r\n}\r\n\r\n.status-item {\r\n  text-align: center;\r\n  padding: 16px;\r\n  background: var(--bg-secondary);\r\n  border-radius: 12px;\r\n}\r\n\r\n.status-value {\r\n  color: var(--primary-color);\r\n  font-size: 1.5rem;\r\n  font-weight: 600;\r\n  margin-bottom: 4px;\r\n}\r\n\r\n.status-label {\r\n  color: var(--text-light);\r\n  font-size: 0.8rem;\r\n}\r\n\r\n/* è§„åˆ™è¯´æ˜ */\r\n.rules-section {\r\n  margin-bottom: 24px;\r\n}\r\n\r\n.rules-title {\r\n  color: var(--text-color);\r\n  margin: 0 0 12px 0;\r\n  font-size: 1rem;\r\n  font-weight: 600;\r\n}\r\n\r\n.rules-list {\r\n  margin: 0;\r\n  padding-left: 16px;\r\n  color: var(--text-light);\r\n  font-size: 0.9rem;\r\n  line-height: 1.6;\r\n}\r\n\r\n.rules-list li {\r\n  margin-bottom: 8px;\r\n}\r\n\r\n/* è´­ä¹°å†å² */\r\n.purchase-history {\r\n  margin-bottom: 24px;\r\n}\r\n\r\n.history-title {\r\n  color: var(--text-color);\r\n  margin: 0 0 12px 0;\r\n  font-size: 1rem;\r\n  font-weight: 600;\r\n}\r\n\r\n.history-list {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8px;\r\n}\r\n\r\n.history-item {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  padding: 12px;\r\n  background: var(--bg-secondary);\r\n  border-radius: 8px;\r\n}\r\n\r\n.history-info {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 2px;\r\n}\r\n\r\n.history-type {\r\n  color: var(--text-color);\r\n  font-weight: 500;\r\n  font-size: 0.9rem;\r\n}\r\n\r\n.history-date {\r\n  color: var(--text-light);\r\n  font-size: 0.8rem;\r\n}\r\n\r\n.history-points {\r\n  color: var(--success-color);\r\n  font-weight: 600;\r\n}\r\n\r\n.modal-actions {\r\n  display: flex;\r\n  gap: 12px;\r\n}\r\n\r\n.modal-actions .van-button {\r\n  flex: 1;\r\n}\r\n\r\n@media (max-width: 768px) {\r\n  .points-display {\r\n    flex-direction: column;\r\n    gap: 12px;\r\n    align-items: stretch;\r\n  }\r\n\r\n  .points-info {\r\n    justify-content: center;\r\n  }\r\n\r\n  .points-actions {\r\n    text-align: center;\r\n  }\r\n\r\n  .status-overview {\r\n    grid-template-columns: 1fr;\r\n    gap: 12px;\r\n  }\r\n\r\n  .payment-methods {\r\n    grid-template-columns: 1fr;\r\n  }\r\n\r\n  .modal-actions {\r\n    flex-direction: column;\r\n  }\r\n}\r\n</style>\r\n"
        }
    ]
}