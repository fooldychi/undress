{
    "sourceFile": "client/src/components/ConfigModal.vue",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 8,
            "patches": [
                {
                    "date": 1752326700206,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752326717694,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -113,11 +113,11 @@\n          localConfig.value.TIMEOUT > 0\r\n })\r\n \r\n // 监听visible变化，加载当前配置\r\n-watch(() => props.visible, (newVisible) => {\r\n+watch(() => props.visible, async (newVisible) => {\r\n   if (newVisible) {\r\n-    loadCurrentConfig()\r\n+    await loadCurrentConfig();\r\n   }\r\n })\r\n \r\n // 加载当前配置\r\n"
                },
                {
                    "date": 1752328379558,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,9 +7,9 @@\n       </div>\r\n \r\n       <div class=\"modal-body\">\r\n         <p style=\"margin-bottom: 20px; color: var(--text-light); font-size: 14px;\">\r\n-          配置原始ComfyUI服务器地址（如: https://hwf0p724ub-8188.cnb.run）\r\n+          配置ComfyUI服务器地址，将从数据库动态获取配置\r\n         </p>\r\n         <div class=\"config-section\">\r\n           <label for=\"comfyui-url\">ComfyUI服务器地址:</label>\r\n           <input\r\n"
                },
                {
                    "date": 1752328422881,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,9 +15,9 @@\n           <input\r\n             id=\"comfyui-url\"\r\n             v-model=\"localConfig.COMFYUI_SERVER_URL\"\r\n             type=\"url\"\r\n-            placeholder=\"https://hwf0p724ub-8188.cnb.run\"\r\n+            placeholder=\"https://your-comfyui-server.com\"\r\n             class=\"config-input\"\r\n           >\r\n           <small class=\"help-text\">原始ComfyUI服务器的完整URL地址</small>\r\n         </div>\r\n"
                },
                {
                    "date": 1752328438259,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,9 +29,9 @@\n           <input\r\n             id=\"client-id\"\r\n             v-model=\"localConfig.CLIENT_ID\"\r\n             type=\"text\"\r\n-            placeholder=\"abc1373d4ad648a3a81d0587fbe5534b\"\r\n+            placeholder=\"your-comfyui-client-id\"\r\n             class=\"config-input\"\r\n           >\r\n           <small class=\"help-text\">用于标识客户端的唯一ID</small>\r\n         </div>\r\n"
                },
                {
                    "date": 1752328465938,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -129,10 +129,10 @@\n   } catch (error) {\r\n     console.error('❌ 加载配置失败:', error);\r\n     // 使用默认配置\r\n     localConfig.value = {\r\n-      COMFYUI_SERVER_URL: 'https://hwf0p724ub-8188.cnb.run',\r\n-      CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n+      COMFYUI_SERVER_URL: 'https://your-comfyui-server.com',\r\n+      CLIENT_ID: 'your-comfyui-client-id',\r\n       TIMEOUT: 300000\r\n     };\r\n   }\r\n }\r\n"
                },
                {
                    "date": 1752328900487,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,17 +7,17 @@\n       </div>\r\n \r\n       <div class=\"modal-body\">\r\n         <p style=\"margin-bottom: 20px; color: var(--text-light); font-size: 14px;\">\r\n-          配置ComfyUI服务器地址，将从数据库动态获取配置\r\n+          配置原始ComfyUI服务器地址（如: https://hwf0p724ub-8188.cnb.run）\r\n         </p>\r\n         <div class=\"config-section\">\r\n           <label for=\"comfyui-url\">ComfyUI服务器地址:</label>\r\n           <input\r\n             id=\"comfyui-url\"\r\n             v-model=\"localConfig.COMFYUI_SERVER_URL\"\r\n             type=\"url\"\r\n-            placeholder=\"https://your-comfyui-server.com\"\r\n+            placeholder=\"https://hwf0p724ub-8188.cnb.run\"\r\n             class=\"config-input\"\r\n           >\r\n           <small class=\"help-text\">原始ComfyUI服务器的完整URL地址</small>\r\n         </div>\r\n@@ -29,9 +29,9 @@\n           <input\r\n             id=\"client-id\"\r\n             v-model=\"localConfig.CLIENT_ID\"\r\n             type=\"text\"\r\n-            placeholder=\"your-comfyui-client-id\"\r\n+            placeholder=\"abc1373d4ad648a3a81d0587fbe5534b\"\r\n             class=\"config-input\"\r\n           >\r\n           <small class=\"help-text\">用于标识客户端的唯一ID</small>\r\n         </div>\r\n@@ -113,29 +113,18 @@\n          localConfig.value.TIMEOUT > 0\r\n })\r\n \r\n // 监听visible变化，加载当前配置\r\n-watch(() => props.visible, async (newVisible) => {\r\n+watch(() => props.visible, (newVisible) => {\r\n   if (newVisible) {\r\n-    await loadCurrentConfig();\r\n+    loadCurrentConfig()\r\n   }\r\n })\r\n \r\n // 加载当前配置\r\n-const loadCurrentConfig = async () => {\r\n-  try {\r\n-    const currentConfig = await getCurrentConfig();\r\n-    localConfig.value = { ...currentConfig };\r\n-    console.log('📋 加载当前配置:', localConfig.value);\r\n-  } catch (error) {\r\n-    console.error('❌ 加载配置失败:', error);\r\n-    // 使用默认配置\r\n-    localConfig.value = {\r\n-      COMFYUI_SERVER_URL: 'https://your-comfyui-server.com',\r\n-      CLIENT_ID: 'your-comfyui-client-id',\r\n-      TIMEOUT: 300000\r\n-    };\r\n-  }\r\n+const loadCurrentConfig = () => {\r\n+  const currentConfig = getCurrentConfig()\r\n+  localConfig.value = { ...currentConfig }\r\n }\r\n \r\n // 测试连接功能已删除\r\n \r\n"
                },
                {
                    "date": 1752330103728,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -79,8 +79,9 @@\n \r\n <script setup>\r\n import { ref, computed, watch } from 'vue'\r\n import { getCurrentConfig, updateComfyUIConfig, resetToDefaultConfig } from '../services/comfyui.js'\r\n+import configService from '../services/configService.js'\r\n \r\n const props = defineProps({\r\n   visible: {\r\n     type: Boolean,\r\n"
                },
                {
                    "date": 1752330120723,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -121,11 +121,38 @@\n   }\r\n })\r\n \r\n // 加载当前配置\r\n-const loadCurrentConfig = () => {\r\n-  const currentConfig = getCurrentConfig()\r\n-  localConfig.value = { ...currentConfig }\r\n+const loadCurrentConfig = async () => {\r\n+  try {\r\n+    // 首先尝试从服务端获取最新配置\r\n+    const serverConfig = await configService.getConfig()\r\n+\r\n+    // 提取ComfyUI相关配置\r\n+    const comfyuiServerConfig = {\r\n+      COMFYUI_SERVER_URL: serverConfig['comfyui.server_url'] || '',\r\n+      CLIENT_ID: serverConfig['comfyui.client_id'] || '',\r\n+      TIMEOUT: serverConfig['comfyui.timeout'] || 300000\r\n+    }\r\n+\r\n+    // 获取本地配置\r\n+    const currentConfig = getCurrentConfig()\r\n+\r\n+    // 合并服务端配置和本地配置，优先使用服务端配置\r\n+    localConfig.value = {\r\n+      ...currentConfig,\r\n+      ...Object.fromEntries(\r\n+        Object.entries(comfyuiServerConfig).filter(([key, value]) => value != null && value !== '')\r\n+      )\r\n+    }\r\n+\r\n+    console.log('📋 配置加载完成:', localConfig.value)\r\n+  } catch (error) {\r\n+    console.warn('⚠️ 从服务端加载配置失败，使用本地配置:', error)\r\n+    // 回退到本地配置\r\n+    const currentConfig = getCurrentConfig()\r\n+    localConfig.value = { ...currentConfig }\r\n+  }\r\n }\r\n \r\n // 测试连接功能已删除\r\n \r\n"
                }
            ],
            "date": 1752326700206,
            "name": "Commit-0",
            "content": "<template>\r\n  <div v-if=\"visible\" class=\"modal-overlay\" @click=\"closeModal\">\r\n    <div class=\"modal-content\" @click.stop>\r\n      <div class=\"modal-header\">\r\n        <h2>ComfyUI 服务器配置</h2>\r\n        <button class=\"close-btn\" @click=\"closeModal\">×</button>\r\n      </div>\r\n\r\n      <div class=\"modal-body\">\r\n        <p style=\"margin-bottom: 20px; color: var(--text-light); font-size: 14px;\">\r\n          配置原始ComfyUI服务器地址（如: https://hwf0p724ub-8188.cnb.run）\r\n        </p>\r\n        <div class=\"config-section\">\r\n          <label for=\"comfyui-url\">ComfyUI服务器地址:</label>\r\n          <input\r\n            id=\"comfyui-url\"\r\n            v-model=\"localConfig.COMFYUI_SERVER_URL\"\r\n            type=\"url\"\r\n            placeholder=\"https://hwf0p724ub-8188.cnb.run\"\r\n            class=\"config-input\"\r\n          >\r\n          <small class=\"help-text\">原始ComfyUI服务器的完整URL地址</small>\r\n        </div>\r\n\r\n        <!-- CORS已在服务端配置，使用直连模式 -->\r\n\r\n        <div class=\"config-section\">\r\n          <label for=\"client-id\">客户端ID:</label>\r\n          <input\r\n            id=\"client-id\"\r\n            v-model=\"localConfig.CLIENT_ID\"\r\n            type=\"text\"\r\n            placeholder=\"abc1373d4ad648a3a81d0587fbe5534b\"\r\n            class=\"config-input\"\r\n          >\r\n          <small class=\"help-text\">用于标识客户端的唯一ID</small>\r\n        </div>\r\n\r\n        <div class=\"config-section\">\r\n          <label for=\"timeout\">请求超时 (秒):</label>\r\n          <input\r\n            id=\"timeout\"\r\n            v-model.number=\"timeoutSeconds\"\r\n            type=\"number\"\r\n            min=\"30\"\r\n            max=\"600\"\r\n            class=\"config-input\"\r\n          >\r\n          <small class=\"help-text\">API请求的超时时间，建议300秒</small>\r\n        </div>\r\n\r\n        <!-- 连接测试功能已删除 -->\r\n\r\n        <!-- 预设配置已删除 -->\r\n      </div>\r\n\r\n      <div class=\"modal-footer\">\r\n        <van-button\r\n          @click=\"resetConfig\"\r\n          type=\"default\"\r\n          size=\"normal\"\r\n          round\r\n        >\r\n          重置默认\r\n        </van-button>\r\n        <van-button\r\n          @click=\"saveConfig\"\r\n          :disabled=\"!isValidConfig\"\r\n          type=\"primary\"\r\n          size=\"normal\"\r\n          round\r\n        >\r\n          保存配置\r\n        </van-button>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref, computed, watch } from 'vue'\r\nimport { getCurrentConfig, updateComfyUIConfig, resetToDefaultConfig } from '../services/comfyui.js'\r\n\r\nconst props = defineProps({\r\n  visible: {\r\n    type: Boolean,\r\n    default: false\r\n  }\r\n})\r\n\r\nconst emit = defineEmits(['close', 'saved'])\r\n\r\nconst localConfig = ref({\r\n  COMFYUI_SERVER_URL: '',\r\n  CLIENT_ID: '',\r\n  TIMEOUT: 300000\r\n})\r\n\r\nconst timeoutSeconds = computed({\r\n  get: () => Math.floor(localConfig.value.TIMEOUT / 1000),\r\n  set: (value) => {\r\n    localConfig.value.TIMEOUT = value * 1000\r\n  }\r\n})\r\n\r\n// 测试相关变量已删除\r\n\r\n// 验证配置是否有效\r\nconst isValidConfig = computed(() => {\r\n  return localConfig.value.COMFYUI_SERVER_URL &&\r\n         localConfig.value.COMFYUI_SERVER_URL.startsWith('http') &&\r\n         localConfig.value.CLIENT_ID &&\r\n         localConfig.value.TIMEOUT > 0\r\n})\r\n\r\n// 监听visible变化，加载当前配置\r\nwatch(() => props.visible, (newVisible) => {\r\n  if (newVisible) {\r\n    loadCurrentConfig()\r\n  }\r\n})\r\n\r\n// 加载当前配置\r\nconst loadCurrentConfig = async () => {\r\n  try {\r\n    const currentConfig = await getCurrentConfig();\r\n    localConfig.value = { ...currentConfig };\r\n    console.log('📋 加载当前配置:', localConfig.value);\r\n  } catch (error) {\r\n    console.error('❌ 加载配置失败:', error);\r\n    // 使用默认配置\r\n    localConfig.value = {\r\n      COMFYUI_SERVER_URL: 'https://hwf0p724ub-8188.cnb.run',\r\n      CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n      TIMEOUT: 300000\r\n    };\r\n  }\r\n}\r\n\r\n// 测试连接功能已删除\r\n\r\n// 预设配置功能已删除\r\n\r\n// 保存配置\r\nconst saveConfig = async () => {\r\n  if (!isValidConfig.value) return\r\n\r\n  try {\r\n    console.log('💾 保存配置中...')\r\n    const result = await updateComfyUIConfig(localConfig.value)\r\n\r\n    // 显示保存结果\r\n    if (result.proxyUpdate.success) {\r\n      console.log('✅ 配置保存成功，代理服务器已同步更新')\r\n    } else {\r\n      console.warn('⚠️ 配置已保存，但代理服务器更新失败:', result.proxyUpdate.message)\r\n      // 可以选择显示警告，但不阻止保存\r\n      if (localConfig.value.USE_PROXY) {\r\n        alert(`配置已保存，但代理服务器更新失败: ${result.proxyUpdate.message}\\n\\n请确保代理服务器正在运行，或考虑重启代理服务器。`)\r\n      }\r\n    }\r\n\r\n    emit('saved', result.config)\r\n    closeModal()\r\n  } catch (error) {\r\n    console.error('保存配置失败:', error)\r\n    alert('保存配置失败: ' + error.message)\r\n  }\r\n}\r\n\r\n// 重置配置\r\nconst resetConfig = () => {\r\n  const defaultConfig = resetToDefaultConfig()\r\n  localConfig.value = { ...defaultConfig }\r\n}\r\n\r\n// 关闭模态框\r\nconst closeModal = () => {\r\n  emit('close')\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.modal-overlay {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  background: rgba(0, 0, 0, 0.7);\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  z-index: 1000;\r\n}\r\n\r\n.modal-content {\r\n  background: var(--bg-card);\r\n  border: 1px solid var(--border-color);\r\n  border-radius: 12px;\r\n  width: 90%;\r\n  max-width: 600px;\r\n  max-height: 90vh;\r\n  overflow-y: auto;\r\n  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);\r\n  color: var(--text-color);\r\n}\r\n\r\n.modal-header {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  padding: 20px 24px;\r\n  border-bottom: 1px solid var(--border-color);\r\n}\r\n\r\n.modal-header h2 {\r\n  margin: 0;\r\n  color: var(--text-color);\r\n}\r\n\r\n.close-btn {\r\n  background: none;\r\n  border: none;\r\n  font-size: 24px;\r\n  cursor: pointer;\r\n  color: var(--text-light);\r\n  padding: 0;\r\n  width: 30px;\r\n  height: 30px;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  border-radius: 50%;\r\n  transition: all 0.2s;\r\n}\r\n\r\n.close-btn:hover {\r\n  background-color: rgba(255, 255, 255, 0.1);\r\n  color: var(--text-color);\r\n}\r\n\r\n.modal-body {\r\n  padding: 24px;\r\n}\r\n\r\n.config-section {\r\n  margin-bottom: 24px;\r\n}\r\n\r\n.config-section label {\r\n  display: block;\r\n  margin-bottom: 8px;\r\n  font-weight: 600;\r\n  color: var(--text-color);\r\n}\r\n\r\n.config-input {\r\n  width: 100%;\r\n  padding: 12px;\r\n  border: 2px solid var(--border-color);\r\n  border-radius: 8px;\r\n  font-size: 14px;\r\n  background: var(--bg-dark-light);\r\n  color: var(--text-color);\r\n  transition: border-color 0.3s;\r\n}\r\n\r\n.config-input:focus {\r\n  outline: none;\r\n  border-color: var(--primary-color);\r\n}\r\n\r\n.config-input::placeholder {\r\n  color: var(--text-muted);\r\n}\r\n\r\n.help-text {\r\n  display: block;\r\n  margin-top: 4px;\r\n  color: var(--text-light);\r\n  font-size: 12px;\r\n}\r\n\r\n/* 测试相关样式已删除 */\r\n\r\n/* 预设配置样式已删除 */\r\n\r\n.modal-footer {\r\n  padding: 20px 24px;\r\n  border-top: 1px solid #eee;\r\n  display: flex;\r\n  justify-content: flex-end;\r\n  gap: 12px;\r\n}\r\n\r\n/* 按钮样式已移至AppButton组件 */\r\n</style>\r\n"
        }
    ]
}