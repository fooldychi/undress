{
    "sourceFile": "client/src/components/ConfigModal.vue",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 8,
            "patches": [
                {
                    "date": 1752326700206,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752326717694,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -113,11 +113,11 @@\n          localConfig.value.TIMEOUT > 0\r\n })\r\n \r\n // ç›‘å¬visibleå˜åŒ–ï¼ŒåŠ è½½å½“å‰é…ç½®\r\n-watch(() => props.visible, (newVisible) => {\r\n+watch(() => props.visible, async (newVisible) => {\r\n   if (newVisible) {\r\n-    loadCurrentConfig()\r\n+    await loadCurrentConfig();\r\n   }\r\n })\r\n \r\n // åŠ è½½å½“å‰é…ç½®\r\n"
                },
                {
                    "date": 1752328379558,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,9 +7,9 @@\n       </div>\r\n \r\n       <div class=\"modal-body\">\r\n         <p style=\"margin-bottom: 20px; color: var(--text-light); font-size: 14px;\">\r\n-          é…ç½®åŸå§‹ComfyUIæœåŠ¡å™¨åœ°å€ï¼ˆå¦‚: https://hwf0p724ub-8188.cnb.runï¼‰\r\n+          é…ç½®ComfyUIæœåŠ¡å™¨åœ°å€ï¼Œå°†ä»æ•°æ®åº“åŠ¨æ€è·å–é…ç½®\r\n         </p>\r\n         <div class=\"config-section\">\r\n           <label for=\"comfyui-url\">ComfyUIæœåŠ¡å™¨åœ°å€:</label>\r\n           <input\r\n"
                },
                {
                    "date": 1752328422881,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,9 +15,9 @@\n           <input\r\n             id=\"comfyui-url\"\r\n             v-model=\"localConfig.COMFYUI_SERVER_URL\"\r\n             type=\"url\"\r\n-            placeholder=\"https://hwf0p724ub-8188.cnb.run\"\r\n+            placeholder=\"https://your-comfyui-server.com\"\r\n             class=\"config-input\"\r\n           >\r\n           <small class=\"help-text\">åŸå§‹ComfyUIæœåŠ¡å™¨çš„å®Œæ•´URLåœ°å€</small>\r\n         </div>\r\n"
                },
                {
                    "date": 1752328438259,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,9 +29,9 @@\n           <input\r\n             id=\"client-id\"\r\n             v-model=\"localConfig.CLIENT_ID\"\r\n             type=\"text\"\r\n-            placeholder=\"abc1373d4ad648a3a81d0587fbe5534b\"\r\n+            placeholder=\"your-comfyui-client-id\"\r\n             class=\"config-input\"\r\n           >\r\n           <small class=\"help-text\">ç”¨äºæ ‡è¯†å®¢æˆ·ç«¯çš„å”¯ä¸€ID</small>\r\n         </div>\r\n"
                },
                {
                    "date": 1752328465938,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -129,10 +129,10 @@\n   } catch (error) {\r\n     console.error('âŒ åŠ è½½é…ç½®å¤±è´¥:', error);\r\n     // ä½¿ç”¨é»˜è®¤é…ç½®\r\n     localConfig.value = {\r\n-      COMFYUI_SERVER_URL: 'https://hwf0p724ub-8188.cnb.run',\r\n-      CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n+      COMFYUI_SERVER_URL: 'https://your-comfyui-server.com',\r\n+      CLIENT_ID: 'your-comfyui-client-id',\r\n       TIMEOUT: 300000\r\n     };\r\n   }\r\n }\r\n"
                },
                {
                    "date": 1752328900487,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,17 +7,17 @@\n       </div>\r\n \r\n       <div class=\"modal-body\">\r\n         <p style=\"margin-bottom: 20px; color: var(--text-light); font-size: 14px;\">\r\n-          é…ç½®ComfyUIæœåŠ¡å™¨åœ°å€ï¼Œå°†ä»æ•°æ®åº“åŠ¨æ€è·å–é…ç½®\r\n+          é…ç½®åŸå§‹ComfyUIæœåŠ¡å™¨åœ°å€ï¼ˆå¦‚: https://hwf0p724ub-8188.cnb.runï¼‰\r\n         </p>\r\n         <div class=\"config-section\">\r\n           <label for=\"comfyui-url\">ComfyUIæœåŠ¡å™¨åœ°å€:</label>\r\n           <input\r\n             id=\"comfyui-url\"\r\n             v-model=\"localConfig.COMFYUI_SERVER_URL\"\r\n             type=\"url\"\r\n-            placeholder=\"https://your-comfyui-server.com\"\r\n+            placeholder=\"https://hwf0p724ub-8188.cnb.run\"\r\n             class=\"config-input\"\r\n           >\r\n           <small class=\"help-text\">åŸå§‹ComfyUIæœåŠ¡å™¨çš„å®Œæ•´URLåœ°å€</small>\r\n         </div>\r\n@@ -29,9 +29,9 @@\n           <input\r\n             id=\"client-id\"\r\n             v-model=\"localConfig.CLIENT_ID\"\r\n             type=\"text\"\r\n-            placeholder=\"your-comfyui-client-id\"\r\n+            placeholder=\"abc1373d4ad648a3a81d0587fbe5534b\"\r\n             class=\"config-input\"\r\n           >\r\n           <small class=\"help-text\">ç”¨äºæ ‡è¯†å®¢æˆ·ç«¯çš„å”¯ä¸€ID</small>\r\n         </div>\r\n@@ -113,29 +113,18 @@\n          localConfig.value.TIMEOUT > 0\r\n })\r\n \r\n // ç›‘å¬visibleå˜åŒ–ï¼ŒåŠ è½½å½“å‰é…ç½®\r\n-watch(() => props.visible, async (newVisible) => {\r\n+watch(() => props.visible, (newVisible) => {\r\n   if (newVisible) {\r\n-    await loadCurrentConfig();\r\n+    loadCurrentConfig()\r\n   }\r\n })\r\n \r\n // åŠ è½½å½“å‰é…ç½®\r\n-const loadCurrentConfig = async () => {\r\n-  try {\r\n-    const currentConfig = await getCurrentConfig();\r\n-    localConfig.value = { ...currentConfig };\r\n-    console.log('ğŸ“‹ åŠ è½½å½“å‰é…ç½®:', localConfig.value);\r\n-  } catch (error) {\r\n-    console.error('âŒ åŠ è½½é…ç½®å¤±è´¥:', error);\r\n-    // ä½¿ç”¨é»˜è®¤é…ç½®\r\n-    localConfig.value = {\r\n-      COMFYUI_SERVER_URL: 'https://your-comfyui-server.com',\r\n-      CLIENT_ID: 'your-comfyui-client-id',\r\n-      TIMEOUT: 300000\r\n-    };\r\n-  }\r\n+const loadCurrentConfig = () => {\r\n+  const currentConfig = getCurrentConfig()\r\n+  localConfig.value = { ...currentConfig }\r\n }\r\n \r\n // æµ‹è¯•è¿æ¥åŠŸèƒ½å·²åˆ é™¤\r\n \r\n"
                },
                {
                    "date": 1752330103728,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -79,8 +79,9 @@\n \r\n <script setup>\r\n import { ref, computed, watch } from 'vue'\r\n import { getCurrentConfig, updateComfyUIConfig, resetToDefaultConfig } from '../services/comfyui.js'\r\n+import configService from '../services/configService.js'\r\n \r\n const props = defineProps({\r\n   visible: {\r\n     type: Boolean,\r\n"
                },
                {
                    "date": 1752330120723,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -121,11 +121,38 @@\n   }\r\n })\r\n \r\n // åŠ è½½å½“å‰é…ç½®\r\n-const loadCurrentConfig = () => {\r\n-  const currentConfig = getCurrentConfig()\r\n-  localConfig.value = { ...currentConfig }\r\n+const loadCurrentConfig = async () => {\r\n+  try {\r\n+    // é¦–å…ˆå°è¯•ä»æœåŠ¡ç«¯è·å–æœ€æ–°é…ç½®\r\n+    const serverConfig = await configService.getConfig()\r\n+\r\n+    // æå–ComfyUIç›¸å…³é…ç½®\r\n+    const comfyuiServerConfig = {\r\n+      COMFYUI_SERVER_URL: serverConfig['comfyui.server_url'] || '',\r\n+      CLIENT_ID: serverConfig['comfyui.client_id'] || '',\r\n+      TIMEOUT: serverConfig['comfyui.timeout'] || 300000\r\n+    }\r\n+\r\n+    // è·å–æœ¬åœ°é…ç½®\r\n+    const currentConfig = getCurrentConfig()\r\n+\r\n+    // åˆå¹¶æœåŠ¡ç«¯é…ç½®å’Œæœ¬åœ°é…ç½®ï¼Œä¼˜å…ˆä½¿ç”¨æœåŠ¡ç«¯é…ç½®\r\n+    localConfig.value = {\r\n+      ...currentConfig,\r\n+      ...Object.fromEntries(\r\n+        Object.entries(comfyuiServerConfig).filter(([key, value]) => value != null && value !== '')\r\n+      )\r\n+    }\r\n+\r\n+    console.log('ğŸ“‹ é…ç½®åŠ è½½å®Œæˆ:', localConfig.value)\r\n+  } catch (error) {\r\n+    console.warn('âš ï¸ ä»æœåŠ¡ç«¯åŠ è½½é…ç½®å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°é…ç½®:', error)\r\n+    // å›é€€åˆ°æœ¬åœ°é…ç½®\r\n+    const currentConfig = getCurrentConfig()\r\n+    localConfig.value = { ...currentConfig }\r\n+  }\r\n }\r\n \r\n // æµ‹è¯•è¿æ¥åŠŸèƒ½å·²åˆ é™¤\r\n \r\n"
                }
            ],
            "date": 1752326700206,
            "name": "Commit-0",
            "content": "<template>\r\n  <div v-if=\"visible\" class=\"modal-overlay\" @click=\"closeModal\">\r\n    <div class=\"modal-content\" @click.stop>\r\n      <div class=\"modal-header\">\r\n        <h2>ComfyUI æœåŠ¡å™¨é…ç½®</h2>\r\n        <button class=\"close-btn\" @click=\"closeModal\">Ã—</button>\r\n      </div>\r\n\r\n      <div class=\"modal-body\">\r\n        <p style=\"margin-bottom: 20px; color: var(--text-light); font-size: 14px;\">\r\n          é…ç½®åŸå§‹ComfyUIæœåŠ¡å™¨åœ°å€ï¼ˆå¦‚: https://hwf0p724ub-8188.cnb.runï¼‰\r\n        </p>\r\n        <div class=\"config-section\">\r\n          <label for=\"comfyui-url\">ComfyUIæœåŠ¡å™¨åœ°å€:</label>\r\n          <input\r\n            id=\"comfyui-url\"\r\n            v-model=\"localConfig.COMFYUI_SERVER_URL\"\r\n            type=\"url\"\r\n            placeholder=\"https://hwf0p724ub-8188.cnb.run\"\r\n            class=\"config-input\"\r\n          >\r\n          <small class=\"help-text\">åŸå§‹ComfyUIæœåŠ¡å™¨çš„å®Œæ•´URLåœ°å€</small>\r\n        </div>\r\n\r\n        <!-- CORSå·²åœ¨æœåŠ¡ç«¯é…ç½®ï¼Œä½¿ç”¨ç›´è¿æ¨¡å¼ -->\r\n\r\n        <div class=\"config-section\">\r\n          <label for=\"client-id\">å®¢æˆ·ç«¯ID:</label>\r\n          <input\r\n            id=\"client-id\"\r\n            v-model=\"localConfig.CLIENT_ID\"\r\n            type=\"text\"\r\n            placeholder=\"abc1373d4ad648a3a81d0587fbe5534b\"\r\n            class=\"config-input\"\r\n          >\r\n          <small class=\"help-text\">ç”¨äºæ ‡è¯†å®¢æˆ·ç«¯çš„å”¯ä¸€ID</small>\r\n        </div>\r\n\r\n        <div class=\"config-section\">\r\n          <label for=\"timeout\">è¯·æ±‚è¶…æ—¶ (ç§’):</label>\r\n          <input\r\n            id=\"timeout\"\r\n            v-model.number=\"timeoutSeconds\"\r\n            type=\"number\"\r\n            min=\"30\"\r\n            max=\"600\"\r\n            class=\"config-input\"\r\n          >\r\n          <small class=\"help-text\">APIè¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼Œå»ºè®®300ç§’</small>\r\n        </div>\r\n\r\n        <!-- è¿æ¥æµ‹è¯•åŠŸèƒ½å·²åˆ é™¤ -->\r\n\r\n        <!-- é¢„è®¾é…ç½®å·²åˆ é™¤ -->\r\n      </div>\r\n\r\n      <div class=\"modal-footer\">\r\n        <van-button\r\n          @click=\"resetConfig\"\r\n          type=\"default\"\r\n          size=\"normal\"\r\n          round\r\n        >\r\n          é‡ç½®é»˜è®¤\r\n        </van-button>\r\n        <van-button\r\n          @click=\"saveConfig\"\r\n          :disabled=\"!isValidConfig\"\r\n          type=\"primary\"\r\n          size=\"normal\"\r\n          round\r\n        >\r\n          ä¿å­˜é…ç½®\r\n        </van-button>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref, computed, watch } from 'vue'\r\nimport { getCurrentConfig, updateComfyUIConfig, resetToDefaultConfig } from '../services/comfyui.js'\r\n\r\nconst props = defineProps({\r\n  visible: {\r\n    type: Boolean,\r\n    default: false\r\n  }\r\n})\r\n\r\nconst emit = defineEmits(['close', 'saved'])\r\n\r\nconst localConfig = ref({\r\n  COMFYUI_SERVER_URL: '',\r\n  CLIENT_ID: '',\r\n  TIMEOUT: 300000\r\n})\r\n\r\nconst timeoutSeconds = computed({\r\n  get: () => Math.floor(localConfig.value.TIMEOUT / 1000),\r\n  set: (value) => {\r\n    localConfig.value.TIMEOUT = value * 1000\r\n  }\r\n})\r\n\r\n// æµ‹è¯•ç›¸å…³å˜é‡å·²åˆ é™¤\r\n\r\n// éªŒè¯é…ç½®æ˜¯å¦æœ‰æ•ˆ\r\nconst isValidConfig = computed(() => {\r\n  return localConfig.value.COMFYUI_SERVER_URL &&\r\n         localConfig.value.COMFYUI_SERVER_URL.startsWith('http') &&\r\n         localConfig.value.CLIENT_ID &&\r\n         localConfig.value.TIMEOUT > 0\r\n})\r\n\r\n// ç›‘å¬visibleå˜åŒ–ï¼ŒåŠ è½½å½“å‰é…ç½®\r\nwatch(() => props.visible, (newVisible) => {\r\n  if (newVisible) {\r\n    loadCurrentConfig()\r\n  }\r\n})\r\n\r\n// åŠ è½½å½“å‰é…ç½®\r\nconst loadCurrentConfig = async () => {\r\n  try {\r\n    const currentConfig = await getCurrentConfig();\r\n    localConfig.value = { ...currentConfig };\r\n    console.log('ğŸ“‹ åŠ è½½å½“å‰é…ç½®:', localConfig.value);\r\n  } catch (error) {\r\n    console.error('âŒ åŠ è½½é…ç½®å¤±è´¥:', error);\r\n    // ä½¿ç”¨é»˜è®¤é…ç½®\r\n    localConfig.value = {\r\n      COMFYUI_SERVER_URL: 'https://hwf0p724ub-8188.cnb.run',\r\n      CLIENT_ID: 'abc1373d4ad648a3a81d0587fbe5534b',\r\n      TIMEOUT: 300000\r\n    };\r\n  }\r\n}\r\n\r\n// æµ‹è¯•è¿æ¥åŠŸèƒ½å·²åˆ é™¤\r\n\r\n// é¢„è®¾é…ç½®åŠŸèƒ½å·²åˆ é™¤\r\n\r\n// ä¿å­˜é…ç½®\r\nconst saveConfig = async () => {\r\n  if (!isValidConfig.value) return\r\n\r\n  try {\r\n    console.log('ğŸ’¾ ä¿å­˜é…ç½®ä¸­...')\r\n    const result = await updateComfyUIConfig(localConfig.value)\r\n\r\n    // æ˜¾ç¤ºä¿å­˜ç»“æœ\r\n    if (result.proxyUpdate.success) {\r\n      console.log('âœ… é…ç½®ä¿å­˜æˆåŠŸï¼Œä»£ç†æœåŠ¡å™¨å·²åŒæ­¥æ›´æ–°')\r\n    } else {\r\n      console.warn('âš ï¸ é…ç½®å·²ä¿å­˜ï¼Œä½†ä»£ç†æœåŠ¡å™¨æ›´æ–°å¤±è´¥:', result.proxyUpdate.message)\r\n      // å¯ä»¥é€‰æ‹©æ˜¾ç¤ºè­¦å‘Šï¼Œä½†ä¸é˜»æ­¢ä¿å­˜\r\n      if (localConfig.value.USE_PROXY) {\r\n        alert(`é…ç½®å·²ä¿å­˜ï¼Œä½†ä»£ç†æœåŠ¡å™¨æ›´æ–°å¤±è´¥: ${result.proxyUpdate.message}\\n\\nè¯·ç¡®ä¿ä»£ç†æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œæˆ–è€ƒè™‘é‡å¯ä»£ç†æœåŠ¡å™¨ã€‚`)\r\n      }\r\n    }\r\n\r\n    emit('saved', result.config)\r\n    closeModal()\r\n  } catch (error) {\r\n    console.error('ä¿å­˜é…ç½®å¤±è´¥:', error)\r\n    alert('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message)\r\n  }\r\n}\r\n\r\n// é‡ç½®é…ç½®\r\nconst resetConfig = () => {\r\n  const defaultConfig = resetToDefaultConfig()\r\n  localConfig.value = { ...defaultConfig }\r\n}\r\n\r\n// å…³é—­æ¨¡æ€æ¡†\r\nconst closeModal = () => {\r\n  emit('close')\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.modal-overlay {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  background: rgba(0, 0, 0, 0.7);\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  z-index: 1000;\r\n}\r\n\r\n.modal-content {\r\n  background: var(--bg-card);\r\n  border: 1px solid var(--border-color);\r\n  border-radius: 12px;\r\n  width: 90%;\r\n  max-width: 600px;\r\n  max-height: 90vh;\r\n  overflow-y: auto;\r\n  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);\r\n  color: var(--text-color);\r\n}\r\n\r\n.modal-header {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  padding: 20px 24px;\r\n  border-bottom: 1px solid var(--border-color);\r\n}\r\n\r\n.modal-header h2 {\r\n  margin: 0;\r\n  color: var(--text-color);\r\n}\r\n\r\n.close-btn {\r\n  background: none;\r\n  border: none;\r\n  font-size: 24px;\r\n  cursor: pointer;\r\n  color: var(--text-light);\r\n  padding: 0;\r\n  width: 30px;\r\n  height: 30px;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  border-radius: 50%;\r\n  transition: all 0.2s;\r\n}\r\n\r\n.close-btn:hover {\r\n  background-color: rgba(255, 255, 255, 0.1);\r\n  color: var(--text-color);\r\n}\r\n\r\n.modal-body {\r\n  padding: 24px;\r\n}\r\n\r\n.config-section {\r\n  margin-bottom: 24px;\r\n}\r\n\r\n.config-section label {\r\n  display: block;\r\n  margin-bottom: 8px;\r\n  font-weight: 600;\r\n  color: var(--text-color);\r\n}\r\n\r\n.config-input {\r\n  width: 100%;\r\n  padding: 12px;\r\n  border: 2px solid var(--border-color);\r\n  border-radius: 8px;\r\n  font-size: 14px;\r\n  background: var(--bg-dark-light);\r\n  color: var(--text-color);\r\n  transition: border-color 0.3s;\r\n}\r\n\r\n.config-input:focus {\r\n  outline: none;\r\n  border-color: var(--primary-color);\r\n}\r\n\r\n.config-input::placeholder {\r\n  color: var(--text-muted);\r\n}\r\n\r\n.help-text {\r\n  display: block;\r\n  margin-top: 4px;\r\n  color: var(--text-light);\r\n  font-size: 12px;\r\n}\r\n\r\n/* æµ‹è¯•ç›¸å…³æ ·å¼å·²åˆ é™¤ */\r\n\r\n/* é¢„è®¾é…ç½®æ ·å¼å·²åˆ é™¤ */\r\n\r\n.modal-footer {\r\n  padding: 20px 24px;\r\n  border-top: 1px solid #eee;\r\n  display: flex;\r\n  justify-content: flex-end;\r\n  gap: 12px;\r\n}\r\n\r\n/* æŒ‰é’®æ ·å¼å·²ç§»è‡³AppButtonç»„ä»¶ */\r\n</style>\r\n"
        }
    ]
}