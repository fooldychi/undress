{
    "sourceFile": "client/src/test-server-consistency-fixes.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1753108550923,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1753108581848,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -182,8 +182,81 @@\n     console.error('âŒ æµ‹è¯•4å¼‚å¸¸:', error)\n   }\n }\n \n+// æµ‹è¯•5: éªŒè¯æœåŠ¡å™¨ä¸€è‡´æ€§æ£€æŸ¥å‡½æ•°\n+async function testServerConsistencyValidation() {\n+  console.log('\\nğŸ§ª æµ‹è¯•5: æœåŠ¡å™¨ä¸€è‡´æ€§æ£€æŸ¥å‡½æ•°')\n+\n+  try {\n+    // 5.1 æµ‹è¯•æ— ä»»åŠ¡æ—¶çš„éªŒè¯é€šè¿‡\n+    console.log('5.1 æµ‹è¯•æ— ä»»åŠ¡æ—¶çš„éªŒè¯é€šè¿‡')\n+    windowTasks.clear()\n+\n+    try {\n+      validateServerConsistency('æµ‹è¯•æ“ä½œ', mockServers[0])\n+      console.log('âœ… æµ‹è¯•5.1é€šè¿‡: æ— ä»»åŠ¡æ—¶éªŒè¯é€šè¿‡')\n+    } catch (error) {\n+      console.error('âŒ æµ‹è¯•5.1å¤±è´¥: æ— ä»»åŠ¡æ—¶éªŒè¯å¤±è´¥:', error.message)\n+    }\n+\n+    // 5.2 æµ‹è¯•æœ‰ä»»åŠ¡ä½†æ— é”å®šæœåŠ¡å™¨æ—¶çš„é”™è¯¯\n+    console.log('5.2 æµ‹è¯•æœ‰ä»»åŠ¡ä½†æ— é”å®šæœåŠ¡å™¨æ—¶çš„é”™è¯¯')\n+\n+    // æ·»åŠ æµ‹è¯•ä»»åŠ¡\n+    windowTasks.set('test-task-005', {\n+      workflowType: 'test',\n+      executionServer: mockServers[0],\n+      windowId: WINDOW_ID\n+    })\n+\n+    const originalLocked = window.windowLockedServer\n+    window.windowLockedServer = null\n+\n+    try {\n+      validateServerConsistency('æµ‹è¯•æ“ä½œ', mockServers[0])\n+      console.error('âŒ æµ‹è¯•5.2å¤±è´¥: åº”è¯¥æŠ›å‡ºé”™è¯¯')\n+    } catch (error) {\n+      if (error.message.includes('å¾…å¤„ç†ä»»åŠ¡ä½†æœåŠ¡å™¨æœªé”å®š')) {\n+        console.log('âœ… æµ‹è¯•5.2é€šè¿‡: æ­£ç¡®æ£€æµ‹åˆ°ä»»åŠ¡-æœåŠ¡å™¨ä¸ä¸€è‡´')\n+      } else {\n+        console.error('âŒ æµ‹è¯•5.2å¤±è´¥: é”™è¯¯ç±»å‹ä¸æ­£ç¡®:', error.message)\n+      }\n+    } finally {\n+      window.windowLockedServer = originalLocked\n+      windowTasks.delete('test-task-005')\n+    }\n+\n+    // 5.3 æµ‹è¯•æœåŠ¡å™¨åˆ‡æ¢æ£€æµ‹\n+    console.log('5.3 æµ‹è¯•æœåŠ¡å™¨åˆ‡æ¢æ£€æµ‹')\n+\n+    windowTasks.set('test-task-006', {\n+      workflowType: 'test',\n+      executionServer: mockServers[0],\n+      windowId: WINDOW_ID\n+    })\n+\n+    window.windowLockedServer = mockServers[0]\n+\n+    try {\n+      validateServerConsistency('æµ‹è¯•æ“ä½œ', mockServers[1]) // ä¸åŒçš„æœåŠ¡å™¨\n+      console.error('âŒ æµ‹è¯•5.3å¤±è´¥: åº”è¯¥æ£€æµ‹åˆ°æœåŠ¡å™¨åˆ‡æ¢')\n+    } catch (error) {\n+      if (error.message.includes('æœåŠ¡å™¨åˆ‡æ¢æ£€æµ‹')) {\n+        console.log('âœ… æµ‹è¯•5.3é€šè¿‡: æ­£ç¡®æ£€æµ‹åˆ°æœåŠ¡å™¨åˆ‡æ¢')\n+      } else {\n+        console.error('âŒ æµ‹è¯•5.3å¤±è´¥: é”™è¯¯ç±»å‹ä¸æ­£ç¡®:', error.message)\n+      }\n+    } finally {\n+      windowTasks.delete('test-task-006')\n+      window.windowLockedServer = null\n+    }\n+\n+  } catch (error) {\n+    console.error('âŒ æµ‹è¯•5å¼‚å¸¸:', error)\n+  }\n+}\n+\n // è¿è¡Œæ‰€æœ‰æµ‹è¯•\n async function runAllTests() {\n   console.log(`ğŸš€ [${WINDOW_ID}] å¼€å§‹è¿è¡ŒæœåŠ¡å™¨ä¸€è‡´æ€§ä¿®å¤æµ‹è¯•`)\n \n"
                },
                {
                    "date": 1753108606491,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -258,20 +258,50 @@\n \n // è¿è¡Œæ‰€æœ‰æµ‹è¯•\n async function runAllTests() {\n   console.log(`ğŸš€ [${WINDOW_ID}] å¼€å§‹è¿è¡ŒæœåŠ¡å™¨ä¸€è‡´æ€§ä¿®å¤æµ‹è¯•`)\n+  console.log('=====================================')\n \n-  await testTaskRegistrationValidation()\n-  await testImageUrlStrictBinding()\n-  await testMissingBindingValidation()\n-  await testWebSocketReconnectionConsistency()\n+  const tests = [\n+    testTaskRegistrationValidation,\n+    testImageUrlStrictBinding,\n+    testMissingBindingValidation,\n+    testWebSocketReconnectionConsistency,\n+    testServerConsistencyValidation\n+  ]\n \n-  console.log('\\nğŸ¯ æµ‹è¯•æ€»ç»“:')\n-  console.log('- ä»»åŠ¡æ³¨å†Œæ—¶å¼ºåˆ¶éªŒè¯æœåŠ¡å™¨é”å®šçŠ¶æ€')\n-  console.log('- å›¾ç‰‡URLè·å–ç§»é™¤å›é€€é€»è¾‘ï¼Œå¼ºåˆ¶ä½¿ç”¨ä»»åŠ¡ç»‘å®šæœåŠ¡å™¨')\n-  console.log('- å¢å¼ºé”™è¯¯å¤„ç†ï¼Œå¯¹ç¼ºå¤±ç»‘å®šä¿¡æ¯æŠ›å‡ºæ˜ç¡®é”™è¯¯')\n-  console.log('- WebSocketé‡è¿æ—¶éªŒè¯æœåŠ¡å™¨ä¸€è‡´æ€§')\n-  console.log('\\nâœ… æ‰€æœ‰ä¿®å¤æªæ–½å·²å®æ–½å®Œæˆ')\n+  let passed = 0\n+  let total = tests.length\n+\n+  for (const test of tests) {\n+    try {\n+      await test()\n+      passed++\n+    } catch (error) {\n+      console.error(`âŒ æµ‹è¯•å¤±è´¥:`, error)\n+    }\n+  }\n+\n+  console.log('\\nğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»')\n+  console.log('=====================================')\n+  console.log(`âœ… é€šè¿‡: ${passed}/${total}`)\n+  console.log(`âŒ å¤±è´¥: ${total - passed}/${total}`)\n+\n+  console.log('\\nğŸ¯ ä¿®å¤æªæ–½éªŒè¯:')\n+  console.log('- âœ… å¼ºåŒ– getApiBaseUrl() å‡½æ•°çš„é”å®šæ£€æŸ¥')\n+  console.log('- âœ… å¢å¼º registerWindowTask() å‡½æ•°çš„éªŒè¯é€»è¾‘')\n+  console.log('- âœ… æ·»åŠ æœåŠ¡å™¨åˆ‡æ¢æ£€æµ‹æœºåˆ¶ validateServerConsistency()')\n+  console.log('- âœ… åœ¨å…³é”®APIè°ƒç”¨å‰è¿›è¡ŒæœåŠ¡å™¨ä¸€è‡´æ€§éªŒè¯')\n+  console.log('- âœ… ç§»é™¤å›¾ç‰‡URLè·å–çš„å›é€€é€»è¾‘ï¼Œå¼ºåˆ¶ä½¿ç”¨ç»‘å®šæœåŠ¡å™¨')\n+  console.log('- âœ… å¢å¼ºè°ƒè¯•å·¥å…· debugServerConsistency() å’Œ checkServerSwitchRisk()')\n+\n+  if (passed === total) {\n+    console.log('\\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼å¤šçª—å£å¤šä»»åŠ¡æœåŠ¡å™¨ä¸€è‡´æ€§ä¿®å¤å·¥ä½œæ­£å¸¸')\n+  } else {\n+    console.log('\\nâš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ä¿®å¤å®ç°')\n+  }\n+\n+  return { passed, total, success: passed === total }\n }\n \n // å¯¼å‡ºæµ‹è¯•å‡½æ•°\n export { runAllTests }\n"
                }
            ],
            "date": 1753108550923,
            "name": "Commit-0",
            "content": "// ğŸ§ª æµ‹è¯•æœåŠ¡å™¨ä¸€è‡´æ€§ä¿®å¤\n// éªŒè¯å¤šçª—å£å¤šä»»åŠ¡ç¯å¢ƒä¸‹å›¾ç‰‡æœåŠ¡å™¨åœ°å€é”™è¯¯é—®é¢˜çš„ä¿®å¤æ•ˆæœ\n\nimport {\n  registerWindowTask,\n  getTaskBoundImageUrl,\n  ensureWebSocketConnection,\n  submitWorkflow,\n  windowTasks,\n  windowLockedServer,\n  WINDOW_ID,\n  validateServerConsistency,\n  getApiBaseUrl,\n  uploadImageToComfyUI,\n  getTaskHistory\n} from './services/comfyui.js'\n\nconsole.log('ğŸ§ª å¼€å§‹æµ‹è¯•æœåŠ¡å™¨ä¸€è‡´æ€§ä¿®å¤')\n\n// æ¨¡æ‹ŸæœåŠ¡å™¨åœ°å€\nconst mockServers = [\n  'https://server1.example.com',\n  'https://server2.example.com',\n  'https://server3.example.com'\n]\n\n// æ¨¡æ‹Ÿä»»åŠ¡ç»“æœ\nconst mockTaskResult = {\n  images: [{\n    filename: 'test_image_001.png',\n    subfolder: '',\n    type: 'output'\n  }]\n}\n\n// æµ‹è¯•1: éªŒè¯ä»»åŠ¡æ³¨å†Œæ—¶æœåŠ¡å™¨ç»‘å®šéªŒè¯\nasync function testTaskRegistrationValidation() {\n  console.log('\\nğŸ§ª æµ‹è¯•1: ä»»åŠ¡æ³¨å†Œæ—¶æœåŠ¡å™¨ç»‘å®šéªŒè¯')\n\n  try {\n    // æ¸…ç©ºå½“å‰çŠ¶æ€\n    windowTasks.clear()\n\n    // å°è¯•åœ¨æœåŠ¡å™¨æœªé”å®šæ—¶æ³¨å†Œä»»åŠ¡ï¼ˆåº”è¯¥å¤±è´¥ï¼‰\n    const promptId = 'test-prompt-001'\n    const mockTask = {\n      workflowType: 'undress',\n      createdAt: new Date().toISOString()\n    }\n\n    try {\n      registerWindowTask(promptId, mockTask)\n      console.error('âŒ æµ‹è¯•1å¤±è´¥: åº”è¯¥æŠ›å‡ºæœåŠ¡å™¨æœªé”å®šé”™è¯¯')\n    } catch (error) {\n      if (error.message.includes('æœåŠ¡å™¨æœªé”å®š')) {\n        console.log('âœ… æµ‹è¯•1é€šè¿‡: æ­£ç¡®æ£€æµ‹åˆ°æœåŠ¡å™¨æœªé”å®š')\n      } else {\n        console.error('âŒ æµ‹è¯•1å¤±è´¥: é”™è¯¯ä¿¡æ¯ä¸ç¬¦åˆé¢„æœŸ:', error.message)\n      }\n    }\n\n  } catch (error) {\n    console.error('âŒ æµ‹è¯•1å¼‚å¸¸:', error)\n  }\n}\n\n// æµ‹è¯•2: éªŒè¯å›¾ç‰‡URLè·å–çš„å¼ºåˆ¶ç»‘å®šæœåŠ¡å™¨é€»è¾‘\nasync function testImageUrlStrictBinding() {\n  console.log('\\nğŸ§ª æµ‹è¯•2: å›¾ç‰‡URLè·å–çš„å¼ºåˆ¶ç»‘å®šæœåŠ¡å™¨é€»è¾‘')\n\n  try {\n    // æ¨¡æ‹Ÿé”å®šæœåŠ¡å™¨\n    window.windowLockedServer = mockServers[0]\n\n    const promptId = 'test-prompt-002'\n    const mockTask = {\n      workflowType: 'undress',\n      executionServer: mockServers[1], // ä¸åŒäºé”å®šæœåŠ¡å™¨\n      createdAt: new Date().toISOString()\n    }\n\n    // æ‰‹åŠ¨æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—ï¼ˆç»•è¿‡æ³¨å†ŒéªŒè¯ï¼‰\n    windowTasks.set(promptId, {\n      ...mockTask,\n      windowId: WINDOW_ID,\n      registeredAt: Date.now()\n    })\n\n    // æµ‹è¯•è·å–å›¾ç‰‡URLï¼ˆåº”è¯¥ä½¿ç”¨ä»»åŠ¡ç»‘å®šçš„æœåŠ¡å™¨ï¼‰\n    try {\n      const imageUrl = await getTaskBoundImageUrl(promptId, mockTaskResult, 'undress')\n\n      if (imageUrl.includes(mockServers[1])) {\n        console.log('âœ… æµ‹è¯•2é€šè¿‡: å›¾ç‰‡URLä½¿ç”¨äº†ä»»åŠ¡ç»‘å®šçš„æœåŠ¡å™¨')\n        console.log(`ğŸŒ ç”Ÿæˆçš„å›¾ç‰‡URL: ${imageUrl}`)\n      } else {\n        console.error('âŒ æµ‹è¯•2å¤±è´¥: å›¾ç‰‡URLæœªä½¿ç”¨ç»‘å®šæœåŠ¡å™¨')\n        console.error(`   æœŸæœ›åŒ…å«: ${mockServers[1]}`)\n        console.error(`   å®é™…URL: ${imageUrl}`)\n      }\n    } catch (error) {\n      console.log('âœ… æµ‹è¯•2é€šè¿‡: æ­£ç¡®æŠ›å‡ºäº†ç»‘å®šéªŒè¯é”™è¯¯:', error.message)\n    }\n\n  } catch (error) {\n    console.error('âŒ æµ‹è¯•2å¼‚å¸¸:', error)\n  }\n}\n\n// æµ‹è¯•3: éªŒè¯ç¼ºå¤±ç»‘å®šä¿¡æ¯æ—¶çš„é”™è¯¯å¤„ç†\nasync function testMissingBindingValidation() {\n  console.log('\\nğŸ§ª æµ‹è¯•3: ç¼ºå¤±ç»‘å®šä¿¡æ¯æ—¶çš„é”™è¯¯å¤„ç†')\n\n  try {\n    const promptId = 'test-prompt-003'\n\n    // æµ‹è¯•ä»»åŠ¡ä¸å­˜åœ¨çš„æƒ…å†µ\n    try {\n      await getTaskBoundImageUrl(promptId, mockTaskResult, 'undress')\n      console.error('âŒ æµ‹è¯•3aå¤±è´¥: åº”è¯¥æŠ›å‡ºä»»åŠ¡æœªæ‰¾åˆ°é”™è¯¯')\n    } catch (error) {\n      if (error.message.includes('ä»»åŠ¡') && error.message.includes('æœªæ‰¾åˆ°')) {\n        console.log('âœ… æµ‹è¯•3aé€šè¿‡: æ­£ç¡®æ£€æµ‹åˆ°ä»»åŠ¡ä¸å­˜åœ¨')\n      } else {\n        console.error('âŒ æµ‹è¯•3aå¤±è´¥: é”™è¯¯ä¿¡æ¯ä¸ç¬¦åˆé¢„æœŸ:', error.message)\n      }\n    }\n\n    // æµ‹è¯•executionServerä¸ºç©ºçš„æƒ…å†µ\n    windowTasks.set(promptId, {\n      workflowType: 'undress',\n      executionServer: null, // ç©ºçš„ç»‘å®šæœåŠ¡å™¨\n      windowId: WINDOW_ID,\n      registeredAt: Date.now()\n    })\n\n    try {\n      await getTaskBoundImageUrl(promptId, mockTaskResult, 'undress')\n      console.error('âŒ æµ‹è¯•3bå¤±è´¥: åº”è¯¥æŠ›å‡ºç»‘å®šæœåŠ¡å™¨ä¸ºç©ºé”™è¯¯')\n    } catch (error) {\n      if (error.message.includes('executionServer') && error.message.includes('ä¸ºç©º')) {\n        console.log('âœ… æµ‹è¯•3bé€šè¿‡: æ­£ç¡®æ£€æµ‹åˆ°ç»‘å®šæœåŠ¡å™¨ä¸ºç©º')\n      } else {\n        console.error('âŒ æµ‹è¯•3bå¤±è´¥: é”™è¯¯ä¿¡æ¯ä¸ç¬¦åˆé¢„æœŸ:', error.message)\n      }\n    }\n\n  } catch (error) {\n    console.error('âŒ æµ‹è¯•3å¼‚å¸¸:', error)\n  }\n}\n\n// æµ‹è¯•4: éªŒè¯WebSocketé‡è¿æ—¶çš„æœåŠ¡å™¨ä¸€è‡´æ€§\nasync function testWebSocketReconnectionConsistency() {\n  console.log('\\nğŸ§ª æµ‹è¯•4: WebSocketé‡è¿æ—¶çš„æœåŠ¡å™¨ä¸€è‡´æ€§')\n\n  try {\n    // æ¨¡æ‹Ÿæœ‰å¾…å¤„ç†ä»»åŠ¡çš„æƒ…å†µ\n    const promptId = 'test-prompt-004'\n    windowTasks.set(promptId, {\n      workflowType: 'undress',\n      executionServer: mockServers[0],\n      windowId: WINDOW_ID,\n      registeredAt: Date.now()\n    })\n\n    // æ¨¡æ‹ŸæœåŠ¡å™¨æœªé”å®šä½†æœ‰å¾…å¤„ç†ä»»åŠ¡çš„æƒ…å†µ\n    window.windowLockedServer = null\n\n    try {\n      await ensureWebSocketConnection()\n      console.error('âŒ æµ‹è¯•4å¤±è´¥: åº”è¯¥æŠ›å‡ºæœåŠ¡å™¨ä¸€è‡´æ€§é”™è¯¯')\n    } catch (error) {\n      if (error.message.includes('å¾…å¤„ç†ä»»åŠ¡') && error.message.includes('æœåŠ¡å™¨æœªé”å®š')) {\n        console.log('âœ… æµ‹è¯•4é€šè¿‡: æ­£ç¡®æ£€æµ‹åˆ°æœåŠ¡å™¨ä¸€è‡´æ€§é—®é¢˜')\n      } else {\n        console.error('âŒ æµ‹è¯•4å¤±è´¥: é”™è¯¯ä¿¡æ¯ä¸ç¬¦åˆé¢„æœŸ:', error.message)\n      }\n    }\n\n  } catch (error) {\n    console.error('âŒ æµ‹è¯•4å¼‚å¸¸:', error)\n  }\n}\n\n// è¿è¡Œæ‰€æœ‰æµ‹è¯•\nasync function runAllTests() {\n  console.log(`ğŸš€ [${WINDOW_ID}] å¼€å§‹è¿è¡ŒæœåŠ¡å™¨ä¸€è‡´æ€§ä¿®å¤æµ‹è¯•`)\n\n  await testTaskRegistrationValidation()\n  await testImageUrlStrictBinding()\n  await testMissingBindingValidation()\n  await testWebSocketReconnectionConsistency()\n\n  console.log('\\nğŸ¯ æµ‹è¯•æ€»ç»“:')\n  console.log('- ä»»åŠ¡æ³¨å†Œæ—¶å¼ºåˆ¶éªŒè¯æœåŠ¡å™¨é”å®šçŠ¶æ€')\n  console.log('- å›¾ç‰‡URLè·å–ç§»é™¤å›é€€é€»è¾‘ï¼Œå¼ºåˆ¶ä½¿ç”¨ä»»åŠ¡ç»‘å®šæœåŠ¡å™¨')\n  console.log('- å¢å¼ºé”™è¯¯å¤„ç†ï¼Œå¯¹ç¼ºå¤±ç»‘å®šä¿¡æ¯æŠ›å‡ºæ˜ç¡®é”™è¯¯')\n  console.log('- WebSocketé‡è¿æ—¶éªŒè¯æœåŠ¡å™¨ä¸€è‡´æ€§')\n  console.log('\\nâœ… æ‰€æœ‰ä¿®å¤æªæ–½å·²å®æ–½å®Œæˆ')\n}\n\n// å¯¼å‡ºæµ‹è¯•å‡½æ•°\nexport { runAllTests }\n\n// å¦‚æœç›´æ¥è¿è¡Œæ­¤æ–‡ä»¶ï¼Œæ‰§è¡Œæµ‹è¯•\nif (typeof window !== 'undefined') {\n  window.testServerConsistencyFixes = runAllTests\n  console.log('ğŸ”§ æµ‹è¯•å‡½æ•°å·²æš´éœ²åˆ°å…¨å±€: window.testServerConsistencyFixes()')\n}\n"
        }
    ]
}