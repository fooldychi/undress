{
    "sourceFile": "client/src/views/QueueManagerDemo.vue",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1753203750496,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1753203750496,
            "name": "Commit-0",
            "content": "<template>\n  <div class=\"queue-manager-demo\">\n    <div class=\"demo-header\">\n      <h1>🔥 任务队列管理系统演示</h1>\n      <p class=\"demo-description\">\n        这个演示展示了如何使用新的任务队列管理系统来彻底解决ComfyUI客户端在52.25%进度卡住的问题。\n      </p>\n    </div>\n\n    <!-- 初始化控制 -->\n    <div class=\"control-section\">\n      <h2>🚀 系统控制</h2>\n      <div class=\"control-buttons\">\n        <button\n          @click=\"initializeSystem\"\n          :disabled=\"isInitialized\"\n          class=\"btn btn-primary\"\n        >\n          {{ isInitialized ? '✅ 已初始化' : '🚀 初始化队列系统' }}\n        </button>\n\n        <button\n          @click=\"startMonitoring\"\n          :disabled=\"!isInitialized || isMonitoring\"\n          class=\"btn btn-secondary\"\n        >\n          {{ isMonitoring ? '📊 监控中...' : '📊 开始监控' }}\n        </button>\n\n        <button\n          @click=\"stopMonitoring\"\n          :disabled=\"!isMonitoring\"\n          class=\"btn btn-warning\"\n        >\n          ⏹️ 停止监控\n        </button>\n\n        <button\n          @click=\"resetSystem\"\n          class=\"btn btn-danger\"\n        >\n          🔄 重置系统\n        </button>\n      </div>\n    </div>\n\n    <!-- 队列监控组件 -->\n    <QueueMonitor v-if=\"isInitialized\" />\n\n    <!-- 测试控制 -->\n    <div class=\"test-section\" v-if=\"isInitialized\">\n      <h2>🧪 功能测试</h2>\n\n      <div class=\"test-grid\">\n        <!-- 单任务测试 -->\n        <div class=\"test-card\">\n          <h3>🎯 单任务测试</h3>\n          <div class=\"test-buttons\">\n            <button\n              @click=\"testUndress\"\n              :disabled=\"isProcessing\"\n              class=\"btn btn-test\"\n            >\n              👗 测试一键褪衣\n            </button>\n\n            <button\n              @click=\"testFaceSwap\"\n              :disabled=\"isProcessing\"\n              class=\"btn btn-test\"\n            >\n              👤 测试极速换脸\n            </button>\n          </div>\n        </div>\n\n        <!-- 批量测试 -->\n        <div class=\"test-card\">\n          <h3>📦 批量测试</h3>\n          <div class=\"batch-controls\">\n            <label>任务数量:</label>\n            <input\n              v-model.number=\"batchSize\"\n              type=\"number\"\n              min=\"1\"\n              max=\"10\"\n              class=\"batch-input\"\n            >\n            <button\n              @click=\"testBatchProcessing\"\n              :disabled=\"isProcessing\"\n              class=\"btn btn-test\"\n            >\n              🚀 开始批量测试\n            </button>\n          </div>\n        </div>\n\n        <!-- 卡住恢复测试 -->\n        <div class=\"test-card\">\n          <h3>🔧 卡住恢复测试</h3>\n          <div class=\"recovery-controls\">\n            <button\n              @click=\"testStuckRecovery\"\n              :disabled=\"isProcessing\"\n              class=\"btn btn-test\"\n            >\n              🚨 模拟52.25%卡住\n            </button>\n\n            <button\n              @click=\"forceRecovery\"\n              class=\"btn btn-warning\"\n            >\n              🔧 强制恢复卡住任务\n            </button>\n          </div>\n        </div>\n\n        <!-- 压力测试 -->\n        <div class=\"test-card\">\n          <h3>💪 压力测试</h3>\n          <div class=\"stress-controls\">\n            <button\n              @click=\"runStressTest\"\n              :disabled=\"isProcessing\"\n              class=\"btn btn-test\"\n            >\n              🔥 运行压力测试\n            </button>\n\n            <button\n              @click=\"runCompleteTest\"\n              :disabled=\"isProcessing\"\n              class=\"btn btn-primary\"\n            >\n              🎯 完整功能测试\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <!-- 日志输出 -->\n    <div class=\"log-section\">\n      <h2>📝 实时日志</h2>\n      <div class=\"log-controls\">\n        <button @click=\"clearLogs\" class=\"btn btn-secondary\">🧹 清空日志</button>\n        <button @click=\"exportLogs\" class=\"btn btn-secondary\">📤 导出日志</button>\n        <label class=\"auto-scroll-label\">\n          <input v-model=\"autoScroll\" type=\"checkbox\">\n          自动滚动\n        </label>\n      </div>\n      <div\n        ref=\"logContainer\"\n        class=\"log-container\"\n        :class=\"{ 'auto-scroll': autoScroll }\"\n      >\n        <div\n          v-for=\"(log, index) in logs\"\n          :key=\"index\"\n          class=\"log-entry\"\n          :class=\"log.type\"\n        >\n          <span class=\"log-time\">{{ formatTime(log.timestamp) }}</span>\n          <span class=\"log-message\">{{ log.message }}</span>\n        </div>\n      </div>\n    </div>\n\n    <!-- 统计信息 -->\n    <div class=\"stats-section\" v-if=\"isInitialized\">\n      <h2>📈 性能统计</h2>\n      <div class=\"stats-grid\">\n        <div class=\"stat-item\">\n          <div class=\"stat-label\">总处理任务</div>\n          <div class=\"stat-value\">{{ stats.totalProcessed }}</div>\n        </div>\n        <div class=\"stat-item\">\n          <div class=\"stat-label\">成功率</div>\n          <div class=\"stat-value\">{{ successRate }}%</div>\n        </div>\n        <div class=\"stat-item\">\n          <div class=\"stat-label\">平均处理时间</div>\n          <div class=\"stat-value\">{{ averageTime }}s</div>\n        </div>\n        <div class=\"stat-item\">\n          <div class=\"stat-label\">重试次数</div>\n          <div class=\"stat-value\">{{ stats.totalRetried }}</div>\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\nimport QueueMonitor from '../components/QueueMonitor.vue'\nimport {\n  initializeQueueSystem,\n  testUndressWithQueue,\n  testFaceSwapWithQueue,\n  testBatchProcessing,\n  testStuckTaskRecovery,\n  monitorQueueStatus,\n  runCompleteTest\n} from '../utils/queueManagerExample.js'\n\nexport default {\n  name: 'QueueManagerDemo',\n  components: {\n    QueueMonitor\n  },\n  data() {\n    return {\n      isInitialized: false,\n      isMonitoring: false,\n      isProcessing: false,\n      batchSize: 3,\n      autoScroll: true,\n      logs: [],\n      stats: {\n        totalProcessed: 0,\n        totalSucceeded: 0,\n        totalFailed: 0,\n        totalRetried: 0,\n        averageProcessingTime: 0\n      },\n      monitoringStopFunction: null,\n      updateInterval: null\n    }\n  },\n  computed: {\n    successRate() {\n      const total = this.stats.totalSucceeded + this.stats.totalFailed\n      if (total === 0) return 0\n      return Math.round((this.stats.totalSucceeded / total) * 100)\n    },\n\n    averageTime() {\n      return Math.round(this.stats.averageProcessingTime / 1000)\n    }\n  },\n  mounted() {\n    this.setupConsoleCapture()\n    this.checkInitialization()\n  },\n  beforeDestroy() {\n    this.stopMonitoring()\n    this.stopStatsUpdate()\n  },\n  methods: {\n    // 系统控制方法\n    async initializeSystem() {\n      try {\n        this.addLog('🚀 正在初始化队列管理系统...', 'info')\n        await initializeQueueSystem()\n        this.isInitialized = true\n        this.addLog('✅ 队列管理系统初始化完成', 'success')\n        this.startStatsUpdate()\n      } catch (error) {\n        this.addLog(`❌ 初始化失败: ${error.message}`, 'error')\n      }\n    },\n\n    startMonitoring() {\n      if (this.monitoringStopFunction) return\n\n      this.addLog('📊 开始队列状态监控...', 'info')\n      this.monitoringStopFunction = monitorQueueStatus()\n      this.isMonitoring = true\n    },\n\n    stopMonitoring() {\n      if (this.monitoringStopFunction) {\n        this.monitoringStopFunction()\n        this.monitoringStopFunction = null\n        this.isMonitoring = false\n        this.addLog('⏹️ 队列状态监控已停止', 'info')\n      }\n    },\n\n    resetSystem() {\n      this.stopMonitoring()\n      this.stopStatsUpdate()\n\n      if (window.taskQueueManager) {\n        window.taskQueueManager.stop()\n        delete window.taskQueueManager\n      }\n\n      this.isInitialized = false\n      this.isProcessing = false\n      this.addLog('🔄 系统已重置', 'warning')\n    },\n\n    // 测试方法\n    async testUndress() {\n      try {\n        this.isProcessing = true\n        this.addLog('👗 开始一键褪衣测试...', 'info')\n\n        // 模拟base64图片数据\n        const mockImage = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k='\n\n        const taskController = await testUndressWithQueue(mockImage)\n        this.addLog(`📋 一键褪衣任务已提交: ${taskController.taskId}`, 'success')\n\n      } catch (error) {\n        this.addLog(`❌ 一键褪衣测试失败: ${error.message}`, 'error')\n      } finally {\n        this.isProcessing = false\n      }\n    },\n\n    async testFaceSwap() {\n      try {\n        this.isProcessing = true\n        this.addLog('👤 开始极速换脸测试...', 'info')\n\n        // 模拟图片数据\n        const mockSource = 'mock_source_image'\n        const mockTarget = 'mock_target_image'\n\n        const taskController = await testFaceSwapWithQueue(mockSource, mockTarget)\n        this.addLog(`📋 极速换脸任务已提交: ${taskController.taskId}`, 'success')\n\n      } catch (error) {\n        this.addLog(`❌ 极速换脸测试失败: ${error.message}`, 'error')\n      } finally {\n        this.isProcessing = false\n      }\n    },\n\n    async testBatchProcessing() {\n      try {\n        this.isProcessing = true\n        this.addLog(`📦 开始批量测试 (${this.batchSize}个任务)...`, 'info')\n\n        const tasks = await testBatchProcessing()\n        this.addLog(`📋 ${tasks.length}个批量任务已提交`, 'success')\n\n      } catch (error) {\n        this.addLog(`❌ 批量测试失败: ${error.message}`, 'error')\n      } finally {\n        this.isProcessing = false\n      }\n    },\n\n    async testStuckRecovery() {\n      try {\n        this.isProcessing = true\n        this.addLog('🚨 开始卡住恢复测试...', 'info')\n\n        const taskController = await testStuckTaskRecovery()\n        this.addLog(`📋 卡住恢复测试任务已提交: ${taskController.taskId}`, 'success')\n        this.addLog('⏰ 任务将在52.25%处卡住，请观察自动恢复过程', 'warning')\n\n      } catch (error) {\n        this.addLog(`❌ 卡住恢复测试失败: ${error.message}`, 'error')\n      } finally {\n        this.isProcessing = false\n      }\n    },\n\n    forceRecovery() {\n      this.addLog('🔧 强制恢复所有卡住的任务...', 'warning')\n      if (window.forceCompleteStuckTasks) {\n        window.forceCompleteStuckTasks()\n      } else {\n        this.addLog('❌ 恢复工具不可用', 'error')\n      }\n    },\n\n    async runStressTest() {\n      try {\n        this.isProcessing = true\n        this.addLog('💪 开始压力测试...', 'info')\n\n        // 提交10个并发任务\n        const promises = []\n        for (let i = 0; i < 10; i++) {\n          promises.push(testBatchProcessing())\n        }\n\n        await Promise.all(promises)\n        this.addLog('✅ 压力测试完成', 'success')\n\n      } catch (error) {\n        this.addLog(`❌ 压力测试失败: ${error.message}`, 'error')\n      } finally {\n        this.isProcessing = false\n      }\n    },\n\n    async runCompleteTest() {\n      try {\n        this.isProcessing = true\n        this.addLog('🎯 开始完整功能测试...', 'info')\n\n        await runCompleteTest()\n        this.addLog('✅ 完整功能测试完成', 'success')\n\n      } catch (error) {\n        this.addLog(`❌ 完整功能测试失败: ${error.message}`, 'error')\n      } finally {\n        this.isProcessing = false\n      }\n    },\n\n    // 工具方法\n    checkInitialization() {\n      if (window.taskQueueManager) {\n        this.isInitialized = true\n        this.startStatsUpdate()\n        this.addLog('✅ 检测到已存在的队列管理器', 'info')\n      }\n    },\n\n    startStatsUpdate() {\n      if (this.updateInterval) return\n\n      this.updateInterval = setInterval(() => {\n        if (window.taskQueueManager) {\n          const status = window.taskQueueManager.getQueueStatus()\n          this.stats = status.stats\n        }\n      }, 2000)\n    },\n\n    stopStatsUpdate() {\n      if (this.updateInterval) {\n        clearInterval(this.updateInterval)\n        this.updateInterval = null\n      }\n    },\n\n    setupConsoleCapture() {\n      // 捕获console.log输出到日志区域\n      const originalLog = console.log\n      const originalError = console.error\n      const originalWarn = console.warn\n\n      console.log = (...args) => {\n        originalLog.apply(console, args)\n        this.addLog(args.join(' '), 'info')\n      }\n\n      console.error = (...args) => {\n        originalError.apply(console, args)\n        this.addLog(args.join(' '), 'error')\n      }\n\n      console.warn = (...args) => {\n        originalWarn.apply(console, args)\n        this.addLog(args.join(' '), 'warning')\n      }\n    },\n\n    addLog(message, type = 'info') {\n      this.logs.push({\n        message,\n        type,\n        timestamp: Date.now()\n      })\n\n      // 限制日志数量\n      if (this.logs.length > 1000) {\n        this.logs = this.logs.slice(-500)\n      }\n\n      // 自动滚动到底部\n      if (this.autoScroll) {\n        this.$nextTick(() => {\n          const container = this.$refs.logContainer\n          if (container) {\n            container.scrollTop = container.scrollHeight\n          }\n        })\n      }\n    },\n\n    clearLogs() {\n      this.logs = []\n    },\n\n    exportLogs() {\n      const logText = this.logs.map(log =>\n        `[${this.formatTime(log.timestamp)}] ${log.type.toUpperCase()}: ${log.message}`\n      ).join('\\n')\n\n      const blob = new Blob([logText], { type: 'text/plain' })\n      const url = URL.createObjectURL(blob)\n      const a = document.createElement('a')\n      a.href = url\n      a.download = `queue-manager-logs-${Date.now()}.txt`\n      a.click()\n      URL.revokeObjectURL(url)\n    },\n\n    formatTime(timestamp) {\n      return new Date(timestamp).toLocaleTimeString()\n    }\n  }\n}\n</script>\n\n<style scoped>\n.queue-manager-demo {\n  max-width: 1200px;\n  margin: 0 auto;\n  padding: 20px;\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n}\n\n/* 头部样式 */\n.demo-header {\n  text-align: center;\n  margin-bottom: 40px;\n  padding: 30px;\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  color: white;\n  border-radius: 12px;\n  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);\n}\n\n.demo-header h1 {\n  margin: 0 0 16px 0;\n  font-size: 2.5em;\n  font-weight: 700;\n}\n\n.demo-description {\n  margin: 0;\n  font-size: 1.1em;\n  opacity: 0.9;\n  line-height: 1.6;\n}\n\n/* 控制区域 */\n.control-section,\n.test-section,\n.log-section,\n.stats-section {\n  background: white;\n  border-radius: 12px;\n  padding: 24px;\n  margin-bottom: 24px;\n  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);\n  border: 1px solid #e9ecef;\n}\n\n.control-section h2,\n.test-section h2,\n.log-section h2,\n.stats-section h2 {\n  margin: 0 0 20px 0;\n  font-size: 1.5em;\n  color: #2c3e50;\n  display: flex;\n  align-items: center;\n  gap: 8px;\n}\n\n.control-buttons {\n  display: flex;\n  gap: 12px;\n  flex-wrap: wrap;\n}\n\n/* 按钮样式 */\n.btn {\n  padding: 12px 24px;\n  border: none;\n  border-radius: 8px;\n  font-size: 14px;\n  font-weight: 600;\n  cursor: pointer;\n  transition: all 0.3s ease;\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  text-decoration: none;\n  min-height: 44px;\n}\n\n.btn:disabled {\n  opacity: 0.6;\n  cursor: not-allowed;\n  transform: none !important;\n}\n\n.btn:hover:not(:disabled) {\n  transform: translateY(-2px);\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n}\n\n.btn-primary {\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  color: white;\n}\n\n.btn-secondary {\n  background: #6c757d;\n  color: white;\n}\n\n.btn-warning {\n  background: #ffc107;\n  color: #212529;\n}\n\n.btn-danger {\n  background: #dc3545;\n  color: white;\n}\n\n.btn-test {\n  background: #28a745;\n  color: white;\n}\n\n/* 测试区域 */\n.test-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n  gap: 20px;\n}\n\n.test-card {\n  background: #f8f9fa;\n  border-radius: 8px;\n  padding: 20px;\n  border: 1px solid #e9ecef;\n}\n\n.test-card h3 {\n  margin: 0 0 16px 0;\n  font-size: 1.2em;\n  color: #495057;\n}\n\n.test-buttons {\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n}\n\n.batch-controls,\n.recovery-controls,\n.stress-controls {\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n}\n\n.batch-controls label {\n  font-weight: 500;\n  color: #495057;\n}\n\n.batch-input {\n  padding: 8px 12px;\n  border: 1px solid #ced4da;\n  border-radius: 4px;\n  font-size: 14px;\n}\n\n/* 日志区域 */\n.log-controls {\n  display: flex;\n  gap: 12px;\n  align-items: center;\n  margin-bottom: 16px;\n  flex-wrap: wrap;\n}\n\n.auto-scroll-label {\n  display: flex;\n  align-items: center;\n  gap: 6px;\n  font-size: 14px;\n  color: #6c757d;\n  cursor: pointer;\n}\n\n.log-container {\n  height: 400px;\n  overflow-y: auto;\n  background: #1e1e1e;\n  border-radius: 8px;\n  padding: 16px;\n  font-family: 'Courier New', monospace;\n  font-size: 13px;\n  line-height: 1.4;\n}\n\n.log-entry {\n  margin-bottom: 4px;\n  display: flex;\n  gap: 12px;\n}\n\n.log-time {\n  color: #888;\n  flex-shrink: 0;\n  width: 80px;\n}\n\n.log-message {\n  flex: 1;\n  word-break: break-word;\n}\n\n.log-entry.info .log-message {\n  color: #e9ecef;\n}\n\n.log-entry.success .log-message {\n  color: #28a745;\n}\n\n.log-entry.warning .log-message {\n  color: #ffc107;\n}\n\n.log-entry.error .log-message {\n  color: #dc3545;\n}\n\n/* 统计区域 */\n.stats-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n  gap: 16px;\n}\n\n.stat-item {\n  background: #f8f9fa;\n  border-radius: 8px;\n  padding: 20px;\n  text-align: center;\n  border: 1px solid #e9ecef;\n}\n\n.stat-label {\n  font-size: 14px;\n  color: #6c757d;\n  margin-bottom: 8px;\n  text-transform: uppercase;\n  letter-spacing: 0.5px;\n}\n\n.stat-value {\n  font-size: 2em;\n  font-weight: bold;\n  color: #2c3e50;\n}\n\n/* 响应式设计 */\n@media (max-width: 768px) {\n  .queue-manager-demo {\n    padding: 16px;\n  }\n\n  .demo-header {\n    padding: 20px;\n  }\n\n  .demo-header h1 {\n    font-size: 2em;\n  }\n\n  .control-section,\n  .test-section,\n  .log-section,\n  .stats-section {\n    padding: 16px;\n  }\n\n  .control-buttons {\n    flex-direction: column;\n  }\n\n  .btn {\n    width: 100%;\n    justify-content: center;\n  }\n\n  .test-grid {\n    grid-template-columns: 1fr;\n  }\n\n  .log-controls {\n    flex-direction: column;\n    align-items: flex-start;\n  }\n\n  .log-container {\n    height: 300px;\n    font-size: 12px;\n  }\n\n  .stats-grid {\n    grid-template-columns: repeat(2, 1fr);\n  }\n}\n\n/* 滚动条样式 */\n.log-container::-webkit-scrollbar {\n  width: 8px;\n}\n\n.log-container::-webkit-scrollbar-track {\n  background: #2d2d2d;\n  border-radius: 4px;\n}\n\n.log-container::-webkit-scrollbar-thumb {\n  background: #555;\n  border-radius: 4px;\n}\n\n.log-container::-webkit-scrollbar-thumb:hover {\n  background: #777;\n}\n\n/* 动画效果 */\n@keyframes fadeIn {\n  from {\n    opacity: 0;\n    transform: translateY(20px);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(0);\n  }\n}\n\n.control-section,\n.test-section,\n.log-section,\n.stats-section {\n  animation: fadeIn 0.5s ease-out;\n}\n\n/* 加载状态 */\n.btn:disabled {\n  position: relative;\n}\n\n.btn:disabled::after {\n  content: '';\n  position: absolute;\n  width: 16px;\n  height: 16px;\n  margin: auto;\n  border: 2px solid transparent;\n  border-top-color: currentColor;\n  border-radius: 50%;\n  animation: spin 1s linear infinite;\n}\n\n@keyframes spin {\n  0% { transform: rotate(0deg); }\n  100% { transform: rotate(360deg); }\n}\n</style>\n"
        }
    ]
}