{
    "sourceFile": "client/test-websocket-fix.html",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1752912268558,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752912294849,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -133,9 +133,9 @@\n             wsConnection,\n             isWsConnected,\n             pendingTasks,\n             debugTaskStatus,\n-            processUndressImage,\n+            testOfficialStandard,\n             getApiBaseUrl\n         };\n \n         // 日志函数\n"
                },
                {
                    "date": 1752912330817,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -202,33 +202,28 @@\n                 updateStatus('connectionStatus', `❌ 初始化失败: ${error.message}`, 'error');\n             }\n         };\n \n-        // 测试任务提交\n+        // 测试官方标准实现\n         window.testTaskSubmission = async function() {\n             const testBtn = document.getElementById('testTaskBtn');\n             testBtn.disabled = true;\n             testBtn.textContent = '测试中...';\n \n-            addLog('🎯 开始测试任务提交和完成检测...');\n-            updateStatus('taskStatus', '正在测试任务提交...', 'info');\n+            addLog('🎯 开始测试官方标准实现...');\n+            updateStatus('taskStatus', '正在测试官方标准实现...', 'info');\n \n             try {\n-                // 创建一个测试用的base64图片（1x1像素的透明PNG）\n-                const testImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';\n+                addLog('📤 调用testOfficialStandard...');\n \n-                addLog('📤 提交测试任务...');\n+                const result = await window.comfyUIService.testOfficialStandard();\n \n-                const result = await window.comfyUIService.processUndressImage(testImage, (status, progress) => {\n-                    addLog(`📊 进度更新: ${status} (${progress}%)`);\n-                });\n+                addLog('✅ 官方标准测试完成！结果:', JSON.stringify(result, null, 2));\n+                updateStatus('taskStatus', '✅ 官方标准测试成功完成', 'success');\n \n-                addLog('✅ 任务完成！结果:', JSON.stringify(result, null, 2));\n-                updateStatus('taskStatus', '✅ 任务测试成功完成', 'success');\n-\n             } catch (error) {\n-                addLog(`❌ 任务测试失败: ${error.message}`);\n-                updateStatus('taskStatus', `❌ 任务测试失败: ${error.message}`, 'error');\n+                addLog(`❌ 官方标准测试失败: ${error.message}`);\n+                updateStatus('taskStatus', `❌ 测试失败: ${error.message}`, 'error');\n             } finally {\n                 testBtn.disabled = false;\n                 testBtn.textContent = '测试任务提交';\n             }\n"
                }
            ],
            "date": 1752912268558,
            "name": "Commit-0",
            "content": "<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>WebSocket 修复测试</title>\n    <style>\n        body {\n            font-family: Arial, sans-serif;\n            max-width: 800px;\n            margin: 0 auto;\n            padding: 20px;\n            background-color: #f5f5f5;\n        }\n        .container {\n            background: white;\n            padding: 20px;\n            border-radius: 8px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n        }\n        .test-section {\n            margin: 20px 0;\n            padding: 15px;\n            border: 1px solid #ddd;\n            border-radius: 5px;\n        }\n        .test-section h3 {\n            margin-top: 0;\n            color: #333;\n        }\n        .log-area {\n            background: #000;\n            color: #0f0;\n            padding: 10px;\n            border-radius: 5px;\n            height: 300px;\n            overflow-y: auto;\n            font-family: monospace;\n            font-size: 12px;\n            white-space: pre-wrap;\n        }\n        button {\n            background: #007bff;\n            color: white;\n            border: none;\n            padding: 10px 20px;\n            border-radius: 5px;\n            cursor: pointer;\n            margin: 5px;\n        }\n        button:hover {\n            background: #0056b3;\n        }\n        button:disabled {\n            background: #ccc;\n            cursor: not-allowed;\n        }\n        .status {\n            padding: 10px;\n            border-radius: 5px;\n            margin: 10px 0;\n        }\n        .status.success {\n            background: #d4edda;\n            color: #155724;\n            border: 1px solid #c3e6cb;\n        }\n        .status.error {\n            background: #f8d7da;\n            color: #721c24;\n            border: 1px solid #f5c6cb;\n        }\n        .status.info {\n            background: #d1ecf1;\n            color: #0c5460;\n            border: 1px solid #bee5eb;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h1>🔧 WebSocket 修复测试</h1>\n        <p>此页面用于测试ComfyUI WebSocket消息处理和任务完成检测的修复效果。</p>\n\n        <div class=\"test-section\">\n            <h3>📊 连接状态</h3>\n            <div id=\"connectionStatus\" class=\"status info\">正在检查连接状态...</div>\n            <button onclick=\"testConnection()\">测试连接</button>\n            <button onclick=\"initWebSocket()\">初始化WebSocket</button>\n        </div>\n\n        <div class=\"test-section\">\n            <h3>🎯 任务测试</h3>\n            <div id=\"taskStatus\" class=\"status info\">准备就绪</div>\n            <button onclick=\"testTaskSubmission()\" id=\"testTaskBtn\">测试任务提交</button>\n            <button onclick=\"debugTasks()\">查看待处理任务</button>\n            <button onclick=\"clearLogs()\">清除日志</button>\n        </div>\n\n        <div class=\"test-section\">\n            <h3>📝 实时日志</h3>\n            <div id=\"logArea\" class=\"log-area\">等待日志输出...\\n</div>\n        </div>\n\n        <div class=\"test-section\">\n            <h3>🔍 调试信息</h3>\n            <div id=\"debugInfo\" class=\"status info\">\n                <strong>测试重点：</strong><br>\n                1. WebSocket消息是否正确接收<br>\n                2. executing消息中node===null是否被正确检测<br>\n                3. getTaskHistory是否被调用<br>\n                4. 任务完成回调是否及时触发<br>\n                5. pendingTasks是否正确管理\n            </div>\n        </div>\n    </div>\n\n    <script type=\"module\">\n        // 导入ComfyUI服务\n        import {\n            initializeWebSocket,\n            wsConnection,\n            isWsConnected,\n            pendingTasks,\n            debugTaskStatus,\n            testOfficialStandard,\n            getApiBaseUrl\n        } from './src/services/comfyui.js';\n\n        // 全局变量\n        window.comfyUIService = {\n            initializeWebSocket,\n            wsConnection,\n            isWsConnected,\n            pendingTasks,\n            debugTaskStatus,\n            processUndressImage,\n            getApiBaseUrl\n        };\n\n        // 日志函数\n        function addLog(message, type = 'info') {\n            const logArea = document.getElementById('logArea');\n            const timestamp = new Date().toLocaleTimeString();\n            const logEntry = `[${timestamp}] ${message}\\n`;\n            logArea.textContent += logEntry;\n            logArea.scrollTop = logArea.scrollHeight;\n\n            console.log(`[WebSocket测试] ${message}`);\n        }\n\n        // 更新状态显示\n        function updateStatus(elementId, message, type = 'info') {\n            const element = document.getElementById(elementId);\n            element.textContent = message;\n            element.className = `status ${type}`;\n        }\n\n        // 测试连接\n        window.testConnection = async function() {\n            addLog('🔍 开始测试连接状态...');\n\n            try {\n                const apiBaseUrl = await window.comfyUIService.getApiBaseUrl();\n                addLog(`📡 API基础URL: ${apiBaseUrl}`);\n\n                const wsStatus = window.comfyUIService.isWsConnected;\n                addLog(`🔌 WebSocket连接状态: ${wsStatus ? '已连接' : '未连接'}`);\n\n                if (window.comfyUIService.wsConnection) {\n                    addLog(`📊 WebSocket readyState: ${window.comfyUIService.wsConnection.readyState}`);\n                }\n\n                updateStatus('connectionStatus',\n                    wsStatus ? '✅ WebSocket已连接' : '❌ WebSocket未连接',\n                    wsStatus ? 'success' : 'error'\n                );\n\n            } catch (error) {\n                addLog(`❌ 连接测试失败: ${error.message}`);\n                updateStatus('connectionStatus', `❌ 连接测试失败: ${error.message}`, 'error');\n            }\n        };\n\n        // 初始化WebSocket\n        window.initWebSocket = async function() {\n            addLog('🚀 开始初始化WebSocket连接...');\n            updateStatus('connectionStatus', '正在初始化WebSocket...', 'info');\n\n            try {\n                await window.comfyUIService.initializeWebSocket();\n                addLog('✅ WebSocket初始化成功');\n                updateStatus('connectionStatus', '✅ WebSocket初始化成功', 'success');\n\n                // 等待一秒后检查状态\n                setTimeout(() => {\n                    window.testConnection();\n                }, 1000);\n\n            } catch (error) {\n                addLog(`❌ WebSocket初始化失败: ${error.message}`);\n                updateStatus('connectionStatus', `❌ 初始化失败: ${error.message}`, 'error');\n            }\n        };\n\n        // 测试任务提交\n        window.testTaskSubmission = async function() {\n            const testBtn = document.getElementById('testTaskBtn');\n            testBtn.disabled = true;\n            testBtn.textContent = '测试中...';\n\n            addLog('🎯 开始测试任务提交和完成检测...');\n            updateStatus('taskStatus', '正在测试任务提交...', 'info');\n\n            try {\n                // 创建一个测试用的base64图片（1x1像素的透明PNG）\n                const testImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';\n\n                addLog('📤 提交测试任务...');\n\n                const result = await window.comfyUIService.processUndressImage(testImage, (status, progress) => {\n                    addLog(`📊 进度更新: ${status} (${progress}%)`);\n                });\n\n                addLog('✅ 任务完成！结果:', JSON.stringify(result, null, 2));\n                updateStatus('taskStatus', '✅ 任务测试成功完成', 'success');\n\n            } catch (error) {\n                addLog(`❌ 任务测试失败: ${error.message}`);\n                updateStatus('taskStatus', `❌ 任务测试失败: ${error.message}`, 'error');\n            } finally {\n                testBtn.disabled = false;\n                testBtn.textContent = '测试任务提交';\n            }\n        };\n\n        // 调试任务状态\n        window.debugTasks = function() {\n            addLog('🔍 调试当前任务状态...');\n\n            try {\n                window.comfyUIService.debugTaskStatus();\n\n                const pendingCount = window.comfyUIService.pendingTasks.size;\n                addLog(`📊 当前待处理任务数: ${pendingCount}`);\n\n                if (pendingCount > 0) {\n                    const taskIds = Array.from(window.comfyUIService.pendingTasks.keys());\n                    addLog(`📋 待处理任务ID列表: ${taskIds.join(', ')}`);\n                }\n\n            } catch (error) {\n                addLog(`❌ 调试失败: ${error.message}`);\n            }\n        };\n\n        // 清除日志\n        window.clearLogs = function() {\n            document.getElementById('logArea').textContent = '日志已清除...\\n';\n        };\n\n        // 页面加载完成后自动测试连接\n        window.addEventListener('load', () => {\n            addLog('🚀 页面加载完成，开始自动测试...');\n            window.testConnection();\n        });\n\n        // 全局错误处理\n        window.addEventListener('error', (event) => {\n            addLog(`❌ 全局错误: ${event.error?.message || event.message}`);\n        });\n\n        // 添加到全局作用域以便调试\n        window.addLog = addLog;\n        window.updateStatus = updateStatus;\n    </script>\n</body>\n</html>\n"
        }
    ]
}