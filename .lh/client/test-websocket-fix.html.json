{
    "sourceFile": "client/test-websocket-fix.html",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1752912268558,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752912294849,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -133,9 +133,9 @@\n             wsConnection,\n             isWsConnected,\n             pendingTasks,\n             debugTaskStatus,\n-            processUndressImage,\n+            testOfficialStandard,\n             getApiBaseUrl\n         };\n \n         // æ—¥å¿—å‡½æ•°\n"
                },
                {
                    "date": 1752912330817,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -202,33 +202,28 @@\n                 updateStatus('connectionStatus', `âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');\n             }\n         };\n \n-        // æµ‹è¯•ä»»åŠ¡æäº¤\n+        // æµ‹è¯•å®˜æ–¹æ ‡å‡†å®ç°\n         window.testTaskSubmission = async function() {\n             const testBtn = document.getElementById('testTaskBtn');\n             testBtn.disabled = true;\n             testBtn.textContent = 'æµ‹è¯•ä¸­...';\n \n-            addLog('ğŸ¯ å¼€å§‹æµ‹è¯•ä»»åŠ¡æäº¤å’Œå®Œæˆæ£€æµ‹...');\n-            updateStatus('taskStatus', 'æ­£åœ¨æµ‹è¯•ä»»åŠ¡æäº¤...', 'info');\n+            addLog('ğŸ¯ å¼€å§‹æµ‹è¯•å®˜æ–¹æ ‡å‡†å®ç°...');\n+            updateStatus('taskStatus', 'æ­£åœ¨æµ‹è¯•å®˜æ–¹æ ‡å‡†å®ç°...', 'info');\n \n             try {\n-                // åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨çš„base64å›¾ç‰‡ï¼ˆ1x1åƒç´ çš„é€æ˜PNGï¼‰\n-                const testImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';\n+                addLog('ğŸ“¤ è°ƒç”¨testOfficialStandard...');\n \n-                addLog('ğŸ“¤ æäº¤æµ‹è¯•ä»»åŠ¡...');\n+                const result = await window.comfyUIService.testOfficialStandard();\n \n-                const result = await window.comfyUIService.processUndressImage(testImage, (status, progress) => {\n-                    addLog(`ğŸ“Š è¿›åº¦æ›´æ–°: ${status} (${progress}%)`);\n-                });\n+                addLog('âœ… å®˜æ–¹æ ‡å‡†æµ‹è¯•å®Œæˆï¼ç»“æœ:', JSON.stringify(result, null, 2));\n+                updateStatus('taskStatus', 'âœ… å®˜æ–¹æ ‡å‡†æµ‹è¯•æˆåŠŸå®Œæˆ', 'success');\n \n-                addLog('âœ… ä»»åŠ¡å®Œæˆï¼ç»“æœ:', JSON.stringify(result, null, 2));\n-                updateStatus('taskStatus', 'âœ… ä»»åŠ¡æµ‹è¯•æˆåŠŸå®Œæˆ', 'success');\n-\n             } catch (error) {\n-                addLog(`âŒ ä»»åŠ¡æµ‹è¯•å¤±è´¥: ${error.message}`);\n-                updateStatus('taskStatus', `âŒ ä»»åŠ¡æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');\n+                addLog(`âŒ å®˜æ–¹æ ‡å‡†æµ‹è¯•å¤±è´¥: ${error.message}`);\n+                updateStatus('taskStatus', `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');\n             } finally {\n                 testBtn.disabled = false;\n                 testBtn.textContent = 'æµ‹è¯•ä»»åŠ¡æäº¤';\n             }\n"
                }
            ],
            "date": 1752912268558,
            "name": "Commit-0",
            "content": "<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>WebSocket ä¿®å¤æµ‹è¯•</title>\n    <style>\n        body {\n            font-family: Arial, sans-serif;\n            max-width: 800px;\n            margin: 0 auto;\n            padding: 20px;\n            background-color: #f5f5f5;\n        }\n        .container {\n            background: white;\n            padding: 20px;\n            border-radius: 8px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n        }\n        .test-section {\n            margin: 20px 0;\n            padding: 15px;\n            border: 1px solid #ddd;\n            border-radius: 5px;\n        }\n        .test-section h3 {\n            margin-top: 0;\n            color: #333;\n        }\n        .log-area {\n            background: #000;\n            color: #0f0;\n            padding: 10px;\n            border-radius: 5px;\n            height: 300px;\n            overflow-y: auto;\n            font-family: monospace;\n            font-size: 12px;\n            white-space: pre-wrap;\n        }\n        button {\n            background: #007bff;\n            color: white;\n            border: none;\n            padding: 10px 20px;\n            border-radius: 5px;\n            cursor: pointer;\n            margin: 5px;\n        }\n        button:hover {\n            background: #0056b3;\n        }\n        button:disabled {\n            background: #ccc;\n            cursor: not-allowed;\n        }\n        .status {\n            padding: 10px;\n            border-radius: 5px;\n            margin: 10px 0;\n        }\n        .status.success {\n            background: #d4edda;\n            color: #155724;\n            border: 1px solid #c3e6cb;\n        }\n        .status.error {\n            background: #f8d7da;\n            color: #721c24;\n            border: 1px solid #f5c6cb;\n        }\n        .status.info {\n            background: #d1ecf1;\n            color: #0c5460;\n            border: 1px solid #bee5eb;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h1>ğŸ”§ WebSocket ä¿®å¤æµ‹è¯•</h1>\n        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•ComfyUI WebSocketæ¶ˆæ¯å¤„ç†å’Œä»»åŠ¡å®Œæˆæ£€æµ‹çš„ä¿®å¤æ•ˆæœã€‚</p>\n\n        <div class=\"test-section\">\n            <h3>ğŸ“Š è¿æ¥çŠ¶æ€</h3>\n            <div id=\"connectionStatus\" class=\"status info\">æ­£åœ¨æ£€æŸ¥è¿æ¥çŠ¶æ€...</div>\n            <button onclick=\"testConnection()\">æµ‹è¯•è¿æ¥</button>\n            <button onclick=\"initWebSocket()\">åˆå§‹åŒ–WebSocket</button>\n        </div>\n\n        <div class=\"test-section\">\n            <h3>ğŸ¯ ä»»åŠ¡æµ‹è¯•</h3>\n            <div id=\"taskStatus\" class=\"status info\">å‡†å¤‡å°±ç»ª</div>\n            <button onclick=\"testTaskSubmission()\" id=\"testTaskBtn\">æµ‹è¯•ä»»åŠ¡æäº¤</button>\n            <button onclick=\"debugTasks()\">æŸ¥çœ‹å¾…å¤„ç†ä»»åŠ¡</button>\n            <button onclick=\"clearLogs()\">æ¸…é™¤æ—¥å¿—</button>\n        </div>\n\n        <div class=\"test-section\">\n            <h3>ğŸ“ å®æ—¶æ—¥å¿—</h3>\n            <div id=\"logArea\" class=\"log-area\">ç­‰å¾…æ—¥å¿—è¾“å‡º...\\n</div>\n        </div>\n\n        <div class=\"test-section\">\n            <h3>ğŸ” è°ƒè¯•ä¿¡æ¯</h3>\n            <div id=\"debugInfo\" class=\"status info\">\n                <strong>æµ‹è¯•é‡ç‚¹ï¼š</strong><br>\n                1. WebSocketæ¶ˆæ¯æ˜¯å¦æ­£ç¡®æ¥æ”¶<br>\n                2. executingæ¶ˆæ¯ä¸­node===nullæ˜¯å¦è¢«æ­£ç¡®æ£€æµ‹<br>\n                3. getTaskHistoryæ˜¯å¦è¢«è°ƒç”¨<br>\n                4. ä»»åŠ¡å®Œæˆå›è°ƒæ˜¯å¦åŠæ—¶è§¦å‘<br>\n                5. pendingTasksæ˜¯å¦æ­£ç¡®ç®¡ç†\n            </div>\n        </div>\n    </div>\n\n    <script type=\"module\">\n        // å¯¼å…¥ComfyUIæœåŠ¡\n        import {\n            initializeWebSocket,\n            wsConnection,\n            isWsConnected,\n            pendingTasks,\n            debugTaskStatus,\n            testOfficialStandard,\n            getApiBaseUrl\n        } from './src/services/comfyui.js';\n\n        // å…¨å±€å˜é‡\n        window.comfyUIService = {\n            initializeWebSocket,\n            wsConnection,\n            isWsConnected,\n            pendingTasks,\n            debugTaskStatus,\n            processUndressImage,\n            getApiBaseUrl\n        };\n\n        // æ—¥å¿—å‡½æ•°\n        function addLog(message, type = 'info') {\n            const logArea = document.getElementById('logArea');\n            const timestamp = new Date().toLocaleTimeString();\n            const logEntry = `[${timestamp}] ${message}\\n`;\n            logArea.textContent += logEntry;\n            logArea.scrollTop = logArea.scrollHeight;\n\n            console.log(`[WebSocketæµ‹è¯•] ${message}`);\n        }\n\n        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º\n        function updateStatus(elementId, message, type = 'info') {\n            const element = document.getElementById(elementId);\n            element.textContent = message;\n            element.className = `status ${type}`;\n        }\n\n        // æµ‹è¯•è¿æ¥\n        window.testConnection = async function() {\n            addLog('ğŸ” å¼€å§‹æµ‹è¯•è¿æ¥çŠ¶æ€...');\n\n            try {\n                const apiBaseUrl = await window.comfyUIService.getApiBaseUrl();\n                addLog(`ğŸ“¡ APIåŸºç¡€URL: ${apiBaseUrl}`);\n\n                const wsStatus = window.comfyUIService.isWsConnected;\n                addLog(`ğŸ”Œ WebSocketè¿æ¥çŠ¶æ€: ${wsStatus ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}`);\n\n                if (window.comfyUIService.wsConnection) {\n                    addLog(`ğŸ“Š WebSocket readyState: ${window.comfyUIService.wsConnection.readyState}`);\n                }\n\n                updateStatus('connectionStatus',\n                    wsStatus ? 'âœ… WebSocketå·²è¿æ¥' : 'âŒ WebSocketæœªè¿æ¥',\n                    wsStatus ? 'success' : 'error'\n                );\n\n            } catch (error) {\n                addLog(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`);\n                updateStatus('connectionStatus', `âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');\n            }\n        };\n\n        // åˆå§‹åŒ–WebSocket\n        window.initWebSocket = async function() {\n            addLog('ğŸš€ å¼€å§‹åˆå§‹åŒ–WebSocketè¿æ¥...');\n            updateStatus('connectionStatus', 'æ­£åœ¨åˆå§‹åŒ–WebSocket...', 'info');\n\n            try {\n                await window.comfyUIService.initializeWebSocket();\n                addLog('âœ… WebSocketåˆå§‹åŒ–æˆåŠŸ');\n                updateStatus('connectionStatus', 'âœ… WebSocketåˆå§‹åŒ–æˆåŠŸ', 'success');\n\n                // ç­‰å¾…ä¸€ç§’åæ£€æŸ¥çŠ¶æ€\n                setTimeout(() => {\n                    window.testConnection();\n                }, 1000);\n\n            } catch (error) {\n                addLog(`âŒ WebSocketåˆå§‹åŒ–å¤±è´¥: ${error.message}`);\n                updateStatus('connectionStatus', `âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');\n            }\n        };\n\n        // æµ‹è¯•ä»»åŠ¡æäº¤\n        window.testTaskSubmission = async function() {\n            const testBtn = document.getElementById('testTaskBtn');\n            testBtn.disabled = true;\n            testBtn.textContent = 'æµ‹è¯•ä¸­...';\n\n            addLog('ğŸ¯ å¼€å§‹æµ‹è¯•ä»»åŠ¡æäº¤å’Œå®Œæˆæ£€æµ‹...');\n            updateStatus('taskStatus', 'æ­£åœ¨æµ‹è¯•ä»»åŠ¡æäº¤...', 'info');\n\n            try {\n                // åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨çš„base64å›¾ç‰‡ï¼ˆ1x1åƒç´ çš„é€æ˜PNGï¼‰\n                const testImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';\n\n                addLog('ğŸ“¤ æäº¤æµ‹è¯•ä»»åŠ¡...');\n\n                const result = await window.comfyUIService.processUndressImage(testImage, (status, progress) => {\n                    addLog(`ğŸ“Š è¿›åº¦æ›´æ–°: ${status} (${progress}%)`);\n                });\n\n                addLog('âœ… ä»»åŠ¡å®Œæˆï¼ç»“æœ:', JSON.stringify(result, null, 2));\n                updateStatus('taskStatus', 'âœ… ä»»åŠ¡æµ‹è¯•æˆåŠŸå®Œæˆ', 'success');\n\n            } catch (error) {\n                addLog(`âŒ ä»»åŠ¡æµ‹è¯•å¤±è´¥: ${error.message}`);\n                updateStatus('taskStatus', `âŒ ä»»åŠ¡æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');\n            } finally {\n                testBtn.disabled = false;\n                testBtn.textContent = 'æµ‹è¯•ä»»åŠ¡æäº¤';\n            }\n        };\n\n        // è°ƒè¯•ä»»åŠ¡çŠ¶æ€\n        window.debugTasks = function() {\n            addLog('ğŸ” è°ƒè¯•å½“å‰ä»»åŠ¡çŠ¶æ€...');\n\n            try {\n                window.comfyUIService.debugTaskStatus();\n\n                const pendingCount = window.comfyUIService.pendingTasks.size;\n                addLog(`ğŸ“Š å½“å‰å¾…å¤„ç†ä»»åŠ¡æ•°: ${pendingCount}`);\n\n                if (pendingCount > 0) {\n                    const taskIds = Array.from(window.comfyUIService.pendingTasks.keys());\n                    addLog(`ğŸ“‹ å¾…å¤„ç†ä»»åŠ¡IDåˆ—è¡¨: ${taskIds.join(', ')}`);\n                }\n\n            } catch (error) {\n                addLog(`âŒ è°ƒè¯•å¤±è´¥: ${error.message}`);\n            }\n        };\n\n        // æ¸…é™¤æ—¥å¿—\n        window.clearLogs = function() {\n            document.getElementById('logArea').textContent = 'æ—¥å¿—å·²æ¸…é™¤...\\n';\n        };\n\n        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•è¿æ¥\n        window.addEventListener('load', () => {\n            addLog('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•...');\n            window.testConnection();\n        });\n\n        // å…¨å±€é”™è¯¯å¤„ç†\n        window.addEventListener('error', (event) => {\n            addLog(`âŒ å…¨å±€é”™è¯¯: ${event.error?.message || event.message}`);\n        });\n\n        // æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸä»¥ä¾¿è°ƒè¯•\n        window.addLog = addLog;\n        window.updateStatus = updateStatus;\n    </script>\n</body>\n</html>\n"
        }
    ]
}