{
    "sourceFile": "client/deploy/imagic_production/proxy-server-simple.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 5,
            "patches": [
                {
                    "date": 1752328484917,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752328900494,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,9 +7,9 @@\n const app = express();\r\n const PORT = process.env.PORT || 3008;\r\n \r\n // ComfyUIæœåŠ¡å™¨åœ°å€\r\n-const COMFYUI_BASE_URL = process.env.COMFYUI_URL || 'https://your-comfyui-server.com';\r\n+const COMFYUI_BASE_URL = process.env.COMFYUI_URL || 'https://dzqgp58z0s-8188.cnb.run';\r\n \r\n console.log('ğŸš€ å¯åŠ¨Imagicä»£ç†æœåŠ¡å™¨...');\r\n \r\n // å¯ç”¨CORS\r\n@@ -35,10 +35,10 @@\n }));\r\n \r\n // å¥åº·æ£€æŸ¥\r\n app.get('/health', (req, res) => {\r\n-  res.json({\r\n-    status: 'ok',\r\n+  res.json({ \r\n+    status: 'ok', \r\n     message: 'Imagicä»£ç†æœåŠ¡å™¨è¿è¡Œæ­£å¸¸',\r\n     target: COMFYUI_BASE_URL,\r\n     timestamp: new Date().toISOString()\r\n   });\r\n@@ -62,10 +62,10 @@\n   },\r\n   onError: (err, req, res) => {\r\n     console.error('âŒ ä»£ç†é”™è¯¯:', err.message);\r\n     if (!res.headersSent) {\r\n-      res.status(500).json({\r\n-        error: 'ä»£ç†è¯·æ±‚å¤±è´¥',\r\n+      res.status(500).json({ \r\n+        error: 'ä»£ç†è¯·æ±‚å¤±è´¥', \r\n         details: err.message,\r\n         target: COMFYUI_BASE_URL\r\n       });\r\n     }\r\n@@ -80,9 +80,9 @@\n   // å¦‚æœæ˜¯APIè¯·æ±‚ä½†æ²¡æœ‰è¢«ä»£ç†å¤„ç†ï¼Œè¿”å›404\r\n   if (req.path.startsWith('/api/')) {\r\n     return res.status(404).json({ error: 'API endpoint not found' });\r\n   }\r\n-\r\n+  \r\n   // å…¶ä»–æ‰€æœ‰è¯·æ±‚è¿”å›index.htmlï¼ˆSPAè·¯ç”±ï¼‰\r\n   res.sendFile(path.join(__dirname, 'index.html'));\r\n });\r\n \r\n@@ -130,9 +130,9 @@\n   server.close(() => {\r\n     console.log('âœ… æœåŠ¡å™¨å·²å®‰å…¨å…³é—­');\r\n     process.exit(0);\r\n   });\r\n-\r\n+  \r\n   // å¼ºåˆ¶å…³é—­è¶…æ—¶\r\n   setTimeout(() => {\r\n     console.log('âš ï¸ å¼ºåˆ¶å…³é—­æœåŠ¡å™¨');\r\n     process.exit(1);\r\n@@ -148,7 +148,7 @@\n   const rl = readline.createInterface({\r\n     input: process.stdin,\r\n     output: process.stdout\r\n   });\r\n-\r\n+  \r\n   rl.on('SIGINT', gracefulShutdown);\r\n }\r\n"
                },
                {
                    "date": 1753557022700,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,18 +1,14 @@\n-// ç®€åŒ–ç‰ˆComfyUIä»£ç†æœåŠ¡å™¨ - ç”Ÿäº§ç¯å¢ƒä¸“ç”¨\r\n+// Imagicé™æ€æ–‡ä»¶æœåŠ¡å™¨ - ç”Ÿäº§ç¯å¢ƒä¸“ç”¨\r\n const express = require('express');\r\n-const { createProxyMiddleware } = require('http-proxy-middleware');\r\n const cors = require('cors');\r\n const path = require('path');\r\n \r\n const app = express();\r\n const PORT = process.env.PORT || 3008;\r\n \r\n-// ComfyUIæœåŠ¡å™¨åœ°å€\r\n-const COMFYUI_BASE_URL = process.env.COMFYUI_URL || 'https://dzqgp58z0s-8188.cnb.run';\r\n+console.log('ğŸš€ å¯åŠ¨Imagicé™æ€æ–‡ä»¶æœåŠ¡å™¨...');\r\n \r\n-console.log('ğŸš€ å¯åŠ¨Imagicä»£ç†æœåŠ¡å™¨...');\r\n-\r\n // å¯ç”¨CORS\r\n app.use(cors({\r\n   origin: true, // å…è®¸æ‰€æœ‰æ¥æº\r\n   credentials: true\r\n@@ -35,10 +31,10 @@\n }));\r\n \r\n // å¥åº·æ£€æŸ¥\r\n app.get('/health', (req, res) => {\r\n-  res.json({ \r\n-    status: 'ok', \r\n+  res.json({\r\n+    status: 'ok',\r\n     message: 'Imagicä»£ç†æœåŠ¡å™¨è¿è¡Œæ­£å¸¸',\r\n     target: COMFYUI_BASE_URL,\r\n     timestamp: new Date().toISOString()\r\n   });\r\n@@ -62,10 +58,10 @@\n   },\r\n   onError: (err, req, res) => {\r\n     console.error('âŒ ä»£ç†é”™è¯¯:', err.message);\r\n     if (!res.headersSent) {\r\n-      res.status(500).json({ \r\n-        error: 'ä»£ç†è¯·æ±‚å¤±è´¥', \r\n+      res.status(500).json({\r\n+        error: 'ä»£ç†è¯·æ±‚å¤±è´¥',\r\n         details: err.message,\r\n         target: COMFYUI_BASE_URL\r\n       });\r\n     }\r\n@@ -80,9 +76,9 @@\n   // å¦‚æœæ˜¯APIè¯·æ±‚ä½†æ²¡æœ‰è¢«ä»£ç†å¤„ç†ï¼Œè¿”å›404\r\n   if (req.path.startsWith('/api/')) {\r\n     return res.status(404).json({ error: 'API endpoint not found' });\r\n   }\r\n-  \r\n+\r\n   // å…¶ä»–æ‰€æœ‰è¯·æ±‚è¿”å›index.htmlï¼ˆSPAè·¯ç”±ï¼‰\r\n   res.sendFile(path.join(__dirname, 'index.html'));\r\n });\r\n \r\n@@ -130,9 +126,9 @@\n   server.close(() => {\r\n     console.log('âœ… æœåŠ¡å™¨å·²å®‰å…¨å…³é—­');\r\n     process.exit(0);\r\n   });\r\n-  \r\n+\r\n   // å¼ºåˆ¶å…³é—­è¶…æ—¶\r\n   setTimeout(() => {\r\n     console.log('âš ï¸ å¼ºåˆ¶å…³é—­æœåŠ¡å™¨');\r\n     process.exit(1);\r\n@@ -148,7 +144,7 @@\n   const rl = readline.createInterface({\r\n     input: process.stdin,\r\n     output: process.stdout\r\n   });\r\n-  \r\n+\r\n   rl.on('SIGINT', gracefulShutdown);\r\n }\r\n"
                },
                {
                    "date": 1753557034658,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -33,10 +33,9 @@\n // å¥åº·æ£€æŸ¥\r\n app.get('/health', (req, res) => {\r\n   res.json({\r\n     status: 'ok',\r\n-    message: 'Imagicä»£ç†æœåŠ¡å™¨è¿è¡Œæ­£å¸¸',\r\n-    target: COMFYUI_BASE_URL,\r\n+    message: 'Imagicé™æ€æ–‡ä»¶æœåŠ¡å™¨è¿è¡Œæ­£å¸¸',\r\n     timestamp: new Date().toISOString()\r\n   });\r\n });\r\n \r\n"
                },
                {
                    "date": 1753557054086,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -38,47 +38,11 @@\n     timestamp: new Date().toISOString()\r\n   });\r\n });\r\n \r\n-// APIä»£ç†é…ç½®\r\n-const proxyOptions = {\r\n-  target: COMFYUI_BASE_URL,\r\n-  changeOrigin: true,\r\n-  timeout: 60000, // 60ç§’è¶…æ—¶\r\n-  proxyTimeout: 60000,\r\n-  pathRewrite: {\r\n-    '^/api': '',\r\n-  },\r\n-  onProxyReq: (proxyReq, req, res) => {\r\n-    console.log(`ğŸ“¡ ä»£ç†è¯·æ±‚: ${req.method} ${req.url}`);\r\n-    proxyReq.setTimeout(60000);\r\n-  },\r\n-  onProxyRes: (proxyRes, req, res) => {\r\n-    console.log(`ğŸ“¥ ä»£ç†å“åº”: ${proxyRes.statusCode} ${req.url}`);\r\n-  },\r\n-  onError: (err, req, res) => {\r\n-    console.error('âŒ ä»£ç†é”™è¯¯:', err.message);\r\n-    if (!res.headersSent) {\r\n-      res.status(500).json({\r\n-        error: 'ä»£ç†è¯·æ±‚å¤±è´¥',\r\n-        details: err.message,\r\n-        target: COMFYUI_BASE_URL\r\n-      });\r\n-    }\r\n-  }\r\n-};\r\n-\r\n-// ä»£ç†æ‰€æœ‰APIè¯·æ±‚\r\n-app.use('/api', createProxyMiddleware(proxyOptions));\r\n-\r\n-// SPAè·¯ç”±æ”¯æŒ - æ‰€æœ‰éAPIè¯·æ±‚è¿”å›index.html\r\n+// SPAè·¯ç”±æ”¯æŒ - æ‰€æœ‰è¯·æ±‚è¿”å›index.html\r\n app.get('*', (req, res) => {\r\n-  // å¦‚æœæ˜¯APIè¯·æ±‚ä½†æ²¡æœ‰è¢«ä»£ç†å¤„ç†ï¼Œè¿”å›404\r\n-  if (req.path.startsWith('/api/')) {\r\n-    return res.status(404).json({ error: 'API endpoint not found' });\r\n-  }\r\n-\r\n-  // å…¶ä»–æ‰€æœ‰è¯·æ±‚è¿”å›index.htmlï¼ˆSPAè·¯ç”±ï¼‰\r\n+  // æ‰€æœ‰è¯·æ±‚è¿”å›index.htmlï¼ˆSPAè·¯ç”±ï¼‰\r\n   res.sendFile(path.join(__dirname, 'index.html'));\r\n });\r\n \r\n // å…¨å±€é”™è¯¯å¤„ç†\r\n"
                },
                {
                    "date": 1753557080559,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -47,27 +47,24 @@\n \r\n // å…¨å±€é”™è¯¯å¤„ç†\r\n process.on('uncaughtException', (error) => {\r\n   console.error('âŒ æœªæ•è·çš„å¼‚å¸¸:', error.message);\r\n-  console.error('è¯·æ£€æŸ¥ComfyUIæœåŠ¡å™¨è¿æ¥:', COMFYUI_BASE_URL);\r\n   // ä¸é€€å‡ºè¿›ç¨‹ï¼Œç»§ç»­è¿è¡Œ\r\n });\r\n \r\n process.on('unhandledRejection', (reason, promise) => {\r\n   console.error('âŒ æœªå¤„ç†çš„Promiseæ‹’ç»:', reason);\r\n-  console.error('è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒComfyUIæœåŠ¡å™¨çŠ¶æ€');\r\n   // ä¸é€€å‡ºè¿›ç¨‹ï¼Œç»§ç»­è¿è¡Œ\r\n });\r\n \r\n // å¯åŠ¨æœåŠ¡å™¨\r\n const server = app.listen(PORT, () => {\r\n-  console.log(`âœ… ImagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!`);\r\n+  console.log(`âœ… Imagicé™æ€æ–‡ä»¶æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!`);\r\n   console.log(`ğŸŒ è®¿é—®åœ°å€: http://localhost:${PORT}`);\r\n-  console.log(`ğŸ“¡ APIä»£ç†: http://localhost:${PORT}/api/*`);\r\n-  console.log(`ğŸ¯ ç›®æ ‡æœåŠ¡å™¨: ${COMFYUI_BASE_URL}`);\r\n   console.log(`ğŸ”§ å¥åº·æ£€æŸ¥: http://localhost:${PORT}/health`);\r\n   console.log('');\r\n   console.log('ğŸ‰ ç°åœ¨å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è®¿é—®Imagicåº”ç”¨äº†ï¼');\r\n+  console.log('ğŸ“ æ³¨æ„ï¼šåº”ç”¨å°†ç›´æ¥è¿æ¥åˆ°ComfyUIæœåŠ¡å™¨ï¼Œæ— éœ€ä»£ç†');\r\n });\r\n \r\n // å¤„ç†æœåŠ¡å™¨é”™è¯¯\r\n server.on('error', (error) => {\r\n"
                }
            ],
            "date": 1752328484917,
            "name": "Commit-0",
            "content": "// ç®€åŒ–ç‰ˆComfyUIä»£ç†æœåŠ¡å™¨ - ç”Ÿäº§ç¯å¢ƒä¸“ç”¨\r\nconst express = require('express');\r\nconst { createProxyMiddleware } = require('http-proxy-middleware');\r\nconst cors = require('cors');\r\nconst path = require('path');\r\n\r\nconst app = express();\r\nconst PORT = process.env.PORT || 3008;\r\n\r\n// ComfyUIæœåŠ¡å™¨åœ°å€\r\nconst COMFYUI_BASE_URL = process.env.COMFYUI_URL || 'https://your-comfyui-server.com';\r\n\r\nconsole.log('ğŸš€ å¯åŠ¨Imagicä»£ç†æœåŠ¡å™¨...');\r\n\r\n// å¯ç”¨CORS\r\napp.use(cors({\r\n  origin: true, // å…è®¸æ‰€æœ‰æ¥æº\r\n  credentials: true\r\n}));\r\n\r\n// è§£æJSON\r\napp.use(express.json({ limit: '50mb' }));\r\napp.use(express.urlencoded({ extended: true, limit: '50mb' }));\r\n\r\n// é™æ€æ–‡ä»¶æœåŠ¡\r\napp.use(express.static('./', {\r\n  index: 'index.html',\r\n  setHeaders: (res, path) => {\r\n    if (path.endsWith('.html')) {\r\n      res.setHeader('Cache-Control', 'no-cache');\r\n    } else if (path.includes('/assets/')) {\r\n      res.setHeader('Cache-Control', 'public, max-age=31536000');\r\n    }\r\n  }\r\n}));\r\n\r\n// å¥åº·æ£€æŸ¥\r\napp.get('/health', (req, res) => {\r\n  res.json({\r\n    status: 'ok',\r\n    message: 'Imagicä»£ç†æœåŠ¡å™¨è¿è¡Œæ­£å¸¸',\r\n    target: COMFYUI_BASE_URL,\r\n    timestamp: new Date().toISOString()\r\n  });\r\n});\r\n\r\n// APIä»£ç†é…ç½®\r\nconst proxyOptions = {\r\n  target: COMFYUI_BASE_URL,\r\n  changeOrigin: true,\r\n  timeout: 60000, // 60ç§’è¶…æ—¶\r\n  proxyTimeout: 60000,\r\n  pathRewrite: {\r\n    '^/api': '',\r\n  },\r\n  onProxyReq: (proxyReq, req, res) => {\r\n    console.log(`ğŸ“¡ ä»£ç†è¯·æ±‚: ${req.method} ${req.url}`);\r\n    proxyReq.setTimeout(60000);\r\n  },\r\n  onProxyRes: (proxyRes, req, res) => {\r\n    console.log(`ğŸ“¥ ä»£ç†å“åº”: ${proxyRes.statusCode} ${req.url}`);\r\n  },\r\n  onError: (err, req, res) => {\r\n    console.error('âŒ ä»£ç†é”™è¯¯:', err.message);\r\n    if (!res.headersSent) {\r\n      res.status(500).json({\r\n        error: 'ä»£ç†è¯·æ±‚å¤±è´¥',\r\n        details: err.message,\r\n        target: COMFYUI_BASE_URL\r\n      });\r\n    }\r\n  }\r\n};\r\n\r\n// ä»£ç†æ‰€æœ‰APIè¯·æ±‚\r\napp.use('/api', createProxyMiddleware(proxyOptions));\r\n\r\n// SPAè·¯ç”±æ”¯æŒ - æ‰€æœ‰éAPIè¯·æ±‚è¿”å›index.html\r\napp.get('*', (req, res) => {\r\n  // å¦‚æœæ˜¯APIè¯·æ±‚ä½†æ²¡æœ‰è¢«ä»£ç†å¤„ç†ï¼Œè¿”å›404\r\n  if (req.path.startsWith('/api/')) {\r\n    return res.status(404).json({ error: 'API endpoint not found' });\r\n  }\r\n\r\n  // å…¶ä»–æ‰€æœ‰è¯·æ±‚è¿”å›index.htmlï¼ˆSPAè·¯ç”±ï¼‰\r\n  res.sendFile(path.join(__dirname, 'index.html'));\r\n});\r\n\r\n// å…¨å±€é”™è¯¯å¤„ç†\r\nprocess.on('uncaughtException', (error) => {\r\n  console.error('âŒ æœªæ•è·çš„å¼‚å¸¸:', error.message);\r\n  console.error('è¯·æ£€æŸ¥ComfyUIæœåŠ¡å™¨è¿æ¥:', COMFYUI_BASE_URL);\r\n  // ä¸é€€å‡ºè¿›ç¨‹ï¼Œç»§ç»­è¿è¡Œ\r\n});\r\n\r\nprocess.on('unhandledRejection', (reason, promise) => {\r\n  console.error('âŒ æœªå¤„ç†çš„Promiseæ‹’ç»:', reason);\r\n  console.error('è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒComfyUIæœåŠ¡å™¨çŠ¶æ€');\r\n  // ä¸é€€å‡ºè¿›ç¨‹ï¼Œç»§ç»­è¿è¡Œ\r\n});\r\n\r\n// å¯åŠ¨æœåŠ¡å™¨\r\nconst server = app.listen(PORT, () => {\r\n  console.log(`âœ… ImagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!`);\r\n  console.log(`ğŸŒ è®¿é—®åœ°å€: http://localhost:${PORT}`);\r\n  console.log(`ğŸ“¡ APIä»£ç†: http://localhost:${PORT}/api/*`);\r\n  console.log(`ğŸ¯ ç›®æ ‡æœåŠ¡å™¨: ${COMFYUI_BASE_URL}`);\r\n  console.log(`ğŸ”§ å¥åº·æ£€æŸ¥: http://localhost:${PORT}/health`);\r\n  console.log('');\r\n  console.log('ğŸ‰ ç°åœ¨å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è®¿é—®Imagicåº”ç”¨äº†ï¼');\r\n});\r\n\r\n// å¤„ç†æœåŠ¡å™¨é”™è¯¯\r\nserver.on('error', (error) => {\r\n  if (error.code === 'EADDRINUSE') {\r\n    console.error(`âŒ ç«¯å£ ${PORT} å·²è¢«å ç”¨`);\r\n    console.error('è¯·å°è¯•ä»¥ä¸‹è§£å†³æ–¹æ¡ˆ:');\r\n    console.error('1. å…³é—­å ç”¨è¯¥ç«¯å£çš„ç¨‹åº');\r\n    console.error('2. ä½¿ç”¨å…¶ä»–ç«¯å£: PORT=3009 node proxy-server-simple.js');\r\n    console.error('3. æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–Imagicå®ä¾‹åœ¨è¿è¡Œ');\r\n  } else {\r\n    console.error('âŒ æœåŠ¡å™¨å¯åŠ¨é”™è¯¯:', error.message);\r\n  }\r\n  process.exit(1);\r\n});\r\n\r\n// ä¼˜é›…å…³é—­\r\nconst gracefulShutdown = () => {\r\n  console.log('\\nğŸ›‘ æ­£åœ¨å…³é—­æœåŠ¡å™¨...');\r\n  server.close(() => {\r\n    console.log('âœ… æœåŠ¡å™¨å·²å®‰å…¨å…³é—­');\r\n    process.exit(0);\r\n  });\r\n\r\n  // å¼ºåˆ¶å…³é—­è¶…æ—¶\r\n  setTimeout(() => {\r\n    console.log('âš ï¸ å¼ºåˆ¶å…³é—­æœåŠ¡å™¨');\r\n    process.exit(1);\r\n  }, 5000);\r\n};\r\n\r\nprocess.on('SIGINT', gracefulShutdown);\r\nprocess.on('SIGTERM', gracefulShutdown);\r\n\r\n// Windowsä¸‹çš„å…³é—­ä¿¡å·\r\nif (process.platform === 'win32') {\r\n  const readline = require('readline');\r\n  const rl = readline.createInterface({\r\n    input: process.stdin,\r\n    output: process.stdout\r\n  });\r\n\r\n  rl.on('SIGINT', gracefulShutdown);\r\n}\r\n"
        }
    ]
}