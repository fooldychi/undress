{
    "sourceFile": "client/deploy/imagic_production/proxy-server.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 7,
            "patches": [
                {
                    "date": 1752328206209,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752328900490,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -20,10 +20,10 @@\n \r\n // 配置multer处理文件上传\r\n const upload = multer({ storage: multer.memoryStorage() });\r\n \r\n-// ComfyUI服务器地址 - 从环境变量获取\r\n-const COMFYUI_BASE_URL = process.env.COMFYUI_SERVER_URL || 'https://your-comfyui-server.com';\r\n+// ComfyUI服务器地址\r\n+const COMFYUI_BASE_URL = 'https://dzqgp58z0s-8188.cnb.run';\r\n \r\n console.log('🚀 启动ComfyUI代理服务器...');\r\n \r\n // 健康检查\r\n"
                },
                {
                    "date": 1752556295776,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -103,9 +103,9 @@\n   try {\r\n     console.log('📡 处理prompt提交请求...');\r\n     console.log('📋 请求体大小:', JSON.stringify(req.body).length, 'bytes');\r\n \r\n-    const response = await fetch(`${COMFYUI_BASE_URL}/prompt`, {\r\n+    const response = await fetch(`${COMFYUI_BASE_URL}/api/prompt`, {\r\n       method: 'POST',\r\n       headers: {\r\n         'Content-Type': 'application/json',\r\n         'Accept': 'application/json'\r\n"
                },
                {
                    "date": 1752556332546,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -58,9 +58,9 @@\n \r\n     console.log(`🌐 转发到: ${COMFYUI_BASE_URL}/upload/image`);\r\n \r\n     // 发送到ComfyUI服务器\r\n-    const response = await fetch(`${COMFYUI_BASE_URL}/upload/image`, {\r\n+    const response = await fetch(`${COMFYUI_BASE_URL}/api/upload/image`, {\r\n       method: 'POST',\r\n       body: formData,\r\n       headers: formData.getHeaders(),\r\n       timeout: 30000, // 30秒超时\r\n"
                },
                {
                    "date": 1752556349373,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -152,9 +152,9 @@\n   changeOrigin: true,\r\n   timeout: 30000,\r\n   proxyTimeout: 30000,\r\n   pathRewrite: {\r\n-    '^/api': '',\r\n+    '^/api': '/api',\r\n   },\r\n   onProxyReq: (proxyReq, req, res) => {\r\n     console.log(`📡 代理请求: ${req.method} ${req.url} -> ${COMFYUI_BASE_URL}${req.url.replace('/api', '')}`);\r\n     proxyReq.setTimeout(30000);\r\n"
                },
                {
                    "date": 1752556367075,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -155,9 +155,9 @@\n   pathRewrite: {\r\n     '^/api': '/api',\r\n   },\r\n   onProxyReq: (proxyReq, req, res) => {\r\n-    console.log(`📡 代理请求: ${req.method} ${req.url} -> ${COMFYUI_BASE_URL}${req.url.replace('/api', '')}`);\r\n+    console.log(`📡 代理请求: ${req.method} ${req.url} -> ${COMFYUI_BASE_URL}${req.url}`);\r\n     proxyReq.setTimeout(30000);\r\n   },\r\n   onProxyRes: (proxyRes, req, res) => {\r\n     console.log(`📥 代理响应: ${proxyRes.statusCode} ${req.url}`);\r\n"
                },
                {
                    "date": 1752556893504,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -106,14 +106,12 @@\n \r\n     const response = await fetch(`${COMFYUI_BASE_URL}/api/prompt`, {\r\n       method: 'POST',\r\n       headers: {\r\n-        'Content-Type': 'application/json',\r\n-        'Accept': 'application/json'\r\n+        'Content-Type': 'application/json'\r\n       },\r\n       body: JSON.stringify(req.body),\r\n-      timeout: 30000, // 30秒超时\r\n-      agent: false // 禁用keep-alive\r\n+      timeout: 30000 // 30秒超时\r\n     });\r\n \r\n     console.log(`📥 ComfyUI响应: ${response.status} ${response.statusText}`);\r\n \r\n"
                },
                {
                    "date": 1752557329713,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -62,10 +62,9 @@\n     const response = await fetch(`${COMFYUI_BASE_URL}/api/upload/image`, {\r\n       method: 'POST',\r\n       body: formData,\r\n       headers: formData.getHeaders(),\r\n-      timeout: 30000, // 30秒超时\r\n-      agent: false // 禁用keep-alive\r\n+      timeout: 30000 // 30秒超时\r\n     });\r\n \r\n     console.log(`📥 ComfyUI响应: ${response.status} ${response.statusText}`);\r\n \r\n"
                }
            ],
            "date": 1752328206209,
            "name": "Commit-0",
            "content": "// 简单的代理服务器，解决ComfyUI CORS问题\r\nimport express from 'express';\r\nimport { createProxyMiddleware } from 'http-proxy-middleware';\r\nimport cors from 'cors';\r\nimport multer from 'multer';\r\nimport FormData from 'form-data';\r\nimport fetch from 'node-fetch';\r\n\r\nconst app = express();\r\nconst PORT = 3008;\r\n\r\n// 启用CORS\r\napp.use(cors({\r\n  origin: ['http://localhost:3001', 'http://localhost:3002', 'http://localhost:3000'],\r\n  credentials: true\r\n}));\r\n\r\n// 解析JSON\r\napp.use(express.json());\r\n\r\n// 配置multer处理文件上传\r\nconst upload = multer({ storage: multer.memoryStorage() });\r\n\r\n// ComfyUI服务器地址 - 从环境变量获取\r\nconst COMFYUI_BASE_URL = process.env.COMFYUI_SERVER_URL || 'https://your-comfyui-server.com';\r\n\r\nconsole.log('🚀 启动ComfyUI代理服务器...');\r\n\r\n// 健康检查\r\napp.get('/health', (req, res) => {\r\n  res.json({ status: 'ok', message: 'ComfyUI代理服务器运行正常' });\r\n});\r\n\r\n\r\n\r\n// 特殊处理文件上传\r\napp.post('/api/upload/image', upload.single('image'), async (req, res) => {\r\n  try {\r\n    console.log('📤 处理文件上传请求...');\r\n\r\n    if (!req.file) {\r\n      return res.status(400).json({ error: '没有上传文件' });\r\n    }\r\n\r\n    console.log(`📁 文件信息: ${req.file.originalname}, ${req.file.size} bytes, ${req.file.mimetype}`);\r\n\r\n    // 创建FormData发送到ComfyUI\r\n    const formData = new FormData();\r\n    formData.append('image', req.file.buffer, {\r\n      filename: req.file.originalname,\r\n      contentType: req.file.mimetype\r\n    });\r\n\r\n    // 添加其他参数\r\n    if (req.body.type) formData.append('type', req.body.type);\r\n    if (req.body.subfolder !== undefined) formData.append('subfolder', req.body.subfolder);\r\n    if (req.body.overwrite !== undefined) formData.append('overwrite', req.body.overwrite);\r\n\r\n    console.log(`🌐 转发到: ${COMFYUI_BASE_URL}/upload/image`);\r\n\r\n    // 发送到ComfyUI服务器\r\n    const response = await fetch(`${COMFYUI_BASE_URL}/upload/image`, {\r\n      method: 'POST',\r\n      body: formData,\r\n      headers: formData.getHeaders(),\r\n      timeout: 30000, // 30秒超时\r\n      agent: false // 禁用keep-alive\r\n    });\r\n\r\n    console.log(`📥 ComfyUI响应: ${response.status} ${response.statusText}`);\r\n\r\n    const responseText = await response.text();\r\n\r\n    if (response.ok) {\r\n      try {\r\n        const result = JSON.parse(responseText);\r\n        console.log('✅ 上传成功:', result);\r\n        res.json(result);\r\n      } catch (e) {\r\n        console.log('⚠️ 响应不是JSON格式:', responseText);\r\n        res.json({ success: true, response: responseText });\r\n      }\r\n    } else {\r\n      console.error('❌ ComfyUI上传失败:', responseText);\r\n      res.status(response.status).json({\r\n        error: 'ComfyUI上传失败',\r\n        status: response.status,\r\n        details: responseText\r\n      });\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('❌ 代理上传错误:', error);\r\n    res.status(500).json({\r\n      error: '代理服务器错误',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n// 特殊处理prompt提交\r\napp.post('/api/prompt', async (req, res) => {\r\n  try {\r\n    console.log('📡 处理prompt提交请求...');\r\n    console.log('📋 请求体大小:', JSON.stringify(req.body).length, 'bytes');\r\n\r\n    const response = await fetch(`${COMFYUI_BASE_URL}/prompt`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Accept': 'application/json'\r\n      },\r\n      body: JSON.stringify(req.body),\r\n      timeout: 30000, // 30秒超时\r\n      agent: false // 禁用keep-alive\r\n    });\r\n\r\n    console.log(`📥 ComfyUI响应: ${response.status} ${response.statusText}`);\r\n\r\n    const responseText = await response.text();\r\n\r\n    if (response.ok) {\r\n      try {\r\n        const result = JSON.parse(responseText);\r\n        console.log('✅ prompt提交成功:', result);\r\n        res.json(result);\r\n      } catch (e) {\r\n        console.log('⚠️ 响应不是JSON格式:', responseText);\r\n        res.json({ success: true, response: responseText });\r\n      }\r\n    } else {\r\n      console.error('❌ ComfyUI prompt提交失败:', responseText);\r\n      res.status(response.status).json({\r\n        error: 'ComfyUI prompt提交失败',\r\n        status: response.status,\r\n        details: responseText\r\n      });\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('❌ 代理prompt错误:', error);\r\n    res.status(500).json({\r\n      error: '代理服务器错误',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n// 代理其他请求（除了特殊处理的upload和prompt）\r\napp.use('/api', createProxyMiddleware({\r\n  target: COMFYUI_BASE_URL,\r\n  changeOrigin: true,\r\n  timeout: 30000,\r\n  proxyTimeout: 30000,\r\n  pathRewrite: {\r\n    '^/api': '',\r\n  },\r\n  onProxyReq: (proxyReq, req, res) => {\r\n    console.log(`📡 代理请求: ${req.method} ${req.url} -> ${COMFYUI_BASE_URL}${req.url.replace('/api', '')}`);\r\n    proxyReq.setTimeout(30000);\r\n  },\r\n  onProxyRes: (proxyRes, req, res) => {\r\n    console.log(`📥 代理响应: ${proxyRes.statusCode} ${req.url}`);\r\n  },\r\n  onError: (err, req, res) => {\r\n    console.error('❌ 代理错误:', err.message);\r\n    if (!res.headersSent) {\r\n      res.status(500).json({ error: '代理请求失败', details: err.message });\r\n    }\r\n  }\r\n}));\r\n\r\n// 启动服务器\r\nconst server = app.listen(PORT, () => {\r\n  console.log(`✅ ComfyUI代理服务器启动成功!`);\r\n  console.log(`📡 代理地址: http://localhost:${PORT}`);\r\n  console.log(`🎯 目标服务器: ${COMFYUI_BASE_URL}`);\r\n  console.log(`🔧 健康检查: http://localhost:${PORT}/health`);\r\n  console.log('');\r\n  console.log('📋 使用方法:');\r\n  console.log(`   原始: ${COMFYUI_BASE_URL}/system_stats`);\r\n  console.log(`   代理: http://localhost:${PORT}/api/system_stats`);\r\n  console.log('');\r\n  console.log('🔄 现在可以在前端使用代理地址避免CORS问题');\r\n});\r\n\r\n// 处理服务器错误\r\nserver.on('error', (error) => {\r\n  if (error.code === 'EADDRINUSE') {\r\n    console.error(`❌ 端口 ${PORT} 已被占用，请尝试其他端口或关闭占用该端口的程序`);\r\n  } else {\r\n    console.error('❌ 服务器启动错误:', error.message);\r\n  }\r\n  process.exit(1);\r\n});\r\n\r\n// 全局错误处理\r\nprocess.on('uncaughtException', (error) => {\r\n  console.error('❌ 未捕获的异常:', error.message);\r\n  console.error('堆栈信息:', error.stack);\r\n  process.exit(1);\r\n});\r\n\r\nprocess.on('unhandledRejection', (reason, promise) => {\r\n  console.error('❌ 未处理的Promise拒绝:', reason);\r\n  console.error('Promise:', promise);\r\n  process.exit(1);\r\n});\r\n\r\n// 优雅关闭\r\nprocess.on('SIGINT', () => {\r\n  console.log('\\n🛑 正在关闭代理服务器...');\r\n  server.close(() => {\r\n    console.log('✅ 服务器已关闭');\r\n    process.exit(0);\r\n  });\r\n});\r\n\r\nprocess.on('SIGTERM', () => {\r\n  console.log('\\n🛑 正在关闭代理服务器...');\r\n  server.close(() => {\r\n    console.log('✅ 服务器已关闭');\r\n    process.exit(0);\r\n  });\r\n});\r\n\r\n\r\n"
        }
    ]
}