{
    "sourceFile": "client/deploy/imagic_production/proxy-server.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 7,
            "patches": [
                {
                    "date": 1752328206209,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752328900490,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -20,10 +20,10 @@\n \r\n // é…ç½®multerå¤„ç†æ–‡ä»¶ä¸Šä¼ \r\n const upload = multer({ storage: multer.memoryStorage() });\r\n \r\n-// ComfyUIæœåŠ¡å™¨åœ°å€ - ä»ç¯å¢ƒå˜é‡è·å–\r\n-const COMFYUI_BASE_URL = process.env.COMFYUI_SERVER_URL || 'https://your-comfyui-server.com';\r\n+// ComfyUIæœåŠ¡å™¨åœ°å€\r\n+const COMFYUI_BASE_URL = 'https://dzqgp58z0s-8188.cnb.run';\r\n \r\n console.log('ğŸš€ å¯åŠ¨ComfyUIä»£ç†æœåŠ¡å™¨...');\r\n \r\n // å¥åº·æ£€æŸ¥\r\n"
                },
                {
                    "date": 1752556295776,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -103,9 +103,9 @@\n   try {\r\n     console.log('ğŸ“¡ å¤„ç†promptæäº¤è¯·æ±‚...');\r\n     console.log('ğŸ“‹ è¯·æ±‚ä½“å¤§å°:', JSON.stringify(req.body).length, 'bytes');\r\n \r\n-    const response = await fetch(`${COMFYUI_BASE_URL}/prompt`, {\r\n+    const response = await fetch(`${COMFYUI_BASE_URL}/api/prompt`, {\r\n       method: 'POST',\r\n       headers: {\r\n         'Content-Type': 'application/json',\r\n         'Accept': 'application/json'\r\n"
                },
                {
                    "date": 1752556332546,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -58,9 +58,9 @@\n \r\n     console.log(`ğŸŒ è½¬å‘åˆ°: ${COMFYUI_BASE_URL}/upload/image`);\r\n \r\n     // å‘é€åˆ°ComfyUIæœåŠ¡å™¨\r\n-    const response = await fetch(`${COMFYUI_BASE_URL}/upload/image`, {\r\n+    const response = await fetch(`${COMFYUI_BASE_URL}/api/upload/image`, {\r\n       method: 'POST',\r\n       body: formData,\r\n       headers: formData.getHeaders(),\r\n       timeout: 30000, // 30ç§’è¶…æ—¶\r\n"
                },
                {
                    "date": 1752556349373,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -152,9 +152,9 @@\n   changeOrigin: true,\r\n   timeout: 30000,\r\n   proxyTimeout: 30000,\r\n   pathRewrite: {\r\n-    '^/api': '',\r\n+    '^/api': '/api',\r\n   },\r\n   onProxyReq: (proxyReq, req, res) => {\r\n     console.log(`ğŸ“¡ ä»£ç†è¯·æ±‚: ${req.method} ${req.url} -> ${COMFYUI_BASE_URL}${req.url.replace('/api', '')}`);\r\n     proxyReq.setTimeout(30000);\r\n"
                },
                {
                    "date": 1752556367075,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -155,9 +155,9 @@\n   pathRewrite: {\r\n     '^/api': '/api',\r\n   },\r\n   onProxyReq: (proxyReq, req, res) => {\r\n-    console.log(`ğŸ“¡ ä»£ç†è¯·æ±‚: ${req.method} ${req.url} -> ${COMFYUI_BASE_URL}${req.url.replace('/api', '')}`);\r\n+    console.log(`ğŸ“¡ ä»£ç†è¯·æ±‚: ${req.method} ${req.url} -> ${COMFYUI_BASE_URL}${req.url}`);\r\n     proxyReq.setTimeout(30000);\r\n   },\r\n   onProxyRes: (proxyRes, req, res) => {\r\n     console.log(`ğŸ“¥ ä»£ç†å“åº”: ${proxyRes.statusCode} ${req.url}`);\r\n"
                },
                {
                    "date": 1752556893504,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -106,14 +106,12 @@\n \r\n     const response = await fetch(`${COMFYUI_BASE_URL}/api/prompt`, {\r\n       method: 'POST',\r\n       headers: {\r\n-        'Content-Type': 'application/json',\r\n-        'Accept': 'application/json'\r\n+        'Content-Type': 'application/json'\r\n       },\r\n       body: JSON.stringify(req.body),\r\n-      timeout: 30000, // 30ç§’è¶…æ—¶\r\n-      agent: false // ç¦ç”¨keep-alive\r\n+      timeout: 30000 // 30ç§’è¶…æ—¶\r\n     });\r\n \r\n     console.log(`ğŸ“¥ ComfyUIå“åº”: ${response.status} ${response.statusText}`);\r\n \r\n"
                },
                {
                    "date": 1752557329713,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -62,10 +62,9 @@\n     const response = await fetch(`${COMFYUI_BASE_URL}/api/upload/image`, {\r\n       method: 'POST',\r\n       body: formData,\r\n       headers: formData.getHeaders(),\r\n-      timeout: 30000, // 30ç§’è¶…æ—¶\r\n-      agent: false // ç¦ç”¨keep-alive\r\n+      timeout: 30000 // 30ç§’è¶…æ—¶\r\n     });\r\n \r\n     console.log(`ğŸ“¥ ComfyUIå“åº”: ${response.status} ${response.statusText}`);\r\n \r\n"
                }
            ],
            "date": 1752328206209,
            "name": "Commit-0",
            "content": "// ç®€å•çš„ä»£ç†æœåŠ¡å™¨ï¼Œè§£å†³ComfyUI CORSé—®é¢˜\r\nimport express from 'express';\r\nimport { createProxyMiddleware } from 'http-proxy-middleware';\r\nimport cors from 'cors';\r\nimport multer from 'multer';\r\nimport FormData from 'form-data';\r\nimport fetch from 'node-fetch';\r\n\r\nconst app = express();\r\nconst PORT = 3008;\r\n\r\n// å¯ç”¨CORS\r\napp.use(cors({\r\n  origin: ['http://localhost:3001', 'http://localhost:3002', 'http://localhost:3000'],\r\n  credentials: true\r\n}));\r\n\r\n// è§£æJSON\r\napp.use(express.json());\r\n\r\n// é…ç½®multerå¤„ç†æ–‡ä»¶ä¸Šä¼ \r\nconst upload = multer({ storage: multer.memoryStorage() });\r\n\r\n// ComfyUIæœåŠ¡å™¨åœ°å€ - ä»ç¯å¢ƒå˜é‡è·å–\r\nconst COMFYUI_BASE_URL = process.env.COMFYUI_SERVER_URL || 'https://your-comfyui-server.com';\r\n\r\nconsole.log('ğŸš€ å¯åŠ¨ComfyUIä»£ç†æœåŠ¡å™¨...');\r\n\r\n// å¥åº·æ£€æŸ¥\r\napp.get('/health', (req, res) => {\r\n  res.json({ status: 'ok', message: 'ComfyUIä»£ç†æœåŠ¡å™¨è¿è¡Œæ­£å¸¸' });\r\n});\r\n\r\n\r\n\r\n// ç‰¹æ®Šå¤„ç†æ–‡ä»¶ä¸Šä¼ \r\napp.post('/api/upload/image', upload.single('image'), async (req, res) => {\r\n  try {\r\n    console.log('ğŸ“¤ å¤„ç†æ–‡ä»¶ä¸Šä¼ è¯·æ±‚...');\r\n\r\n    if (!req.file) {\r\n      return res.status(400).json({ error: 'æ²¡æœ‰ä¸Šä¼ æ–‡ä»¶' });\r\n    }\r\n\r\n    console.log(`ğŸ“ æ–‡ä»¶ä¿¡æ¯: ${req.file.originalname}, ${req.file.size} bytes, ${req.file.mimetype}`);\r\n\r\n    // åˆ›å»ºFormDataå‘é€åˆ°ComfyUI\r\n    const formData = new FormData();\r\n    formData.append('image', req.file.buffer, {\r\n      filename: req.file.originalname,\r\n      contentType: req.file.mimetype\r\n    });\r\n\r\n    // æ·»åŠ å…¶ä»–å‚æ•°\r\n    if (req.body.type) formData.append('type', req.body.type);\r\n    if (req.body.subfolder !== undefined) formData.append('subfolder', req.body.subfolder);\r\n    if (req.body.overwrite !== undefined) formData.append('overwrite', req.body.overwrite);\r\n\r\n    console.log(`ğŸŒ è½¬å‘åˆ°: ${COMFYUI_BASE_URL}/upload/image`);\r\n\r\n    // å‘é€åˆ°ComfyUIæœåŠ¡å™¨\r\n    const response = await fetch(`${COMFYUI_BASE_URL}/upload/image`, {\r\n      method: 'POST',\r\n      body: formData,\r\n      headers: formData.getHeaders(),\r\n      timeout: 30000, // 30ç§’è¶…æ—¶\r\n      agent: false // ç¦ç”¨keep-alive\r\n    });\r\n\r\n    console.log(`ğŸ“¥ ComfyUIå“åº”: ${response.status} ${response.statusText}`);\r\n\r\n    const responseText = await response.text();\r\n\r\n    if (response.ok) {\r\n      try {\r\n        const result = JSON.parse(responseText);\r\n        console.log('âœ… ä¸Šä¼ æˆåŠŸ:', result);\r\n        res.json(result);\r\n      } catch (e) {\r\n        console.log('âš ï¸ å“åº”ä¸æ˜¯JSONæ ¼å¼:', responseText);\r\n        res.json({ success: true, response: responseText });\r\n      }\r\n    } else {\r\n      console.error('âŒ ComfyUIä¸Šä¼ å¤±è´¥:', responseText);\r\n      res.status(response.status).json({\r\n        error: 'ComfyUIä¸Šä¼ å¤±è´¥',\r\n        status: response.status,\r\n        details: responseText\r\n      });\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('âŒ ä»£ç†ä¸Šä¼ é”™è¯¯:', error);\r\n    res.status(500).json({\r\n      error: 'ä»£ç†æœåŠ¡å™¨é”™è¯¯',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n// ç‰¹æ®Šå¤„ç†promptæäº¤\r\napp.post('/api/prompt', async (req, res) => {\r\n  try {\r\n    console.log('ğŸ“¡ å¤„ç†promptæäº¤è¯·æ±‚...');\r\n    console.log('ğŸ“‹ è¯·æ±‚ä½“å¤§å°:', JSON.stringify(req.body).length, 'bytes');\r\n\r\n    const response = await fetch(`${COMFYUI_BASE_URL}/prompt`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Accept': 'application/json'\r\n      },\r\n      body: JSON.stringify(req.body),\r\n      timeout: 30000, // 30ç§’è¶…æ—¶\r\n      agent: false // ç¦ç”¨keep-alive\r\n    });\r\n\r\n    console.log(`ğŸ“¥ ComfyUIå“åº”: ${response.status} ${response.statusText}`);\r\n\r\n    const responseText = await response.text();\r\n\r\n    if (response.ok) {\r\n      try {\r\n        const result = JSON.parse(responseText);\r\n        console.log('âœ… promptæäº¤æˆåŠŸ:', result);\r\n        res.json(result);\r\n      } catch (e) {\r\n        console.log('âš ï¸ å“åº”ä¸æ˜¯JSONæ ¼å¼:', responseText);\r\n        res.json({ success: true, response: responseText });\r\n      }\r\n    } else {\r\n      console.error('âŒ ComfyUI promptæäº¤å¤±è´¥:', responseText);\r\n      res.status(response.status).json({\r\n        error: 'ComfyUI promptæäº¤å¤±è´¥',\r\n        status: response.status,\r\n        details: responseText\r\n      });\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('âŒ ä»£ç†prompté”™è¯¯:', error);\r\n    res.status(500).json({\r\n      error: 'ä»£ç†æœåŠ¡å™¨é”™è¯¯',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n// ä»£ç†å…¶ä»–è¯·æ±‚ï¼ˆé™¤äº†ç‰¹æ®Šå¤„ç†çš„uploadå’Œpromptï¼‰\r\napp.use('/api', createProxyMiddleware({\r\n  target: COMFYUI_BASE_URL,\r\n  changeOrigin: true,\r\n  timeout: 30000,\r\n  proxyTimeout: 30000,\r\n  pathRewrite: {\r\n    '^/api': '',\r\n  },\r\n  onProxyReq: (proxyReq, req, res) => {\r\n    console.log(`ğŸ“¡ ä»£ç†è¯·æ±‚: ${req.method} ${req.url} -> ${COMFYUI_BASE_URL}${req.url.replace('/api', '')}`);\r\n    proxyReq.setTimeout(30000);\r\n  },\r\n  onProxyRes: (proxyRes, req, res) => {\r\n    console.log(`ğŸ“¥ ä»£ç†å“åº”: ${proxyRes.statusCode} ${req.url}`);\r\n  },\r\n  onError: (err, req, res) => {\r\n    console.error('âŒ ä»£ç†é”™è¯¯:', err.message);\r\n    if (!res.headersSent) {\r\n      res.status(500).json({ error: 'ä»£ç†è¯·æ±‚å¤±è´¥', details: err.message });\r\n    }\r\n  }\r\n}));\r\n\r\n// å¯åŠ¨æœåŠ¡å™¨\r\nconst server = app.listen(PORT, () => {\r\n  console.log(`âœ… ComfyUIä»£ç†æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!`);\r\n  console.log(`ğŸ“¡ ä»£ç†åœ°å€: http://localhost:${PORT}`);\r\n  console.log(`ğŸ¯ ç›®æ ‡æœåŠ¡å™¨: ${COMFYUI_BASE_URL}`);\r\n  console.log(`ğŸ”§ å¥åº·æ£€æŸ¥: http://localhost:${PORT}/health`);\r\n  console.log('');\r\n  console.log('ğŸ“‹ ä½¿ç”¨æ–¹æ³•:');\r\n  console.log(`   åŸå§‹: ${COMFYUI_BASE_URL}/system_stats`);\r\n  console.log(`   ä»£ç†: http://localhost:${PORT}/api/system_stats`);\r\n  console.log('');\r\n  console.log('ğŸ”„ ç°åœ¨å¯ä»¥åœ¨å‰ç«¯ä½¿ç”¨ä»£ç†åœ°å€é¿å…CORSé—®é¢˜');\r\n});\r\n\r\n// å¤„ç†æœåŠ¡å™¨é”™è¯¯\r\nserver.on('error', (error) => {\r\n  if (error.code === 'EADDRINUSE') {\r\n    console.error(`âŒ ç«¯å£ ${PORT} å·²è¢«å ç”¨ï¼Œè¯·å°è¯•å…¶ä»–ç«¯å£æˆ–å…³é—­å ç”¨è¯¥ç«¯å£çš„ç¨‹åº`);\r\n  } else {\r\n    console.error('âŒ æœåŠ¡å™¨å¯åŠ¨é”™è¯¯:', error.message);\r\n  }\r\n  process.exit(1);\r\n});\r\n\r\n// å…¨å±€é”™è¯¯å¤„ç†\r\nprocess.on('uncaughtException', (error) => {\r\n  console.error('âŒ æœªæ•è·çš„å¼‚å¸¸:', error.message);\r\n  console.error('å †æ ˆä¿¡æ¯:', error.stack);\r\n  process.exit(1);\r\n});\r\n\r\nprocess.on('unhandledRejection', (reason, promise) => {\r\n  console.error('âŒ æœªå¤„ç†çš„Promiseæ‹’ç»:', reason);\r\n  console.error('Promise:', promise);\r\n  process.exit(1);\r\n});\r\n\r\n// ä¼˜é›…å…³é—­\r\nprocess.on('SIGINT', () => {\r\n  console.log('\\nğŸ›‘ æ­£åœ¨å…³é—­ä»£ç†æœåŠ¡å™¨...');\r\n  server.close(() => {\r\n    console.log('âœ… æœåŠ¡å™¨å·²å…³é—­');\r\n    process.exit(0);\r\n  });\r\n});\r\n\r\nprocess.on('SIGTERM', () => {\r\n  console.log('\\nğŸ›‘ æ­£åœ¨å…³é—­ä»£ç†æœåŠ¡å™¨...');\r\n  server.close(() => {\r\n    console.log('âœ… æœåŠ¡å™¨å·²å…³é—­');\r\n    process.exit(0);\r\n  });\r\n});\r\n\r\n\r\n"
        }
    ]
}