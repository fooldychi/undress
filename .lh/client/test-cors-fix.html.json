{
    "sourceFile": "client/test-cors-fix.html",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1752550658874,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1752550658874,
            "name": "Commit-0",
            "content": "<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>CORSé—®é¢˜ä¿®å¤æµ‹è¯•</title>\n    <style>\n        body {\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            max-width: 1000px;\n            margin: 0 auto;\n            padding: 20px;\n            background-color: #f5f5f5;\n        }\n        .container {\n            background: white;\n            border-radius: 8px;\n            padding: 20px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            margin-bottom: 20px;\n        }\n        h1 {\n            color: #333;\n            text-align: center;\n        }\n        .test-section {\n            margin-bottom: 20px;\n            padding: 15px;\n            border: 1px solid #ddd;\n            border-radius: 5px;\n        }\n        button {\n            background: #3498db;\n            color: white;\n            border: none;\n            padding: 8px 16px;\n            border-radius: 4px;\n            cursor: pointer;\n            margin: 5px;\n        }\n        button:hover {\n            background: #2980b9;\n        }\n        .log-area {\n            background: #2c3e50;\n            color: #ecf0f1;\n            padding: 15px;\n            border-radius: 5px;\n            font-family: 'Courier New', monospace;\n            font-size: 12px;\n            height: 300px;\n            overflow-y: auto;\n            white-space: pre-wrap;\n        }\n        .server-input {\n            width: 100%;\n            padding: 8px;\n            border: 1px solid #ddd;\n            border-radius: 4px;\n            margin: 5px 0;\n        }\n        .status {\n            padding: 10px;\n            border-radius: 5px;\n            margin: 10px 0;\n        }\n        .status.success {\n            background: #d4edda;\n            color: #155724;\n        }\n        .status.error {\n            background: #f8d7da;\n            color: #721c24;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h1>ğŸ”§ CORSé—®é¢˜ä¿®å¤æµ‹è¯•</h1>\n\n        <div class=\"test-section\">\n            <h3>ğŸ“‹ æœåŠ¡å™¨æµ‹è¯•</h3>\n            <input type=\"text\" id=\"serverUrl\" class=\"server-input\"\n                   value=\"https://7r56is2wtd-8188.cnb.run\"\n                   placeholder=\"è¾“å…¥ComfyUIæœåŠ¡å™¨åœ°å€\">\n            <br>\n            <button onclick=\"testStandardRequest()\">æ ‡å‡†è¯·æ±‚æµ‹è¯•</button>\n            <button onclick=\"testSimpleRequest()\">ç®€åŒ–è¯·æ±‚æµ‹è¯•</button>\n            <button onclick=\"testLoadBalancer()\">è´Ÿè½½å‡è¡¡å™¨æµ‹è¯•</button>\n            <button onclick=\"clearLog()\">æ¸…ç©ºæ—¥å¿—</button>\n        </div>\n\n        <div class=\"test-section\">\n            <h3>ğŸ“ æµ‹è¯•æ—¥å¿—</h3>\n            <div id=\"logArea\" class=\"log-area\">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>\n        </div>\n    </div>\n\n    <script type=\"module\">\n        // æ—¥å¿—å‡½æ•°\n        function log(message) {\n            const logArea = document.getElementById('logArea');\n            const timestamp = new Date().toLocaleTimeString();\n            logArea.textContent += `[${timestamp}] ${message}\\n`;\n            logArea.scrollTop = logArea.scrollHeight;\n        }\n\n        // æ¸…ç©ºæ—¥å¿—\n        window.clearLog = function() {\n            document.getElementById('logArea').textContent = '';\n        }\n\n        // æ ‡å‡†è¯·æ±‚æµ‹è¯•\n        window.testStandardRequest = async function() {\n            const serverUrl = document.getElementById('serverUrl').value.trim();\n            if (!serverUrl) {\n                log('âŒ è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€');\n                return;\n            }\n\n            log('ğŸ§ª å¼€å§‹æ ‡å‡†è¯·æ±‚æµ‹è¯•...');\n\n            const endpoints = ['/api/queue', '/api/system_stats'];\n\n            for (const endpoint of endpoints) {\n                const fullUrl = `${serverUrl.replace(/\\/$/, '')}${endpoint}`;\n                log(`ğŸ” æµ‹è¯•ç«¯ç‚¹: ${endpoint}`);\n\n                try {\n                    const controller = new AbortController();\n                    const timeoutId = setTimeout(() => controller.abort(), 10000);\n\n                    const response = await fetch(fullUrl, {\n                        method: 'GET',\n                        signal: controller.signal,\n                        headers: {\n                            'Accept': 'application/json'\n                        },\n                        mode: 'cors',\n                        credentials: 'omit',\n                        cache: 'no-cache'\n                    });\n\n                    clearTimeout(timeoutId);\n\n                    if (response.ok) {\n                        const data = await response.json();\n                        log(`âœ… æ ‡å‡†è¯·æ±‚æˆåŠŸ: ${endpoint}`);\n                        log(`   çŠ¶æ€ç : ${response.status}`);\n                        log(`   æ•°æ®å­—æ®µ: ${Object.keys(data).join(', ')}`);\n\n                        // éªŒè¯å“åº”\n                        if (endpoint.includes('system_stats') && data.system) {\n                            log(`   âœ… ç³»ç»Ÿä¿¡æ¯éªŒè¯é€šè¿‡`);\n                        } else if (endpoint.includes('queue') && (data.queue_running !== undefined || data.queue_pending !== undefined)) {\n                            log(`   âœ… é˜Ÿåˆ—ä¿¡æ¯éªŒè¯é€šè¿‡`);\n                        }\n                    } else {\n                        log(`âŒ æ ‡å‡†è¯·æ±‚å¤±è´¥: ${endpoint} - çŠ¶æ€ç  ${response.status}`);\n                    }\n\n                } catch (error) {\n                    log(`âŒ æ ‡å‡†è¯·æ±‚é”™è¯¯: ${endpoint} - ${error.message}`);\n                }\n            }\n        }\n\n        // ç®€åŒ–è¯·æ±‚æµ‹è¯•\n        window.testSimpleRequest = async function() {\n            const serverUrl = document.getElementById('serverUrl').value.trim();\n            if (!serverUrl) {\n                log('âŒ è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€');\n                return;\n            }\n\n            log('ğŸ§ª å¼€å§‹ç®€åŒ–è¯·æ±‚æµ‹è¯•...');\n\n            const endpoints = ['/api/queue', '/api/system_stats'];\n\n            for (const endpoint of endpoints) {\n                const fullUrl = `${serverUrl.replace(/\\/$/, '')}${endpoint}`;\n                log(`ğŸ” ç®€åŒ–æµ‹è¯•ç«¯ç‚¹: ${endpoint}`);\n\n                try {\n                    const controller = new AbortController();\n                    const timeoutId = setTimeout(() => controller.abort(), 5000);\n\n                    await fetch(fullUrl, {\n                        method: 'GET',\n                        signal: controller.signal,\n                        mode: 'no-cors',\n                        cache: 'no-cache'\n                    });\n\n                    clearTimeout(timeoutId);\n                    log(`âœ… ç®€åŒ–è¯·æ±‚è¿æ¥æˆåŠŸ: ${endpoint}`);\n\n                } catch (error) {\n                    log(`âŒ ç®€åŒ–è¯·æ±‚å¤±è´¥: ${endpoint} - ${error.message}`);\n                }\n            }\n        }\n\n        // è´Ÿè½½å‡è¡¡å™¨æµ‹è¯•\n        window.testLoadBalancer = async function() {\n            log('ğŸ§ª å¼€å§‹è´Ÿè½½å‡è¡¡å™¨æµ‹è¯•...');\n\n            try {\n                // åŠ¨æ€å¯¼å…¥è´Ÿè½½å‡è¡¡å™¨\n                const { default: loadBalancer } = await import('./src/services/loadBalancer.js');\n\n                log('ğŸ“Š åˆå§‹åŒ–è´Ÿè½½å‡è¡¡å™¨...');\n                await loadBalancer.initialize();\n\n                log('ğŸ”„ åˆ·æ–°å¥åº·çŠ¶æ€...');\n                await loadBalancer.refreshHealthStatus();\n\n                log('ğŸ¯ è·å–æœ€ä¼˜æœåŠ¡å™¨...');\n                const optimalServer = await loadBalancer.getOptimalServer();\n                log(`âœ… æœ€ä¼˜æœåŠ¡å™¨: ${optimalServer}`);\n\n                // æ˜¾ç¤ºæœåŠ¡å™¨çŠ¶æ€\n                if (loadBalancer.serverList && loadBalancer.serverList.length > 0) {\n                    log('ğŸ“‹ æœåŠ¡å™¨çŠ¶æ€:');\n                    loadBalancer.serverList.forEach((server, index) => {\n                        const status = server.healthy === true ? 'âœ… å¥åº·' :\n                                      server.healthy === false ? 'âŒ å¼‚å¸¸' : 'â³ æœªçŸ¥';\n                        log(`   ${index + 1}. ${server.url}: ${status}`);\n                    });\n                }\n\n            } catch (error) {\n                log(`âŒ è´Ÿè½½å‡è¡¡å™¨æµ‹è¯•å¤±è´¥: ${error.message}`);\n            }\n        }\n\n        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–\n        window.addEventListener('load', () => {\n            log('ğŸš€ CORSä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½');\n            log('ğŸ“‹ å¯ä»¥å¼€å§‹æµ‹è¯•äº†');\n        });\n    </script>\n</body>\n</html>\n"
        }
    ]
}