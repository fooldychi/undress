{
    "sourceFile": "test-server.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1752409212658,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752409225529,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -182,9 +182,9 @@\n   console.log('  GET /api/config - å…¬å¼€é…ç½®');\n   console.log('  GET /api/admin/config - ç®¡ç†å‘˜é…ç½®');\n   console.log('');\n   console.log('ğŸ§ª æµ‹è¯•å‘½ä»¤:');\n-  console.log('  curl http://localhost:3007/api/admin/config');\n+  console.log(`  curl http://localhost:${PORT}/api/admin/config`);\n   console.log('  node test-config-api.js');\n });\n \n // é”™è¯¯å¤„ç†\n"
                }
            ],
            "date": 1752409212658,
            "name": "Commit-0",
            "content": "#!/usr/bin/env node\n\n/**\n * ç®€åŒ–çš„æµ‹è¯•æœåŠ¡å™¨ï¼Œç”¨äºéªŒè¯é…ç½®API\n */\n\nconst express = require('./server/node_modules/express');\nconst cors = require('./server/node_modules/cors');\nconst fs = require('fs');\nconst path = require('path');\n\n// è¯»å–.envæ–‡ä»¶\nfunction loadEnvFile() {\n  const envPath = path.join(__dirname, 'server', '.env');\n  if (fs.existsSync(envPath)) {\n    const envContent = fs.readFileSync(envPath, 'utf8');\n    envContent.split('\\n').forEach(line => {\n      const [key, value] = line.split('=');\n      if (key && value) {\n        process.env[key.trim()] = value.trim();\n      }\n    });\n  }\n}\n\nloadEnvFile();\n\nconst mysql = require('./server/node_modules/mysql2/promise');\n\nconst app = express();\nconst PORT = process.env.TEST_PORT || 3008;\n\n// ä¸­é—´ä»¶\napp.use(cors());\napp.use(express.json());\n\n// æ•°æ®åº“è¿æ¥é…ç½®\nconst dbConfig = {\n  host: process.env.DB_HOST,\n  port: process.env.DB_PORT || 3306,\n  user: process.env.DB_USER,\n  password: process.env.DB_PASSWORD,\n  database: process.env.DB_NAME\n};\n\n// æ•°æ®åº“æŸ¥è¯¢å‡½æ•°\nasync function query(sql, params = []) {\n  const connection = await mysql.createConnection(dbConfig);\n  try {\n    const [results] = await connection.execute(sql, params);\n    return results;\n  } finally {\n    await connection.end();\n  }\n}\n\n// æµ‹è¯•è·¯ç”±\napp.get('/', (req, res) => {\n  res.json({\n    success: true,\n    message: 'æµ‹è¯•æœåŠ¡å™¨è¿è¡Œæ­£å¸¸',\n    timestamp: new Date().toISOString()\n  });\n});\n\n// ç®¡ç†å‘˜é…ç½®API (ç®€åŒ–ç‰ˆï¼Œä¸éœ€è¦è®¤è¯)\napp.get('/api/admin/config', async (req, res) => {\n  try {\n    console.log('ğŸ“Š è·å–ç®¡ç†å‘˜é…ç½®...');\n\n    const configs = await query(`\n      SELECT config_key, config_value, config_type, config_group, description, is_encrypted\n      FROM system_config\n      ORDER BY config_group, config_key\n    `);\n\n    console.log(`ğŸ“‹ ä»æ•°æ®åº“è·å–äº† ${configs.length} é¡¹é…ç½®`);\n\n    // æŒ‰åˆ†ç»„ç»„ç»‡é…ç½®\n    const groupedConfigs = {};\n    configs.forEach(config => {\n      if (!groupedConfigs[config.config_group]) {\n        groupedConfigs[config.config_group] = [];\n      }\n      groupedConfigs[config.config_group].push(config);\n    });\n\n    // åŒæ—¶æä¾›æ‰å¹³åŒ–çš„é…ç½®æ•°æ®ï¼Œæ–¹ä¾¿å‰ç«¯ä½¿ç”¨\n    const flatConfigs = {};\n    configs.forEach(config => {\n      let value = config.config_value;\n\n      // æ ¹æ®ç±»å‹è½¬æ¢å€¼\n      if (config.config_type === 'number') {\n        value = parseInt(value) || 0;\n      } else if (config.config_type === 'boolean') {\n        value = value === 'true' || value === '1' || value === true;\n      }\n\n      flatConfigs[config.config_key] = value;\n    });\n\n    console.log('ğŸ“‹ è¿”å›çš„ComfyUIé…ç½®:');\n    Object.keys(flatConfigs).filter(key => key.startsWith('comfyui.')).forEach(key => {\n      console.log(`   ${key}: ${flatConfigs[key]}`);\n    });\n\n    res.json({\n      success: true,\n      data: flatConfigs,\n      grouped: groupedConfigs\n    });\n  } catch (error) {\n    console.error('âŒ è·å–é…ç½®å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'è·å–é…ç½®å¤±è´¥',\n      error: error.message\n    });\n  }\n});\n\n// å…¬å¼€é…ç½®API\napp.get('/api/config', async (req, res) => {\n  try {\n    console.log('ğŸ“Š è·å–å…¬å¼€é…ç½®...');\n\n    const configs = await query(`\n      SELECT config_key, config_value, config_type\n      FROM system_config\n      WHERE config_group IN ('comfyui', 'ai', 'frontend')\n      AND config_key NOT LIKE '%password%'\n      AND config_key NOT LIKE '%secret%'\n      ORDER BY config_group, config_key\n    `);\n\n    console.log(`ğŸ“‹ ä»æ•°æ®åº“è·å–äº† ${configs.length} é¡¹å…¬å¼€é…ç½®`);\n\n    // è½¬æ¢ä¸ºå‰ç«¯éœ€è¦çš„æ ¼å¼\n    const configMap = {};\n    configs.forEach(config => {\n      let value = config.config_value;\n\n      // æ ¹æ®ç±»å‹è½¬æ¢å€¼\n      if (config.config_type === 'number') {\n        value = parseInt(value);\n      } else if (config.config_type === 'boolean') {\n        value = value === 'true' || value === '1';\n      }\n\n      configMap[config.config_key] = value;\n    });\n\n    console.log('ğŸ“‹ è¿”å›çš„å…¬å¼€é…ç½®:');\n    Object.keys(configMap).forEach(key => {\n      console.log(`   ${key}: ${configMap[key]}`);\n    });\n\n    res.json({\n      success: true,\n      data: configMap\n    });\n  } catch (error) {\n    console.error('âŒ è·å–å…¬å¼€é…ç½®å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'è·å–å…¬å¼€é…ç½®å¤±è´¥',\n      error: error.message\n    });\n  }\n});\n\n// å¯åŠ¨æœåŠ¡å™¨\napp.listen(PORT, () => {\n  console.log('ğŸš€ æµ‹è¯•æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n  console.log(`ğŸ“ æœåŠ¡åœ°å€: http://localhost:${PORT}`);\n  console.log(`ğŸŒ ç¯å¢ƒ: ${process.env.NODE_ENV || 'development'}`);\n  console.log(`â° å¯åŠ¨æ—¶é—´: ${new Date().toLocaleString()}`);\n  console.log('');\n  console.log('ğŸ“‹ å¯ç”¨çš„APIç«¯ç‚¹:');\n  console.log('  GET / - æœåŠ¡å™¨çŠ¶æ€');\n  console.log('  GET /api/config - å…¬å¼€é…ç½®');\n  console.log('  GET /api/admin/config - ç®¡ç†å‘˜é…ç½®');\n  console.log('');\n  console.log('ğŸ§ª æµ‹è¯•å‘½ä»¤:');\n  console.log('  curl http://localhost:3007/api/admin/config');\n  console.log('  node test-config-api.js');\n});\n\n// é”™è¯¯å¤„ç†\nprocess.on('uncaughtException', (error) => {\n  console.error('âŒ æœªæ•è·çš„å¼‚å¸¸:', error);\n});\n\nprocess.on('unhandledRejection', (reason, promise) => {\n  console.error('âŒ æœªå¤„ç†çš„Promiseæ‹’ç»:', reason);\n});\n"
        }
    ]
}