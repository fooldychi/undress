{
    "sourceFile": "check-database-config.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1752409054826,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752409542902,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -152,9 +152,9 @@\n   try {\n     connection = await mysql.createConnection(dbConfig);\n \n     const comfyuiConfigs = [\n-      ['comfyui.server_url', 'https://your-comfyui-server.com', 'string', 'comfyui', 'ComfyUIä¸»æœåŠ¡å™¨åœ°å€'],\n+      ['comfyui.server_url', 'your-comfyui-server.com', 'string', 'comfyui', 'ComfyUIä¸»æœåŠ¡å™¨åœ°å€'],\n       ['comfyui.backup_servers', '', 'string', 'comfyui', 'ComfyUIå¤‡ç”¨æœåŠ¡å™¨åœ°å€åˆ—è¡¨'],\n       ['comfyui.request_timeout', '30000', 'number', 'comfyui', 'ComfyUIè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰'],\n       ['comfyui.health_check_timeout', '10000', 'number', 'comfyui', 'ComfyUIå¥åº·æ£€æŸ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰'],\n       ['comfyui.auto_switch', 'true', 'boolean', 'comfyui', 'æ˜¯å¦è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡å™¨'],\n"
                }
            ],
            "date": 1752409054826,
            "name": "Commit-0",
            "content": "#!/usr/bin/env node\n\n/**\n * æ£€æŸ¥æ•°æ®åº“ä¸­çš„é…ç½®æ•°æ®\n */\n\nconst fs = require('fs');\nconst path = require('path');\n\n// è¯»å–.envæ–‡ä»¶\nfunction loadEnvFile() {\n  const envPath = path.join(__dirname, 'server', '.env');\n  if (fs.existsSync(envPath)) {\n    const envContent = fs.readFileSync(envPath, 'utf8');\n    envContent.split('\\n').forEach(line => {\n      const [key, value] = line.split('=');\n      if (key && value) {\n        process.env[key.trim()] = value.trim();\n      }\n    });\n  }\n}\n\nloadEnvFile();\n\n// ä½¿ç”¨serverç›®å½•ä¸‹çš„mysql2\nconst mysql = require('./server/node_modules/mysql2/promise');\n\nasync function checkDatabaseConfig() {\n  console.log('ğŸ” æ£€æŸ¥æ•°æ®åº“é…ç½®...');\n\n  const dbConfig = {\n    host: process.env.DB_HOST,\n    port: process.env.DB_PORT || 3306,\n    user: process.env.DB_USER,\n    password: process.env.DB_PASSWORD,\n    database: process.env.DB_NAME\n  };\n\n  console.log('ğŸ“Š æ•°æ®åº“è¿æ¥é…ç½®:');\n  console.log(`  ä¸»æœº: ${dbConfig.host}`);\n  console.log(`  ç«¯å£: ${dbConfig.port}`);\n  console.log(`  ç”¨æˆ·: ${dbConfig.user}`);\n  console.log(`  æ•°æ®åº“: ${dbConfig.database}`);\n  console.log('');\n\n  let connection;\n\n  try {\n    // è¿æ¥æ•°æ®åº“\n    console.log('ğŸ”— è¿æ¥æ•°æ®åº“...');\n    connection = await mysql.createConnection(dbConfig);\n    console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ');\n\n    // æ£€æŸ¥system_configè¡¨æ˜¯å¦å­˜åœ¨\n    console.log('\\nğŸ“‹ æ£€æŸ¥system_configè¡¨...');\n    const [tables] = await connection.execute(\n      \"SHOW TABLES LIKE 'system_config'\"\n    );\n\n    if (tables.length === 0) {\n      console.log('âŒ system_configè¡¨ä¸å­˜åœ¨');\n      console.log('ğŸ’¡ éœ€è¦åˆ›å»ºsystem_configè¡¨å’Œåˆå§‹åŒ–é…ç½®æ•°æ®');\n      return;\n    }\n\n    console.log('âœ… system_configè¡¨å­˜åœ¨');\n\n    // æŸ¥è¯¢æ‰€æœ‰é…ç½®\n    console.log('\\nğŸ“Š æŸ¥è¯¢æ‰€æœ‰é…ç½®æ•°æ®...');\n    const [configs] = await connection.execute(\n      'SELECT config_key, config_value, config_type, config_group, description FROM system_config ORDER BY config_group, config_key'\n    );\n\n    if (configs.length === 0) {\n      console.log('âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é…ç½®æ•°æ®');\n      console.log('ğŸ’¡ éœ€è¦åˆå§‹åŒ–é…ç½®æ•°æ®');\n      return;\n    }\n\n    console.log(`âœ… æ‰¾åˆ° ${configs.length} é¡¹é…ç½®`);\n\n    // æŒ‰åˆ†ç»„æ˜¾ç¤ºé…ç½®\n    const groupedConfigs = {};\n    configs.forEach(config => {\n      if (!groupedConfigs[config.config_group]) {\n        groupedConfigs[config.config_group] = [];\n      }\n      groupedConfigs[config.config_group].push(config);\n    });\n\n    console.log('\\nğŸ“‹ é…ç½®è¯¦æƒ…:');\n    Object.entries(groupedConfigs).forEach(([group, groupConfigs]) => {\n      console.log(`\\nğŸ”§ ${group} é…ç½®ç»„:`);\n      groupConfigs.forEach(config => {\n        console.log(`  ${config.config_key}: ${config.config_value} (${config.config_type})`);\n        if (config.description) {\n          console.log(`    æè¿°: ${config.description}`);\n        }\n      });\n    });\n\n    // ç‰¹åˆ«æ£€æŸ¥ComfyUIé…ç½®\n    console.log('\\nğŸ¨ ComfyUIé…ç½®æ£€æŸ¥:');\n    const comfyuiConfigs = configs.filter(config => config.config_group === 'comfyui');\n\n    if (comfyuiConfigs.length === 0) {\n      console.log('âŒ æ²¡æœ‰æ‰¾åˆ°ComfyUIé…ç½®');\n      console.log('ğŸ’¡ éœ€è¦æ·»åŠ ComfyUIé…ç½®æ•°æ®');\n    } else {\n      console.log(`âœ… æ‰¾åˆ° ${comfyuiConfigs.length} é¡¹ComfyUIé…ç½®`);\n      comfyuiConfigs.forEach(config => {\n        console.log(`  âœ“ ${config.config_key}: ${config.config_value}`);\n      });\n    }\n\n  } catch (error) {\n    console.error('âŒ æ•°æ®åº“æ“ä½œå¤±è´¥:', error.message);\n\n    if (error.code === 'ECONNREFUSED') {\n      console.log('ğŸ’¡ æ•°æ®åº“è¿æ¥è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥:');\n      console.log('  1. æ•°æ®åº“æœåŠ¡æ˜¯å¦è¿è¡Œ');\n      console.log('  2. è¿æ¥é…ç½®æ˜¯å¦æ­£ç¡®');\n      console.log('  3. é˜²ç«å¢™è®¾ç½®');\n    } else if (error.code === 'ER_ACCESS_DENIED_ERROR') {\n      console.log('ğŸ’¡ æ•°æ®åº“è®¿é—®è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ');\n    } else if (error.code === 'ER_BAD_DB_ERROR') {\n      console.log('ğŸ’¡ æ•°æ®åº“ä¸å­˜åœ¨ï¼Œè¯·åˆ›å»ºæ•°æ®åº“');\n    }\n  } finally {\n    if (connection) {\n      await connection.end();\n      console.log('\\nğŸ”Œ æ•°æ®åº“è¿æ¥å·²å…³é—­');\n    }\n  }\n}\n\n// åˆå§‹åŒ–ComfyUIé…ç½®\nasync function initComfyUIConfig() {\n  console.log('\\nğŸ”§ åˆå§‹åŒ–ComfyUIé…ç½®...');\n\n  const dbConfig = {\n    host: process.env.DB_HOST,\n    port: process.env.DB_PORT || 3306,\n    user: process.env.DB_USER,\n    password: process.env.DB_PASSWORD,\n    database: process.env.DB_NAME\n  };\n\n  let connection;\n\n  try {\n    connection = await mysql.createConnection(dbConfig);\n\n    const comfyuiConfigs = [\n      ['comfyui.server_url', 'https://your-comfyui-server.com', 'string', 'comfyui', 'ComfyUIä¸»æœåŠ¡å™¨åœ°å€'],\n      ['comfyui.backup_servers', '', 'string', 'comfyui', 'ComfyUIå¤‡ç”¨æœåŠ¡å™¨åœ°å€åˆ—è¡¨'],\n      ['comfyui.request_timeout', '30000', 'number', 'comfyui', 'ComfyUIè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰'],\n      ['comfyui.health_check_timeout', '10000', 'number', 'comfyui', 'ComfyUIå¥åº·æ£€æŸ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰'],\n      ['comfyui.auto_switch', 'true', 'boolean', 'comfyui', 'æ˜¯å¦è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡å™¨'],\n      ['comfyui.client_id', 'your-client-id', 'string', 'comfyui', 'ComfyUIå®¢æˆ·ç«¯ID'],\n      ['comfyui.max_retries', '3', 'number', 'comfyui', 'æœ€å¤§é‡è¯•æ¬¡æ•°']\n    ];\n\n    for (const [key, value, type, group, description] of comfyuiConfigs) {\n      await connection.execute(\n        `INSERT INTO system_config (config_key, config_value, config_type, config_group, description, is_encrypted, created_at, updated_at)\n         VALUES (?, ?, ?, ?, ?, 0, NOW(), NOW())\n         ON DUPLICATE KEY UPDATE\n         config_value = VALUES(config_value),\n         config_type = VALUES(config_type),\n         description = VALUES(description),\n         updated_at = NOW()`,\n        [key, value, type, group, description]\n      );\n    }\n\n    console.log('âœ… ComfyUIé…ç½®åˆå§‹åŒ–å®Œæˆ');\n\n  } catch (error) {\n    console.error('âŒ åˆå§‹åŒ–é…ç½®å¤±è´¥:', error.message);\n  } finally {\n    if (connection) {\n      await connection.end();\n    }\n  }\n}\n\n// ä¸»å‡½æ•°\nasync function main() {\n  console.log('ğŸš€ æ•°æ®åº“é…ç½®æ£€æŸ¥å·¥å…·');\n  console.log('='.repeat(50));\n\n  await checkDatabaseConfig();\n\n  // è¯¢é—®æ˜¯å¦åˆå§‹åŒ–é…ç½®\n  const args = process.argv.slice(2);\n  if (args.includes('--init')) {\n    await initComfyUIConfig();\n    console.log('\\nğŸ”„ é‡æ–°æ£€æŸ¥é…ç½®...');\n    await checkDatabaseConfig();\n  } else {\n    console.log('\\nğŸ’¡ å¦‚éœ€åˆå§‹åŒ–ComfyUIé…ç½®ï¼Œè¯·è¿è¡Œ:');\n    console.log('   node check-database-config.js --init');\n  }\n}\n\n// è¿è¡Œæ£€æŸ¥\nif (require.main === module) {\n  main().catch(console.error);\n}\n"
        }
    ]
}