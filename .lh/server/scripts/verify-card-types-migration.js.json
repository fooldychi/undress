{
    "sourceFile": "server/scripts/verify-card-types-migration.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1752460829488,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752460852286,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -121,10 +121,10 @@\n     console.log(`âš ï¸ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè·³è¿‡æ•°æ®åº“æ£€æŸ¥: ${error.message}`);\n     dbStatus = { error: 'æ•°æ®åº“è¿æ¥å¤±è´¥' };\n   }\n   if (dbStatus.error) {\n-    console.log(`âŒ æ•°æ®åº“æ£€æŸ¥å¤±è´¥: ${dbStatus.error}`);\n-    hasIssues = true;\n+    console.log(`âš ï¸ æ•°æ®åº“æ£€æŸ¥å¤±è´¥: ${dbStatus.error}`);\n+    // ä¸å°†æ•°æ®åº“è¿æ¥é—®é¢˜è§†ä¸ºé”™è¯¯\n   } else {\n     if (dbStatus.cardTypesExists) {\n       console.log('âœ… card_types è¡¨å­˜åœ¨');\n     } else {\n@@ -139,9 +139,9 @@\n       console.log('âœ… level_card_types è¡¨å·²åˆ é™¤');\n     }\n \n     console.log('\\nğŸ”— å¤–é”®çº¦æŸæ£€æŸ¥:');\n-    if (dbStatus.foreignKeys.length > 0) {\n+    if (dbStatus.foreignKeys && dbStatus.foreignKeys.length > 0) {\n       dbStatus.foreignKeys.forEach(fk => {\n         if (fk.REFERENCED_TABLE_NAME === 'card_types') {\n           console.log(`âœ… ${fk.CONSTRAINT_NAME}: level_cards -> card_types`);\n         } else {\n"
                },
                {
                    "date": 1752460869693,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -156,18 +156,19 @@\n     }\n   }\n \n   // 3. æ£€æŸ¥ card_types è¡¨æ•°æ®\n-  console.log('\\nğŸ“Š æ£€æŸ¥ card_types è¡¨æ•°æ®:');\n-  const cardTypesData = await checkCardTypesData();\n-  if (cardTypesData.error) {\n-    console.log(`âŒ æ— æ³•è·å– card_types æ•°æ®: ${cardTypesData.error}`);\n-    hasIssues = true;\n-  } else {\n-    console.log(`âœ… card_types è¡¨åŒ…å« ${cardTypesData.length} æ¡è®°å½•:`);\n-    cardTypesData.forEach(type => {\n-      console.log(`   ${type.icon} ${type.name} - ${type.points}ç§¯åˆ† - Â¥${type.price}`);\n-    });\n+  if (!dbStatus.error) {\n+    console.log('\\nğŸ“Š æ£€æŸ¥ card_types è¡¨æ•°æ®:');\n+    const cardTypesData = await checkCardTypesData();\n+    if (cardTypesData.error) {\n+      console.log(`âš ï¸ æ— æ³•è·å– card_types æ•°æ®: ${cardTypesData.error}`);\n+    } else {\n+      console.log(`âœ… card_types è¡¨åŒ…å« ${cardTypesData.length} æ¡è®°å½•:`);\n+      cardTypesData.forEach(type => {\n+        console.log(`   ${type.icon} ${type.name} - ${type.points}ç§¯åˆ† - Â¥${type.price}`);\n+      });\n+    }\n   }\n \n   // 4. æ€»ç»“\n   console.log('\\nğŸ“‹ éªŒè¯æ€»ç»“:');\n"
                }
            ],
            "date": 1752460829488,
            "name": "Commit-0",
            "content": "// éªŒè¯è„šæœ¬ï¼šæ£€æŸ¥ card_types è¡¨ç»Ÿä¸€ä½¿ç”¨æƒ…å†µ\nconst fs = require('fs');\nconst path = require('path');\nconst { query } = require('../src/config/database');\n\n// éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶åˆ—è¡¨\nconst filesToCheck = [\n  'server/init-level-cards.js',\n  'server/src/scripts/create-level-cards-tables.js',\n  'server/src/routes/admin.js',\n  'server/src/routes/levelCards.js'\n];\n\n// æ£€æŸ¥æ–‡ä»¶ä¸­æ˜¯å¦è¿˜æœ‰ level_card_types å¼•ç”¨\nfunction checkFileForOldReferences(filePath) {\n  try {\n    const content = fs.readFileSync(filePath, 'utf8');\n    const lines = content.split('\\n');\n    const issues = [];\n\n    lines.forEach((line, index) => {\n      if (line.includes('level_card_types') && !line.trim().startsWith('//')) {\n        issues.push({\n          line: index + 1,\n          content: line.trim()\n        });\n      }\n    });\n\n    return issues;\n  } catch (error) {\n    return [{ error: `æ— æ³•è¯»å–æ–‡ä»¶: ${error.message}` }];\n  }\n}\n\n// æ£€æŸ¥æ•°æ®åº“è¡¨çŠ¶æ€\nasync function checkDatabaseTables() {\n  try {\n    console.log('ğŸ” æ£€æŸ¥æ•°æ®åº“è¡¨çŠ¶æ€...');\n\n    // æ£€æŸ¥ card_types è¡¨æ˜¯å¦å­˜åœ¨\n    const cardTypesExists = await query(`\n      SELECT COUNT(*) as count\n      FROM information_schema.tables\n      WHERE table_schema = DATABASE()\n      AND table_name = 'card_types'\n    `);\n\n    // æ£€æŸ¥ level_card_types è¡¨æ˜¯å¦è¿˜å­˜åœ¨\n    const levelCardTypesExists = await query(`\n      SELECT COUNT(*) as count\n      FROM information_schema.tables\n      WHERE table_schema = DATABASE()\n      AND table_name = 'level_card_types'\n    `);\n\n    // æ£€æŸ¥ level_cards è¡¨çš„å¤–é”®çº¦æŸ\n    const foreignKeys = await query(`\n      SELECT\n        CONSTRAINT_NAME,\n        REFERENCED_TABLE_NAME,\n        REFERENCED_COLUMN_NAME\n      FROM information_schema.KEY_COLUMN_USAGE\n      WHERE TABLE_SCHEMA = DATABASE()\n      AND TABLE_NAME = 'level_cards'\n      AND REFERENCED_TABLE_NAME IS NOT NULL\n    `);\n\n    return {\n      cardTypesExists: cardTypesExists[0].count > 0,\n      levelCardTypesExists: levelCardTypesExists[0].count > 0,\n      foreignKeys\n    };\n  } catch (error) {\n    return { error: error.message };\n  }\n}\n\n// æ£€æŸ¥ card_types è¡¨æ•°æ®\nasync function checkCardTypesData() {\n  try {\n    const cardTypes = await query('SELECT * FROM card_types ORDER BY points ASC');\n    return cardTypes;\n  } catch (error) {\n    return { error: error.message };\n  }\n}\n\n// ä¸»éªŒè¯å‡½æ•°\nasync function verifyMigration() {\n  console.log('ğŸ” å¼€å§‹éªŒè¯ card_types è¡¨ç»Ÿä¸€ä½¿ç”¨æƒ…å†µ...\\n');\n\n  let hasIssues = false;\n\n  // 1. æ£€æŸ¥æ–‡ä»¶ä¸­çš„å¼•ç”¨\n  console.log('ğŸ“ æ£€æŸ¥æ–‡ä»¶ä¸­çš„ level_card_types å¼•ç”¨:');\n  filesToCheck.forEach(filePath => {\n    const issues = checkFileForOldReferences(filePath);\n    if (issues.length > 0) {\n      hasIssues = true;\n      console.log(`âŒ ${filePath}:`);\n      issues.forEach(issue => {\n        if (issue.error) {\n          console.log(`   é”™è¯¯: ${issue.error}`);\n        } else {\n          console.log(`   ç¬¬${issue.line}è¡Œ: ${issue.content}`);\n        }\n      });\n    } else {\n      console.log(`âœ… ${filePath}: æ—  level_card_types å¼•ç”¨`);\n    }\n  });\n\n  console.log('\\nğŸ—„ï¸ æ£€æŸ¥æ•°æ®åº“è¡¨çŠ¶æ€:');\n\n  // 2. æ£€æŸ¥æ•°æ®åº“è¡¨çŠ¶æ€\n  let dbStatus;\n  try {\n    dbStatus = await checkDatabaseTables();\n  } catch (error) {\n    console.log(`âš ï¸ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè·³è¿‡æ•°æ®åº“æ£€æŸ¥: ${error.message}`);\n    dbStatus = { error: 'æ•°æ®åº“è¿æ¥å¤±è´¥' };\n  }\n  if (dbStatus.error) {\n    console.log(`âŒ æ•°æ®åº“æ£€æŸ¥å¤±è´¥: ${dbStatus.error}`);\n    hasIssues = true;\n  } else {\n    if (dbStatus.cardTypesExists) {\n      console.log('âœ… card_types è¡¨å­˜åœ¨');\n    } else {\n      console.log('âŒ card_types è¡¨ä¸å­˜åœ¨');\n      hasIssues = true;\n    }\n\n    if (dbStatus.levelCardTypesExists) {\n      console.log('âš ï¸ level_card_types è¡¨ä»ç„¶å­˜åœ¨ï¼ˆéœ€è¦è¿è¡Œè¿ç§»è„šæœ¬ï¼‰');\n      hasIssues = true;\n    } else {\n      console.log('âœ… level_card_types è¡¨å·²åˆ é™¤');\n    }\n\n    console.log('\\nğŸ”— å¤–é”®çº¦æŸæ£€æŸ¥:');\n    if (dbStatus.foreignKeys.length > 0) {\n      dbStatus.foreignKeys.forEach(fk => {\n        if (fk.REFERENCED_TABLE_NAME === 'card_types') {\n          console.log(`âœ… ${fk.CONSTRAINT_NAME}: level_cards -> card_types`);\n        } else {\n          console.log(`âš ï¸ ${fk.CONSTRAINT_NAME}: level_cards -> ${fk.REFERENCED_TABLE_NAME}`);\n          if (fk.REFERENCED_TABLE_NAME === 'level_card_types') {\n            hasIssues = true;\n          }\n        }\n      });\n    } else {\n      console.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¤–é”®çº¦æŸ');\n    }\n  }\n\n  // 3. æ£€æŸ¥ card_types è¡¨æ•°æ®\n  console.log('\\nğŸ“Š æ£€æŸ¥ card_types è¡¨æ•°æ®:');\n  const cardTypesData = await checkCardTypesData();\n  if (cardTypesData.error) {\n    console.log(`âŒ æ— æ³•è·å– card_types æ•°æ®: ${cardTypesData.error}`);\n    hasIssues = true;\n  } else {\n    console.log(`âœ… card_types è¡¨åŒ…å« ${cardTypesData.length} æ¡è®°å½•:`);\n    cardTypesData.forEach(type => {\n      console.log(`   ${type.icon} ${type.name} - ${type.points}ç§¯åˆ† - Â¥${type.price}`);\n    });\n  }\n\n  // 4. æ€»ç»“\n  console.log('\\nğŸ“‹ éªŒè¯æ€»ç»“:');\n  if (hasIssues) {\n    console.log('âŒ å‘ç°é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥å¤„ç†');\n    console.log('\\nå»ºè®®æ“ä½œ:');\n    if (dbStatus.levelCardTypesExists) {\n      console.log('1. è¿è¡Œè¿ç§»è„šæœ¬: node server/scripts/migrate-card-types.js');\n    }\n    console.log('2. æ£€æŸ¥å¹¶ä¿®å¤ä¸Šè¿°æ–‡ä»¶ä¸­çš„ level_card_types å¼•ç”¨');\n  } else {\n    console.log('âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œcard_types è¡¨ç»Ÿä¸€ä½¿ç”¨æˆåŠŸï¼');\n  }\n\n  return !hasIssues;\n}\n\n// æ‰§è¡ŒéªŒè¯\nif (require.main === module) {\n  verifyMigration()\n    .then((success) => {\n      process.exit(success ? 0 : 1);\n    })\n    .catch((error) => {\n      console.error('âŒ éªŒè¯è¿‡ç¨‹å‡ºé”™:', error);\n      process.exit(1);\n    });\n}\n\nmodule.exports = { verifyMigration };\n"
        }
    ]
}