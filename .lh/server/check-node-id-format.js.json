{
    "sourceFile": "server/check-node-id-format.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1752831722084,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752831830729,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,41 +29,54 @@\n       let actualNodeId = node_id;\n       let depth = 0;\n \n       // æ£€æŸ¥æ˜¯å¦åŒ…å«JSONç»“æ„çš„ç‰¹å¾\n-      if (typeof node_id === 'string' && node_id.includes('{\"nodeId\":')) {\n-        isJsonFormat = true;\n+      if (typeof node_id === 'string' && (node_id.includes('{\"nodeId\":') || node_id.startsWith('{'))) {\n+        try {\n+          // å°è¯•è§£æJSON\n+          const parsed = JSON.parse(node_id);\n+          if (parsed && typeof parsed === 'object' && parsed.nodeId) {\n+            isJsonFormat = true;\n \n-        // é€’å½’è§£æåµŒå¥—çš„JSONå­—ç¬¦ä¸²\n-        let temp = node_id;\n-        while (typeof temp === 'string' && temp.includes('{\"nodeId\":')) {\n-          try {\n-            const parsed = JSON.parse(temp);\n-            if (parsed && typeof parsed === 'object' && parsed.nodeId) {\n-              temp = parsed.nodeId;\n-              depth++;\n-            } else {\n-              break;\n+            // é€’å½’è§£æåµŒå¥—çš„JSONå­—ç¬¦ä¸²\n+            let temp = parsed.nodeId;\n+            depth = 1;\n+\n+            while (typeof temp === 'string') {\n+              try {\n+                if (temp.startsWith('{')) {\n+                  const innerParsed = JSON.parse(temp);\n+                  if (innerParsed && typeof innerParsed === 'object' && innerParsed.nodeId) {\n+                    temp = innerParsed.nodeId;\n+                    depth++;\n+                  } else {\n+                    break;\n+                  }\n+                } else {\n+                  break;\n+                }\n+              } catch (e) {\n+                break;\n+              }\n             }\n-          } catch (e) {\n-            break;\n+\n+            actualNodeId = temp;\n+\n+            issues.push({\n+              id,\n+              workflow_type,\n+              node_type,\n+              node_key,\n+              original: node_id,\n+              extracted: actualNodeId,\n+              depth,\n+              severity: depth > 2 ? 'high' : 'medium'\n+            });\n+            issueCount++;\n           }\n+        } catch (e) {\n+          // ä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œå¿½ç•¥\n         }\n-        actualNodeId = temp;\n-\n-        if (depth > 0) {\n-          issues.push({\n-            id,\n-            workflow_type,\n-            node_type,\n-            node_key,\n-            original: node_id,\n-            extracted: actualNodeId,\n-            depth,\n-            severity: depth > 2 ? 'high' : 'medium'\n-          });\n-          issueCount++;\n-        }\n       }\n \n       // æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯\n       const status = isJsonFormat ? 'âŒ JSONæ ¼å¼' : 'âœ… æ­£å¸¸';\n"
                }
            ],
            "date": 1752831722084,
            "name": "Commit-0",
            "content": "const { query } = require('./src/config/database');\n\n/**\n * æ£€æŸ¥æ•°æ®åº“ä¸­èŠ‚ç‚¹IDçš„æ ¼å¼ï¼Œè¯†åˆ«å¯èƒ½çš„JSONåºåˆ—åŒ–é—®é¢˜\n */\nasync function checkNodeIdFormat() {\n  console.log('ğŸ” æ£€æŸ¥æ•°æ®åº“ä¸­çš„èŠ‚ç‚¹IDæ ¼å¼...');\n  console.log('='.repeat(60));\n\n  try {\n    // è·å–æ‰€æœ‰èŠ‚ç‚¹é…ç½®\n    const nodeConfigs = await query(`\n      SELECT id, workflow_type, node_type, node_key, node_id, node_order, created_at, updated_at\n      FROM workflow_configs\n      ORDER BY workflow_type, node_type, node_key\n    `);\n\n    console.log(`ğŸ“Š æ‰¾åˆ° ${nodeConfigs.length} ä¸ªèŠ‚ç‚¹é…ç½®`);\n    console.log('');\n\n    let issueCount = 0;\n    const issues = [];\n\n    nodeConfigs.forEach(config => {\n      const { id, workflow_type, node_type, node_key, node_id } = config;\n\n      // æ£€æŸ¥æ˜¯å¦æ˜¯JSONæ ¼å¼çš„å­—ç¬¦ä¸²\n      let isJsonFormat = false;\n      let actualNodeId = node_id;\n      let depth = 0;\n\n      // æ£€æŸ¥æ˜¯å¦åŒ…å«JSONç»“æ„çš„ç‰¹å¾\n      if (typeof node_id === 'string' && node_id.includes('{\"nodeId\":')) {\n        isJsonFormat = true;\n\n        // é€’å½’è§£æåµŒå¥—çš„JSONå­—ç¬¦ä¸²\n        let temp = node_id;\n        while (typeof temp === 'string' && temp.includes('{\"nodeId\":')) {\n          try {\n            const parsed = JSON.parse(temp);\n            if (parsed && typeof parsed === 'object' && parsed.nodeId) {\n              temp = parsed.nodeId;\n              depth++;\n            } else {\n              break;\n            }\n          } catch (e) {\n            break;\n          }\n        }\n        actualNodeId = temp;\n\n        if (depth > 0) {\n          issues.push({\n            id,\n            workflow_type,\n            node_type,\n            node_key,\n            original: node_id,\n            extracted: actualNodeId,\n            depth,\n            severity: depth > 2 ? 'high' : 'medium'\n          });\n          issueCount++;\n        }\n      }\n\n      // æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯\n      const status = isJsonFormat ? 'âŒ JSONæ ¼å¼' : 'âœ… æ­£å¸¸';\n      const displayValue = node_id.length > 80 ? node_id.substring(0, 80) + '...' : node_id;\n      console.log(`${status} ${workflow_type}.${node_type}.${node_key}: ${displayValue}`);\n\n      if (isJsonFormat && actualNodeId !== node_id) {\n        console.log(`    ğŸ”§ æå–çš„å®é™…èŠ‚ç‚¹ID: ${actualNodeId} (åµŒå¥—æ·±åº¦: ${depth})`);\n      }\n    });\n\n    console.log('');\n    console.log('='.repeat(60));\n    console.log(`ğŸ“‹ æ£€æŸ¥å®Œæˆ: å‘ç° ${issueCount} ä¸ªé—®é¢˜èŠ‚ç‚¹`);\n\n    if (issues.length > 0) {\n      console.log('');\n      console.log('ğŸš¨ é—®é¢˜è¯¦æƒ…:');\n      issues.forEach((issue, index) => {\n        console.log(`${index + 1}. ${issue.workflow_type}.${issue.node_type}.${issue.node_key}`);\n        console.log(`   ID: ${issue.id}`);\n        console.log(`   åŸå§‹å€¼: ${issue.original}`);\n        console.log(`   æå–å€¼: ${issue.extracted}`);\n        console.log(`   åµŒå¥—æ·±åº¦: ${issue.depth}`);\n        console.log(`   ä¸¥é‡ç¨‹åº¦: ${issue.severity}`);\n        console.log('');\n      });\n\n      console.log('ğŸ”§ ä¿®å¤å»ºè®®:');\n      console.log('1. è¿è¡Œä¿®å¤è„šæœ¬æ¸…ç†è¿™äº›èŠ‚ç‚¹ID');\n      console.log('2. æ£€æŸ¥å‰ç«¯ä»£ç ç¡®ä¿ä¸å†äº§ç”ŸåµŒå¥—JSON');\n      console.log('3. åœ¨åå°ç®¡ç†é¡µé¢é‡æ–°ä¿å­˜é…ç½®');\n    } else {\n      console.log('âœ… æ‰€æœ‰èŠ‚ç‚¹IDæ ¼å¼æ­£å¸¸ï¼');\n    }\n\n    return {\n      total: nodeConfigs.length,\n      issues: issues.length,\n      details: issues\n    };\n\n  } catch (error) {\n    console.error('âŒ æ£€æŸ¥å¤±è´¥:', error);\n    throw error;\n  }\n}\n\n/**\n * ä¿®å¤æœ‰é—®é¢˜çš„èŠ‚ç‚¹ID\n */\nasync function fixNodeIdFormat() {\n  console.log('ğŸ”§ å¼€å§‹ä¿®å¤èŠ‚ç‚¹IDæ ¼å¼...');\n\n  try {\n    const checkResult = await checkNodeIdFormat();\n\n    if (checkResult.issues === 0) {\n      console.log('âœ… æ²¡æœ‰éœ€è¦ä¿®å¤çš„èŠ‚ç‚¹ID');\n      return;\n    }\n\n    console.log(`ğŸ”§ å‡†å¤‡ä¿®å¤ ${checkResult.issues} ä¸ªé—®é¢˜èŠ‚ç‚¹...`);\n\n    let fixedCount = 0;\n\n    for (const issue of checkResult.details) {\n      try {\n        console.log(`ğŸ”§ ä¿®å¤èŠ‚ç‚¹ ${issue.workflow_type}.${issue.node_type}.${issue.node_key}...`);\n\n        const result = await query(`\n          UPDATE workflow_configs\n          SET node_id = ?, updated_at = NOW()\n          WHERE id = ?\n        `, [issue.extracted, issue.id]);\n\n        if (result.affectedRows > 0) {\n          console.log(`âœ… ä¿®å¤æˆåŠŸ: ${issue.original} -> ${issue.extracted}`);\n          fixedCount++;\n        } else {\n          console.log(`âš ï¸ ä¿®å¤å¤±è´¥: æ²¡æœ‰æ‰¾åˆ°IDä¸º ${issue.id} çš„è®°å½•`);\n        }\n\n      } catch (error) {\n        console.error(`âŒ ä¿®å¤èŠ‚ç‚¹ ${issue.id} å¤±è´¥:`, error);\n      }\n    }\n\n    console.log('');\n    console.log('='.repeat(60));\n    console.log(`ğŸ‰ ä¿®å¤å®Œæˆ: æˆåŠŸä¿®å¤ ${fixedCount}/${checkResult.issues} ä¸ªèŠ‚ç‚¹`);\n\n    // å†æ¬¡æ£€æŸ¥ç¡®è®¤ä¿®å¤ç»“æœ\n    console.log('');\n    console.log('ğŸ” éªŒè¯ä¿®å¤ç»“æœ...');\n    await checkNodeIdFormat();\n\n  } catch (error) {\n    console.error('âŒ ä¿®å¤å¤±è´¥:', error);\n    throw error;\n  }\n}\n\n// ä¸»å‡½æ•°\nasync function main() {\n  const args = process.argv.slice(2);\n  const command = args[0] || 'check';\n\n  try {\n    if (command === 'check') {\n      await checkNodeIdFormat();\n    } else if (command === 'fix') {\n      await fixNodeIdFormat();\n    } else {\n      console.log('ç”¨æ³•:');\n      console.log('  node check-node-id-format.js check  # æ£€æŸ¥èŠ‚ç‚¹IDæ ¼å¼');\n      console.log('  node check-node-id-format.js fix    # ä¿®å¤èŠ‚ç‚¹IDæ ¼å¼');\n    }\n  } catch (error) {\n    console.error('âŒ æ‰§è¡Œå¤±è´¥:', error);\n    process.exit(1);\n  }\n}\n\n// å¦‚æœç›´æ¥è¿è¡Œæ­¤è„šæœ¬\nif (require.main === module) {\n  main();\n}\n\nmodule.exports = {\n  checkNodeIdFormat,\n  fixNodeIdFormat\n};\n"
        }
    ]
}