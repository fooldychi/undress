{
    "sourceFile": "server/create-workflow-tables.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1752815242549,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752815265453,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -46,9 +46,9 @@\n         node_order INT DEFAULT 0 COMMENT 'èŠ‚ç‚¹é¡ºåºï¼ˆç”¨äºè¾“å‡ºèŠ‚ç‚¹ä¼˜å…ˆçº§ï¼‰',\n         description VARCHAR(255) DEFAULT NULL COMMENT 'èŠ‚ç‚¹æè¿°',\n         is_enabled BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',\n         created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+        updated_at DATETIME DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,\n         UNIQUE KEY uk_workflow_node (workflow_type, node_type, node_key),\n         INDEX idx_workflow_type (workflow_type),\n         INDEX idx_node_type (node_type)\n       ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å·¥ä½œæµèŠ‚ç‚¹é…ç½®è¡¨'\n"
                }
            ],
            "date": 1752815242549,
            "name": "Commit-0",
            "content": "const mysql = require('mysql2/promise');\nrequire('dotenv').config();\n\nasync function createWorkflowTables() {\n  let connection;\n  try {\n    console.log('ğŸ”§ å¼€å§‹åˆ›å»ºå·¥ä½œæµè¡¨...');\n\n    // åˆ›å»ºæ•°æ®åº“è¿æ¥\n    connection = await mysql.createConnection({\n      host: process.env.DB_HOST || 'localhost',\n      port: process.env.DB_PORT || 3306,\n      user: process.env.DB_USER || 'root',\n      password: process.env.DB_PASSWORD || '',\n      database: process.env.DB_NAME || 'aimagic',\n      charset: 'utf8mb4'\n    });\n\n    console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ');\n\n    // 1. åˆ›å»ºå·¥ä½œæµåŸºç¡€ä¿¡æ¯è¡¨\n    console.log('ğŸ“ åˆ›å»º workflow_info è¡¨...');\n    await connection.execute(`\n      CREATE TABLE IF NOT EXISTS workflow_info (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        workflow_type VARCHAR(50) NOT NULL UNIQUE COMMENT 'å·¥ä½œæµç±»å‹',\n        workflow_name VARCHAR(100) NOT NULL COMMENT 'å·¥ä½œæµåç§°',\n        description TEXT COMMENT 'å·¥ä½œæµæè¿°',\n        file_path VARCHAR(255) COMMENT 'å·¥ä½œæµæ–‡ä»¶è·¯å¾„',\n        is_enabled BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at DATETIME DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å·¥ä½œæµåŸºç¡€ä¿¡æ¯è¡¨'\n    `);\n    console.log('âœ… workflow_info è¡¨åˆ›å»ºæˆåŠŸ');\n\n    // 2. åˆ›å»ºå·¥ä½œæµèŠ‚ç‚¹é…ç½®è¡¨\n    console.log('ğŸ“ åˆ›å»º workflow_configs è¡¨...');\n    await connection.execute(`\n      CREATE TABLE IF NOT EXISTS workflow_configs (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        workflow_type VARCHAR(50) NOT NULL COMMENT 'å·¥ä½œæµç±»å‹ï¼šfaceswap, undress',\n        node_type ENUM('input', 'output') NOT NULL COMMENT 'èŠ‚ç‚¹ç±»å‹',\n        node_key VARCHAR(100) NOT NULL COMMENT 'èŠ‚ç‚¹é”®å',\n        node_id VARCHAR(50) NOT NULL COMMENT 'èŠ‚ç‚¹ID',\n        node_order INT DEFAULT 0 COMMENT 'èŠ‚ç‚¹é¡ºåºï¼ˆç”¨äºè¾“å‡ºèŠ‚ç‚¹ä¼˜å…ˆçº§ï¼‰',\n        description VARCHAR(255) DEFAULT NULL COMMENT 'èŠ‚ç‚¹æè¿°',\n        is_enabled BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n        UNIQUE KEY uk_workflow_node (workflow_type, node_type, node_key),\n        INDEX idx_workflow_type (workflow_type),\n        INDEX idx_node_type (node_type)\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å·¥ä½œæµèŠ‚ç‚¹é…ç½®è¡¨'\n    `);\n    console.log('âœ… workflow_configs è¡¨åˆ›å»ºæˆåŠŸ');\n\n    // 3. æ’å…¥å·¥ä½œæµåŸºç¡€ä¿¡æ¯\n    console.log('ğŸ“ æ’å…¥å·¥ä½œæµåŸºç¡€ä¿¡æ¯...');\n    const workflowInfos = [\n      ['faceswap', 'Face Swap 2.0', 'é«˜è´¨é‡äººè„¸æ›¿æ¢å·¥ä½œæµ', 'workflows/faceswap2.0.json', true],\n      ['undress', 'Undress AI', 'ä¸€é”®è¤ªè¡£AIå·¥ä½œæµ', 'workflows/undress.json', true]\n    ];\n\n    for (const [type, name, desc, path, enabled] of workflowInfos) {\n      await connection.execute(`\n        INSERT INTO workflow_info (workflow_type, workflow_name, description, file_path, is_enabled)\n        VALUES (?, ?, ?, ?, ?)\n        ON DUPLICATE KEY UPDATE\n          workflow_name = VALUES(workflow_name),\n          description = VALUES(description),\n          file_path = VALUES(file_path),\n          is_enabled = VALUES(is_enabled),\n          updated_at = CURRENT_TIMESTAMP\n      `, [type, name, desc, path, enabled]);\n      console.log(`  âœ… æ’å…¥å·¥ä½œæµ: ${name}`);\n    }\n\n    // 4. æ’å…¥å·¥ä½œæµèŠ‚ç‚¹é…ç½®\n    console.log('ğŸ“ æ’å…¥å·¥ä½œæµèŠ‚ç‚¹é…ç½®...');\n    const nodeConfigs = [\n      // æ¢è„¸å·¥ä½œæµè¾“å…¥èŠ‚ç‚¹\n      ['faceswap', 'input', 'face_photo_1', '670', 1, 'ç¬¬ä¸€å¼ äººè„¸ç…§ç‰‡èŠ‚ç‚¹'],\n      ['faceswap', 'input', 'face_photo_2', '662', 2, 'ç¬¬äºŒå¼ äººè„¸ç…§ç‰‡èŠ‚ç‚¹'],\n      ['faceswap', 'input', 'face_photo_3', '658', 3, 'ç¬¬ä¸‰å¼ äººè„¸ç…§ç‰‡èŠ‚ç‚¹'],\n      ['faceswap', 'input', 'face_photo_4', '655', 4, 'ç¬¬å››å¼ äººè„¸ç…§ç‰‡èŠ‚ç‚¹'],\n      ['faceswap', 'input', 'target_image', '737', 5, 'ç›®æ ‡å›¾ç‰‡èŠ‚ç‚¹'],\n\n      // æ¢è„¸å·¥ä½œæµè¾“å‡ºèŠ‚ç‚¹ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰\n      ['faceswap', 'output', 'primary', '812', 1, 'ä¸»è¦è¾“å‡ºèŠ‚ç‚¹'],\n      ['faceswap', 'output', 'secondary_1', '813', 2, 'å¤‡ç”¨è¾“å‡ºèŠ‚ç‚¹1'],\n      ['faceswap', 'output', 'secondary_2', '746', 3, 'å¤‡ç”¨è¾“å‡ºèŠ‚ç‚¹2'],\n      ['faceswap', 'output', 'secondary_3', '710', 4, 'å¤‡ç”¨è¾“å‡ºèŠ‚ç‚¹3'],\n\n      // ä¸€é”®è¤ªè¡£å·¥ä½œæµè¾“å…¥èŠ‚ç‚¹\n      ['undress', 'input', 'main_image', '49', 1, 'ä¸»å›¾ç‰‡è¾“å…¥èŠ‚ç‚¹'],\n      ['undress', 'input', 'seed_node', '174', 2, 'éšæœºç§å­èŠ‚ç‚¹'],\n\n      // ä¸€é”®è¤ªè¡£å·¥ä½œæµè¾“å‡ºèŠ‚ç‚¹ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰\n      ['undress', 'output', 'primary', '730', 1, 'ä¸»è¦è¾“å‡ºèŠ‚ç‚¹'],\n      ['undress', 'output', 'secondary_1', '812', 2, 'å¤‡ç”¨è¾“å‡ºèŠ‚ç‚¹1'],\n      ['undress', 'output', 'secondary_2', '813', 3, 'å¤‡ç”¨è¾“å‡ºèŠ‚ç‚¹2'],\n      ['undress', 'output', 'secondary_3', '746', 4, 'å¤‡ç”¨è¾“å‡ºèŠ‚ç‚¹3'],\n      ['undress', 'output', 'secondary_4', '710', 5, 'å¤‡ç”¨è¾“å‡ºèŠ‚ç‚¹4']\n    ];\n\n    for (const [workflowType, nodeType, nodeKey, nodeId, order, desc] of nodeConfigs) {\n      await connection.execute(`\n        INSERT INTO workflow_configs (workflow_type, node_type, node_key, node_id, node_order, description)\n        VALUES (?, ?, ?, ?, ?, ?)\n        ON DUPLICATE KEY UPDATE\n          node_id = VALUES(node_id),\n          node_order = VALUES(node_order),\n          description = VALUES(description),\n          updated_at = CURRENT_TIMESTAMP\n      `, [workflowType, nodeType, nodeKey, nodeId, order, desc]);\n    }\n    console.log(`  âœ… æ’å…¥ ${nodeConfigs.length} ä¸ªèŠ‚ç‚¹é…ç½®`);\n\n    // 5. éªŒè¯åˆ›å»ºç»“æœ\n    console.log('\\nğŸ“Š éªŒè¯åˆ›å»ºç»“æœ...');\n\n    const [workflowInfoResult] = await connection.execute('SELECT * FROM workflow_info ORDER BY workflow_type');\n    console.log('å·¥ä½œæµä¿¡æ¯:');\n    workflowInfoResult.forEach(info => {\n      console.log(`  - ${info.workflow_type}: ${info.workflow_name} (${info.is_enabled ? 'å¯ç”¨' : 'ç¦ç”¨'})`);\n    });\n\n    const [nodeConfigResult] = await connection.execute(`\n      SELECT workflow_type, node_type, COUNT(*) as count\n      FROM workflow_configs\n      GROUP BY workflow_type, node_type\n      ORDER BY workflow_type, node_type\n    `);\n    console.log('èŠ‚ç‚¹é…ç½®ç»Ÿè®¡:');\n    nodeConfigResult.forEach(stat => {\n      console.log(`  - ${stat.workflow_type} ${stat.node_type}: ${stat.count} ä¸ªèŠ‚ç‚¹`);\n    });\n\n    // 6. æ£€æŸ¥è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ\n    const [tables] = await connection.execute(\"SHOW TABLES LIKE 'workflow%'\");\n    console.log('\\nğŸ“‹ å·¥ä½œæµç›¸å…³è¡¨:');\n    tables.forEach(table => {\n      const tableName = Object.values(table)[0];\n      console.log(`  âœ… ${tableName}`);\n    });\n\n    console.log('\\nğŸ‰ å·¥ä½œæµè¡¨åˆ›å»ºå®Œæˆï¼');\n    return true;\n\n  } catch (error) {\n    console.error('âŒ åˆ›å»ºå·¥ä½œæµè¡¨å¤±è´¥:', error.message);\n    console.error('è¯¦ç»†é”™è¯¯:', error);\n    return false;\n  } finally {\n    if (connection) {\n      await connection.end();\n    }\n  }\n}\n\ncreateWorkflowTables().then(success => {\n  if (success) {\n    console.log('\\nâœ… å·¥ä½œæµè¡¨åˆ›å»ºæˆåŠŸï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨é…ç½®åŠŸèƒ½');\n  } else {\n    console.log('\\nâŒ å·¥ä½œæµè¡¨åˆ›å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯');\n  }\n  process.exit(success ? 0 : 1);\n}).catch(error => {\n  console.error('âŒ åˆ›å»ºè¿‡ç¨‹å¤±è´¥:', error);\n  process.exit(1);\n});\n"
        }
    ]
}