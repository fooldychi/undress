{
    "sourceFile": "server/src/app.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 7,
            "patches": [
                {
                    "date": 1752317973745,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752323494398,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,8 +15,9 @@\n const imageRoutes = require('./routes/images');\n const seckillRoutes = require('./routes/seckill');\n const levelCardsRoutes = require('./routes/levelCards');\n const adminAuthRoutes = require('./routes/adminAuth');\n+const adminRoutes = require('./routes/admin');\n \n const app = express();\n const PORT = process.env.PORT || 3001;\n \n"
                },
                {
                    "date": 1752323518402,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -101,9 +101,9 @@\n app.use('/api/level-cards', require('./routes/levelCards'));\n app.use('/api/admin-auth', adminAuthRoutes);\n // æ³¨æ„ï¼šæ›´å…·ä½“çš„è·¯ç”±è¦æ”¾åœ¨å‰é¢\n app.use('/api/admin/config', require('./routes/config'));\n-app.use('/api/admin', require('./routes/admin'));\n+app.use('/api/admin', adminRoutes);\n app.use('/api/config', require('./routes/public-config'));\n \n // 404å¤„ç†\n app.use('*', (req, res) => {\n"
                },
                {
                    "date": 1752331635269,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -103,8 +103,9 @@\n // æ³¨æ„ï¼šæ›´å…·ä½“çš„è·¯ç”±è¦æ”¾åœ¨å‰é¢\n app.use('/api/admin/config', require('./routes/config'));\n app.use('/api/admin', adminRoutes);\n app.use('/api/config', require('./routes/public-config'));\n+app.use('/api/comfyui', require('./routes/comfyui-status'));\n \n // 404å¤„ç†\n app.use('*', (req, res) => {\n   res.status(404).json({\n"
                },
                {
                    "date": 1752331656451,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -126,11 +126,23 @@\n     if (!dbConnected) {\n       console.warn('âš ï¸ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œä½†æœåŠ¡å™¨å°†ç»§ç»­å¯åŠ¨ï¼ˆä»…ç”¨äºç®¡ç†ç•Œé¢ï¼‰');\n     }\n \n+    // åˆå§‹åŒ–ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨\n+    if (dbConnected) {\n+      try {\n+        console.log('ğŸ”§ åˆå§‹åŒ–ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨...');\n+        const { initializeServerManager } = require('./utils/comfyUIRequest');\n+        await initializeServerManager();\n+        console.log('âœ… ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');\n+      } catch (error) {\n+        console.warn('âš ï¸ ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error.message);\n+      }\n+    }\n+\n     // å¯åŠ¨HTTPæœåŠ¡å™¨\n     app.listen(PORT, () => {\n-      console.log('ğŸš€ ImagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n+      console.log('ğŸš€ AI MagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n       console.log(`ğŸ“ æœåŠ¡åœ°å€: http://localhost:${PORT}`);\n       console.log(`ğŸŒ ç¯å¢ƒ: ${process.env.NODE_ENV}`);\n       console.log(`â° å¯åŠ¨æ—¶é—´: ${new Date().toLocaleString()}`);\n       if (!dbConnected) {\n"
                },
                {
                    "date": 1752332664959,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -103,9 +103,8 @@\n // æ³¨æ„ï¼šæ›´å…·ä½“çš„è·¯ç”±è¦æ”¾åœ¨å‰é¢\n app.use('/api/admin/config', require('./routes/config'));\n app.use('/api/admin', adminRoutes);\n app.use('/api/config', require('./routes/public-config'));\n-app.use('/api/comfyui', require('./routes/comfyui-status'));\n \n // 404å¤„ç†\n app.use('*', (req, res) => {\n   res.status(404).json({\n@@ -126,23 +125,11 @@\n     if (!dbConnected) {\n       console.warn('âš ï¸ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œä½†æœåŠ¡å™¨å°†ç»§ç»­å¯åŠ¨ï¼ˆä»…ç”¨äºç®¡ç†ç•Œé¢ï¼‰');\n     }\n \n-    // åˆå§‹åŒ–ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨\n-    if (dbConnected) {\n-      try {\n-        console.log('ğŸ”§ åˆå§‹åŒ–ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨...');\n-        const { initializeServerManager } = require('./utils/comfyUIRequest');\n-        await initializeServerManager();\n-        console.log('âœ… ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');\n-      } catch (error) {\n-        console.warn('âš ï¸ ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error.message);\n-      }\n-    }\n-\n     // å¯åŠ¨HTTPæœåŠ¡å™¨\n     app.listen(PORT, () => {\n-      console.log('ğŸš€ AI MagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n+      console.log('ğŸš€ ImagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n       console.log(`ğŸ“ æœåŠ¡åœ°å€: http://localhost:${PORT}`);\n       console.log(`ğŸŒ ç¯å¢ƒ: ${process.env.NODE_ENV}`);\n       console.log(`â° å¯åŠ¨æ—¶é—´: ${new Date().toLocaleString()}`);\n       if (!dbConnected) {\n"
                },
                {
                    "date": 1752332713899,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -103,8 +103,9 @@\n // æ³¨æ„ï¼šæ›´å…·ä½“çš„è·¯ç”±è¦æ”¾åœ¨å‰é¢\n app.use('/api/admin/config', require('./routes/config'));\n app.use('/api/admin', adminRoutes);\n app.use('/api/config', require('./routes/public-config'));\n+app.use('/api/comfyui', require('./routes/comfyui-status'));\n \n // 404å¤„ç†\n app.use('*', (req, res) => {\n   res.status(404).json({\n@@ -125,11 +126,23 @@\n     if (!dbConnected) {\n       console.warn('âš ï¸ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œä½†æœåŠ¡å™¨å°†ç»§ç»­å¯åŠ¨ï¼ˆä»…ç”¨äºç®¡ç†ç•Œé¢ï¼‰');\n     }\n \n+    // åˆå§‹åŒ–ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨\n+    if (dbConnected) {\n+      try {\n+        console.log('ğŸ”§ åˆå§‹åŒ–ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨...');\n+        const { initializeServerManager } = require('./utils/comfyUIRequest');\n+        await initializeServerManager();\n+        console.log('âœ… ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');\n+      } catch (error) {\n+        console.warn('âš ï¸ ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error.message);\n+      }\n+    }\n+\n     // å¯åŠ¨HTTPæœåŠ¡å™¨\n     app.listen(PORT, () => {\n-      console.log('ğŸš€ ImagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n+      console.log('ğŸš€ AI MagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n       console.log(`ğŸ“ æœåŠ¡åœ°å€: http://localhost:${PORT}`);\n       console.log(`ğŸŒ ç¯å¢ƒ: ${process.env.NODE_ENV}`);\n       console.log(`â° å¯åŠ¨æ—¶é—´: ${new Date().toLocaleString()}`);\n       if (!dbConnected) {\n"
                },
                {
                    "date": 1752332764848,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -103,9 +103,8 @@\n // æ³¨æ„ï¼šæ›´å…·ä½“çš„è·¯ç”±è¦æ”¾åœ¨å‰é¢\n app.use('/api/admin/config', require('./routes/config'));\n app.use('/api/admin', adminRoutes);\n app.use('/api/config', require('./routes/public-config'));\n-app.use('/api/comfyui', require('./routes/comfyui-status'));\n \n // 404å¤„ç†\n app.use('*', (req, res) => {\n   res.status(404).json({\n@@ -126,23 +125,11 @@\n     if (!dbConnected) {\n       console.warn('âš ï¸ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œä½†æœåŠ¡å™¨å°†ç»§ç»­å¯åŠ¨ï¼ˆä»…ç”¨äºç®¡ç†ç•Œé¢ï¼‰');\n     }\n \n-    // åˆå§‹åŒ–ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨\n-    if (dbConnected) {\n-      try {\n-        console.log('ğŸ”§ åˆå§‹åŒ–ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨...');\n-        const { initializeServerManager } = require('./utils/comfyUIRequest');\n-        await initializeServerManager();\n-        console.log('âœ… ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');\n-      } catch (error) {\n-        console.warn('âš ï¸ ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error.message);\n-      }\n-    }\n-\n     // å¯åŠ¨HTTPæœåŠ¡å™¨\n     app.listen(PORT, () => {\n-      console.log('ğŸš€ AI MagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n+      console.log('ğŸš€ ImagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n       console.log(`ğŸ“ æœåŠ¡åœ°å€: http://localhost:${PORT}`);\n       console.log(`ğŸŒ ç¯å¢ƒ: ${process.env.NODE_ENV}`);\n       console.log(`â° å¯åŠ¨æ—¶é—´: ${new Date().toLocaleString()}`);\n       if (!dbConnected) {\n"
                }
            ],
            "date": 1752317973745,
            "name": "Commit-0",
            "content": "const express = require('express');\nconst cors = require('cors');\nconst helmet = require('helmet');\nconst morgan = require('morgan');\nconst compression = require('compression');\nrequire('dotenv').config();\n\nconst { testConnection } = require('./config/database');\nconst errorHandler = require('./middleware/errorHandler');\nconst rateLimiter = require('./middleware/rateLimiter');\n\n// å¯¼å…¥è·¯ç”±\nconst authRoutes = require('./routes/auth');\nconst userRoutes = require('./routes/users');\nconst imageRoutes = require('./routes/images');\nconst seckillRoutes = require('./routes/seckill');\nconst levelCardsRoutes = require('./routes/levelCards');\nconst adminAuthRoutes = require('./routes/adminAuth');\n\nconst app = express();\nconst PORT = process.env.PORT || 3001;\n\n// ä¸­é—´ä»¶é…ç½®\napp.use(helmet()); // å®‰å…¨å¤´\napp.use(compression()); // å‹ç¼©å“åº”\napp.use(morgan('combined')); // æ—¥å¿—è®°å½•\n\n// CORSé…ç½® - æ”¯æŒåŠ¨æ€ç«¯å£\napp.use(cors({\n  origin: function (origin, callback) {\n    // å…è®¸çš„åŸŸååˆ—è¡¨\n    const allowedOrigins = [\n      'http://localhost:3000',\n      'http://localhost:3001',\n      'http://localhost:3002',  // åå°ç®¡ç†ç³»ç»Ÿç«¯å£\n      'http://localhost:3007',  // Vue ç®¡ç†åå°ç«¯å£\n      'http://localhost:5173',  // Vite é»˜è®¤ç«¯å£\n      'http://localhost:5174',  // Vite å¤‡ç”¨ç«¯å£\n      'http://127.0.0.1:3000',\n      'http://127.0.0.1:3001',\n      'http://127.0.0.1:3002',  // åå°ç®¡ç†ç³»ç»Ÿç«¯å£\n      'http://127.0.0.1:3007',  // Vue ç®¡ç†åå°ç«¯å£\n      'http://127.0.0.1:5173',\n      'http://127.0.0.1:5174'\n    ];\n\n    // å¦‚æœè®¾ç½®äº†ç¯å¢ƒå˜é‡ï¼Œä¼˜å…ˆä½¿ç”¨\n    if (process.env.CORS_ORIGIN) {\n      allowedOrigins.push(process.env.CORS_ORIGIN);\n    }\n\n    // å…è®¸æ²¡æœ‰originçš„è¯·æ±‚ï¼ˆå¦‚ç§»åŠ¨åº”ç”¨ã€Postmanç­‰ï¼‰\n    // ä»¥åŠoriginä¸ºnullçš„è¯·æ±‚ï¼ˆå¦‚ç›´æ¥æ‰“å¼€HTMLæ–‡ä»¶ï¼‰\n    if (!origin || origin === 'null') return callback(null, true);\n\n    // å…è®¸file://åè®®çš„è¯·æ±‚ï¼ˆç”¨äºç›´æ¥æ‰“å¼€HTMLæ–‡ä»¶ï¼‰\n    if (origin && origin.startsWith('file://')) {\n      return callback(null, true);\n    }\n\n    // æ£€æŸ¥originæ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­\n    if (allowedOrigins.indexOf(origin) !== -1) {\n      callback(null, true);\n    } else {\n      console.log(`âŒ CORS blocked origin: ${origin}`);\n      console.log(`âœ… Allowed origins: ${allowedOrigins.join(', ')}, file://`);\n      callback(new Error('Not allowed by CORS'));\n    }\n  },\n  credentials: true,\n  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],\n  allowedHeaders: ['Content-Type', 'Authorization']\n}));\n\n// è¯·æ±‚è§£æ\napp.use(express.json({ limit: '10mb' }));\napp.use(express.urlencoded({ extended: true, limit: '10mb' }));\n\n// é™æ€æ–‡ä»¶æœåŠ¡\napp.use('/uploads', express.static('uploads'));\n\n// é€Ÿç‡é™åˆ¶\napp.use(rateLimiter);\n\n// å¥åº·æ£€æŸ¥ç«¯ç‚¹\napp.get('/health', (req, res) => {\n  res.json({\n    status: 'OK',\n    timestamp: new Date().toISOString(),\n    uptime: process.uptime(),\n    environment: process.env.NODE_ENV\n  });\n});\n\n// APIè·¯ç”±\napp.use('/api/auth', authRoutes);\napp.use('/api/users', userRoutes);\napp.use('/api/images', imageRoutes);\napp.use('/api/points', require('./routes/points'));\napp.use('/api/level-cards', require('./routes/levelCards'));\napp.use('/api/admin-auth', adminAuthRoutes);\n// æ³¨æ„ï¼šæ›´å…·ä½“çš„è·¯ç”±è¦æ”¾åœ¨å‰é¢\napp.use('/api/admin/config', require('./routes/config'));\napp.use('/api/admin', require('./routes/admin'));\napp.use('/api/config', require('./routes/public-config'));\n\n// 404å¤„ç†\napp.use('*', (req, res) => {\n  res.status(404).json({\n    success: false,\n    message: 'æ¥å£ä¸å­˜åœ¨',\n    path: req.originalUrl\n  });\n});\n\n// é”™è¯¯å¤„ç†ä¸­é—´ä»¶\napp.use(errorHandler);\n\n// å¯åŠ¨æœåŠ¡å™¨\nasync function startServer() {\n  try {\n    // æµ‹è¯•æ•°æ®åº“è¿æ¥\n    const dbConnected = await testConnection();\n    if (!dbConnected) {\n      console.warn('âš ï¸ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œä½†æœåŠ¡å™¨å°†ç»§ç»­å¯åŠ¨ï¼ˆä»…ç”¨äºç®¡ç†ç•Œé¢ï¼‰');\n    }\n\n    // å¯åŠ¨HTTPæœåŠ¡å™¨\n    app.listen(PORT, () => {\n      console.log('ğŸš€ ImagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n      console.log(`ğŸ“ æœåŠ¡åœ°å€: http://localhost:${PORT}`);\n      console.log(`ğŸŒ ç¯å¢ƒ: ${process.env.NODE_ENV}`);\n      console.log(`â° å¯åŠ¨æ—¶é—´: ${new Date().toLocaleString()}`);\n      if (!dbConnected) {\n        console.log('âš ï¸ æ³¨æ„ï¼šæ•°æ®åº“æœªè¿æ¥ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨');\n      }\n    });\n  } catch (error) {\n    console.error('âŒ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:', error);\n    process.exit(1);\n  }\n}\n\n// ä¼˜é›…å…³é—­\nprocess.on('SIGTERM', () => {\n  console.log('ğŸ›‘ æ”¶åˆ°SIGTERMä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...');\n  process.exit(0);\n});\n\nprocess.on('SIGINT', () => {\n  console.log('ğŸ›‘ æ”¶åˆ°SIGINTä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...');\n  process.exit(0);\n});\n\nstartServer();\n\nmodule.exports = app;\n"
        }
    ]
}