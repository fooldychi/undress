{
    "sourceFile": "server/src/app.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 22,
            "patches": [
                {
                    "date": 1752317973745,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752323494398,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,8 +15,9 @@\n const imageRoutes = require('./routes/images');\n const seckillRoutes = require('./routes/seckill');\n const levelCardsRoutes = require('./routes/levelCards');\n const adminAuthRoutes = require('./routes/adminAuth');\n+const adminRoutes = require('./routes/admin');\n \n const app = express();\n const PORT = process.env.PORT || 3001;\n \n"
                },
                {
                    "date": 1752323518402,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -101,9 +101,9 @@\n app.use('/api/level-cards', require('./routes/levelCards'));\n app.use('/api/admin-auth', adminAuthRoutes);\n // æ³¨æ„ï¼šæ›´å…·ä½“çš„è·¯ç”±è¦æ”¾åœ¨å‰é¢\n app.use('/api/admin/config', require('./routes/config'));\n-app.use('/api/admin', require('./routes/admin'));\n+app.use('/api/admin', adminRoutes);\n app.use('/api/config', require('./routes/public-config'));\n \n // 404å¤„ç†\n app.use('*', (req, res) => {\n"
                },
                {
                    "date": 1752331635269,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -103,8 +103,9 @@\n // æ³¨æ„ï¼šæ›´å…·ä½“çš„è·¯ç”±è¦æ”¾åœ¨å‰é¢\n app.use('/api/admin/config', require('./routes/config'));\n app.use('/api/admin', adminRoutes);\n app.use('/api/config', require('./routes/public-config'));\n+app.use('/api/comfyui', require('./routes/comfyui-status'));\n \n // 404å¤„ç†\n app.use('*', (req, res) => {\n   res.status(404).json({\n"
                },
                {
                    "date": 1752331656451,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -126,11 +126,23 @@\n     if (!dbConnected) {\n       console.warn('âš ï¸ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œä½†æœåŠ¡å™¨å°†ç»§ç»­å¯åŠ¨ï¼ˆä»…ç”¨äºç®¡ç†ç•Œé¢ï¼‰');\n     }\n \n+    // åˆå§‹åŒ–ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨\n+    if (dbConnected) {\n+      try {\n+        console.log('ğŸ”§ åˆå§‹åŒ–ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨...');\n+        const { initializeServerManager } = require('./utils/comfyUIRequest');\n+        await initializeServerManager();\n+        console.log('âœ… ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');\n+      } catch (error) {\n+        console.warn('âš ï¸ ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error.message);\n+      }\n+    }\n+\n     // å¯åŠ¨HTTPæœåŠ¡å™¨\n     app.listen(PORT, () => {\n-      console.log('ğŸš€ ImagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n+      console.log('ğŸš€ AI MagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n       console.log(`ğŸ“ æœåŠ¡åœ°å€: http://localhost:${PORT}`);\n       console.log(`ğŸŒ ç¯å¢ƒ: ${process.env.NODE_ENV}`);\n       console.log(`â° å¯åŠ¨æ—¶é—´: ${new Date().toLocaleString()}`);\n       if (!dbConnected) {\n"
                },
                {
                    "date": 1752332664959,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -103,9 +103,8 @@\n // æ³¨æ„ï¼šæ›´å…·ä½“çš„è·¯ç”±è¦æ”¾åœ¨å‰é¢\n app.use('/api/admin/config', require('./routes/config'));\n app.use('/api/admin', adminRoutes);\n app.use('/api/config', require('./routes/public-config'));\n-app.use('/api/comfyui', require('./routes/comfyui-status'));\n \n // 404å¤„ç†\n app.use('*', (req, res) => {\n   res.status(404).json({\n@@ -126,23 +125,11 @@\n     if (!dbConnected) {\n       console.warn('âš ï¸ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œä½†æœåŠ¡å™¨å°†ç»§ç»­å¯åŠ¨ï¼ˆä»…ç”¨äºç®¡ç†ç•Œé¢ï¼‰');\n     }\n \n-    // åˆå§‹åŒ–ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨\n-    if (dbConnected) {\n-      try {\n-        console.log('ğŸ”§ åˆå§‹åŒ–ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨...');\n-        const { initializeServerManager } = require('./utils/comfyUIRequest');\n-        await initializeServerManager();\n-        console.log('âœ… ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');\n-      } catch (error) {\n-        console.warn('âš ï¸ ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error.message);\n-      }\n-    }\n-\n     // å¯åŠ¨HTTPæœåŠ¡å™¨\n     app.listen(PORT, () => {\n-      console.log('ğŸš€ AI MagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n+      console.log('ğŸš€ ImagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n       console.log(`ğŸ“ æœåŠ¡åœ°å€: http://localhost:${PORT}`);\n       console.log(`ğŸŒ ç¯å¢ƒ: ${process.env.NODE_ENV}`);\n       console.log(`â° å¯åŠ¨æ—¶é—´: ${new Date().toLocaleString()}`);\n       if (!dbConnected) {\n"
                },
                {
                    "date": 1752332713899,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -103,8 +103,9 @@\n // æ³¨æ„ï¼šæ›´å…·ä½“çš„è·¯ç”±è¦æ”¾åœ¨å‰é¢\n app.use('/api/admin/config', require('./routes/config'));\n app.use('/api/admin', adminRoutes);\n app.use('/api/config', require('./routes/public-config'));\n+app.use('/api/comfyui', require('./routes/comfyui-status'));\n \n // 404å¤„ç†\n app.use('*', (req, res) => {\n   res.status(404).json({\n@@ -125,11 +126,23 @@\n     if (!dbConnected) {\n       console.warn('âš ï¸ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œä½†æœåŠ¡å™¨å°†ç»§ç»­å¯åŠ¨ï¼ˆä»…ç”¨äºç®¡ç†ç•Œé¢ï¼‰');\n     }\n \n+    // åˆå§‹åŒ–ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨\n+    if (dbConnected) {\n+      try {\n+        console.log('ğŸ”§ åˆå§‹åŒ–ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨...');\n+        const { initializeServerManager } = require('./utils/comfyUIRequest');\n+        await initializeServerManager();\n+        console.log('âœ… ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');\n+      } catch (error) {\n+        console.warn('âš ï¸ ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error.message);\n+      }\n+    }\n+\n     // å¯åŠ¨HTTPæœåŠ¡å™¨\n     app.listen(PORT, () => {\n-      console.log('ğŸš€ ImagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n+      console.log('ğŸš€ AI MagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n       console.log(`ğŸ“ æœåŠ¡åœ°å€: http://localhost:${PORT}`);\n       console.log(`ğŸŒ ç¯å¢ƒ: ${process.env.NODE_ENV}`);\n       console.log(`â° å¯åŠ¨æ—¶é—´: ${new Date().toLocaleString()}`);\n       if (!dbConnected) {\n"
                },
                {
                    "date": 1752332764848,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -103,9 +103,8 @@\n // æ³¨æ„ï¼šæ›´å…·ä½“çš„è·¯ç”±è¦æ”¾åœ¨å‰é¢\n app.use('/api/admin/config', require('./routes/config'));\n app.use('/api/admin', adminRoutes);\n app.use('/api/config', require('./routes/public-config'));\n-app.use('/api/comfyui', require('./routes/comfyui-status'));\n \n // 404å¤„ç†\n app.use('*', (req, res) => {\n   res.status(404).json({\n@@ -126,23 +125,11 @@\n     if (!dbConnected) {\n       console.warn('âš ï¸ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œä½†æœåŠ¡å™¨å°†ç»§ç»­å¯åŠ¨ï¼ˆä»…ç”¨äºç®¡ç†ç•Œé¢ï¼‰');\n     }\n \n-    // åˆå§‹åŒ–ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨\n-    if (dbConnected) {\n-      try {\n-        console.log('ğŸ”§ åˆå§‹åŒ–ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨...');\n-        const { initializeServerManager } = require('./utils/comfyUIRequest');\n-        await initializeServerManager();\n-        console.log('âœ… ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');\n-      } catch (error) {\n-        console.warn('âš ï¸ ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error.message);\n-      }\n-    }\n-\n     // å¯åŠ¨HTTPæœåŠ¡å™¨\n     app.listen(PORT, () => {\n-      console.log('ğŸš€ AI MagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n+      console.log('ğŸš€ ImagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n       console.log(`ğŸ“ æœåŠ¡åœ°å€: http://localhost:${PORT}`);\n       console.log(`ğŸŒ ç¯å¢ƒ: ${process.env.NODE_ENV}`);\n       console.log(`â° å¯åŠ¨æ—¶é—´: ${new Date().toLocaleString()}`);\n       if (!dbConnected) {\n"
                },
                {
                    "date": 1752377139860,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -141,18 +141,94 @@\n     process.exit(1);\n   }\n }\n \n-// ä¼˜é›…å…³é—­\n-process.on('SIGTERM', () => {\n-  console.log('ğŸ›‘ æ”¶åˆ°SIGTERMä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...');\n-  process.exit(0);\n+// å…¨å±€å¼‚å¸¸å¤„ç†\n+process.on('uncaughtException', (error) => {\n+  console.error('âŒ æœªæ•è·çš„å¼‚å¸¸:', error);\n+  console.error('å †æ ˆä¿¡æ¯:', error.stack);\n+\n+  // è®°å½•é”™è¯¯åˆ°æ—¥å¿—æ–‡ä»¶\n+  const fs = require('fs');\n+  const logEntry = `[${new Date().toISOString()}] UNCAUGHT EXCEPTION: ${error.message}\\n${error.stack}\\n\\n`;\n+  fs.appendFileSync('logs/error.log', logEntry, { flag: 'a' });\n+\n+  // ä¼˜é›…å…³é—­æœåŠ¡å™¨\n+  gracefulShutdown('uncaughtException');\n });\n \n-process.on('SIGINT', () => {\n-  console.log('ğŸ›‘ æ”¶åˆ°SIGINTä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...');\n-  process.exit(0);\n+process.on('unhandledRejection', (reason, promise) => {\n+  console.error('âŒ æœªå¤„ç†çš„Promiseæ‹’ç»:', reason);\n+  console.error('Promise:', promise);\n+\n+  // è®°å½•é”™è¯¯åˆ°æ—¥å¿—æ–‡ä»¶\n+  const fs = require('fs');\n+  const logEntry = `[${new Date().toISOString()}] UNHANDLED REJECTION: ${reason}\\nPromise: ${promise}\\n\\n`;\n+  fs.appendFileSync('logs/error.log', logEntry, { flag: 'a' });\n+\n+  // å¯¹äºPromiseæ‹’ç»ï¼Œä¸ç«‹å³é€€å‡ºï¼Œä½†è®°å½•é”™è¯¯\n+  console.warn('âš ï¸ æœåŠ¡å™¨ç»§ç»­è¿è¡Œï¼Œä½†å»ºè®®æ£€æŸ¥ä¸Šè¿°é”™è¯¯');\n });\n \n+// å†…å­˜ä½¿ç”¨ç›‘æ§\n+const monitorMemoryUsage = () => {\n+  const usage = process.memoryUsage();\n+  const formatBytes = (bytes) => (bytes / 1024 / 1024).toFixed(2) + ' MB';\n+\n+  console.log('ğŸ“Š å†…å­˜ä½¿ç”¨æƒ…å†µ:');\n+  console.log(`   RSS: ${formatBytes(usage.rss)}`);\n+  console.log(`   Heap Used: ${formatBytes(usage.heapUsed)}`);\n+  console.log(`   Heap Total: ${formatBytes(usage.heapTotal)}`);\n+  console.log(`   External: ${formatBytes(usage.external)}`);\n+\n+  // å†…å­˜ä½¿ç”¨è¶…è¿‡500MBæ—¶å‘å‡ºè­¦å‘Š\n+  if (usage.heapUsed > 500 * 1024 * 1024) {\n+    console.warn('âš ï¸ å†…å­˜ä½¿ç”¨è¿‡é«˜ï¼Œå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼');\n+  }\n+};\n+\n+// æ¯5åˆ†é’Ÿç›‘æ§ä¸€æ¬¡å†…å­˜ä½¿ç”¨\n+const memoryMonitorInterval = setInterval(monitorMemoryUsage, 5 * 60 * 1000);\n+\n+// ä¼˜é›…å…³é—­å‡½æ•°\n+const gracefulShutdown = (signal) => {\n+  console.log(`ğŸ›‘ æ”¶åˆ°${signal}ä¿¡å·ï¼Œæ­£åœ¨ä¼˜é›…å…³é—­æœåŠ¡å™¨...`);\n+\n+  // æ¸…ç†å®šæ—¶å™¨\n+  if (memoryMonitorInterval) {\n+    clearInterval(memoryMonitorInterval);\n+  }\n+\n+  // å…³é—­æ•°æ®åº“è¿æ¥æ± \n+  const { pool } = require('./config/database');\n+  if (pool) {\n+    pool.end(() => {\n+      console.log('ğŸ”Œ æ•°æ®åº“è¿æ¥æ± å·²å…³é—­');\n+    });\n+  }\n+\n+  // è®¾ç½®è¶…æ—¶å¼ºåˆ¶é€€å‡º\n+  const forceExitTimer = setTimeout(() => {\n+    console.log('âš ï¸ å¼ºåˆ¶é€€å‡ºæœåŠ¡å™¨');\n+    process.exit(1);\n+  }, 10000); // 10ç§’åå¼ºåˆ¶é€€å‡º\n+\n+  // ä¼˜é›…å…³é—­HTTPæœåŠ¡å™¨\n+  if (global.httpServer) {\n+    global.httpServer.close(() => {\n+      console.log('âœ… HTTPæœåŠ¡å™¨å·²å…³é—­');\n+      clearTimeout(forceExitTimer);\n+      process.exit(0);\n+    });\n+  } else {\n+    clearTimeout(forceExitTimer);\n+    process.exit(0);\n+  }\n+};\n+\n+// ä¿¡å·å¤„ç†\n+process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));\n+process.on('SIGINT', () => gracefulShutdown('SIGINT'));\n+\n startServer();\n \n module.exports = app;\n"
                },
                {
                    "date": 1752377157133,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -126,16 +126,21 @@\n       console.warn('âš ï¸ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œä½†æœåŠ¡å™¨å°†ç»§ç»­å¯åŠ¨ï¼ˆä»…ç”¨äºç®¡ç†ç•Œé¢ï¼‰');\n     }\n \n     // å¯åŠ¨HTTPæœåŠ¡å™¨\n-    app.listen(PORT, () => {\n+    global.httpServer = app.listen(PORT, () => {\n       console.log('ğŸš€ ImagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n       console.log(`ğŸ“ æœåŠ¡åœ°å€: http://localhost:${PORT}`);\n       console.log(`ğŸŒ ç¯å¢ƒ: ${process.env.NODE_ENV}`);\n       console.log(`â° å¯åŠ¨æ—¶é—´: ${new Date().toLocaleString()}`);\n+      console.log(`ğŸ†” è¿›ç¨‹ID: ${process.pid}`);\n       if (!dbConnected) {\n         console.log('âš ï¸ æ³¨æ„ï¼šæ•°æ®åº“æœªè¿æ¥ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨');\n       }\n+\n+      // å¯åŠ¨å†…å­˜ç›‘æ§\n+      console.log('ğŸ“Š å†…å­˜ç›‘æ§å·²å¯åŠ¨ï¼Œæ¯5åˆ†é’ŸæŠ¥å‘Šä¸€æ¬¡');\n+      monitorMemoryUsage(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡\n     });\n   } catch (error) {\n     console.error('âŒ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:', error);\n     process.exit(1);\n"
                },
                {
                    "date": 1752377231117,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -203,14 +203,10 @@\n     clearInterval(memoryMonitorInterval);\n   }\n \n   // å…³é—­æ•°æ®åº“è¿æ¥æ± \n-  const { pool } = require('./config/database');\n-  if (pool) {\n-    pool.end(() => {\n-      console.log('ğŸ”Œ æ•°æ®åº“è¿æ¥æ± å·²å…³é—­');\n-    });\n-  }\n+  const { closePool } = require('./config/database');\n+  await closePool();\n \n   // è®¾ç½®è¶…æ—¶å¼ºåˆ¶é€€å‡º\n   const forceExitTimer = setTimeout(() => {\n     console.log('âš ï¸ å¼ºåˆ¶é€€å‡ºæœåŠ¡å™¨');\n"
                },
                {
                    "date": 1752377277207,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,8 +6,9 @@\n require('dotenv').config();\n \n const { testConnection } = require('./config/database');\n const errorHandler = require('./middleware/errorHandler');\n+const { healthMonitor } = require('./utils/healthMonitor');\n const rateLimiter = require('./middleware/rateLimiter');\n \n // å¯¼å…¥è·¯ç”±\n const authRoutes = require('./routes/auth');\n"
                },
                {
                    "date": 1752377290762,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -84,15 +84,29 @@\n // é€Ÿç‡é™åˆ¶\n app.use(rateLimiter);\n \n // å¥åº·æ£€æŸ¥ç«¯ç‚¹\n-app.get('/health', (req, res) => {\n-  res.json({\n-    status: 'OK',\n-    timestamp: new Date().toISOString(),\n-    uptime: process.uptime(),\n-    environment: process.env.NODE_ENV\n-  });\n+app.get('/health', async (req, res) => {\n+  try {\n+    const healthReport = healthMonitor.getHealthReport();\n+    const detailedCheck = await healthMonitor.forceHealthCheck();\n+\n+    res.json({\n+      status: healthReport.current.healthy ? 'OK' : 'UNHEALTHY',\n+      timestamp: new Date().toISOString(),\n+      uptime: process.uptime(),\n+      environment: process.env.NODE_ENV,\n+      pid: process.pid,\n+      health: healthReport,\n+      detailed: detailedCheck\n+    });\n+  } catch (error) {\n+    res.status(500).json({\n+      status: 'ERROR',\n+      timestamp: new Date().toISOString(),\n+      error: error.message\n+    });\n+  }\n });\n \n // APIè·¯ç”±\n app.use('/api/auth', authRoutes);\n"
                },
                {
                    "date": 1752377304564,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -154,8 +154,11 @@\n \n       // å¯åŠ¨å†…å­˜ç›‘æ§\n       console.log('ğŸ“Š å†…å­˜ç›‘æ§å·²å¯åŠ¨ï¼Œæ¯5åˆ†é’ŸæŠ¥å‘Šä¸€æ¬¡');\n       monitorMemoryUsage(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡\n+\n+      // å¯åŠ¨å¥åº·ç›‘æ§\n+      healthMonitor.start();\n     });\n   } catch (error) {\n     console.error('âŒ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:', error);\n     process.exit(1);\n"
                },
                {
                    "date": 1752377316602,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -215,13 +215,16 @@\n // ä¼˜é›…å…³é—­å‡½æ•°\n const gracefulShutdown = (signal) => {\n   console.log(`ğŸ›‘ æ”¶åˆ°${signal}ä¿¡å·ï¼Œæ­£åœ¨ä¼˜é›…å…³é—­æœåŠ¡å™¨...`);\n \n-  // æ¸…ç†å®šæ—¶å™¨\n+  // æ¸…ç†å®šæ—¶å™¨å’Œç›‘æ§\n   if (memoryMonitorInterval) {\n     clearInterval(memoryMonitorInterval);\n   }\n \n+  // åœæ­¢å¥åº·ç›‘æ§\n+  healthMonitor.stop();\n+\n   // å…³é—­æ•°æ®åº“è¿æ¥æ± \n   const { closePool } = require('./config/database');\n   await closePool();\n \n"
                },
                {
                    "date": 1752377414196,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,8 +7,9 @@\n \n const { testConnection } = require('./config/database');\n const errorHandler = require('./middleware/errorHandler');\n const { healthMonitor } = require('./utils/healthMonitor');\n+const { memoryManager } = require('./utils/memoryManager');\n const rateLimiter = require('./middleware/rateLimiter');\n \n // å¯¼å…¥è·¯ç”±\n const authRoutes = require('./routes/auth');\n"
                },
                {
                    "date": 1752377428039,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -158,8 +158,11 @@\n       monitorMemoryUsage(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡\n \n       // å¯åŠ¨å¥åº·ç›‘æ§\n       healthMonitor.start();\n+\n+      // å¯åŠ¨å†…å­˜ç®¡ç†\n+      memoryManager.start();\n     });\n   } catch (error) {\n     console.error('âŒ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:', error);\n     process.exit(1);\n"
                },
                {
                    "date": 1752377439954,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -227,8 +227,11 @@\n \n   // åœæ­¢å¥åº·ç›‘æ§\n   healthMonitor.stop();\n \n+  // åœæ­¢å†…å­˜ç®¡ç†\n+  memoryManager.stop();\n+\n   // å…³é—­æ•°æ®åº“è¿æ¥æ± \n   const { closePool } = require('./config/database');\n   await closePool();\n \n"
                },
                {
                    "date": 1752378409791,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -216,9 +216,9 @@\n // æ¯5åˆ†é’Ÿç›‘æ§ä¸€æ¬¡å†…å­˜ä½¿ç”¨\n const memoryMonitorInterval = setInterval(monitorMemoryUsage, 5 * 60 * 1000);\n \n // ä¼˜é›…å…³é—­å‡½æ•°\n-const gracefulShutdown = (signal) => {\n+const gracefulShutdown = async (signal) => {\n   console.log(`ğŸ›‘ æ”¶åˆ°${signal}ä¿¡å·ï¼Œæ­£åœ¨ä¼˜é›…å…³é—­æœåŠ¡å™¨...`);\n \n   // æ¸…ç†å®šæ—¶å™¨å’Œç›‘æ§\n   if (memoryMonitorInterval) {\n@@ -231,10 +231,14 @@\n   // åœæ­¢å†…å­˜ç®¡ç†\n   memoryManager.stop();\n \n   // å…³é—­æ•°æ®åº“è¿æ¥æ± \n-  const { closePool } = require('./config/database');\n-  await closePool();\n+  try {\n+    const { closePool } = require('./config/database');\n+    await closePool();\n+  } catch (error) {\n+    console.error('âŒ å…³é—­æ•°æ®åº“è¿æ¥æ± å¤±è´¥:', error);\n+  }\n \n   // è®¾ç½®è¶…æ—¶å¼ºåˆ¶é€€å‡º\n   const forceExitTimer = setTimeout(() => {\n     console.log('âš ï¸ å¼ºåˆ¶é€€å‡ºæœåŠ¡å™¨');\n"
                },
                {
                    "date": 1752378425208,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -258,10 +258,21 @@\n   }\n };\n \n // ä¿¡å·å¤„ç†\n-process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));\n-process.on('SIGINT', () => gracefulShutdown('SIGINT'));\n+process.on('SIGTERM', () => {\n+  gracefulShutdown('SIGTERM').catch(error => {\n+    console.error('âŒ ä¼˜é›…å…³é—­å¤±è´¥:', error);\n+    process.exit(1);\n+  });\n+});\n \n+process.on('SIGINT', () => {\n+  gracefulShutdown('SIGINT').catch(error => {\n+    console.error('âŒ ä¼˜é›…å…³é—­å¤±è´¥:', error);\n+    process.exit(1);\n+  });\n+});\n+\n startServer();\n \n module.exports = app;\n"
                },
                {
                    "date": 1752378438738,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -179,9 +179,12 @@\n   const logEntry = `[${new Date().toISOString()}] UNCAUGHT EXCEPTION: ${error.message}\\n${error.stack}\\n\\n`;\n   fs.appendFileSync('logs/error.log', logEntry, { flag: 'a' });\n \n   // ä¼˜é›…å…³é—­æœåŠ¡å™¨\n-  gracefulShutdown('uncaughtException');\n+  gracefulShutdown('uncaughtException').catch(error => {\n+    console.error('âŒ ä¼˜é›…å…³é—­å¤±è´¥:', error);\n+    process.exit(1);\n+  });\n });\n \n process.on('unhandledRejection', (reason, promise) => {\n   console.error('âŒ æœªå¤„ç†çš„Promiseæ‹’ç»:', reason);\n"
                },
                {
                    "date": 1752407517875,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -20,9 +20,9 @@\n const adminAuthRoutes = require('./routes/adminAuth');\n const adminRoutes = require('./routes/admin');\n \n const app = express();\n-const PORT = process.env.PORT || 3001;\n+const PORT = process.env.PORT || 3007;\n \n // ä¸­é—´ä»¶é…ç½®\n app.use(helmet()); // å®‰å…¨å¤´\n app.use(compression()); // å‹ç¼©å“åº”\n"
                },
                {
                    "date": 1752408332328,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,20 +30,22 @@\n \n // CORSé…ç½® - æ”¯æŒåŠ¨æ€ç«¯å£\n app.use(cors({\n   origin: function (origin, callback) {\n-    // å…è®¸çš„åŸŸååˆ—è¡¨\n+    // ä»ç¯å¢ƒå˜é‡è·å–ç«¯å£é…ç½®\n+    const CLIENT_PORT = process.env.CLIENT_PORT || 3001;\n+    const ADMIN_PORT = process.env.ADMIN_PORT || 3003;\n+\n+    // å…è®¸çš„åŸŸååˆ—è¡¨ - ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®ç«¯å£\n     const allowedOrigins = [\n       'http://localhost:3000',\n-      'http://localhost:3001',\n-      'http://localhost:3002',  // åå°ç®¡ç†ç³»ç»Ÿç«¯å£\n-      'http://localhost:3007',  // Vue ç®¡ç†åå°ç«¯å£\n+      `http://localhost:${CLIENT_PORT}`,  // å®¢æˆ·ç«¯ç«¯å£\n+      `http://localhost:${ADMIN_PORT}`,   // åå°ç®¡ç†ç³»ç»Ÿç«¯å£\n       'http://localhost:5173',  // Vite é»˜è®¤ç«¯å£\n       'http://localhost:5174',  // Vite å¤‡ç”¨ç«¯å£\n       'http://127.0.0.1:3000',\n-      'http://127.0.0.1:3001',\n-      'http://127.0.0.1:3002',  // åå°ç®¡ç†ç³»ç»Ÿç«¯å£\n-      'http://127.0.0.1:3007',  // Vue ç®¡ç†åå°ç«¯å£\n+      `http://127.0.0.1:${CLIENT_PORT}`,  // å®¢æˆ·ç«¯ç«¯å£\n+      `http://127.0.0.1:${ADMIN_PORT}`,   // åå°ç®¡ç†ç³»ç»Ÿç«¯å£\n       'http://127.0.0.1:5173',\n       'http://127.0.0.1:5174'\n     ];\n \n"
                }
            ],
            "date": 1752317973745,
            "name": "Commit-0",
            "content": "const express = require('express');\nconst cors = require('cors');\nconst helmet = require('helmet');\nconst morgan = require('morgan');\nconst compression = require('compression');\nrequire('dotenv').config();\n\nconst { testConnection } = require('./config/database');\nconst errorHandler = require('./middleware/errorHandler');\nconst rateLimiter = require('./middleware/rateLimiter');\n\n// å¯¼å…¥è·¯ç”±\nconst authRoutes = require('./routes/auth');\nconst userRoutes = require('./routes/users');\nconst imageRoutes = require('./routes/images');\nconst seckillRoutes = require('./routes/seckill');\nconst levelCardsRoutes = require('./routes/levelCards');\nconst adminAuthRoutes = require('./routes/adminAuth');\n\nconst app = express();\nconst PORT = process.env.PORT || 3001;\n\n// ä¸­é—´ä»¶é…ç½®\napp.use(helmet()); // å®‰å…¨å¤´\napp.use(compression()); // å‹ç¼©å“åº”\napp.use(morgan('combined')); // æ—¥å¿—è®°å½•\n\n// CORSé…ç½® - æ”¯æŒåŠ¨æ€ç«¯å£\napp.use(cors({\n  origin: function (origin, callback) {\n    // å…è®¸çš„åŸŸååˆ—è¡¨\n    const allowedOrigins = [\n      'http://localhost:3000',\n      'http://localhost:3001',\n      'http://localhost:3002',  // åå°ç®¡ç†ç³»ç»Ÿç«¯å£\n      'http://localhost:3007',  // Vue ç®¡ç†åå°ç«¯å£\n      'http://localhost:5173',  // Vite é»˜è®¤ç«¯å£\n      'http://localhost:5174',  // Vite å¤‡ç”¨ç«¯å£\n      'http://127.0.0.1:3000',\n      'http://127.0.0.1:3001',\n      'http://127.0.0.1:3002',  // åå°ç®¡ç†ç³»ç»Ÿç«¯å£\n      'http://127.0.0.1:3007',  // Vue ç®¡ç†åå°ç«¯å£\n      'http://127.0.0.1:5173',\n      'http://127.0.0.1:5174'\n    ];\n\n    // å¦‚æœè®¾ç½®äº†ç¯å¢ƒå˜é‡ï¼Œä¼˜å…ˆä½¿ç”¨\n    if (process.env.CORS_ORIGIN) {\n      allowedOrigins.push(process.env.CORS_ORIGIN);\n    }\n\n    // å…è®¸æ²¡æœ‰originçš„è¯·æ±‚ï¼ˆå¦‚ç§»åŠ¨åº”ç”¨ã€Postmanç­‰ï¼‰\n    // ä»¥åŠoriginä¸ºnullçš„è¯·æ±‚ï¼ˆå¦‚ç›´æ¥æ‰“å¼€HTMLæ–‡ä»¶ï¼‰\n    if (!origin || origin === 'null') return callback(null, true);\n\n    // å…è®¸file://åè®®çš„è¯·æ±‚ï¼ˆç”¨äºç›´æ¥æ‰“å¼€HTMLæ–‡ä»¶ï¼‰\n    if (origin && origin.startsWith('file://')) {\n      return callback(null, true);\n    }\n\n    // æ£€æŸ¥originæ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­\n    if (allowedOrigins.indexOf(origin) !== -1) {\n      callback(null, true);\n    } else {\n      console.log(`âŒ CORS blocked origin: ${origin}`);\n      console.log(`âœ… Allowed origins: ${allowedOrigins.join(', ')}, file://`);\n      callback(new Error('Not allowed by CORS'));\n    }\n  },\n  credentials: true,\n  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],\n  allowedHeaders: ['Content-Type', 'Authorization']\n}));\n\n// è¯·æ±‚è§£æ\napp.use(express.json({ limit: '10mb' }));\napp.use(express.urlencoded({ extended: true, limit: '10mb' }));\n\n// é™æ€æ–‡ä»¶æœåŠ¡\napp.use('/uploads', express.static('uploads'));\n\n// é€Ÿç‡é™åˆ¶\napp.use(rateLimiter);\n\n// å¥åº·æ£€æŸ¥ç«¯ç‚¹\napp.get('/health', (req, res) => {\n  res.json({\n    status: 'OK',\n    timestamp: new Date().toISOString(),\n    uptime: process.uptime(),\n    environment: process.env.NODE_ENV\n  });\n});\n\n// APIè·¯ç”±\napp.use('/api/auth', authRoutes);\napp.use('/api/users', userRoutes);\napp.use('/api/images', imageRoutes);\napp.use('/api/points', require('./routes/points'));\napp.use('/api/level-cards', require('./routes/levelCards'));\napp.use('/api/admin-auth', adminAuthRoutes);\n// æ³¨æ„ï¼šæ›´å…·ä½“çš„è·¯ç”±è¦æ”¾åœ¨å‰é¢\napp.use('/api/admin/config', require('./routes/config'));\napp.use('/api/admin', require('./routes/admin'));\napp.use('/api/config', require('./routes/public-config'));\n\n// 404å¤„ç†\napp.use('*', (req, res) => {\n  res.status(404).json({\n    success: false,\n    message: 'æ¥å£ä¸å­˜åœ¨',\n    path: req.originalUrl\n  });\n});\n\n// é”™è¯¯å¤„ç†ä¸­é—´ä»¶\napp.use(errorHandler);\n\n// å¯åŠ¨æœåŠ¡å™¨\nasync function startServer() {\n  try {\n    // æµ‹è¯•æ•°æ®åº“è¿æ¥\n    const dbConnected = await testConnection();\n    if (!dbConnected) {\n      console.warn('âš ï¸ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œä½†æœåŠ¡å™¨å°†ç»§ç»­å¯åŠ¨ï¼ˆä»…ç”¨äºç®¡ç†ç•Œé¢ï¼‰');\n    }\n\n    // å¯åŠ¨HTTPæœåŠ¡å™¨\n    app.listen(PORT, () => {\n      console.log('ğŸš€ ImagicæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!');\n      console.log(`ğŸ“ æœåŠ¡åœ°å€: http://localhost:${PORT}`);\n      console.log(`ğŸŒ ç¯å¢ƒ: ${process.env.NODE_ENV}`);\n      console.log(`â° å¯åŠ¨æ—¶é—´: ${new Date().toLocaleString()}`);\n      if (!dbConnected) {\n        console.log('âš ï¸ æ³¨æ„ï¼šæ•°æ®åº“æœªè¿æ¥ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨');\n      }\n    });\n  } catch (error) {\n    console.error('âŒ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:', error);\n    process.exit(1);\n  }\n}\n\n// ä¼˜é›…å…³é—­\nprocess.on('SIGTERM', () => {\n  console.log('ğŸ›‘ æ”¶åˆ°SIGTERMä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...');\n  process.exit(0);\n});\n\nprocess.on('SIGINT', () => {\n  console.log('ğŸ›‘ æ”¶åˆ°SIGINTä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...');\n  process.exit(0);\n});\n\nstartServer();\n\nmodule.exports = app;\n"
        }
    ]
}