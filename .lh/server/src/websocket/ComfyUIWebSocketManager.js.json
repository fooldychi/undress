{
    "sourceFile": "server/src/websocket/ComfyUIWebSocketManager.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1752941898191,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752941972562,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -528,4 +528,195 @@\n         }\n       }\n     }\n   }\n+\n+  /**\n+   * æäº¤ä»»åŠ¡åˆ°ComfyUI - å‚è€ƒå®˜æ–¹post_prompt\n+   */\n+  async submitTask(prompt, clientId, extraData = {}) {\n+    const promptId = uuidv4();\n+\n+    try {\n+      // æ³¨å†Œä»»åŠ¡åˆ°å®¢æˆ·ç«¯\n+      const metadata = this.clientMetadata.get(clientId);\n+      if (metadata) {\n+        metadata.taskIds.add(promptId);\n+      }\n+\n+      // è®¾ç½®ä»»åŠ¡çŠ¶æ€\n+      this.taskStatus.set(promptId, 'queued');\n+\n+      console.log(`ğŸ“¤ æäº¤ä»»åŠ¡åˆ°ComfyUI: ${promptId}`);\n+\n+      // æ„å»ºè¯·æ±‚ä½“ - å‚è€ƒå®˜æ–¹æ ‡å‡†æ ¼å¼\n+      const requestBody = {\n+        prompt_id: promptId,\n+        prompt: prompt,\n+        client_id: clientId,\n+        extra_data: extraData\n+      };\n+\n+      const response = await fetch(`${this.comfyUIServerUrl}/prompt`, {\n+        method: 'POST',\n+        headers: {\n+          'Content-Type': 'application/json'\n+        },\n+        body: JSON.stringify(requestBody)\n+      });\n+\n+      if (!response.ok) {\n+        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n+      }\n+\n+      const result = await response.json();\n+      console.log(`âœ… ä»»åŠ¡æäº¤æˆåŠŸ: ${promptId}`);\n+\n+      return {\n+        promptId,\n+        status: 'submitted',\n+        result\n+      };\n+\n+    } catch (error) {\n+      console.error(`âŒ æäº¤ä»»åŠ¡å¤±è´¥: ${promptId}`, error);\n+      this.taskStatus.set(promptId, 'error');\n+\n+      // æ¸…ç†ä»»åŠ¡æ³¨å†Œ\n+      const metadata = this.clientMetadata.get(clientId);\n+      if (metadata) {\n+        metadata.taskIds.delete(promptId);\n+      }\n+\n+      throw error;\n+    }\n+  }\n+\n+  /**\n+   * è·å–ä»»åŠ¡ç»“æœ\n+   */\n+  getTaskResult(promptId) {\n+    return {\n+      status: this.taskStatus.get(promptId) || 'unknown',\n+      result: this.taskResults.get(promptId) || null,\n+      history: this.taskHistory.get(promptId) || null\n+    };\n+  }\n+\n+  /**\n+   * è·å–é˜Ÿåˆ—ä¿¡æ¯ - å‚è€ƒå®˜æ–¹get_queue_info\n+   */\n+  getQueueInfo() {\n+    const queueRemaining = Array.from(this.taskStatus.values())\n+      .filter(status => status === 'queued' || status === 'executing').length;\n+\n+    const activeTasks = Array.from(this.taskStatus.values())\n+      .filter(status => status === 'executing').length;\n+\n+    return {\n+      exec_info: {\n+        queue_remaining: queueRemaining\n+      },\n+      active_tasks: activeTasks,\n+      total_clients: this.clientSockets.size\n+    };\n+  }\n+\n+  /**\n+   * é‡è¿è°ƒåº¦\n+   */\n+  scheduleReconnect() {\n+    if (this.reconnectAttempts >= this.maxReconnectAttempts) {\n+      console.error(`âŒ è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•° (${this.maxReconnectAttempts})ï¼Œåœæ­¢é‡è¿`);\n+      this.emit('max_reconnect_attempts_reached');\n+      return;\n+    }\n+\n+    this.reconnectAttempts++;\n+    const delay = this.reconnectInterval * this.reconnectAttempts;\n+\n+    console.log(`ğŸ”„ è®¡åˆ’é‡è¿ ComfyUI (${this.reconnectAttempts}/${this.maxReconnectAttempts}) å»¶è¿Ÿ: ${delay}ms`);\n+\n+    setTimeout(() => {\n+      if (this.comfyUIServerUrl) {\n+        this.initComfyUIConnection(this.comfyUIServerUrl).catch(error => {\n+          console.error('âŒ é‡è¿å¤±è´¥:', error);\n+        });\n+      }\n+    }, delay);\n+  }\n+\n+  /**\n+   * æ¸…ç†è¿‡æœŸä»»åŠ¡\n+   */\n+  cleanupExpiredTasks(maxAge = 3600000) { // 1å°æ—¶\n+    const now = Date.now();\n+    const expiredTasks = [];\n+\n+    for (const [promptId, status] of this.taskStatus) {\n+      // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦è¿‡æœŸï¼ˆç®€å•å®ç°ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ”¹è¿›ï¼‰\n+      if (status === 'completed' || status === 'error') {\n+        // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„è¿‡æœŸé€»è¾‘\n+        // æš‚æ—¶ä¿ç•™æ‰€æœ‰å·²å®Œæˆçš„ä»»åŠ¡ç»“æœ\n+      }\n+    }\n+\n+    // æ¸…ç†è¿‡æœŸçš„å®¢æˆ·ç«¯è¿æ¥\n+    for (const [clientId, metadata] of this.clientMetadata) {\n+      if (now - metadata.lastActivity > maxAge) {\n+        console.log(`ğŸ§¹ æ¸…ç†è¿‡æœŸå®¢æˆ·ç«¯: ${clientId}`);\n+        this.removeClient(clientId);\n+      }\n+    }\n+  }\n+\n+  /**\n+   * è·å–ç»Ÿè®¡ä¿¡æ¯\n+   */\n+  getStats() {\n+    const taskStatusCounts = {};\n+    for (const status of this.taskStatus.values()) {\n+      taskStatusCounts[status] = (taskStatusCounts[status] || 0) + 1;\n+    }\n+\n+    return {\n+      comfyui_connected: this.comfyUIConnection && this.comfyUIConnection.readyState === WebSocket.OPEN,\n+      clients_connected: this.clientSockets.size,\n+      tasks_total: this.taskStatus.size,\n+      tasks_by_status: taskStatusCounts,\n+      reconnect_attempts: this.reconnectAttempts,\n+      current_executing: this.currentExecutingPromptId,\n+      last_node: this.lastNodeId\n+    };\n+  }\n+\n+  /**\n+   * å…³é—­ç®¡ç†å™¨\n+   */\n+  async close() {\n+    console.log('ğŸ›‘ å…³é—­ComfyUI WebSocketç®¡ç†å™¨...');\n+\n+    // å…³é—­ComfyUIè¿æ¥\n+    if (this.comfyUIConnection) {\n+      this.comfyUIConnection.close();\n+      this.comfyUIConnection = null;\n+    }\n+\n+    // å…³é—­æ‰€æœ‰å®¢æˆ·ç«¯è¿æ¥\n+    for (const [clientId, ws] of this.clientSockets) {\n+      if (ws.readyState === WebSocket.OPEN) {\n+        ws.close(1000, 'æœåŠ¡å™¨å…³é—­');\n+      }\n+    }\n+\n+    // æ¸…ç†æ•°æ®\n+    this.clientSockets.clear();\n+    this.clientMetadata.clear();\n+    this.taskResults.clear();\n+    this.taskStatus.clear();\n+    this.taskHistory.clear();\n+\n+    console.log('âœ… ComfyUI WebSocketç®¡ç†å™¨å·²å…³é—­');\n+  }\n+}\n+\n+module.exports = ComfyUIWebSocketManager;\n"
                }
            ],
            "date": 1752941898191,
            "name": "Commit-0",
            "content": "const WebSocket = require('ws');\nconst EventEmitter = require('events');\nconst { v4: uuidv4 } = require('uuid');\nconst fetch = require('node-fetch');\n\n/**\n * ComfyUI WebSocketç®¡ç†å™¨ - åŸºäºå®˜æ–¹server.pyçš„PromptServerç±»\n * å‚è€ƒ: server/server.py ç¬¬147-976è¡Œ\n */\nclass ComfyUIWebSocketManager extends EventEmitter {\n  constructor() {\n    super();\n\n    // æ ¸å¿ƒè¿æ¥ç®¡ç† - å‚è€ƒå®˜æ–¹PromptServer.__init__\n    this.comfyUIConnection = null;\n    this.comfyUIServerUrl = null;\n    this.reconnectAttempts = 0;\n    this.maxReconnectAttempts = 5;\n    this.reconnectInterval = 5000;\n\n    // å®¢æˆ·ç«¯è¿æ¥ç®¡ç† - å‚è€ƒå®˜æ–¹socketså’Œsockets_metadata\n    this.clientSockets = new Map(); // å­˜å‚¨å®¢æˆ·ç«¯WebSocketè¿æ¥\n    this.clientMetadata = new Map(); // å­˜å‚¨å®¢æˆ·ç«¯å…ƒæ•°æ®\n\n    // ä»»åŠ¡çŠ¶æ€ç®¡ç† - å‚è€ƒå®˜æ–¹æ¶ˆæ¯å¤„ç†æœºåˆ¶\n    this.taskResults = new Map(); // ç¼“å­˜ä»»åŠ¡ç»“æœ\n    this.taskStatus = new Map(); // ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª\n    this.taskHistory = new Map(); // ä»»åŠ¡å†å²è®°å½•ç¼“å­˜\n\n    // æ‰§è¡ŒçŠ¶æ€è·Ÿè¸ª - å‚è€ƒå®˜æ–¹client_idå’Œlast_node_id\n    this.currentExecutingClient = null;\n    this.currentExecutingPromptId = null;\n    this.lastNodeId = null;\n\n    // æ¶ˆæ¯é˜Ÿåˆ— - å‚è€ƒå®˜æ–¹messagesé˜Ÿåˆ—\n    this.messageQueue = [];\n    this.isProcessingMessages = false;\n\n    console.log('ğŸš€ ComfyUI WebSocketç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');\n  }\n\n  /**\n   * åˆå§‹åŒ–åˆ°ComfyUIçš„è¿æ¥\n   * å‚è€ƒ: server.py websocket_handleræ–¹æ³•\n   */\n  async initComfyUIConnection(comfyUIUrl) {\n    this.comfyUIServerUrl = comfyUIUrl;\n\n    try {\n      // æ„å»ºWebSocket URL\n      const wsUrl = comfyUIUrl.replace('http://', 'ws://').replace('https://', 'wss://') + '/ws';\n      console.log(`ğŸ”Œ è¿æ¥åˆ°ComfyUIæœåŠ¡å™¨: ${wsUrl}`);\n\n      this.comfyUIConnection = new WebSocket(wsUrl);\n\n      this.comfyUIConnection.on('open', () => {\n        console.log('âœ… å·²è¿æ¥åˆ°ComfyUIæœåŠ¡å™¨');\n        this.reconnectAttempts = 0;\n        this.emit('comfyui_connected');\n      });\n\n      this.comfyUIConnection.on('message', (data) => {\n        this.handleComfyUIMessage(data);\n      });\n\n      this.comfyUIConnection.on('error', (error) => {\n        console.error('âŒ ComfyUIè¿æ¥é”™è¯¯:', error);\n        this.emit('comfyui_error', error);\n        this.scheduleReconnect();\n      });\n\n      this.comfyUIConnection.on('close', (code, reason) => {\n        console.log(`âš ï¸ ComfyUIè¿æ¥æ–­å¼€ (${code}): ${reason}`);\n        this.emit('comfyui_disconnected', { code, reason });\n        this.scheduleReconnect();\n      });\n\n      return new Promise((resolve, reject) => {\n        const timeout = setTimeout(() => {\n          reject(new Error('ComfyUIè¿æ¥è¶…æ—¶'));\n        }, 10000);\n\n        this.comfyUIConnection.once('open', () => {\n          clearTimeout(timeout);\n          resolve();\n        });\n\n        this.comfyUIConnection.once('error', (error) => {\n          clearTimeout(timeout);\n          reject(error);\n        });\n      });\n\n    } catch (error) {\n      console.error('âŒ åˆå§‹åŒ–ComfyUIè¿æ¥å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * å¤„ç†ComfyUIæ¶ˆæ¯ - å‚è€ƒå®˜æ–¹æ¶ˆæ¯å¤„ç†é€»è¾‘\n   * å‚è€ƒ: server.py handleExecutingMessageç­‰æ–¹æ³•\n   */\n  handleComfyUIMessage(data) {\n    try {\n      // å¤„ç†äºŒè¿›åˆ¶æ¶ˆæ¯ï¼ˆé¢„è§ˆå›¾åƒï¼‰- å‚è€ƒå®˜æ–¹äºŒè¿›åˆ¶æ¶ˆæ¯å¤„ç†\n      if (data instanceof Buffer) {\n        this.handleBinaryMessage(data);\n        return;\n      }\n\n      // å¤„ç†JSONæ¶ˆæ¯\n      const message = JSON.parse(data);\n      console.log(`ğŸ“¨ æ”¶åˆ°ComfyUIæ¶ˆæ¯: ${message.type}`);\n\n      switch (message.type) {\n        case 'status':\n          this.handleStatusMessage(message.data);\n          break;\n        case 'progress':\n          this.handleProgressMessage(message.data);\n          break;\n        case 'executing':\n          this.handleExecutingMessage(message.data);\n          break;\n        case 'executed':\n          this.handleExecutedMessage(message.data);\n          break;\n        case 'execution_start':\n          this.handleExecutionStartMessage(message.data);\n          break;\n        case 'execution_error':\n          this.handleExecutionErrorMessage(message.data);\n          break;\n        default:\n          // è½¬å‘å…¶ä»–æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯\n          this.broadcastToClients(message);\n      }\n    } catch (error) {\n      console.error('âŒ å¤„ç†ComfyUIæ¶ˆæ¯å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * å¤„ç†æ‰§è¡ŒçŠ¶æ€æ¶ˆæ¯ - æ ¸å¿ƒä»»åŠ¡å®Œæˆæ£€æµ‹\n   * å‚è€ƒ: websockets_api_example.py ç¬¬37-40è¡Œçš„æ ‡å‡†å®ç°\n   */\n  handleExecutingMessage(data) {\n    if (!data || !data.prompt_id) {\n      return;\n    }\n\n    const { node, prompt_id } = data;\n    console.log(`ğŸ¯ æ‰§è¡ŒçŠ¶æ€æ›´æ–°: prompt_id=${prompt_id}, node=${node}`);\n\n    // æ›´æ–°æ‰§è¡ŒçŠ¶æ€\n    this.lastNodeId = node;\n    this.currentExecutingPromptId = prompt_id;\n\n    // å®˜æ–¹æ ‡å‡†ä»»åŠ¡å®Œæˆæ£€æµ‹: if data['node'] is None and data['prompt_id'] == prompt_id:\n    if (node === null) {\n      console.log(`ğŸ‰ ä»»åŠ¡æ‰§è¡Œå®Œæˆ: ${prompt_id}`);\n      this.handleTaskCompletion(prompt_id);\n    } else {\n      // ä»»åŠ¡ä»åœ¨æ‰§è¡Œä¸­ï¼Œæ›´æ–°è¿›åº¦\n      this.updateTaskProgress(prompt_id, node);\n    }\n\n    // è½¬å‘æ‰§è¡ŒçŠ¶æ€ç»™å¯¹åº”çš„å®¢æˆ·ç«¯\n    this.sendToTaskClient(prompt_id, {\n      type: 'executing',\n      data: { node, prompt_id }\n    });\n  }\n\n  /**\n   * å¤„ç†ä»»åŠ¡å®Œæˆ - å‚è€ƒå®˜æ–¹æ ‡å‡†æµç¨‹\n   * å‚è€ƒ: websockets_api_example.py ç¬¬47-56è¡Œ\n   */\n  async handleTaskCompletion(promptId) {\n    try {\n      console.log(`ğŸ” å¼€å§‹å¤„ç†ä»»åŠ¡å®Œæˆ: ${promptId}`);\n\n      // æ›´æ–°ä»»åŠ¡çŠ¶æ€\n      this.taskStatus.set(promptId, 'completed');\n\n      // å®˜æ–¹æ ‡å‡†ï¼šç«‹å³è·å–ä»»åŠ¡å†å²è®°å½•\n      const history = await this.getTaskHistory(promptId);\n\n      if (history && history[promptId]) {\n        // å®˜æ–¹æ ‡å‡†ï¼šæå–ç»“æœæ•°æ®\n        const results = await this.extractTaskResults(history[promptId], promptId);\n\n        // ç¼“å­˜ç»“æœ\n        this.taskResults.set(promptId, results);\n        this.taskHistory.set(promptId, history[promptId]);\n\n        console.log(`âœ… ä»»åŠ¡å®Œæˆå¤„ç†æˆåŠŸ: ${promptId}`);\n\n        // é€šçŸ¥å®¢æˆ·ç«¯ä»»åŠ¡å®Œæˆ\n        this.sendToTaskClient(promptId, {\n          type: 'task_completed',\n          data: {\n            prompt_id: promptId,\n            results,\n            status: 'completed'\n          }\n        });\n      } else {\n        console.error(`âŒ è·å–ä»»åŠ¡å†å²å¤±è´¥: ${promptId}`);\n        this.taskStatus.set(promptId, 'error');\n\n        this.sendToTaskClient(promptId, {\n          type: 'task_error',\n          data: {\n            prompt_id: promptId,\n            error: 'è·å–ä»»åŠ¡å†å²å¤±è´¥',\n            status: 'error'\n          }\n        });\n      }\n\n      // æ¸…ç†æ‰§è¡ŒçŠ¶æ€\n      if (this.currentExecutingPromptId === promptId) {\n        this.currentExecutingPromptId = null;\n        this.lastNodeId = null;\n      }\n\n    } catch (error) {\n      console.error(`âŒ å¤„ç†ä»»åŠ¡å®Œæˆå¤±è´¥: ${promptId}`, error);\n      this.taskStatus.set(promptId, 'error');\n\n      this.sendToTaskClient(promptId, {\n        type: 'task_error',\n        data: {\n          prompt_id: promptId,\n          error: error.message,\n          status: 'error'\n        }\n      });\n    }\n  }\n\n  /**\n   * è·å–ä»»åŠ¡å†å²è®°å½• - å®˜æ–¹æ ‡å‡†APIè°ƒç”¨\n   * å‚è€ƒ: websockets_api_example.py get_historyå‡½æ•°\n   */\n  async getTaskHistory(promptId) {\n    try {\n      const historyUrl = `${this.comfyUIServerUrl}/history/${promptId}`;\n      console.log(`ğŸ“¡ è·å–ä»»åŠ¡å†å²: ${historyUrl}`);\n\n      const response = await fetch(historyUrl);\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const history = await response.json();\n      console.log(`ğŸ“Š å†å²è®°å½•è·å–æˆåŠŸ: ${promptId}`);\n      return history;\n\n    } catch (error) {\n      console.error(`âŒ è·å–ä»»åŠ¡å†å²å¤±è´¥: ${promptId}`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * æå–ä»»åŠ¡ç»“æœ - å®˜æ–¹æ ‡å‡†ç»“æœæå–\n   * å‚è€ƒ: websockets_api_example.py ç¬¬48-56è¡Œ\n   */\n  async extractTaskResults(history, promptId) {\n    try {\n      const outputImages = {};\n\n      // å®˜æ–¹æ ‡å‡†ï¼šfor node_id in history['outputs']:\n      if (history.outputs) {\n        for (const nodeId in history.outputs) {\n          const nodeOutput = history.outputs[nodeId];\n          const imagesOutput = [];\n\n          // å®˜æ–¹æ ‡å‡†ï¼šif 'images' in node_output:\n          if (nodeOutput.images) {\n            for (const image of nodeOutput.images) {\n              // æ„å»ºå›¾ç‰‡URLè€Œä¸æ˜¯ä¸‹è½½æ•°æ®\n              const imageUrl = `${this.comfyUIServerUrl}/view?filename=${image.filename}&subfolder=${image.subfolder}&type=${image.type}`;\n              imagesOutput.push({\n                filename: image.filename,\n                subfolder: image.subfolder,\n                type: image.type,\n                url: imageUrl\n              });\n            }\n          }\n\n          outputImages[nodeId] = imagesOutput;\n        }\n      }\n\n      console.log(`ğŸ¨ ç»“æœæå–å®Œæˆ: ${promptId}, èŠ‚ç‚¹æ•°: ${Object.keys(outputImages).length}`);\n      return outputImages;\n\n    } catch (error) {\n      console.error(`âŒ æå–ä»»åŠ¡ç»“æœå¤±è´¥: ${promptId}`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * å¤„ç†è¿›åº¦æ¶ˆæ¯\n   */\n  handleProgressMessage(data) {\n    if (!data || !data.prompt_id) {\n      return;\n    }\n\n    const { prompt_id, value, max } = data;\n    const progress = max > 0 ? Math.round((value / max) * 100) : 0;\n\n    console.log(`ğŸ“Š ä»»åŠ¡è¿›åº¦æ›´æ–°: ${prompt_id} - ${progress}%`);\n\n    // è½¬å‘è¿›åº¦ç»™å¯¹åº”çš„å®¢æˆ·ç«¯\n    this.sendToTaskClient(prompt_id, {\n      type: 'progress',\n      data: { prompt_id, progress, value, max }\n    });\n  }\n\n  /**\n   * å¤„ç†çŠ¶æ€æ¶ˆæ¯\n   */\n  handleStatusMessage(data) {\n    console.log('ğŸ“‹ çŠ¶æ€æ›´æ–°:', data);\n\n    // å¹¿æ’­çŠ¶æ€ç»™æ‰€æœ‰å®¢æˆ·ç«¯\n    this.broadcastToClients({\n      type: 'status',\n      data\n    });\n  }\n\n  /**\n   * å¤„ç†æ‰§è¡Œå¼€å§‹æ¶ˆæ¯\n   */\n  handleExecutionStartMessage(data) {\n    if (!data || !data.prompt_id) {\n      return;\n    }\n\n    const { prompt_id } = data;\n    console.log(`ğŸš€ ä»»åŠ¡å¼€å§‹æ‰§è¡Œ: ${prompt_id}`);\n\n    this.taskStatus.set(prompt_id, 'executing');\n\n    // é€šçŸ¥å¯¹åº”çš„å®¢æˆ·ç«¯\n    this.sendToTaskClient(prompt_id, {\n      type: 'execution_start',\n      data\n    });\n  }\n\n  /**\n   * å¤„ç†æ‰§è¡Œé”™è¯¯æ¶ˆæ¯\n   */\n  handleExecutionErrorMessage(data) {\n    if (!data || !data.prompt_id) {\n      return;\n    }\n\n    const { prompt_id } = data;\n    console.error(`âŒ ä»»åŠ¡æ‰§è¡Œé”™è¯¯: ${prompt_id}`, data);\n\n    this.taskStatus.set(prompt_id, 'error');\n\n    // é€šçŸ¥å¯¹åº”çš„å®¢æˆ·ç«¯\n    this.sendToTaskClient(prompt_id, {\n      type: 'execution_error',\n      data\n    });\n  }\n\n  /**\n   * å¤„ç†äºŒè¿›åˆ¶æ¶ˆæ¯ï¼ˆé¢„è§ˆå›¾åƒï¼‰\n   */\n  handleBinaryMessage(data) {\n    // è½¬å‘äºŒè¿›åˆ¶æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯\n    this.broadcastBinaryToClients(data);\n  }\n\n  /**\n   * æ›´æ–°ä»»åŠ¡è¿›åº¦\n   */\n  updateTaskProgress(promptId, currentNode) {\n    // å¯ä»¥æ ¹æ®èŠ‚ç‚¹ä¿¡æ¯è®¡ç®—è¿›åº¦\n    const progress = currentNode ? 85 : 50; // ç®€å•çš„è¿›åº¦ä¼°ç®—\n\n    this.sendToTaskClient(promptId, {\n      type: 'progress',\n      data: {\n        prompt_id: promptId,\n        progress,\n        current_node: currentNode,\n        status: 'executing'\n      }\n    });\n  }\n\n  /**\n   * æ·»åŠ å®¢æˆ·ç«¯è¿æ¥ - å‚è€ƒå®˜æ–¹websocket_handler\n   */\n  addClient(ws, clientId = null) {\n    const sid = clientId || uuidv4();\n\n    // å¦‚æœæ˜¯é‡ç”¨ä¼šè¯ï¼Œç§»é™¤æ—§è¿æ¥\n    if (clientId && this.clientSockets.has(clientId)) {\n      const oldWs = this.clientSockets.get(clientId);\n      if (oldWs.readyState === WebSocket.OPEN) {\n        oldWs.close();\n      }\n    }\n\n    this.clientSockets.set(sid, ws);\n    this.clientMetadata.set(sid, {\n      connectedAt: Date.now(),\n      lastActivity: Date.now(),\n      taskIds: new Set() // è·Ÿè¸ªå®¢æˆ·ç«¯çš„ä»»åŠ¡\n    });\n\n    console.log(`ğŸ”— å®¢æˆ·ç«¯è¿æ¥: ${sid}`);\n\n    // å‘é€åˆå§‹çŠ¶æ€ - å‚è€ƒå®˜æ–¹send initial state\n    this.sendToClient(sid, {\n      type: 'status',\n      data: {\n        status: this.getQueueInfo(),\n        sid: sid\n      }\n    });\n\n    // å¦‚æœæœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ä¸”æ˜¯è¯¥å®¢æˆ·ç«¯çš„ä»»åŠ¡ï¼Œå‘é€å½“å‰çŠ¶æ€\n    if (this.currentExecutingPromptId && this.lastNodeId) {\n      const metadata = this.clientMetadata.get(sid);\n      if (metadata && metadata.taskIds.has(this.currentExecutingPromptId)) {\n        this.sendToClient(sid, {\n          type: 'executing',\n          data: {\n            node: this.lastNodeId,\n            prompt_id: this.currentExecutingPromptId\n          }\n        });\n      }\n    }\n\n    return sid;\n  }\n\n  /**\n   * ç§»é™¤å®¢æˆ·ç«¯è¿æ¥\n   */\n  removeClient(clientId) {\n    console.log(`ğŸ”Œ å®¢æˆ·ç«¯æ–­å¼€: ${clientId}`);\n\n    this.clientSockets.delete(clientId);\n    this.clientMetadata.delete(clientId);\n  }\n\n  /**\n   * å‘é€æ¶ˆæ¯ç»™ç‰¹å®šå®¢æˆ·ç«¯ - å‚è€ƒå®˜æ–¹send_json\n   */\n  sendToClient(clientId, message) {\n    const ws = this.clientSockets.get(clientId);\n    if (ws && ws.readyState === WebSocket.OPEN) {\n      try {\n        ws.send(JSON.stringify(message));\n\n        // æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´\n        const metadata = this.clientMetadata.get(clientId);\n        if (metadata) {\n          metadata.lastActivity = Date.now();\n        }\n      } catch (error) {\n        console.error(`âŒ å‘é€æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ ${clientId} å¤±è´¥:`, error);\n        this.removeClient(clientId);\n      }\n    }\n  }\n\n  /**\n   * å‘é€æ¶ˆæ¯ç»™ä»»åŠ¡å¯¹åº”çš„å®¢æˆ·ç«¯\n   */\n  sendToTaskClient(promptId, message) {\n    // æŸ¥æ‰¾æ‹¥æœ‰è¯¥ä»»åŠ¡çš„å®¢æˆ·ç«¯\n    for (const [clientId, metadata] of this.clientMetadata) {\n      if (metadata.taskIds && metadata.taskIds.has(promptId)) {\n        this.sendToClient(clientId, message);\n        break;\n      }\n    }\n  }\n\n  /**\n   * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯ - å‚è€ƒå®˜æ–¹å¹¿æ’­æœºåˆ¶\n   */\n  broadcastToClients(message) {\n    for (const [clientId, ws] of this.clientSockets) {\n      if (ws.readyState === WebSocket.OPEN) {\n        try {\n          ws.send(JSON.stringify(message));\n        } catch (error) {\n          console.error(`âŒ å¹¿æ’­æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ ${clientId} å¤±è´¥:`, error);\n          this.removeClient(clientId);\n        }\n      }\n    }\n  }\n\n  /**\n   * å¹¿æ’­äºŒè¿›åˆ¶æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯\n   */\n  broadcastBinaryToClients(data) {\n    for (const [clientId, ws] of this.clientSockets) {\n      if (ws.readyState === WebSocket.OPEN) {\n        try {\n          ws.send(data);\n        } catch (error) {\n          console.error(`âŒ å¹¿æ’­äºŒè¿›åˆ¶æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ ${clientId} å¤±è´¥:`, error);\n          this.removeClient(clientId);\n        }\n      }\n    }\n  }\n"
        }
    ]
}