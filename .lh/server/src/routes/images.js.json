{
    "sourceFile": "server/src/routes/images.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1752331689147,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752331739003,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -224,8 +224,221 @@\n     next(error);\n   }\n });\n \n+// æ‰§è¡ŒComfyUIå›¾åƒå¤„ç†ä»»åŠ¡ï¼ˆä½¿ç”¨è´Ÿè½½å‡è¡¡ï¼‰\n+router.post('/process-comfyui', authenticateToken, async (req, res, next) => {\n+  try {\n+    const { taskId, workflow } = req.body;\n+\n+    // éªŒè¯ä»»åŠ¡ID\n+    if (!taskId) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'è¯·æä¾›ä»»åŠ¡ID'\n+      });\n+    }\n+\n+    // éªŒè¯å·¥ä½œæµ\n+    if (!workflow) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'è¯·æä¾›ComfyUIå·¥ä½œæµ'\n+      });\n+    }\n+\n+    // éªŒè¯ä»»åŠ¡æ˜¯å¦å±žäºŽå½“å‰ç”¨æˆ·\n+    const tasks = await query(\n+      'SELECT * FROM processing_tasks WHERE id = ? AND user_id = ?',\n+      [taskId, req.user.id]\n+    );\n+\n+    if (tasks.length === 0) {\n+      return res.status(404).json({\n+        success: false,\n+        message: 'ä»»åŠ¡ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®'\n+      });\n+    }\n+\n+    const task = tasks[0];\n+\n+    // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\n+    if (task.status !== 'pending') {\n+      return res.status(400).json({\n+        success: false,\n+        message: `ä»»åŠ¡çŠ¶æ€ä¸º${task.status}ï¼Œæ— æ³•æ‰§è¡Œ`\n+      });\n+    }\n+\n+    console.log(`ðŸŽ¯ å¼€å§‹æ‰§è¡ŒComfyUIä»»åŠ¡: ${taskId}, ç±»åž‹: ${task.type}`);\n+\n+    // é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n+    const selectedServer = await selectBestServer();\n+    console.log(`âœ… é€‰æ‹©æœåŠ¡å™¨: ${selectedServer}`);\n+\n+    // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤„ç†ä¸­\n+    await query(\n+      'UPDATE processing_tasks SET status = ?, server_url = ?, updated_at = NOW() WHERE id = ?',\n+      ['processing', selectedServer, taskId]\n+    );\n+\n+    try {\n+      // å‘é€å·¥ä½œæµåˆ°ComfyUIæœåŠ¡å™¨\n+      const promptResult = await comfyUIRequest('/prompt', {\n+        method: 'POST',\n+        body: JSON.stringify({\n+          prompt: workflow,\n+          client_id: `ai-magic-${taskId}`\n+        })\n+      });\n+\n+      console.log(`âœ… ComfyUIä»»åŠ¡æäº¤æˆåŠŸ: ${JSON.stringify(promptResult)}`);\n+\n+      // æ›´æ–°ä»»åŠ¡çŠ¶æ€å’Œprompt_id\n+      await query(\n+        'UPDATE processing_tasks SET prompt_id = ?, progress = ?, updated_at = NOW() WHERE id = ?',\n+        [promptResult.prompt_id, 10, taskId]\n+      );\n+\n+      res.json({\n+        success: true,\n+        message: 'ComfyUIä»»åŠ¡æäº¤æˆåŠŸ',\n+        data: {\n+          taskId,\n+          promptId: promptResult.prompt_id,\n+          selectedServer,\n+          status: 'processing'\n+        }\n+      });\n+\n+    } catch (comfyError) {\n+      console.error(`âŒ ComfyUIä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${comfyError.message}`);\n+\n+      // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤±è´¥\n+      await query(\n+        'UPDATE processing_tasks SET status = ?, error_message = ?, updated_at = NOW() WHERE id = ?',\n+        ['failed', comfyError.message, taskId]\n+      );\n+\n+      throw comfyError;\n+    }\n+\n+  } catch (error) {\n+    console.error('âŒ å¤„ç†ComfyUIä»»åŠ¡å¤±è´¥:', error);\n+    next(error);\n+  }\n+});\n+\n+// æ£€æŸ¥ComfyUIä»»åŠ¡çŠ¶æ€\n+router.get('/check-comfyui/:taskId', authenticateToken, async (req, res, next) => {\n+  try {\n+    const { taskId } = req.params;\n+\n+    // èŽ·å–ä»»åŠ¡ä¿¡æ¯\n+    const tasks = await query(\n+      'SELECT * FROM processing_tasks WHERE id = ? AND user_id = ?',\n+      [taskId, req.user.id]\n+    );\n+\n+    if (tasks.length === 0) {\n+      return res.status(404).json({\n+        success: false,\n+        message: 'ä»»åŠ¡ä¸å­˜åœ¨'\n+      });\n+    }\n+\n+    const task = tasks[0];\n+\n+    if (!task.prompt_id) {\n+      return res.json({\n+        success: true,\n+        data: {\n+          status: task.status,\n+          progress: task.progress || 0,\n+          message: 'ä»»åŠ¡å°šæœªæäº¤åˆ°ComfyUI'\n+        }\n+      });\n+    }\n+\n+    try {\n+      // æ£€æŸ¥ComfyUIé˜Ÿåˆ—çŠ¶æ€\n+      const queueStatus = await comfyUIRequest('/queue');\n+\n+      // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­\n+      const isRunning = queueStatus.queue_running?.some(item =>\n+        item[1] === task.prompt_id\n+      );\n+\n+      // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­\n+      const isPending = queueStatus.queue_pending?.some(item =>\n+        item[1] === task.prompt_id\n+      );\n+\n+      let status = task.status;\n+      let progress = task.progress || 0;\n+\n+      if (isRunning) {\n+        status = 'processing';\n+        progress = Math.max(progress, 50); // è¿è¡Œä¸­è‡³å°‘50%è¿›åº¦\n+      } else if (isPending) {\n+        status = 'pending';\n+        progress = Math.max(progress, 10); // ç­‰å¾…ä¸­è‡³å°‘10%è¿›åº¦\n+      } else if (task.status === 'processing') {\n+        // ä¸åœ¨é˜Ÿåˆ—ä¸­ä¸”ä¹‹å‰æ˜¯å¤„ç†ä¸­çŠ¶æ€ï¼Œå¯èƒ½å·²å®Œæˆæˆ–å¤±è´¥\n+        try {\n+          // å°è¯•èŽ·å–åŽ†å²è®°å½•\n+          const historyResult = await comfyUIRequest(`/history/${task.prompt_id}`);\n+\n+          if (historyResult && Object.keys(historyResult).length > 0) {\n+            status = 'completed';\n+            progress = 100;\n+\n+            // æ›´æ–°ä»»åŠ¡çŠ¶æ€\n+            await query(\n+              'UPDATE processing_tasks SET status = ?, progress = ?, completed_at = NOW(), updated_at = NOW() WHERE id = ?',\n+              [status, progress, taskId]\n+            );\n+          }\n+        } catch (historyError) {\n+          console.warn(`âš ï¸ èŽ·å–ä»»åŠ¡åŽ†å²å¤±è´¥: ${historyError.message}`);\n+        }\n+      }\n+\n+      res.json({\n+        success: true,\n+        data: {\n+          taskId,\n+          promptId: task.prompt_id,\n+          status,\n+          progress,\n+          serverUrl: task.server_url,\n+          isRunning,\n+          isPending,\n+          queuePosition: isPending ?\n+            queueStatus.queue_pending?.findIndex(item => item[1] === task.prompt_id) + 1 :\n+            null\n+        }\n+      });\n+\n+    } catch (comfyError) {\n+      console.error(`âŒ æ£€æŸ¥ComfyUIä»»åŠ¡çŠ¶æ€å¤±è´¥: ${comfyError.message}`);\n+\n+      res.json({\n+        success: true,\n+        data: {\n+          status: task.status,\n+          progress: task.progress || 0,\n+          error: comfyError.message,\n+          message: 'æ— æ³•è¿žæŽ¥åˆ°ComfyUIæœåŠ¡å™¨'\n+        }\n+      });\n+    }\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n // èŽ·å–å¤„ç†ä»»åŠ¡åˆ—è¡¨\n router.get('/tasks', authenticateToken, async (req, res, next) => {\n   try {\n     const page = parseInt(req.query.page) || 1;\n"
                },
                {
                    "date": 1752332665040,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,9 +4,8 @@\n const fs = require('fs').promises;\n const Joi = require('joi');\n const { query } = require('../config/database');\n const { authenticateToken, optionalAuth } = require('../middleware/auth');\n-const { comfyUIRequest, selectBestServer } = require('../utils/comfyUIRequest');\n \n const router = express.Router();\n \n // ç¡®ä¿ä¸Šä¼ ç›®å½•å­˜åœ¨\n@@ -63,9 +62,9 @@\n     }\n \n     // ä¿å­˜å›¾ç‰‡ä¿¡æ¯åˆ°æ•°æ®åº“\n     const result = await query(\n-      `INSERT INTO images (user_id, filename, original_name, file_path, file_size, mime_type, created_at)\n+      `INSERT INTO images (user_id, filename, original_name, file_path, file_size, mime_type, created_at) \n        VALUES (?, ?, ?, ?, ?, ?, NOW())`,\n       [\n         req.user.id,\n         req.file.filename,\n@@ -112,9 +111,9 @@\n \n     // æ‰¹é‡ä¿å­˜å›¾ç‰‡ä¿¡æ¯\n     for (const file of req.files) {\n       const result = await query(\n-        `INSERT INTO images (user_id, filename, original_name, file_path, file_size, mime_type, created_at)\n+        `INSERT INTO images (user_id, filename, original_name, file_path, file_size, mime_type, created_at) \n          VALUES (?, ?, ?, ?, ?, ?, NOW())`,\n         [\n           req.user.id,\n           file.filename,\n@@ -176,9 +175,9 @@\n     }\n \n     // éªŒè¯å›¾ç‰‡æ˜¯å¦å±žäºŽå½“å‰ç”¨æˆ·\n     const images = await query(\n-      `SELECT id, filename, file_path FROM images\n+      `SELECT id, filename, file_path FROM images \n        WHERE id IN (${imageIds.map(() => '?').join(',')}) AND user_id = ?`,\n       [...imageIds, req.user.id]\n     );\n \n@@ -190,9 +189,9 @@\n     }\n \n     // åˆ›å»ºå¤„ç†ä»»åŠ¡\n     const taskResult = await query(\n-      `INSERT INTO processing_tasks (user_id, type, status, prompt, settings, created_at)\n+      `INSERT INTO processing_tasks (user_id, type, status, prompt, settings, created_at) \n        VALUES (?, ?, ?, ?, ?, NOW())`,\n       [req.user.id, type, 'pending', prompt || null, JSON.stringify(settings || {})]\n     );\n \n@@ -224,221 +223,8 @@\n     next(error);\n   }\n });\n \n-// æ‰§è¡ŒComfyUIå›¾åƒå¤„ç†ä»»åŠ¡ï¼ˆä½¿ç”¨è´Ÿè½½å‡è¡¡ï¼‰\n-router.post('/process-comfyui', authenticateToken, async (req, res, next) => {\n-  try {\n-    const { taskId, workflow } = req.body;\n-\n-    // éªŒè¯ä»»åŠ¡ID\n-    if (!taskId) {\n-      return res.status(400).json({\n-        success: false,\n-        message: 'è¯·æä¾›ä»»åŠ¡ID'\n-      });\n-    }\n-\n-    // éªŒè¯å·¥ä½œæµ\n-    if (!workflow) {\n-      return res.status(400).json({\n-        success: false,\n-        message: 'è¯·æä¾›ComfyUIå·¥ä½œæµ'\n-      });\n-    }\n-\n-    // éªŒè¯ä»»åŠ¡æ˜¯å¦å±žäºŽå½“å‰ç”¨æˆ·\n-    const tasks = await query(\n-      'SELECT * FROM processing_tasks WHERE id = ? AND user_id = ?',\n-      [taskId, req.user.id]\n-    );\n-\n-    if (tasks.length === 0) {\n-      return res.status(404).json({\n-        success: false,\n-        message: 'ä»»åŠ¡ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®'\n-      });\n-    }\n-\n-    const task = tasks[0];\n-\n-    // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\n-    if (task.status !== 'pending') {\n-      return res.status(400).json({\n-        success: false,\n-        message: `ä»»åŠ¡çŠ¶æ€ä¸º${task.status}ï¼Œæ— æ³•æ‰§è¡Œ`\n-      });\n-    }\n-\n-    console.log(`ðŸŽ¯ å¼€å§‹æ‰§è¡ŒComfyUIä»»åŠ¡: ${taskId}, ç±»åž‹: ${task.type}`);\n-\n-    // é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n-    const selectedServer = await selectBestServer();\n-    console.log(`âœ… é€‰æ‹©æœåŠ¡å™¨: ${selectedServer}`);\n-\n-    // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤„ç†ä¸­\n-    await query(\n-      'UPDATE processing_tasks SET status = ?, server_url = ?, updated_at = NOW() WHERE id = ?',\n-      ['processing', selectedServer, taskId]\n-    );\n-\n-    try {\n-      // å‘é€å·¥ä½œæµåˆ°ComfyUIæœåŠ¡å™¨\n-      const promptResult = await comfyUIRequest('/prompt', {\n-        method: 'POST',\n-        body: JSON.stringify({\n-          prompt: workflow,\n-          client_id: `ai-magic-${taskId}`\n-        })\n-      });\n-\n-      console.log(`âœ… ComfyUIä»»åŠ¡æäº¤æˆåŠŸ: ${JSON.stringify(promptResult)}`);\n-\n-      // æ›´æ–°ä»»åŠ¡çŠ¶æ€å’Œprompt_id\n-      await query(\n-        'UPDATE processing_tasks SET prompt_id = ?, progress = ?, updated_at = NOW() WHERE id = ?',\n-        [promptResult.prompt_id, 10, taskId]\n-      );\n-\n-      res.json({\n-        success: true,\n-        message: 'ComfyUIä»»åŠ¡æäº¤æˆåŠŸ',\n-        data: {\n-          taskId,\n-          promptId: promptResult.prompt_id,\n-          selectedServer,\n-          status: 'processing'\n-        }\n-      });\n-\n-    } catch (comfyError) {\n-      console.error(`âŒ ComfyUIä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${comfyError.message}`);\n-\n-      // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤±è´¥\n-      await query(\n-        'UPDATE processing_tasks SET status = ?, error_message = ?, updated_at = NOW() WHERE id = ?',\n-        ['failed', comfyError.message, taskId]\n-      );\n-\n-      throw comfyError;\n-    }\n-\n-  } catch (error) {\n-    console.error('âŒ å¤„ç†ComfyUIä»»åŠ¡å¤±è´¥:', error);\n-    next(error);\n-  }\n-});\n-\n-// æ£€æŸ¥ComfyUIä»»åŠ¡çŠ¶æ€\n-router.get('/check-comfyui/:taskId', authenticateToken, async (req, res, next) => {\n-  try {\n-    const { taskId } = req.params;\n-\n-    // èŽ·å–ä»»åŠ¡ä¿¡æ¯\n-    const tasks = await query(\n-      'SELECT * FROM processing_tasks WHERE id = ? AND user_id = ?',\n-      [taskId, req.user.id]\n-    );\n-\n-    if (tasks.length === 0) {\n-      return res.status(404).json({\n-        success: false,\n-        message: 'ä»»åŠ¡ä¸å­˜åœ¨'\n-      });\n-    }\n-\n-    const task = tasks[0];\n-\n-    if (!task.prompt_id) {\n-      return res.json({\n-        success: true,\n-        data: {\n-          status: task.status,\n-          progress: task.progress || 0,\n-          message: 'ä»»åŠ¡å°šæœªæäº¤åˆ°ComfyUI'\n-        }\n-      });\n-    }\n-\n-    try {\n-      // æ£€æŸ¥ComfyUIé˜Ÿåˆ—çŠ¶æ€\n-      const queueStatus = await comfyUIRequest('/queue');\n-\n-      // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­\n-      const isRunning = queueStatus.queue_running?.some(item =>\n-        item[1] === task.prompt_id\n-      );\n-\n-      // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­\n-      const isPending = queueStatus.queue_pending?.some(item =>\n-        item[1] === task.prompt_id\n-      );\n-\n-      let status = task.status;\n-      let progress = task.progress || 0;\n-\n-      if (isRunning) {\n-        status = 'processing';\n-        progress = Math.max(progress, 50); // è¿è¡Œä¸­è‡³å°‘50%è¿›åº¦\n-      } else if (isPending) {\n-        status = 'pending';\n-        progress = Math.max(progress, 10); // ç­‰å¾…ä¸­è‡³å°‘10%è¿›åº¦\n-      } else if (task.status === 'processing') {\n-        // ä¸åœ¨é˜Ÿåˆ—ä¸­ä¸”ä¹‹å‰æ˜¯å¤„ç†ä¸­çŠ¶æ€ï¼Œå¯èƒ½å·²å®Œæˆæˆ–å¤±è´¥\n-        try {\n-          // å°è¯•èŽ·å–åŽ†å²è®°å½•\n-          const historyResult = await comfyUIRequest(`/history/${task.prompt_id}`);\n-\n-          if (historyResult && Object.keys(historyResult).length > 0) {\n-            status = 'completed';\n-            progress = 100;\n-\n-            // æ›´æ–°ä»»åŠ¡çŠ¶æ€\n-            await query(\n-              'UPDATE processing_tasks SET status = ?, progress = ?, completed_at = NOW(), updated_at = NOW() WHERE id = ?',\n-              [status, progress, taskId]\n-            );\n-          }\n-        } catch (historyError) {\n-          console.warn(`âš ï¸ èŽ·å–ä»»åŠ¡åŽ†å²å¤±è´¥: ${historyError.message}`);\n-        }\n-      }\n-\n-      res.json({\n-        success: true,\n-        data: {\n-          taskId,\n-          promptId: task.prompt_id,\n-          status,\n-          progress,\n-          serverUrl: task.server_url,\n-          isRunning,\n-          isPending,\n-          queuePosition: isPending ?\n-            queueStatus.queue_pending?.findIndex(item => item[1] === task.prompt_id) + 1 :\n-            null\n-        }\n-      });\n-\n-    } catch (comfyError) {\n-      console.error(`âŒ æ£€æŸ¥ComfyUIä»»åŠ¡çŠ¶æ€å¤±è´¥: ${comfyError.message}`);\n-\n-      res.json({\n-        success: true,\n-        data: {\n-          status: task.status,\n-          progress: task.progress || 0,\n-          error: comfyError.message,\n-          message: 'æ— æ³•è¿žæŽ¥åˆ°ComfyUIæœåŠ¡å™¨'\n-        }\n-      });\n-    }\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n // èŽ·å–å¤„ç†ä»»åŠ¡åˆ—è¡¨\n router.get('/tasks', authenticateToken, async (req, res, next) => {\n   try {\n     const page = parseInt(req.query.page) || 1;\n@@ -454,11 +240,11 @@\n \n     // èŽ·å–ä»»åŠ¡åˆ—è¡¨\n     const tasks = await query(\n       `SELECT id, type, status, prompt, progress, created_at, updated_at, completed_at\n-       FROM processing_tasks\n-       WHERE user_id = ?\n-       ORDER BY created_at DESC\n+       FROM processing_tasks \n+       WHERE user_id = ? \n+       ORDER BY created_at DESC \n        LIMIT ? OFFSET ?`,\n       [req.user.id, limit, offset]\n     );\n \n@@ -485,9 +271,9 @@\n     const taskId = req.params.id;\n \n     // èŽ·å–ä»»åŠ¡ä¿¡æ¯\n     const tasks = await query(\n-      `SELECT * FROM processing_tasks\n+      `SELECT * FROM processing_tasks \n        WHERE id = ? AND user_id = ?`,\n       [taskId, req.user.id]\n     );\n \n@@ -546,11 +332,11 @@\n \n     // èŽ·å–å›¾ç‰‡åˆ—è¡¨\n     const images = await query(\n       `SELECT id, filename, original_name, file_size, mime_type, created_at\n-       FROM images\n-       WHERE user_id = ?\n-       ORDER BY created_at DESC\n+       FROM images \n+       WHERE user_id = ? \n+       ORDER BY created_at DESC \n        LIMIT ? OFFSET ?`,\n       [req.user.id, limit, offset]\n     );\n \n"
                },
                {
                    "date": 1752332713894,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,8 +4,9 @@\n const fs = require('fs').promises;\n const Joi = require('joi');\n const { query } = require('../config/database');\n const { authenticateToken, optionalAuth } = require('../middleware/auth');\n+const { comfyUIRequest, selectBestServer } = require('../utils/comfyUIRequest');\n \n const router = express.Router();\n \n // ç¡®ä¿ä¸Šä¼ ç›®å½•å­˜åœ¨\n@@ -62,9 +63,9 @@\n     }\n \n     // ä¿å­˜å›¾ç‰‡ä¿¡æ¯åˆ°æ•°æ®åº“\n     const result = await query(\n-      `INSERT INTO images (user_id, filename, original_name, file_path, file_size, mime_type, created_at) \n+      `INSERT INTO images (user_id, filename, original_name, file_path, file_size, mime_type, created_at)\n        VALUES (?, ?, ?, ?, ?, ?, NOW())`,\n       [\n         req.user.id,\n         req.file.filename,\n@@ -111,9 +112,9 @@\n \n     // æ‰¹é‡ä¿å­˜å›¾ç‰‡ä¿¡æ¯\n     for (const file of req.files) {\n       const result = await query(\n-        `INSERT INTO images (user_id, filename, original_name, file_path, file_size, mime_type, created_at) \n+        `INSERT INTO images (user_id, filename, original_name, file_path, file_size, mime_type, created_at)\n          VALUES (?, ?, ?, ?, ?, ?, NOW())`,\n         [\n           req.user.id,\n           file.filename,\n@@ -175,9 +176,9 @@\n     }\n \n     // éªŒè¯å›¾ç‰‡æ˜¯å¦å±žäºŽå½“å‰ç”¨æˆ·\n     const images = await query(\n-      `SELECT id, filename, file_path FROM images \n+      `SELECT id, filename, file_path FROM images\n        WHERE id IN (${imageIds.map(() => '?').join(',')}) AND user_id = ?`,\n       [...imageIds, req.user.id]\n     );\n \n@@ -189,9 +190,9 @@\n     }\n \n     // åˆ›å»ºå¤„ç†ä»»åŠ¡\n     const taskResult = await query(\n-      `INSERT INTO processing_tasks (user_id, type, status, prompt, settings, created_at) \n+      `INSERT INTO processing_tasks (user_id, type, status, prompt, settings, created_at)\n        VALUES (?, ?, ?, ?, ?, NOW())`,\n       [req.user.id, type, 'pending', prompt || null, JSON.stringify(settings || {})]\n     );\n \n@@ -223,8 +224,221 @@\n     next(error);\n   }\n });\n \n+// æ‰§è¡ŒComfyUIå›¾åƒå¤„ç†ä»»åŠ¡ï¼ˆä½¿ç”¨è´Ÿè½½å‡è¡¡ï¼‰\n+router.post('/process-comfyui', authenticateToken, async (req, res, next) => {\n+  try {\n+    const { taskId, workflow } = req.body;\n+\n+    // éªŒè¯ä»»åŠ¡ID\n+    if (!taskId) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'è¯·æä¾›ä»»åŠ¡ID'\n+      });\n+    }\n+\n+    // éªŒè¯å·¥ä½œæµ\n+    if (!workflow) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'è¯·æä¾›ComfyUIå·¥ä½œæµ'\n+      });\n+    }\n+\n+    // éªŒè¯ä»»åŠ¡æ˜¯å¦å±žäºŽå½“å‰ç”¨æˆ·\n+    const tasks = await query(\n+      'SELECT * FROM processing_tasks WHERE id = ? AND user_id = ?',\n+      [taskId, req.user.id]\n+    );\n+\n+    if (tasks.length === 0) {\n+      return res.status(404).json({\n+        success: false,\n+        message: 'ä»»åŠ¡ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®'\n+      });\n+    }\n+\n+    const task = tasks[0];\n+\n+    // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\n+    if (task.status !== 'pending') {\n+      return res.status(400).json({\n+        success: false,\n+        message: `ä»»åŠ¡çŠ¶æ€ä¸º${task.status}ï¼Œæ— æ³•æ‰§è¡Œ`\n+      });\n+    }\n+\n+    console.log(`ðŸŽ¯ å¼€å§‹æ‰§è¡ŒComfyUIä»»åŠ¡: ${taskId}, ç±»åž‹: ${task.type}`);\n+\n+    // é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n+    const selectedServer = await selectBestServer();\n+    console.log(`âœ… é€‰æ‹©æœåŠ¡å™¨: ${selectedServer}`);\n+\n+    // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤„ç†ä¸­\n+    await query(\n+      'UPDATE processing_tasks SET status = ?, server_url = ?, updated_at = NOW() WHERE id = ?',\n+      ['processing', selectedServer, taskId]\n+    );\n+\n+    try {\n+      // å‘é€å·¥ä½œæµåˆ°ComfyUIæœåŠ¡å™¨\n+      const promptResult = await comfyUIRequest('/prompt', {\n+        method: 'POST',\n+        body: JSON.stringify({\n+          prompt: workflow,\n+          client_id: `ai-magic-${taskId}`\n+        })\n+      });\n+\n+      console.log(`âœ… ComfyUIä»»åŠ¡æäº¤æˆåŠŸ: ${JSON.stringify(promptResult)}`);\n+\n+      // æ›´æ–°ä»»åŠ¡çŠ¶æ€å’Œprompt_id\n+      await query(\n+        'UPDATE processing_tasks SET prompt_id = ?, progress = ?, updated_at = NOW() WHERE id = ?',\n+        [promptResult.prompt_id, 10, taskId]\n+      );\n+\n+      res.json({\n+        success: true,\n+        message: 'ComfyUIä»»åŠ¡æäº¤æˆåŠŸ',\n+        data: {\n+          taskId,\n+          promptId: promptResult.prompt_id,\n+          selectedServer,\n+          status: 'processing'\n+        }\n+      });\n+\n+    } catch (comfyError) {\n+      console.error(`âŒ ComfyUIä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${comfyError.message}`);\n+\n+      // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤±è´¥\n+      await query(\n+        'UPDATE processing_tasks SET status = ?, error_message = ?, updated_at = NOW() WHERE id = ?',\n+        ['failed', comfyError.message, taskId]\n+      );\n+\n+      throw comfyError;\n+    }\n+\n+  } catch (error) {\n+    console.error('âŒ å¤„ç†ComfyUIä»»åŠ¡å¤±è´¥:', error);\n+    next(error);\n+  }\n+});\n+\n+// æ£€æŸ¥ComfyUIä»»åŠ¡çŠ¶æ€\n+router.get('/check-comfyui/:taskId', authenticateToken, async (req, res, next) => {\n+  try {\n+    const { taskId } = req.params;\n+\n+    // èŽ·å–ä»»åŠ¡ä¿¡æ¯\n+    const tasks = await query(\n+      'SELECT * FROM processing_tasks WHERE id = ? AND user_id = ?',\n+      [taskId, req.user.id]\n+    );\n+\n+    if (tasks.length === 0) {\n+      return res.status(404).json({\n+        success: false,\n+        message: 'ä»»åŠ¡ä¸å­˜åœ¨'\n+      });\n+    }\n+\n+    const task = tasks[0];\n+\n+    if (!task.prompt_id) {\n+      return res.json({\n+        success: true,\n+        data: {\n+          status: task.status,\n+          progress: task.progress || 0,\n+          message: 'ä»»åŠ¡å°šæœªæäº¤åˆ°ComfyUI'\n+        }\n+      });\n+    }\n+\n+    try {\n+      // æ£€æŸ¥ComfyUIé˜Ÿåˆ—çŠ¶æ€\n+      const queueStatus = await comfyUIRequest('/queue');\n+\n+      // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­\n+      const isRunning = queueStatus.queue_running?.some(item =>\n+        item[1] === task.prompt_id\n+      );\n+\n+      // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­\n+      const isPending = queueStatus.queue_pending?.some(item =>\n+        item[1] === task.prompt_id\n+      );\n+\n+      let status = task.status;\n+      let progress = task.progress || 0;\n+\n+      if (isRunning) {\n+        status = 'processing';\n+        progress = Math.max(progress, 50); // è¿è¡Œä¸­è‡³å°‘50%è¿›åº¦\n+      } else if (isPending) {\n+        status = 'pending';\n+        progress = Math.max(progress, 10); // ç­‰å¾…ä¸­è‡³å°‘10%è¿›åº¦\n+      } else if (task.status === 'processing') {\n+        // ä¸åœ¨é˜Ÿåˆ—ä¸­ä¸”ä¹‹å‰æ˜¯å¤„ç†ä¸­çŠ¶æ€ï¼Œå¯èƒ½å·²å®Œæˆæˆ–å¤±è´¥\n+        try {\n+          // å°è¯•èŽ·å–åŽ†å²è®°å½•\n+          const historyResult = await comfyUIRequest(`/history/${task.prompt_id}`);\n+\n+          if (historyResult && Object.keys(historyResult).length > 0) {\n+            status = 'completed';\n+            progress = 100;\n+\n+            // æ›´æ–°ä»»åŠ¡çŠ¶æ€\n+            await query(\n+              'UPDATE processing_tasks SET status = ?, progress = ?, completed_at = NOW(), updated_at = NOW() WHERE id = ?',\n+              [status, progress, taskId]\n+            );\n+          }\n+        } catch (historyError) {\n+          console.warn(`âš ï¸ èŽ·å–ä»»åŠ¡åŽ†å²å¤±è´¥: ${historyError.message}`);\n+        }\n+      }\n+\n+      res.json({\n+        success: true,\n+        data: {\n+          taskId,\n+          promptId: task.prompt_id,\n+          status,\n+          progress,\n+          serverUrl: task.server_url,\n+          isRunning,\n+          isPending,\n+          queuePosition: isPending ?\n+            queueStatus.queue_pending?.findIndex(item => item[1] === task.prompt_id) + 1 :\n+            null\n+        }\n+      });\n+\n+    } catch (comfyError) {\n+      console.error(`âŒ æ£€æŸ¥ComfyUIä»»åŠ¡çŠ¶æ€å¤±è´¥: ${comfyError.message}`);\n+\n+      res.json({\n+        success: true,\n+        data: {\n+          status: task.status,\n+          progress: task.progress || 0,\n+          error: comfyError.message,\n+          message: 'æ— æ³•è¿žæŽ¥åˆ°ComfyUIæœåŠ¡å™¨'\n+        }\n+      });\n+    }\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n // èŽ·å–å¤„ç†ä»»åŠ¡åˆ—è¡¨\n router.get('/tasks', authenticateToken, async (req, res, next) => {\n   try {\n     const page = parseInt(req.query.page) || 1;\n@@ -240,11 +454,11 @@\n \n     // èŽ·å–ä»»åŠ¡åˆ—è¡¨\n     const tasks = await query(\n       `SELECT id, type, status, prompt, progress, created_at, updated_at, completed_at\n-       FROM processing_tasks \n-       WHERE user_id = ? \n-       ORDER BY created_at DESC \n+       FROM processing_tasks\n+       WHERE user_id = ?\n+       ORDER BY created_at DESC\n        LIMIT ? OFFSET ?`,\n       [req.user.id, limit, offset]\n     );\n \n@@ -271,9 +485,9 @@\n     const taskId = req.params.id;\n \n     // èŽ·å–ä»»åŠ¡ä¿¡æ¯\n     const tasks = await query(\n-      `SELECT * FROM processing_tasks \n+      `SELECT * FROM processing_tasks\n        WHERE id = ? AND user_id = ?`,\n       [taskId, req.user.id]\n     );\n \n@@ -332,11 +546,11 @@\n \n     // èŽ·å–å›¾ç‰‡åˆ—è¡¨\n     const images = await query(\n       `SELECT id, filename, original_name, file_size, mime_type, created_at\n-       FROM images \n-       WHERE user_id = ? \n-       ORDER BY created_at DESC \n+       FROM images\n+       WHERE user_id = ?\n+       ORDER BY created_at DESC\n        LIMIT ? OFFSET ?`,\n       [req.user.id, limit, offset]\n     );\n \n"
                },
                {
                    "date": 1752332764878,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,9 +4,8 @@\n const fs = require('fs').promises;\n const Joi = require('joi');\n const { query } = require('../config/database');\n const { authenticateToken, optionalAuth } = require('../middleware/auth');\n-const { comfyUIRequest, selectBestServer } = require('../utils/comfyUIRequest');\n \n const router = express.Router();\n \n // ç¡®ä¿ä¸Šä¼ ç›®å½•å­˜åœ¨\n@@ -63,9 +62,9 @@\n     }\n \n     // ä¿å­˜å›¾ç‰‡ä¿¡æ¯åˆ°æ•°æ®åº“\n     const result = await query(\n-      `INSERT INTO images (user_id, filename, original_name, file_path, file_size, mime_type, created_at)\n+      `INSERT INTO images (user_id, filename, original_name, file_path, file_size, mime_type, created_at) \n        VALUES (?, ?, ?, ?, ?, ?, NOW())`,\n       [\n         req.user.id,\n         req.file.filename,\n@@ -112,9 +111,9 @@\n \n     // æ‰¹é‡ä¿å­˜å›¾ç‰‡ä¿¡æ¯\n     for (const file of req.files) {\n       const result = await query(\n-        `INSERT INTO images (user_id, filename, original_name, file_path, file_size, mime_type, created_at)\n+        `INSERT INTO images (user_id, filename, original_name, file_path, file_size, mime_type, created_at) \n          VALUES (?, ?, ?, ?, ?, ?, NOW())`,\n         [\n           req.user.id,\n           file.filename,\n@@ -176,9 +175,9 @@\n     }\n \n     // éªŒè¯å›¾ç‰‡æ˜¯å¦å±žäºŽå½“å‰ç”¨æˆ·\n     const images = await query(\n-      `SELECT id, filename, file_path FROM images\n+      `SELECT id, filename, file_path FROM images \n        WHERE id IN (${imageIds.map(() => '?').join(',')}) AND user_id = ?`,\n       [...imageIds, req.user.id]\n     );\n \n@@ -190,9 +189,9 @@\n     }\n \n     // åˆ›å»ºå¤„ç†ä»»åŠ¡\n     const taskResult = await query(\n-      `INSERT INTO processing_tasks (user_id, type, status, prompt, settings, created_at)\n+      `INSERT INTO processing_tasks (user_id, type, status, prompt, settings, created_at) \n        VALUES (?, ?, ?, ?, ?, NOW())`,\n       [req.user.id, type, 'pending', prompt || null, JSON.stringify(settings || {})]\n     );\n \n@@ -224,221 +223,8 @@\n     next(error);\n   }\n });\n \n-// æ‰§è¡ŒComfyUIå›¾åƒå¤„ç†ä»»åŠ¡ï¼ˆä½¿ç”¨è´Ÿè½½å‡è¡¡ï¼‰\n-router.post('/process-comfyui', authenticateToken, async (req, res, next) => {\n-  try {\n-    const { taskId, workflow } = req.body;\n-\n-    // éªŒè¯ä»»åŠ¡ID\n-    if (!taskId) {\n-      return res.status(400).json({\n-        success: false,\n-        message: 'è¯·æä¾›ä»»åŠ¡ID'\n-      });\n-    }\n-\n-    // éªŒè¯å·¥ä½œæµ\n-    if (!workflow) {\n-      return res.status(400).json({\n-        success: false,\n-        message: 'è¯·æä¾›ComfyUIå·¥ä½œæµ'\n-      });\n-    }\n-\n-    // éªŒè¯ä»»åŠ¡æ˜¯å¦å±žäºŽå½“å‰ç”¨æˆ·\n-    const tasks = await query(\n-      'SELECT * FROM processing_tasks WHERE id = ? AND user_id = ?',\n-      [taskId, req.user.id]\n-    );\n-\n-    if (tasks.length === 0) {\n-      return res.status(404).json({\n-        success: false,\n-        message: 'ä»»åŠ¡ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®'\n-      });\n-    }\n-\n-    const task = tasks[0];\n-\n-    // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€\n-    if (task.status !== 'pending') {\n-      return res.status(400).json({\n-        success: false,\n-        message: `ä»»åŠ¡çŠ¶æ€ä¸º${task.status}ï¼Œæ— æ³•æ‰§è¡Œ`\n-      });\n-    }\n-\n-    console.log(`ðŸŽ¯ å¼€å§‹æ‰§è¡ŒComfyUIä»»åŠ¡: ${taskId}, ç±»åž‹: ${task.type}`);\n-\n-    // é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n-    const selectedServer = await selectBestServer();\n-    console.log(`âœ… é€‰æ‹©æœåŠ¡å™¨: ${selectedServer}`);\n-\n-    // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤„ç†ä¸­\n-    await query(\n-      'UPDATE processing_tasks SET status = ?, server_url = ?, updated_at = NOW() WHERE id = ?',\n-      ['processing', selectedServer, taskId]\n-    );\n-\n-    try {\n-      // å‘é€å·¥ä½œæµåˆ°ComfyUIæœåŠ¡å™¨\n-      const promptResult = await comfyUIRequest('/prompt', {\n-        method: 'POST',\n-        body: JSON.stringify({\n-          prompt: workflow,\n-          client_id: `ai-magic-${taskId}`\n-        })\n-      });\n-\n-      console.log(`âœ… ComfyUIä»»åŠ¡æäº¤æˆåŠŸ: ${JSON.stringify(promptResult)}`);\n-\n-      // æ›´æ–°ä»»åŠ¡çŠ¶æ€å’Œprompt_id\n-      await query(\n-        'UPDATE processing_tasks SET prompt_id = ?, progress = ?, updated_at = NOW() WHERE id = ?',\n-        [promptResult.prompt_id, 10, taskId]\n-      );\n-\n-      res.json({\n-        success: true,\n-        message: 'ComfyUIä»»åŠ¡æäº¤æˆåŠŸ',\n-        data: {\n-          taskId,\n-          promptId: promptResult.prompt_id,\n-          selectedServer,\n-          status: 'processing'\n-        }\n-      });\n-\n-    } catch (comfyError) {\n-      console.error(`âŒ ComfyUIä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${comfyError.message}`);\n-\n-      // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤±è´¥\n-      await query(\n-        'UPDATE processing_tasks SET status = ?, error_message = ?, updated_at = NOW() WHERE id = ?',\n-        ['failed', comfyError.message, taskId]\n-      );\n-\n-      throw comfyError;\n-    }\n-\n-  } catch (error) {\n-    console.error('âŒ å¤„ç†ComfyUIä»»åŠ¡å¤±è´¥:', error);\n-    next(error);\n-  }\n-});\n-\n-// æ£€æŸ¥ComfyUIä»»åŠ¡çŠ¶æ€\n-router.get('/check-comfyui/:taskId', authenticateToken, async (req, res, next) => {\n-  try {\n-    const { taskId } = req.params;\n-\n-    // èŽ·å–ä»»åŠ¡ä¿¡æ¯\n-    const tasks = await query(\n-      'SELECT * FROM processing_tasks WHERE id = ? AND user_id = ?',\n-      [taskId, req.user.id]\n-    );\n-\n-    if (tasks.length === 0) {\n-      return res.status(404).json({\n-        success: false,\n-        message: 'ä»»åŠ¡ä¸å­˜åœ¨'\n-      });\n-    }\n-\n-    const task = tasks[0];\n-\n-    if (!task.prompt_id) {\n-      return res.json({\n-        success: true,\n-        data: {\n-          status: task.status,\n-          progress: task.progress || 0,\n-          message: 'ä»»åŠ¡å°šæœªæäº¤åˆ°ComfyUI'\n-        }\n-      });\n-    }\n-\n-    try {\n-      // æ£€æŸ¥ComfyUIé˜Ÿåˆ—çŠ¶æ€\n-      const queueStatus = await comfyUIRequest('/queue');\n-\n-      // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­\n-      const isRunning = queueStatus.queue_running?.some(item =>\n-        item[1] === task.prompt_id\n-      );\n-\n-      // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­\n-      const isPending = queueStatus.queue_pending?.some(item =>\n-        item[1] === task.prompt_id\n-      );\n-\n-      let status = task.status;\n-      let progress = task.progress || 0;\n-\n-      if (isRunning) {\n-        status = 'processing';\n-        progress = Math.max(progress, 50); // è¿è¡Œä¸­è‡³å°‘50%è¿›åº¦\n-      } else if (isPending) {\n-        status = 'pending';\n-        progress = Math.max(progress, 10); // ç­‰å¾…ä¸­è‡³å°‘10%è¿›åº¦\n-      } else if (task.status === 'processing') {\n-        // ä¸åœ¨é˜Ÿåˆ—ä¸­ä¸”ä¹‹å‰æ˜¯å¤„ç†ä¸­çŠ¶æ€ï¼Œå¯èƒ½å·²å®Œæˆæˆ–å¤±è´¥\n-        try {\n-          // å°è¯•èŽ·å–åŽ†å²è®°å½•\n-          const historyResult = await comfyUIRequest(`/history/${task.prompt_id}`);\n-\n-          if (historyResult && Object.keys(historyResult).length > 0) {\n-            status = 'completed';\n-            progress = 100;\n-\n-            // æ›´æ–°ä»»åŠ¡çŠ¶æ€\n-            await query(\n-              'UPDATE processing_tasks SET status = ?, progress = ?, completed_at = NOW(), updated_at = NOW() WHERE id = ?',\n-              [status, progress, taskId]\n-            );\n-          }\n-        } catch (historyError) {\n-          console.warn(`âš ï¸ èŽ·å–ä»»åŠ¡åŽ†å²å¤±è´¥: ${historyError.message}`);\n-        }\n-      }\n-\n-      res.json({\n-        success: true,\n-        data: {\n-          taskId,\n-          promptId: task.prompt_id,\n-          status,\n-          progress,\n-          serverUrl: task.server_url,\n-          isRunning,\n-          isPending,\n-          queuePosition: isPending ?\n-            queueStatus.queue_pending?.findIndex(item => item[1] === task.prompt_id) + 1 :\n-            null\n-        }\n-      });\n-\n-    } catch (comfyError) {\n-      console.error(`âŒ æ£€æŸ¥ComfyUIä»»åŠ¡çŠ¶æ€å¤±è´¥: ${comfyError.message}`);\n-\n-      res.json({\n-        success: true,\n-        data: {\n-          status: task.status,\n-          progress: task.progress || 0,\n-          error: comfyError.message,\n-          message: 'æ— æ³•è¿žæŽ¥åˆ°ComfyUIæœåŠ¡å™¨'\n-        }\n-      });\n-    }\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n // èŽ·å–å¤„ç†ä»»åŠ¡åˆ—è¡¨\n router.get('/tasks', authenticateToken, async (req, res, next) => {\n   try {\n     const page = parseInt(req.query.page) || 1;\n@@ -454,11 +240,11 @@\n \n     // èŽ·å–ä»»åŠ¡åˆ—è¡¨\n     const tasks = await query(\n       `SELECT id, type, status, prompt, progress, created_at, updated_at, completed_at\n-       FROM processing_tasks\n-       WHERE user_id = ?\n-       ORDER BY created_at DESC\n+       FROM processing_tasks \n+       WHERE user_id = ? \n+       ORDER BY created_at DESC \n        LIMIT ? OFFSET ?`,\n       [req.user.id, limit, offset]\n     );\n \n@@ -485,9 +271,9 @@\n     const taskId = req.params.id;\n \n     // èŽ·å–ä»»åŠ¡ä¿¡æ¯\n     const tasks = await query(\n-      `SELECT * FROM processing_tasks\n+      `SELECT * FROM processing_tasks \n        WHERE id = ? AND user_id = ?`,\n       [taskId, req.user.id]\n     );\n \n@@ -546,11 +332,11 @@\n \n     // èŽ·å–å›¾ç‰‡åˆ—è¡¨\n     const images = await query(\n       `SELECT id, filename, original_name, file_size, mime_type, created_at\n-       FROM images\n-       WHERE user_id = ?\n-       ORDER BY created_at DESC\n+       FROM images \n+       WHERE user_id = ? \n+       ORDER BY created_at DESC \n        LIMIT ? OFFSET ?`,\n       [req.user.id, limit, offset]\n     );\n \n"
                }
            ],
            "date": 1752331689147,
            "name": "Commit-0",
            "content": "const express = require('express');\nconst multer = require('multer');\nconst path = require('path');\nconst fs = require('fs').promises;\nconst Joi = require('joi');\nconst { query } = require('../config/database');\nconst { authenticateToken, optionalAuth } = require('../middleware/auth');\nconst { comfyUIRequest, selectBestServer } = require('../utils/comfyUIRequest');\n\nconst router = express.Router();\n\n// ç¡®ä¿ä¸Šä¼ ç›®å½•å­˜åœ¨\nconst uploadDir = 'uploads/images';\nfs.mkdir(uploadDir, { recursive: true }).catch(console.error);\n\n// é…ç½®multeræ–‡ä»¶ä¸Šä¼ \nconst storage = multer.diskStorage({\n  destination: (req, file, cb) => {\n    cb(null, uploadDir);\n  },\n  filename: (req, file, cb) => {\n    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);\n    cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));\n  }\n});\n\nconst fileFilter = (req, file, cb) => {\n  // åªå…è®¸å›¾ç‰‡æ–‡ä»¶\n  if (file.mimetype.startsWith('image/')) {\n    cb(null, true);\n  } else {\n    cb(new Error('åªå…è®¸ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶'), false);\n  }\n};\n\nconst upload = multer({\n  storage,\n  fileFilter,\n  limits: {\n    fileSize: parseInt(process.env.MAX_FILE_SIZE) || 10 * 1024 * 1024 // 10MB\n  }\n});\n\n// å›¾åƒå¤„ç†ä»»åŠ¡éªŒè¯è§„åˆ™\nconst processImageSchema = Joi.object({\n  type: Joi.string().valid('undress', 'text-to-image', 'face-swap').required(),\n  prompt: Joi.string().when('type', {\n    is: 'text-to-image',\n    then: Joi.required(),\n    otherwise: Joi.optional()\n  }),\n  settings: Joi.object().optional()\n});\n\n// ä¸Šä¼ å›¾ç‰‡\nrouter.post('/upload', authenticateToken, upload.single('image'), async (req, res, next) => {\n  try {\n    if (!req.file) {\n      return res.status(400).json({\n        success: false,\n        message: 'è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡'\n      });\n    }\n\n    // ä¿å­˜å›¾ç‰‡ä¿¡æ¯åˆ°æ•°æ®åº“\n    const result = await query(\n      `INSERT INTO images (user_id, filename, original_name, file_path, file_size, mime_type, created_at)\n       VALUES (?, ?, ?, ?, ?, ?, NOW())`,\n      [\n        req.user.id,\n        req.file.filename,\n        req.file.originalname,\n        req.file.path,\n        req.file.size,\n        req.file.mimetype\n      ]\n    );\n\n    res.json({\n      success: true,\n      message: 'å›¾ç‰‡ä¸Šä¼ æˆåŠŸ',\n      data: {\n        image: {\n          id: result.insertId,\n          filename: req.file.filename,\n          originalName: req.file.originalname,\n          url: `/uploads/images/${req.file.filename}`,\n          size: req.file.size\n        }\n      }\n    });\n  } catch (error) {\n    // å¦‚æžœæ•°æ®åº“æ“ä½œå¤±è´¥ï¼Œåˆ é™¤å·²ä¸Šä¼ çš„æ–‡ä»¶\n    if (req.file) {\n      fs.unlink(req.file.path).catch(console.error);\n    }\n    next(error);\n  }\n});\n\n// æ‰¹é‡ä¸Šä¼ å›¾ç‰‡\nrouter.post('/upload-multiple', authenticateToken, upload.array('images', 5), async (req, res, next) => {\n  try {\n    if (!req.files || req.files.length === 0) {\n      return res.status(400).json({\n        success: false,\n        message: 'è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡'\n      });\n    }\n\n    const uploadedImages = [];\n\n    // æ‰¹é‡ä¿å­˜å›¾ç‰‡ä¿¡æ¯\n    for (const file of req.files) {\n      const result = await query(\n        `INSERT INTO images (user_id, filename, original_name, file_path, file_size, mime_type, created_at)\n         VALUES (?, ?, ?, ?, ?, ?, NOW())`,\n        [\n          req.user.id,\n          file.filename,\n          file.originalname,\n          file.path,\n          file.size,\n          file.mimetype\n        ]\n      );\n\n      uploadedImages.push({\n        id: result.insertId,\n        filename: file.filename,\n        originalName: file.originalname,\n        url: `/uploads/images/${file.filename}`,\n        size: file.size\n      });\n    }\n\n    res.json({\n      success: true,\n      message: `æˆåŠŸä¸Šä¼ ${uploadedImages.length}å¼ å›¾ç‰‡`,\n      data: {\n        images: uploadedImages\n      }\n    });\n  } catch (error) {\n    // å¦‚æžœæ•°æ®åº“æ“ä½œå¤±è´¥ï¼Œåˆ é™¤å·²ä¸Šä¼ çš„æ–‡ä»¶\n    if (req.files) {\n      req.files.forEach(file => {\n        fs.unlink(file.path).catch(console.error);\n      });\n    }\n    next(error);\n  }\n});\n\n// åˆ›å»ºå›¾åƒå¤„ç†ä»»åŠ¡\nrouter.post('/process', authenticateToken, async (req, res, next) => {\n  try {\n    // éªŒè¯è¾“å…¥æ•°æ®\n    const { error, value } = processImageSchema.validate(req.body);\n    if (error) {\n      return res.status(400).json({\n        success: false,\n        message: error.details[0].message\n      });\n    }\n\n    const { type, prompt, settings } = value;\n    const { imageIds } = req.body; // å›¾ç‰‡IDæ•°ç»„\n\n    // éªŒè¯å›¾ç‰‡ID\n    if (!imageIds || !Array.isArray(imageIds) || imageIds.length === 0) {\n      return res.status(400).json({\n        success: false,\n        message: 'è¯·æä¾›è¦å¤„ç†çš„å›¾ç‰‡ID'\n      });\n    }\n\n    // éªŒè¯å›¾ç‰‡æ˜¯å¦å±žäºŽå½“å‰ç”¨æˆ·\n    const images = await query(\n      `SELECT id, filename, file_path FROM images\n       WHERE id IN (${imageIds.map(() => '?').join(',')}) AND user_id = ?`,\n      [...imageIds, req.user.id]\n    );\n\n    if (images.length !== imageIds.length) {\n      return res.status(400).json({\n        success: false,\n        message: 'éƒ¨åˆ†å›¾ç‰‡ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®'\n      });\n    }\n\n    // åˆ›å»ºå¤„ç†ä»»åŠ¡\n    const taskResult = await query(\n      `INSERT INTO processing_tasks (user_id, type, status, prompt, settings, created_at)\n       VALUES (?, ?, ?, ?, ?, NOW())`,\n      [req.user.id, type, 'pending', prompt || null, JSON.stringify(settings || {})]\n    );\n\n    const taskId = taskResult.insertId;\n\n    // å…³è”å›¾ç‰‡åˆ°ä»»åŠ¡\n    for (const imageId of imageIds) {\n      await query(\n        'INSERT INTO task_images (task_id, image_id, type) VALUES (?, ?, ?)',\n        [taskId, imageId, 'input']\n      );\n    }\n\n    res.json({\n      success: true,\n      message: 'å›¾åƒå¤„ç†ä»»åŠ¡åˆ›å»ºæˆåŠŸ',\n      data: {\n        task: {\n          id: taskId,\n          type,\n          status: 'pending',\n          prompt,\n          settings,\n          imageCount: images.length\n        }\n      }\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// èŽ·å–å¤„ç†ä»»åŠ¡åˆ—è¡¨\nrouter.get('/tasks', authenticateToken, async (req, res, next) => {\n  try {\n    const page = parseInt(req.query.page) || 1;\n    const limit = parseInt(req.query.limit) || 10;\n    const offset = (page - 1) * limit;\n\n    // èŽ·å–ä»»åŠ¡æ€»æ•°\n    const countResult = await query(\n      'SELECT COUNT(*) as total FROM processing_tasks WHERE user_id = ?',\n      [req.user.id]\n    );\n    const total = countResult[0].total;\n\n    // èŽ·å–ä»»åŠ¡åˆ—è¡¨\n    const tasks = await query(\n      `SELECT id, type, status, prompt, progress, created_at, updated_at, completed_at\n       FROM processing_tasks\n       WHERE user_id = ?\n       ORDER BY created_at DESC\n       LIMIT ? OFFSET ?`,\n      [req.user.id, limit, offset]\n    );\n\n    res.json({\n      success: true,\n      data: {\n        tasks,\n        pagination: {\n          page,\n          limit,\n          total,\n          pages: Math.ceil(total / limit)\n        }\n      }\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// èŽ·å–ä»»åŠ¡è¯¦æƒ…\nrouter.get('/tasks/:id', authenticateToken, async (req, res, next) => {\n  try {\n    const taskId = req.params.id;\n\n    // èŽ·å–ä»»åŠ¡ä¿¡æ¯\n    const tasks = await query(\n      `SELECT * FROM processing_tasks\n       WHERE id = ? AND user_id = ?`,\n      [taskId, req.user.id]\n    );\n\n    if (tasks.length === 0) {\n      return res.status(404).json({\n        success: false,\n        message: 'ä»»åŠ¡ä¸å­˜åœ¨'\n      });\n    }\n\n    const task = tasks[0];\n\n    // èŽ·å–å…³è”çš„å›¾ç‰‡\n    const taskImages = await query(\n      `SELECT ti.type, i.id, i.filename, i.original_name, i.file_path\n       FROM task_images ti\n       JOIN images i ON ti.image_id = i.id\n       WHERE ti.task_id = ?`,\n      [taskId]\n    );\n\n    // æŒ‰ç±»åž‹åˆ†ç»„å›¾ç‰‡\n    const images = {\n      input: taskImages.filter(img => img.type === 'input'),\n      output: taskImages.filter(img => img.type === 'output')\n    };\n\n    res.json({\n      success: true,\n      data: {\n        task: {\n          ...task,\n          settings: task.settings ? JSON.parse(task.settings) : {},\n          images\n        }\n      }\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// èŽ·å–ç”¨æˆ·çš„å›¾ç‰‡åˆ—è¡¨\nrouter.get('/', authenticateToken, async (req, res, next) => {\n  try {\n    const page = parseInt(req.query.page) || 1;\n    const limit = parseInt(req.query.limit) || 20;\n    const offset = (page - 1) * limit;\n\n    // èŽ·å–å›¾ç‰‡æ€»æ•°\n    const countResult = await query(\n      'SELECT COUNT(*) as total FROM images WHERE user_id = ?',\n      [req.user.id]\n    );\n    const total = countResult[0].total;\n\n    // èŽ·å–å›¾ç‰‡åˆ—è¡¨\n    const images = await query(\n      `SELECT id, filename, original_name, file_size, mime_type, created_at\n       FROM images\n       WHERE user_id = ?\n       ORDER BY created_at DESC\n       LIMIT ? OFFSET ?`,\n      [req.user.id, limit, offset]\n    );\n\n    // æ·»åŠ URL\n    const imagesWithUrl = images.map(image => ({\n      ...image,\n      url: `/uploads/images/${image.filename}`\n    }));\n\n    res.json({\n      success: true,\n      data: {\n        images: imagesWithUrl,\n        pagination: {\n          page,\n          limit,\n          total,\n          pages: Math.ceil(total / limit)\n        }\n      }\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\nmodule.exports = router;\n"
        }
    ]
}