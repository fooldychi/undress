{
    "sourceFile": "server/src/routes/config.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1752325621617,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752408878885,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -52,11 +52,27 @@\n       }\n       groupedConfigs[config.config_group].push(config);\n     });\n \n+    // åŒæ—¶æä¾›æ‰å¹³åŒ–çš„é…ç½®æ•°æ®ï¼Œæ–¹ä¾¿å‰ç«¯ä½¿ç”¨\n+    const flatConfigs = {};\n+    processedConfigs.forEach(config => {\n+      let value = config.config_value;\n+\n+      // æ ¹æ®ç±»å‹è½¬æ¢å€¼\n+      if (config.config_type === 'number') {\n+        value = parseInt(value) || 0;\n+      } else if (config.config_type === 'boolean') {\n+        value = value === 'true' || value === '1' || value === true;\n+      }\n+\n+      flatConfigs[config.config_key] = value;\n+    });\n+\n     res.json({\n       success: true,\n-      data: groupedConfigs\n+      data: flatConfigs,\n+      grouped: groupedConfigs\n     });\n   } catch (error) {\n     console.error('è·å–é…ç½®å¤±è´¥:', error);\n     res.status(500).json({\n"
                }
            ],
            "date": 1752325621617,
            "name": "Commit-0",
            "content": "const express = require('express');\nconst router = express.Router();\nconst { query } = require('../config/database');\nconst { adminAuth } = require('../middleware/adminAuth');\nconst crypto = require('crypto');\n\n// åŠ å¯†å¯†é’¥ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥ä»ç¯å¢ƒå˜é‡è·å–ï¼‰\nconst ENCRYPTION_KEY = process.env.CONFIG_ENCRYPTION_KEY || 'your-32-char-secret-key-here!!';\n\n// åŠ å¯†å‡½æ•°\nfunction encrypt(text) {\n  const cipher = crypto.createCipher('aes-256-cbc', ENCRYPTION_KEY);\n  let encrypted = cipher.update(text, 'utf8', 'hex');\n  encrypted += cipher.final('hex');\n  return encrypted;\n}\n\n// è§£å¯†å‡½æ•°\nfunction decrypt(encryptedText) {\n  const decipher = crypto.createDecipher('aes-256-cbc', ENCRYPTION_KEY);\n  let decrypted = decipher.update(encryptedText, 'hex', 'utf8');\n  decrypted += decipher.final('utf8');\n  return decrypted;\n}\n\n// è·å–æ‰€æœ‰é…ç½®\nrouter.get('/', adminAuth, async (req, res) => {\n  try {\n    const configs = await query(`\n      SELECT config_key, config_value, config_type, config_group, description, is_encrypted\n      FROM system_config\n      ORDER BY config_group, config_key\n    `);\n\n    // è§£å¯†æ•æ„Ÿé…ç½®\n    const processedConfigs = configs.map(config => {\n      if (config.is_encrypted && config.config_value) {\n        try {\n          config.config_value = decrypt(config.config_value);\n        } catch (error) {\n          console.error('è§£å¯†é…ç½®å¤±è´¥:', config.config_key, error);\n        }\n      }\n      return config;\n    });\n\n    // æŒ‰åˆ†ç»„ç»„ç»‡é…ç½®\n    const groupedConfigs = {};\n    processedConfigs.forEach(config => {\n      if (!groupedConfigs[config.config_group]) {\n        groupedConfigs[config.config_group] = [];\n      }\n      groupedConfigs[config.config_group].push(config);\n    });\n\n    res.json({\n      success: true,\n      data: groupedConfigs\n    });\n  } catch (error) {\n    console.error('è·å–é…ç½®å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'è·å–é…ç½®å¤±è´¥'\n    });\n  }\n});\n\n// è·å–å•ä¸ªé…ç½®\nrouter.get('/:key', async (req, res) => {\n  try {\n    const { key } = req.params;\n    const configs = await query(\n      'SELECT config_value, is_encrypted FROM system_config WHERE config_key = ?',\n      [key]\n    );\n\n    if (configs.length === 0) {\n      return res.status(404).json({\n        success: false,\n        message: 'é…ç½®ä¸å­˜åœ¨'\n      });\n    }\n\n    let value = configs[0].config_value;\n    if (configs[0].is_encrypted && value) {\n      try {\n        value = decrypt(value);\n      } catch (error) {\n        console.error('è§£å¯†é…ç½®å¤±è´¥:', key, error);\n      }\n    }\n\n    res.json({\n      success: true,\n      data: value\n    });\n  } catch (error) {\n    console.error('è·å–é…ç½®å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'è·å–é…ç½®å¤±è´¥'\n    });\n  }\n});\n\n// æ›´æ–°é…ç½®\nrouter.put('/', async (req, res) => {\n  try {\n    const { configs } = req.body;\n\n    if (!configs || !Array.isArray(configs)) {\n      return res.status(400).json({\n        success: false,\n        message: 'é…ç½®æ•°æ®æ ¼å¼é”™è¯¯'\n      });\n    }\n\n    // å¼€å§‹äº‹åŠ¡\n    const results = [];\n    for (const config of configs) {\n      const { config_key, config_value, is_encrypted } = config;\n\n      let valueToStore = config_value;\n\n      // å¦‚æœéœ€è¦åŠ å¯†\n      if (is_encrypted && config_value) {\n        valueToStore = encrypt(config_value);\n      }\n\n      const result = await query(`\n        UPDATE system_config\n        SET config_value = ?, updated_at = CURRENT_TIMESTAMP\n        WHERE config_key = ?\n      `, [valueToStore, config_key]);\n\n      results.push({\n        config_key,\n        updated: result.affectedRows > 0\n      });\n    }\n\n    res.json({\n      success: true,\n      message: 'é…ç½®æ›´æ–°æˆåŠŸ',\n      data: results\n    });\n  } catch (error) {\n    console.error('æ›´æ–°é…ç½®å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'æ›´æ–°é…ç½®å¤±è´¥'\n    });\n  }\n});\n\n// é‡ç½®é…ç½®åˆ°é»˜è®¤å€¼\nrouter.post('/reset', async (req, res) => {\n  try {\n    const { config_group } = req.body;\n\n    let whereClause = '';\n    let params = [];\n\n    if (config_group) {\n      whereClause = 'WHERE config_group = ?';\n      params = [config_group];\n    }\n\n    // è¿™é‡Œå¯ä»¥æ·»åŠ é‡ç½®åˆ°é»˜è®¤å€¼çš„é€»è¾‘\n    // æš‚æ—¶è¿”å›æˆåŠŸå“åº”\n    res.json({\n      success: true,\n      message: 'é…ç½®é‡ç½®æˆåŠŸ'\n    });\n  } catch (error) {\n    console.error('é‡ç½®é…ç½®å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'é‡ç½®é…ç½®å¤±è´¥'\n    });\n  }\n});\n\n// æµ‹è¯•é…ç½®è¿æ¥\nrouter.post('/test', async (req, res) => {\n  try {\n    const { config_group, configs, serverUrl, timeout = 10000 } = req.body;\n\n    if (config_group === 'database') {\n      // æµ‹è¯•æ•°æ®åº“è¿æ¥\n      const mysql = require('mysql2/promise');\n      const dbConfig = {};\n\n      configs.forEach(config => {\n        const key = config.config_key.replace('database.', '');\n        dbConfig[key] = config.config_value;\n      });\n\n      try {\n        const connection = await mysql.createConnection({\n          host: dbConfig.host,\n          port: dbConfig.port,\n          user: dbConfig.user,\n          password: dbConfig.password,\n          database: dbConfig.name\n        });\n\n        await connection.ping();\n        await connection.end();\n\n        res.json({\n          success: true,\n          message: 'æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ'\n        });\n      } catch (error) {\n        res.json({\n          success: false,\n          message: `æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`\n        });\n      }\n    } else if (config_group === 'comfyui' || serverUrl) {\n      // æµ‹è¯•ComfyUIè¿æ¥\n      const testUrl = serverUrl || configs?.find(c => c.config_key === 'comfyui.server_url')?.config_value;\n\n      if (!testUrl) {\n        return res.json({\n          success: false,\n          message: 'è¯·æä¾›ComfyUIæœåŠ¡å™¨åœ°å€'\n        });\n      }\n\n      console.log(`ğŸ” æµ‹è¯•ComfyUIè¿æ¥: ${testUrl}`);\n\n      // æ„å»ºå¥åº·æ£€æŸ¥URL\n      const healthCheckUrl = `${testUrl.replace(/\\/$/, '')}/system_stats`;\n\n      // ä½¿ç”¨fetchè¿›è¡Œè¿æ¥æµ‹è¯•\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), timeout);\n\n      try {\n        const response = await fetch(healthCheckUrl, {\n          method: 'GET',\n          headers: {\n            'Content-Type': 'application/json',\n            'User-Agent': 'Imagic-Admin/1.0'\n          },\n          signal: controller.signal\n        });\n\n        clearTimeout(timeoutId);\n\n        if (response.ok) {\n          const data = await response.json();\n          console.log('âœ… ComfyUIè¿æ¥æµ‹è¯•æˆåŠŸ');\n\n          res.json({\n            success: true,\n            message: 'ComfyUIæœåŠ¡å™¨è¿æ¥æ­£å¸¸',\n            data: {\n              status: 'connected',\n              responseTime: Date.now(),\n              serverInfo: data\n            }\n          });\n        } else {\n          console.log(`âŒ ComfyUIè¿æ¥æµ‹è¯•å¤±è´¥: HTTP ${response.status}`);\n\n          res.json({\n            success: false,\n            message: `æœåŠ¡å™¨å“åº”é”™è¯¯: HTTP ${response.status}`,\n            data: {\n              status: 'error',\n              statusCode: response.status\n            }\n          });\n        }\n      } catch (fetchError) {\n        clearTimeout(timeoutId);\n\n        if (fetchError.name === 'AbortError') {\n          console.log('âŒ ComfyUIè¿æ¥æµ‹è¯•è¶…æ—¶');\n          res.json({\n            success: false,\n            message: `è¿æ¥è¶…æ—¶ (${timeout}ms)`,\n            data: {\n              status: 'timeout'\n            }\n          });\n        } else {\n          console.log('âŒ ComfyUIè¿æ¥æµ‹è¯•å¤±è´¥:', fetchError.message);\n          res.json({\n            success: false,\n            message: `è¿æ¥å¤±è´¥: ${fetchError.message}`,\n            data: {\n              status: 'error',\n              error: fetchError.message\n            }\n          });\n        }\n      }\n    } else {\n      res.json({\n        success: true,\n        message: 'é…ç½®æµ‹è¯•æˆåŠŸ'\n      });\n    }\n  } catch (error) {\n    console.error('æµ‹è¯•é…ç½®å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'æµ‹è¯•é…ç½®å¤±è´¥'\n    });\n  }\n});\n\nmodule.exports = router;\n"
        }
    ]
}