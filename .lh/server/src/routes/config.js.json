{
    "sourceFile": "server/src/routes/config.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 8,
            "patches": [
                {
                    "date": 1752325621617,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752408878885,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -52,11 +52,27 @@\n       }\n       groupedConfigs[config.config_group].push(config);\n     });\n \n+    // åŒæ—¶æä¾›æ‰å¹³åŒ–çš„é…ç½®æ•°æ®ï¼Œæ–¹ä¾¿å‰ç«¯ä½¿ç”¨\n+    const flatConfigs = {};\n+    processedConfigs.forEach(config => {\n+      let value = config.config_value;\n+\n+      // æ ¹æ®ç±»å‹è½¬æ¢å€¼\n+      if (config.config_type === 'number') {\n+        value = parseInt(value) || 0;\n+      } else if (config.config_type === 'boolean') {\n+        value = value === 'true' || value === '1' || value === true;\n+      }\n+\n+      flatConfigs[config.config_key] = value;\n+    });\n+\n     res.json({\n       success: true,\n-      data: groupedConfigs\n+      data: flatConfigs,\n+      grouped: groupedConfigs\n     });\n   } catch (error) {\n     console.error('è·å–é…ç½®å¤±è´¥:', error);\n     res.status(500).json({\n"
                },
                {
                    "date": 1752545417376,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -247,25 +247,41 @@\n       }\n \n       console.log(`ğŸ” æµ‹è¯•ComfyUIè¿æ¥: ${testUrl}`);\n \n-      // æ„å»ºå¥åº·æ£€æŸ¥URL\n-      const healthCheckUrl = `${testUrl.replace(/\\/$/, '')}/system_stats`;\n+      // åŸºäºComfyUIå®˜æ–¹æ–‡æ¡£çš„å¥åº·æ£€æŸ¥ç«¯ç‚¹\n+      const baseUrl = testUrl.replace(/\\/$/, '');\n+      const testEndpoints = [\n+        '/api/queue',        // ComfyUIå®˜æ–¹é˜Ÿåˆ—ç«¯ç‚¹\n+        '/api/system_stats', // ComfyUIå®˜æ–¹ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n+        '/queue',            // å¤‡ç”¨é˜Ÿåˆ—ç«¯ç‚¹\n+        '/system_stats'      // å¤‡ç”¨ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n+      ];\n \n       // ä½¿ç”¨fetchè¿›è¡Œè¿æ¥æµ‹è¯•\n       const controller = new AbortController();\n       const timeoutId = setTimeout(() => controller.abort(), timeout);\n \n-      try {\n-        const response = await fetch(healthCheckUrl, {\n-          method: 'GET',\n-          headers: {\n-            'Content-Type': 'application/json',\n-            'User-Agent': 'Imagic-Admin/1.0'\n-          },\n-          signal: controller.signal\n-        });\n+      let lastError = null;\n+      let successResult = null;\n \n+      for (const endpoint of testEndpoints) {\n+        try {\n+          const healthCheckUrl = `${baseUrl}${endpoint}`;\n+          console.log(`ğŸ” æµ‹è¯•ç«¯ç‚¹: ${endpoint}`);\n+\n+          const response = await fetch(healthCheckUrl, {\n+            method: 'GET',\n+            headers: {\n+              'Accept': 'application/json, */*',\n+              'Accept-Language': 'zh-CN,zh;q=0.9',\n+              'Cache-Control': 'no-cache',\n+              'comfy-user': 'health-monitor',\n+              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'\n+            },\n+            signal: controller.signal\n+          });\n+\n         clearTimeout(timeoutId);\n \n         if (response.ok) {\n           const data = await response.json();\n"
                },
                {
                    "date": 1752545436821,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -280,35 +280,65 @@\n             },\n             signal: controller.signal\n           });\n \n-        clearTimeout(timeoutId);\n+          if (response.ok) {\n+            try {\n+              const data = await response.json();\n+              console.log(`âœ… ComfyUIç«¯ç‚¹æµ‹è¯•æˆåŠŸ: ${endpoint}`);\n \n-        if (response.ok) {\n-          const data = await response.json();\n-          console.log('âœ… ComfyUIè¿æ¥æµ‹è¯•æˆåŠŸ');\n-\n-          res.json({\n-            success: true,\n-            message: 'ComfyUIæœåŠ¡å™¨è¿æ¥æ­£å¸¸',\n-            data: {\n-              status: 'connected',\n-              responseTime: Date.now(),\n-              serverInfo: data\n+              successResult = {\n+                success: true,\n+                message: `ComfyUIæœåŠ¡å™¨è¿æ¥æ­£å¸¸ (ç«¯ç‚¹: ${endpoint})`,\n+                data: {\n+                  status: 'connected',\n+                  endpoint: endpoint,\n+                  responseTime: Date.now(),\n+                  serverInfo: data\n+                }\n+              };\n+              break; // æ‰¾åˆ°å¯ç”¨ç«¯ç‚¹ï¼Œé€€å‡ºå¾ªç¯\n+            } catch (jsonError) {\n+              console.log(`âš ï¸ ç«¯ç‚¹ ${endpoint} å“åº”éJSONæ ¼å¼ï¼Œä½†è¿æ¥æ­£å¸¸`);\n+              successResult = {\n+                success: true,\n+                message: `ComfyUIæœåŠ¡å™¨è¿æ¥æ­£å¸¸ (ç«¯ç‚¹: ${endpoint})`,\n+                data: {\n+                  status: 'connected',\n+                  endpoint: endpoint,\n+                  responseTime: Date.now(),\n+                  note: 'å“åº”éJSONæ ¼å¼ä½†è¿æ¥æ­£å¸¸'\n+                }\n+              };\n+              break;\n             }\n-          });\n-        } else {\n-          console.log(`âŒ ComfyUIè¿æ¥æµ‹è¯•å¤±è´¥: HTTP ${response.status}`);\n+          } else {\n+            lastError = `ç«¯ç‚¹ ${endpoint}: HTTP ${response.status}`;\n+            console.log(`âŒ ${lastError}`);\n+          }\n+        } catch (endpointError) {\n+          lastError = `ç«¯ç‚¹ ${endpoint}: ${endpointError.message}`;\n+          console.log(`âŒ ${lastError}`);\n+        }\n+      }\n \n-          res.json({\n-            success: false,\n-            message: `æœåŠ¡å™¨å“åº”é”™è¯¯: HTTP ${response.status}`,\n-            data: {\n-              status: 'error',\n-              statusCode: response.status\n-            }\n-          });\n-        }\n+      clearTimeout(timeoutId);\n+\n+      // è¿”å›ç»“æœ\n+      if (successResult) {\n+        res.json(successResult);\n+      } else {\n+        console.log('âŒ æ‰€æœ‰ComfyUIç«¯ç‚¹æµ‹è¯•å¤±è´¥');\n+        res.json({\n+          success: false,\n+          message: `æ‰€æœ‰ComfyUIç«¯ç‚¹æµ‹è¯•å¤±è´¥ã€‚æœ€åé”™è¯¯: ${lastError}`,\n+          data: {\n+            status: 'error',\n+            testedEndpoints: testEndpoints,\n+            lastError: lastError\n+          }\n+        });\n+      }\n       } catch (fetchError) {\n         clearTimeout(timeoutId);\n \n         if (fetchError.name === 'AbortError') {\n"
                },
                {
                    "date": 1752546209565,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -235,9 +235,11 @@\n           message: `æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`\n         });\n       }\n     } else if (config_group === 'comfyui' || serverUrl) {\n-      // æµ‹è¯•ComfyUIè¿æ¥\n+      // ä½¿ç”¨ç»Ÿä¸€çš„ComfyUIå¥åº·æ£€æŸ¥å·¥å…·\n+      const { quickHealthCheck } = require('../../shared/comfyui-health-checker');\n+\n       const testUrl = serverUrl || configs?.find(c => c.config_key === 'comfyui.server_url')?.config_value;\n \n       if (!testUrl) {\n         return res.json({\n@@ -245,97 +247,56 @@\n           message: 'è¯·æä¾›ComfyUIæœåŠ¡å™¨åœ°å€'\n         });\n       }\n \n-      console.log(`ğŸ” æµ‹è¯•ComfyUIè¿æ¥: ${testUrl}`);\n+      console.log(`ğŸ” ä½¿ç”¨å®˜æ–¹æ ‡å‡†æ£€æŸ¥ComfyUIè¿æ¥: ${testUrl}`);\n \n-      // åŸºäºComfyUIå®˜æ–¹æ–‡æ¡£çš„å¥åº·æ£€æŸ¥ç«¯ç‚¹\n-      const baseUrl = testUrl.replace(/\\/$/, '');\n-      const testEndpoints = [\n-        '/api/queue',        // ComfyUIå®˜æ–¹é˜Ÿåˆ—ç«¯ç‚¹\n-        '/api/system_stats', // ComfyUIå®˜æ–¹ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n-        '/queue',            // å¤‡ç”¨é˜Ÿåˆ—ç«¯ç‚¹\n-        '/system_stats'      // å¤‡ç”¨ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n-      ];\n+      try {\n+        // ä½¿ç”¨ç»Ÿä¸€çš„å¥åº·æ£€æŸ¥å·¥å…·\n+        const healthResult = await quickHealthCheck(testUrl, {\n+          timeout: timeout,\n+          requireComfyUIFeatures: true\n+        });\n \n-      // ä½¿ç”¨fetchè¿›è¡Œè¿æ¥æµ‹è¯•\n-      const controller = new AbortController();\n-      const timeoutId = setTimeout(() => controller.abort(), timeout);\n+        if (healthResult.isHealthy) {\n+          console.log('âœ… ComfyUIå¥åº·æ£€æŸ¥é€šè¿‡');\n \n-      let lastError = null;\n-      let successResult = null;\n-\n-      for (const endpoint of testEndpoints) {\n-        try {\n-          const healthCheckUrl = `${baseUrl}${endpoint}`;\n-          console.log(`ğŸ” æµ‹è¯•ç«¯ç‚¹: ${endpoint}`);\n-\n-          const response = await fetch(healthCheckUrl, {\n-            method: 'GET',\n-            headers: {\n-              'Accept': 'application/json, */*',\n-              'Accept-Language': 'zh-CN,zh;q=0.9',\n-              'Cache-Control': 'no-cache',\n-              'comfy-user': 'health-monitor',\n-              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'\n-            },\n-            signal: controller.signal\n+          res.json({\n+            success: true,\n+            message: `ComfyUIæœåŠ¡å™¨è¿æ¥æ­£å¸¸ (${healthResult.recommendation.message})`,\n+            data: {\n+              status: 'connected',\n+              checkDuration: healthResult.checkDuration,\n+              recommendedEndpoint: healthResult.recommendation.recommendedEndpoint,\n+              successfulEndpoints: healthResult.summary.successfulEndpoints,\n+              comfyUIFeatures: healthResult.summary.comfyUIFeatures,\n+              serverInfo: healthResult.summary\n+            }\n           });\n+        } else {\n+          console.log('âŒ ComfyUIå¥åº·æ£€æŸ¥å¤±è´¥');\n \n-          if (response.ok) {\n-            try {\n-              const data = await response.json();\n-              console.log(`âœ… ComfyUIç«¯ç‚¹æµ‹è¯•æˆåŠŸ: ${endpoint}`);\n-\n-              successResult = {\n-                success: true,\n-                message: `ComfyUIæœåŠ¡å™¨è¿æ¥æ­£å¸¸ (ç«¯ç‚¹: ${endpoint})`,\n-                data: {\n-                  status: 'connected',\n-                  endpoint: endpoint,\n-                  responseTime: Date.now(),\n-                  serverInfo: data\n-                }\n-              };\n-              break; // æ‰¾åˆ°å¯ç”¨ç«¯ç‚¹ï¼Œé€€å‡ºå¾ªç¯\n-            } catch (jsonError) {\n-              console.log(`âš ï¸ ç«¯ç‚¹ ${endpoint} å“åº”éJSONæ ¼å¼ï¼Œä½†è¿æ¥æ­£å¸¸`);\n-              successResult = {\n-                success: true,\n-                message: `ComfyUIæœåŠ¡å™¨è¿æ¥æ­£å¸¸ (ç«¯ç‚¹: ${endpoint})`,\n-                data: {\n-                  status: 'connected',\n-                  endpoint: endpoint,\n-                  responseTime: Date.now(),\n-                  note: 'å“åº”éJSONæ ¼å¼ä½†è¿æ¥æ­£å¸¸'\n-                }\n-              };\n-              break;\n+          res.json({\n+            success: false,\n+            message: `ComfyUIæœåŠ¡å™¨å¥åº·æ£€æŸ¥å¤±è´¥: ${healthResult.recommendation.message}`,\n+            data: {\n+              status: 'unhealthy',\n+              checkDuration: healthResult.checkDuration,\n+              successfulEndpoints: healthResult.summary.successfulEndpoints,\n+              totalEndpoints: healthResult.summary.totalEndpoints,\n+              suggestion: healthResult.recommendation.suggestedAction\n             }\n-          } else {\n-            lastError = `ç«¯ç‚¹ ${endpoint}: HTTP ${response.status}`;\n-            console.log(`âŒ ${lastError}`);\n-          }\n-        } catch (endpointError) {\n-          lastError = `ç«¯ç‚¹ ${endpoint}: ${endpointError.message}`;\n-          console.log(`âŒ ${lastError}`);\n+          });\n         }\n-      }\n+      } catch (healthError) {\n+        console.error('âŒ ComfyUIå¥åº·æ£€æŸ¥å‡ºé”™:', healthError);\n \n-      clearTimeout(timeoutId);\n-\n-      // è¿”å›ç»“æœ\n-      if (successResult) {\n-        res.json(successResult);\n-      } else {\n-        console.log('âŒ æ‰€æœ‰ComfyUIç«¯ç‚¹æµ‹è¯•å¤±è´¥');\n         res.json({\n           success: false,\n-          message: `æ‰€æœ‰ComfyUIç«¯ç‚¹æµ‹è¯•å¤±è´¥ã€‚æœ€åé”™è¯¯: ${lastError}`,\n+          message: `ComfyUIå¥åº·æ£€æŸ¥å¤±è´¥: ${healthError.message}`,\n           data: {\n             status: 'error',\n-            testedEndpoints: testEndpoints,\n-            lastError: lastError\n+            error: healthError.message\n           }\n         });\n       }\n       } catch (fetchError) {\n"
                },
                {
                    "date": 1752546325327,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -235,11 +235,9 @@\n           message: `æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`\n         });\n       }\n     } else if (config_group === 'comfyui' || serverUrl) {\n-      // ä½¿ç”¨ç»Ÿä¸€çš„ComfyUIå¥åº·æ£€æŸ¥å·¥å…·\n-      const { quickHealthCheck } = require('../../shared/comfyui-health-checker');\n-\n+      // æµ‹è¯•ComfyUIè¿æ¥\n       const testUrl = serverUrl || configs?.find(c => c.config_key === 'comfyui.server_url')?.config_value;\n \n       if (!testUrl) {\n         return res.json({\n@@ -247,56 +245,97 @@\n           message: 'è¯·æä¾›ComfyUIæœåŠ¡å™¨åœ°å€'\n         });\n       }\n \n-      console.log(`ğŸ” ä½¿ç”¨å®˜æ–¹æ ‡å‡†æ£€æŸ¥ComfyUIè¿æ¥: ${testUrl}`);\n+      console.log(`ğŸ” æµ‹è¯•ComfyUIè¿æ¥: ${testUrl}`);\n \n-      try {\n-        // ä½¿ç”¨ç»Ÿä¸€çš„å¥åº·æ£€æŸ¥å·¥å…·\n-        const healthResult = await quickHealthCheck(testUrl, {\n-          timeout: timeout,\n-          requireComfyUIFeatures: true\n-        });\n+      // åŸºäºComfyUIå®˜æ–¹æ–‡æ¡£çš„å¥åº·æ£€æŸ¥ç«¯ç‚¹\n+      const baseUrl = testUrl.replace(/\\/$/, '');\n+      const testEndpoints = [\n+        '/api/queue',        // ComfyUIå®˜æ–¹é˜Ÿåˆ—ç«¯ç‚¹\n+        '/api/system_stats', // ComfyUIå®˜æ–¹ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n+        '/queue',            // å¤‡ç”¨é˜Ÿåˆ—ç«¯ç‚¹\n+        '/system_stats'      // å¤‡ç”¨ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n+      ];\n \n-        if (healthResult.isHealthy) {\n-          console.log('âœ… ComfyUIå¥åº·æ£€æŸ¥é€šè¿‡');\n+      // ä½¿ç”¨fetchè¿›è¡Œè¿æ¥æµ‹è¯•\n+      const controller = new AbortController();\n+      const timeoutId = setTimeout(() => controller.abort(), timeout);\n \n-          res.json({\n-            success: true,\n-            message: `ComfyUIæœåŠ¡å™¨è¿æ¥æ­£å¸¸ (${healthResult.recommendation.message})`,\n-            data: {\n-              status: 'connected',\n-              checkDuration: healthResult.checkDuration,\n-              recommendedEndpoint: healthResult.recommendation.recommendedEndpoint,\n-              successfulEndpoints: healthResult.summary.successfulEndpoints,\n-              comfyUIFeatures: healthResult.summary.comfyUIFeatures,\n-              serverInfo: healthResult.summary\n-            }\n+      let lastError = null;\n+      let successResult = null;\n+\n+      for (const endpoint of testEndpoints) {\n+        try {\n+          const healthCheckUrl = `${baseUrl}${endpoint}`;\n+          console.log(`ğŸ” æµ‹è¯•ç«¯ç‚¹: ${endpoint}`);\n+\n+          const response = await fetch(healthCheckUrl, {\n+            method: 'GET',\n+            headers: {\n+              'Accept': 'application/json, */*',\n+              'Accept-Language': 'zh-CN,zh;q=0.9',\n+              'Cache-Control': 'no-cache',\n+              'comfy-user': 'health-monitor',\n+              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'\n+            },\n+            signal: controller.signal\n           });\n-        } else {\n-          console.log('âŒ ComfyUIå¥åº·æ£€æŸ¥å¤±è´¥');\n \n-          res.json({\n-            success: false,\n-            message: `ComfyUIæœåŠ¡å™¨å¥åº·æ£€æŸ¥å¤±è´¥: ${healthResult.recommendation.message}`,\n-            data: {\n-              status: 'unhealthy',\n-              checkDuration: healthResult.checkDuration,\n-              successfulEndpoints: healthResult.summary.successfulEndpoints,\n-              totalEndpoints: healthResult.summary.totalEndpoints,\n-              suggestion: healthResult.recommendation.suggestedAction\n+          if (response.ok) {\n+            try {\n+              const data = await response.json();\n+              console.log(`âœ… ComfyUIç«¯ç‚¹æµ‹è¯•æˆåŠŸ: ${endpoint}`);\n+\n+              successResult = {\n+                success: true,\n+                message: `ComfyUIæœåŠ¡å™¨è¿æ¥æ­£å¸¸ (ç«¯ç‚¹: ${endpoint})`,\n+                data: {\n+                  status: 'connected',\n+                  endpoint: endpoint,\n+                  responseTime: Date.now(),\n+                  serverInfo: data\n+                }\n+              };\n+              break; // æ‰¾åˆ°å¯ç”¨ç«¯ç‚¹ï¼Œé€€å‡ºå¾ªç¯\n+            } catch (jsonError) {\n+              console.log(`âš ï¸ ç«¯ç‚¹ ${endpoint} å“åº”éJSONæ ¼å¼ï¼Œä½†è¿æ¥æ­£å¸¸`);\n+              successResult = {\n+                success: true,\n+                message: `ComfyUIæœåŠ¡å™¨è¿æ¥æ­£å¸¸ (ç«¯ç‚¹: ${endpoint})`,\n+                data: {\n+                  status: 'connected',\n+                  endpoint: endpoint,\n+                  responseTime: Date.now(),\n+                  note: 'å“åº”éJSONæ ¼å¼ä½†è¿æ¥æ­£å¸¸'\n+                }\n+              };\n+              break;\n             }\n-          });\n+          } else {\n+            lastError = `ç«¯ç‚¹ ${endpoint}: HTTP ${response.status}`;\n+            console.log(`âŒ ${lastError}`);\n+          }\n+        } catch (endpointError) {\n+          lastError = `ç«¯ç‚¹ ${endpoint}: ${endpointError.message}`;\n+          console.log(`âŒ ${lastError}`);\n         }\n-      } catch (healthError) {\n-        console.error('âŒ ComfyUIå¥åº·æ£€æŸ¥å‡ºé”™:', healthError);\n+      }\n \n+      clearTimeout(timeoutId);\n+\n+      // è¿”å›ç»“æœ\n+      if (successResult) {\n+        res.json(successResult);\n+      } else {\n+        console.log('âŒ æ‰€æœ‰ComfyUIç«¯ç‚¹æµ‹è¯•å¤±è´¥');\n         res.json({\n           success: false,\n-          message: `ComfyUIå¥åº·æ£€æŸ¥å¤±è´¥: ${healthError.message}`,\n+          message: `æ‰€æœ‰ComfyUIç«¯ç‚¹æµ‹è¯•å¤±è´¥ã€‚æœ€åé”™è¯¯: ${lastError}`,\n           data: {\n             status: 'error',\n-            error: healthError.message\n+            testedEndpoints: testEndpoints,\n+            lastError: lastError\n           }\n         });\n       }\n       } catch (fetchError) {\n"
                },
                {
                    "date": 1752548017842,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -251,11 +251,9 @@\n       // åŸºäºComfyUIå®˜æ–¹æ–‡æ¡£çš„å¥åº·æ£€æŸ¥ç«¯ç‚¹\n       const baseUrl = testUrl.replace(/\\/$/, '');\n       const testEndpoints = [\n         '/api/queue',        // ComfyUIå®˜æ–¹é˜Ÿåˆ—ç«¯ç‚¹\n-        '/api/system_stats', // ComfyUIå®˜æ–¹ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n-        '/queue',            // å¤‡ç”¨é˜Ÿåˆ—ç«¯ç‚¹\n-        '/system_stats'      // å¤‡ç”¨ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n+        '/api/system_stats'  // ComfyUIå®˜æ–¹ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n       ];\n \n       // ä½¿ç”¨fetchè¿›è¡Œè¿æ¥æµ‹è¯•\n       const controller = new AbortController();\n"
                },
                {
                    "date": 1752548045278,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -335,9 +335,9 @@\n             lastError: lastError\n           }\n         });\n       }\n-      } catch (fetchError) {\n+    } catch (fetchError) {\n         clearTimeout(timeoutId);\n \n         if (fetchError.name === 'AbortError') {\n           console.log('âŒ ComfyUIè¿æ¥æµ‹è¯•è¶…æ—¶');\n"
                },
                {
                    "date": 1752548899166,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -261,9 +261,10 @@\n \n       let lastError = null;\n       let successResult = null;\n \n-      for (const endpoint of testEndpoints) {\n+      try {\n+        for (const endpoint of testEndpoints) {\n         try {\n           const healthCheckUrl = `${baseUrl}${endpoint}`;\n           console.log(`ğŸ” æµ‹è¯•ç«¯ç‚¹: ${endpoint}`);\n \n"
                }
            ],
            "date": 1752325621617,
            "name": "Commit-0",
            "content": "const express = require('express');\nconst router = express.Router();\nconst { query } = require('../config/database');\nconst { adminAuth } = require('../middleware/adminAuth');\nconst crypto = require('crypto');\n\n// åŠ å¯†å¯†é’¥ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥ä»ç¯å¢ƒå˜é‡è·å–ï¼‰\nconst ENCRYPTION_KEY = process.env.CONFIG_ENCRYPTION_KEY || 'your-32-char-secret-key-here!!';\n\n// åŠ å¯†å‡½æ•°\nfunction encrypt(text) {\n  const cipher = crypto.createCipher('aes-256-cbc', ENCRYPTION_KEY);\n  let encrypted = cipher.update(text, 'utf8', 'hex');\n  encrypted += cipher.final('hex');\n  return encrypted;\n}\n\n// è§£å¯†å‡½æ•°\nfunction decrypt(encryptedText) {\n  const decipher = crypto.createDecipher('aes-256-cbc', ENCRYPTION_KEY);\n  let decrypted = decipher.update(encryptedText, 'hex', 'utf8');\n  decrypted += decipher.final('utf8');\n  return decrypted;\n}\n\n// è·å–æ‰€æœ‰é…ç½®\nrouter.get('/', adminAuth, async (req, res) => {\n  try {\n    const configs = await query(`\n      SELECT config_key, config_value, config_type, config_group, description, is_encrypted\n      FROM system_config\n      ORDER BY config_group, config_key\n    `);\n\n    // è§£å¯†æ•æ„Ÿé…ç½®\n    const processedConfigs = configs.map(config => {\n      if (config.is_encrypted && config.config_value) {\n        try {\n          config.config_value = decrypt(config.config_value);\n        } catch (error) {\n          console.error('è§£å¯†é…ç½®å¤±è´¥:', config.config_key, error);\n        }\n      }\n      return config;\n    });\n\n    // æŒ‰åˆ†ç»„ç»„ç»‡é…ç½®\n    const groupedConfigs = {};\n    processedConfigs.forEach(config => {\n      if (!groupedConfigs[config.config_group]) {\n        groupedConfigs[config.config_group] = [];\n      }\n      groupedConfigs[config.config_group].push(config);\n    });\n\n    res.json({\n      success: true,\n      data: groupedConfigs\n    });\n  } catch (error) {\n    console.error('è·å–é…ç½®å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'è·å–é…ç½®å¤±è´¥'\n    });\n  }\n});\n\n// è·å–å•ä¸ªé…ç½®\nrouter.get('/:key', async (req, res) => {\n  try {\n    const { key } = req.params;\n    const configs = await query(\n      'SELECT config_value, is_encrypted FROM system_config WHERE config_key = ?',\n      [key]\n    );\n\n    if (configs.length === 0) {\n      return res.status(404).json({\n        success: false,\n        message: 'é…ç½®ä¸å­˜åœ¨'\n      });\n    }\n\n    let value = configs[0].config_value;\n    if (configs[0].is_encrypted && value) {\n      try {\n        value = decrypt(value);\n      } catch (error) {\n        console.error('è§£å¯†é…ç½®å¤±è´¥:', key, error);\n      }\n    }\n\n    res.json({\n      success: true,\n      data: value\n    });\n  } catch (error) {\n    console.error('è·å–é…ç½®å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'è·å–é…ç½®å¤±è´¥'\n    });\n  }\n});\n\n// æ›´æ–°é…ç½®\nrouter.put('/', async (req, res) => {\n  try {\n    const { configs } = req.body;\n\n    if (!configs || !Array.isArray(configs)) {\n      return res.status(400).json({\n        success: false,\n        message: 'é…ç½®æ•°æ®æ ¼å¼é”™è¯¯'\n      });\n    }\n\n    // å¼€å§‹äº‹åŠ¡\n    const results = [];\n    for (const config of configs) {\n      const { config_key, config_value, is_encrypted } = config;\n\n      let valueToStore = config_value;\n\n      // å¦‚æœéœ€è¦åŠ å¯†\n      if (is_encrypted && config_value) {\n        valueToStore = encrypt(config_value);\n      }\n\n      const result = await query(`\n        UPDATE system_config\n        SET config_value = ?, updated_at = CURRENT_TIMESTAMP\n        WHERE config_key = ?\n      `, [valueToStore, config_key]);\n\n      results.push({\n        config_key,\n        updated: result.affectedRows > 0\n      });\n    }\n\n    res.json({\n      success: true,\n      message: 'é…ç½®æ›´æ–°æˆåŠŸ',\n      data: results\n    });\n  } catch (error) {\n    console.error('æ›´æ–°é…ç½®å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'æ›´æ–°é…ç½®å¤±è´¥'\n    });\n  }\n});\n\n// é‡ç½®é…ç½®åˆ°é»˜è®¤å€¼\nrouter.post('/reset', async (req, res) => {\n  try {\n    const { config_group } = req.body;\n\n    let whereClause = '';\n    let params = [];\n\n    if (config_group) {\n      whereClause = 'WHERE config_group = ?';\n      params = [config_group];\n    }\n\n    // è¿™é‡Œå¯ä»¥æ·»åŠ é‡ç½®åˆ°é»˜è®¤å€¼çš„é€»è¾‘\n    // æš‚æ—¶è¿”å›æˆåŠŸå“åº”\n    res.json({\n      success: true,\n      message: 'é…ç½®é‡ç½®æˆåŠŸ'\n    });\n  } catch (error) {\n    console.error('é‡ç½®é…ç½®å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'é‡ç½®é…ç½®å¤±è´¥'\n    });\n  }\n});\n\n// æµ‹è¯•é…ç½®è¿æ¥\nrouter.post('/test', async (req, res) => {\n  try {\n    const { config_group, configs, serverUrl, timeout = 10000 } = req.body;\n\n    if (config_group === 'database') {\n      // æµ‹è¯•æ•°æ®åº“è¿æ¥\n      const mysql = require('mysql2/promise');\n      const dbConfig = {};\n\n      configs.forEach(config => {\n        const key = config.config_key.replace('database.', '');\n        dbConfig[key] = config.config_value;\n      });\n\n      try {\n        const connection = await mysql.createConnection({\n          host: dbConfig.host,\n          port: dbConfig.port,\n          user: dbConfig.user,\n          password: dbConfig.password,\n          database: dbConfig.name\n        });\n\n        await connection.ping();\n        await connection.end();\n\n        res.json({\n          success: true,\n          message: 'æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ'\n        });\n      } catch (error) {\n        res.json({\n          success: false,\n          message: `æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`\n        });\n      }\n    } else if (config_group === 'comfyui' || serverUrl) {\n      // æµ‹è¯•ComfyUIè¿æ¥\n      const testUrl = serverUrl || configs?.find(c => c.config_key === 'comfyui.server_url')?.config_value;\n\n      if (!testUrl) {\n        return res.json({\n          success: false,\n          message: 'è¯·æä¾›ComfyUIæœåŠ¡å™¨åœ°å€'\n        });\n      }\n\n      console.log(`ğŸ” æµ‹è¯•ComfyUIè¿æ¥: ${testUrl}`);\n\n      // æ„å»ºå¥åº·æ£€æŸ¥URL\n      const healthCheckUrl = `${testUrl.replace(/\\/$/, '')}/system_stats`;\n\n      // ä½¿ç”¨fetchè¿›è¡Œè¿æ¥æµ‹è¯•\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), timeout);\n\n      try {\n        const response = await fetch(healthCheckUrl, {\n          method: 'GET',\n          headers: {\n            'Content-Type': 'application/json',\n            'User-Agent': 'Imagic-Admin/1.0'\n          },\n          signal: controller.signal\n        });\n\n        clearTimeout(timeoutId);\n\n        if (response.ok) {\n          const data = await response.json();\n          console.log('âœ… ComfyUIè¿æ¥æµ‹è¯•æˆåŠŸ');\n\n          res.json({\n            success: true,\n            message: 'ComfyUIæœåŠ¡å™¨è¿æ¥æ­£å¸¸',\n            data: {\n              status: 'connected',\n              responseTime: Date.now(),\n              serverInfo: data\n            }\n          });\n        } else {\n          console.log(`âŒ ComfyUIè¿æ¥æµ‹è¯•å¤±è´¥: HTTP ${response.status}`);\n\n          res.json({\n            success: false,\n            message: `æœåŠ¡å™¨å“åº”é”™è¯¯: HTTP ${response.status}`,\n            data: {\n              status: 'error',\n              statusCode: response.status\n            }\n          });\n        }\n      } catch (fetchError) {\n        clearTimeout(timeoutId);\n\n        if (fetchError.name === 'AbortError') {\n          console.log('âŒ ComfyUIè¿æ¥æµ‹è¯•è¶…æ—¶');\n          res.json({\n            success: false,\n            message: `è¿æ¥è¶…æ—¶ (${timeout}ms)`,\n            data: {\n              status: 'timeout'\n            }\n          });\n        } else {\n          console.log('âŒ ComfyUIè¿æ¥æµ‹è¯•å¤±è´¥:', fetchError.message);\n          res.json({\n            success: false,\n            message: `è¿æ¥å¤±è´¥: ${fetchError.message}`,\n            data: {\n              status: 'error',\n              error: fetchError.message\n            }\n          });\n        }\n      }\n    } else {\n      res.json({\n        success: true,\n        message: 'é…ç½®æµ‹è¯•æˆåŠŸ'\n      });\n    }\n  } catch (error) {\n    console.error('æµ‹è¯•é…ç½®å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'æµ‹è¯•é…ç½®å¤±è´¥'\n    });\n  }\n});\n\nmodule.exports = router;\n"
        }
    ]
}