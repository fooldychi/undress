{
    "sourceFile": "server/src/routes/admin.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 50,
            "patches": [
                {
                    "date": 1752319729592,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752319759982,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -537,9 +537,9 @@\n     }\n \n     await query(`\n       UPDATE level_cards\n-      SET status = ?, updated_at = NOW()\n+      SET status = ?\n       WHERE id = ?\n     `, [status, cardId]);\n \n     res.json({\n"
                },
                {
                    "date": 1752321842325,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -395,8 +395,28 @@\n   }\n });\n \n \n+// 获取等级卡类型列表（管理员用）\n+router.get('/card-types', adminAuth, async (req, res, next) => {\n+  try {\n+    const cardTypes = await query(`\n+      SELECT id, name, icon, points, price, description\n+      FROM level_card_types\n+      ORDER BY points ASC\n+    `);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        cardTypes\n+      }\n+    });\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n // 获取所有等级卡列表（管理员用）\n router.get('/cards', adminAuth, async (req, res, next) => {\n   try {\n     const page = parseInt(req.query.page) || 1;\n"
                },
                {
                    "date": 1752321870041,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -930,18 +930,32 @@\n \n // 生成等级卡（管理员用）\n router.post('/generate-cards', adminAuth, async (req, res, next) => {\n   try {\n-    const { cardType = '基础卡', count = 5 } = req.body;\n+    const { cardTypeId, count = 5 } = req.body;\n \n-    console.log(`🎫 开始生成${count}张${cardType}...`);\n+    if (!cardTypeId) {\n+      return res.status(400).json({\n+        success: false,\n+        message: '请选择等级卡类型'\n+      });\n+    }\n \n-    // 获取卡片类型信息 - 修复表名，遵循开发原则\n+    if (!count || count <= 0 || count > 100) {\n+      return res.status(400).json({\n+        success: false,\n+        message: '生成数量必须在1-100之间'\n+      });\n+    }\n+\n+    console.log(`🎫 开始生成${count}张等级卡，类型ID: ${cardTypeId}...`);\n+\n+    // 获取卡片类型信息\n     const cardTypeResult = await query(`\n-      SELECT id, name, points, price\n+      SELECT id, name, points, price, description\n       FROM level_card_types\n-      WHERE name = ?\n-    `, [cardType]);\n+      WHERE id = ?\n+    `, [cardTypeId]);\n \n     if (cardTypeResult.length === 0) {\n       return res.status(400).json({\n         success: false,\n@@ -953,9 +967,9 @@\n     const generatedCards = [];\n \n     // 批量生成等级卡\n     for (let i = 1; i <= count; i++) {\n-      const cardNumber = generateCardNumber(cardType, i);\n+      const cardNumber = generateCardNumber(typeInfo.name, i);\n       const cardPassword = generateCardPassword();\n \n       await query(`\n         INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n@@ -965,17 +979,18 @@\n       generatedCards.push({\n         cardNumber,\n         cardPassword,\n         typeName: typeInfo.name,\n-        points: typeInfo.points\n+        points: typeInfo.points,\n+        price: typeInfo.price\n       });\n     }\n \n-    console.log(`✅ 成功生成${count}张${cardType}`);\n+    console.log(`✅ 成功生成${count}张${typeInfo.name}`);\n \n     res.json({\n       success: true,\n-      message: `成功生成${count}张${cardType}`,\n+      message: `成功生成${count}张${typeInfo.name}`,\n       data: {\n         cards: generatedCards,\n         cardType: typeInfo.name,\n         totalGenerated: count\n"
                },
                {
                    "date": 1752322059169,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -451,9 +451,9 @@\n     // 获取等级卡总数\n     const countQuery = `\n       SELECT COUNT(*) as total\n       FROM level_cards lc\n-      LEFT JOIN card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n       LEFT JOIN users u ON lc.bound_user_id = u.id\n       ${whereClause}\n     `;\n     const countResult = await query(countQuery, queryParams);\n@@ -465,9 +465,9 @@\n              lc.bound_at, lc.created_at,\n              ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n              u.username as bound_username, u.id as bound_user_id\n       FROM level_cards lc\n-      LEFT JOIN card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n       LEFT JOIN users u ON lc.bound_user_id = u.id\n       ${whereClause}\n       ORDER BY lc.created_at DESC\n       LIMIT ? OFFSET ?\n"
                },
                {
                    "date": 1752322076238,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -502,9 +502,9 @@\n              lc.bound_at, lc.created_at,\n              ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n              u.username as bound_username, u.id as bound_user_id, u.email as bound_user_email\n       FROM level_cards lc\n-      LEFT JOIN card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n       LEFT JOIN users u ON lc.bound_user_id = u.id\n       WHERE lc.id = ?\n     `, [cardId]);\n \n"
                },
                {
                    "date": 1752322101126,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1073,9 +1073,9 @@\n         COUNT(CASE WHEN bound_user_id IS NOT NULL THEN 1 END) as bound_cards,\n         SUM(CASE WHEN bound_user_id IS NULL THEN remaining_points ELSE 0 END) as available_points,\n         SUM(CASE WHEN bound_user_id IS NOT NULL THEN remaining_points ELSE 0 END) as bound_points\n       FROM level_cards lc\n-      JOIN card_types ct ON lc.type_id = ct.id\n+      JOIN level_card_types ct ON lc.type_id = ct.id\n       WHERE ct.name = '体验卡'\n     `);\n \n     // 获取可用体验卡列表\n"
                },
                {
                    "date": 1752322614000,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -398,21 +398,68 @@\n \n // 获取等级卡类型列表（管理员用）\n router.get('/card-types', adminAuth, async (req, res, next) => {\n   try {\n-    const cardTypes = await query(`\n-      SELECT id, name, icon, points, price, description\n-      FROM level_card_types\n-      ORDER BY points ASC\n-    `);\n+    console.log('🔍 获取等级卡类型列表...');\n \n-    res.json({\n-      success: true,\n-      data: {\n-        cardTypes\n-      }\n-    });\n+    // 首先检查表是否存在\n+    try {\n+      const cardTypes = await query(`\n+        SELECT id, name, icon, points, price, description\n+        FROM level_card_types\n+        ORDER BY points ASC\n+      `);\n+\n+      console.log('✅ 成功获取等级卡类型:', cardTypes.length, '个');\n+      res.json({\n+        success: true,\n+        data: {\n+          cardTypes\n+        }\n+      });\n+    } catch (tableError) {\n+      console.log('⚠️ 等级卡类型表不存在，尝试创建...');\n+\n+      // 创建表和初始数据\n+      await query(`\n+        CREATE TABLE IF NOT EXISTS level_card_types (\n+          id INT AUTO_INCREMENT PRIMARY KEY,\n+          name VARCHAR(50) NOT NULL COMMENT '等级卡名称',\n+          icon VARCHAR(10) NOT NULL COMMENT '等级卡图标',\n+          price DECIMAL(10,2) NOT NULL COMMENT '价格',\n+          points INT NOT NULL COMMENT '积分数量',\n+          description TEXT COMMENT '描述',\n+          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+          updated_at DATETIME NULL\n+        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+      `);\n+\n+      // 插入初始数据\n+      await query(`\n+        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n+        ('体验卡', '🎁', 0.00, 20, '免费体验卡，每张20积分'),\n+        ('基础卡', '🥉', 9.90, 300, '适合轻度使用的用户'),\n+        ('高级卡', '🥈', 30.00, 1000, '适合中度使用的用户'),\n+        ('至尊卡', '🥇', 50.00, 2000, '适合重度使用的用户')\n+      `);\n+\n+      // 重新获取数据\n+      const cardTypes = await query(`\n+        SELECT id, name, icon, points, price, description\n+        FROM level_card_types\n+        ORDER BY points ASC\n+      `);\n+\n+      console.log('✅ 表创建成功，获取等级卡类型:', cardTypes.length, '个');\n+      res.json({\n+        success: true,\n+        data: {\n+          cardTypes\n+        }\n+      });\n+    }\n   } catch (error) {\n+    console.error('❌ 获取等级卡类型失败:', error);\n     next(error);\n   }\n });\n \n"
                },
                {
                    "date": 1752322637823,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -995,8 +995,29 @@\n     }\n \n     console.log(`🎫 开始生成${count}张等级卡，类型ID: ${cardTypeId}...`);\n \n+    // 确保level_cards表存在\n+    await query(`\n+      CREATE TABLE IF NOT EXISTS level_cards (\n+        id INT AUTO_INCREMENT PRIMARY KEY,\n+        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT '卡号',\n+        card_password VARCHAR(20) NOT NULL COMMENT '卡密',\n+        type_id INT NOT NULL COMMENT '等级卡类型ID',\n+        total_points INT NOT NULL COMMENT '总积分',\n+        remaining_points INT NOT NULL COMMENT '剩余积分',\n+        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT '状态',\n+        bound_user_id INT NULL COMMENT '绑定的用户ID',\n+        bound_at DATETIME NULL COMMENT '绑定时间',\n+        expires_at DATETIME NULL COMMENT '过期时间',\n+        created_at DATETIME NOT NULL,\n+        updated_at DATETIME NULL,\n+        INDEX idx_card_number (card_number),\n+        INDEX idx_bound_user (bound_user_id),\n+        INDEX idx_status (status)\n+      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+    `);\n+\n     // 获取卡片类型信息\n     const cardTypeResult = await query(`\n       SELECT id, name, points, price, description\n       FROM level_card_types\n"
                },
                {
                    "date": 1752346972847,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1079,9 +1079,9 @@\n \n     // 获取体验卡类型信息 - 修复表名，遵循开发原则\n     const cardTypeResult = await query(`\n       SELECT id, name, points, price\n-      FROM level_card_types\n+      FROM card_types\n       WHERE name = '体验卡'\n     `);\n \n     if (cardTypeResult.length === 0) {\n"
                },
                {
                    "date": 1752346991888,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,1363 @@\n+const express = require('express');\n+const router = express.Router();\n+const { query } = require('../config/database');\n+const { createExperienceCardSystem, getAvailableExperienceCards } = require('../scripts/create-experience-cards');\n+const { adminAuth } = require('../middleware/adminAuth');\n+\n+// 生成卡号的辅助函数\n+function generateCardNumber(cardType, index) {\n+  const typePrefix = {\n+    '基础卡': 'BC',\n+    '高级卡': 'AC',\n+    '至尊卡': 'PC',\n+    '体验卡': 'EXP'\n+  };\n+\n+  const prefix = typePrefix[cardType] || 'CARD';\n+  const timestamp = Date.now().toString().slice(-8); // 取时间戳后8位\n+  const indexStr = String(index).padStart(2, '0'); // 序号补零到2位\n+\n+  return `${prefix}${timestamp}${indexStr}`;\n+}\n+\n+// 生成卡密的辅助函数\n+function generateCardPassword() {\n+  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n+  let password = '';\n+  for (let i = 0; i < 8; i++) {\n+    password += chars.charAt(Math.floor(Math.random() * chars.length));\n+  }\n+  return password;\n+}\n+\n+\n+\n+// 获取系统统计信息\n+router.get('/stats', adminAuth, async (req, res, next) => {\n+  try {\n+    // 用户统计\n+    const userStats = await query(`\n+      SELECT\n+        COUNT(*) as total_users,\n+        COUNT(CASE WHEN status = 'active' THEN 1 END) as active_users,\n+        COUNT(CASE WHEN status = 'inactive' THEN 1 END) as inactive_users,\n+        COUNT(CASE WHEN status = 'banned' THEN 1 END) as banned_users,\n+        COUNT(CASE WHEN DATE(created_at) = CURDATE() THEN 1 END) as today_new_users\n+      FROM users\n+    `);\n+\n+    // 等级卡统计\n+    const cardStats = await query(`\n+      SELECT\n+        COUNT(*) as total_cards,\n+        COUNT(CASE WHEN bound_user_id IS NOT NULL THEN 1 END) as bound_cards,\n+        COUNT(CASE WHEN bound_user_id IS NULL THEN 1 END) as available_cards,\n+        SUM(remaining_points) as total_remaining_points,\n+        COUNT(CASE WHEN ct.name = '体验卡' THEN 1 END) as experience_cards,\n+        COUNT(CASE WHEN ct.name != '体验卡' THEN 1 END) as level_cards\n+      FROM level_cards lc\n+      LEFT JOIN card_types ct ON lc.type_id = ct.id\n+    `);\n+\n+    // 积分消费统计\n+    const pointsStats = await query(`\n+      SELECT\n+        COUNT(*) as total_transactions,\n+        SUM(points_amount) as total_points_consumed,\n+        COUNT(CASE WHEN DATE(created_at) = CURDATE() THEN 1 END) as today_transactions,\n+        SUM(CASE WHEN DATE(created_at) = CURDATE() THEN points_amount ELSE 0 END) as today_points_consumed\n+      FROM point_logs\n+      WHERE action_type = 'consume'\n+    `);\n+\n+    // 最近7天的用户注册趋势\n+    const userTrend = await query(`\n+      SELECT\n+        DATE(created_at) as date,\n+        COUNT(*) as count\n+      FROM users\n+      WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)\n+      GROUP BY DATE(created_at)\n+      ORDER BY date DESC\n+    `);\n+\n+    // 最近7天的积分消费趋势\n+    const pointsTrend = await query(`\n+      SELECT\n+        DATE(created_at) as date,\n+        COUNT(*) as transactions,\n+        SUM(points_amount) as points_consumed\n+      FROM point_logs\n+      WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)\n+        AND action_type = 'consume'\n+      GROUP BY DATE(created_at)\n+      ORDER BY date DESC\n+    `);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        users: userStats[0],\n+        cards: cardStats[0],\n+        points: pointsStats[0],\n+        trends: {\n+          users: userTrend,\n+          points: pointsTrend\n+        }\n+      }\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// 获取用户列表（管理员用）\n+router.get('/users', adminAuth, async (req, res, next) => {\n+  try {\n+    const page = parseInt(req.query.page) || 1;\n+    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n+    const offset = (page - 1) * limit;\n+    const status = req.query.status;\n+    const search = req.query.search;\n+\n+    let whereClause = '';\n+    let queryParams = [];\n+\n+    // 构建查询条件\n+    const conditions = [];\n+    if (status) {\n+      conditions.push('status = ?');\n+      queryParams.push(status);\n+    }\n+    if (search) {\n+      conditions.push('(username LIKE ? OR email LIKE ?)');\n+      queryParams.push(`%${search}%`, `%${search}%`);\n+    }\n+\n+    if (conditions.length > 0) {\n+      whereClause = 'WHERE ' + conditions.join(' AND ');\n+    }\n+\n+    // 获取用户总数\n+    const countQuery = `SELECT COUNT(*) as total FROM users ${whereClause}`;\n+    const countResult = await query(countQuery, queryParams);\n+    const total = countResult[0].total;\n+\n+    // 获取用户列表\n+    const usersQuery = `\n+      SELECT u.id, u.username, u.email, u.status, u.created_at, u.last_login,\n+             COUNT(lc.id) as bound_cards,\n+             COALESCE(SUM(lc.remaining_points), 0) as total_points\n+      FROM users u\n+      LEFT JOIN level_cards lc ON u.id = lc.bound_user_id\n+      ${whereClause}\n+      GROUP BY u.id\n+      ORDER BY u.created_at DESC\n+      LIMIT ? OFFSET ?\n+    `;\n+\n+    const users = await query(usersQuery, [...queryParams, limit, offset]);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        items: users,\n+        total,\n+        page,\n+        pageSize: limit,\n+        totalPages: Math.ceil(total / limit)\n+      }\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// 获取用户详情（管理员用）\n+router.get('/users/:id', adminAuth, async (req, res, next) => {\n+  try {\n+    const userId = req.params.id;\n+\n+    // 获取用户基本信息\n+    const userResult = await query(`\n+      SELECT id, username, email, status, created_at, updated_at, last_login\n+      FROM users\n+      WHERE id = ?\n+    `, [userId]);\n+\n+    if (userResult.length === 0) {\n+      return res.status(404).json({\n+        success: false,\n+        message: '用户不存在'\n+      });\n+    }\n+\n+    const user = userResult[0];\n+\n+    // 获取用户绑定的等级卡\n+    const cards = await query(`\n+      SELECT lc.id, lc.card_number, lc.remaining_points, lc.bound_at,\n+             ct.name as type_name, ct.icon, ct.points as total_points\n+      FROM level_cards lc\n+      JOIN card_types ct ON lc.type_id = ct.id\n+      WHERE lc.bound_user_id = ?\n+      ORDER BY lc.bound_at DESC\n+    `, [userId]);\n+\n+    // 获取用户积分消费记录\n+    const pointsHistory = await query(`\n+      SELECT id, action_type, points_amount, description, url, created_at\n+      FROM point_logs\n+      WHERE user_id = ?\n+      ORDER BY created_at DESC\n+      LIMIT 20\n+    `, [userId]);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        user,\n+        cards,\n+        pointsHistory,\n+        summary: {\n+          totalCards: cards.length,\n+          totalPoints: cards.reduce((sum, card) => sum + card.remaining_points, 0),\n+          totalConsumed: pointsHistory\n+            .filter(log => log.action_type === 'consume')\n+            .reduce((sum, log) => sum + log.points_amount, 0)\n+        }\n+      }\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// 更新用户状态（管理员用）\n+router.put('/users/:id/status', adminAuth, async (req, res, next) => {\n+  try {\n+    const userId = req.params.id;\n+    const { status } = req.body;\n+\n+    if (!['active', 'inactive', 'banned'].includes(status)) {\n+      return res.status(400).json({\n+        success: false,\n+        message: '无效的用户状态'\n+      });\n+    }\n+\n+    await query(`\n+      UPDATE users\n+      SET status = ?, updated_at = NOW()\n+      WHERE id = ?\n+    `, [status, userId]);\n+\n+    res.json({\n+      success: true,\n+      message: '用户状态更新成功'\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// 封禁用户（管理员用）\n+router.post('/users/:id/ban', adminAuth, async (req, res, next) => {\n+  try {\n+    const userId = req.params.id;\n+\n+    await query(`\n+      UPDATE users\n+      SET status = 'banned', updated_at = NOW()\n+      WHERE id = ?\n+    `, [userId]);\n+\n+    res.json({\n+      success: true,\n+      message: '用户已封禁'\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// 解封用户（管理员用）\n+router.post('/users/:id/unban', adminAuth, async (req, res, next) => {\n+  try {\n+    const userId = req.params.id;\n+\n+    await query(`\n+      UPDATE users\n+      SET status = 'active', updated_at = NOW()\n+      WHERE id = ?\n+    `, [userId]);\n+\n+    res.json({\n+      success: true,\n+      message: '用户已解封'\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// 初始化等级卡数据库表\n+router.post('/init-level-cards', async (req, res, next) => {\n+  try {\n+    console.log('🗃️ 开始创建等级卡相关数据库表...');\n+\n+    // 1. 创建等级卡类型表\n+    console.log('📝 创建等级卡类型表...');\n+    await query(`\n+      CREATE TABLE IF NOT EXISTS level_card_types (\n+        id INT AUTO_INCREMENT PRIMARY KEY,\n+        name VARCHAR(50) NOT NULL COMMENT '等级卡名称',\n+        icon VARCHAR(10) NOT NULL COMMENT '等级卡图标',\n+        price DECIMAL(10,2) NOT NULL COMMENT '价格',\n+        points INT NOT NULL COMMENT '积分数量',\n+        description TEXT COMMENT '描述',\n+        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+        updated_at DATETIME NULL\n+      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+    `);\n+    console.log('✅ 等级卡类型表创建成功');\n+\n+    // 2. 创建等级卡表\n+    console.log('📝 创建等级卡表...');\n+    await query(`\n+      CREATE TABLE IF NOT EXISTS level_cards (\n+        id INT AUTO_INCREMENT PRIMARY KEY,\n+        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT '卡号',\n+        card_password VARCHAR(20) NOT NULL COMMENT '卡密',\n+        type_id INT NOT NULL COMMENT '等级卡类型ID',\n+        total_points INT NOT NULL COMMENT '总积分',\n+        remaining_points INT NOT NULL COMMENT '剩余积分',\n+        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT '状态',\n+        bound_user_id INT NULL COMMENT '绑定的用户ID',\n+        bound_at DATETIME NULL COMMENT '绑定时间',\n+        expires_at DATETIME NULL COMMENT '过期时间',\n+        created_at DATETIME NOT NULL,\n+        updated_at DATETIME NULL,\n+        FOREIGN KEY (type_id) REFERENCES level_card_types(id),\n+        FOREIGN KEY (bound_user_id) REFERENCES users(id),\n+        INDEX idx_card_number (card_number),\n+        INDEX idx_bound_user (bound_user_id),\n+        INDEX idx_status (status)\n+      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+    `);\n+    console.log('✅ 等级卡表创建成功');\n+\n+    // 3. 创建等级卡使用记录表\n+    console.log('📝 创建等级卡交易记录表...');\n+    await query(`\n+      CREATE TABLE IF NOT EXISTS level_card_transactions (\n+        id INT AUTO_INCREMENT PRIMARY KEY,\n+        card_id INT NOT NULL COMMENT '等级卡ID',\n+        user_id INT NOT NULL COMMENT '用户ID',\n+        type ENUM('bind', 'consume') NOT NULL COMMENT '交易类型',\n+        points_amount INT NOT NULL COMMENT '积分数量',\n+        remaining_points INT NOT NULL COMMENT '操作后剩余积分',\n+        description VARCHAR(255) COMMENT '描述',\n+        created_at DATETIME NOT NULL,\n+        FOREIGN KEY (card_id) REFERENCES level_cards(id),\n+        FOREIGN KEY (user_id) REFERENCES users(id),\n+        INDEX idx_card_user (card_id, user_id),\n+        INDEX idx_created_at (created_at)\n+      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+    `);\n+    console.log('✅ 等级卡交易记录表创建成功');\n+\n+    // 4. 插入等级卡类型数据（包含体验卡）\n+    const existingTypes = await query('SELECT COUNT(*) as count FROM level_card_types');\n+    if (existingTypes[0].count === 0) {\n+      await query(`\n+        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n+        ('体验卡', '🎁', 0.00, 20, '免费体验卡，每张20积分'),\n+        ('基础卡', '🥉', 9.90, 300, '适合轻度使用的用户'),\n+        ('高级卡', '🥈', 30.00, 1000, '适合中度使用的用户'),\n+        ('至尊卡', '🥇', 50.00, 2000, '适合重度使用的用户')\n+      `);\n+    }\n+\n+    res.json({\n+      success: true,\n+      message: '等级卡数据库表创建成功'\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+\n+// 获取等级卡类型列表（管理员用）\n+router.get('/card-types', adminAuth, async (req, res, next) => {\n+  try {\n+    console.log('🔍 获取等级卡类型列表...');\n+\n+    // 首先检查表是否存在\n+    try {\n+      const cardTypes = await query(`\n+        SELECT id, name, icon, points, price, description\n+        FROM level_card_types\n+        ORDER BY points ASC\n+      `);\n+\n+      console.log('✅ 成功获取等级卡类型:', cardTypes.length, '个');\n+      res.json({\n+        success: true,\n+        data: {\n+          cardTypes\n+        }\n+      });\n+    } catch (tableError) {\n+      console.log('⚠️ 等级卡类型表不存在，尝试创建...');\n+\n+      // 创建表和初始数据\n+      await query(`\n+        CREATE TABLE IF NOT EXISTS level_card_types (\n+          id INT AUTO_INCREMENT PRIMARY KEY,\n+          name VARCHAR(50) NOT NULL COMMENT '等级卡名称',\n+          icon VARCHAR(10) NOT NULL COMMENT '等级卡图标',\n+          price DECIMAL(10,2) NOT NULL COMMENT '价格',\n+          points INT NOT NULL COMMENT '积分数量',\n+          description TEXT COMMENT '描述',\n+          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+          updated_at DATETIME NULL\n+        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+      `);\n+\n+      // 插入初始数据\n+      await query(`\n+        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n+        ('体验卡', '🎁', 0.00, 20, '免费体验卡，每张20积分'),\n+        ('基础卡', '🥉', 9.90, 300, '适合轻度使用的用户'),\n+        ('高级卡', '🥈', 30.00, 1000, '适合中度使用的用户'),\n+        ('至尊卡', '🥇', 50.00, 2000, '适合重度使用的用户')\n+      `);\n+\n+      // 重新获取数据\n+      const cardTypes = await query(`\n+        SELECT id, name, icon, points, price, description\n+        FROM level_card_types\n+        ORDER BY points ASC\n+      `);\n+\n+      console.log('✅ 表创建成功，获取等级卡类型:', cardTypes.length, '个');\n+      res.json({\n+        success: true,\n+        data: {\n+          cardTypes\n+        }\n+      });\n+    }\n+  } catch (error) {\n+    console.error('❌ 获取等级卡类型失败:', error);\n+    next(error);\n+  }\n+});\n+\n+// 获取所有等级卡列表（管理员用）\n+router.get('/cards', adminAuth, async (req, res, next) => {\n+  try {\n+    const page = parseInt(req.query.page) || 1;\n+    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n+    const offset = (page - 1) * limit;\n+    const status = req.query.status;\n+    const cardType = req.query.type;\n+    const search = req.query.search;\n+\n+    let whereClause = '';\n+    let queryParams = [];\n+\n+    // 构建查询条件\n+    const conditions = [];\n+    if (status) {\n+      conditions.push('lc.status = ?');\n+      queryParams.push(status);\n+    }\n+    if (cardType) {\n+      conditions.push('ct.name = ?');\n+      queryParams.push(cardType);\n+    }\n+    if (search) {\n+      conditions.push('(lc.card_number LIKE ? OR u.username LIKE ?)');\n+      queryParams.push(`%${search}%`, `%${search}%`);\n+    }\n+\n+    if (conditions.length > 0) {\n+      whereClause = 'WHERE ' + conditions.join(' AND ');\n+    }\n+\n+    // 获取等级卡总数\n+    const countQuery = `\n+      SELECT COUNT(*) as total\n+      FROM level_cards lc\n+      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN users u ON lc.bound_user_id = u.id\n+      ${whereClause}\n+    `;\n+    const countResult = await query(countQuery, queryParams);\n+    const total = countResult[0].total;\n+\n+    // 获取等级卡列表\n+    const cardsQuery = `\n+      SELECT lc.id, lc.card_number, lc.card_password, lc.remaining_points,\n+             lc.bound_at, lc.created_at,\n+             ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n+             u.username as bound_username, u.id as bound_user_id\n+      FROM level_cards lc\n+      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN users u ON lc.bound_user_id = u.id\n+      ${whereClause}\n+      ORDER BY lc.created_at DESC\n+      LIMIT ? OFFSET ?\n+    `;\n+\n+    const cards = await query(cardsQuery, [...queryParams, limit, offset]);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        items: cards,\n+        total,\n+        page,\n+        pageSize: limit,\n+        totalPages: Math.ceil(total / limit)\n+      }\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// 获取等级卡详情（管理员用）\n+router.get('/cards/:id', adminAuth, async (req, res, next) => {\n+  try {\n+    const cardId = req.params.id;\n+\n+    // 获取等级卡基本信息\n+    const cardResult = await query(`\n+      SELECT lc.id, lc.card_number, lc.card_password, lc.remaining_points,\n+             lc.bound_at, lc.created_at,\n+             ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n+             u.username as bound_username, u.id as bound_user_id, u.email as bound_user_email\n+      FROM level_cards lc\n+      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN users u ON lc.bound_user_id = u.id\n+      WHERE lc.id = ?\n+    `, [cardId]);\n+\n+    if (cardResult.length === 0) {\n+      return res.status(404).json({\n+        success: false,\n+        message: '等级卡不存在'\n+      });\n+    }\n+\n+    const card = cardResult[0];\n+\n+    // 获取该卡的使用记录\n+    const usageHistory = await query(`\n+      SELECT id, action_type, points_amount, description, url, created_at\n+      FROM point_logs\n+      WHERE user_id = ? AND description LIKE '%${card.card_number}%'\n+      ORDER BY created_at DESC\n+      LIMIT 20\n+    `, [card.bound_user_id]);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        card,\n+        usageHistory,\n+        summary: {\n+          totalUsed: card.total_points - card.remaining_points,\n+          usageCount: usageHistory.filter(log => log.action_type === 'consume').length\n+        }\n+      }\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// 禁用/启用等级卡（管理员用）\n+router.put('/cards/:id/status', adminAuth, async (req, res, next) => {\n+  try {\n+    const cardId = req.params.id;\n+    const { status } = req.body;\n+\n+    if (!['active', 'disabled', 'expired'].includes(status)) {\n+      return res.status(400).json({\n+        success: false,\n+        message: '无效的等级卡状态'\n+      });\n+    }\n+\n+    await query(`\n+      UPDATE level_cards\n+      SET status = ?\n+      WHERE id = ?\n+    `, [status, cardId]);\n+\n+    res.json({\n+      success: true,\n+      message: '等级卡状态更新成功'\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// 解绑等级卡（管理员用）\n+router.put('/cards/:id/unbind', adminAuth, async (req, res, next) => {\n+  try {\n+    const cardId = req.params.id;\n+\n+    await query(`\n+      UPDATE level_cards\n+      SET bound_user_id = NULL, bound_at = NULL\n+      WHERE id = ?\n+    `, [cardId]);\n+\n+    res.json({\n+      success: true,\n+      message: '等级卡解绑成功'\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// 获取积分记录列表（管理员用）- 兼容新前端路径\n+router.get('/points-logs', adminAuth, async (req, res, next) => {\n+  try {\n+    const page = parseInt(req.query.page) || 1;\n+    const pageSize = parseInt(req.query.pageSize) || 20;\n+    const offset = (page - 1) * pageSize;\n+    const actionType = req.query.type;\n+    const search = req.query.search;\n+\n+    let whereClause = '';\n+    let queryParams = [];\n+\n+    // 构建查询条件\n+    const conditions = [];\n+    if (actionType) {\n+      conditions.push('pl.action_type = ?');\n+      queryParams.push(actionType);\n+    }\n+    if (search) {\n+      conditions.push('u.username LIKE ?');\n+      queryParams.push(`%${search}%`);\n+    }\n+\n+    if (conditions.length > 0) {\n+      whereClause = 'WHERE ' + conditions.join(' AND ');\n+    }\n+\n+    // 获取积分记录总数\n+    const countQuery = `\n+      SELECT COUNT(*) as total\n+      FROM point_logs pl\n+      LEFT JOIN users u ON pl.user_id = u.id\n+      ${whereClause}\n+    `;\n+    const countResult = await query(countQuery, queryParams);\n+    const total = countResult[0].total;\n+\n+    // 获取积分记录列表\n+    const pointsQuery = `\n+      SELECT pl.id, pl.action_type, pl.points_amount, pl.description, pl.url, pl.created_at,\n+             u.username, u.id as user_id\n+      FROM point_logs pl\n+      LEFT JOIN users u ON pl.user_id = u.id\n+      ${whereClause}\n+      ORDER BY pl.created_at DESC\n+      LIMIT ? OFFSET ?\n+    `;\n+\n+    const pointsLogs = await query(pointsQuery, [...queryParams, pageSize, offset]);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        items: pointsLogs,\n+        total,\n+        page,\n+        pageSize,\n+        totalPages: Math.ceil(total / pageSize)\n+      }\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// 获取积分记录列表（管理员用）- 保持原有接口兼容性\n+router.get('/points', adminAuth, async (req, res, next) => {\n+  try {\n+    const page = parseInt(req.query.page) || 1;\n+    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n+    const offset = (page - 1) * limit;\n+    const actionType = req.query.type;\n+    const search = req.query.search;\n+\n+    let whereClause = '';\n+    let queryParams = [];\n+\n+    // 构建查询条件\n+    const conditions = [];\n+    if (actionType) {\n+      conditions.push('pl.action_type = ?');\n+      queryParams.push(actionType);\n+    }\n+    if (search) {\n+      conditions.push('u.username LIKE ?');\n+      queryParams.push(`%${search}%`);\n+    }\n+\n+    if (conditions.length > 0) {\n+      whereClause = 'WHERE ' + conditions.join(' AND ');\n+    }\n+\n+    // 获取积分记录总数\n+    const countQuery = `\n+      SELECT COUNT(*) as total\n+      FROM point_logs pl\n+      LEFT JOIN users u ON pl.user_id = u.id\n+      ${whereClause}\n+    `;\n+    const countResult = await query(countQuery, queryParams);\n+    const total = countResult[0].total;\n+\n+    // 获取积分记录列表\n+    const pointsQuery = `\n+      SELECT pl.id, pl.action_type, pl.points_amount, pl.description, pl.url, pl.created_at,\n+             u.username, u.id as user_id\n+      FROM point_logs pl\n+      LEFT JOIN users u ON pl.user_id = u.id\n+      ${whereClause}\n+      ORDER BY pl.created_at DESC\n+      LIMIT ? OFFSET ?\n+    `;\n+\n+    const pointsLogs = await query(pointsQuery, [...queryParams, limit, offset]);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        items: pointsLogs,\n+        total,\n+        page,\n+        pageSize: limit,\n+        totalPages: Math.ceil(total / limit)\n+      }\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// 获取系统配置信息（管理员用）\n+router.get('/config', adminAuth, async (req, res, next) => {\n+  try {\n+    console.log('📥 从数据库加载系统配置...');\n+\n+    // 从数据库获取所有配置\n+    const configs = await query(`\n+      SELECT config_key, config_value, config_type, config_group, description, is_encrypted\n+      FROM system_config\n+      ORDER BY config_group, config_key\n+    `);\n+\n+    console.log(`📊 从数据库加载了${configs.length}项配置`);\n+\n+    // 按分组组织配置\n+    const groupedConfigs = {};\n+    configs.forEach(config => {\n+      const group = config.config_group || 'general';\n+\n+      if (!groupedConfigs[group]) {\n+        groupedConfigs[group] = [];\n+      }\n+\n+      // 处理敏感配置显示\n+      let displayValue = config.config_value;\n+      if (config.is_encrypted && config.config_value) {\n+        // 对于敏感配置，显示掩码\n+        if (config.config_key.includes('password') || config.config_key.includes('secret')) {\n+          displayValue = '***';\n+        }\n+      }\n+\n+      groupedConfigs[group].push({\n+        config_key: config.config_key,\n+        config_value: displayValue,\n+        config_type: config.config_type || 'string',\n+        description: config.description || '',\n+        is_encrypted: config.is_encrypted || 0\n+      });\n+    });\n+\n+    // 确保所有必要的分组都存在\n+    const requiredGroups = ['server', 'database', 'jwt', 'comfyui', 'ai', 'frontend', 'cors', 'upload', 'log'];\n+    requiredGroups.forEach(group => {\n+      if (!groupedConfigs[group]) {\n+        groupedConfigs[group] = [];\n+      }\n+    });\n+\n+    console.log('📋 配置分组统计:');\n+    Object.keys(groupedConfigs).forEach(group => {\n+      console.log(`   ${group}: ${groupedConfigs[group].length} 项配置`);\n+    });\n+\n+    res.json({\n+      success: true,\n+      data: groupedConfigs\n+    });\n+\n+  } catch (error) {\n+    console.error('❌ 加载配置失败:', error);\n+    res.status(500).json({\n+      success: false,\n+      message: '加载配置失败: ' + error.message\n+    });\n+  }\n+});\n+\n+// 保存系统配置（管理员用）\n+router.post('/config', adminAuth, async (req, res, next) => {\n+  try {\n+    const { configs } = req.body;\n+\n+    if (!configs || !Array.isArray(configs)) {\n+      return res.status(400).json({\n+        success: false,\n+        message: '配置数据格式错误'\n+      });\n+    }\n+\n+    console.log('💾 保存系统配置到数据库，共', configs.length, '项');\n+\n+    // 真正保存配置到数据库\n+    const results = [];\n+    let successCount = 0;\n+    let errorCount = 0;\n+\n+    for (const config of configs) {\n+      const { config_key, config_value } = config;\n+\n+      try {\n+        // 更新数据库中的配置\n+        const result = await query(`\n+          UPDATE system_config\n+          SET config_value = ?, updated_at = NOW()\n+          WHERE config_key = ?\n+        `, [config_value, config_key]);\n+\n+        if (result.affectedRows > 0) {\n+          console.log(`  ✅ 保存成功: ${config_key} = ${config_value}`);\n+          results.push({\n+            config_key,\n+            updated: true,\n+            message: '更新成功'\n+          });\n+          successCount++;\n+        } else {\n+          // 如果没有找到配置项，尝试插入新的\n+          try {\n+            await query(`\n+              INSERT INTO system_config (config_key, config_value, config_type, config_group, description)\n+              VALUES (?, ?, 'string', 'custom', '用户自定义配置')\n+            `, [config_key, config_value]);\n+\n+            console.log(`  ✅ 新增成功: ${config_key} = ${config_value}`);\n+            results.push({\n+              config_key,\n+              updated: true,\n+              message: '新增成功'\n+            });\n+            successCount++;\n+          } catch (insertError) {\n+            console.log(`  ❌ 新增失败: ${config_key} - ${insertError.message}`);\n+            results.push({\n+              config_key,\n+              updated: false,\n+              message: '新增失败: ' + insertError.message\n+            });\n+            errorCount++;\n+          }\n+        }\n+      } catch (updateError) {\n+        console.log(`  ❌ 更新失败: ${config_key} - ${updateError.message}`);\n+        results.push({\n+          config_key,\n+          updated: false,\n+          message: '更新失败: ' + updateError.message\n+        });\n+        errorCount++;\n+      }\n+    }\n+\n+    const message = `配置保存完成: ${successCount}项成功, ${errorCount}项失败`;\n+    console.log('📊', message);\n+\n+    res.json({\n+      success: errorCount === 0,\n+      message: message,\n+      data: {\n+        results,\n+        summary: {\n+          total: configs.length,\n+          success: successCount,\n+          error: errorCount\n+        }\n+      }\n+    });\n+\n+  } catch (error) {\n+    console.error('❌ 保存配置失败:', error);\n+    res.status(500).json({\n+      success: false,\n+      message: '保存配置失败: ' + error.message\n+    });\n+  }\n+});\n+\n+// 批量操作用户状态（管理员用）\n+router.put('/users/batch-status', adminAuth, async (req, res, next) => {\n+  try {\n+    const { userIds, status } = req.body;\n+\n+    if (!Array.isArray(userIds) || userIds.length === 0) {\n+      return res.status(400).json({\n+        success: false,\n+        message: '请提供有效的用户ID列表'\n+      });\n+    }\n+\n+    if (!['active', 'inactive', 'banned'].includes(status)) {\n+      return res.status(400).json({\n+        success: false,\n+        message: '无效的用户状态'\n+      });\n+    }\n+\n+    const placeholders = userIds.map(() => '?').join(',');\n+    await query(`\n+      UPDATE users\n+      SET status = ?, updated_at = NOW()\n+      WHERE id IN (${placeholders})\n+    `, [status, ...userIds]);\n+\n+    res.json({\n+      success: true,\n+      message: `成功更新${userIds.length}个用户的状态`\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// 生成等级卡（管理员用）\n+router.post('/generate-cards', adminAuth, async (req, res, next) => {\n+  try {\n+    const { cardTypeId, count = 5 } = req.body;\n+\n+    if (!cardTypeId) {\n+      return res.status(400).json({\n+        success: false,\n+        message: '请选择等级卡类型'\n+      });\n+    }\n+\n+    if (!count || count <= 0 || count > 100) {\n+      return res.status(400).json({\n+        success: false,\n+        message: '生成数量必须在1-100之间'\n+      });\n+    }\n+\n+    console.log(`🎫 开始生成${count}张等级卡，类型ID: ${cardTypeId}...`);\n+\n+    // 确保level_cards表存在\n+    await query(`\n+      CREATE TABLE IF NOT EXISTS level_cards (\n+        id INT AUTO_INCREMENT PRIMARY KEY,\n+        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT '卡号',\n+        card_password VARCHAR(20) NOT NULL COMMENT '卡密',\n+        type_id INT NOT NULL COMMENT '等级卡类型ID',\n+        total_points INT NOT NULL COMMENT '总积分',\n+        remaining_points INT NOT NULL COMMENT '剩余积分',\n+        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT '状态',\n+        bound_user_id INT NULL COMMENT '绑定的用户ID',\n+        bound_at DATETIME NULL COMMENT '绑定时间',\n+        expires_at DATETIME NULL COMMENT '过期时间',\n+        created_at DATETIME NOT NULL,\n+        updated_at DATETIME NULL,\n+        INDEX idx_card_number (card_number),\n+        INDEX idx_bound_user (bound_user_id),\n+        INDEX idx_status (status)\n+      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+    `);\n+\n+    // 获取卡片类型信息\n+    const cardTypeResult = await query(`\n+      SELECT id, name, points, price, description\n+      FROM level_card_types\n+      WHERE id = ?\n+    `, [cardTypeId]);\n+\n+    if (cardTypeResult.length === 0) {\n+      return res.status(400).json({\n+        success: false,\n+        message: '无效的卡片类型'\n+      });\n+    }\n+\n+    const typeInfo = cardTypeResult[0];\n+    const generatedCards = [];\n+\n+    // 批量生成等级卡\n+    for (let i = 1; i <= count; i++) {\n+      const cardNumber = generateCardNumber(typeInfo.name, i);\n+      const cardPassword = generateCardPassword();\n+\n+      await query(`\n+        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n+        VALUES (?, ?, ?, ?, NOW())\n+      `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+\n+      generatedCards.push({\n+        cardNumber,\n+        cardPassword,\n+        typeName: typeInfo.name,\n+        points: typeInfo.points,\n+        price: typeInfo.price\n+      });\n+    }\n+\n+    console.log(`✅ 成功生成${count}张${typeInfo.name}`);\n+\n+    res.json({\n+      success: true,\n+      message: `成功生成${count}张${typeInfo.name}`,\n+      data: {\n+        cards: generatedCards,\n+        cardType: typeInfo.name,\n+        totalGenerated: count\n+      }\n+    });\n+\n+  } catch (error) {\n+    console.error('❌ 生成等级卡失败:', error);\n+    next(error);\n+  }\n+});\n+\n+// 生成体验卡\n+router.post('/generate-experience-cards', adminAuth, async (req, res, next) => {\n+  try {\n+    const { count = 1 } = req.body;\n+    console.log(`🎫 管理员请求生成${count}张体验卡...`);\n+\n+    // 获取体验卡类型信息 - 修复表名，遵循开发原则\n+    const cardTypeResult = await query(`\n+      SELECT id, name, points, price\n+      FROM card_types\n+      WHERE name = '体验卡'\n+    `);\n+\n+    if (cardTypeResult.length === 0) {\n+      return res.status(400).json({\n+        success: false,\n+        message: '体验卡类型不存在'\n+      });\n+    }\n+\n+    const typeInfo = cardTypeResult[0];\n+    const generatedCards = [];\n+\n+    // 批量生成体验卡\n+    for (let i = 1; i <= count; i++) {\n+      const cardNumber = generateCardNumber('体验卡', i);\n+      const cardPassword = generateCardPassword();\n+\n+      await query(`\n+        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n+        VALUES (?, ?, ?, ?, NOW())\n+      `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+\n+      generatedCards.push({\n+        cardNumber,\n+        cardPassword,\n+        typeName: typeInfo.name,\n+        points: typeInfo.points\n+      });\n+    }\n+\n+    console.log(`✅ 成功生成${count}张体验卡`);\n+\n+    res.json({\n+      success: true,\n+      message: `成功生成${count}张体验卡`,\n+      data: {\n+        cards: generatedCards,\n+        cardType: typeInfo.name,\n+        totalGenerated: count\n+      }\n+    });\n+\n+  } catch (error) {\n+    console.error('❌ 生成体验卡失败:', error);\n+    next(error);\n+  }\n+});\n+\n+// 获取体验卡统计信息\n+router.get('/experience-cards-stats', adminAuth, async (req, res, next) => {\n+  try {\n+    // 获取体验卡统计\n+    const stats = await query(`\n+      SELECT\n+        COUNT(*) as total_cards,\n+        COUNT(CASE WHEN bound_user_id IS NULL THEN 1 END) as available_cards,\n+        COUNT(CASE WHEN bound_user_id IS NOT NULL THEN 1 END) as bound_cards,\n+        SUM(CASE WHEN bound_user_id IS NULL THEN remaining_points ELSE 0 END) as available_points,\n+        SUM(CASE WHEN bound_user_id IS NOT NULL THEN remaining_points ELSE 0 END) as bound_points\n+      FROM level_cards lc\n+      JOIN card_types ct ON lc.type_id = ct.id\n+      WHERE ct.name = '体验卡'\n+    `);\n+\n+    // 获取可用体验卡列表\n+    const availableCards = await getAvailableExperienceCards();\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        stats: stats[0],\n+        availableCards: availableCards.slice(0, 10) // 只返回前10张作为示例\n+      }\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// 测试数据库连接（管理员用）\n+router.post('/test-database', adminAuth, async (req, res, next) => {\n+  try {\n+    // 简单的数据库连接测试\n+    await query('SELECT 1 as test');\n+\n+    res.json({\n+      success: true,\n+      message: '数据库连接测试成功'\n+    });\n+\n+  } catch (error) {\n+    console.error('❌ 数据库连接测试失败:', error);\n+    res.status(500).json({\n+      success: false,\n+      message: '数据库连接测试失败: ' + error.message\n+    });\n+  }\n+});\n+\n+// 测试ComfyUI连接（管理员用）\n+router.post('/test-comfyui', adminAuth, async (req, res, next) => {\n+  try {\n+    // 从请求体获取服务器地址，如果没有则使用默认配置\n+    let serverUrl = req.body?.serverUrl;\n+\n+    // 如果没有提供服务器地址，从数据库获取配置\n+    if (!serverUrl) {\n+      try {\n+        const [configRows] = await query(\n+          'SELECT config_value FROM system_config WHERE config_key = ?',\n+          ['comfyui.server_url']\n+        );\n+        serverUrl = configRows.length > 0 ? configRows[0].config_value : 'https://your-comfyui-server.com';\n+      } catch (dbError) {\n+        console.error('获取ComfyUI配置失败:', dbError);\n+        serverUrl = 'https://your-comfyui-server.com';\n+      }\n+    }\n+\n+    // 确保URL格式正确\n+    if (serverUrl && !serverUrl.startsWith('http')) {\n+      serverUrl = 'https://' + serverUrl;\n+    }\n+\n+    // 移除末尾的斜杠\n+    if (serverUrl && serverUrl.endsWith('/')) {\n+      serverUrl = serverUrl.slice(0, -1);\n+    }\n+\n+    console.log('🧪 测试ComfyUI连接:', serverUrl);\n+\n+    // 测试ComfyUI连接\n+    const fetch = require('node-fetch');\n+\n+    // 尝试多个端点来检测ComfyUI服务器\n+    const testEndpoints = [\n+      `${serverUrl}/system_stats`,  // ComfyUI系统状态端点\n+      `${serverUrl}/history`,       // ComfyUI历史记录端点\n+      `${serverUrl}/`,              // 根路径\n+    ];\n+\n+    let lastError = null;\n+    let response = null;\n+\n+    // 依次尝试不同的端点\n+    for (const testUrl of testEndpoints) {\n+      try {\n+        console.log(`🔍 尝试端点: ${testUrl}`);\n+\n+        response = await fetch(testUrl, {\n+          method: 'GET',\n+          timeout: 10000,\n+          headers: {\n+            'User-Agent': 'ComfyUI-Admin-Test/1.0'\n+          }\n+        });\n+\n+        console.log(`📡 端点 ${testUrl} 响应状态:`, response.status, response.statusText);\n+\n+        // 如果得到响应（即使是错误状态码），说明服务器是可达的\n+        if (response) {\n+          break;\n+        }\n+      } catch (error) {\n+        console.log(`❌ 端点 ${testUrl} 失败:`, error.message);\n+        lastError = error;\n+        continue;\n+      }\n+    }\n+\n+    // 如果所有端点都失败了\n+    if (!response) {\n+      throw lastError || new Error('所有测试端点都无法访问');\n+    }\n+\n+    if (response.status === 200) {\n+      // 服务器正常响应\n+      res.json({\n+        success: true,\n+        message: 'ComfyUI服务器连接成功',\n+        data: {\n+          serverUrl,\n+          status: 'connected',\n+          statusCode: response.status,\n+          message: '服务器可正常访问'\n+        }\n+      });\n+    } else if (response.status === 401) {\n+      // 服务器需要认证，但可以连接\n+      res.json({\n+        success: true,\n+        message: 'ComfyUI服务器连接成功（需要认证）',\n+        data: {\n+          serverUrl,\n+          status: 'connected_auth_required',\n+          statusCode: response.status,\n+          message: '服务器可访问，但需要认证'\n+        }\n+      });\n+    } else if (response.status === 404) {\n+      // 路径不存在，但服务器可达\n+      res.json({\n+        success: true,\n+        message: 'ComfyUI服务器连接成功',\n+        data: {\n+          serverUrl,\n+          status: 'connected',\n+          statusCode: response.status,\n+          message: '服务器可访问（路径不存在是正常的）'\n+        }\n+      });\n+    } else {\n+      // 其他状态码\n+      res.json({\n+        success: false,\n+        message: `ComfyUI服务器响应异常: ${response.status} ${response.statusText}`,\n+        data: {\n+          serverUrl,\n+          status: 'error',\n+          statusCode: response.status\n+        }\n+      });\n+    }\n+\n+  } catch (error) {\n+    console.error('❌ ComfyUI连接测试失败:', error);\n+\n+    if (error.code === 'ENOTFOUND') {\n+      res.status(500).json({\n+        success: false,\n+        message: 'ComfyUI服务器域名无法解析，请检查服务器地址是否正确',\n+        data: {\n+          serverUrl: serverUrl || 'unknown',\n+          status: 'dns_error',\n+          error: error.code,\n+          message: 'Domain name resolution failed'\n+        }\n+      });\n+    } else if (error.code === 'ECONNREFUSED') {\n+      res.status(500).json({\n+        success: false,\n+        message: 'ComfyUI服务器拒绝连接，请检查服务器是否运行',\n+        data: {\n+          serverUrl: serverUrl || 'unknown',\n+          status: 'connection_refused',\n+          error: error.code,\n+          message: 'Connection refused by server'\n+        }\n+      });\n+    } else if (error.name === 'AbortError' || error.message.includes('timeout')) {\n+      res.status(500).json({\n+        success: false,\n+        message: 'ComfyUI服务器连接超时，请检查网络连接',\n+        data: {\n+          serverUrl: serverUrl || 'unknown',\n+          status: 'timeout',\n+          error: 'timeout',\n+          message: 'Connection timeout'\n+        }\n+      });\n+    } else {\n+      res.status(500).json({\n+        success: false,\n+        message: 'ComfyUI连接测试失败: ' + error.message,\n+        data: {\n+          serverUrl: serverUrl || 'unknown',\n+          status: 'error',\n+          error: error.message,\n+          message: 'Unknown connection error'\n+        }\n+      });\n+    }\n+  }\n+});\n+\n+// 生成卡密函数已在文件开头定义，这里删除重复定义\n+\n+module.exports = router;\n"
                },
                {
                    "date": 1752347560789,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -404,9 +404,9 @@\n     // 首先检查表是否存在\n     try {\n       const cardTypes = await query(`\n         SELECT id, name, icon, points, price, description\n-        FROM level_card_types\n+        FROM card_types\n         ORDER BY points ASC\n       `);\n \n       console.log('✅ 成功获取等级卡类型:', cardTypes.length, '个');\n@@ -1360,1367 +1360,4 @@\n \n // 生成卡密函数已在文件开头定义，这里删除重复定义\n \n module.exports = router;\n-const express = require('express');\n-const router = express.Router();\n-const { query } = require('../config/database');\n-const { createExperienceCardSystem, getAvailableExperienceCards } = require('../scripts/create-experience-cards');\n-const { adminAuth } = require('../middleware/adminAuth');\n-\n-// 生成卡号的辅助函数\n-function generateCardNumber(cardType, index) {\n-  const typePrefix = {\n-    '基础卡': 'BC',\n-    '高级卡': 'AC',\n-    '至尊卡': 'PC',\n-    '体验卡': 'EXP'\n-  };\n-\n-  const prefix = typePrefix[cardType] || 'CARD';\n-  const timestamp = Date.now().toString().slice(-8); // 取时间戳后8位\n-  const indexStr = String(index).padStart(2, '0'); // 序号补零到2位\n-\n-  return `${prefix}${timestamp}${indexStr}`;\n-}\n-\n-// 生成卡密的辅助函数\n-function generateCardPassword() {\n-  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n-  let password = '';\n-  for (let i = 0; i < 8; i++) {\n-    password += chars.charAt(Math.floor(Math.random() * chars.length));\n-  }\n-  return password;\n-}\n-\n-\n-\n-// 获取系统统计信息\n-router.get('/stats', adminAuth, async (req, res, next) => {\n-  try {\n-    // 用户统计\n-    const userStats = await query(`\n-      SELECT\n-        COUNT(*) as total_users,\n-        COUNT(CASE WHEN status = 'active' THEN 1 END) as active_users,\n-        COUNT(CASE WHEN status = 'inactive' THEN 1 END) as inactive_users,\n-        COUNT(CASE WHEN status = 'banned' THEN 1 END) as banned_users,\n-        COUNT(CASE WHEN DATE(created_at) = CURDATE() THEN 1 END) as today_new_users\n-      FROM users\n-    `);\n-\n-    // 等级卡统计\n-    const cardStats = await query(`\n-      SELECT\n-        COUNT(*) as total_cards,\n-        COUNT(CASE WHEN bound_user_id IS NOT NULL THEN 1 END) as bound_cards,\n-        COUNT(CASE WHEN bound_user_id IS NULL THEN 1 END) as available_cards,\n-        SUM(remaining_points) as total_remaining_points,\n-        COUNT(CASE WHEN ct.name = '体验卡' THEN 1 END) as experience_cards,\n-        COUNT(CASE WHEN ct.name != '体验卡' THEN 1 END) as level_cards\n-      FROM level_cards lc\n-      LEFT JOIN card_types ct ON lc.type_id = ct.id\n-    `);\n-\n-    // 积分消费统计\n-    const pointsStats = await query(`\n-      SELECT\n-        COUNT(*) as total_transactions,\n-        SUM(points_amount) as total_points_consumed,\n-        COUNT(CASE WHEN DATE(created_at) = CURDATE() THEN 1 END) as today_transactions,\n-        SUM(CASE WHEN DATE(created_at) = CURDATE() THEN points_amount ELSE 0 END) as today_points_consumed\n-      FROM point_logs\n-      WHERE action_type = 'consume'\n-    `);\n-\n-    // 最近7天的用户注册趋势\n-    const userTrend = await query(`\n-      SELECT\n-        DATE(created_at) as date,\n-        COUNT(*) as count\n-      FROM users\n-      WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)\n-      GROUP BY DATE(created_at)\n-      ORDER BY date DESC\n-    `);\n-\n-    // 最近7天的积分消费趋势\n-    const pointsTrend = await query(`\n-      SELECT\n-        DATE(created_at) as date,\n-        COUNT(*) as transactions,\n-        SUM(points_amount) as points_consumed\n-      FROM point_logs\n-      WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)\n-        AND action_type = 'consume'\n-      GROUP BY DATE(created_at)\n-      ORDER BY date DESC\n-    `);\n-\n-    res.json({\n-      success: true,\n-      data: {\n-        users: userStats[0],\n-        cards: cardStats[0],\n-        points: pointsStats[0],\n-        trends: {\n-          users: userTrend,\n-          points: pointsTrend\n-        }\n-      }\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// 获取用户列表（管理员用）\n-router.get('/users', adminAuth, async (req, res, next) => {\n-  try {\n-    const page = parseInt(req.query.page) || 1;\n-    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n-    const offset = (page - 1) * limit;\n-    const status = req.query.status;\n-    const search = req.query.search;\n-\n-    let whereClause = '';\n-    let queryParams = [];\n-\n-    // 构建查询条件\n-    const conditions = [];\n-    if (status) {\n-      conditions.push('status = ?');\n-      queryParams.push(status);\n-    }\n-    if (search) {\n-      conditions.push('(username LIKE ? OR email LIKE ?)');\n-      queryParams.push(`%${search}%`, `%${search}%`);\n-    }\n-\n-    if (conditions.length > 0) {\n-      whereClause = 'WHERE ' + conditions.join(' AND ');\n-    }\n-\n-    // 获取用户总数\n-    const countQuery = `SELECT COUNT(*) as total FROM users ${whereClause}`;\n-    const countResult = await query(countQuery, queryParams);\n-    const total = countResult[0].total;\n-\n-    // 获取用户列表\n-    const usersQuery = `\n-      SELECT u.id, u.username, u.email, u.status, u.created_at, u.last_login,\n-             COUNT(lc.id) as bound_cards,\n-             COALESCE(SUM(lc.remaining_points), 0) as total_points\n-      FROM users u\n-      LEFT JOIN level_cards lc ON u.id = lc.bound_user_id\n-      ${whereClause}\n-      GROUP BY u.id\n-      ORDER BY u.created_at DESC\n-      LIMIT ? OFFSET ?\n-    `;\n-\n-    const users = await query(usersQuery, [...queryParams, limit, offset]);\n-\n-    res.json({\n-      success: true,\n-      data: {\n-        items: users,\n-        total,\n-        page,\n-        pageSize: limit,\n-        totalPages: Math.ceil(total / limit)\n-      }\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// 获取用户详情（管理员用）\n-router.get('/users/:id', adminAuth, async (req, res, next) => {\n-  try {\n-    const userId = req.params.id;\n-\n-    // 获取用户基本信息\n-    const userResult = await query(`\n-      SELECT id, username, email, status, created_at, updated_at, last_login\n-      FROM users\n-      WHERE id = ?\n-    `, [userId]);\n-\n-    if (userResult.length === 0) {\n-      return res.status(404).json({\n-        success: false,\n-        message: '用户不存在'\n-      });\n-    }\n-\n-    const user = userResult[0];\n-\n-    // 获取用户绑定的等级卡\n-    const cards = await query(`\n-      SELECT lc.id, lc.card_number, lc.remaining_points, lc.bound_at,\n-             ct.name as type_name, ct.icon, ct.points as total_points\n-      FROM level_cards lc\n-      JOIN card_types ct ON lc.type_id = ct.id\n-      WHERE lc.bound_user_id = ?\n-      ORDER BY lc.bound_at DESC\n-    `, [userId]);\n-\n-    // 获取用户积分消费记录\n-    const pointsHistory = await query(`\n-      SELECT id, action_type, points_amount, description, url, created_at\n-      FROM point_logs\n-      WHERE user_id = ?\n-      ORDER BY created_at DESC\n-      LIMIT 20\n-    `, [userId]);\n-\n-    res.json({\n-      success: true,\n-      data: {\n-        user,\n-        cards,\n-        pointsHistory,\n-        summary: {\n-          totalCards: cards.length,\n-          totalPoints: cards.reduce((sum, card) => sum + card.remaining_points, 0),\n-          totalConsumed: pointsHistory\n-            .filter(log => log.action_type === 'consume')\n-            .reduce((sum, log) => sum + log.points_amount, 0)\n-        }\n-      }\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// 更新用户状态（管理员用）\n-router.put('/users/:id/status', adminAuth, async (req, res, next) => {\n-  try {\n-    const userId = req.params.id;\n-    const { status } = req.body;\n-\n-    if (!['active', 'inactive', 'banned'].includes(status)) {\n-      return res.status(400).json({\n-        success: false,\n-        message: '无效的用户状态'\n-      });\n-    }\n-\n-    await query(`\n-      UPDATE users\n-      SET status = ?, updated_at = NOW()\n-      WHERE id = ?\n-    `, [status, userId]);\n-\n-    res.json({\n-      success: true,\n-      message: '用户状态更新成功'\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// 封禁用户（管理员用）\n-router.post('/users/:id/ban', adminAuth, async (req, res, next) => {\n-  try {\n-    const userId = req.params.id;\n-\n-    await query(`\n-      UPDATE users\n-      SET status = 'banned', updated_at = NOW()\n-      WHERE id = ?\n-    `, [userId]);\n-\n-    res.json({\n-      success: true,\n-      message: '用户已封禁'\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// 解封用户（管理员用）\n-router.post('/users/:id/unban', adminAuth, async (req, res, next) => {\n-  try {\n-    const userId = req.params.id;\n-\n-    await query(`\n-      UPDATE users\n-      SET status = 'active', updated_at = NOW()\n-      WHERE id = ?\n-    `, [userId]);\n-\n-    res.json({\n-      success: true,\n-      message: '用户已解封'\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// 初始化等级卡数据库表\n-router.post('/init-level-cards', async (req, res, next) => {\n-  try {\n-    console.log('🗃️ 开始创建等级卡相关数据库表...');\n-\n-    // 1. 创建等级卡类型表\n-    console.log('📝 创建等级卡类型表...');\n-    await query(`\n-      CREATE TABLE IF NOT EXISTS level_card_types (\n-        id INT AUTO_INCREMENT PRIMARY KEY,\n-        name VARCHAR(50) NOT NULL COMMENT '等级卡名称',\n-        icon VARCHAR(10) NOT NULL COMMENT '等级卡图标',\n-        price DECIMAL(10,2) NOT NULL COMMENT '价格',\n-        points INT NOT NULL COMMENT '积分数量',\n-        description TEXT COMMENT '描述',\n-        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-        updated_at DATETIME NULL\n-      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-    `);\n-    console.log('✅ 等级卡类型表创建成功');\n-\n-    // 2. 创建等级卡表\n-    console.log('📝 创建等级卡表...');\n-    await query(`\n-      CREATE TABLE IF NOT EXISTS level_cards (\n-        id INT AUTO_INCREMENT PRIMARY KEY,\n-        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT '卡号',\n-        card_password VARCHAR(20) NOT NULL COMMENT '卡密',\n-        type_id INT NOT NULL COMMENT '等级卡类型ID',\n-        total_points INT NOT NULL COMMENT '总积分',\n-        remaining_points INT NOT NULL COMMENT '剩余积分',\n-        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT '状态',\n-        bound_user_id INT NULL COMMENT '绑定的用户ID',\n-        bound_at DATETIME NULL COMMENT '绑定时间',\n-        expires_at DATETIME NULL COMMENT '过期时间',\n-        created_at DATETIME NOT NULL,\n-        updated_at DATETIME NULL,\n-        FOREIGN KEY (type_id) REFERENCES level_card_types(id),\n-        FOREIGN KEY (bound_user_id) REFERENCES users(id),\n-        INDEX idx_card_number (card_number),\n-        INDEX idx_bound_user (bound_user_id),\n-        INDEX idx_status (status)\n-      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-    `);\n-    console.log('✅ 等级卡表创建成功');\n-\n-    // 3. 创建等级卡使用记录表\n-    console.log('📝 创建等级卡交易记录表...');\n-    await query(`\n-      CREATE TABLE IF NOT EXISTS level_card_transactions (\n-        id INT AUTO_INCREMENT PRIMARY KEY,\n-        card_id INT NOT NULL COMMENT '等级卡ID',\n-        user_id INT NOT NULL COMMENT '用户ID',\n-        type ENUM('bind', 'consume') NOT NULL COMMENT '交易类型',\n-        points_amount INT NOT NULL COMMENT '积分数量',\n-        remaining_points INT NOT NULL COMMENT '操作后剩余积分',\n-        description VARCHAR(255) COMMENT '描述',\n-        created_at DATETIME NOT NULL,\n-        FOREIGN KEY (card_id) REFERENCES level_cards(id),\n-        FOREIGN KEY (user_id) REFERENCES users(id),\n-        INDEX idx_card_user (card_id, user_id),\n-        INDEX idx_created_at (created_at)\n-      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-    `);\n-    console.log('✅ 等级卡交易记录表创建成功');\n-\n-    // 4. 插入等级卡类型数据（包含体验卡）\n-    const existingTypes = await query('SELECT COUNT(*) as count FROM level_card_types');\n-    if (existingTypes[0].count === 0) {\n-      await query(`\n-        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n-        ('体验卡', '🎁', 0.00, 20, '免费体验卡，每张20积分'),\n-        ('基础卡', '🥉', 9.90, 300, '适合轻度使用的用户'),\n-        ('高级卡', '🥈', 30.00, 1000, '适合中度使用的用户'),\n-        ('至尊卡', '🥇', 50.00, 2000, '适合重度使用的用户')\n-      `);\n-    }\n-\n-    res.json({\n-      success: true,\n-      message: '等级卡数据库表创建成功'\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-\n-// 获取等级卡类型列表（管理员用）\n-router.get('/card-types', adminAuth, async (req, res, next) => {\n-  try {\n-    console.log('🔍 获取等级卡类型列表...');\n-\n-    // 首先检查表是否存在\n-    try {\n-      const cardTypes = await query(`\n-        SELECT id, name, icon, points, price, description\n-        FROM level_card_types\n-        ORDER BY points ASC\n-      `);\n-\n-      console.log('✅ 成功获取等级卡类型:', cardTypes.length, '个');\n-      res.json({\n-        success: true,\n-        data: {\n-          cardTypes\n-        }\n-      });\n-    } catch (tableError) {\n-      console.log('⚠️ 等级卡类型表不存在，尝试创建...');\n-\n-      // 创建表和初始数据\n-      await query(`\n-        CREATE TABLE IF NOT EXISTS level_card_types (\n-          id INT AUTO_INCREMENT PRIMARY KEY,\n-          name VARCHAR(50) NOT NULL COMMENT '等级卡名称',\n-          icon VARCHAR(10) NOT NULL COMMENT '等级卡图标',\n-          price DECIMAL(10,2) NOT NULL COMMENT '价格',\n-          points INT NOT NULL COMMENT '积分数量',\n-          description TEXT COMMENT '描述',\n-          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-          updated_at DATETIME NULL\n-        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-      `);\n-\n-      // 插入初始数据\n-      await query(`\n-        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n-        ('体验卡', '🎁', 0.00, 20, '免费体验卡，每张20积分'),\n-        ('基础卡', '🥉', 9.90, 300, '适合轻度使用的用户'),\n-        ('高级卡', '🥈', 30.00, 1000, '适合中度使用的用户'),\n-        ('至尊卡', '🥇', 50.00, 2000, '适合重度使用的用户')\n-      `);\n-\n-      // 重新获取数据\n-      const cardTypes = await query(`\n-        SELECT id, name, icon, points, price, description\n-        FROM level_card_types\n-        ORDER BY points ASC\n-      `);\n-\n-      console.log('✅ 表创建成功，获取等级卡类型:', cardTypes.length, '个');\n-      res.json({\n-        success: true,\n-        data: {\n-          cardTypes\n-        }\n-      });\n-    }\n-  } catch (error) {\n-    console.error('❌ 获取等级卡类型失败:', error);\n-    next(error);\n-  }\n-});\n-\n-// 获取所有等级卡列表（管理员用）\n-router.get('/cards', adminAuth, async (req, res, next) => {\n-  try {\n-    const page = parseInt(req.query.page) || 1;\n-    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n-    const offset = (page - 1) * limit;\n-    const status = req.query.status;\n-    const cardType = req.query.type;\n-    const search = req.query.search;\n-\n-    let whereClause = '';\n-    let queryParams = [];\n-\n-    // 构建查询条件\n-    const conditions = [];\n-    if (status) {\n-      conditions.push('lc.status = ?');\n-      queryParams.push(status);\n-    }\n-    if (cardType) {\n-      conditions.push('ct.name = ?');\n-      queryParams.push(cardType);\n-    }\n-    if (search) {\n-      conditions.push('(lc.card_number LIKE ? OR u.username LIKE ?)');\n-      queryParams.push(`%${search}%`, `%${search}%`);\n-    }\n-\n-    if (conditions.length > 0) {\n-      whereClause = 'WHERE ' + conditions.join(' AND ');\n-    }\n-\n-    // 获取等级卡总数\n-    const countQuery = `\n-      SELECT COUNT(*) as total\n-      FROM level_cards lc\n-      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n-      LEFT JOIN users u ON lc.bound_user_id = u.id\n-      ${whereClause}\n-    `;\n-    const countResult = await query(countQuery, queryParams);\n-    const total = countResult[0].total;\n-\n-    // 获取等级卡列表\n-    const cardsQuery = `\n-      SELECT lc.id, lc.card_number, lc.card_password, lc.remaining_points,\n-             lc.bound_at, lc.created_at,\n-             ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n-             u.username as bound_username, u.id as bound_user_id\n-      FROM level_cards lc\n-      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n-      LEFT JOIN users u ON lc.bound_user_id = u.id\n-      ${whereClause}\n-      ORDER BY lc.created_at DESC\n-      LIMIT ? OFFSET ?\n-    `;\n-\n-    const cards = await query(cardsQuery, [...queryParams, limit, offset]);\n-\n-    res.json({\n-      success: true,\n-      data: {\n-        items: cards,\n-        total,\n-        page,\n-        pageSize: limit,\n-        totalPages: Math.ceil(total / limit)\n-      }\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// 获取等级卡详情（管理员用）\n-router.get('/cards/:id', adminAuth, async (req, res, next) => {\n-  try {\n-    const cardId = req.params.id;\n-\n-    // 获取等级卡基本信息\n-    const cardResult = await query(`\n-      SELECT lc.id, lc.card_number, lc.card_password, lc.remaining_points,\n-             lc.bound_at, lc.created_at,\n-             ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n-             u.username as bound_username, u.id as bound_user_id, u.email as bound_user_email\n-      FROM level_cards lc\n-      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n-      LEFT JOIN users u ON lc.bound_user_id = u.id\n-      WHERE lc.id = ?\n-    `, [cardId]);\n-\n-    if (cardResult.length === 0) {\n-      return res.status(404).json({\n-        success: false,\n-        message: '等级卡不存在'\n-      });\n-    }\n-\n-    const card = cardResult[0];\n-\n-    // 获取该卡的使用记录\n-    const usageHistory = await query(`\n-      SELECT id, action_type, points_amount, description, url, created_at\n-      FROM point_logs\n-      WHERE user_id = ? AND description LIKE '%${card.card_number}%'\n-      ORDER BY created_at DESC\n-      LIMIT 20\n-    `, [card.bound_user_id]);\n-\n-    res.json({\n-      success: true,\n-      data: {\n-        card,\n-        usageHistory,\n-        summary: {\n-          totalUsed: card.total_points - card.remaining_points,\n-          usageCount: usageHistory.filter(log => log.action_type === 'consume').length\n-        }\n-      }\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// 禁用/启用等级卡（管理员用）\n-router.put('/cards/:id/status', adminAuth, async (req, res, next) => {\n-  try {\n-    const cardId = req.params.id;\n-    const { status } = req.body;\n-\n-    if (!['active', 'disabled', 'expired'].includes(status)) {\n-      return res.status(400).json({\n-        success: false,\n-        message: '无效的等级卡状态'\n-      });\n-    }\n-\n-    await query(`\n-      UPDATE level_cards\n-      SET status = ?\n-      WHERE id = ?\n-    `, [status, cardId]);\n-\n-    res.json({\n-      success: true,\n-      message: '等级卡状态更新成功'\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// 解绑等级卡（管理员用）\n-router.put('/cards/:id/unbind', adminAuth, async (req, res, next) => {\n-  try {\n-    const cardId = req.params.id;\n-\n-    await query(`\n-      UPDATE level_cards\n-      SET bound_user_id = NULL, bound_at = NULL\n-      WHERE id = ?\n-    `, [cardId]);\n-\n-    res.json({\n-      success: true,\n-      message: '等级卡解绑成功'\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// 获取积分记录列表（管理员用）- 兼容新前端路径\n-router.get('/points-logs', adminAuth, async (req, res, next) => {\n-  try {\n-    const page = parseInt(req.query.page) || 1;\n-    const pageSize = parseInt(req.query.pageSize) || 20;\n-    const offset = (page - 1) * pageSize;\n-    const actionType = req.query.type;\n-    const search = req.query.search;\n-\n-    let whereClause = '';\n-    let queryParams = [];\n-\n-    // 构建查询条件\n-    const conditions = [];\n-    if (actionType) {\n-      conditions.push('pl.action_type = ?');\n-      queryParams.push(actionType);\n-    }\n-    if (search) {\n-      conditions.push('u.username LIKE ?');\n-      queryParams.push(`%${search}%`);\n-    }\n-\n-    if (conditions.length > 0) {\n-      whereClause = 'WHERE ' + conditions.join(' AND ');\n-    }\n-\n-    // 获取积分记录总数\n-    const countQuery = `\n-      SELECT COUNT(*) as total\n-      FROM point_logs pl\n-      LEFT JOIN users u ON pl.user_id = u.id\n-      ${whereClause}\n-    `;\n-    const countResult = await query(countQuery, queryParams);\n-    const total = countResult[0].total;\n-\n-    // 获取积分记录列表\n-    const pointsQuery = `\n-      SELECT pl.id, pl.action_type, pl.points_amount, pl.description, pl.url, pl.created_at,\n-             u.username, u.id as user_id\n-      FROM point_logs pl\n-      LEFT JOIN users u ON pl.user_id = u.id\n-      ${whereClause}\n-      ORDER BY pl.created_at DESC\n-      LIMIT ? OFFSET ?\n-    `;\n-\n-    const pointsLogs = await query(pointsQuery, [...queryParams, pageSize, offset]);\n-\n-    res.json({\n-      success: true,\n-      data: {\n-        items: pointsLogs,\n-        total,\n-        page,\n-        pageSize,\n-        totalPages: Math.ceil(total / pageSize)\n-      }\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// 获取积分记录列表（管理员用）- 保持原有接口兼容性\n-router.get('/points', adminAuth, async (req, res, next) => {\n-  try {\n-    const page = parseInt(req.query.page) || 1;\n-    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n-    const offset = (page - 1) * limit;\n-    const actionType = req.query.type;\n-    const search = req.query.search;\n-\n-    let whereClause = '';\n-    let queryParams = [];\n-\n-    // 构建查询条件\n-    const conditions = [];\n-    if (actionType) {\n-      conditions.push('pl.action_type = ?');\n-      queryParams.push(actionType);\n-    }\n-    if (search) {\n-      conditions.push('u.username LIKE ?');\n-      queryParams.push(`%${search}%`);\n-    }\n-\n-    if (conditions.length > 0) {\n-      whereClause = 'WHERE ' + conditions.join(' AND ');\n-    }\n-\n-    // 获取积分记录总数\n-    const countQuery = `\n-      SELECT COUNT(*) as total\n-      FROM point_logs pl\n-      LEFT JOIN users u ON pl.user_id = u.id\n-      ${whereClause}\n-    `;\n-    const countResult = await query(countQuery, queryParams);\n-    const total = countResult[0].total;\n-\n-    // 获取积分记录列表\n-    const pointsQuery = `\n-      SELECT pl.id, pl.action_type, pl.points_amount, pl.description, pl.url, pl.created_at,\n-             u.username, u.id as user_id\n-      FROM point_logs pl\n-      LEFT JOIN users u ON pl.user_id = u.id\n-      ${whereClause}\n-      ORDER BY pl.created_at DESC\n-      LIMIT ? OFFSET ?\n-    `;\n-\n-    const pointsLogs = await query(pointsQuery, [...queryParams, limit, offset]);\n-\n-    res.json({\n-      success: true,\n-      data: {\n-        items: pointsLogs,\n-        total,\n-        page,\n-        pageSize: limit,\n-        totalPages: Math.ceil(total / limit)\n-      }\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// 获取系统配置信息（管理员用）\n-router.get('/config', adminAuth, async (req, res, next) => {\n-  try {\n-    console.log('📥 从数据库加载系统配置...');\n-\n-    // 从数据库获取所有配置\n-    const configs = await query(`\n-      SELECT config_key, config_value, config_type, config_group, description, is_encrypted\n-      FROM system_config\n-      ORDER BY config_group, config_key\n-    `);\n-\n-    console.log(`📊 从数据库加载了${configs.length}项配置`);\n-\n-    // 按分组组织配置\n-    const groupedConfigs = {};\n-    configs.forEach(config => {\n-      const group = config.config_group || 'general';\n-\n-      if (!groupedConfigs[group]) {\n-        groupedConfigs[group] = [];\n-      }\n-\n-      // 处理敏感配置显示\n-      let displayValue = config.config_value;\n-      if (config.is_encrypted && config.config_value) {\n-        // 对于敏感配置，显示掩码\n-        if (config.config_key.includes('password') || config.config_key.includes('secret')) {\n-          displayValue = '***';\n-        }\n-      }\n-\n-      groupedConfigs[group].push({\n-        config_key: config.config_key,\n-        config_value: displayValue,\n-        config_type: config.config_type || 'string',\n-        description: config.description || '',\n-        is_encrypted: config.is_encrypted || 0\n-      });\n-    });\n-\n-    // 确保所有必要的分组都存在\n-    const requiredGroups = ['server', 'database', 'jwt', 'comfyui', 'ai', 'frontend', 'cors', 'upload', 'log'];\n-    requiredGroups.forEach(group => {\n-      if (!groupedConfigs[group]) {\n-        groupedConfigs[group] = [];\n-      }\n-    });\n-\n-    console.log('📋 配置分组统计:');\n-    Object.keys(groupedConfigs).forEach(group => {\n-      console.log(`   ${group}: ${groupedConfigs[group].length} 项配置`);\n-    });\n-\n-    res.json({\n-      success: true,\n-      data: groupedConfigs\n-    });\n-\n-  } catch (error) {\n-    console.error('❌ 加载配置失败:', error);\n-    res.status(500).json({\n-      success: false,\n-      message: '加载配置失败: ' + error.message\n-    });\n-  }\n-});\n-\n-// 保存系统配置（管理员用）\n-router.post('/config', adminAuth, async (req, res, next) => {\n-  try {\n-    const { configs } = req.body;\n-\n-    if (!configs || !Array.isArray(configs)) {\n-      return res.status(400).json({\n-        success: false,\n-        message: '配置数据格式错误'\n-      });\n-    }\n-\n-    console.log('💾 保存系统配置到数据库，共', configs.length, '项');\n-\n-    // 真正保存配置到数据库\n-    const results = [];\n-    let successCount = 0;\n-    let errorCount = 0;\n-\n-    for (const config of configs) {\n-      const { config_key, config_value } = config;\n-\n-      try {\n-        // 更新数据库中的配置\n-        const result = await query(`\n-          UPDATE system_config\n-          SET config_value = ?, updated_at = NOW()\n-          WHERE config_key = ?\n-        `, [config_value, config_key]);\n-\n-        if (result.affectedRows > 0) {\n-          console.log(`  ✅ 保存成功: ${config_key} = ${config_value}`);\n-          results.push({\n-            config_key,\n-            updated: true,\n-            message: '更新成功'\n-          });\n-          successCount++;\n-        } else {\n-          // 如果没有找到配置项，尝试插入新的\n-          try {\n-            await query(`\n-              INSERT INTO system_config (config_key, config_value, config_type, config_group, description)\n-              VALUES (?, ?, 'string', 'custom', '用户自定义配置')\n-            `, [config_key, config_value]);\n-\n-            console.log(`  ✅ 新增成功: ${config_key} = ${config_value}`);\n-            results.push({\n-              config_key,\n-              updated: true,\n-              message: '新增成功'\n-            });\n-            successCount++;\n-          } catch (insertError) {\n-            console.log(`  ❌ 新增失败: ${config_key} - ${insertError.message}`);\n-            results.push({\n-              config_key,\n-              updated: false,\n-              message: '新增失败: ' + insertError.message\n-            });\n-            errorCount++;\n-          }\n-        }\n-      } catch (updateError) {\n-        console.log(`  ❌ 更新失败: ${config_key} - ${updateError.message}`);\n-        results.push({\n-          config_key,\n-          updated: false,\n-          message: '更新失败: ' + updateError.message\n-        });\n-        errorCount++;\n-      }\n-    }\n-\n-    const message = `配置保存完成: ${successCount}项成功, ${errorCount}项失败`;\n-    console.log('📊', message);\n-\n-    res.json({\n-      success: errorCount === 0,\n-      message: message,\n-      data: {\n-        results,\n-        summary: {\n-          total: configs.length,\n-          success: successCount,\n-          error: errorCount\n-        }\n-      }\n-    });\n-\n-  } catch (error) {\n-    console.error('❌ 保存配置失败:', error);\n-    res.status(500).json({\n-      success: false,\n-      message: '保存配置失败: ' + error.message\n-    });\n-  }\n-});\n-\n-// 批量操作用户状态（管理员用）\n-router.put('/users/batch-status', adminAuth, async (req, res, next) => {\n-  try {\n-    const { userIds, status } = req.body;\n-\n-    if (!Array.isArray(userIds) || userIds.length === 0) {\n-      return res.status(400).json({\n-        success: false,\n-        message: '请提供有效的用户ID列表'\n-      });\n-    }\n-\n-    if (!['active', 'inactive', 'banned'].includes(status)) {\n-      return res.status(400).json({\n-        success: false,\n-        message: '无效的用户状态'\n-      });\n-    }\n-\n-    const placeholders = userIds.map(() => '?').join(',');\n-    await query(`\n-      UPDATE users\n-      SET status = ?, updated_at = NOW()\n-      WHERE id IN (${placeholders})\n-    `, [status, ...userIds]);\n-\n-    res.json({\n-      success: true,\n-      message: `成功更新${userIds.length}个用户的状态`\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// 生成等级卡（管理员用）\n-router.post('/generate-cards', adminAuth, async (req, res, next) => {\n-  try {\n-    const { cardTypeId, count = 5 } = req.body;\n-\n-    if (!cardTypeId) {\n-      return res.status(400).json({\n-        success: false,\n-        message: '请选择等级卡类型'\n-      });\n-    }\n-\n-    if (!count || count <= 0 || count > 100) {\n-      return res.status(400).json({\n-        success: false,\n-        message: '生成数量必须在1-100之间'\n-      });\n-    }\n-\n-    console.log(`🎫 开始生成${count}张等级卡，类型ID: ${cardTypeId}...`);\n-\n-    // 确保level_cards表存在\n-    await query(`\n-      CREATE TABLE IF NOT EXISTS level_cards (\n-        id INT AUTO_INCREMENT PRIMARY KEY,\n-        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT '卡号',\n-        card_password VARCHAR(20) NOT NULL COMMENT '卡密',\n-        type_id INT NOT NULL COMMENT '等级卡类型ID',\n-        total_points INT NOT NULL COMMENT '总积分',\n-        remaining_points INT NOT NULL COMMENT '剩余积分',\n-        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT '状态',\n-        bound_user_id INT NULL COMMENT '绑定的用户ID',\n-        bound_at DATETIME NULL COMMENT '绑定时间',\n-        expires_at DATETIME NULL COMMENT '过期时间',\n-        created_at DATETIME NOT NULL,\n-        updated_at DATETIME NULL,\n-        INDEX idx_card_number (card_number),\n-        INDEX idx_bound_user (bound_user_id),\n-        INDEX idx_status (status)\n-      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-    `);\n-\n-    // 获取卡片类型信息\n-    const cardTypeResult = await query(`\n-      SELECT id, name, points, price, description\n-      FROM level_card_types\n-      WHERE id = ?\n-    `, [cardTypeId]);\n-\n-    if (cardTypeResult.length === 0) {\n-      return res.status(400).json({\n-        success: false,\n-        message: '无效的卡片类型'\n-      });\n-    }\n-\n-    const typeInfo = cardTypeResult[0];\n-    const generatedCards = [];\n-\n-    // 批量生成等级卡\n-    for (let i = 1; i <= count; i++) {\n-      const cardNumber = generateCardNumber(typeInfo.name, i);\n-      const cardPassword = generateCardPassword();\n-\n-      await query(`\n-        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n-        VALUES (?, ?, ?, ?, NOW())\n-      `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n-\n-      generatedCards.push({\n-        cardNumber,\n-        cardPassword,\n-        typeName: typeInfo.name,\n-        points: typeInfo.points,\n-        price: typeInfo.price\n-      });\n-    }\n-\n-    console.log(`✅ 成功生成${count}张${typeInfo.name}`);\n-\n-    res.json({\n-      success: true,\n-      message: `成功生成${count}张${typeInfo.name}`,\n-      data: {\n-        cards: generatedCards,\n-        cardType: typeInfo.name,\n-        totalGenerated: count\n-      }\n-    });\n-\n-  } catch (error) {\n-    console.error('❌ 生成等级卡失败:', error);\n-    next(error);\n-  }\n-});\n-\n-// 生成体验卡\n-router.post('/generate-experience-cards', adminAuth, async (req, res, next) => {\n-  try {\n-    const { count = 1 } = req.body;\n-    console.log(`🎫 管理员请求生成${count}张体验卡...`);\n-\n-    // 获取体验卡类型信息 - 修复表名，遵循开发原则\n-    const cardTypeResult = await query(`\n-      SELECT id, name, points, price\n-      FROM card_types\n-      WHERE name = '体验卡'\n-    `);\n-\n-    if (cardTypeResult.length === 0) {\n-      return res.status(400).json({\n-        success: false,\n-        message: '体验卡类型不存在'\n-      });\n-    }\n-\n-    const typeInfo = cardTypeResult[0];\n-    const generatedCards = [];\n-\n-    // 批量生成体验卡\n-    for (let i = 1; i <= count; i++) {\n-      const cardNumber = generateCardNumber('体验卡', i);\n-      const cardPassword = generateCardPassword();\n-\n-      await query(`\n-        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n-        VALUES (?, ?, ?, ?, NOW())\n-      `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n-\n-      generatedCards.push({\n-        cardNumber,\n-        cardPassword,\n-        typeName: typeInfo.name,\n-        points: typeInfo.points\n-      });\n-    }\n-\n-    console.log(`✅ 成功生成${count}张体验卡`);\n-\n-    res.json({\n-      success: true,\n-      message: `成功生成${count}张体验卡`,\n-      data: {\n-        cards: generatedCards,\n-        cardType: typeInfo.name,\n-        totalGenerated: count\n-      }\n-    });\n-\n-  } catch (error) {\n-    console.error('❌ 生成体验卡失败:', error);\n-    next(error);\n-  }\n-});\n-\n-// 获取体验卡统计信息\n-router.get('/experience-cards-stats', adminAuth, async (req, res, next) => {\n-  try {\n-    // 获取体验卡统计\n-    const stats = await query(`\n-      SELECT\n-        COUNT(*) as total_cards,\n-        COUNT(CASE WHEN bound_user_id IS NULL THEN 1 END) as available_cards,\n-        COUNT(CASE WHEN bound_user_id IS NOT NULL THEN 1 END) as bound_cards,\n-        SUM(CASE WHEN bound_user_id IS NULL THEN remaining_points ELSE 0 END) as available_points,\n-        SUM(CASE WHEN bound_user_id IS NOT NULL THEN remaining_points ELSE 0 END) as bound_points\n-      FROM level_cards lc\n-      JOIN level_card_types ct ON lc.type_id = ct.id\n-      WHERE ct.name = '体验卡'\n-    `);\n-\n-    // 获取可用体验卡列表\n-    const availableCards = await getAvailableExperienceCards();\n-\n-    res.json({\n-      success: true,\n-      data: {\n-        stats: stats[0],\n-        availableCards: availableCards.slice(0, 10) // 只返回前10张作为示例\n-      }\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// 测试数据库连接（管理员用）\n-router.post('/test-database', adminAuth, async (req, res, next) => {\n-  try {\n-    // 简单的数据库连接测试\n-    await query('SELECT 1 as test');\n-\n-    res.json({\n-      success: true,\n-      message: '数据库连接测试成功'\n-    });\n-\n-  } catch (error) {\n-    console.error('❌ 数据库连接测试失败:', error);\n-    res.status(500).json({\n-      success: false,\n-      message: '数据库连接测试失败: ' + error.message\n-    });\n-  }\n-});\n-\n-// 测试ComfyUI连接（管理员用）\n-router.post('/test-comfyui', adminAuth, async (req, res, next) => {\n-  try {\n-    // 从请求体获取服务器地址，如果没有则使用默认配置\n-    let serverUrl = req.body?.serverUrl;\n-\n-    // 如果没有提供服务器地址，从数据库获取配置\n-    if (!serverUrl) {\n-      try {\n-        const [configRows] = await query(\n-          'SELECT config_value FROM system_config WHERE config_key = ?',\n-          ['comfyui.server_url']\n-        );\n-        serverUrl = configRows.length > 0 ? configRows[0].config_value : 'https://your-comfyui-server.com';\n-      } catch (dbError) {\n-        console.error('获取ComfyUI配置失败:', dbError);\n-        serverUrl = 'https://your-comfyui-server.com';\n-      }\n-    }\n-\n-    // 确保URL格式正确\n-    if (serverUrl && !serverUrl.startsWith('http')) {\n-      serverUrl = 'https://' + serverUrl;\n-    }\n-\n-    // 移除末尾的斜杠\n-    if (serverUrl && serverUrl.endsWith('/')) {\n-      serverUrl = serverUrl.slice(0, -1);\n-    }\n-\n-    console.log('🧪 测试ComfyUI连接:', serverUrl);\n-\n-    // 测试ComfyUI连接\n-    const fetch = require('node-fetch');\n-\n-    // 尝试多个端点来检测ComfyUI服务器\n-    const testEndpoints = [\n-      `${serverUrl}/system_stats`,  // ComfyUI系统状态端点\n-      `${serverUrl}/history`,       // ComfyUI历史记录端点\n-      `${serverUrl}/`,              // 根路径\n-    ];\n-\n-    let lastError = null;\n-    let response = null;\n-\n-    // 依次尝试不同的端点\n-    for (const testUrl of testEndpoints) {\n-      try {\n-        console.log(`🔍 尝试端点: ${testUrl}`);\n-\n-        response = await fetch(testUrl, {\n-          method: 'GET',\n-          timeout: 10000,\n-          headers: {\n-            'User-Agent': 'ComfyUI-Admin-Test/1.0'\n-          }\n-        });\n-\n-        console.log(`📡 端点 ${testUrl} 响应状态:`, response.status, response.statusText);\n-\n-        // 如果得到响应（即使是错误状态码），说明服务器是可达的\n-        if (response) {\n-          break;\n-        }\n-      } catch (error) {\n-        console.log(`❌ 端点 ${testUrl} 失败:`, error.message);\n-        lastError = error;\n-        continue;\n-      }\n-    }\n-\n-    // 如果所有端点都失败了\n-    if (!response) {\n-      throw lastError || new Error('所有测试端点都无法访问');\n-    }\n-\n-    if (response.status === 200) {\n-      // 服务器正常响应\n-      res.json({\n-        success: true,\n-        message: 'ComfyUI服务器连接成功',\n-        data: {\n-          serverUrl,\n-          status: 'connected',\n-          statusCode: response.status,\n-          message: '服务器可正常访问'\n-        }\n-      });\n-    } else if (response.status === 401) {\n-      // 服务器需要认证，但可以连接\n-      res.json({\n-        success: true,\n-        message: 'ComfyUI服务器连接成功（需要认证）',\n-        data: {\n-          serverUrl,\n-          status: 'connected_auth_required',\n-          statusCode: response.status,\n-          message: '服务器可访问，但需要认证'\n-        }\n-      });\n-    } else if (response.status === 404) {\n-      // 路径不存在，但服务器可达\n-      res.json({\n-        success: true,\n-        message: 'ComfyUI服务器连接成功',\n-        data: {\n-          serverUrl,\n-          status: 'connected',\n-          statusCode: response.status,\n-          message: '服务器可访问（路径不存在是正常的）'\n-        }\n-      });\n-    } else {\n-      // 其他状态码\n-      res.json({\n-        success: false,\n-        message: `ComfyUI服务器响应异常: ${response.status} ${response.statusText}`,\n-        data: {\n-          serverUrl,\n-          status: 'error',\n-          statusCode: response.status\n-        }\n-      });\n-    }\n-\n-  } catch (error) {\n-    console.error('❌ ComfyUI连接测试失败:', error);\n-\n-    if (error.code === 'ENOTFOUND') {\n-      res.status(500).json({\n-        success: false,\n-        message: 'ComfyUI服务器域名无法解析，请检查服务器地址是否正确',\n-        data: {\n-          serverUrl: serverUrl || 'unknown',\n-          status: 'dns_error',\n-          error: error.code,\n-          message: 'Domain name resolution failed'\n-        }\n-      });\n-    } else if (error.code === 'ECONNREFUSED') {\n-      res.status(500).json({\n-        success: false,\n-        message: 'ComfyUI服务器拒绝连接，请检查服务器是否运行',\n-        data: {\n-          serverUrl: serverUrl || 'unknown',\n-          status: 'connection_refused',\n-          error: error.code,\n-          message: 'Connection refused by server'\n-        }\n-      });\n-    } else if (error.name === 'AbortError' || error.message.includes('timeout')) {\n-      res.status(500).json({\n-        success: false,\n-        message: 'ComfyUI服务器连接超时，请检查网络连接',\n-        data: {\n-          serverUrl: serverUrl || 'unknown',\n-          status: 'timeout',\n-          error: 'timeout',\n-          message: 'Connection timeout'\n-        }\n-      });\n-    } else {\n-      res.status(500).json({\n-        success: false,\n-        message: 'ComfyUI连接测试失败: ' + error.message,\n-        data: {\n-          serverUrl: serverUrl || 'unknown',\n-          status: 'error',\n-          error: error.message,\n-          message: 'Unknown connection error'\n-        }\n-      });\n-    }\n-  }\n-});\n-\n-// 生成卡密函数已在文件开头定义，这里删除重复定义\n-\n-module.exports = router;\n"
                },
                {
                    "date": 1752347574386,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -498,9 +498,9 @@\n     // 获取等级卡总数\n     const countQuery = `\n       SELECT COUNT(*) as total\n       FROM level_cards lc\n-      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN card_types ct ON lc.type_id = ct.id\n       LEFT JOIN users u ON lc.bound_user_id = u.id\n       ${whereClause}\n     `;\n     const countResult = await query(countQuery, queryParams);\n"
                },
                {
                    "date": 1752347588579,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -512,9 +512,9 @@\n              lc.bound_at, lc.created_at,\n              ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n              u.username as bound_username, u.id as bound_user_id\n       FROM level_cards lc\n-      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN card_types ct ON lc.type_id = ct.id\n       LEFT JOIN users u ON lc.bound_user_id = u.id\n       ${whereClause}\n       ORDER BY lc.created_at DESC\n       LIMIT ? OFFSET ?\n"
                },
                {
                    "date": 1752347601083,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -549,9 +549,9 @@\n              lc.bound_at, lc.created_at,\n              ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n              u.username as bound_username, u.id as bound_user_id, u.email as bound_user_email\n       FROM level_cards lc\n-      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN card_types ct ON lc.type_id = ct.id\n       LEFT JOIN users u ON lc.bound_user_id = u.id\n       WHERE lc.id = ?\n     `, [cardId]);\n \n"
                },
                {
                    "date": 1752347651861,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -420,9 +420,9 @@\n       console.log('⚠️ 等级卡类型表不存在，尝试创建...');\n \n       // 创建表和初始数据\n       await query(`\n-        CREATE TABLE IF NOT EXISTS level_card_types (\n+        CREATE TABLE IF NOT EXISTS card_types (\n           id INT AUTO_INCREMENT PRIMARY KEY,\n           name VARCHAR(50) NOT NULL COMMENT '等级卡名称',\n           icon VARCHAR(10) NOT NULL COMMENT '等级卡图标',\n           price DECIMAL(10,2) NOT NULL COMMENT '价格',\n@@ -434,9 +434,9 @@\n       `);\n \n       // 插入初始数据\n       await query(`\n-        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n+        INSERT INTO card_types (name, icon, price, points, description) VALUES\n         ('体验卡', '🎁', 0.00, 20, '免费体验卡，每张20积分'),\n         ('基础卡', '🥉', 9.90, 300, '适合轻度使用的用户'),\n         ('高级卡', '🥈', 30.00, 1000, '适合中度使用的用户'),\n         ('至尊卡', '🥇', 50.00, 2000, '适合重度使用的用户')\n@@ -444,9 +444,9 @@\n \n       // 重新获取数据\n       const cardTypes = await query(`\n         SELECT id, name, icon, points, price, description\n-        FROM level_card_types\n+        FROM card_types\n         ORDER BY points ASC\n       `);\n \n       console.log('✅ 表创建成功，获取等级卡类型:', cardTypes.length, '个');\n"
                },
                {
                    "date": 1752347679931,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -314,9 +314,9 @@\n \n     // 1. 创建等级卡类型表\n     console.log('📝 创建等级卡类型表...');\n     await query(`\n-      CREATE TABLE IF NOT EXISTS level_card_types (\n+      CREATE TABLE IF NOT EXISTS card_types (\n         id INT AUTO_INCREMENT PRIMARY KEY,\n         name VARCHAR(50) NOT NULL COMMENT '等级卡名称',\n         icon VARCHAR(10) NOT NULL COMMENT '等级卡图标',\n         price DECIMAL(10,2) NOT NULL COMMENT '价格',\n"
                },
                {
                    "date": 1752347695895,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -373,12 +373,12 @@\n     `);\n     console.log('✅ 等级卡交易记录表创建成功');\n \n     // 4. 插入等级卡类型数据（包含体验卡）\n-    const existingTypes = await query('SELECT COUNT(*) as count FROM level_card_types');\n+    const existingTypes = await query('SELECT COUNT(*) as count FROM card_types');\n     if (existingTypes[0].count === 0) {\n       await query(`\n-        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n+        INSERT INTO card_types (name, icon, price, points, description) VALUES\n         ('体验卡', '🎁', 0.00, 20, '免费体验卡，每张20积分'),\n         ('基础卡', '🥉', 9.90, 300, '适合轻度使用的用户'),\n         ('高级卡', '🥈', 30.00, 1000, '适合中度使用的用户'),\n         ('至尊卡', '🥇', 50.00, 2000, '适合重度使用的用户')\n"
                },
                {
                    "date": 1752460685118,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -343,9 +343,9 @@\n         bound_at DATETIME NULL COMMENT '绑定时间',\n         expires_at DATETIME NULL COMMENT '过期时间',\n         created_at DATETIME NOT NULL,\n         updated_at DATETIME NULL,\n-        FOREIGN KEY (type_id) REFERENCES level_card_types(id),\n+        FOREIGN KEY (type_id) REFERENCES card_types(id),\n         FOREIGN KEY (bound_user_id) REFERENCES users(id),\n         INDEX idx_card_number (card_number),\n         INDEX idx_bound_user (bound_user_id),\n         INDEX idx_status (status)\n"
                },
                {
                    "date": 1752460809707,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1019,9 +1019,9 @@\n \n     // 获取卡片类型信息\n     const cardTypeResult = await query(`\n       SELECT id, name, points, price, description\n-      FROM level_card_types\n+      FROM card_types\n       WHERE id = ?\n     `, [cardTypeId]);\n \n     if (cardTypeResult.length === 0) {\n"
                },
                {
                    "date": 1752548154247,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1216,13 +1216,12 @@\n \n     // 测试ComfyUI连接\n     const fetch = require('node-fetch');\n \n-    // 尝试多个端点来检测ComfyUI服务器\n+    // 使用ComfyUI官方端点进行检测\n     const testEndpoints = [\n-      `${serverUrl}/system_stats`,  // ComfyUI系统状态端点\n-      `${serverUrl}/history`,       // ComfyUI历史记录端点\n-      `${serverUrl}/`,              // 根路径\n+      `${serverUrl}/api/queue`,        // ComfyUI官方队列端点\n+      `${serverUrl}/api/system_stats`, // ComfyUI官方系统状态端点\n     ];\n \n     let lastError = null;\n     let response = null;\n"
                },
                {
                    "date": 1752810925519,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -813,9 +813,9 @@\n       });\n     });\n \n     // 确保所有必要的分组都存在\n-    const requiredGroups = ['server', 'database', 'jwt', 'comfyui', 'ai', 'frontend', 'cors', 'upload', 'log'];\n+    const requiredGroups = ['server', 'database', 'jwt', 'comfyui', 'ai', 'frontend', 'cors', 'upload', 'log', 'workflow'];\n     requiredGroups.forEach(group => {\n       if (!groupedConfigs[group]) {\n         groupedConfigs[group] = [];\n       }\n"
                },
                {
                    "date": 1752977977111,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1042,16 +1042,8 @@\n       await query(`\n         INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n         VALUES (?, ?, ?, ?, NOW())\n       `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n-\n-      generatedCards.push({\n-        cardNumber,\n-        cardPassword,\n-        typeName: typeInfo.name,\n-        points: typeInfo.points,\n-        price: typeInfo.price\n-      });\n     }\n \n     console.log(`✅ 成功生成${count}张${typeInfo.name}`);\n \n@@ -1359,4 +1351,5 @@\n \n // 生成卡密函数已在文件开头定义，这里删除重复定义\n \n module.exports = router;\n+\n"
                },
                {
                    "date": 1752978249568,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -977,76 +977,83 @@\n \n // 生成等级卡（管理员用）\n router.post('/generate-cards', adminAuth, async (req, res, next) => {\n   try {\n+    console.log('🎫 收到生成等级卡请求，请求体:', req.body);\n+\n     const { cardTypeId, count = 5 } = req.body;\n \n     if (!cardTypeId) {\n+      console.log('❌ 缺少cardTypeId参数');\n       return res.status(400).json({\n         success: false,\n         message: '请选择等级卡类型'\n       });\n     }\n \n     if (!count || count <= 0 || count > 100) {\n+      console.log('❌ count参数无效:', count);\n       return res.status(400).json({\n         success: false,\n         message: '生成数量必须在1-100之间'\n       });\n     }\n \n     console.log(`🎫 开始生成${count}张等级卡，类型ID: ${cardTypeId}...`);\n \n-    // 确保level_cards表存在\n-    await query(`\n-      CREATE TABLE IF NOT EXISTS level_cards (\n-        id INT AUTO_INCREMENT PRIMARY KEY,\n-        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT '卡号',\n-        card_password VARCHAR(20) NOT NULL COMMENT '卡密',\n-        type_id INT NOT NULL COMMENT '等级卡类型ID',\n-        total_points INT NOT NULL COMMENT '总积分',\n-        remaining_points INT NOT NULL COMMENT '剩余积分',\n-        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT '状态',\n-        bound_user_id INT NULL COMMENT '绑定的用户ID',\n-        bound_at DATETIME NULL COMMENT '绑定时间',\n-        expires_at DATETIME NULL COMMENT '过期时间',\n-        created_at DATETIME NOT NULL,\n-        updated_at DATETIME NULL,\n-        INDEX idx_card_number (card_number),\n-        INDEX idx_bound_user (bound_user_id),\n-        INDEX idx_status (status)\n-      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-    `);\n-\n     // 获取卡片类型信息\n+    console.log('📋 查询卡片类型信息...');\n     const cardTypeResult = await query(`\n       SELECT id, name, points, price, description\n       FROM card_types\n       WHERE id = ?\n     `, [cardTypeId]);\n \n+    console.log('📋 卡片类型查询结果:', cardTypeResult);\n+\n     if (cardTypeResult.length === 0) {\n+      console.log('❌ 卡片类型不存在:', cardTypeId);\n       return res.status(400).json({\n         success: false,\n         message: '无效的卡片类型'\n       });\n     }\n \n     const typeInfo = cardTypeResult[0];\n+    console.log('✅ 找到卡片类型:', typeInfo);\n+\n     const generatedCards = [];\n \n     // 批量生成等级卡\n     for (let i = 1; i <= count; i++) {\n-      const cardNumber = generateCardNumber(typeInfo.name, i);\n-      const cardPassword = generateCardPassword();\n+      try {\n+        const cardNumber = generateCardNumber(typeInfo.name, i);\n+        const cardPassword = generateCardPassword();\n \n-      await query(`\n-        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n-        VALUES (?, ?, ?, ?, NOW())\n-      `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+        console.log(`📝 生成第${i}张卡: ${cardNumber} - ${cardPassword}`);\n+\n+        // 根据实际表结构插入数据（不包含total_points字段）\n+        await query(`\n+          INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n+          VALUES (?, ?, ?, ?, NOW())\n+        `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+\n+        generatedCards.push({\n+          cardNumber,\n+          cardPassword,\n+          typeName: typeInfo.name,\n+          points: typeInfo.points,\n+          price: typeInfo.price\n+        });\n+\n+        console.log(`✅ 第${i}张卡生成成功`);\n+      } catch (insertError) {\n+        console.error(`❌ 生成第${i}张卡失败:`, insertError);\n+        throw insertError;\n+      }\n     }\n \n-    console.log(`✅ 成功生成${count}张${typeInfo.name}`);\n+    console.log(`🎉 成功生成${count}张${typeInfo.name}`);\n \n     res.json({\n       success: true,\n       message: `成功生成${count}张${typeInfo.name}`,\n@@ -1057,10 +1064,19 @@\n       }\n     });\n \n   } catch (error) {\n-    console.error('❌ 生成等级卡失败:', error);\n-    next(error);\n+    console.error('❌ 生成等级卡失败 - 详细错误信息:');\n+    console.error('错误消息:', error.message);\n+    console.error('错误代码:', error.code);\n+    console.error('SQL状态:', error.sqlState);\n+    console.error('SQL消息:', error.sqlMessage);\n+    console.error('完整错误:', error);\n+\n+    res.status(500).json({\n+      success: false,\n+      message: '生成等级卡失败: ' + error.message\n+    });\n   }\n });\n \n // 生成体验卡\n"
                },
                {
                    "date": 1752978698411,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -399,26 +399,31 @@\n // 获取等级卡类型列表（管理员用）\n router.get('/card-types', adminAuth, async (req, res, next) => {\n   try {\n     console.log('🔍 获取等级卡类型列表...');\n+    console.log('👤 管理员信息:', req.admin);\n \n     // 首先检查表是否存在\n     try {\n+      console.log('📋 查询等级卡类型表...');\n       const cardTypes = await query(`\n         SELECT id, name, icon, points, price, description\n         FROM card_types\n         ORDER BY points ASC\n       `);\n \n       console.log('✅ 成功获取等级卡类型:', cardTypes.length, '个');\n+      console.log('📊 卡片类型数据:', cardTypes);\n+\n       res.json({\n         success: true,\n         data: {\n           cardTypes\n         }\n       });\n     } catch (tableError) {\n-      console.log('⚠️ 等级卡类型表不存在，尝试创建...');\n+      console.log('⚠️ 等级卡类型表查询失败，错误:', tableError.message);\n+      console.log('🔧 尝试创建等级卡类型表...');\n \n       // 创建表和初始数据\n       await query(`\n         CREATE TABLE IF NOT EXISTS card_types (\n@@ -431,18 +436,27 @@\n           created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n           updated_at DATETIME NULL\n         ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n       `);\n+      console.log('✅ 等级卡类型表创建成功');\n \n-      // 插入初始数据\n-      await query(`\n-        INSERT INTO card_types (name, icon, price, points, description) VALUES\n-        ('体验卡', '🎁', 0.00, 20, '免费体验卡，每张20积分'),\n-        ('基础卡', '🥉', 9.90, 300, '适合轻度使用的用户'),\n-        ('高级卡', '🥈', 30.00, 1000, '适合中度使用的用户'),\n-        ('至尊卡', '🥇', 50.00, 2000, '适合重度使用的用户')\n-      `);\n+      // 检查是否已有数据\n+      const existingData = await query(`SELECT COUNT(*) as count FROM card_types`);\n+      console.log('📊 现有数据数量:', existingData[0].count);\n \n+      if (existingData[0].count === 0) {\n+        console.log('📝 插入初始数据...');\n+        // 插入初始数据\n+        await query(`\n+          INSERT INTO card_types (name, icon, price, points, description) VALUES\n+          ('体验卡', '🎁', 0.00, 20, '免费体验卡，每张20积分'),\n+          ('基础卡', '🥉', 9.90, 300, '适合轻度使用的用户'),\n+          ('高级卡', '🥈', 30.00, 1000, '适合中度使用的用户'),\n+          ('至尊卡', '🥇', 50.00, 2000, '适合重度使用的用户')\n+        `);\n+        console.log('✅ 初始数据插入成功');\n+      }\n+\n       // 重新获取数据\n       const cardTypes = await query(`\n         SELECT id, name, icon, points, price, description\n         FROM card_types\n@@ -457,10 +471,19 @@\n         }\n       });\n     }\n   } catch (error) {\n-    console.error('❌ 获取等级卡类型失败:', error);\n-    next(error);\n+    console.error('❌ 获取等级卡类型失败 - 详细错误信息:');\n+    console.error('错误消息:', error.message);\n+    console.error('错误代码:', error.code);\n+    console.error('SQL状态:', error.sqlState);\n+    console.error('SQL消息:', error.sqlMessage);\n+    console.error('完整错误:', error);\n+\n+    res.status(500).json({\n+      success: false,\n+      message: '获取等级卡类型失败: ' + error.message\n+    });\n   }\n });\n \n // 获取所有等级卡列表（管理员用）\n"
                },
                {
                    "date": 1752979355547,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1098,8 +1098,9 @@\n     res.status(500).json({\n       success: false,\n       message: '生成等级卡失败: ' + error.message\n     });\n+    });\n   }\n });\n \n // 生成体验卡\n"
                },
                {
                    "date": 1752979382415,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1098,9 +1098,8 @@\n     res.status(500).json({\n       success: false,\n       message: '生成等级卡失败: ' + error.message\n     });\n-    });\n   }\n });\n \n // 生成体验卡\n"
                },
                {
                    "date": 1752981569662,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -405,9 +405,9 @@\n     // 首先检查表是否存在\n     try {\n       console.log('📋 查询等级卡类型表...');\n       const cardTypes = await query(`\n-        SELECT id, name, icon, points, price, description\n+        SELECT id, name, icon, points, price, created_at\n         FROM card_types\n         ORDER BY points ASC\n       `);\n \n"
                },
                {
                    "date": 1752981581290,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -457,9 +457,9 @@\n       }\n \n       // 重新获取数据\n       const cardTypes = await query(`\n-        SELECT id, name, icon, points, price, description\n+        SELECT id, name, icon, points, price, created_at\n         FROM card_types\n         ORDER BY points ASC\n       `);\n \n"
                },
                {
                    "date": 1752981595164,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1025,9 +1025,9 @@\n \n     // 获取卡片类型信息\n     console.log('📋 查询卡片类型信息...');\n     const cardTypeResult = await query(`\n-      SELECT id, name, points, price, description\n+      SELECT id, name, points, price\n       FROM card_types\n       WHERE id = ?\n     `, [cardTypeId]);\n \n"
                },
                {
                    "date": 1752981624948,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -376,13 +376,13 @@\n     // 4. 插入等级卡类型数据（包含体验卡）\n     const existingTypes = await query('SELECT COUNT(*) as count FROM card_types');\n     if (existingTypes[0].count === 0) {\n       await query(`\n-        INSERT INTO card_types (name, icon, price, points, description) VALUES\n-        ('体验卡', '🎁', 0.00, 20, '免费体验卡，每张20积分'),\n-        ('基础卡', '🥉', 9.90, 300, '适合轻度使用的用户'),\n-        ('高级卡', '🥈', 30.00, 1000, '适合中度使用的用户'),\n-        ('至尊卡', '🥇', 50.00, 2000, '适合重度使用的用户')\n+        INSERT INTO card_types (name, icon, price, points) VALUES\n+        ('体验卡', '🎁', 0.00, 20),\n+        ('基础卡', '🥉', 9.90, 300),\n+        ('高级卡', '🥈', 30.00, 1000),\n+        ('至尊卡', '🥇', 50.00, 2000)\n       `);\n     }\n \n     res.json({\n"
                },
                {
                    "date": 1752981639737,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -446,13 +446,13 @@\n       if (existingData[0].count === 0) {\n         console.log('📝 插入初始数据...');\n         // 插入初始数据\n         await query(`\n-          INSERT INTO card_types (name, icon, price, points, description) VALUES\n-          ('体验卡', '🎁', 0.00, 20, '免费体验卡，每张20积分'),\n-          ('基础卡', '🥉', 9.90, 300, '适合轻度使用的用户'),\n-          ('高级卡', '🥈', 30.00, 1000, '适合中度使用的用户'),\n-          ('至尊卡', '🥇', 50.00, 2000, '适合重度使用的用户')\n+          INSERT INTO card_types (name, icon, price, points) VALUES\n+          ('体验卡', '🎁', 0.00, 20),\n+          ('基础卡', '🥉', 9.90, 300),\n+          ('高级卡', '🥈', 30.00, 1000),\n+          ('至尊卡', '🥇', 50.00, 2000)\n         `);\n         console.log('✅ 初始数据插入成功');\n       }\n \n"
                },
                {
                    "date": 1752981656149,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -320,9 +320,8 @@\n         name VARCHAR(50) NOT NULL COMMENT '等级卡名称',\n         icon VARCHAR(10) NOT NULL COMMENT '等级卡图标',\n         price DECIMAL(10,2) NOT NULL COMMENT '价格',\n         points INT NOT NULL COMMENT '积分数量',\n-        description TEXT COMMENT '描述',\n         created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n         updated_at DATETIME NULL\n       ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n     `);\n"
                },
                {
                    "date": 1752981672300,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -430,9 +430,8 @@\n           name VARCHAR(50) NOT NULL COMMENT '等级卡名称',\n           icon VARCHAR(10) NOT NULL COMMENT '等级卡图标',\n           price DECIMAL(10,2) NOT NULL COMMENT '价格',\n           points INT NOT NULL COMMENT '积分数量',\n-          description TEXT COMMENT '描述',\n           created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n           updated_at DATETIME NULL\n         ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n       `);\n"
                },
                {
                    "date": 1752981992820,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -398,90 +398,26 @@\n // 获取等级卡类型列表（管理员用）\n router.get('/card-types', adminAuth, async (req, res, next) => {\n   try {\n     console.log('🔍 获取等级卡类型列表...');\n-    console.log('👤 管理员信息:', req.admin);\n \n-    // 首先检查表是否存在\n-    try {\n-      console.log('📋 查询等级卡类型表...');\n-      const cardTypes = await query(`\n-        SELECT id, name, icon, points, price, created_at\n-        FROM card_types\n-        ORDER BY points ASC\n-      `);\n+    const cardTypes = await query(`\n+      SELECT id, name, icon, points, price, created_at\n+      FROM card_types\n+      ORDER BY points ASC\n+    `);\n \n-      console.log('✅ 成功获取等级卡类型:', cardTypes.length, '个');\n-      console.log('📊 卡片类型数据:', cardTypes);\n+    console.log('✅ 成功获取等级卡类型:', cardTypes.length, '个');\n \n-      res.json({\n-        success: true,\n-        data: {\n-          cardTypes\n-        }\n-      });\n-    } catch (tableError) {\n-      console.log('⚠️ 等级卡类型表查询失败，错误:', tableError.message);\n-      console.log('🔧 尝试创建等级卡类型表...');\n-\n-      // 创建表和初始数据\n-      await query(`\n-        CREATE TABLE IF NOT EXISTS card_types (\n-          id INT AUTO_INCREMENT PRIMARY KEY,\n-          name VARCHAR(50) NOT NULL COMMENT '等级卡名称',\n-          icon VARCHAR(10) NOT NULL COMMENT '等级卡图标',\n-          price DECIMAL(10,2) NOT NULL COMMENT '价格',\n-          points INT NOT NULL COMMENT '积分数量',\n-          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-          updated_at DATETIME NULL\n-        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-      `);\n-      console.log('✅ 等级卡类型表创建成功');\n-\n-      // 检查是否已有数据\n-      const existingData = await query(`SELECT COUNT(*) as count FROM card_types`);\n-      console.log('📊 现有数据数量:', existingData[0].count);\n-\n-      if (existingData[0].count === 0) {\n-        console.log('📝 插入初始数据...');\n-        // 插入初始数据\n-        await query(`\n-          INSERT INTO card_types (name, icon, price, points) VALUES\n-          ('体验卡', '🎁', 0.00, 20),\n-          ('基础卡', '🥉', 9.90, 300),\n-          ('高级卡', '🥈', 30.00, 1000),\n-          ('至尊卡', '🥇', 50.00, 2000)\n-        `);\n-        console.log('✅ 初始数据插入成功');\n+    res.json({\n+      success: true,\n+      data: {\n+        cardTypes\n       }\n-\n-      // 重新获取数据\n-      const cardTypes = await query(`\n-        SELECT id, name, icon, points, price, created_at\n-        FROM card_types\n-        ORDER BY points ASC\n-      `);\n-\n-      console.log('✅ 表创建成功，获取等级卡类型:', cardTypes.length, '个');\n-      res.json({\n-        success: true,\n-        data: {\n-          cardTypes\n-        }\n-      });\n-    }\n+    });\n   } catch (error) {\n-    console.error('❌ 获取等级卡类型失败 - 详细错误信息:');\n-    console.error('错误消息:', error.message);\n-    console.error('错误代码:', error.code);\n-    console.error('SQL状态:', error.sqlState);\n-    console.error('SQL消息:', error.sqlMessage);\n-    console.error('完整错误:', error);\n-\n-    res.status(500).json({\n-      success: false,\n-      message: '获取等级卡类型失败: ' + error.message\n-    });\n+    console.error('❌ 获取等级卡类型失败:', error);\n+    next(error);\n   }\n });\n \n // 获取所有等级卡列表（管理员用）\n"
                },
                {
                    "date": 1752983581589,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -398,26 +398,90 @@\n // 获取等级卡类型列表（管理员用）\n router.get('/card-types', adminAuth, async (req, res, next) => {\n   try {\n     console.log('🔍 获取等级卡类型列表...');\n+    console.log('👤 管理员信息:', req.admin);\n \n-    const cardTypes = await query(`\n-      SELECT id, name, icon, points, price, created_at\n-      FROM card_types\n-      ORDER BY points ASC\n-    `);\n+    // 首先检查表是否存在\n+    try {\n+      console.log('📋 查询等级卡类型表...');\n+      const cardTypes = await query(`\n+        SELECT id, name, icon, points, price, created_at\n+        FROM card_types\n+        ORDER BY points ASC\n+      `);\n \n-    console.log('✅ 成功获取等级卡类型:', cardTypes.length, '个');\n+      console.log('✅ 成功获取等级卡类型:', cardTypes.length, '个');\n+      console.log('📊 卡片类型数据:', cardTypes);\n \n-    res.json({\n-      success: true,\n-      data: {\n-        cardTypes\n+      res.json({\n+        success: true,\n+        data: {\n+          cardTypes\n+        }\n+      });\n+    } catch (tableError) {\n+      console.log('⚠️ 等级卡类型表查询失败，错误:', tableError.message);\n+      console.log('🔧 尝试创建等级卡类型表...');\n+\n+      // 创建表和初始数据\n+      await query(`\n+        CREATE TABLE IF NOT EXISTS card_types (\n+          id INT AUTO_INCREMENT PRIMARY KEY,\n+          name VARCHAR(50) NOT NULL COMMENT '等级卡名称',\n+          icon VARCHAR(10) NOT NULL COMMENT '等级卡图标',\n+          price DECIMAL(10,2) NOT NULL COMMENT '价格',\n+          points INT NOT NULL COMMENT '积分数量',\n+          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+          updated_at DATETIME NULL\n+        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+      `);\n+      console.log('✅ 等级卡类型表创建成功');\n+\n+      // 检查是否已有数据\n+      const existingData = await query(`SELECT COUNT(*) as count FROM card_types`);\n+      console.log('📊 现有数据数量:', existingData[0].count);\n+\n+      if (existingData[0].count === 0) {\n+        console.log('📝 插入初始数据...');\n+        // 插入初始数据\n+        await query(`\n+          INSERT INTO card_types (name, icon, price, points) VALUES\n+          ('体验卡', '🎁', 0.00, 20),\n+          ('基础卡', '🥉', 9.90, 300),\n+          ('高级卡', '🥈', 30.00, 1000),\n+          ('至尊卡', '🥇', 50.00, 2000)\n+        `);\n+        console.log('✅ 初始数据插入成功');\n       }\n+\n+      // 重新获取数据\n+      const cardTypes = await query(`\n+        SELECT id, name, icon, points, price, created_at\n+        FROM card_types\n+        ORDER BY points ASC\n+      `);\n+\n+      console.log('✅ 表创建成功，获取等级卡类型:', cardTypes.length, '个');\n+      res.json({\n+        success: true,\n+        data: {\n+          cardTypes\n+        }\n+      });\n+    }\n+  } catch (error) {\n+    console.error('❌ 获取等级卡类型失败 - 详细错误信息:');\n+    console.error('错误消息:', error.message);\n+    console.error('错误代码:', error.code);\n+    console.error('SQL状态:', error.sqlState);\n+    console.error('SQL消息:', error.sqlMessage);\n+    console.error('完整错误:', error);\n+\n+    res.status(500).json({\n+      success: false,\n+      message: '获取等级卡类型失败: ' + error.message\n     });\n-  } catch (error) {\n-    console.error('❌ 获取等级卡类型失败:', error);\n-    next(error);\n   }\n });\n \n // 获取所有等级卡列表（管理员用）\n"
                },
                {
                    "date": 1752984862547,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -400,88 +400,61 @@\n   try {\n     console.log('🔍 获取等级卡类型列表...');\n     console.log('👤 管理员信息:', req.admin);\n \n-    // 首先检查表是否存在\n-    try {\n-      console.log('📋 查询等级卡类型表...');\n-      const cardTypes = await query(`\n-        SELECT id, name, icon, points, price, created_at\n-        FROM card_types\n-        ORDER BY points ASC\n-      `);\n+    // 确保表存在（先创建表，避免查询失败）\n+    console.log('🔧 确保等级卡类型表存在...');\n+    await query(`\n+      CREATE TABLE IF NOT EXISTS card_types (\n+        id INT AUTO_INCREMENT PRIMARY KEY,\n+        name VARCHAR(50) NOT NULL COMMENT '等级卡名称',\n+        icon VARCHAR(10) NOT NULL COMMENT '等级卡图标',\n+        price DECIMAL(10,2) NOT NULL COMMENT '价格',\n+        points INT NOT NULL COMMENT '积分数量',\n+        description TEXT COMMENT '描述',\n+        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+        updated_at DATETIME NULL\n+      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+    `);\n+    console.log('✅ 等级卡类型表确保存在');\n \n-      console.log('✅ 成功获取等级卡类型:', cardTypes.length, '个');\n-      console.log('📊 卡片类型数据:', cardTypes);\n+    // 检查是否已有数据\n+    const existingData = await query(`SELECT COUNT(*) as count FROM card_types`);\n+    console.log('📊 现有数据数量:', existingData[0].count);\n \n-      res.json({\n-        success: true,\n-        data: {\n-          cardTypes\n-        }\n-      });\n-    } catch (tableError) {\n-      console.log('⚠️ 等级卡类型表查询失败，错误:', tableError.message);\n-      console.log('🔧 尝试创建等级卡类型表...');\n-\n-      // 创建表和初始数据\n+    if (existingData[0].count === 0) {\n+      console.log('📝 插入初始数据...');\n       await query(`\n-        CREATE TABLE IF NOT EXISTS card_types (\n-          id INT AUTO_INCREMENT PRIMARY KEY,\n-          name VARCHAR(50) NOT NULL COMMENT '等级卡名称',\n-          icon VARCHAR(10) NOT NULL COMMENT '等级卡图标',\n-          price DECIMAL(10,2) NOT NULL COMMENT '价格',\n-          points INT NOT NULL COMMENT '积分数量',\n-          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-          updated_at DATETIME NULL\n-        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+        INSERT INTO card_types (name, icon, price, points, description) VALUES\n+        ('体验卡', '🎁', 0.00, 20, '免费体验卡，每张20积分'),\n+        ('基础卡', '🥉', 9.90, 300, '适合轻度使用的用户'),\n+        ('高级卡', '🥈', 30.00, 1000, '适合中度使用的用户'),\n+        ('至尊卡', '🥇', 50.00, 2000, '适合重度使用的用户')\n       `);\n-      console.log('✅ 等级卡类型表创建成功');\n+      console.log('✅ 初始数据插入成功');\n+    }\n \n-      // 检查是否已有数据\n-      const existingData = await query(`SELECT COUNT(*) as count FROM card_types`);\n-      console.log('📊 现有数据数量:', existingData[0].count);\n+    // 获取数据\n+    console.log('📋 查询等级卡类型表...');\n+    const cardTypes = await query(`\n+      SELECT id, name, icon, points, price, created_at\n+      FROM card_types\n+      ORDER BY points ASC\n+    `);\n \n-      if (existingData[0].count === 0) {\n-        console.log('📝 插入初始数据...');\n-        // 插入初始数据\n-        await query(`\n-          INSERT INTO card_types (name, icon, price, points) VALUES\n-          ('体验卡', '🎁', 0.00, 20),\n-          ('基础卡', '🥉', 9.90, 300),\n-          ('高级卡', '🥈', 30.00, 1000),\n-          ('至尊卡', '🥇', 50.00, 2000)\n-        `);\n-        console.log('✅ 初始数据插入成功');\n+    console.log('✅ 成功获取等级卡类型:', cardTypes.length, '个');\n+    console.log('📊 卡片类型数据:', cardTypes);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        cardTypes\n       }\n+    });\n \n-      // 重新获取数据\n-      const cardTypes = await query(`\n-        SELECT id, name, icon, points, price, created_at\n-        FROM card_types\n-        ORDER BY points ASC\n-      `);\n-\n-      console.log('✅ 表创建成功，获取等级卡类型:', cardTypes.length, '个');\n-      res.json({\n-        success: true,\n-        data: {\n-          cardTypes\n-        }\n-      });\n-    }\n   } catch (error) {\n-    console.error('❌ 获取等级卡类型失败 - 详细错误信息:');\n-    console.error('错误消息:', error.message);\n-    console.error('错误代码:', error.code);\n-    console.error('SQL状态:', error.sqlState);\n-    console.error('SQL消息:', error.sqlMessage);\n-    console.error('完整错误:', error);\n-\n-    res.status(500).json({\n-      success: false,\n-      message: '获取等级卡类型失败: ' + error.message\n-    });\n+    console.error('❌ 获取等级卡类型失败:', error);\n+    next(error);\n   }\n });\n \n // 获取所有等级卡列表（管理员用）\n"
                },
                {
                    "date": 1752985772529,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -422,16 +422,51 @@\n     console.log('📊 现有数据数量:', existingData[0].count);\n \n     if (existingData[0].count === 0) {\n       console.log('📝 插入初始数据...');\n-      await query(`\n-        INSERT INTO card_types (name, icon, price, points, description) VALUES\n-        ('体验卡', '🎁', 0.00, 20, '免费体验卡，每张20积分'),\n-        ('基础卡', '🥉', 9.90, 300, '适合轻度使用的用户'),\n-        ('高级卡', '🥈', 30.00, 1000, '适合中度使用的用户'),\n-        ('至尊卡', '🥇', 50.00, 2000, '适合重度使用的用户')\n-      `);\n-      console.log('✅ 初始数据插入成功');\n+\n+      // 先检查表结构，确定是否有 description 字段\n+      try {\n+        const tableStructure = await query('DESCRIBE card_types');\n+        const hasDescription = tableStructure.some(col => col.Field === 'description');\n+\n+        if (hasDescription) {\n+          // 如果有 description 字段\n+          await query(`\n+            INSERT INTO card_types (name, icon, price, points, description) VALUES\n+            ('体验卡', '🎁', 0.00, 20, '免费体验卡，每张20积分'),\n+            ('基础卡', '🥉', 9.90, 300, '适合轻度使用的用户'),\n+            ('高级卡', '🥈', 30.00, 1000, '适合中度使用的用户'),\n+            ('至尊卡', '🥇', 50.00, 2000, '适合重度使用的用户')\n+          `);\n+        } else {\n+          // 如果没有 description 字段\n+          await query(`\n+            INSERT INTO card_types (name, icon, price, points) VALUES\n+            ('体验卡', '🎁', 0.00, 20),\n+            ('基础卡', '🥉', 9.90, 300),\n+            ('高级卡', '🥈', 30.00, 1000),\n+            ('至尊卡', '🥇', 50.00, 2000)\n+          `);\n+        }\n+        console.log('✅ 初始数据插入成功');\n+      } catch (insertError) {\n+        console.error('❌ 插入初始数据失败:', insertError);\n+        // 如果插入失败，尝试不带 description 字段的插入\n+        try {\n+          await query(`\n+            INSERT INTO card_types (name, icon, price, points) VALUES\n+            ('体验卡', '🎁', 0.00, 20),\n+            ('基础卡', '🥉', 9.90, 300),\n+            ('高级卡', '🥈', 30.00, 1000),\n+            ('至尊卡', '🥇', 50.00, 2000)\n+          `);\n+          console.log('✅ 初始数据插入成功（不含description字段）');\n+        } catch (fallbackError) {\n+          console.error('❌ 备用插入也失败:', fallbackError);\n+          throw fallbackError;\n+        }\n+      }\n     }\n \n     // 获取数据\n     console.log('📋 查询等级卡类型表...');\n"
                },
                {
                    "date": 1752985803917,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1028,8 +1028,31 @@\n     }\n \n     console.log(`🎫 开始生成${count}张等级卡，类型ID: ${cardTypeId}...`);\n \n+    // 确保 level_cards 表存在\n+    console.log('🔧 确保等级卡表存在...');\n+    await query(`\n+      CREATE TABLE IF NOT EXISTS level_cards (\n+        id INT AUTO_INCREMENT PRIMARY KEY,\n+        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT '卡号',\n+        card_password VARCHAR(20) NOT NULL COMMENT '卡密',\n+        type_id INT NOT NULL COMMENT '等级卡类型ID',\n+        remaining_points INT NOT NULL COMMENT '剩余积分',\n+        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT '状态',\n+        bound_user_id INT NULL COMMENT '绑定的用户ID',\n+        bound_at DATETIME NULL COMMENT '绑定时间',\n+        expires_at DATETIME NULL COMMENT '过期时间',\n+        created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n+        updated_at DATETIME NULL ON UPDATE CURRENT_TIMESTAMP,\n+        INDEX idx_card_number (card_number),\n+        INDEX idx_bound_user (bound_user_id),\n+        INDEX idx_status (status),\n+        INDEX idx_type (type_id)\n+      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='等级卡表'\n+    `);\n+    console.log('✅ 等级卡表确保存在');\n+\n     // 获取卡片类型信息\n     console.log('📋 查询卡片类型信息...');\n     const cardTypeResult = await query(`\n       SELECT id, name, points, price\n"
                },
                {
                    "date": 1752985821514,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1082,12 +1082,12 @@\n         const cardPassword = generateCardPassword();\n \n         console.log(`📝 生成第${i}张卡: ${cardNumber} - ${cardPassword}`);\n \n-        // 根据实际表结构插入数据（不包含total_points字段）\n+        // 插入等级卡数据\n         await query(`\n-          INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n-          VALUES (?, ?, ?, ?, NOW())\n+          INSERT INTO level_cards (card_number, card_password, type_id, remaining_points)\n+          VALUES (?, ?, ?, ?)\n         `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n \n         generatedCards.push({\n           cardNumber,\n"
                },
                {
                    "date": 1752985851223,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1159,10 +1159,10 @@\n       const cardNumber = generateCardNumber('体验卡', i);\n       const cardPassword = generateCardPassword();\n \n       await query(`\n-        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n-        VALUES (?, ?, ?, ?, NOW())\n+        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points)\n+        VALUES (?, ?, ?, ?)\n       `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n \n       generatedCards.push({\n         cardNumber,\n"
                },
                {
                    "date": 1753015687250,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1082,14 +1082,51 @@\n         const cardPassword = generateCardPassword();\n \n         console.log(`📝 生成第${i}张卡: ${cardNumber} - ${cardPassword}`);\n \n-        // 插入等级卡数据\n-        await query(`\n-          INSERT INTO level_cards (card_number, card_password, type_id, remaining_points)\n-          VALUES (?, ?, ?, ?)\n-        `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+        // 插入等级卡数据 - 使用更安全的方式\n+        try {\n+          await query(`\n+            INSERT INTO level_cards (card_number, card_password, type_id, remaining_points)\n+            VALUES (?, ?, ?, ?)\n+          `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+        } catch (insertError) {\n+          console.error(`❌ 插入等级卡数据失败:`, insertError);\n \n+          // 如果插入失败，可能是表结构问题，尝试检查表结构\n+          try {\n+            const tableStructure = await query('DESCRIBE level_cards');\n+            console.log('📊 level_cards表结构:', tableStructure);\n+\n+            // 检查是否缺少某些字段，尝试不同的插入方式\n+            const hasRemainingPoints = tableStructure.some(col => col.Field === 'remaining_points');\n+            const hasTotalPoints = tableStructure.some(col => col.Field === 'total_points');\n+\n+            if (hasRemainingPoints) {\n+              // 如果有 remaining_points 字段，重试原始插入\n+              await query(`\n+                INSERT INTO level_cards (card_number, card_password, type_id, remaining_points)\n+                VALUES (?, ?, ?, ?)\n+              `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+            } else if (hasTotalPoints) {\n+              // 如果只有 total_points 字段\n+              await query(`\n+                INSERT INTO level_cards (card_number, card_password, type_id, total_points)\n+                VALUES (?, ?, ?, ?)\n+              `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+            } else {\n+              // 最基本的插入\n+              await query(`\n+                INSERT INTO level_cards (card_number, card_password, type_id)\n+                VALUES (?, ?, ?)\n+              `, [cardNumber, cardPassword, typeInfo.id]);\n+            }\n+          } catch (fallbackError) {\n+            console.error(`❌ 备用插入也失败:`, fallbackError);\n+            throw fallbackError;\n+          }\n+        }\n+\n         generatedCards.push({\n           cardNumber,\n           cardPassword,\n           typeName: typeInfo.name,\n"
                },
                {
                    "date": 1753015702520,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1053,14 +1053,31 @@\n     console.log('✅ 等级卡表确保存在');\n \n     // 获取卡片类型信息\n     console.log('📋 查询卡片类型信息...');\n-    const cardTypeResult = await query(`\n-      SELECT id, name, points, price\n-      FROM card_types\n-      WHERE id = ?\n-    `, [cardTypeId]);\n+    let cardTypeResult;\n+    try {\n+      cardTypeResult = await query(`\n+        SELECT id, name, points, price\n+        FROM card_types\n+        WHERE id = ?\n+      `, [cardTypeId]);\n+    } catch (queryError) {\n+      console.error('❌ 查询卡片类型失败:', queryError);\n \n+      // 如果查询失败，可能是字段不存在，尝试基本查询\n+      try {\n+        cardTypeResult = await query(`\n+          SELECT id, name, points, price\n+          FROM card_types\n+          WHERE id = ?\n+        `, [cardTypeId]);\n+      } catch (fallbackError) {\n+        console.error('❌ 备用查询也失败:', fallbackError);\n+        throw fallbackError;\n+      }\n+    }\n+\n     console.log('📋 卡片类型查询结果:', cardTypeResult);\n \n     if (cardTypeResult.length === 0) {\n       console.log('❌ 卡片类型不存在:', cardTypeId);\n"
                },
                {
                    "date": 1753015863184,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1006,12 +1006,15 @@\n \n // 生成等级卡（管理员用）\n router.post('/generate-cards', adminAuth, async (req, res, next) => {\n   try {\n-    console.log('🎫 收到生成等级卡请求，请求体:', req.body);\n+    console.log('🎫 收到生成等级卡请求');\n+    console.log('📋 请求体:', JSON.stringify(req.body, null, 2));\n+    console.log('👤 管理员信息:', req.admin);\n \n     const { cardTypeId, count = 5 } = req.body;\n \n+    // 参数验证\n     if (!cardTypeId) {\n       console.log('❌ 缺少cardTypeId参数');\n       return res.status(400).json({\n         success: false,\n"
                },
                {
                    "date": 1753016004924,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1044,10 +1044,10 @@\n         status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT '状态',\n         bound_user_id INT NULL COMMENT '绑定的用户ID',\n         bound_at DATETIME NULL COMMENT '绑定时间',\n         expires_at DATETIME NULL COMMENT '过期时间',\n-        created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n-        updated_at DATETIME NULL ON UPDATE CURRENT_TIMESTAMP,\n+        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+        updated_at TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,\n         INDEX idx_card_number (card_number),\n         INDEX idx_bound_user (bound_user_id),\n         INDEX idx_status (status),\n         INDEX idx_type (type_id)\n"
                },
                {
                    "date": 1753016273097,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1045,9 +1045,9 @@\n         bound_user_id INT NULL COMMENT '绑定的用户ID',\n         bound_at DATETIME NULL COMMENT '绑定时间',\n         expires_at DATETIME NULL COMMENT '过期时间',\n         created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-        updated_at TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,\n+        updated_at DATETIME NULL COMMENT '更新时间',\n         INDEX idx_card_number (card_number),\n         INDEX idx_bound_user (bound_user_id),\n         INDEX idx_status (status),\n         INDEX idx_type (type_id)\n"
                },
                {
                    "date": 1753016310014,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1105,10 +1105,10 @@\n \n         // 插入等级卡数据 - 使用更安全的方式\n         try {\n           await query(`\n-            INSERT INTO level_cards (card_number, card_password, type_id, remaining_points)\n-            VALUES (?, ?, ?, ?)\n+            INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n+            VALUES (?, ?, ?, ?, NOW())\n           `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n         } catch (insertError) {\n           console.error(`❌ 插入等级卡数据失败:`, insertError);\n \n"
                },
                {
                    "date": 1753016326048,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1123,22 +1123,22 @@\n \n             if (hasRemainingPoints) {\n               // 如果有 remaining_points 字段，重试原始插入\n               await query(`\n-                INSERT INTO level_cards (card_number, card_password, type_id, remaining_points)\n-                VALUES (?, ?, ?, ?)\n+                INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n+                VALUES (?, ?, ?, ?, NOW())\n               `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n             } else if (hasTotalPoints) {\n               // 如果只有 total_points 字段\n               await query(`\n-                INSERT INTO level_cards (card_number, card_password, type_id, total_points)\n-                VALUES (?, ?, ?, ?)\n+                INSERT INTO level_cards (card_number, card_password, type_id, total_points, created_at)\n+                VALUES (?, ?, ?, ?, NOW())\n               `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n             } else {\n               // 最基本的插入\n               await query(`\n-                INSERT INTO level_cards (card_number, card_password, type_id)\n-                VALUES (?, ?, ?)\n+                INSERT INTO level_cards (card_number, card_password, type_id, created_at)\n+                VALUES (?, ?, ?, NOW())\n               `, [cardNumber, cardPassword, typeInfo.id]);\n             }\n           } catch (fallbackError) {\n             console.error(`❌ 备用插入也失败:`, fallbackError);\n"
                },
                {
                    "date": 1753016350615,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1031,28 +1031,24 @@\n     }\n \n     console.log(`🎫 开始生成${count}张等级卡，类型ID: ${cardTypeId}...`);\n \n-    // 确保 level_cards 表存在\n+    // 确保 level_cards 表存在 - 使用简单的表结构避免MySQL版本兼容性问题\n     console.log('🔧 确保等级卡表存在...');\n     await query(`\n       CREATE TABLE IF NOT EXISTS level_cards (\n         id INT AUTO_INCREMENT PRIMARY KEY,\n-        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT '卡号',\n-        card_password VARCHAR(20) NOT NULL COMMENT '卡密',\n-        type_id INT NOT NULL COMMENT '等级卡类型ID',\n-        remaining_points INT NOT NULL COMMENT '剩余积分',\n-        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT '状态',\n-        bound_user_id INT NULL COMMENT '绑定的用户ID',\n-        bound_at DATETIME NULL COMMENT '绑定时间',\n-        expires_at DATETIME NULL COMMENT '过期时间',\n-        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-        updated_at DATETIME NULL COMMENT '更新时间',\n-        INDEX idx_card_number (card_number),\n-        INDEX idx_bound_user (bound_user_id),\n-        INDEX idx_status (status),\n-        INDEX idx_type (type_id)\n-      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='等级卡表'\n+        card_number VARCHAR(20) UNIQUE NOT NULL,\n+        card_password VARCHAR(20) NOT NULL,\n+        type_id INT NOT NULL,\n+        remaining_points INT NOT NULL,\n+        status VARCHAR(20) DEFAULT 'active',\n+        bound_user_id INT NULL,\n+        bound_at DATETIME NULL,\n+        expires_at DATETIME NULL,\n+        created_at DATETIME NULL,\n+        updated_at DATETIME NULL\n+      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4\n     `);\n     console.log('✅ 等级卡表确保存在');\n \n     // 获取卡片类型信息\n"
                },
                {
                    "date": 1753016527113,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1031,27 +1031,26 @@\n     }\n \n     console.log(`🎫 开始生成${count}张等级卡，类型ID: ${cardTypeId}...`);\n \n-    // 确保 level_cards 表存在 - 使用简单的表结构避免MySQL版本兼容性问题\n-    console.log('🔧 确保等级卡表存在...');\n-    await query(`\n-      CREATE TABLE IF NOT EXISTS level_cards (\n-        id INT AUTO_INCREMENT PRIMARY KEY,\n-        card_number VARCHAR(20) UNIQUE NOT NULL,\n-        card_password VARCHAR(20) NOT NULL,\n-        type_id INT NOT NULL,\n-        remaining_points INT NOT NULL,\n-        status VARCHAR(20) DEFAULT 'active',\n-        bound_user_id INT NULL,\n-        bound_at DATETIME NULL,\n-        expires_at DATETIME NULL,\n-        created_at DATETIME NULL,\n-        updated_at DATETIME NULL\n-      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4\n-    `);\n-    console.log('✅ 等级卡表确保存在');\n+    // 检查 level_cards 表是否存在\n+    console.log('🔧 检查等级卡表是否存在...');\n+    const tableExists = await query(\"SHOW TABLES LIKE 'level_cards'\");\n \n+    if (tableExists.length === 0) {\n+      console.log('❌ level_cards 表不存在，请先创建表');\n+      return res.status(500).json({\n+        success: false,\n+        message: 'level_cards 表不存在，请联系管理员'\n+      });\n+    }\n+\n+    console.log('✅ level_cards 表存在');\n+\n+    // 检查表结构\n+    const tableStructure = await query('DESCRIBE level_cards');\n+    console.log('📊 表结构:', tableStructure.map(col => col.Field).join(', '));\n+\n     // 获取卡片类型信息\n     console.log('📋 查询卡片类型信息...');\n     let cardTypeResult;\n     try {\n"
                },
                {
                    "date": 1753016554842,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1097,49 +1097,47 @@\n         const cardPassword = generateCardPassword();\n \n         console.log(`📝 生成第${i}张卡: ${cardNumber} - ${cardPassword}`);\n \n-        // 插入等级卡数据 - 使用更安全的方式\n+        // 插入等级卡数据 - 根据现有表结构\n         try {\n-          await query(`\n-            INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n-            VALUES (?, ?, ?, ?, NOW())\n-          `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n-        } catch (insertError) {\n-          console.error(`❌ 插入等级卡数据失败:`, insertError);\n+          // 根据表结构动态构建插入语句\n+          const hasRemainingPoints = tableStructure.some(col => col.Field === 'remaining_points');\n+          const hasTotalPoints = tableStructure.some(col => col.Field === 'total_points');\n+          const hasCreatedAt = tableStructure.some(col => col.Field === 'created_at');\n \n-          // 如果插入失败，可能是表结构问题，尝试检查表结构\n-          try {\n-            const tableStructure = await query('DESCRIBE level_cards');\n-            console.log('📊 level_cards表结构:', tableStructure);\n+          let insertSQL;\n+          let insertValues;\n \n-            // 检查是否缺少某些字段，尝试不同的插入方式\n-            const hasRemainingPoints = tableStructure.some(col => col.Field === 'remaining_points');\n-            const hasTotalPoints = tableStructure.some(col => col.Field === 'total_points');\n-\n-            if (hasRemainingPoints) {\n-              // 如果有 remaining_points 字段，重试原始插入\n-              await query(`\n-                INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n-                VALUES (?, ?, ?, ?, NOW())\n-              `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n-            } else if (hasTotalPoints) {\n-              // 如果只有 total_points 字段\n-              await query(`\n-                INSERT INTO level_cards (card_number, card_password, type_id, total_points, created_at)\n-                VALUES (?, ?, ?, ?, NOW())\n-              `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+          if (hasRemainingPoints) {\n+            if (hasCreatedAt) {\n+              insertSQL = `INSERT INTO level_cards (card_number, card_password, type_id, remaining_points) VALUES (?, ?, ?, ?)`;\n+              insertValues = [cardNumber, cardPassword, typeInfo.id, typeInfo.points];\n             } else {\n-              // 最基本的插入\n-              await query(`\n-                INSERT INTO level_cards (card_number, card_password, type_id, created_at)\n-                VALUES (?, ?, ?, NOW())\n-              `, [cardNumber, cardPassword, typeInfo.id]);\n+              insertSQL = `INSERT INTO level_cards (card_number, card_password, type_id, remaining_points) VALUES (?, ?, ?, ?)`;\n+              insertValues = [cardNumber, cardPassword, typeInfo.id, typeInfo.points];\n             }\n-          } catch (fallbackError) {\n-            console.error(`❌ 备用插入也失败:`, fallbackError);\n-            throw fallbackError;\n+          } else if (hasTotalPoints) {\n+            insertSQL = `INSERT INTO level_cards (card_number, card_password, type_id, total_points) VALUES (?, ?, ?, ?)`;\n+            insertValues = [cardNumber, cardPassword, typeInfo.id, typeInfo.points];\n+          } else {\n+            insertSQL = `INSERT INTO level_cards (card_number, card_password, type_id) VALUES (?, ?, ?)`;\n+            insertValues = [cardNumber, cardPassword, typeInfo.id];\n           }\n+\n+          console.log(`📝 执行插入SQL: ${insertSQL}`);\n+          console.log(`📝 插入参数:`, insertValues);\n+\n+          await query(insertSQL, insertValues);\n+\n+        } catch (insertError) {\n+          console.error(`❌ 插入等级卡数据失败:`, insertError);\n+          console.error('错误详情:', {\n+            message: insertError.message,\n+            code: insertError.code,\n+            sqlState: insertError.sqlState\n+          });\n+          throw insertError;\n         }\n \n         generatedCards.push({\n           cardNumber,\n"
                }
            ],
            "date": 1752319729592,
            "name": "Commit-0",
            "content": "const express = require('express');\nconst router = express.Router();\nconst { query } = require('../config/database');\nconst { createExperienceCardSystem, getAvailableExperienceCards } = require('../scripts/create-experience-cards');\nconst { adminAuth } = require('../middleware/adminAuth');\n\n// 生成卡号的辅助函数\nfunction generateCardNumber(cardType, index) {\n  const typePrefix = {\n    '基础卡': 'BC',\n    '高级卡': 'AC',\n    '至尊卡': 'PC',\n    '体验卡': 'EXP'\n  };\n\n  const prefix = typePrefix[cardType] || 'CARD';\n  const timestamp = Date.now().toString().slice(-8); // 取时间戳后8位\n  const indexStr = String(index).padStart(2, '0'); // 序号补零到2位\n\n  return `${prefix}${timestamp}${indexStr}`;\n}\n\n// 生成卡密的辅助函数\nfunction generateCardPassword() {\n  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n  let password = '';\n  for (let i = 0; i < 8; i++) {\n    password += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  return password;\n}\n\n\n\n// 获取系统统计信息\nrouter.get('/stats', adminAuth, async (req, res, next) => {\n  try {\n    // 用户统计\n    const userStats = await query(`\n      SELECT\n        COUNT(*) as total_users,\n        COUNT(CASE WHEN status = 'active' THEN 1 END) as active_users,\n        COUNT(CASE WHEN status = 'inactive' THEN 1 END) as inactive_users,\n        COUNT(CASE WHEN status = 'banned' THEN 1 END) as banned_users,\n        COUNT(CASE WHEN DATE(created_at) = CURDATE() THEN 1 END) as today_new_users\n      FROM users\n    `);\n\n    // 等级卡统计\n    const cardStats = await query(`\n      SELECT\n        COUNT(*) as total_cards,\n        COUNT(CASE WHEN bound_user_id IS NOT NULL THEN 1 END) as bound_cards,\n        COUNT(CASE WHEN bound_user_id IS NULL THEN 1 END) as available_cards,\n        SUM(remaining_points) as total_remaining_points,\n        COUNT(CASE WHEN ct.name = '体验卡' THEN 1 END) as experience_cards,\n        COUNT(CASE WHEN ct.name != '体验卡' THEN 1 END) as level_cards\n      FROM level_cards lc\n      LEFT JOIN card_types ct ON lc.type_id = ct.id\n    `);\n\n    // 积分消费统计\n    const pointsStats = await query(`\n      SELECT\n        COUNT(*) as total_transactions,\n        SUM(points_amount) as total_points_consumed,\n        COUNT(CASE WHEN DATE(created_at) = CURDATE() THEN 1 END) as today_transactions,\n        SUM(CASE WHEN DATE(created_at) = CURDATE() THEN points_amount ELSE 0 END) as today_points_consumed\n      FROM point_logs\n      WHERE action_type = 'consume'\n    `);\n\n    // 最近7天的用户注册趋势\n    const userTrend = await query(`\n      SELECT\n        DATE(created_at) as date,\n        COUNT(*) as count\n      FROM users\n      WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)\n      GROUP BY DATE(created_at)\n      ORDER BY date DESC\n    `);\n\n    // 最近7天的积分消费趋势\n    const pointsTrend = await query(`\n      SELECT\n        DATE(created_at) as date,\n        COUNT(*) as transactions,\n        SUM(points_amount) as points_consumed\n      FROM point_logs\n      WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)\n        AND action_type = 'consume'\n      GROUP BY DATE(created_at)\n      ORDER BY date DESC\n    `);\n\n    res.json({\n      success: true,\n      data: {\n        users: userStats[0],\n        cards: cardStats[0],\n        points: pointsStats[0],\n        trends: {\n          users: userTrend,\n          points: pointsTrend\n        }\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// 获取用户列表（管理员用）\nrouter.get('/users', adminAuth, async (req, res, next) => {\n  try {\n    const page = parseInt(req.query.page) || 1;\n    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n    const offset = (page - 1) * limit;\n    const status = req.query.status;\n    const search = req.query.search;\n\n    let whereClause = '';\n    let queryParams = [];\n\n    // 构建查询条件\n    const conditions = [];\n    if (status) {\n      conditions.push('status = ?');\n      queryParams.push(status);\n    }\n    if (search) {\n      conditions.push('(username LIKE ? OR email LIKE ?)');\n      queryParams.push(`%${search}%`, `%${search}%`);\n    }\n\n    if (conditions.length > 0) {\n      whereClause = 'WHERE ' + conditions.join(' AND ');\n    }\n\n    // 获取用户总数\n    const countQuery = `SELECT COUNT(*) as total FROM users ${whereClause}`;\n    const countResult = await query(countQuery, queryParams);\n    const total = countResult[0].total;\n\n    // 获取用户列表\n    const usersQuery = `\n      SELECT u.id, u.username, u.email, u.status, u.created_at, u.last_login,\n             COUNT(lc.id) as bound_cards,\n             COALESCE(SUM(lc.remaining_points), 0) as total_points\n      FROM users u\n      LEFT JOIN level_cards lc ON u.id = lc.bound_user_id\n      ${whereClause}\n      GROUP BY u.id\n      ORDER BY u.created_at DESC\n      LIMIT ? OFFSET ?\n    `;\n\n    const users = await query(usersQuery, [...queryParams, limit, offset]);\n\n    res.json({\n      success: true,\n      data: {\n        items: users,\n        total,\n        page,\n        pageSize: limit,\n        totalPages: Math.ceil(total / limit)\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// 获取用户详情（管理员用）\nrouter.get('/users/:id', adminAuth, async (req, res, next) => {\n  try {\n    const userId = req.params.id;\n\n    // 获取用户基本信息\n    const userResult = await query(`\n      SELECT id, username, email, status, created_at, updated_at, last_login\n      FROM users\n      WHERE id = ?\n    `, [userId]);\n\n    if (userResult.length === 0) {\n      return res.status(404).json({\n        success: false,\n        message: '用户不存在'\n      });\n    }\n\n    const user = userResult[0];\n\n    // 获取用户绑定的等级卡\n    const cards = await query(`\n      SELECT lc.id, lc.card_number, lc.remaining_points, lc.bound_at,\n             ct.name as type_name, ct.icon, ct.points as total_points\n      FROM level_cards lc\n      JOIN card_types ct ON lc.type_id = ct.id\n      WHERE lc.bound_user_id = ?\n      ORDER BY lc.bound_at DESC\n    `, [userId]);\n\n    // 获取用户积分消费记录\n    const pointsHistory = await query(`\n      SELECT id, action_type, points_amount, description, url, created_at\n      FROM point_logs\n      WHERE user_id = ?\n      ORDER BY created_at DESC\n      LIMIT 20\n    `, [userId]);\n\n    res.json({\n      success: true,\n      data: {\n        user,\n        cards,\n        pointsHistory,\n        summary: {\n          totalCards: cards.length,\n          totalPoints: cards.reduce((sum, card) => sum + card.remaining_points, 0),\n          totalConsumed: pointsHistory\n            .filter(log => log.action_type === 'consume')\n            .reduce((sum, log) => sum + log.points_amount, 0)\n        }\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// 更新用户状态（管理员用）\nrouter.put('/users/:id/status', adminAuth, async (req, res, next) => {\n  try {\n    const userId = req.params.id;\n    const { status } = req.body;\n\n    if (!['active', 'inactive', 'banned'].includes(status)) {\n      return res.status(400).json({\n        success: false,\n        message: '无效的用户状态'\n      });\n    }\n\n    await query(`\n      UPDATE users\n      SET status = ?, updated_at = NOW()\n      WHERE id = ?\n    `, [status, userId]);\n\n    res.json({\n      success: true,\n      message: '用户状态更新成功'\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// 封禁用户（管理员用）\nrouter.post('/users/:id/ban', adminAuth, async (req, res, next) => {\n  try {\n    const userId = req.params.id;\n\n    await query(`\n      UPDATE users\n      SET status = 'banned', updated_at = NOW()\n      WHERE id = ?\n    `, [userId]);\n\n    res.json({\n      success: true,\n      message: '用户已封禁'\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// 解封用户（管理员用）\nrouter.post('/users/:id/unban', adminAuth, async (req, res, next) => {\n  try {\n    const userId = req.params.id;\n\n    await query(`\n      UPDATE users\n      SET status = 'active', updated_at = NOW()\n      WHERE id = ?\n    `, [userId]);\n\n    res.json({\n      success: true,\n      message: '用户已解封'\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// 初始化等级卡数据库表\nrouter.post('/init-level-cards', async (req, res, next) => {\n  try {\n    console.log('🗃️ 开始创建等级卡相关数据库表...');\n\n    // 1. 创建等级卡类型表\n    console.log('📝 创建等级卡类型表...');\n    await query(`\n      CREATE TABLE IF NOT EXISTS level_card_types (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        name VARCHAR(50) NOT NULL COMMENT '等级卡名称',\n        icon VARCHAR(10) NOT NULL COMMENT '等级卡图标',\n        price DECIMAL(10,2) NOT NULL COMMENT '价格',\n        points INT NOT NULL COMMENT '积分数量',\n        description TEXT COMMENT '描述',\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at DATETIME NULL\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n    `);\n    console.log('✅ 等级卡类型表创建成功');\n\n    // 2. 创建等级卡表\n    console.log('📝 创建等级卡表...');\n    await query(`\n      CREATE TABLE IF NOT EXISTS level_cards (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT '卡号',\n        card_password VARCHAR(20) NOT NULL COMMENT '卡密',\n        type_id INT NOT NULL COMMENT '等级卡类型ID',\n        total_points INT NOT NULL COMMENT '总积分',\n        remaining_points INT NOT NULL COMMENT '剩余积分',\n        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT '状态',\n        bound_user_id INT NULL COMMENT '绑定的用户ID',\n        bound_at DATETIME NULL COMMENT '绑定时间',\n        expires_at DATETIME NULL COMMENT '过期时间',\n        created_at DATETIME NOT NULL,\n        updated_at DATETIME NULL,\n        FOREIGN KEY (type_id) REFERENCES level_card_types(id),\n        FOREIGN KEY (bound_user_id) REFERENCES users(id),\n        INDEX idx_card_number (card_number),\n        INDEX idx_bound_user (bound_user_id),\n        INDEX idx_status (status)\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n    `);\n    console.log('✅ 等级卡表创建成功');\n\n    // 3. 创建等级卡使用记录表\n    console.log('📝 创建等级卡交易记录表...');\n    await query(`\n      CREATE TABLE IF NOT EXISTS level_card_transactions (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        card_id INT NOT NULL COMMENT '等级卡ID',\n        user_id INT NOT NULL COMMENT '用户ID',\n        type ENUM('bind', 'consume') NOT NULL COMMENT '交易类型',\n        points_amount INT NOT NULL COMMENT '积分数量',\n        remaining_points INT NOT NULL COMMENT '操作后剩余积分',\n        description VARCHAR(255) COMMENT '描述',\n        created_at DATETIME NOT NULL,\n        FOREIGN KEY (card_id) REFERENCES level_cards(id),\n        FOREIGN KEY (user_id) REFERENCES users(id),\n        INDEX idx_card_user (card_id, user_id),\n        INDEX idx_created_at (created_at)\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n    `);\n    console.log('✅ 等级卡交易记录表创建成功');\n\n    // 4. 插入等级卡类型数据（包含体验卡）\n    const existingTypes = await query('SELECT COUNT(*) as count FROM level_card_types');\n    if (existingTypes[0].count === 0) {\n      await query(`\n        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n        ('体验卡', '🎁', 0.00, 20, '免费体验卡，每张20积分'),\n        ('基础卡', '🥉', 9.90, 300, '适合轻度使用的用户'),\n        ('高级卡', '🥈', 30.00, 1000, '适合中度使用的用户'),\n        ('至尊卡', '🥇', 50.00, 2000, '适合重度使用的用户')\n      `);\n    }\n\n    res.json({\n      success: true,\n      message: '等级卡数据库表创建成功'\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n\n// 获取所有等级卡列表（管理员用）\nrouter.get('/cards', adminAuth, async (req, res, next) => {\n  try {\n    const page = parseInt(req.query.page) || 1;\n    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n    const offset = (page - 1) * limit;\n    const status = req.query.status;\n    const cardType = req.query.type;\n    const search = req.query.search;\n\n    let whereClause = '';\n    let queryParams = [];\n\n    // 构建查询条件\n    const conditions = [];\n    if (status) {\n      conditions.push('lc.status = ?');\n      queryParams.push(status);\n    }\n    if (cardType) {\n      conditions.push('ct.name = ?');\n      queryParams.push(cardType);\n    }\n    if (search) {\n      conditions.push('(lc.card_number LIKE ? OR u.username LIKE ?)');\n      queryParams.push(`%${search}%`, `%${search}%`);\n    }\n\n    if (conditions.length > 0) {\n      whereClause = 'WHERE ' + conditions.join(' AND ');\n    }\n\n    // 获取等级卡总数\n    const countQuery = `\n      SELECT COUNT(*) as total\n      FROM level_cards lc\n      LEFT JOIN card_types ct ON lc.type_id = ct.id\n      LEFT JOIN users u ON lc.bound_user_id = u.id\n      ${whereClause}\n    `;\n    const countResult = await query(countQuery, queryParams);\n    const total = countResult[0].total;\n\n    // 获取等级卡列表\n    const cardsQuery = `\n      SELECT lc.id, lc.card_number, lc.card_password, lc.remaining_points,\n             lc.bound_at, lc.created_at,\n             ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n             u.username as bound_username, u.id as bound_user_id\n      FROM level_cards lc\n      LEFT JOIN card_types ct ON lc.type_id = ct.id\n      LEFT JOIN users u ON lc.bound_user_id = u.id\n      ${whereClause}\n      ORDER BY lc.created_at DESC\n      LIMIT ? OFFSET ?\n    `;\n\n    const cards = await query(cardsQuery, [...queryParams, limit, offset]);\n\n    res.json({\n      success: true,\n      data: {\n        items: cards,\n        total,\n        page,\n        pageSize: limit,\n        totalPages: Math.ceil(total / limit)\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// 获取等级卡详情（管理员用）\nrouter.get('/cards/:id', adminAuth, async (req, res, next) => {\n  try {\n    const cardId = req.params.id;\n\n    // 获取等级卡基本信息\n    const cardResult = await query(`\n      SELECT lc.id, lc.card_number, lc.card_password, lc.remaining_points,\n             lc.bound_at, lc.created_at,\n             ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n             u.username as bound_username, u.id as bound_user_id, u.email as bound_user_email\n      FROM level_cards lc\n      LEFT JOIN card_types ct ON lc.type_id = ct.id\n      LEFT JOIN users u ON lc.bound_user_id = u.id\n      WHERE lc.id = ?\n    `, [cardId]);\n\n    if (cardResult.length === 0) {\n      return res.status(404).json({\n        success: false,\n        message: '等级卡不存在'\n      });\n    }\n\n    const card = cardResult[0];\n\n    // 获取该卡的使用记录\n    const usageHistory = await query(`\n      SELECT id, action_type, points_amount, description, url, created_at\n      FROM point_logs\n      WHERE user_id = ? AND description LIKE '%${card.card_number}%'\n      ORDER BY created_at DESC\n      LIMIT 20\n    `, [card.bound_user_id]);\n\n    res.json({\n      success: true,\n      data: {\n        card,\n        usageHistory,\n        summary: {\n          totalUsed: card.total_points - card.remaining_points,\n          usageCount: usageHistory.filter(log => log.action_type === 'consume').length\n        }\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// 禁用/启用等级卡（管理员用）\nrouter.put('/cards/:id/status', adminAuth, async (req, res, next) => {\n  try {\n    const cardId = req.params.id;\n    const { status } = req.body;\n\n    if (!['active', 'disabled', 'expired'].includes(status)) {\n      return res.status(400).json({\n        success: false,\n        message: '无效的等级卡状态'\n      });\n    }\n\n    await query(`\n      UPDATE level_cards\n      SET status = ?, updated_at = NOW()\n      WHERE id = ?\n    `, [status, cardId]);\n\n    res.json({\n      success: true,\n      message: '等级卡状态更新成功'\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// 解绑等级卡（管理员用）\nrouter.put('/cards/:id/unbind', adminAuth, async (req, res, next) => {\n  try {\n    const cardId = req.params.id;\n\n    await query(`\n      UPDATE level_cards\n      SET bound_user_id = NULL, bound_at = NULL\n      WHERE id = ?\n    `, [cardId]);\n\n    res.json({\n      success: true,\n      message: '等级卡解绑成功'\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// 获取积分记录列表（管理员用）- 兼容新前端路径\nrouter.get('/points-logs', adminAuth, async (req, res, next) => {\n  try {\n    const page = parseInt(req.query.page) || 1;\n    const pageSize = parseInt(req.query.pageSize) || 20;\n    const offset = (page - 1) * pageSize;\n    const actionType = req.query.type;\n    const search = req.query.search;\n\n    let whereClause = '';\n    let queryParams = [];\n\n    // 构建查询条件\n    const conditions = [];\n    if (actionType) {\n      conditions.push('pl.action_type = ?');\n      queryParams.push(actionType);\n    }\n    if (search) {\n      conditions.push('u.username LIKE ?');\n      queryParams.push(`%${search}%`);\n    }\n\n    if (conditions.length > 0) {\n      whereClause = 'WHERE ' + conditions.join(' AND ');\n    }\n\n    // 获取积分记录总数\n    const countQuery = `\n      SELECT COUNT(*) as total\n      FROM point_logs pl\n      LEFT JOIN users u ON pl.user_id = u.id\n      ${whereClause}\n    `;\n    const countResult = await query(countQuery, queryParams);\n    const total = countResult[0].total;\n\n    // 获取积分记录列表\n    const pointsQuery = `\n      SELECT pl.id, pl.action_type, pl.points_amount, pl.description, pl.url, pl.created_at,\n             u.username, u.id as user_id\n      FROM point_logs pl\n      LEFT JOIN users u ON pl.user_id = u.id\n      ${whereClause}\n      ORDER BY pl.created_at DESC\n      LIMIT ? OFFSET ?\n    `;\n\n    const pointsLogs = await query(pointsQuery, [...queryParams, pageSize, offset]);\n\n    res.json({\n      success: true,\n      data: {\n        items: pointsLogs,\n        total,\n        page,\n        pageSize,\n        totalPages: Math.ceil(total / pageSize)\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// 获取积分记录列表（管理员用）- 保持原有接口兼容性\nrouter.get('/points', adminAuth, async (req, res, next) => {\n  try {\n    const page = parseInt(req.query.page) || 1;\n    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n    const offset = (page - 1) * limit;\n    const actionType = req.query.type;\n    const search = req.query.search;\n\n    let whereClause = '';\n    let queryParams = [];\n\n    // 构建查询条件\n    const conditions = [];\n    if (actionType) {\n      conditions.push('pl.action_type = ?');\n      queryParams.push(actionType);\n    }\n    if (search) {\n      conditions.push('u.username LIKE ?');\n      queryParams.push(`%${search}%`);\n    }\n\n    if (conditions.length > 0) {\n      whereClause = 'WHERE ' + conditions.join(' AND ');\n    }\n\n    // 获取积分记录总数\n    const countQuery = `\n      SELECT COUNT(*) as total\n      FROM point_logs pl\n      LEFT JOIN users u ON pl.user_id = u.id\n      ${whereClause}\n    `;\n    const countResult = await query(countQuery, queryParams);\n    const total = countResult[0].total;\n\n    // 获取积分记录列表\n    const pointsQuery = `\n      SELECT pl.id, pl.action_type, pl.points_amount, pl.description, pl.url, pl.created_at,\n             u.username, u.id as user_id\n      FROM point_logs pl\n      LEFT JOIN users u ON pl.user_id = u.id\n      ${whereClause}\n      ORDER BY pl.created_at DESC\n      LIMIT ? OFFSET ?\n    `;\n\n    const pointsLogs = await query(pointsQuery, [...queryParams, limit, offset]);\n\n    res.json({\n      success: true,\n      data: {\n        items: pointsLogs,\n        total,\n        page,\n        pageSize: limit,\n        totalPages: Math.ceil(total / limit)\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// 获取系统配置信息（管理员用）\nrouter.get('/config', adminAuth, async (req, res, next) => {\n  try {\n    console.log('📥 从数据库加载系统配置...');\n\n    // 从数据库获取所有配置\n    const configs = await query(`\n      SELECT config_key, config_value, config_type, config_group, description, is_encrypted\n      FROM system_config\n      ORDER BY config_group, config_key\n    `);\n\n    console.log(`📊 从数据库加载了${configs.length}项配置`);\n\n    // 按分组组织配置\n    const groupedConfigs = {};\n    configs.forEach(config => {\n      const group = config.config_group || 'general';\n\n      if (!groupedConfigs[group]) {\n        groupedConfigs[group] = [];\n      }\n\n      // 处理敏感配置显示\n      let displayValue = config.config_value;\n      if (config.is_encrypted && config.config_value) {\n        // 对于敏感配置，显示掩码\n        if (config.config_key.includes('password') || config.config_key.includes('secret')) {\n          displayValue = '***';\n        }\n      }\n\n      groupedConfigs[group].push({\n        config_key: config.config_key,\n        config_value: displayValue,\n        config_type: config.config_type || 'string',\n        description: config.description || '',\n        is_encrypted: config.is_encrypted || 0\n      });\n    });\n\n    // 确保所有必要的分组都存在\n    const requiredGroups = ['server', 'database', 'jwt', 'comfyui', 'ai', 'frontend', 'cors', 'upload', 'log'];\n    requiredGroups.forEach(group => {\n      if (!groupedConfigs[group]) {\n        groupedConfigs[group] = [];\n      }\n    });\n\n    console.log('📋 配置分组统计:');\n    Object.keys(groupedConfigs).forEach(group => {\n      console.log(`   ${group}: ${groupedConfigs[group].length} 项配置`);\n    });\n\n    res.json({\n      success: true,\n      data: groupedConfigs\n    });\n\n  } catch (error) {\n    console.error('❌ 加载配置失败:', error);\n    res.status(500).json({\n      success: false,\n      message: '加载配置失败: ' + error.message\n    });\n  }\n});\n\n// 保存系统配置（管理员用）\nrouter.post('/config', adminAuth, async (req, res, next) => {\n  try {\n    const { configs } = req.body;\n\n    if (!configs || !Array.isArray(configs)) {\n      return res.status(400).json({\n        success: false,\n        message: '配置数据格式错误'\n      });\n    }\n\n    console.log('💾 保存系统配置到数据库，共', configs.length, '项');\n\n    // 真正保存配置到数据库\n    const results = [];\n    let successCount = 0;\n    let errorCount = 0;\n\n    for (const config of configs) {\n      const { config_key, config_value } = config;\n\n      try {\n        // 更新数据库中的配置\n        const result = await query(`\n          UPDATE system_config\n          SET config_value = ?, updated_at = NOW()\n          WHERE config_key = ?\n        `, [config_value, config_key]);\n\n        if (result.affectedRows > 0) {\n          console.log(`  ✅ 保存成功: ${config_key} = ${config_value}`);\n          results.push({\n            config_key,\n            updated: true,\n            message: '更新成功'\n          });\n          successCount++;\n        } else {\n          // 如果没有找到配置项，尝试插入新的\n          try {\n            await query(`\n              INSERT INTO system_config (config_key, config_value, config_type, config_group, description)\n              VALUES (?, ?, 'string', 'custom', '用户自定义配置')\n            `, [config_key, config_value]);\n\n            console.log(`  ✅ 新增成功: ${config_key} = ${config_value}`);\n            results.push({\n              config_key,\n              updated: true,\n              message: '新增成功'\n            });\n            successCount++;\n          } catch (insertError) {\n            console.log(`  ❌ 新增失败: ${config_key} - ${insertError.message}`);\n            results.push({\n              config_key,\n              updated: false,\n              message: '新增失败: ' + insertError.message\n            });\n            errorCount++;\n          }\n        }\n      } catch (updateError) {\n        console.log(`  ❌ 更新失败: ${config_key} - ${updateError.message}`);\n        results.push({\n          config_key,\n          updated: false,\n          message: '更新失败: ' + updateError.message\n        });\n        errorCount++;\n      }\n    }\n\n    const message = `配置保存完成: ${successCount}项成功, ${errorCount}项失败`;\n    console.log('📊', message);\n\n    res.json({\n      success: errorCount === 0,\n      message: message,\n      data: {\n        results,\n        summary: {\n          total: configs.length,\n          success: successCount,\n          error: errorCount\n        }\n      }\n    });\n\n  } catch (error) {\n    console.error('❌ 保存配置失败:', error);\n    res.status(500).json({\n      success: false,\n      message: '保存配置失败: ' + error.message\n    });\n  }\n});\n\n// 批量操作用户状态（管理员用）\nrouter.put('/users/batch-status', adminAuth, async (req, res, next) => {\n  try {\n    const { userIds, status } = req.body;\n\n    if (!Array.isArray(userIds) || userIds.length === 0) {\n      return res.status(400).json({\n        success: false,\n        message: '请提供有效的用户ID列表'\n      });\n    }\n\n    if (!['active', 'inactive', 'banned'].includes(status)) {\n      return res.status(400).json({\n        success: false,\n        message: '无效的用户状态'\n      });\n    }\n\n    const placeholders = userIds.map(() => '?').join(',');\n    await query(`\n      UPDATE users\n      SET status = ?, updated_at = NOW()\n      WHERE id IN (${placeholders})\n    `, [status, ...userIds]);\n\n    res.json({\n      success: true,\n      message: `成功更新${userIds.length}个用户的状态`\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// 生成等级卡（管理员用）\nrouter.post('/generate-cards', adminAuth, async (req, res, next) => {\n  try {\n    const { cardType = '基础卡', count = 5 } = req.body;\n\n    console.log(`🎫 开始生成${count}张${cardType}...`);\n\n    // 获取卡片类型信息 - 修复表名，遵循开发原则\n    const cardTypeResult = await query(`\n      SELECT id, name, points, price\n      FROM level_card_types\n      WHERE name = ?\n    `, [cardType]);\n\n    if (cardTypeResult.length === 0) {\n      return res.status(400).json({\n        success: false,\n        message: '无效的卡片类型'\n      });\n    }\n\n    const typeInfo = cardTypeResult[0];\n    const generatedCards = [];\n\n    // 批量生成等级卡\n    for (let i = 1; i <= count; i++) {\n      const cardNumber = generateCardNumber(cardType, i);\n      const cardPassword = generateCardPassword();\n\n      await query(`\n        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n        VALUES (?, ?, ?, ?, NOW())\n      `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n\n      generatedCards.push({\n        cardNumber,\n        cardPassword,\n        typeName: typeInfo.name,\n        points: typeInfo.points\n      });\n    }\n\n    console.log(`✅ 成功生成${count}张${cardType}`);\n\n    res.json({\n      success: true,\n      message: `成功生成${count}张${cardType}`,\n      data: {\n        cards: generatedCards,\n        cardType: typeInfo.name,\n        totalGenerated: count\n      }\n    });\n\n  } catch (error) {\n    console.error('❌ 生成等级卡失败:', error);\n    next(error);\n  }\n});\n\n// 生成体验卡\nrouter.post('/generate-experience-cards', adminAuth, async (req, res, next) => {\n  try {\n    const { count = 1 } = req.body;\n    console.log(`🎫 管理员请求生成${count}张体验卡...`);\n\n    // 获取体验卡类型信息 - 修复表名，遵循开发原则\n    const cardTypeResult = await query(`\n      SELECT id, name, points, price\n      FROM level_card_types\n      WHERE name = '体验卡'\n    `);\n\n    if (cardTypeResult.length === 0) {\n      return res.status(400).json({\n        success: false,\n        message: '体验卡类型不存在'\n      });\n    }\n\n    const typeInfo = cardTypeResult[0];\n    const generatedCards = [];\n\n    // 批量生成体验卡\n    for (let i = 1; i <= count; i++) {\n      const cardNumber = generateCardNumber('体验卡', i);\n      const cardPassword = generateCardPassword();\n\n      await query(`\n        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n        VALUES (?, ?, ?, ?, NOW())\n      `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n\n      generatedCards.push({\n        cardNumber,\n        cardPassword,\n        typeName: typeInfo.name,\n        points: typeInfo.points\n      });\n    }\n\n    console.log(`✅ 成功生成${count}张体验卡`);\n\n    res.json({\n      success: true,\n      message: `成功生成${count}张体验卡`,\n      data: {\n        cards: generatedCards,\n        cardType: typeInfo.name,\n        totalGenerated: count\n      }\n    });\n\n  } catch (error) {\n    console.error('❌ 生成体验卡失败:', error);\n    next(error);\n  }\n});\n\n// 获取体验卡统计信息\nrouter.get('/experience-cards-stats', adminAuth, async (req, res, next) => {\n  try {\n    // 获取体验卡统计\n    const stats = await query(`\n      SELECT\n        COUNT(*) as total_cards,\n        COUNT(CASE WHEN bound_user_id IS NULL THEN 1 END) as available_cards,\n        COUNT(CASE WHEN bound_user_id IS NOT NULL THEN 1 END) as bound_cards,\n        SUM(CASE WHEN bound_user_id IS NULL THEN remaining_points ELSE 0 END) as available_points,\n        SUM(CASE WHEN bound_user_id IS NOT NULL THEN remaining_points ELSE 0 END) as bound_points\n      FROM level_cards lc\n      JOIN card_types ct ON lc.type_id = ct.id\n      WHERE ct.name = '体验卡'\n    `);\n\n    // 获取可用体验卡列表\n    const availableCards = await getAvailableExperienceCards();\n\n    res.json({\n      success: true,\n      data: {\n        stats: stats[0],\n        availableCards: availableCards.slice(0, 10) // 只返回前10张作为示例\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// 测试数据库连接（管理员用）\nrouter.post('/test-database', adminAuth, async (req, res, next) => {\n  try {\n    // 简单的数据库连接测试\n    await query('SELECT 1 as test');\n\n    res.json({\n      success: true,\n      message: '数据库连接测试成功'\n    });\n\n  } catch (error) {\n    console.error('❌ 数据库连接测试失败:', error);\n    res.status(500).json({\n      success: false,\n      message: '数据库连接测试失败: ' + error.message\n    });\n  }\n});\n\n// 测试ComfyUI连接（管理员用）\nrouter.post('/test-comfyui', adminAuth, async (req, res, next) => {\n  try {\n    // 从请求体获取服务器地址，如果没有则使用默认配置\n    let serverUrl = req.body?.serverUrl;\n\n    // 如果没有提供服务器地址，从数据库获取配置\n    if (!serverUrl) {\n      try {\n        const [configRows] = await query(\n          'SELECT config_value FROM system_config WHERE config_key = ?',\n          ['comfyui.server_url']\n        );\n        serverUrl = configRows.length > 0 ? configRows[0].config_value : 'https://your-comfyui-server.com';\n      } catch (dbError) {\n        console.error('获取ComfyUI配置失败:', dbError);\n        serverUrl = 'https://your-comfyui-server.com';\n      }\n    }\n\n    // 确保URL格式正确\n    if (serverUrl && !serverUrl.startsWith('http')) {\n      serverUrl = 'https://' + serverUrl;\n    }\n\n    // 移除末尾的斜杠\n    if (serverUrl && serverUrl.endsWith('/')) {\n      serverUrl = serverUrl.slice(0, -1);\n    }\n\n    console.log('🧪 测试ComfyUI连接:', serverUrl);\n\n    // 测试ComfyUI连接\n    const fetch = require('node-fetch');\n\n    // 尝试多个端点来检测ComfyUI服务器\n    const testEndpoints = [\n      `${serverUrl}/system_stats`,  // ComfyUI系统状态端点\n      `${serverUrl}/history`,       // ComfyUI历史记录端点\n      `${serverUrl}/`,              // 根路径\n    ];\n\n    let lastError = null;\n    let response = null;\n\n    // 依次尝试不同的端点\n    for (const testUrl of testEndpoints) {\n      try {\n        console.log(`🔍 尝试端点: ${testUrl}`);\n\n        response = await fetch(testUrl, {\n          method: 'GET',\n          timeout: 10000,\n          headers: {\n            'User-Agent': 'ComfyUI-Admin-Test/1.0'\n          }\n        });\n\n        console.log(`📡 端点 ${testUrl} 响应状态:`, response.status, response.statusText);\n\n        // 如果得到响应（即使是错误状态码），说明服务器是可达的\n        if (response) {\n          break;\n        }\n      } catch (error) {\n        console.log(`❌ 端点 ${testUrl} 失败:`, error.message);\n        lastError = error;\n        continue;\n      }\n    }\n\n    // 如果所有端点都失败了\n    if (!response) {\n      throw lastError || new Error('所有测试端点都无法访问');\n    }\n\n    if (response.status === 200) {\n      // 服务器正常响应\n      res.json({\n        success: true,\n        message: 'ComfyUI服务器连接成功',\n        data: {\n          serverUrl,\n          status: 'connected',\n          statusCode: response.status,\n          message: '服务器可正常访问'\n        }\n      });\n    } else if (response.status === 401) {\n      // 服务器需要认证，但可以连接\n      res.json({\n        success: true,\n        message: 'ComfyUI服务器连接成功（需要认证）',\n        data: {\n          serverUrl,\n          status: 'connected_auth_required',\n          statusCode: response.status,\n          message: '服务器可访问，但需要认证'\n        }\n      });\n    } else if (response.status === 404) {\n      // 路径不存在，但服务器可达\n      res.json({\n        success: true,\n        message: 'ComfyUI服务器连接成功',\n        data: {\n          serverUrl,\n          status: 'connected',\n          statusCode: response.status,\n          message: '服务器可访问（路径不存在是正常的）'\n        }\n      });\n    } else {\n      // 其他状态码\n      res.json({\n        success: false,\n        message: `ComfyUI服务器响应异常: ${response.status} ${response.statusText}`,\n        data: {\n          serverUrl,\n          status: 'error',\n          statusCode: response.status\n        }\n      });\n    }\n\n  } catch (error) {\n    console.error('❌ ComfyUI连接测试失败:', error);\n\n    if (error.code === 'ENOTFOUND') {\n      res.status(500).json({\n        success: false,\n        message: 'ComfyUI服务器域名无法解析，请检查服务器地址是否正确',\n        data: {\n          serverUrl: serverUrl || 'unknown',\n          status: 'dns_error',\n          error: error.code,\n          message: 'Domain name resolution failed'\n        }\n      });\n    } else if (error.code === 'ECONNREFUSED') {\n      res.status(500).json({\n        success: false,\n        message: 'ComfyUI服务器拒绝连接，请检查服务器是否运行',\n        data: {\n          serverUrl: serverUrl || 'unknown',\n          status: 'connection_refused',\n          error: error.code,\n          message: 'Connection refused by server'\n        }\n      });\n    } else if (error.name === 'AbortError' || error.message.includes('timeout')) {\n      res.status(500).json({\n        success: false,\n        message: 'ComfyUI服务器连接超时，请检查网络连接',\n        data: {\n          serverUrl: serverUrl || 'unknown',\n          status: 'timeout',\n          error: 'timeout',\n          message: 'Connection timeout'\n        }\n      });\n    } else {\n      res.status(500).json({\n        success: false,\n        message: 'ComfyUI连接测试失败: ' + error.message,\n        data: {\n          serverUrl: serverUrl || 'unknown',\n          status: 'error',\n          error: error.message,\n          message: 'Unknown connection error'\n        }\n      });\n    }\n  }\n});\n\n// 生成卡密函数已在文件开头定义，这里删除重复定义\n\nmodule.exports = router;\n"
        }
    ]
}