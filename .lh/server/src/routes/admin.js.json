{
    "sourceFile": "server/src/routes/admin.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 50,
            "patches": [
                {
                    "date": 1752319729592,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752319759982,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -537,9 +537,9 @@\n     }\n \n     await query(`\n       UPDATE level_cards\n-      SET status = ?, updated_at = NOW()\n+      SET status = ?\n       WHERE id = ?\n     `, [status, cardId]);\n \n     res.json({\n"
                },
                {
                    "date": 1752321842325,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -395,8 +395,28 @@\n   }\n });\n \n \n+// è·å–ç­‰çº§å¡ç±»å‹åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n+router.get('/card-types', adminAuth, async (req, res, next) => {\n+  try {\n+    const cardTypes = await query(`\n+      SELECT id, name, icon, points, price, description\n+      FROM level_card_types\n+      ORDER BY points ASC\n+    `);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        cardTypes\n+      }\n+    });\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n // è·å–æ‰€æœ‰ç­‰çº§å¡åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n router.get('/cards', adminAuth, async (req, res, next) => {\n   try {\n     const page = parseInt(req.query.page) || 1;\n"
                },
                {
                    "date": 1752321870041,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -930,18 +930,32 @@\n \n // ç”Ÿæˆç­‰çº§å¡ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n router.post('/generate-cards', adminAuth, async (req, res, next) => {\n   try {\n-    const { cardType = 'åŸºç¡€å¡', count = 5 } = req.body;\n+    const { cardTypeId, count = 5 } = req.body;\n \n-    console.log(`ğŸ« å¼€å§‹ç”Ÿæˆ${count}å¼ ${cardType}...`);\n+    if (!cardTypeId) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'è¯·é€‰æ‹©ç­‰çº§å¡ç±»å‹'\n+      });\n+    }\n \n-    // è·å–å¡ç‰‡ç±»å‹ä¿¡æ¯ - ä¿®å¤è¡¨åï¼Œéµå¾ªå¼€å‘åŸåˆ™\n+    if (!count || count <= 0 || count > 100) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'ç”Ÿæˆæ•°é‡å¿…é¡»åœ¨1-100ä¹‹é—´'\n+      });\n+    }\n+\n+    console.log(`ğŸ« å¼€å§‹ç”Ÿæˆ${count}å¼ ç­‰çº§å¡ï¼Œç±»å‹ID: ${cardTypeId}...`);\n+\n+    // è·å–å¡ç‰‡ç±»å‹ä¿¡æ¯\n     const cardTypeResult = await query(`\n-      SELECT id, name, points, price\n+      SELECT id, name, points, price, description\n       FROM level_card_types\n-      WHERE name = ?\n-    `, [cardType]);\n+      WHERE id = ?\n+    `, [cardTypeId]);\n \n     if (cardTypeResult.length === 0) {\n       return res.status(400).json({\n         success: false,\n@@ -953,9 +967,9 @@\n     const generatedCards = [];\n \n     // æ‰¹é‡ç”Ÿæˆç­‰çº§å¡\n     for (let i = 1; i <= count; i++) {\n-      const cardNumber = generateCardNumber(cardType, i);\n+      const cardNumber = generateCardNumber(typeInfo.name, i);\n       const cardPassword = generateCardPassword();\n \n       await query(`\n         INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n@@ -965,17 +979,18 @@\n       generatedCards.push({\n         cardNumber,\n         cardPassword,\n         typeName: typeInfo.name,\n-        points: typeInfo.points\n+        points: typeInfo.points,\n+        price: typeInfo.price\n       });\n     }\n \n-    console.log(`âœ… æˆåŠŸç”Ÿæˆ${count}å¼ ${cardType}`);\n+    console.log(`âœ… æˆåŠŸç”Ÿæˆ${count}å¼ ${typeInfo.name}`);\n \n     res.json({\n       success: true,\n-      message: `æˆåŠŸç”Ÿæˆ${count}å¼ ${cardType}`,\n+      message: `æˆåŠŸç”Ÿæˆ${count}å¼ ${typeInfo.name}`,\n       data: {\n         cards: generatedCards,\n         cardType: typeInfo.name,\n         totalGenerated: count\n"
                },
                {
                    "date": 1752322059169,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -451,9 +451,9 @@\n     // è·å–ç­‰çº§å¡æ€»æ•°\n     const countQuery = `\n       SELECT COUNT(*) as total\n       FROM level_cards lc\n-      LEFT JOIN card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n       LEFT JOIN users u ON lc.bound_user_id = u.id\n       ${whereClause}\n     `;\n     const countResult = await query(countQuery, queryParams);\n@@ -465,9 +465,9 @@\n              lc.bound_at, lc.created_at,\n              ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n              u.username as bound_username, u.id as bound_user_id\n       FROM level_cards lc\n-      LEFT JOIN card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n       LEFT JOIN users u ON lc.bound_user_id = u.id\n       ${whereClause}\n       ORDER BY lc.created_at DESC\n       LIMIT ? OFFSET ?\n"
                },
                {
                    "date": 1752322076238,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -502,9 +502,9 @@\n              lc.bound_at, lc.created_at,\n              ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n              u.username as bound_username, u.id as bound_user_id, u.email as bound_user_email\n       FROM level_cards lc\n-      LEFT JOIN card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n       LEFT JOIN users u ON lc.bound_user_id = u.id\n       WHERE lc.id = ?\n     `, [cardId]);\n \n"
                },
                {
                    "date": 1752322101126,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1073,9 +1073,9 @@\n         COUNT(CASE WHEN bound_user_id IS NOT NULL THEN 1 END) as bound_cards,\n         SUM(CASE WHEN bound_user_id IS NULL THEN remaining_points ELSE 0 END) as available_points,\n         SUM(CASE WHEN bound_user_id IS NOT NULL THEN remaining_points ELSE 0 END) as bound_points\n       FROM level_cards lc\n-      JOIN card_types ct ON lc.type_id = ct.id\n+      JOIN level_card_types ct ON lc.type_id = ct.id\n       WHERE ct.name = 'ä½“éªŒå¡'\n     `);\n \n     // è·å–å¯ç”¨ä½“éªŒå¡åˆ—è¡¨\n"
                },
                {
                    "date": 1752322614000,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -398,21 +398,68 @@\n \n // è·å–ç­‰çº§å¡ç±»å‹åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n router.get('/card-types', adminAuth, async (req, res, next) => {\n   try {\n-    const cardTypes = await query(`\n-      SELECT id, name, icon, points, price, description\n-      FROM level_card_types\n-      ORDER BY points ASC\n-    `);\n+    console.log('ğŸ” è·å–ç­‰çº§å¡ç±»å‹åˆ—è¡¨...');\n \n-    res.json({\n-      success: true,\n-      data: {\n-        cardTypes\n-      }\n-    });\n+    // é¦–å…ˆæ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨\n+    try {\n+      const cardTypes = await query(`\n+        SELECT id, name, icon, points, price, description\n+        FROM level_card_types\n+        ORDER BY points ASC\n+      `);\n+\n+      console.log('âœ… æˆåŠŸè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n+      res.json({\n+        success: true,\n+        data: {\n+          cardTypes\n+        }\n+      });\n+    } catch (tableError) {\n+      console.log('âš ï¸ ç­‰çº§å¡ç±»å‹è¡¨ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º...');\n+\n+      // åˆ›å»ºè¡¨å’Œåˆå§‹æ•°æ®\n+      await query(`\n+        CREATE TABLE IF NOT EXISTS level_card_types (\n+          id INT AUTO_INCREMENT PRIMARY KEY,\n+          name VARCHAR(50) NOT NULL COMMENT 'ç­‰çº§å¡åç§°',\n+          icon VARCHAR(10) NOT NULL COMMENT 'ç­‰çº§å¡å›¾æ ‡',\n+          price DECIMAL(10,2) NOT NULL COMMENT 'ä»·æ ¼',\n+          points INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',\n+          description TEXT COMMENT 'æè¿°',\n+          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+          updated_at DATETIME NULL\n+        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+      `);\n+\n+      // æ’å…¥åˆå§‹æ•°æ®\n+      await query(`\n+        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n+        ('ä½“éªŒå¡', 'ğŸ', 0.00, 20, 'å…è´¹ä½“éªŒå¡ï¼Œæ¯å¼ 20ç§¯åˆ†'),\n+        ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300, 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n+        ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000, 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n+        ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000, 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·')\n+      `);\n+\n+      // é‡æ–°è·å–æ•°æ®\n+      const cardTypes = await query(`\n+        SELECT id, name, icon, points, price, description\n+        FROM level_card_types\n+        ORDER BY points ASC\n+      `);\n+\n+      console.log('âœ… è¡¨åˆ›å»ºæˆåŠŸï¼Œè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n+      res.json({\n+        success: true,\n+        data: {\n+          cardTypes\n+        }\n+      });\n+    }\n   } catch (error) {\n+    console.error('âŒ è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥:', error);\n     next(error);\n   }\n });\n \n"
                },
                {
                    "date": 1752322637823,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -995,8 +995,29 @@\n     }\n \n     console.log(`ğŸ« å¼€å§‹ç”Ÿæˆ${count}å¼ ç­‰çº§å¡ï¼Œç±»å‹ID: ${cardTypeId}...`);\n \n+    // ç¡®ä¿level_cardsè¡¨å­˜åœ¨\n+    await query(`\n+      CREATE TABLE IF NOT EXISTS level_cards (\n+        id INT AUTO_INCREMENT PRIMARY KEY,\n+        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT 'å¡å·',\n+        card_password VARCHAR(20) NOT NULL COMMENT 'å¡å¯†',\n+        type_id INT NOT NULL COMMENT 'ç­‰çº§å¡ç±»å‹ID',\n+        total_points INT NOT NULL COMMENT 'æ€»ç§¯åˆ†',\n+        remaining_points INT NOT NULL COMMENT 'å‰©ä½™ç§¯åˆ†',\n+        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT 'çŠ¶æ€',\n+        bound_user_id INT NULL COMMENT 'ç»‘å®šçš„ç”¨æˆ·ID',\n+        bound_at DATETIME NULL COMMENT 'ç»‘å®šæ—¶é—´',\n+        expires_at DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´',\n+        created_at DATETIME NOT NULL,\n+        updated_at DATETIME NULL,\n+        INDEX idx_card_number (card_number),\n+        INDEX idx_bound_user (bound_user_id),\n+        INDEX idx_status (status)\n+      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+    `);\n+\n     // è·å–å¡ç‰‡ç±»å‹ä¿¡æ¯\n     const cardTypeResult = await query(`\n       SELECT id, name, points, price, description\n       FROM level_card_types\n"
                },
                {
                    "date": 1752346972847,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1079,9 +1079,9 @@\n \n     // è·å–ä½“éªŒå¡ç±»å‹ä¿¡æ¯ - ä¿®å¤è¡¨åï¼Œéµå¾ªå¼€å‘åŸåˆ™\n     const cardTypeResult = await query(`\n       SELECT id, name, points, price\n-      FROM level_card_types\n+      FROM card_types\n       WHERE name = 'ä½“éªŒå¡'\n     `);\n \n     if (cardTypeResult.length === 0) {\n"
                },
                {
                    "date": 1752346991888,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,1363 @@\n+const express = require('express');\n+const router = express.Router();\n+const { query } = require('../config/database');\n+const { createExperienceCardSystem, getAvailableExperienceCards } = require('../scripts/create-experience-cards');\n+const { adminAuth } = require('../middleware/adminAuth');\n+\n+// ç”Ÿæˆå¡å·çš„è¾…åŠ©å‡½æ•°\n+function generateCardNumber(cardType, index) {\n+  const typePrefix = {\n+    'åŸºç¡€å¡': 'BC',\n+    'é«˜çº§å¡': 'AC',\n+    'è‡³å°Šå¡': 'PC',\n+    'ä½“éªŒå¡': 'EXP'\n+  };\n+\n+  const prefix = typePrefix[cardType] || 'CARD';\n+  const timestamp = Date.now().toString().slice(-8); // å–æ—¶é—´æˆ³å8ä½\n+  const indexStr = String(index).padStart(2, '0'); // åºå·è¡¥é›¶åˆ°2ä½\n+\n+  return `${prefix}${timestamp}${indexStr}`;\n+}\n+\n+// ç”Ÿæˆå¡å¯†çš„è¾…åŠ©å‡½æ•°\n+function generateCardPassword() {\n+  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n+  let password = '';\n+  for (let i = 0; i < 8; i++) {\n+    password += chars.charAt(Math.floor(Math.random() * chars.length));\n+  }\n+  return password;\n+}\n+\n+\n+\n+// è·å–ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯\n+router.get('/stats', adminAuth, async (req, res, next) => {\n+  try {\n+    // ç”¨æˆ·ç»Ÿè®¡\n+    const userStats = await query(`\n+      SELECT\n+        COUNT(*) as total_users,\n+        COUNT(CASE WHEN status = 'active' THEN 1 END) as active_users,\n+        COUNT(CASE WHEN status = 'inactive' THEN 1 END) as inactive_users,\n+        COUNT(CASE WHEN status = 'banned' THEN 1 END) as banned_users,\n+        COUNT(CASE WHEN DATE(created_at) = CURDATE() THEN 1 END) as today_new_users\n+      FROM users\n+    `);\n+\n+    // ç­‰çº§å¡ç»Ÿè®¡\n+    const cardStats = await query(`\n+      SELECT\n+        COUNT(*) as total_cards,\n+        COUNT(CASE WHEN bound_user_id IS NOT NULL THEN 1 END) as bound_cards,\n+        COUNT(CASE WHEN bound_user_id IS NULL THEN 1 END) as available_cards,\n+        SUM(remaining_points) as total_remaining_points,\n+        COUNT(CASE WHEN ct.name = 'ä½“éªŒå¡' THEN 1 END) as experience_cards,\n+        COUNT(CASE WHEN ct.name != 'ä½“éªŒå¡' THEN 1 END) as level_cards\n+      FROM level_cards lc\n+      LEFT JOIN card_types ct ON lc.type_id = ct.id\n+    `);\n+\n+    // ç§¯åˆ†æ¶ˆè´¹ç»Ÿè®¡\n+    const pointsStats = await query(`\n+      SELECT\n+        COUNT(*) as total_transactions,\n+        SUM(points_amount) as total_points_consumed,\n+        COUNT(CASE WHEN DATE(created_at) = CURDATE() THEN 1 END) as today_transactions,\n+        SUM(CASE WHEN DATE(created_at) = CURDATE() THEN points_amount ELSE 0 END) as today_points_consumed\n+      FROM point_logs\n+      WHERE action_type = 'consume'\n+    `);\n+\n+    // æœ€è¿‘7å¤©çš„ç”¨æˆ·æ³¨å†Œè¶‹åŠ¿\n+    const userTrend = await query(`\n+      SELECT\n+        DATE(created_at) as date,\n+        COUNT(*) as count\n+      FROM users\n+      WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)\n+      GROUP BY DATE(created_at)\n+      ORDER BY date DESC\n+    `);\n+\n+    // æœ€è¿‘7å¤©çš„ç§¯åˆ†æ¶ˆè´¹è¶‹åŠ¿\n+    const pointsTrend = await query(`\n+      SELECT\n+        DATE(created_at) as date,\n+        COUNT(*) as transactions,\n+        SUM(points_amount) as points_consumed\n+      FROM point_logs\n+      WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)\n+        AND action_type = 'consume'\n+      GROUP BY DATE(created_at)\n+      ORDER BY date DESC\n+    `);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        users: userStats[0],\n+        cards: cardStats[0],\n+        points: pointsStats[0],\n+        trends: {\n+          users: userTrend,\n+          points: pointsTrend\n+        }\n+      }\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n+router.get('/users', adminAuth, async (req, res, next) => {\n+  try {\n+    const page = parseInt(req.query.page) || 1;\n+    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n+    const offset = (page - 1) * limit;\n+    const status = req.query.status;\n+    const search = req.query.search;\n+\n+    let whereClause = '';\n+    let queryParams = [];\n+\n+    // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n+    const conditions = [];\n+    if (status) {\n+      conditions.push('status = ?');\n+      queryParams.push(status);\n+    }\n+    if (search) {\n+      conditions.push('(username LIKE ? OR email LIKE ?)');\n+      queryParams.push(`%${search}%`, `%${search}%`);\n+    }\n+\n+    if (conditions.length > 0) {\n+      whereClause = 'WHERE ' + conditions.join(' AND ');\n+    }\n+\n+    // è·å–ç”¨æˆ·æ€»æ•°\n+    const countQuery = `SELECT COUNT(*) as total FROM users ${whereClause}`;\n+    const countResult = await query(countQuery, queryParams);\n+    const total = countResult[0].total;\n+\n+    // è·å–ç”¨æˆ·åˆ—è¡¨\n+    const usersQuery = `\n+      SELECT u.id, u.username, u.email, u.status, u.created_at, u.last_login,\n+             COUNT(lc.id) as bound_cards,\n+             COALESCE(SUM(lc.remaining_points), 0) as total_points\n+      FROM users u\n+      LEFT JOIN level_cards lc ON u.id = lc.bound_user_id\n+      ${whereClause}\n+      GROUP BY u.id\n+      ORDER BY u.created_at DESC\n+      LIMIT ? OFFSET ?\n+    `;\n+\n+    const users = await query(usersQuery, [...queryParams, limit, offset]);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        items: users,\n+        total,\n+        page,\n+        pageSize: limit,\n+        totalPages: Math.ceil(total / limit)\n+      }\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// è·å–ç”¨æˆ·è¯¦æƒ…ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n+router.get('/users/:id', adminAuth, async (req, res, next) => {\n+  try {\n+    const userId = req.params.id;\n+\n+    // è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯\n+    const userResult = await query(`\n+      SELECT id, username, email, status, created_at, updated_at, last_login\n+      FROM users\n+      WHERE id = ?\n+    `, [userId]);\n+\n+    if (userResult.length === 0) {\n+      return res.status(404).json({\n+        success: false,\n+        message: 'ç”¨æˆ·ä¸å­˜åœ¨'\n+      });\n+    }\n+\n+    const user = userResult[0];\n+\n+    // è·å–ç”¨æˆ·ç»‘å®šçš„ç­‰çº§å¡\n+    const cards = await query(`\n+      SELECT lc.id, lc.card_number, lc.remaining_points, lc.bound_at,\n+             ct.name as type_name, ct.icon, ct.points as total_points\n+      FROM level_cards lc\n+      JOIN card_types ct ON lc.type_id = ct.id\n+      WHERE lc.bound_user_id = ?\n+      ORDER BY lc.bound_at DESC\n+    `, [userId]);\n+\n+    // è·å–ç”¨æˆ·ç§¯åˆ†æ¶ˆè´¹è®°å½•\n+    const pointsHistory = await query(`\n+      SELECT id, action_type, points_amount, description, url, created_at\n+      FROM point_logs\n+      WHERE user_id = ?\n+      ORDER BY created_at DESC\n+      LIMIT 20\n+    `, [userId]);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        user,\n+        cards,\n+        pointsHistory,\n+        summary: {\n+          totalCards: cards.length,\n+          totalPoints: cards.reduce((sum, card) => sum + card.remaining_points, 0),\n+          totalConsumed: pointsHistory\n+            .filter(log => log.action_type === 'consume')\n+            .reduce((sum, log) => sum + log.points_amount, 0)\n+        }\n+      }\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// æ›´æ–°ç”¨æˆ·çŠ¶æ€ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n+router.put('/users/:id/status', adminAuth, async (req, res, next) => {\n+  try {\n+    const userId = req.params.id;\n+    const { status } = req.body;\n+\n+    if (!['active', 'inactive', 'banned'].includes(status)) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'æ— æ•ˆçš„ç”¨æˆ·çŠ¶æ€'\n+      });\n+    }\n+\n+    await query(`\n+      UPDATE users\n+      SET status = ?, updated_at = NOW()\n+      WHERE id = ?\n+    `, [status, userId]);\n+\n+    res.json({\n+      success: true,\n+      message: 'ç”¨æˆ·çŠ¶æ€æ›´æ–°æˆåŠŸ'\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// å°ç¦ç”¨æˆ·ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n+router.post('/users/:id/ban', adminAuth, async (req, res, next) => {\n+  try {\n+    const userId = req.params.id;\n+\n+    await query(`\n+      UPDATE users\n+      SET status = 'banned', updated_at = NOW()\n+      WHERE id = ?\n+    `, [userId]);\n+\n+    res.json({\n+      success: true,\n+      message: 'ç”¨æˆ·å·²å°ç¦'\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// è§£å°ç”¨æˆ·ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n+router.post('/users/:id/unban', adminAuth, async (req, res, next) => {\n+  try {\n+    const userId = req.params.id;\n+\n+    await query(`\n+      UPDATE users\n+      SET status = 'active', updated_at = NOW()\n+      WHERE id = ?\n+    `, [userId]);\n+\n+    res.json({\n+      success: true,\n+      message: 'ç”¨æˆ·å·²è§£å°'\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// åˆå§‹åŒ–ç­‰çº§å¡æ•°æ®åº“è¡¨\n+router.post('/init-level-cards', async (req, res, next) => {\n+  try {\n+    console.log('ğŸ—ƒï¸ å¼€å§‹åˆ›å»ºç­‰çº§å¡ç›¸å…³æ•°æ®åº“è¡¨...');\n+\n+    // 1. åˆ›å»ºç­‰çº§å¡ç±»å‹è¡¨\n+    console.log('ğŸ“ åˆ›å»ºç­‰çº§å¡ç±»å‹è¡¨...');\n+    await query(`\n+      CREATE TABLE IF NOT EXISTS level_card_types (\n+        id INT AUTO_INCREMENT PRIMARY KEY,\n+        name VARCHAR(50) NOT NULL COMMENT 'ç­‰çº§å¡åç§°',\n+        icon VARCHAR(10) NOT NULL COMMENT 'ç­‰çº§å¡å›¾æ ‡',\n+        price DECIMAL(10,2) NOT NULL COMMENT 'ä»·æ ¼',\n+        points INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',\n+        description TEXT COMMENT 'æè¿°',\n+        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+        updated_at DATETIME NULL\n+      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+    `);\n+    console.log('âœ… ç­‰çº§å¡ç±»å‹è¡¨åˆ›å»ºæˆåŠŸ');\n+\n+    // 2. åˆ›å»ºç­‰çº§å¡è¡¨\n+    console.log('ğŸ“ åˆ›å»ºç­‰çº§å¡è¡¨...');\n+    await query(`\n+      CREATE TABLE IF NOT EXISTS level_cards (\n+        id INT AUTO_INCREMENT PRIMARY KEY,\n+        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT 'å¡å·',\n+        card_password VARCHAR(20) NOT NULL COMMENT 'å¡å¯†',\n+        type_id INT NOT NULL COMMENT 'ç­‰çº§å¡ç±»å‹ID',\n+        total_points INT NOT NULL COMMENT 'æ€»ç§¯åˆ†',\n+        remaining_points INT NOT NULL COMMENT 'å‰©ä½™ç§¯åˆ†',\n+        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT 'çŠ¶æ€',\n+        bound_user_id INT NULL COMMENT 'ç»‘å®šçš„ç”¨æˆ·ID',\n+        bound_at DATETIME NULL COMMENT 'ç»‘å®šæ—¶é—´',\n+        expires_at DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´',\n+        created_at DATETIME NOT NULL,\n+        updated_at DATETIME NULL,\n+        FOREIGN KEY (type_id) REFERENCES level_card_types(id),\n+        FOREIGN KEY (bound_user_id) REFERENCES users(id),\n+        INDEX idx_card_number (card_number),\n+        INDEX idx_bound_user (bound_user_id),\n+        INDEX idx_status (status)\n+      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+    `);\n+    console.log('âœ… ç­‰çº§å¡è¡¨åˆ›å»ºæˆåŠŸ');\n+\n+    // 3. åˆ›å»ºç­‰çº§å¡ä½¿ç”¨è®°å½•è¡¨\n+    console.log('ğŸ“ åˆ›å»ºç­‰çº§å¡äº¤æ˜“è®°å½•è¡¨...');\n+    await query(`\n+      CREATE TABLE IF NOT EXISTS level_card_transactions (\n+        id INT AUTO_INCREMENT PRIMARY KEY,\n+        card_id INT NOT NULL COMMENT 'ç­‰çº§å¡ID',\n+        user_id INT NOT NULL COMMENT 'ç”¨æˆ·ID',\n+        type ENUM('bind', 'consume') NOT NULL COMMENT 'äº¤æ˜“ç±»å‹',\n+        points_amount INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',\n+        remaining_points INT NOT NULL COMMENT 'æ“ä½œåå‰©ä½™ç§¯åˆ†',\n+        description VARCHAR(255) COMMENT 'æè¿°',\n+        created_at DATETIME NOT NULL,\n+        FOREIGN KEY (card_id) REFERENCES level_cards(id),\n+        FOREIGN KEY (user_id) REFERENCES users(id),\n+        INDEX idx_card_user (card_id, user_id),\n+        INDEX idx_created_at (created_at)\n+      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+    `);\n+    console.log('âœ… ç­‰çº§å¡äº¤æ˜“è®°å½•è¡¨åˆ›å»ºæˆåŠŸ');\n+\n+    // 4. æ’å…¥ç­‰çº§å¡ç±»å‹æ•°æ®ï¼ˆåŒ…å«ä½“éªŒå¡ï¼‰\n+    const existingTypes = await query('SELECT COUNT(*) as count FROM level_card_types');\n+    if (existingTypes[0].count === 0) {\n+      await query(`\n+        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n+        ('ä½“éªŒå¡', 'ğŸ', 0.00, 20, 'å…è´¹ä½“éªŒå¡ï¼Œæ¯å¼ 20ç§¯åˆ†'),\n+        ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300, 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n+        ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000, 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n+        ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000, 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·')\n+      `);\n+    }\n+\n+    res.json({\n+      success: true,\n+      message: 'ç­‰çº§å¡æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ'\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+\n+// è·å–ç­‰çº§å¡ç±»å‹åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n+router.get('/card-types', adminAuth, async (req, res, next) => {\n+  try {\n+    console.log('ğŸ” è·å–ç­‰çº§å¡ç±»å‹åˆ—è¡¨...');\n+\n+    // é¦–å…ˆæ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨\n+    try {\n+      const cardTypes = await query(`\n+        SELECT id, name, icon, points, price, description\n+        FROM level_card_types\n+        ORDER BY points ASC\n+      `);\n+\n+      console.log('âœ… æˆåŠŸè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n+      res.json({\n+        success: true,\n+        data: {\n+          cardTypes\n+        }\n+      });\n+    } catch (tableError) {\n+      console.log('âš ï¸ ç­‰çº§å¡ç±»å‹è¡¨ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º...');\n+\n+      // åˆ›å»ºè¡¨å’Œåˆå§‹æ•°æ®\n+      await query(`\n+        CREATE TABLE IF NOT EXISTS level_card_types (\n+          id INT AUTO_INCREMENT PRIMARY KEY,\n+          name VARCHAR(50) NOT NULL COMMENT 'ç­‰çº§å¡åç§°',\n+          icon VARCHAR(10) NOT NULL COMMENT 'ç­‰çº§å¡å›¾æ ‡',\n+          price DECIMAL(10,2) NOT NULL COMMENT 'ä»·æ ¼',\n+          points INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',\n+          description TEXT COMMENT 'æè¿°',\n+          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+          updated_at DATETIME NULL\n+        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+      `);\n+\n+      // æ’å…¥åˆå§‹æ•°æ®\n+      await query(`\n+        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n+        ('ä½“éªŒå¡', 'ğŸ', 0.00, 20, 'å…è´¹ä½“éªŒå¡ï¼Œæ¯å¼ 20ç§¯åˆ†'),\n+        ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300, 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n+        ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000, 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n+        ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000, 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·')\n+      `);\n+\n+      // é‡æ–°è·å–æ•°æ®\n+      const cardTypes = await query(`\n+        SELECT id, name, icon, points, price, description\n+        FROM level_card_types\n+        ORDER BY points ASC\n+      `);\n+\n+      console.log('âœ… è¡¨åˆ›å»ºæˆåŠŸï¼Œè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n+      res.json({\n+        success: true,\n+        data: {\n+          cardTypes\n+        }\n+      });\n+    }\n+  } catch (error) {\n+    console.error('âŒ è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥:', error);\n+    next(error);\n+  }\n+});\n+\n+// è·å–æ‰€æœ‰ç­‰çº§å¡åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n+router.get('/cards', adminAuth, async (req, res, next) => {\n+  try {\n+    const page = parseInt(req.query.page) || 1;\n+    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n+    const offset = (page - 1) * limit;\n+    const status = req.query.status;\n+    const cardType = req.query.type;\n+    const search = req.query.search;\n+\n+    let whereClause = '';\n+    let queryParams = [];\n+\n+    // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n+    const conditions = [];\n+    if (status) {\n+      conditions.push('lc.status = ?');\n+      queryParams.push(status);\n+    }\n+    if (cardType) {\n+      conditions.push('ct.name = ?');\n+      queryParams.push(cardType);\n+    }\n+    if (search) {\n+      conditions.push('(lc.card_number LIKE ? OR u.username LIKE ?)');\n+      queryParams.push(`%${search}%`, `%${search}%`);\n+    }\n+\n+    if (conditions.length > 0) {\n+      whereClause = 'WHERE ' + conditions.join(' AND ');\n+    }\n+\n+    // è·å–ç­‰çº§å¡æ€»æ•°\n+    const countQuery = `\n+      SELECT COUNT(*) as total\n+      FROM level_cards lc\n+      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN users u ON lc.bound_user_id = u.id\n+      ${whereClause}\n+    `;\n+    const countResult = await query(countQuery, queryParams);\n+    const total = countResult[0].total;\n+\n+    // è·å–ç­‰çº§å¡åˆ—è¡¨\n+    const cardsQuery = `\n+      SELECT lc.id, lc.card_number, lc.card_password, lc.remaining_points,\n+             lc.bound_at, lc.created_at,\n+             ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n+             u.username as bound_username, u.id as bound_user_id\n+      FROM level_cards lc\n+      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN users u ON lc.bound_user_id = u.id\n+      ${whereClause}\n+      ORDER BY lc.created_at DESC\n+      LIMIT ? OFFSET ?\n+    `;\n+\n+    const cards = await query(cardsQuery, [...queryParams, limit, offset]);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        items: cards,\n+        total,\n+        page,\n+        pageSize: limit,\n+        totalPages: Math.ceil(total / limit)\n+      }\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// è·å–ç­‰çº§å¡è¯¦æƒ…ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n+router.get('/cards/:id', adminAuth, async (req, res, next) => {\n+  try {\n+    const cardId = req.params.id;\n+\n+    // è·å–ç­‰çº§å¡åŸºæœ¬ä¿¡æ¯\n+    const cardResult = await query(`\n+      SELECT lc.id, lc.card_number, lc.card_password, lc.remaining_points,\n+             lc.bound_at, lc.created_at,\n+             ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n+             u.username as bound_username, u.id as bound_user_id, u.email as bound_user_email\n+      FROM level_cards lc\n+      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN users u ON lc.bound_user_id = u.id\n+      WHERE lc.id = ?\n+    `, [cardId]);\n+\n+    if (cardResult.length === 0) {\n+      return res.status(404).json({\n+        success: false,\n+        message: 'ç­‰çº§å¡ä¸å­˜åœ¨'\n+      });\n+    }\n+\n+    const card = cardResult[0];\n+\n+    // è·å–è¯¥å¡çš„ä½¿ç”¨è®°å½•\n+    const usageHistory = await query(`\n+      SELECT id, action_type, points_amount, description, url, created_at\n+      FROM point_logs\n+      WHERE user_id = ? AND description LIKE '%${card.card_number}%'\n+      ORDER BY created_at DESC\n+      LIMIT 20\n+    `, [card.bound_user_id]);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        card,\n+        usageHistory,\n+        summary: {\n+          totalUsed: card.total_points - card.remaining_points,\n+          usageCount: usageHistory.filter(log => log.action_type === 'consume').length\n+        }\n+      }\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// ç¦ç”¨/å¯ç”¨ç­‰çº§å¡ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n+router.put('/cards/:id/status', adminAuth, async (req, res, next) => {\n+  try {\n+    const cardId = req.params.id;\n+    const { status } = req.body;\n+\n+    if (!['active', 'disabled', 'expired'].includes(status)) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'æ— æ•ˆçš„ç­‰çº§å¡çŠ¶æ€'\n+      });\n+    }\n+\n+    await query(`\n+      UPDATE level_cards\n+      SET status = ?\n+      WHERE id = ?\n+    `, [status, cardId]);\n+\n+    res.json({\n+      success: true,\n+      message: 'ç­‰çº§å¡çŠ¶æ€æ›´æ–°æˆåŠŸ'\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// è§£ç»‘ç­‰çº§å¡ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n+router.put('/cards/:id/unbind', adminAuth, async (req, res, next) => {\n+  try {\n+    const cardId = req.params.id;\n+\n+    await query(`\n+      UPDATE level_cards\n+      SET bound_user_id = NULL, bound_at = NULL\n+      WHERE id = ?\n+    `, [cardId]);\n+\n+    res.json({\n+      success: true,\n+      message: 'ç­‰çº§å¡è§£ç»‘æˆåŠŸ'\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// è·å–ç§¯åˆ†è®°å½•åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰- å…¼å®¹æ–°å‰ç«¯è·¯å¾„\n+router.get('/points-logs', adminAuth, async (req, res, next) => {\n+  try {\n+    const page = parseInt(req.query.page) || 1;\n+    const pageSize = parseInt(req.query.pageSize) || 20;\n+    const offset = (page - 1) * pageSize;\n+    const actionType = req.query.type;\n+    const search = req.query.search;\n+\n+    let whereClause = '';\n+    let queryParams = [];\n+\n+    // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n+    const conditions = [];\n+    if (actionType) {\n+      conditions.push('pl.action_type = ?');\n+      queryParams.push(actionType);\n+    }\n+    if (search) {\n+      conditions.push('u.username LIKE ?');\n+      queryParams.push(`%${search}%`);\n+    }\n+\n+    if (conditions.length > 0) {\n+      whereClause = 'WHERE ' + conditions.join(' AND ');\n+    }\n+\n+    // è·å–ç§¯åˆ†è®°å½•æ€»æ•°\n+    const countQuery = `\n+      SELECT COUNT(*) as total\n+      FROM point_logs pl\n+      LEFT JOIN users u ON pl.user_id = u.id\n+      ${whereClause}\n+    `;\n+    const countResult = await query(countQuery, queryParams);\n+    const total = countResult[0].total;\n+\n+    // è·å–ç§¯åˆ†è®°å½•åˆ—è¡¨\n+    const pointsQuery = `\n+      SELECT pl.id, pl.action_type, pl.points_amount, pl.description, pl.url, pl.created_at,\n+             u.username, u.id as user_id\n+      FROM point_logs pl\n+      LEFT JOIN users u ON pl.user_id = u.id\n+      ${whereClause}\n+      ORDER BY pl.created_at DESC\n+      LIMIT ? OFFSET ?\n+    `;\n+\n+    const pointsLogs = await query(pointsQuery, [...queryParams, pageSize, offset]);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        items: pointsLogs,\n+        total,\n+        page,\n+        pageSize,\n+        totalPages: Math.ceil(total / pageSize)\n+      }\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// è·å–ç§¯åˆ†è®°å½•åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰- ä¿æŒåŸæœ‰æ¥å£å…¼å®¹æ€§\n+router.get('/points', adminAuth, async (req, res, next) => {\n+  try {\n+    const page = parseInt(req.query.page) || 1;\n+    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n+    const offset = (page - 1) * limit;\n+    const actionType = req.query.type;\n+    const search = req.query.search;\n+\n+    let whereClause = '';\n+    let queryParams = [];\n+\n+    // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n+    const conditions = [];\n+    if (actionType) {\n+      conditions.push('pl.action_type = ?');\n+      queryParams.push(actionType);\n+    }\n+    if (search) {\n+      conditions.push('u.username LIKE ?');\n+      queryParams.push(`%${search}%`);\n+    }\n+\n+    if (conditions.length > 0) {\n+      whereClause = 'WHERE ' + conditions.join(' AND ');\n+    }\n+\n+    // è·å–ç§¯åˆ†è®°å½•æ€»æ•°\n+    const countQuery = `\n+      SELECT COUNT(*) as total\n+      FROM point_logs pl\n+      LEFT JOIN users u ON pl.user_id = u.id\n+      ${whereClause}\n+    `;\n+    const countResult = await query(countQuery, queryParams);\n+    const total = countResult[0].total;\n+\n+    // è·å–ç§¯åˆ†è®°å½•åˆ—è¡¨\n+    const pointsQuery = `\n+      SELECT pl.id, pl.action_type, pl.points_amount, pl.description, pl.url, pl.created_at,\n+             u.username, u.id as user_id\n+      FROM point_logs pl\n+      LEFT JOIN users u ON pl.user_id = u.id\n+      ${whereClause}\n+      ORDER BY pl.created_at DESC\n+      LIMIT ? OFFSET ?\n+    `;\n+\n+    const pointsLogs = await query(pointsQuery, [...queryParams, limit, offset]);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        items: pointsLogs,\n+        total,\n+        page,\n+        pageSize: limit,\n+        totalPages: Math.ceil(total / limit)\n+      }\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// è·å–ç³»ç»Ÿé…ç½®ä¿¡æ¯ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n+router.get('/config', adminAuth, async (req, res, next) => {\n+  try {\n+    console.log('ğŸ“¥ ä»æ•°æ®åº“åŠ è½½ç³»ç»Ÿé…ç½®...');\n+\n+    // ä»æ•°æ®åº“è·å–æ‰€æœ‰é…ç½®\n+    const configs = await query(`\n+      SELECT config_key, config_value, config_type, config_group, description, is_encrypted\n+      FROM system_config\n+      ORDER BY config_group, config_key\n+    `);\n+\n+    console.log(`ğŸ“Š ä»æ•°æ®åº“åŠ è½½äº†${configs.length}é¡¹é…ç½®`);\n+\n+    // æŒ‰åˆ†ç»„ç»„ç»‡é…ç½®\n+    const groupedConfigs = {};\n+    configs.forEach(config => {\n+      const group = config.config_group || 'general';\n+\n+      if (!groupedConfigs[group]) {\n+        groupedConfigs[group] = [];\n+      }\n+\n+      // å¤„ç†æ•æ„Ÿé…ç½®æ˜¾ç¤º\n+      let displayValue = config.config_value;\n+      if (config.is_encrypted && config.config_value) {\n+        // å¯¹äºæ•æ„Ÿé…ç½®ï¼Œæ˜¾ç¤ºæ©ç \n+        if (config.config_key.includes('password') || config.config_key.includes('secret')) {\n+          displayValue = '***';\n+        }\n+      }\n+\n+      groupedConfigs[group].push({\n+        config_key: config.config_key,\n+        config_value: displayValue,\n+        config_type: config.config_type || 'string',\n+        description: config.description || '',\n+        is_encrypted: config.is_encrypted || 0\n+      });\n+    });\n+\n+    // ç¡®ä¿æ‰€æœ‰å¿…è¦çš„åˆ†ç»„éƒ½å­˜åœ¨\n+    const requiredGroups = ['server', 'database', 'jwt', 'comfyui', 'ai', 'frontend', 'cors', 'upload', 'log'];\n+    requiredGroups.forEach(group => {\n+      if (!groupedConfigs[group]) {\n+        groupedConfigs[group] = [];\n+      }\n+    });\n+\n+    console.log('ğŸ“‹ é…ç½®åˆ†ç»„ç»Ÿè®¡:');\n+    Object.keys(groupedConfigs).forEach(group => {\n+      console.log(`   ${group}: ${groupedConfigs[group].length} é¡¹é…ç½®`);\n+    });\n+\n+    res.json({\n+      success: true,\n+      data: groupedConfigs\n+    });\n+\n+  } catch (error) {\n+    console.error('âŒ åŠ è½½é…ç½®å¤±è´¥:', error);\n+    res.status(500).json({\n+      success: false,\n+      message: 'åŠ è½½é…ç½®å¤±è´¥: ' + error.message\n+    });\n+  }\n+});\n+\n+// ä¿å­˜ç³»ç»Ÿé…ç½®ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n+router.post('/config', adminAuth, async (req, res, next) => {\n+  try {\n+    const { configs } = req.body;\n+\n+    if (!configs || !Array.isArray(configs)) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'é…ç½®æ•°æ®æ ¼å¼é”™è¯¯'\n+      });\n+    }\n+\n+    console.log('ğŸ’¾ ä¿å­˜ç³»ç»Ÿé…ç½®åˆ°æ•°æ®åº“ï¼Œå…±', configs.length, 'é¡¹');\n+\n+    // çœŸæ­£ä¿å­˜é…ç½®åˆ°æ•°æ®åº“\n+    const results = [];\n+    let successCount = 0;\n+    let errorCount = 0;\n+\n+    for (const config of configs) {\n+      const { config_key, config_value } = config;\n+\n+      try {\n+        // æ›´æ–°æ•°æ®åº“ä¸­çš„é…ç½®\n+        const result = await query(`\n+          UPDATE system_config\n+          SET config_value = ?, updated_at = NOW()\n+          WHERE config_key = ?\n+        `, [config_value, config_key]);\n+\n+        if (result.affectedRows > 0) {\n+          console.log(`  âœ… ä¿å­˜æˆåŠŸ: ${config_key} = ${config_value}`);\n+          results.push({\n+            config_key,\n+            updated: true,\n+            message: 'æ›´æ–°æˆåŠŸ'\n+          });\n+          successCount++;\n+        } else {\n+          // å¦‚æœæ²¡æœ‰æ‰¾åˆ°é…ç½®é¡¹ï¼Œå°è¯•æ’å…¥æ–°çš„\n+          try {\n+            await query(`\n+              INSERT INTO system_config (config_key, config_value, config_type, config_group, description)\n+              VALUES (?, ?, 'string', 'custom', 'ç”¨æˆ·è‡ªå®šä¹‰é…ç½®')\n+            `, [config_key, config_value]);\n+\n+            console.log(`  âœ… æ–°å¢æˆåŠŸ: ${config_key} = ${config_value}`);\n+            results.push({\n+              config_key,\n+              updated: true,\n+              message: 'æ–°å¢æˆåŠŸ'\n+            });\n+            successCount++;\n+          } catch (insertError) {\n+            console.log(`  âŒ æ–°å¢å¤±è´¥: ${config_key} - ${insertError.message}`);\n+            results.push({\n+              config_key,\n+              updated: false,\n+              message: 'æ–°å¢å¤±è´¥: ' + insertError.message\n+            });\n+            errorCount++;\n+          }\n+        }\n+      } catch (updateError) {\n+        console.log(`  âŒ æ›´æ–°å¤±è´¥: ${config_key} - ${updateError.message}`);\n+        results.push({\n+          config_key,\n+          updated: false,\n+          message: 'æ›´æ–°å¤±è´¥: ' + updateError.message\n+        });\n+        errorCount++;\n+      }\n+    }\n+\n+    const message = `é…ç½®ä¿å­˜å®Œæˆ: ${successCount}é¡¹æˆåŠŸ, ${errorCount}é¡¹å¤±è´¥`;\n+    console.log('ğŸ“Š', message);\n+\n+    res.json({\n+      success: errorCount === 0,\n+      message: message,\n+      data: {\n+        results,\n+        summary: {\n+          total: configs.length,\n+          success: successCount,\n+          error: errorCount\n+        }\n+      }\n+    });\n+\n+  } catch (error) {\n+    console.error('âŒ ä¿å­˜é…ç½®å¤±è´¥:', error);\n+    res.status(500).json({\n+      success: false,\n+      message: 'ä¿å­˜é…ç½®å¤±è´¥: ' + error.message\n+    });\n+  }\n+});\n+\n+// æ‰¹é‡æ“ä½œç”¨æˆ·çŠ¶æ€ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n+router.put('/users/batch-status', adminAuth, async (req, res, next) => {\n+  try {\n+    const { userIds, status } = req.body;\n+\n+    if (!Array.isArray(userIds) || userIds.length === 0) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'è¯·æä¾›æœ‰æ•ˆçš„ç”¨æˆ·IDåˆ—è¡¨'\n+      });\n+    }\n+\n+    if (!['active', 'inactive', 'banned'].includes(status)) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'æ— æ•ˆçš„ç”¨æˆ·çŠ¶æ€'\n+      });\n+    }\n+\n+    const placeholders = userIds.map(() => '?').join(',');\n+    await query(`\n+      UPDATE users\n+      SET status = ?, updated_at = NOW()\n+      WHERE id IN (${placeholders})\n+    `, [status, ...userIds]);\n+\n+    res.json({\n+      success: true,\n+      message: `æˆåŠŸæ›´æ–°${userIds.length}ä¸ªç”¨æˆ·çš„çŠ¶æ€`\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// ç”Ÿæˆç­‰çº§å¡ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n+router.post('/generate-cards', adminAuth, async (req, res, next) => {\n+  try {\n+    const { cardTypeId, count = 5 } = req.body;\n+\n+    if (!cardTypeId) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'è¯·é€‰æ‹©ç­‰çº§å¡ç±»å‹'\n+      });\n+    }\n+\n+    if (!count || count <= 0 || count > 100) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'ç”Ÿæˆæ•°é‡å¿…é¡»åœ¨1-100ä¹‹é—´'\n+      });\n+    }\n+\n+    console.log(`ğŸ« å¼€å§‹ç”Ÿæˆ${count}å¼ ç­‰çº§å¡ï¼Œç±»å‹ID: ${cardTypeId}...`);\n+\n+    // ç¡®ä¿level_cardsè¡¨å­˜åœ¨\n+    await query(`\n+      CREATE TABLE IF NOT EXISTS level_cards (\n+        id INT AUTO_INCREMENT PRIMARY KEY,\n+        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT 'å¡å·',\n+        card_password VARCHAR(20) NOT NULL COMMENT 'å¡å¯†',\n+        type_id INT NOT NULL COMMENT 'ç­‰çº§å¡ç±»å‹ID',\n+        total_points INT NOT NULL COMMENT 'æ€»ç§¯åˆ†',\n+        remaining_points INT NOT NULL COMMENT 'å‰©ä½™ç§¯åˆ†',\n+        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT 'çŠ¶æ€',\n+        bound_user_id INT NULL COMMENT 'ç»‘å®šçš„ç”¨æˆ·ID',\n+        bound_at DATETIME NULL COMMENT 'ç»‘å®šæ—¶é—´',\n+        expires_at DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´',\n+        created_at DATETIME NOT NULL,\n+        updated_at DATETIME NULL,\n+        INDEX idx_card_number (card_number),\n+        INDEX idx_bound_user (bound_user_id),\n+        INDEX idx_status (status)\n+      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+    `);\n+\n+    // è·å–å¡ç‰‡ç±»å‹ä¿¡æ¯\n+    const cardTypeResult = await query(`\n+      SELECT id, name, points, price, description\n+      FROM level_card_types\n+      WHERE id = ?\n+    `, [cardTypeId]);\n+\n+    if (cardTypeResult.length === 0) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'æ— æ•ˆçš„å¡ç‰‡ç±»å‹'\n+      });\n+    }\n+\n+    const typeInfo = cardTypeResult[0];\n+    const generatedCards = [];\n+\n+    // æ‰¹é‡ç”Ÿæˆç­‰çº§å¡\n+    for (let i = 1; i <= count; i++) {\n+      const cardNumber = generateCardNumber(typeInfo.name, i);\n+      const cardPassword = generateCardPassword();\n+\n+      await query(`\n+        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n+        VALUES (?, ?, ?, ?, NOW())\n+      `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+\n+      generatedCards.push({\n+        cardNumber,\n+        cardPassword,\n+        typeName: typeInfo.name,\n+        points: typeInfo.points,\n+        price: typeInfo.price\n+      });\n+    }\n+\n+    console.log(`âœ… æˆåŠŸç”Ÿæˆ${count}å¼ ${typeInfo.name}`);\n+\n+    res.json({\n+      success: true,\n+      message: `æˆåŠŸç”Ÿæˆ${count}å¼ ${typeInfo.name}`,\n+      data: {\n+        cards: generatedCards,\n+        cardType: typeInfo.name,\n+        totalGenerated: count\n+      }\n+    });\n+\n+  } catch (error) {\n+    console.error('âŒ ç”Ÿæˆç­‰çº§å¡å¤±è´¥:', error);\n+    next(error);\n+  }\n+});\n+\n+// ç”Ÿæˆä½“éªŒå¡\n+router.post('/generate-experience-cards', adminAuth, async (req, res, next) => {\n+  try {\n+    const { count = 1 } = req.body;\n+    console.log(`ğŸ« ç®¡ç†å‘˜è¯·æ±‚ç”Ÿæˆ${count}å¼ ä½“éªŒå¡...`);\n+\n+    // è·å–ä½“éªŒå¡ç±»å‹ä¿¡æ¯ - ä¿®å¤è¡¨åï¼Œéµå¾ªå¼€å‘åŸåˆ™\n+    const cardTypeResult = await query(`\n+      SELECT id, name, points, price\n+      FROM card_types\n+      WHERE name = 'ä½“éªŒå¡'\n+    `);\n+\n+    if (cardTypeResult.length === 0) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'ä½“éªŒå¡ç±»å‹ä¸å­˜åœ¨'\n+      });\n+    }\n+\n+    const typeInfo = cardTypeResult[0];\n+    const generatedCards = [];\n+\n+    // æ‰¹é‡ç”Ÿæˆä½“éªŒå¡\n+    for (let i = 1; i <= count; i++) {\n+      const cardNumber = generateCardNumber('ä½“éªŒå¡', i);\n+      const cardPassword = generateCardPassword();\n+\n+      await query(`\n+        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n+        VALUES (?, ?, ?, ?, NOW())\n+      `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+\n+      generatedCards.push({\n+        cardNumber,\n+        cardPassword,\n+        typeName: typeInfo.name,\n+        points: typeInfo.points\n+      });\n+    }\n+\n+    console.log(`âœ… æˆåŠŸç”Ÿæˆ${count}å¼ ä½“éªŒå¡`);\n+\n+    res.json({\n+      success: true,\n+      message: `æˆåŠŸç”Ÿæˆ${count}å¼ ä½“éªŒå¡`,\n+      data: {\n+        cards: generatedCards,\n+        cardType: typeInfo.name,\n+        totalGenerated: count\n+      }\n+    });\n+\n+  } catch (error) {\n+    console.error('âŒ ç”Ÿæˆä½“éªŒå¡å¤±è´¥:', error);\n+    next(error);\n+  }\n+});\n+\n+// è·å–ä½“éªŒå¡ç»Ÿè®¡ä¿¡æ¯\n+router.get('/experience-cards-stats', adminAuth, async (req, res, next) => {\n+  try {\n+    // è·å–ä½“éªŒå¡ç»Ÿè®¡\n+    const stats = await query(`\n+      SELECT\n+        COUNT(*) as total_cards,\n+        COUNT(CASE WHEN bound_user_id IS NULL THEN 1 END) as available_cards,\n+        COUNT(CASE WHEN bound_user_id IS NOT NULL THEN 1 END) as bound_cards,\n+        SUM(CASE WHEN bound_user_id IS NULL THEN remaining_points ELSE 0 END) as available_points,\n+        SUM(CASE WHEN bound_user_id IS NOT NULL THEN remaining_points ELSE 0 END) as bound_points\n+      FROM level_cards lc\n+      JOIN card_types ct ON lc.type_id = ct.id\n+      WHERE ct.name = 'ä½“éªŒå¡'\n+    `);\n+\n+    // è·å–å¯ç”¨ä½“éªŒå¡åˆ—è¡¨\n+    const availableCards = await getAvailableExperienceCards();\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        stats: stats[0],\n+        availableCards: availableCards.slice(0, 10) // åªè¿”å›å‰10å¼ ä½œä¸ºç¤ºä¾‹\n+      }\n+    });\n+\n+  } catch (error) {\n+    next(error);\n+  }\n+});\n+\n+// æµ‹è¯•æ•°æ®åº“è¿æ¥ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n+router.post('/test-database', adminAuth, async (req, res, next) => {\n+  try {\n+    // ç®€å•çš„æ•°æ®åº“è¿æ¥æµ‹è¯•\n+    await query('SELECT 1 as test');\n+\n+    res.json({\n+      success: true,\n+      message: 'æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ'\n+    });\n+\n+  } catch (error) {\n+    console.error('âŒ æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥:', error);\n+    res.status(500).json({\n+      success: false,\n+      message: 'æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message\n+    });\n+  }\n+});\n+\n+// æµ‹è¯•ComfyUIè¿æ¥ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n+router.post('/test-comfyui', adminAuth, async (req, res, next) => {\n+  try {\n+    // ä»è¯·æ±‚ä½“è·å–æœåŠ¡å™¨åœ°å€ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤é…ç½®\n+    let serverUrl = req.body?.serverUrl;\n+\n+    // å¦‚æœæ²¡æœ‰æä¾›æœåŠ¡å™¨åœ°å€ï¼Œä»æ•°æ®åº“è·å–é…ç½®\n+    if (!serverUrl) {\n+      try {\n+        const [configRows] = await query(\n+          'SELECT config_value FROM system_config WHERE config_key = ?',\n+          ['comfyui.server_url']\n+        );\n+        serverUrl = configRows.length > 0 ? configRows[0].config_value : 'https://your-comfyui-server.com';\n+      } catch (dbError) {\n+        console.error('è·å–ComfyUIé…ç½®å¤±è´¥:', dbError);\n+        serverUrl = 'https://your-comfyui-server.com';\n+      }\n+    }\n+\n+    // ç¡®ä¿URLæ ¼å¼æ­£ç¡®\n+    if (serverUrl && !serverUrl.startsWith('http')) {\n+      serverUrl = 'https://' + serverUrl;\n+    }\n+\n+    // ç§»é™¤æœ«å°¾çš„æ–œæ \n+    if (serverUrl && serverUrl.endsWith('/')) {\n+      serverUrl = serverUrl.slice(0, -1);\n+    }\n+\n+    console.log('ğŸ§ª æµ‹è¯•ComfyUIè¿æ¥:', serverUrl);\n+\n+    // æµ‹è¯•ComfyUIè¿æ¥\n+    const fetch = require('node-fetch');\n+\n+    // å°è¯•å¤šä¸ªç«¯ç‚¹æ¥æ£€æµ‹ComfyUIæœåŠ¡å™¨\n+    const testEndpoints = [\n+      `${serverUrl}/system_stats`,  // ComfyUIç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n+      `${serverUrl}/history`,       // ComfyUIå†å²è®°å½•ç«¯ç‚¹\n+      `${serverUrl}/`,              // æ ¹è·¯å¾„\n+    ];\n+\n+    let lastError = null;\n+    let response = null;\n+\n+    // ä¾æ¬¡å°è¯•ä¸åŒçš„ç«¯ç‚¹\n+    for (const testUrl of testEndpoints) {\n+      try {\n+        console.log(`ğŸ” å°è¯•ç«¯ç‚¹: ${testUrl}`);\n+\n+        response = await fetch(testUrl, {\n+          method: 'GET',\n+          timeout: 10000,\n+          headers: {\n+            'User-Agent': 'ComfyUI-Admin-Test/1.0'\n+          }\n+        });\n+\n+        console.log(`ğŸ“¡ ç«¯ç‚¹ ${testUrl} å“åº”çŠ¶æ€:`, response.status, response.statusText);\n+\n+        // å¦‚æœå¾—åˆ°å“åº”ï¼ˆå³ä½¿æ˜¯é”™è¯¯çŠ¶æ€ç ï¼‰ï¼Œè¯´æ˜æœåŠ¡å™¨æ˜¯å¯è¾¾çš„\n+        if (response) {\n+          break;\n+        }\n+      } catch (error) {\n+        console.log(`âŒ ç«¯ç‚¹ ${testUrl} å¤±è´¥:`, error.message);\n+        lastError = error;\n+        continue;\n+      }\n+    }\n+\n+    // å¦‚æœæ‰€æœ‰ç«¯ç‚¹éƒ½å¤±è´¥äº†\n+    if (!response) {\n+      throw lastError || new Error('æ‰€æœ‰æµ‹è¯•ç«¯ç‚¹éƒ½æ— æ³•è®¿é—®');\n+    }\n+\n+    if (response.status === 200) {\n+      // æœåŠ¡å™¨æ­£å¸¸å“åº”\n+      res.json({\n+        success: true,\n+        message: 'ComfyUIæœåŠ¡å™¨è¿æ¥æˆåŠŸ',\n+        data: {\n+          serverUrl,\n+          status: 'connected',\n+          statusCode: response.status,\n+          message: 'æœåŠ¡å™¨å¯æ­£å¸¸è®¿é—®'\n+        }\n+      });\n+    } else if (response.status === 401) {\n+      // æœåŠ¡å™¨éœ€è¦è®¤è¯ï¼Œä½†å¯ä»¥è¿æ¥\n+      res.json({\n+        success: true,\n+        message: 'ComfyUIæœåŠ¡å™¨è¿æ¥æˆåŠŸï¼ˆéœ€è¦è®¤è¯ï¼‰',\n+        data: {\n+          serverUrl,\n+          status: 'connected_auth_required',\n+          statusCode: response.status,\n+          message: 'æœåŠ¡å™¨å¯è®¿é—®ï¼Œä½†éœ€è¦è®¤è¯'\n+        }\n+      });\n+    } else if (response.status === 404) {\n+      // è·¯å¾„ä¸å­˜åœ¨ï¼Œä½†æœåŠ¡å™¨å¯è¾¾\n+      res.json({\n+        success: true,\n+        message: 'ComfyUIæœåŠ¡å™¨è¿æ¥æˆåŠŸ',\n+        data: {\n+          serverUrl,\n+          status: 'connected',\n+          statusCode: response.status,\n+          message: 'æœåŠ¡å™¨å¯è®¿é—®ï¼ˆè·¯å¾„ä¸å­˜åœ¨æ˜¯æ­£å¸¸çš„ï¼‰'\n+        }\n+      });\n+    } else {\n+      // å…¶ä»–çŠ¶æ€ç \n+      res.json({\n+        success: false,\n+        message: `ComfyUIæœåŠ¡å™¨å“åº”å¼‚å¸¸: ${response.status} ${response.statusText}`,\n+        data: {\n+          serverUrl,\n+          status: 'error',\n+          statusCode: response.status\n+        }\n+      });\n+    }\n+\n+  } catch (error) {\n+    console.error('âŒ ComfyUIè¿æ¥æµ‹è¯•å¤±è´¥:', error);\n+\n+    if (error.code === 'ENOTFOUND') {\n+      res.status(500).json({\n+        success: false,\n+        message: 'ComfyUIæœåŠ¡å™¨åŸŸåæ— æ³•è§£æï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®',\n+        data: {\n+          serverUrl: serverUrl || 'unknown',\n+          status: 'dns_error',\n+          error: error.code,\n+          message: 'Domain name resolution failed'\n+        }\n+      });\n+    } else if (error.code === 'ECONNREFUSED') {\n+      res.status(500).json({\n+        success: false,\n+        message: 'ComfyUIæœåŠ¡å™¨æ‹’ç»è¿æ¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ',\n+        data: {\n+          serverUrl: serverUrl || 'unknown',\n+          status: 'connection_refused',\n+          error: error.code,\n+          message: 'Connection refused by server'\n+        }\n+      });\n+    } else if (error.name === 'AbortError' || error.message.includes('timeout')) {\n+      res.status(500).json({\n+        success: false,\n+        message: 'ComfyUIæœåŠ¡å™¨è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',\n+        data: {\n+          serverUrl: serverUrl || 'unknown',\n+          status: 'timeout',\n+          error: 'timeout',\n+          message: 'Connection timeout'\n+        }\n+      });\n+    } else {\n+      res.status(500).json({\n+        success: false,\n+        message: 'ComfyUIè¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message,\n+        data: {\n+          serverUrl: serverUrl || 'unknown',\n+          status: 'error',\n+          error: error.message,\n+          message: 'Unknown connection error'\n+        }\n+      });\n+    }\n+  }\n+});\n+\n+// ç”Ÿæˆå¡å¯†å‡½æ•°å·²åœ¨æ–‡ä»¶å¼€å¤´å®šä¹‰ï¼Œè¿™é‡Œåˆ é™¤é‡å¤å®šä¹‰\n+\n+module.exports = router;\n"
                },
                {
                    "date": 1752347560789,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -404,9 +404,9 @@\n     // é¦–å…ˆæ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨\n     try {\n       const cardTypes = await query(`\n         SELECT id, name, icon, points, price, description\n-        FROM level_card_types\n+        FROM card_types\n         ORDER BY points ASC\n       `);\n \n       console.log('âœ… æˆåŠŸè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n@@ -1360,1367 +1360,4 @@\n \n // ç”Ÿæˆå¡å¯†å‡½æ•°å·²åœ¨æ–‡ä»¶å¼€å¤´å®šä¹‰ï¼Œè¿™é‡Œåˆ é™¤é‡å¤å®šä¹‰\n \n module.exports = router;\n-const express = require('express');\n-const router = express.Router();\n-const { query } = require('../config/database');\n-const { createExperienceCardSystem, getAvailableExperienceCards } = require('../scripts/create-experience-cards');\n-const { adminAuth } = require('../middleware/adminAuth');\n-\n-// ç”Ÿæˆå¡å·çš„è¾…åŠ©å‡½æ•°\n-function generateCardNumber(cardType, index) {\n-  const typePrefix = {\n-    'åŸºç¡€å¡': 'BC',\n-    'é«˜çº§å¡': 'AC',\n-    'è‡³å°Šå¡': 'PC',\n-    'ä½“éªŒå¡': 'EXP'\n-  };\n-\n-  const prefix = typePrefix[cardType] || 'CARD';\n-  const timestamp = Date.now().toString().slice(-8); // å–æ—¶é—´æˆ³å8ä½\n-  const indexStr = String(index).padStart(2, '0'); // åºå·è¡¥é›¶åˆ°2ä½\n-\n-  return `${prefix}${timestamp}${indexStr}`;\n-}\n-\n-// ç”Ÿæˆå¡å¯†çš„è¾…åŠ©å‡½æ•°\n-function generateCardPassword() {\n-  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n-  let password = '';\n-  for (let i = 0; i < 8; i++) {\n-    password += chars.charAt(Math.floor(Math.random() * chars.length));\n-  }\n-  return password;\n-}\n-\n-\n-\n-// è·å–ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯\n-router.get('/stats', adminAuth, async (req, res, next) => {\n-  try {\n-    // ç”¨æˆ·ç»Ÿè®¡\n-    const userStats = await query(`\n-      SELECT\n-        COUNT(*) as total_users,\n-        COUNT(CASE WHEN status = 'active' THEN 1 END) as active_users,\n-        COUNT(CASE WHEN status = 'inactive' THEN 1 END) as inactive_users,\n-        COUNT(CASE WHEN status = 'banned' THEN 1 END) as banned_users,\n-        COUNT(CASE WHEN DATE(created_at) = CURDATE() THEN 1 END) as today_new_users\n-      FROM users\n-    `);\n-\n-    // ç­‰çº§å¡ç»Ÿè®¡\n-    const cardStats = await query(`\n-      SELECT\n-        COUNT(*) as total_cards,\n-        COUNT(CASE WHEN bound_user_id IS NOT NULL THEN 1 END) as bound_cards,\n-        COUNT(CASE WHEN bound_user_id IS NULL THEN 1 END) as available_cards,\n-        SUM(remaining_points) as total_remaining_points,\n-        COUNT(CASE WHEN ct.name = 'ä½“éªŒå¡' THEN 1 END) as experience_cards,\n-        COUNT(CASE WHEN ct.name != 'ä½“éªŒå¡' THEN 1 END) as level_cards\n-      FROM level_cards lc\n-      LEFT JOIN card_types ct ON lc.type_id = ct.id\n-    `);\n-\n-    // ç§¯åˆ†æ¶ˆè´¹ç»Ÿè®¡\n-    const pointsStats = await query(`\n-      SELECT\n-        COUNT(*) as total_transactions,\n-        SUM(points_amount) as total_points_consumed,\n-        COUNT(CASE WHEN DATE(created_at) = CURDATE() THEN 1 END) as today_transactions,\n-        SUM(CASE WHEN DATE(created_at) = CURDATE() THEN points_amount ELSE 0 END) as today_points_consumed\n-      FROM point_logs\n-      WHERE action_type = 'consume'\n-    `);\n-\n-    // æœ€è¿‘7å¤©çš„ç”¨æˆ·æ³¨å†Œè¶‹åŠ¿\n-    const userTrend = await query(`\n-      SELECT\n-        DATE(created_at) as date,\n-        COUNT(*) as count\n-      FROM users\n-      WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)\n-      GROUP BY DATE(created_at)\n-      ORDER BY date DESC\n-    `);\n-\n-    // æœ€è¿‘7å¤©çš„ç§¯åˆ†æ¶ˆè´¹è¶‹åŠ¿\n-    const pointsTrend = await query(`\n-      SELECT\n-        DATE(created_at) as date,\n-        COUNT(*) as transactions,\n-        SUM(points_amount) as points_consumed\n-      FROM point_logs\n-      WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)\n-        AND action_type = 'consume'\n-      GROUP BY DATE(created_at)\n-      ORDER BY date DESC\n-    `);\n-\n-    res.json({\n-      success: true,\n-      data: {\n-        users: userStats[0],\n-        cards: cardStats[0],\n-        points: pointsStats[0],\n-        trends: {\n-          users: userTrend,\n-          points: pointsTrend\n-        }\n-      }\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n-router.get('/users', adminAuth, async (req, res, next) => {\n-  try {\n-    const page = parseInt(req.query.page) || 1;\n-    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n-    const offset = (page - 1) * limit;\n-    const status = req.query.status;\n-    const search = req.query.search;\n-\n-    let whereClause = '';\n-    let queryParams = [];\n-\n-    // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n-    const conditions = [];\n-    if (status) {\n-      conditions.push('status = ?');\n-      queryParams.push(status);\n-    }\n-    if (search) {\n-      conditions.push('(username LIKE ? OR email LIKE ?)');\n-      queryParams.push(`%${search}%`, `%${search}%`);\n-    }\n-\n-    if (conditions.length > 0) {\n-      whereClause = 'WHERE ' + conditions.join(' AND ');\n-    }\n-\n-    // è·å–ç”¨æˆ·æ€»æ•°\n-    const countQuery = `SELECT COUNT(*) as total FROM users ${whereClause}`;\n-    const countResult = await query(countQuery, queryParams);\n-    const total = countResult[0].total;\n-\n-    // è·å–ç”¨æˆ·åˆ—è¡¨\n-    const usersQuery = `\n-      SELECT u.id, u.username, u.email, u.status, u.created_at, u.last_login,\n-             COUNT(lc.id) as bound_cards,\n-             COALESCE(SUM(lc.remaining_points), 0) as total_points\n-      FROM users u\n-      LEFT JOIN level_cards lc ON u.id = lc.bound_user_id\n-      ${whereClause}\n-      GROUP BY u.id\n-      ORDER BY u.created_at DESC\n-      LIMIT ? OFFSET ?\n-    `;\n-\n-    const users = await query(usersQuery, [...queryParams, limit, offset]);\n-\n-    res.json({\n-      success: true,\n-      data: {\n-        items: users,\n-        total,\n-        page,\n-        pageSize: limit,\n-        totalPages: Math.ceil(total / limit)\n-      }\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// è·å–ç”¨æˆ·è¯¦æƒ…ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n-router.get('/users/:id', adminAuth, async (req, res, next) => {\n-  try {\n-    const userId = req.params.id;\n-\n-    // è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯\n-    const userResult = await query(`\n-      SELECT id, username, email, status, created_at, updated_at, last_login\n-      FROM users\n-      WHERE id = ?\n-    `, [userId]);\n-\n-    if (userResult.length === 0) {\n-      return res.status(404).json({\n-        success: false,\n-        message: 'ç”¨æˆ·ä¸å­˜åœ¨'\n-      });\n-    }\n-\n-    const user = userResult[0];\n-\n-    // è·å–ç”¨æˆ·ç»‘å®šçš„ç­‰çº§å¡\n-    const cards = await query(`\n-      SELECT lc.id, lc.card_number, lc.remaining_points, lc.bound_at,\n-             ct.name as type_name, ct.icon, ct.points as total_points\n-      FROM level_cards lc\n-      JOIN card_types ct ON lc.type_id = ct.id\n-      WHERE lc.bound_user_id = ?\n-      ORDER BY lc.bound_at DESC\n-    `, [userId]);\n-\n-    // è·å–ç”¨æˆ·ç§¯åˆ†æ¶ˆè´¹è®°å½•\n-    const pointsHistory = await query(`\n-      SELECT id, action_type, points_amount, description, url, created_at\n-      FROM point_logs\n-      WHERE user_id = ?\n-      ORDER BY created_at DESC\n-      LIMIT 20\n-    `, [userId]);\n-\n-    res.json({\n-      success: true,\n-      data: {\n-        user,\n-        cards,\n-        pointsHistory,\n-        summary: {\n-          totalCards: cards.length,\n-          totalPoints: cards.reduce((sum, card) => sum + card.remaining_points, 0),\n-          totalConsumed: pointsHistory\n-            .filter(log => log.action_type === 'consume')\n-            .reduce((sum, log) => sum + log.points_amount, 0)\n-        }\n-      }\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// æ›´æ–°ç”¨æˆ·çŠ¶æ€ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n-router.put('/users/:id/status', adminAuth, async (req, res, next) => {\n-  try {\n-    const userId = req.params.id;\n-    const { status } = req.body;\n-\n-    if (!['active', 'inactive', 'banned'].includes(status)) {\n-      return res.status(400).json({\n-        success: false,\n-        message: 'æ— æ•ˆçš„ç”¨æˆ·çŠ¶æ€'\n-      });\n-    }\n-\n-    await query(`\n-      UPDATE users\n-      SET status = ?, updated_at = NOW()\n-      WHERE id = ?\n-    `, [status, userId]);\n-\n-    res.json({\n-      success: true,\n-      message: 'ç”¨æˆ·çŠ¶æ€æ›´æ–°æˆåŠŸ'\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// å°ç¦ç”¨æˆ·ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n-router.post('/users/:id/ban', adminAuth, async (req, res, next) => {\n-  try {\n-    const userId = req.params.id;\n-\n-    await query(`\n-      UPDATE users\n-      SET status = 'banned', updated_at = NOW()\n-      WHERE id = ?\n-    `, [userId]);\n-\n-    res.json({\n-      success: true,\n-      message: 'ç”¨æˆ·å·²å°ç¦'\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// è§£å°ç”¨æˆ·ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n-router.post('/users/:id/unban', adminAuth, async (req, res, next) => {\n-  try {\n-    const userId = req.params.id;\n-\n-    await query(`\n-      UPDATE users\n-      SET status = 'active', updated_at = NOW()\n-      WHERE id = ?\n-    `, [userId]);\n-\n-    res.json({\n-      success: true,\n-      message: 'ç”¨æˆ·å·²è§£å°'\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// åˆå§‹åŒ–ç­‰çº§å¡æ•°æ®åº“è¡¨\n-router.post('/init-level-cards', async (req, res, next) => {\n-  try {\n-    console.log('ğŸ—ƒï¸ å¼€å§‹åˆ›å»ºç­‰çº§å¡ç›¸å…³æ•°æ®åº“è¡¨...');\n-\n-    // 1. åˆ›å»ºç­‰çº§å¡ç±»å‹è¡¨\n-    console.log('ğŸ“ åˆ›å»ºç­‰çº§å¡ç±»å‹è¡¨...');\n-    await query(`\n-      CREATE TABLE IF NOT EXISTS level_card_types (\n-        id INT AUTO_INCREMENT PRIMARY KEY,\n-        name VARCHAR(50) NOT NULL COMMENT 'ç­‰çº§å¡åç§°',\n-        icon VARCHAR(10) NOT NULL COMMENT 'ç­‰çº§å¡å›¾æ ‡',\n-        price DECIMAL(10,2) NOT NULL COMMENT 'ä»·æ ¼',\n-        points INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',\n-        description TEXT COMMENT 'æè¿°',\n-        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-        updated_at DATETIME NULL\n-      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-    `);\n-    console.log('âœ… ç­‰çº§å¡ç±»å‹è¡¨åˆ›å»ºæˆåŠŸ');\n-\n-    // 2. åˆ›å»ºç­‰çº§å¡è¡¨\n-    console.log('ğŸ“ åˆ›å»ºç­‰çº§å¡è¡¨...');\n-    await query(`\n-      CREATE TABLE IF NOT EXISTS level_cards (\n-        id INT AUTO_INCREMENT PRIMARY KEY,\n-        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT 'å¡å·',\n-        card_password VARCHAR(20) NOT NULL COMMENT 'å¡å¯†',\n-        type_id INT NOT NULL COMMENT 'ç­‰çº§å¡ç±»å‹ID',\n-        total_points INT NOT NULL COMMENT 'æ€»ç§¯åˆ†',\n-        remaining_points INT NOT NULL COMMENT 'å‰©ä½™ç§¯åˆ†',\n-        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT 'çŠ¶æ€',\n-        bound_user_id INT NULL COMMENT 'ç»‘å®šçš„ç”¨æˆ·ID',\n-        bound_at DATETIME NULL COMMENT 'ç»‘å®šæ—¶é—´',\n-        expires_at DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´',\n-        created_at DATETIME NOT NULL,\n-        updated_at DATETIME NULL,\n-        FOREIGN KEY (type_id) REFERENCES level_card_types(id),\n-        FOREIGN KEY (bound_user_id) REFERENCES users(id),\n-        INDEX idx_card_number (card_number),\n-        INDEX idx_bound_user (bound_user_id),\n-        INDEX idx_status (status)\n-      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-    `);\n-    console.log('âœ… ç­‰çº§å¡è¡¨åˆ›å»ºæˆåŠŸ');\n-\n-    // 3. åˆ›å»ºç­‰çº§å¡ä½¿ç”¨è®°å½•è¡¨\n-    console.log('ğŸ“ åˆ›å»ºç­‰çº§å¡äº¤æ˜“è®°å½•è¡¨...');\n-    await query(`\n-      CREATE TABLE IF NOT EXISTS level_card_transactions (\n-        id INT AUTO_INCREMENT PRIMARY KEY,\n-        card_id INT NOT NULL COMMENT 'ç­‰çº§å¡ID',\n-        user_id INT NOT NULL COMMENT 'ç”¨æˆ·ID',\n-        type ENUM('bind', 'consume') NOT NULL COMMENT 'äº¤æ˜“ç±»å‹',\n-        points_amount INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',\n-        remaining_points INT NOT NULL COMMENT 'æ“ä½œåå‰©ä½™ç§¯åˆ†',\n-        description VARCHAR(255) COMMENT 'æè¿°',\n-        created_at DATETIME NOT NULL,\n-        FOREIGN KEY (card_id) REFERENCES level_cards(id),\n-        FOREIGN KEY (user_id) REFERENCES users(id),\n-        INDEX idx_card_user (card_id, user_id),\n-        INDEX idx_created_at (created_at)\n-      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-    `);\n-    console.log('âœ… ç­‰çº§å¡äº¤æ˜“è®°å½•è¡¨åˆ›å»ºæˆåŠŸ');\n-\n-    // 4. æ’å…¥ç­‰çº§å¡ç±»å‹æ•°æ®ï¼ˆåŒ…å«ä½“éªŒå¡ï¼‰\n-    const existingTypes = await query('SELECT COUNT(*) as count FROM level_card_types');\n-    if (existingTypes[0].count === 0) {\n-      await query(`\n-        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n-        ('ä½“éªŒå¡', 'ğŸ', 0.00, 20, 'å…è´¹ä½“éªŒå¡ï¼Œæ¯å¼ 20ç§¯åˆ†'),\n-        ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300, 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n-        ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000, 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n-        ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000, 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·')\n-      `);\n-    }\n-\n-    res.json({\n-      success: true,\n-      message: 'ç­‰çº§å¡æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ'\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-\n-// è·å–ç­‰çº§å¡ç±»å‹åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n-router.get('/card-types', adminAuth, async (req, res, next) => {\n-  try {\n-    console.log('ğŸ” è·å–ç­‰çº§å¡ç±»å‹åˆ—è¡¨...');\n-\n-    // é¦–å…ˆæ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨\n-    try {\n-      const cardTypes = await query(`\n-        SELECT id, name, icon, points, price, description\n-        FROM level_card_types\n-        ORDER BY points ASC\n-      `);\n-\n-      console.log('âœ… æˆåŠŸè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n-      res.json({\n-        success: true,\n-        data: {\n-          cardTypes\n-        }\n-      });\n-    } catch (tableError) {\n-      console.log('âš ï¸ ç­‰çº§å¡ç±»å‹è¡¨ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º...');\n-\n-      // åˆ›å»ºè¡¨å’Œåˆå§‹æ•°æ®\n-      await query(`\n-        CREATE TABLE IF NOT EXISTS level_card_types (\n-          id INT AUTO_INCREMENT PRIMARY KEY,\n-          name VARCHAR(50) NOT NULL COMMENT 'ç­‰çº§å¡åç§°',\n-          icon VARCHAR(10) NOT NULL COMMENT 'ç­‰çº§å¡å›¾æ ‡',\n-          price DECIMAL(10,2) NOT NULL COMMENT 'ä»·æ ¼',\n-          points INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',\n-          description TEXT COMMENT 'æè¿°',\n-          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-          updated_at DATETIME NULL\n-        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-      `);\n-\n-      // æ’å…¥åˆå§‹æ•°æ®\n-      await query(`\n-        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n-        ('ä½“éªŒå¡', 'ğŸ', 0.00, 20, 'å…è´¹ä½“éªŒå¡ï¼Œæ¯å¼ 20ç§¯åˆ†'),\n-        ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300, 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n-        ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000, 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n-        ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000, 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·')\n-      `);\n-\n-      // é‡æ–°è·å–æ•°æ®\n-      const cardTypes = await query(`\n-        SELECT id, name, icon, points, price, description\n-        FROM level_card_types\n-        ORDER BY points ASC\n-      `);\n-\n-      console.log('âœ… è¡¨åˆ›å»ºæˆåŠŸï¼Œè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n-      res.json({\n-        success: true,\n-        data: {\n-          cardTypes\n-        }\n-      });\n-    }\n-  } catch (error) {\n-    console.error('âŒ è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥:', error);\n-    next(error);\n-  }\n-});\n-\n-// è·å–æ‰€æœ‰ç­‰çº§å¡åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n-router.get('/cards', adminAuth, async (req, res, next) => {\n-  try {\n-    const page = parseInt(req.query.page) || 1;\n-    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n-    const offset = (page - 1) * limit;\n-    const status = req.query.status;\n-    const cardType = req.query.type;\n-    const search = req.query.search;\n-\n-    let whereClause = '';\n-    let queryParams = [];\n-\n-    // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n-    const conditions = [];\n-    if (status) {\n-      conditions.push('lc.status = ?');\n-      queryParams.push(status);\n-    }\n-    if (cardType) {\n-      conditions.push('ct.name = ?');\n-      queryParams.push(cardType);\n-    }\n-    if (search) {\n-      conditions.push('(lc.card_number LIKE ? OR u.username LIKE ?)');\n-      queryParams.push(`%${search}%`, `%${search}%`);\n-    }\n-\n-    if (conditions.length > 0) {\n-      whereClause = 'WHERE ' + conditions.join(' AND ');\n-    }\n-\n-    // è·å–ç­‰çº§å¡æ€»æ•°\n-    const countQuery = `\n-      SELECT COUNT(*) as total\n-      FROM level_cards lc\n-      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n-      LEFT JOIN users u ON lc.bound_user_id = u.id\n-      ${whereClause}\n-    `;\n-    const countResult = await query(countQuery, queryParams);\n-    const total = countResult[0].total;\n-\n-    // è·å–ç­‰çº§å¡åˆ—è¡¨\n-    const cardsQuery = `\n-      SELECT lc.id, lc.card_number, lc.card_password, lc.remaining_points,\n-             lc.bound_at, lc.created_at,\n-             ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n-             u.username as bound_username, u.id as bound_user_id\n-      FROM level_cards lc\n-      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n-      LEFT JOIN users u ON lc.bound_user_id = u.id\n-      ${whereClause}\n-      ORDER BY lc.created_at DESC\n-      LIMIT ? OFFSET ?\n-    `;\n-\n-    const cards = await query(cardsQuery, [...queryParams, limit, offset]);\n-\n-    res.json({\n-      success: true,\n-      data: {\n-        items: cards,\n-        total,\n-        page,\n-        pageSize: limit,\n-        totalPages: Math.ceil(total / limit)\n-      }\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// è·å–ç­‰çº§å¡è¯¦æƒ…ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n-router.get('/cards/:id', adminAuth, async (req, res, next) => {\n-  try {\n-    const cardId = req.params.id;\n-\n-    // è·å–ç­‰çº§å¡åŸºæœ¬ä¿¡æ¯\n-    const cardResult = await query(`\n-      SELECT lc.id, lc.card_number, lc.card_password, lc.remaining_points,\n-             lc.bound_at, lc.created_at,\n-             ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n-             u.username as bound_username, u.id as bound_user_id, u.email as bound_user_email\n-      FROM level_cards lc\n-      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n-      LEFT JOIN users u ON lc.bound_user_id = u.id\n-      WHERE lc.id = ?\n-    `, [cardId]);\n-\n-    if (cardResult.length === 0) {\n-      return res.status(404).json({\n-        success: false,\n-        message: 'ç­‰çº§å¡ä¸å­˜åœ¨'\n-      });\n-    }\n-\n-    const card = cardResult[0];\n-\n-    // è·å–è¯¥å¡çš„ä½¿ç”¨è®°å½•\n-    const usageHistory = await query(`\n-      SELECT id, action_type, points_amount, description, url, created_at\n-      FROM point_logs\n-      WHERE user_id = ? AND description LIKE '%${card.card_number}%'\n-      ORDER BY created_at DESC\n-      LIMIT 20\n-    `, [card.bound_user_id]);\n-\n-    res.json({\n-      success: true,\n-      data: {\n-        card,\n-        usageHistory,\n-        summary: {\n-          totalUsed: card.total_points - card.remaining_points,\n-          usageCount: usageHistory.filter(log => log.action_type === 'consume').length\n-        }\n-      }\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// ç¦ç”¨/å¯ç”¨ç­‰çº§å¡ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n-router.put('/cards/:id/status', adminAuth, async (req, res, next) => {\n-  try {\n-    const cardId = req.params.id;\n-    const { status } = req.body;\n-\n-    if (!['active', 'disabled', 'expired'].includes(status)) {\n-      return res.status(400).json({\n-        success: false,\n-        message: 'æ— æ•ˆçš„ç­‰çº§å¡çŠ¶æ€'\n-      });\n-    }\n-\n-    await query(`\n-      UPDATE level_cards\n-      SET status = ?\n-      WHERE id = ?\n-    `, [status, cardId]);\n-\n-    res.json({\n-      success: true,\n-      message: 'ç­‰çº§å¡çŠ¶æ€æ›´æ–°æˆåŠŸ'\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// è§£ç»‘ç­‰çº§å¡ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n-router.put('/cards/:id/unbind', adminAuth, async (req, res, next) => {\n-  try {\n-    const cardId = req.params.id;\n-\n-    await query(`\n-      UPDATE level_cards\n-      SET bound_user_id = NULL, bound_at = NULL\n-      WHERE id = ?\n-    `, [cardId]);\n-\n-    res.json({\n-      success: true,\n-      message: 'ç­‰çº§å¡è§£ç»‘æˆåŠŸ'\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// è·å–ç§¯åˆ†è®°å½•åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰- å…¼å®¹æ–°å‰ç«¯è·¯å¾„\n-router.get('/points-logs', adminAuth, async (req, res, next) => {\n-  try {\n-    const page = parseInt(req.query.page) || 1;\n-    const pageSize = parseInt(req.query.pageSize) || 20;\n-    const offset = (page - 1) * pageSize;\n-    const actionType = req.query.type;\n-    const search = req.query.search;\n-\n-    let whereClause = '';\n-    let queryParams = [];\n-\n-    // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n-    const conditions = [];\n-    if (actionType) {\n-      conditions.push('pl.action_type = ?');\n-      queryParams.push(actionType);\n-    }\n-    if (search) {\n-      conditions.push('u.username LIKE ?');\n-      queryParams.push(`%${search}%`);\n-    }\n-\n-    if (conditions.length > 0) {\n-      whereClause = 'WHERE ' + conditions.join(' AND ');\n-    }\n-\n-    // è·å–ç§¯åˆ†è®°å½•æ€»æ•°\n-    const countQuery = `\n-      SELECT COUNT(*) as total\n-      FROM point_logs pl\n-      LEFT JOIN users u ON pl.user_id = u.id\n-      ${whereClause}\n-    `;\n-    const countResult = await query(countQuery, queryParams);\n-    const total = countResult[0].total;\n-\n-    // è·å–ç§¯åˆ†è®°å½•åˆ—è¡¨\n-    const pointsQuery = `\n-      SELECT pl.id, pl.action_type, pl.points_amount, pl.description, pl.url, pl.created_at,\n-             u.username, u.id as user_id\n-      FROM point_logs pl\n-      LEFT JOIN users u ON pl.user_id = u.id\n-      ${whereClause}\n-      ORDER BY pl.created_at DESC\n-      LIMIT ? OFFSET ?\n-    `;\n-\n-    const pointsLogs = await query(pointsQuery, [...queryParams, pageSize, offset]);\n-\n-    res.json({\n-      success: true,\n-      data: {\n-        items: pointsLogs,\n-        total,\n-        page,\n-        pageSize,\n-        totalPages: Math.ceil(total / pageSize)\n-      }\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// è·å–ç§¯åˆ†è®°å½•åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰- ä¿æŒåŸæœ‰æ¥å£å…¼å®¹æ€§\n-router.get('/points', adminAuth, async (req, res, next) => {\n-  try {\n-    const page = parseInt(req.query.page) || 1;\n-    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n-    const offset = (page - 1) * limit;\n-    const actionType = req.query.type;\n-    const search = req.query.search;\n-\n-    let whereClause = '';\n-    let queryParams = [];\n-\n-    // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n-    const conditions = [];\n-    if (actionType) {\n-      conditions.push('pl.action_type = ?');\n-      queryParams.push(actionType);\n-    }\n-    if (search) {\n-      conditions.push('u.username LIKE ?');\n-      queryParams.push(`%${search}%`);\n-    }\n-\n-    if (conditions.length > 0) {\n-      whereClause = 'WHERE ' + conditions.join(' AND ');\n-    }\n-\n-    // è·å–ç§¯åˆ†è®°å½•æ€»æ•°\n-    const countQuery = `\n-      SELECT COUNT(*) as total\n-      FROM point_logs pl\n-      LEFT JOIN users u ON pl.user_id = u.id\n-      ${whereClause}\n-    `;\n-    const countResult = await query(countQuery, queryParams);\n-    const total = countResult[0].total;\n-\n-    // è·å–ç§¯åˆ†è®°å½•åˆ—è¡¨\n-    const pointsQuery = `\n-      SELECT pl.id, pl.action_type, pl.points_amount, pl.description, pl.url, pl.created_at,\n-             u.username, u.id as user_id\n-      FROM point_logs pl\n-      LEFT JOIN users u ON pl.user_id = u.id\n-      ${whereClause}\n-      ORDER BY pl.created_at DESC\n-      LIMIT ? OFFSET ?\n-    `;\n-\n-    const pointsLogs = await query(pointsQuery, [...queryParams, limit, offset]);\n-\n-    res.json({\n-      success: true,\n-      data: {\n-        items: pointsLogs,\n-        total,\n-        page,\n-        pageSize: limit,\n-        totalPages: Math.ceil(total / limit)\n-      }\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// è·å–ç³»ç»Ÿé…ç½®ä¿¡æ¯ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n-router.get('/config', adminAuth, async (req, res, next) => {\n-  try {\n-    console.log('ğŸ“¥ ä»æ•°æ®åº“åŠ è½½ç³»ç»Ÿé…ç½®...');\n-\n-    // ä»æ•°æ®åº“è·å–æ‰€æœ‰é…ç½®\n-    const configs = await query(`\n-      SELECT config_key, config_value, config_type, config_group, description, is_encrypted\n-      FROM system_config\n-      ORDER BY config_group, config_key\n-    `);\n-\n-    console.log(`ğŸ“Š ä»æ•°æ®åº“åŠ è½½äº†${configs.length}é¡¹é…ç½®`);\n-\n-    // æŒ‰åˆ†ç»„ç»„ç»‡é…ç½®\n-    const groupedConfigs = {};\n-    configs.forEach(config => {\n-      const group = config.config_group || 'general';\n-\n-      if (!groupedConfigs[group]) {\n-        groupedConfigs[group] = [];\n-      }\n-\n-      // å¤„ç†æ•æ„Ÿé…ç½®æ˜¾ç¤º\n-      let displayValue = config.config_value;\n-      if (config.is_encrypted && config.config_value) {\n-        // å¯¹äºæ•æ„Ÿé…ç½®ï¼Œæ˜¾ç¤ºæ©ç \n-        if (config.config_key.includes('password') || config.config_key.includes('secret')) {\n-          displayValue = '***';\n-        }\n-      }\n-\n-      groupedConfigs[group].push({\n-        config_key: config.config_key,\n-        config_value: displayValue,\n-        config_type: config.config_type || 'string',\n-        description: config.description || '',\n-        is_encrypted: config.is_encrypted || 0\n-      });\n-    });\n-\n-    // ç¡®ä¿æ‰€æœ‰å¿…è¦çš„åˆ†ç»„éƒ½å­˜åœ¨\n-    const requiredGroups = ['server', 'database', 'jwt', 'comfyui', 'ai', 'frontend', 'cors', 'upload', 'log'];\n-    requiredGroups.forEach(group => {\n-      if (!groupedConfigs[group]) {\n-        groupedConfigs[group] = [];\n-      }\n-    });\n-\n-    console.log('ğŸ“‹ é…ç½®åˆ†ç»„ç»Ÿè®¡:');\n-    Object.keys(groupedConfigs).forEach(group => {\n-      console.log(`   ${group}: ${groupedConfigs[group].length} é¡¹é…ç½®`);\n-    });\n-\n-    res.json({\n-      success: true,\n-      data: groupedConfigs\n-    });\n-\n-  } catch (error) {\n-    console.error('âŒ åŠ è½½é…ç½®å¤±è´¥:', error);\n-    res.status(500).json({\n-      success: false,\n-      message: 'åŠ è½½é…ç½®å¤±è´¥: ' + error.message\n-    });\n-  }\n-});\n-\n-// ä¿å­˜ç³»ç»Ÿé…ç½®ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n-router.post('/config', adminAuth, async (req, res, next) => {\n-  try {\n-    const { configs } = req.body;\n-\n-    if (!configs || !Array.isArray(configs)) {\n-      return res.status(400).json({\n-        success: false,\n-        message: 'é…ç½®æ•°æ®æ ¼å¼é”™è¯¯'\n-      });\n-    }\n-\n-    console.log('ğŸ’¾ ä¿å­˜ç³»ç»Ÿé…ç½®åˆ°æ•°æ®åº“ï¼Œå…±', configs.length, 'é¡¹');\n-\n-    // çœŸæ­£ä¿å­˜é…ç½®åˆ°æ•°æ®åº“\n-    const results = [];\n-    let successCount = 0;\n-    let errorCount = 0;\n-\n-    for (const config of configs) {\n-      const { config_key, config_value } = config;\n-\n-      try {\n-        // æ›´æ–°æ•°æ®åº“ä¸­çš„é…ç½®\n-        const result = await query(`\n-          UPDATE system_config\n-          SET config_value = ?, updated_at = NOW()\n-          WHERE config_key = ?\n-        `, [config_value, config_key]);\n-\n-        if (result.affectedRows > 0) {\n-          console.log(`  âœ… ä¿å­˜æˆåŠŸ: ${config_key} = ${config_value}`);\n-          results.push({\n-            config_key,\n-            updated: true,\n-            message: 'æ›´æ–°æˆåŠŸ'\n-          });\n-          successCount++;\n-        } else {\n-          // å¦‚æœæ²¡æœ‰æ‰¾åˆ°é…ç½®é¡¹ï¼Œå°è¯•æ’å…¥æ–°çš„\n-          try {\n-            await query(`\n-              INSERT INTO system_config (config_key, config_value, config_type, config_group, description)\n-              VALUES (?, ?, 'string', 'custom', 'ç”¨æˆ·è‡ªå®šä¹‰é…ç½®')\n-            `, [config_key, config_value]);\n-\n-            console.log(`  âœ… æ–°å¢æˆåŠŸ: ${config_key} = ${config_value}`);\n-            results.push({\n-              config_key,\n-              updated: true,\n-              message: 'æ–°å¢æˆåŠŸ'\n-            });\n-            successCount++;\n-          } catch (insertError) {\n-            console.log(`  âŒ æ–°å¢å¤±è´¥: ${config_key} - ${insertError.message}`);\n-            results.push({\n-              config_key,\n-              updated: false,\n-              message: 'æ–°å¢å¤±è´¥: ' + insertError.message\n-            });\n-            errorCount++;\n-          }\n-        }\n-      } catch (updateError) {\n-        console.log(`  âŒ æ›´æ–°å¤±è´¥: ${config_key} - ${updateError.message}`);\n-        results.push({\n-          config_key,\n-          updated: false,\n-          message: 'æ›´æ–°å¤±è´¥: ' + updateError.message\n-        });\n-        errorCount++;\n-      }\n-    }\n-\n-    const message = `é…ç½®ä¿å­˜å®Œæˆ: ${successCount}é¡¹æˆåŠŸ, ${errorCount}é¡¹å¤±è´¥`;\n-    console.log('ğŸ“Š', message);\n-\n-    res.json({\n-      success: errorCount === 0,\n-      message: message,\n-      data: {\n-        results,\n-        summary: {\n-          total: configs.length,\n-          success: successCount,\n-          error: errorCount\n-        }\n-      }\n-    });\n-\n-  } catch (error) {\n-    console.error('âŒ ä¿å­˜é…ç½®å¤±è´¥:', error);\n-    res.status(500).json({\n-      success: false,\n-      message: 'ä¿å­˜é…ç½®å¤±è´¥: ' + error.message\n-    });\n-  }\n-});\n-\n-// æ‰¹é‡æ“ä½œç”¨æˆ·çŠ¶æ€ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n-router.put('/users/batch-status', adminAuth, async (req, res, next) => {\n-  try {\n-    const { userIds, status } = req.body;\n-\n-    if (!Array.isArray(userIds) || userIds.length === 0) {\n-      return res.status(400).json({\n-        success: false,\n-        message: 'è¯·æä¾›æœ‰æ•ˆçš„ç”¨æˆ·IDåˆ—è¡¨'\n-      });\n-    }\n-\n-    if (!['active', 'inactive', 'banned'].includes(status)) {\n-      return res.status(400).json({\n-        success: false,\n-        message: 'æ— æ•ˆçš„ç”¨æˆ·çŠ¶æ€'\n-      });\n-    }\n-\n-    const placeholders = userIds.map(() => '?').join(',');\n-    await query(`\n-      UPDATE users\n-      SET status = ?, updated_at = NOW()\n-      WHERE id IN (${placeholders})\n-    `, [status, ...userIds]);\n-\n-    res.json({\n-      success: true,\n-      message: `æˆåŠŸæ›´æ–°${userIds.length}ä¸ªç”¨æˆ·çš„çŠ¶æ€`\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// ç”Ÿæˆç­‰çº§å¡ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n-router.post('/generate-cards', adminAuth, async (req, res, next) => {\n-  try {\n-    const { cardTypeId, count = 5 } = req.body;\n-\n-    if (!cardTypeId) {\n-      return res.status(400).json({\n-        success: false,\n-        message: 'è¯·é€‰æ‹©ç­‰çº§å¡ç±»å‹'\n-      });\n-    }\n-\n-    if (!count || count <= 0 || count > 100) {\n-      return res.status(400).json({\n-        success: false,\n-        message: 'ç”Ÿæˆæ•°é‡å¿…é¡»åœ¨1-100ä¹‹é—´'\n-      });\n-    }\n-\n-    console.log(`ğŸ« å¼€å§‹ç”Ÿæˆ${count}å¼ ç­‰çº§å¡ï¼Œç±»å‹ID: ${cardTypeId}...`);\n-\n-    // ç¡®ä¿level_cardsè¡¨å­˜åœ¨\n-    await query(`\n-      CREATE TABLE IF NOT EXISTS level_cards (\n-        id INT AUTO_INCREMENT PRIMARY KEY,\n-        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT 'å¡å·',\n-        card_password VARCHAR(20) NOT NULL COMMENT 'å¡å¯†',\n-        type_id INT NOT NULL COMMENT 'ç­‰çº§å¡ç±»å‹ID',\n-        total_points INT NOT NULL COMMENT 'æ€»ç§¯åˆ†',\n-        remaining_points INT NOT NULL COMMENT 'å‰©ä½™ç§¯åˆ†',\n-        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT 'çŠ¶æ€',\n-        bound_user_id INT NULL COMMENT 'ç»‘å®šçš„ç”¨æˆ·ID',\n-        bound_at DATETIME NULL COMMENT 'ç»‘å®šæ—¶é—´',\n-        expires_at DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´',\n-        created_at DATETIME NOT NULL,\n-        updated_at DATETIME NULL,\n-        INDEX idx_card_number (card_number),\n-        INDEX idx_bound_user (bound_user_id),\n-        INDEX idx_status (status)\n-      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-    `);\n-\n-    // è·å–å¡ç‰‡ç±»å‹ä¿¡æ¯\n-    const cardTypeResult = await query(`\n-      SELECT id, name, points, price, description\n-      FROM level_card_types\n-      WHERE id = ?\n-    `, [cardTypeId]);\n-\n-    if (cardTypeResult.length === 0) {\n-      return res.status(400).json({\n-        success: false,\n-        message: 'æ— æ•ˆçš„å¡ç‰‡ç±»å‹'\n-      });\n-    }\n-\n-    const typeInfo = cardTypeResult[0];\n-    const generatedCards = [];\n-\n-    // æ‰¹é‡ç”Ÿæˆç­‰çº§å¡\n-    for (let i = 1; i <= count; i++) {\n-      const cardNumber = generateCardNumber(typeInfo.name, i);\n-      const cardPassword = generateCardPassword();\n-\n-      await query(`\n-        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n-        VALUES (?, ?, ?, ?, NOW())\n-      `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n-\n-      generatedCards.push({\n-        cardNumber,\n-        cardPassword,\n-        typeName: typeInfo.name,\n-        points: typeInfo.points,\n-        price: typeInfo.price\n-      });\n-    }\n-\n-    console.log(`âœ… æˆåŠŸç”Ÿæˆ${count}å¼ ${typeInfo.name}`);\n-\n-    res.json({\n-      success: true,\n-      message: `æˆåŠŸç”Ÿæˆ${count}å¼ ${typeInfo.name}`,\n-      data: {\n-        cards: generatedCards,\n-        cardType: typeInfo.name,\n-        totalGenerated: count\n-      }\n-    });\n-\n-  } catch (error) {\n-    console.error('âŒ ç”Ÿæˆç­‰çº§å¡å¤±è´¥:', error);\n-    next(error);\n-  }\n-});\n-\n-// ç”Ÿæˆä½“éªŒå¡\n-router.post('/generate-experience-cards', adminAuth, async (req, res, next) => {\n-  try {\n-    const { count = 1 } = req.body;\n-    console.log(`ğŸ« ç®¡ç†å‘˜è¯·æ±‚ç”Ÿæˆ${count}å¼ ä½“éªŒå¡...`);\n-\n-    // è·å–ä½“éªŒå¡ç±»å‹ä¿¡æ¯ - ä¿®å¤è¡¨åï¼Œéµå¾ªå¼€å‘åŸåˆ™\n-    const cardTypeResult = await query(`\n-      SELECT id, name, points, price\n-      FROM card_types\n-      WHERE name = 'ä½“éªŒå¡'\n-    `);\n-\n-    if (cardTypeResult.length === 0) {\n-      return res.status(400).json({\n-        success: false,\n-        message: 'ä½“éªŒå¡ç±»å‹ä¸å­˜åœ¨'\n-      });\n-    }\n-\n-    const typeInfo = cardTypeResult[0];\n-    const generatedCards = [];\n-\n-    // æ‰¹é‡ç”Ÿæˆä½“éªŒå¡\n-    for (let i = 1; i <= count; i++) {\n-      const cardNumber = generateCardNumber('ä½“éªŒå¡', i);\n-      const cardPassword = generateCardPassword();\n-\n-      await query(`\n-        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n-        VALUES (?, ?, ?, ?, NOW())\n-      `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n-\n-      generatedCards.push({\n-        cardNumber,\n-        cardPassword,\n-        typeName: typeInfo.name,\n-        points: typeInfo.points\n-      });\n-    }\n-\n-    console.log(`âœ… æˆåŠŸç”Ÿæˆ${count}å¼ ä½“éªŒå¡`);\n-\n-    res.json({\n-      success: true,\n-      message: `æˆåŠŸç”Ÿæˆ${count}å¼ ä½“éªŒå¡`,\n-      data: {\n-        cards: generatedCards,\n-        cardType: typeInfo.name,\n-        totalGenerated: count\n-      }\n-    });\n-\n-  } catch (error) {\n-    console.error('âŒ ç”Ÿæˆä½“éªŒå¡å¤±è´¥:', error);\n-    next(error);\n-  }\n-});\n-\n-// è·å–ä½“éªŒå¡ç»Ÿè®¡ä¿¡æ¯\n-router.get('/experience-cards-stats', adminAuth, async (req, res, next) => {\n-  try {\n-    // è·å–ä½“éªŒå¡ç»Ÿè®¡\n-    const stats = await query(`\n-      SELECT\n-        COUNT(*) as total_cards,\n-        COUNT(CASE WHEN bound_user_id IS NULL THEN 1 END) as available_cards,\n-        COUNT(CASE WHEN bound_user_id IS NOT NULL THEN 1 END) as bound_cards,\n-        SUM(CASE WHEN bound_user_id IS NULL THEN remaining_points ELSE 0 END) as available_points,\n-        SUM(CASE WHEN bound_user_id IS NOT NULL THEN remaining_points ELSE 0 END) as bound_points\n-      FROM level_cards lc\n-      JOIN level_card_types ct ON lc.type_id = ct.id\n-      WHERE ct.name = 'ä½“éªŒå¡'\n-    `);\n-\n-    // è·å–å¯ç”¨ä½“éªŒå¡åˆ—è¡¨\n-    const availableCards = await getAvailableExperienceCards();\n-\n-    res.json({\n-      success: true,\n-      data: {\n-        stats: stats[0],\n-        availableCards: availableCards.slice(0, 10) // åªè¿”å›å‰10å¼ ä½œä¸ºç¤ºä¾‹\n-      }\n-    });\n-\n-  } catch (error) {\n-    next(error);\n-  }\n-});\n-\n-// æµ‹è¯•æ•°æ®åº“è¿æ¥ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n-router.post('/test-database', adminAuth, async (req, res, next) => {\n-  try {\n-    // ç®€å•çš„æ•°æ®åº“è¿æ¥æµ‹è¯•\n-    await query('SELECT 1 as test');\n-\n-    res.json({\n-      success: true,\n-      message: 'æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ'\n-    });\n-\n-  } catch (error) {\n-    console.error('âŒ æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥:', error);\n-    res.status(500).json({\n-      success: false,\n-      message: 'æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message\n-    });\n-  }\n-});\n-\n-// æµ‹è¯•ComfyUIè¿æ¥ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n-router.post('/test-comfyui', adminAuth, async (req, res, next) => {\n-  try {\n-    // ä»è¯·æ±‚ä½“è·å–æœåŠ¡å™¨åœ°å€ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤é…ç½®\n-    let serverUrl = req.body?.serverUrl;\n-\n-    // å¦‚æœæ²¡æœ‰æä¾›æœåŠ¡å™¨åœ°å€ï¼Œä»æ•°æ®åº“è·å–é…ç½®\n-    if (!serverUrl) {\n-      try {\n-        const [configRows] = await query(\n-          'SELECT config_value FROM system_config WHERE config_key = ?',\n-          ['comfyui.server_url']\n-        );\n-        serverUrl = configRows.length > 0 ? configRows[0].config_value : 'https://your-comfyui-server.com';\n-      } catch (dbError) {\n-        console.error('è·å–ComfyUIé…ç½®å¤±è´¥:', dbError);\n-        serverUrl = 'https://your-comfyui-server.com';\n-      }\n-    }\n-\n-    // ç¡®ä¿URLæ ¼å¼æ­£ç¡®\n-    if (serverUrl && !serverUrl.startsWith('http')) {\n-      serverUrl = 'https://' + serverUrl;\n-    }\n-\n-    // ç§»é™¤æœ«å°¾çš„æ–œæ \n-    if (serverUrl && serverUrl.endsWith('/')) {\n-      serverUrl = serverUrl.slice(0, -1);\n-    }\n-\n-    console.log('ğŸ§ª æµ‹è¯•ComfyUIè¿æ¥:', serverUrl);\n-\n-    // æµ‹è¯•ComfyUIè¿æ¥\n-    const fetch = require('node-fetch');\n-\n-    // å°è¯•å¤šä¸ªç«¯ç‚¹æ¥æ£€æµ‹ComfyUIæœåŠ¡å™¨\n-    const testEndpoints = [\n-      `${serverUrl}/system_stats`,  // ComfyUIç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n-      `${serverUrl}/history`,       // ComfyUIå†å²è®°å½•ç«¯ç‚¹\n-      `${serverUrl}/`,              // æ ¹è·¯å¾„\n-    ];\n-\n-    let lastError = null;\n-    let response = null;\n-\n-    // ä¾æ¬¡å°è¯•ä¸åŒçš„ç«¯ç‚¹\n-    for (const testUrl of testEndpoints) {\n-      try {\n-        console.log(`ğŸ” å°è¯•ç«¯ç‚¹: ${testUrl}`);\n-\n-        response = await fetch(testUrl, {\n-          method: 'GET',\n-          timeout: 10000,\n-          headers: {\n-            'User-Agent': 'ComfyUI-Admin-Test/1.0'\n-          }\n-        });\n-\n-        console.log(`ğŸ“¡ ç«¯ç‚¹ ${testUrl} å“åº”çŠ¶æ€:`, response.status, response.statusText);\n-\n-        // å¦‚æœå¾—åˆ°å“åº”ï¼ˆå³ä½¿æ˜¯é”™è¯¯çŠ¶æ€ç ï¼‰ï¼Œè¯´æ˜æœåŠ¡å™¨æ˜¯å¯è¾¾çš„\n-        if (response) {\n-          break;\n-        }\n-      } catch (error) {\n-        console.log(`âŒ ç«¯ç‚¹ ${testUrl} å¤±è´¥:`, error.message);\n-        lastError = error;\n-        continue;\n-      }\n-    }\n-\n-    // å¦‚æœæ‰€æœ‰ç«¯ç‚¹éƒ½å¤±è´¥äº†\n-    if (!response) {\n-      throw lastError || new Error('æ‰€æœ‰æµ‹è¯•ç«¯ç‚¹éƒ½æ— æ³•è®¿é—®');\n-    }\n-\n-    if (response.status === 200) {\n-      // æœåŠ¡å™¨æ­£å¸¸å“åº”\n-      res.json({\n-        success: true,\n-        message: 'ComfyUIæœåŠ¡å™¨è¿æ¥æˆåŠŸ',\n-        data: {\n-          serverUrl,\n-          status: 'connected',\n-          statusCode: response.status,\n-          message: 'æœåŠ¡å™¨å¯æ­£å¸¸è®¿é—®'\n-        }\n-      });\n-    } else if (response.status === 401) {\n-      // æœåŠ¡å™¨éœ€è¦è®¤è¯ï¼Œä½†å¯ä»¥è¿æ¥\n-      res.json({\n-        success: true,\n-        message: 'ComfyUIæœåŠ¡å™¨è¿æ¥æˆåŠŸï¼ˆéœ€è¦è®¤è¯ï¼‰',\n-        data: {\n-          serverUrl,\n-          status: 'connected_auth_required',\n-          statusCode: response.status,\n-          message: 'æœåŠ¡å™¨å¯è®¿é—®ï¼Œä½†éœ€è¦è®¤è¯'\n-        }\n-      });\n-    } else if (response.status === 404) {\n-      // è·¯å¾„ä¸å­˜åœ¨ï¼Œä½†æœåŠ¡å™¨å¯è¾¾\n-      res.json({\n-        success: true,\n-        message: 'ComfyUIæœåŠ¡å™¨è¿æ¥æˆåŠŸ',\n-        data: {\n-          serverUrl,\n-          status: 'connected',\n-          statusCode: response.status,\n-          message: 'æœåŠ¡å™¨å¯è®¿é—®ï¼ˆè·¯å¾„ä¸å­˜åœ¨æ˜¯æ­£å¸¸çš„ï¼‰'\n-        }\n-      });\n-    } else {\n-      // å…¶ä»–çŠ¶æ€ç \n-      res.json({\n-        success: false,\n-        message: `ComfyUIæœåŠ¡å™¨å“åº”å¼‚å¸¸: ${response.status} ${response.statusText}`,\n-        data: {\n-          serverUrl,\n-          status: 'error',\n-          statusCode: response.status\n-        }\n-      });\n-    }\n-\n-  } catch (error) {\n-    console.error('âŒ ComfyUIè¿æ¥æµ‹è¯•å¤±è´¥:', error);\n-\n-    if (error.code === 'ENOTFOUND') {\n-      res.status(500).json({\n-        success: false,\n-        message: 'ComfyUIæœåŠ¡å™¨åŸŸåæ— æ³•è§£æï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®',\n-        data: {\n-          serverUrl: serverUrl || 'unknown',\n-          status: 'dns_error',\n-          error: error.code,\n-          message: 'Domain name resolution failed'\n-        }\n-      });\n-    } else if (error.code === 'ECONNREFUSED') {\n-      res.status(500).json({\n-        success: false,\n-        message: 'ComfyUIæœåŠ¡å™¨æ‹’ç»è¿æ¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ',\n-        data: {\n-          serverUrl: serverUrl || 'unknown',\n-          status: 'connection_refused',\n-          error: error.code,\n-          message: 'Connection refused by server'\n-        }\n-      });\n-    } else if (error.name === 'AbortError' || error.message.includes('timeout')) {\n-      res.status(500).json({\n-        success: false,\n-        message: 'ComfyUIæœåŠ¡å™¨è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',\n-        data: {\n-          serverUrl: serverUrl || 'unknown',\n-          status: 'timeout',\n-          error: 'timeout',\n-          message: 'Connection timeout'\n-        }\n-      });\n-    } else {\n-      res.status(500).json({\n-        success: false,\n-        message: 'ComfyUIè¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message,\n-        data: {\n-          serverUrl: serverUrl || 'unknown',\n-          status: 'error',\n-          error: error.message,\n-          message: 'Unknown connection error'\n-        }\n-      });\n-    }\n-  }\n-});\n-\n-// ç”Ÿæˆå¡å¯†å‡½æ•°å·²åœ¨æ–‡ä»¶å¼€å¤´å®šä¹‰ï¼Œè¿™é‡Œåˆ é™¤é‡å¤å®šä¹‰\n-\n-module.exports = router;\n"
                },
                {
                    "date": 1752347574386,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -498,9 +498,9 @@\n     // è·å–ç­‰çº§å¡æ€»æ•°\n     const countQuery = `\n       SELECT COUNT(*) as total\n       FROM level_cards lc\n-      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN card_types ct ON lc.type_id = ct.id\n       LEFT JOIN users u ON lc.bound_user_id = u.id\n       ${whereClause}\n     `;\n     const countResult = await query(countQuery, queryParams);\n"
                },
                {
                    "date": 1752347588579,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -512,9 +512,9 @@\n              lc.bound_at, lc.created_at,\n              ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n              u.username as bound_username, u.id as bound_user_id\n       FROM level_cards lc\n-      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN card_types ct ON lc.type_id = ct.id\n       LEFT JOIN users u ON lc.bound_user_id = u.id\n       ${whereClause}\n       ORDER BY lc.created_at DESC\n       LIMIT ? OFFSET ?\n"
                },
                {
                    "date": 1752347601083,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -549,9 +549,9 @@\n              lc.bound_at, lc.created_at,\n              ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n              u.username as bound_username, u.id as bound_user_id, u.email as bound_user_email\n       FROM level_cards lc\n-      LEFT JOIN level_card_types ct ON lc.type_id = ct.id\n+      LEFT JOIN card_types ct ON lc.type_id = ct.id\n       LEFT JOIN users u ON lc.bound_user_id = u.id\n       WHERE lc.id = ?\n     `, [cardId]);\n \n"
                },
                {
                    "date": 1752347651861,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -420,9 +420,9 @@\n       console.log('âš ï¸ ç­‰çº§å¡ç±»å‹è¡¨ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º...');\n \n       // åˆ›å»ºè¡¨å’Œåˆå§‹æ•°æ®\n       await query(`\n-        CREATE TABLE IF NOT EXISTS level_card_types (\n+        CREATE TABLE IF NOT EXISTS card_types (\n           id INT AUTO_INCREMENT PRIMARY KEY,\n           name VARCHAR(50) NOT NULL COMMENT 'ç­‰çº§å¡åç§°',\n           icon VARCHAR(10) NOT NULL COMMENT 'ç­‰çº§å¡å›¾æ ‡',\n           price DECIMAL(10,2) NOT NULL COMMENT 'ä»·æ ¼',\n@@ -434,9 +434,9 @@\n       `);\n \n       // æ’å…¥åˆå§‹æ•°æ®\n       await query(`\n-        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n+        INSERT INTO card_types (name, icon, price, points, description) VALUES\n         ('ä½“éªŒå¡', 'ğŸ', 0.00, 20, 'å…è´¹ä½“éªŒå¡ï¼Œæ¯å¼ 20ç§¯åˆ†'),\n         ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300, 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n         ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000, 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n         ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000, 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·')\n@@ -444,9 +444,9 @@\n \n       // é‡æ–°è·å–æ•°æ®\n       const cardTypes = await query(`\n         SELECT id, name, icon, points, price, description\n-        FROM level_card_types\n+        FROM card_types\n         ORDER BY points ASC\n       `);\n \n       console.log('âœ… è¡¨åˆ›å»ºæˆåŠŸï¼Œè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n"
                },
                {
                    "date": 1752347679931,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -314,9 +314,9 @@\n \n     // 1. åˆ›å»ºç­‰çº§å¡ç±»å‹è¡¨\n     console.log('ğŸ“ åˆ›å»ºç­‰çº§å¡ç±»å‹è¡¨...');\n     await query(`\n-      CREATE TABLE IF NOT EXISTS level_card_types (\n+      CREATE TABLE IF NOT EXISTS card_types (\n         id INT AUTO_INCREMENT PRIMARY KEY,\n         name VARCHAR(50) NOT NULL COMMENT 'ç­‰çº§å¡åç§°',\n         icon VARCHAR(10) NOT NULL COMMENT 'ç­‰çº§å¡å›¾æ ‡',\n         price DECIMAL(10,2) NOT NULL COMMENT 'ä»·æ ¼',\n"
                },
                {
                    "date": 1752347695895,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -373,12 +373,12 @@\n     `);\n     console.log('âœ… ç­‰çº§å¡äº¤æ˜“è®°å½•è¡¨åˆ›å»ºæˆåŠŸ');\n \n     // 4. æ’å…¥ç­‰çº§å¡ç±»å‹æ•°æ®ï¼ˆåŒ…å«ä½“éªŒå¡ï¼‰\n-    const existingTypes = await query('SELECT COUNT(*) as count FROM level_card_types');\n+    const existingTypes = await query('SELECT COUNT(*) as count FROM card_types');\n     if (existingTypes[0].count === 0) {\n       await query(`\n-        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n+        INSERT INTO card_types (name, icon, price, points, description) VALUES\n         ('ä½“éªŒå¡', 'ğŸ', 0.00, 20, 'å…è´¹ä½“éªŒå¡ï¼Œæ¯å¼ 20ç§¯åˆ†'),\n         ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300, 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n         ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000, 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n         ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000, 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·')\n"
                },
                {
                    "date": 1752460685118,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -343,9 +343,9 @@\n         bound_at DATETIME NULL COMMENT 'ç»‘å®šæ—¶é—´',\n         expires_at DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´',\n         created_at DATETIME NOT NULL,\n         updated_at DATETIME NULL,\n-        FOREIGN KEY (type_id) REFERENCES level_card_types(id),\n+        FOREIGN KEY (type_id) REFERENCES card_types(id),\n         FOREIGN KEY (bound_user_id) REFERENCES users(id),\n         INDEX idx_card_number (card_number),\n         INDEX idx_bound_user (bound_user_id),\n         INDEX idx_status (status)\n"
                },
                {
                    "date": 1752460809707,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1019,9 +1019,9 @@\n \n     // è·å–å¡ç‰‡ç±»å‹ä¿¡æ¯\n     const cardTypeResult = await query(`\n       SELECT id, name, points, price, description\n-      FROM level_card_types\n+      FROM card_types\n       WHERE id = ?\n     `, [cardTypeId]);\n \n     if (cardTypeResult.length === 0) {\n"
                },
                {
                    "date": 1752548154247,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1216,13 +1216,12 @@\n \n     // æµ‹è¯•ComfyUIè¿æ¥\n     const fetch = require('node-fetch');\n \n-    // å°è¯•å¤šä¸ªç«¯ç‚¹æ¥æ£€æµ‹ComfyUIæœåŠ¡å™¨\n+    // ä½¿ç”¨ComfyUIå®˜æ–¹ç«¯ç‚¹è¿›è¡Œæ£€æµ‹\n     const testEndpoints = [\n-      `${serverUrl}/system_stats`,  // ComfyUIç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n-      `${serverUrl}/history`,       // ComfyUIå†å²è®°å½•ç«¯ç‚¹\n-      `${serverUrl}/`,              // æ ¹è·¯å¾„\n+      `${serverUrl}/api/queue`,        // ComfyUIå®˜æ–¹é˜Ÿåˆ—ç«¯ç‚¹\n+      `${serverUrl}/api/system_stats`, // ComfyUIå®˜æ–¹ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n     ];\n \n     let lastError = null;\n     let response = null;\n"
                },
                {
                    "date": 1752810925519,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -813,9 +813,9 @@\n       });\n     });\n \n     // ç¡®ä¿æ‰€æœ‰å¿…è¦çš„åˆ†ç»„éƒ½å­˜åœ¨\n-    const requiredGroups = ['server', 'database', 'jwt', 'comfyui', 'ai', 'frontend', 'cors', 'upload', 'log'];\n+    const requiredGroups = ['server', 'database', 'jwt', 'comfyui', 'ai', 'frontend', 'cors', 'upload', 'log', 'workflow'];\n     requiredGroups.forEach(group => {\n       if (!groupedConfigs[group]) {\n         groupedConfigs[group] = [];\n       }\n"
                },
                {
                    "date": 1752977977111,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1042,16 +1042,8 @@\n       await query(`\n         INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n         VALUES (?, ?, ?, ?, NOW())\n       `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n-\n-      generatedCards.push({\n-        cardNumber,\n-        cardPassword,\n-        typeName: typeInfo.name,\n-        points: typeInfo.points,\n-        price: typeInfo.price\n-      });\n     }\n \n     console.log(`âœ… æˆåŠŸç”Ÿæˆ${count}å¼ ${typeInfo.name}`);\n \n@@ -1359,4 +1351,5 @@\n \n // ç”Ÿæˆå¡å¯†å‡½æ•°å·²åœ¨æ–‡ä»¶å¼€å¤´å®šä¹‰ï¼Œè¿™é‡Œåˆ é™¤é‡å¤å®šä¹‰\n \n module.exports = router;\n+\n"
                },
                {
                    "date": 1752978249568,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -977,76 +977,83 @@\n \n // ç”Ÿæˆç­‰çº§å¡ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n router.post('/generate-cards', adminAuth, async (req, res, next) => {\n   try {\n+    console.log('ğŸ« æ”¶åˆ°ç”Ÿæˆç­‰çº§å¡è¯·æ±‚ï¼Œè¯·æ±‚ä½“:', req.body);\n+\n     const { cardTypeId, count = 5 } = req.body;\n \n     if (!cardTypeId) {\n+      console.log('âŒ ç¼ºå°‘cardTypeIdå‚æ•°');\n       return res.status(400).json({\n         success: false,\n         message: 'è¯·é€‰æ‹©ç­‰çº§å¡ç±»å‹'\n       });\n     }\n \n     if (!count || count <= 0 || count > 100) {\n+      console.log('âŒ countå‚æ•°æ— æ•ˆ:', count);\n       return res.status(400).json({\n         success: false,\n         message: 'ç”Ÿæˆæ•°é‡å¿…é¡»åœ¨1-100ä¹‹é—´'\n       });\n     }\n \n     console.log(`ğŸ« å¼€å§‹ç”Ÿæˆ${count}å¼ ç­‰çº§å¡ï¼Œç±»å‹ID: ${cardTypeId}...`);\n \n-    // ç¡®ä¿level_cardsè¡¨å­˜åœ¨\n-    await query(`\n-      CREATE TABLE IF NOT EXISTS level_cards (\n-        id INT AUTO_INCREMENT PRIMARY KEY,\n-        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT 'å¡å·',\n-        card_password VARCHAR(20) NOT NULL COMMENT 'å¡å¯†',\n-        type_id INT NOT NULL COMMENT 'ç­‰çº§å¡ç±»å‹ID',\n-        total_points INT NOT NULL COMMENT 'æ€»ç§¯åˆ†',\n-        remaining_points INT NOT NULL COMMENT 'å‰©ä½™ç§¯åˆ†',\n-        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT 'çŠ¶æ€',\n-        bound_user_id INT NULL COMMENT 'ç»‘å®šçš„ç”¨æˆ·ID',\n-        bound_at DATETIME NULL COMMENT 'ç»‘å®šæ—¶é—´',\n-        expires_at DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´',\n-        created_at DATETIME NOT NULL,\n-        updated_at DATETIME NULL,\n-        INDEX idx_card_number (card_number),\n-        INDEX idx_bound_user (bound_user_id),\n-        INDEX idx_status (status)\n-      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-    `);\n-\n     // è·å–å¡ç‰‡ç±»å‹ä¿¡æ¯\n+    console.log('ğŸ“‹ æŸ¥è¯¢å¡ç‰‡ç±»å‹ä¿¡æ¯...');\n     const cardTypeResult = await query(`\n       SELECT id, name, points, price, description\n       FROM card_types\n       WHERE id = ?\n     `, [cardTypeId]);\n \n+    console.log('ğŸ“‹ å¡ç‰‡ç±»å‹æŸ¥è¯¢ç»“æœ:', cardTypeResult);\n+\n     if (cardTypeResult.length === 0) {\n+      console.log('âŒ å¡ç‰‡ç±»å‹ä¸å­˜åœ¨:', cardTypeId);\n       return res.status(400).json({\n         success: false,\n         message: 'æ— æ•ˆçš„å¡ç‰‡ç±»å‹'\n       });\n     }\n \n     const typeInfo = cardTypeResult[0];\n+    console.log('âœ… æ‰¾åˆ°å¡ç‰‡ç±»å‹:', typeInfo);\n+\n     const generatedCards = [];\n \n     // æ‰¹é‡ç”Ÿæˆç­‰çº§å¡\n     for (let i = 1; i <= count; i++) {\n-      const cardNumber = generateCardNumber(typeInfo.name, i);\n-      const cardPassword = generateCardPassword();\n+      try {\n+        const cardNumber = generateCardNumber(typeInfo.name, i);\n+        const cardPassword = generateCardPassword();\n \n-      await query(`\n-        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n-        VALUES (?, ?, ?, ?, NOW())\n-      `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+        console.log(`ğŸ“ ç”Ÿæˆç¬¬${i}å¼ å¡: ${cardNumber} - ${cardPassword}`);\n+\n+        // æ ¹æ®å®é™…è¡¨ç»“æ„æ’å…¥æ•°æ®ï¼ˆä¸åŒ…å«total_pointså­—æ®µï¼‰\n+        await query(`\n+          INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n+          VALUES (?, ?, ?, ?, NOW())\n+        `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+\n+        generatedCards.push({\n+          cardNumber,\n+          cardPassword,\n+          typeName: typeInfo.name,\n+          points: typeInfo.points,\n+          price: typeInfo.price\n+        });\n+\n+        console.log(`âœ… ç¬¬${i}å¼ å¡ç”ŸæˆæˆåŠŸ`);\n+      } catch (insertError) {\n+        console.error(`âŒ ç”Ÿæˆç¬¬${i}å¼ å¡å¤±è´¥:`, insertError);\n+        throw insertError;\n+      }\n     }\n \n-    console.log(`âœ… æˆåŠŸç”Ÿæˆ${count}å¼ ${typeInfo.name}`);\n+    console.log(`ğŸ‰ æˆåŠŸç”Ÿæˆ${count}å¼ ${typeInfo.name}`);\n \n     res.json({\n       success: true,\n       message: `æˆåŠŸç”Ÿæˆ${count}å¼ ${typeInfo.name}`,\n@@ -1057,10 +1064,19 @@\n       }\n     });\n \n   } catch (error) {\n-    console.error('âŒ ç”Ÿæˆç­‰çº§å¡å¤±è´¥:', error);\n-    next(error);\n+    console.error('âŒ ç”Ÿæˆç­‰çº§å¡å¤±è´¥ - è¯¦ç»†é”™è¯¯ä¿¡æ¯:');\n+    console.error('é”™è¯¯æ¶ˆæ¯:', error.message);\n+    console.error('é”™è¯¯ä»£ç :', error.code);\n+    console.error('SQLçŠ¶æ€:', error.sqlState);\n+    console.error('SQLæ¶ˆæ¯:', error.sqlMessage);\n+    console.error('å®Œæ•´é”™è¯¯:', error);\n+\n+    res.status(500).json({\n+      success: false,\n+      message: 'ç”Ÿæˆç­‰çº§å¡å¤±è´¥: ' + error.message\n+    });\n   }\n });\n \n // ç”Ÿæˆä½“éªŒå¡\n"
                },
                {
                    "date": 1752978698411,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -399,26 +399,31 @@\n // è·å–ç­‰çº§å¡ç±»å‹åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n router.get('/card-types', adminAuth, async (req, res, next) => {\n   try {\n     console.log('ğŸ” è·å–ç­‰çº§å¡ç±»å‹åˆ—è¡¨...');\n+    console.log('ğŸ‘¤ ç®¡ç†å‘˜ä¿¡æ¯:', req.admin);\n \n     // é¦–å…ˆæ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨\n     try {\n+      console.log('ğŸ“‹ æŸ¥è¯¢ç­‰çº§å¡ç±»å‹è¡¨...');\n       const cardTypes = await query(`\n         SELECT id, name, icon, points, price, description\n         FROM card_types\n         ORDER BY points ASC\n       `);\n \n       console.log('âœ… æˆåŠŸè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n+      console.log('ğŸ“Š å¡ç‰‡ç±»å‹æ•°æ®:', cardTypes);\n+\n       res.json({\n         success: true,\n         data: {\n           cardTypes\n         }\n       });\n     } catch (tableError) {\n-      console.log('âš ï¸ ç­‰çº§å¡ç±»å‹è¡¨ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º...');\n+      console.log('âš ï¸ ç­‰çº§å¡ç±»å‹è¡¨æŸ¥è¯¢å¤±è´¥ï¼Œé”™è¯¯:', tableError.message);\n+      console.log('ğŸ”§ å°è¯•åˆ›å»ºç­‰çº§å¡ç±»å‹è¡¨...');\n \n       // åˆ›å»ºè¡¨å’Œåˆå§‹æ•°æ®\n       await query(`\n         CREATE TABLE IF NOT EXISTS card_types (\n@@ -431,18 +436,27 @@\n           created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n           updated_at DATETIME NULL\n         ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n       `);\n+      console.log('âœ… ç­‰çº§å¡ç±»å‹è¡¨åˆ›å»ºæˆåŠŸ');\n \n-      // æ’å…¥åˆå§‹æ•°æ®\n-      await query(`\n-        INSERT INTO card_types (name, icon, price, points, description) VALUES\n-        ('ä½“éªŒå¡', 'ğŸ', 0.00, 20, 'å…è´¹ä½“éªŒå¡ï¼Œæ¯å¼ 20ç§¯åˆ†'),\n-        ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300, 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n-        ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000, 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n-        ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000, 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·')\n-      `);\n+      // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®\n+      const existingData = await query(`SELECT COUNT(*) as count FROM card_types`);\n+      console.log('ğŸ“Š ç°æœ‰æ•°æ®æ•°é‡:', existingData[0].count);\n \n+      if (existingData[0].count === 0) {\n+        console.log('ğŸ“ æ’å…¥åˆå§‹æ•°æ®...');\n+        // æ’å…¥åˆå§‹æ•°æ®\n+        await query(`\n+          INSERT INTO card_types (name, icon, price, points, description) VALUES\n+          ('ä½“éªŒå¡', 'ğŸ', 0.00, 20, 'å…è´¹ä½“éªŒå¡ï¼Œæ¯å¼ 20ç§¯åˆ†'),\n+          ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300, 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n+          ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000, 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n+          ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000, 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·')\n+        `);\n+        console.log('âœ… åˆå§‹æ•°æ®æ’å…¥æˆåŠŸ');\n+      }\n+\n       // é‡æ–°è·å–æ•°æ®\n       const cardTypes = await query(`\n         SELECT id, name, icon, points, price, description\n         FROM card_types\n@@ -457,10 +471,19 @@\n         }\n       });\n     }\n   } catch (error) {\n-    console.error('âŒ è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥:', error);\n-    next(error);\n+    console.error('âŒ è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥ - è¯¦ç»†é”™è¯¯ä¿¡æ¯:');\n+    console.error('é”™è¯¯æ¶ˆæ¯:', error.message);\n+    console.error('é”™è¯¯ä»£ç :', error.code);\n+    console.error('SQLçŠ¶æ€:', error.sqlState);\n+    console.error('SQLæ¶ˆæ¯:', error.sqlMessage);\n+    console.error('å®Œæ•´é”™è¯¯:', error);\n+\n+    res.status(500).json({\n+      success: false,\n+      message: 'è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥: ' + error.message\n+    });\n   }\n });\n \n // è·å–æ‰€æœ‰ç­‰çº§å¡åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n"
                },
                {
                    "date": 1752979355547,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1098,8 +1098,9 @@\n     res.status(500).json({\n       success: false,\n       message: 'ç”Ÿæˆç­‰çº§å¡å¤±è´¥: ' + error.message\n     });\n+    });\n   }\n });\n \n // ç”Ÿæˆä½“éªŒå¡\n"
                },
                {
                    "date": 1752979382415,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1098,9 +1098,8 @@\n     res.status(500).json({\n       success: false,\n       message: 'ç”Ÿæˆç­‰çº§å¡å¤±è´¥: ' + error.message\n     });\n-    });\n   }\n });\n \n // ç”Ÿæˆä½“éªŒå¡\n"
                },
                {
                    "date": 1752981569662,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -405,9 +405,9 @@\n     // é¦–å…ˆæ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨\n     try {\n       console.log('ğŸ“‹ æŸ¥è¯¢ç­‰çº§å¡ç±»å‹è¡¨...');\n       const cardTypes = await query(`\n-        SELECT id, name, icon, points, price, description\n+        SELECT id, name, icon, points, price, created_at\n         FROM card_types\n         ORDER BY points ASC\n       `);\n \n"
                },
                {
                    "date": 1752981581290,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -457,9 +457,9 @@\n       }\n \n       // é‡æ–°è·å–æ•°æ®\n       const cardTypes = await query(`\n-        SELECT id, name, icon, points, price, description\n+        SELECT id, name, icon, points, price, created_at\n         FROM card_types\n         ORDER BY points ASC\n       `);\n \n"
                },
                {
                    "date": 1752981595164,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1025,9 +1025,9 @@\n \n     // è·å–å¡ç‰‡ç±»å‹ä¿¡æ¯\n     console.log('ğŸ“‹ æŸ¥è¯¢å¡ç‰‡ç±»å‹ä¿¡æ¯...');\n     const cardTypeResult = await query(`\n-      SELECT id, name, points, price, description\n+      SELECT id, name, points, price\n       FROM card_types\n       WHERE id = ?\n     `, [cardTypeId]);\n \n"
                },
                {
                    "date": 1752981624948,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -376,13 +376,13 @@\n     // 4. æ’å…¥ç­‰çº§å¡ç±»å‹æ•°æ®ï¼ˆåŒ…å«ä½“éªŒå¡ï¼‰\n     const existingTypes = await query('SELECT COUNT(*) as count FROM card_types');\n     if (existingTypes[0].count === 0) {\n       await query(`\n-        INSERT INTO card_types (name, icon, price, points, description) VALUES\n-        ('ä½“éªŒå¡', 'ğŸ', 0.00, 20, 'å…è´¹ä½“éªŒå¡ï¼Œæ¯å¼ 20ç§¯åˆ†'),\n-        ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300, 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n-        ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000, 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n-        ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000, 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·')\n+        INSERT INTO card_types (name, icon, price, points) VALUES\n+        ('ä½“éªŒå¡', 'ğŸ', 0.00, 20),\n+        ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300),\n+        ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000),\n+        ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000)\n       `);\n     }\n \n     res.json({\n"
                },
                {
                    "date": 1752981639737,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -446,13 +446,13 @@\n       if (existingData[0].count === 0) {\n         console.log('ğŸ“ æ’å…¥åˆå§‹æ•°æ®...');\n         // æ’å…¥åˆå§‹æ•°æ®\n         await query(`\n-          INSERT INTO card_types (name, icon, price, points, description) VALUES\n-          ('ä½“éªŒå¡', 'ğŸ', 0.00, 20, 'å…è´¹ä½“éªŒå¡ï¼Œæ¯å¼ 20ç§¯åˆ†'),\n-          ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300, 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n-          ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000, 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n-          ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000, 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·')\n+          INSERT INTO card_types (name, icon, price, points) VALUES\n+          ('ä½“éªŒå¡', 'ğŸ', 0.00, 20),\n+          ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300),\n+          ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000),\n+          ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000)\n         `);\n         console.log('âœ… åˆå§‹æ•°æ®æ’å…¥æˆåŠŸ');\n       }\n \n"
                },
                {
                    "date": 1752981656149,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -320,9 +320,8 @@\n         name VARCHAR(50) NOT NULL COMMENT 'ç­‰çº§å¡åç§°',\n         icon VARCHAR(10) NOT NULL COMMENT 'ç­‰çº§å¡å›¾æ ‡',\n         price DECIMAL(10,2) NOT NULL COMMENT 'ä»·æ ¼',\n         points INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',\n-        description TEXT COMMENT 'æè¿°',\n         created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n         updated_at DATETIME NULL\n       ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n     `);\n"
                },
                {
                    "date": 1752981672300,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -430,9 +430,8 @@\n           name VARCHAR(50) NOT NULL COMMENT 'ç­‰çº§å¡åç§°',\n           icon VARCHAR(10) NOT NULL COMMENT 'ç­‰çº§å¡å›¾æ ‡',\n           price DECIMAL(10,2) NOT NULL COMMENT 'ä»·æ ¼',\n           points INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',\n-          description TEXT COMMENT 'æè¿°',\n           created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n           updated_at DATETIME NULL\n         ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n       `);\n"
                },
                {
                    "date": 1752981992820,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -398,90 +398,26 @@\n // è·å–ç­‰çº§å¡ç±»å‹åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n router.get('/card-types', adminAuth, async (req, res, next) => {\n   try {\n     console.log('ğŸ” è·å–ç­‰çº§å¡ç±»å‹åˆ—è¡¨...');\n-    console.log('ğŸ‘¤ ç®¡ç†å‘˜ä¿¡æ¯:', req.admin);\n \n-    // é¦–å…ˆæ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨\n-    try {\n-      console.log('ğŸ“‹ æŸ¥è¯¢ç­‰çº§å¡ç±»å‹è¡¨...');\n-      const cardTypes = await query(`\n-        SELECT id, name, icon, points, price, created_at\n-        FROM card_types\n-        ORDER BY points ASC\n-      `);\n+    const cardTypes = await query(`\n+      SELECT id, name, icon, points, price, created_at\n+      FROM card_types\n+      ORDER BY points ASC\n+    `);\n \n-      console.log('âœ… æˆåŠŸè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n-      console.log('ğŸ“Š å¡ç‰‡ç±»å‹æ•°æ®:', cardTypes);\n+    console.log('âœ… æˆåŠŸè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n \n-      res.json({\n-        success: true,\n-        data: {\n-          cardTypes\n-        }\n-      });\n-    } catch (tableError) {\n-      console.log('âš ï¸ ç­‰çº§å¡ç±»å‹è¡¨æŸ¥è¯¢å¤±è´¥ï¼Œé”™è¯¯:', tableError.message);\n-      console.log('ğŸ”§ å°è¯•åˆ›å»ºç­‰çº§å¡ç±»å‹è¡¨...');\n-\n-      // åˆ›å»ºè¡¨å’Œåˆå§‹æ•°æ®\n-      await query(`\n-        CREATE TABLE IF NOT EXISTS card_types (\n-          id INT AUTO_INCREMENT PRIMARY KEY,\n-          name VARCHAR(50) NOT NULL COMMENT 'ç­‰çº§å¡åç§°',\n-          icon VARCHAR(10) NOT NULL COMMENT 'ç­‰çº§å¡å›¾æ ‡',\n-          price DECIMAL(10,2) NOT NULL COMMENT 'ä»·æ ¼',\n-          points INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',\n-          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-          updated_at DATETIME NULL\n-        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-      `);\n-      console.log('âœ… ç­‰çº§å¡ç±»å‹è¡¨åˆ›å»ºæˆåŠŸ');\n-\n-      // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®\n-      const existingData = await query(`SELECT COUNT(*) as count FROM card_types`);\n-      console.log('ğŸ“Š ç°æœ‰æ•°æ®æ•°é‡:', existingData[0].count);\n-\n-      if (existingData[0].count === 0) {\n-        console.log('ğŸ“ æ’å…¥åˆå§‹æ•°æ®...');\n-        // æ’å…¥åˆå§‹æ•°æ®\n-        await query(`\n-          INSERT INTO card_types (name, icon, price, points) VALUES\n-          ('ä½“éªŒå¡', 'ğŸ', 0.00, 20),\n-          ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300),\n-          ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000),\n-          ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000)\n-        `);\n-        console.log('âœ… åˆå§‹æ•°æ®æ’å…¥æˆåŠŸ');\n+    res.json({\n+      success: true,\n+      data: {\n+        cardTypes\n       }\n-\n-      // é‡æ–°è·å–æ•°æ®\n-      const cardTypes = await query(`\n-        SELECT id, name, icon, points, price, created_at\n-        FROM card_types\n-        ORDER BY points ASC\n-      `);\n-\n-      console.log('âœ… è¡¨åˆ›å»ºæˆåŠŸï¼Œè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n-      res.json({\n-        success: true,\n-        data: {\n-          cardTypes\n-        }\n-      });\n-    }\n+    });\n   } catch (error) {\n-    console.error('âŒ è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥ - è¯¦ç»†é”™è¯¯ä¿¡æ¯:');\n-    console.error('é”™è¯¯æ¶ˆæ¯:', error.message);\n-    console.error('é”™è¯¯ä»£ç :', error.code);\n-    console.error('SQLçŠ¶æ€:', error.sqlState);\n-    console.error('SQLæ¶ˆæ¯:', error.sqlMessage);\n-    console.error('å®Œæ•´é”™è¯¯:', error);\n-\n-    res.status(500).json({\n-      success: false,\n-      message: 'è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥: ' + error.message\n-    });\n+    console.error('âŒ è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥:', error);\n+    next(error);\n   }\n });\n \n // è·å–æ‰€æœ‰ç­‰çº§å¡åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n"
                },
                {
                    "date": 1752983581589,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -398,26 +398,90 @@\n // è·å–ç­‰çº§å¡ç±»å‹åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n router.get('/card-types', adminAuth, async (req, res, next) => {\n   try {\n     console.log('ğŸ” è·å–ç­‰çº§å¡ç±»å‹åˆ—è¡¨...');\n+    console.log('ğŸ‘¤ ç®¡ç†å‘˜ä¿¡æ¯:', req.admin);\n \n-    const cardTypes = await query(`\n-      SELECT id, name, icon, points, price, created_at\n-      FROM card_types\n-      ORDER BY points ASC\n-    `);\n+    // é¦–å…ˆæ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨\n+    try {\n+      console.log('ğŸ“‹ æŸ¥è¯¢ç­‰çº§å¡ç±»å‹è¡¨...');\n+      const cardTypes = await query(`\n+        SELECT id, name, icon, points, price, created_at\n+        FROM card_types\n+        ORDER BY points ASC\n+      `);\n \n-    console.log('âœ… æˆåŠŸè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n+      console.log('âœ… æˆåŠŸè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n+      console.log('ğŸ“Š å¡ç‰‡ç±»å‹æ•°æ®:', cardTypes);\n \n-    res.json({\n-      success: true,\n-      data: {\n-        cardTypes\n+      res.json({\n+        success: true,\n+        data: {\n+          cardTypes\n+        }\n+      });\n+    } catch (tableError) {\n+      console.log('âš ï¸ ç­‰çº§å¡ç±»å‹è¡¨æŸ¥è¯¢å¤±è´¥ï¼Œé”™è¯¯:', tableError.message);\n+      console.log('ğŸ”§ å°è¯•åˆ›å»ºç­‰çº§å¡ç±»å‹è¡¨...');\n+\n+      // åˆ›å»ºè¡¨å’Œåˆå§‹æ•°æ®\n+      await query(`\n+        CREATE TABLE IF NOT EXISTS card_types (\n+          id INT AUTO_INCREMENT PRIMARY KEY,\n+          name VARCHAR(50) NOT NULL COMMENT 'ç­‰çº§å¡åç§°',\n+          icon VARCHAR(10) NOT NULL COMMENT 'ç­‰çº§å¡å›¾æ ‡',\n+          price DECIMAL(10,2) NOT NULL COMMENT 'ä»·æ ¼',\n+          points INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',\n+          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+          updated_at DATETIME NULL\n+        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+      `);\n+      console.log('âœ… ç­‰çº§å¡ç±»å‹è¡¨åˆ›å»ºæˆåŠŸ');\n+\n+      // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®\n+      const existingData = await query(`SELECT COUNT(*) as count FROM card_types`);\n+      console.log('ğŸ“Š ç°æœ‰æ•°æ®æ•°é‡:', existingData[0].count);\n+\n+      if (existingData[0].count === 0) {\n+        console.log('ğŸ“ æ’å…¥åˆå§‹æ•°æ®...');\n+        // æ’å…¥åˆå§‹æ•°æ®\n+        await query(`\n+          INSERT INTO card_types (name, icon, price, points) VALUES\n+          ('ä½“éªŒå¡', 'ğŸ', 0.00, 20),\n+          ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300),\n+          ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000),\n+          ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000)\n+        `);\n+        console.log('âœ… åˆå§‹æ•°æ®æ’å…¥æˆåŠŸ');\n       }\n+\n+      // é‡æ–°è·å–æ•°æ®\n+      const cardTypes = await query(`\n+        SELECT id, name, icon, points, price, created_at\n+        FROM card_types\n+        ORDER BY points ASC\n+      `);\n+\n+      console.log('âœ… è¡¨åˆ›å»ºæˆåŠŸï¼Œè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n+      res.json({\n+        success: true,\n+        data: {\n+          cardTypes\n+        }\n+      });\n+    }\n+  } catch (error) {\n+    console.error('âŒ è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥ - è¯¦ç»†é”™è¯¯ä¿¡æ¯:');\n+    console.error('é”™è¯¯æ¶ˆæ¯:', error.message);\n+    console.error('é”™è¯¯ä»£ç :', error.code);\n+    console.error('SQLçŠ¶æ€:', error.sqlState);\n+    console.error('SQLæ¶ˆæ¯:', error.sqlMessage);\n+    console.error('å®Œæ•´é”™è¯¯:', error);\n+\n+    res.status(500).json({\n+      success: false,\n+      message: 'è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥: ' + error.message\n     });\n-  } catch (error) {\n-    console.error('âŒ è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥:', error);\n-    next(error);\n   }\n });\n \n // è·å–æ‰€æœ‰ç­‰çº§å¡åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n"
                },
                {
                    "date": 1752984862547,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -400,88 +400,61 @@\n   try {\n     console.log('ğŸ” è·å–ç­‰çº§å¡ç±»å‹åˆ—è¡¨...');\n     console.log('ğŸ‘¤ ç®¡ç†å‘˜ä¿¡æ¯:', req.admin);\n \n-    // é¦–å…ˆæ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨\n-    try {\n-      console.log('ğŸ“‹ æŸ¥è¯¢ç­‰çº§å¡ç±»å‹è¡¨...');\n-      const cardTypes = await query(`\n-        SELECT id, name, icon, points, price, created_at\n-        FROM card_types\n-        ORDER BY points ASC\n-      `);\n+    // ç¡®ä¿è¡¨å­˜åœ¨ï¼ˆå…ˆåˆ›å»ºè¡¨ï¼Œé¿å…æŸ¥è¯¢å¤±è´¥ï¼‰\n+    console.log('ğŸ”§ ç¡®ä¿ç­‰çº§å¡ç±»å‹è¡¨å­˜åœ¨...');\n+    await query(`\n+      CREATE TABLE IF NOT EXISTS card_types (\n+        id INT AUTO_INCREMENT PRIMARY KEY,\n+        name VARCHAR(50) NOT NULL COMMENT 'ç­‰çº§å¡åç§°',\n+        icon VARCHAR(10) NOT NULL COMMENT 'ç­‰çº§å¡å›¾æ ‡',\n+        price DECIMAL(10,2) NOT NULL COMMENT 'ä»·æ ¼',\n+        points INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',\n+        description TEXT COMMENT 'æè¿°',\n+        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+        updated_at DATETIME NULL\n+      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+    `);\n+    console.log('âœ… ç­‰çº§å¡ç±»å‹è¡¨ç¡®ä¿å­˜åœ¨');\n \n-      console.log('âœ… æˆåŠŸè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n-      console.log('ğŸ“Š å¡ç‰‡ç±»å‹æ•°æ®:', cardTypes);\n+    // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®\n+    const existingData = await query(`SELECT COUNT(*) as count FROM card_types`);\n+    console.log('ğŸ“Š ç°æœ‰æ•°æ®æ•°é‡:', existingData[0].count);\n \n-      res.json({\n-        success: true,\n-        data: {\n-          cardTypes\n-        }\n-      });\n-    } catch (tableError) {\n-      console.log('âš ï¸ ç­‰çº§å¡ç±»å‹è¡¨æŸ¥è¯¢å¤±è´¥ï¼Œé”™è¯¯:', tableError.message);\n-      console.log('ğŸ”§ å°è¯•åˆ›å»ºç­‰çº§å¡ç±»å‹è¡¨...');\n-\n-      // åˆ›å»ºè¡¨å’Œåˆå§‹æ•°æ®\n+    if (existingData[0].count === 0) {\n+      console.log('ğŸ“ æ’å…¥åˆå§‹æ•°æ®...');\n       await query(`\n-        CREATE TABLE IF NOT EXISTS card_types (\n-          id INT AUTO_INCREMENT PRIMARY KEY,\n-          name VARCHAR(50) NOT NULL COMMENT 'ç­‰çº§å¡åç§°',\n-          icon VARCHAR(10) NOT NULL COMMENT 'ç­‰çº§å¡å›¾æ ‡',\n-          price DECIMAL(10,2) NOT NULL COMMENT 'ä»·æ ¼',\n-          points INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',\n-          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-          updated_at DATETIME NULL\n-        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+        INSERT INTO card_types (name, icon, price, points, description) VALUES\n+        ('ä½“éªŒå¡', 'ğŸ', 0.00, 20, 'å…è´¹ä½“éªŒå¡ï¼Œæ¯å¼ 20ç§¯åˆ†'),\n+        ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300, 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n+        ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000, 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n+        ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000, 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·')\n       `);\n-      console.log('âœ… ç­‰çº§å¡ç±»å‹è¡¨åˆ›å»ºæˆåŠŸ');\n+      console.log('âœ… åˆå§‹æ•°æ®æ’å…¥æˆåŠŸ');\n+    }\n \n-      // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®\n-      const existingData = await query(`SELECT COUNT(*) as count FROM card_types`);\n-      console.log('ğŸ“Š ç°æœ‰æ•°æ®æ•°é‡:', existingData[0].count);\n+    // è·å–æ•°æ®\n+    console.log('ğŸ“‹ æŸ¥è¯¢ç­‰çº§å¡ç±»å‹è¡¨...');\n+    const cardTypes = await query(`\n+      SELECT id, name, icon, points, price, created_at\n+      FROM card_types\n+      ORDER BY points ASC\n+    `);\n \n-      if (existingData[0].count === 0) {\n-        console.log('ğŸ“ æ’å…¥åˆå§‹æ•°æ®...');\n-        // æ’å…¥åˆå§‹æ•°æ®\n-        await query(`\n-          INSERT INTO card_types (name, icon, price, points) VALUES\n-          ('ä½“éªŒå¡', 'ğŸ', 0.00, 20),\n-          ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300),\n-          ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000),\n-          ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000)\n-        `);\n-        console.log('âœ… åˆå§‹æ•°æ®æ’å…¥æˆåŠŸ');\n+    console.log('âœ… æˆåŠŸè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n+    console.log('ğŸ“Š å¡ç‰‡ç±»å‹æ•°æ®:', cardTypes);\n+\n+    res.json({\n+      success: true,\n+      data: {\n+        cardTypes\n       }\n+    });\n \n-      // é‡æ–°è·å–æ•°æ®\n-      const cardTypes = await query(`\n-        SELECT id, name, icon, points, price, created_at\n-        FROM card_types\n-        ORDER BY points ASC\n-      `);\n-\n-      console.log('âœ… è¡¨åˆ›å»ºæˆåŠŸï¼Œè·å–ç­‰çº§å¡ç±»å‹:', cardTypes.length, 'ä¸ª');\n-      res.json({\n-        success: true,\n-        data: {\n-          cardTypes\n-        }\n-      });\n-    }\n   } catch (error) {\n-    console.error('âŒ è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥ - è¯¦ç»†é”™è¯¯ä¿¡æ¯:');\n-    console.error('é”™è¯¯æ¶ˆæ¯:', error.message);\n-    console.error('é”™è¯¯ä»£ç :', error.code);\n-    console.error('SQLçŠ¶æ€:', error.sqlState);\n-    console.error('SQLæ¶ˆæ¯:', error.sqlMessage);\n-    console.error('å®Œæ•´é”™è¯¯:', error);\n-\n-    res.status(500).json({\n-      success: false,\n-      message: 'è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥: ' + error.message\n-    });\n+    console.error('âŒ è·å–ç­‰çº§å¡ç±»å‹å¤±è´¥:', error);\n+    next(error);\n   }\n });\n \n // è·å–æ‰€æœ‰ç­‰çº§å¡åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n"
                },
                {
                    "date": 1752985772529,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -422,16 +422,51 @@\n     console.log('ğŸ“Š ç°æœ‰æ•°æ®æ•°é‡:', existingData[0].count);\n \n     if (existingData[0].count === 0) {\n       console.log('ğŸ“ æ’å…¥åˆå§‹æ•°æ®...');\n-      await query(`\n-        INSERT INTO card_types (name, icon, price, points, description) VALUES\n-        ('ä½“éªŒå¡', 'ğŸ', 0.00, 20, 'å…è´¹ä½“éªŒå¡ï¼Œæ¯å¼ 20ç§¯åˆ†'),\n-        ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300, 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n-        ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000, 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n-        ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000, 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·')\n-      `);\n-      console.log('âœ… åˆå§‹æ•°æ®æ’å…¥æˆåŠŸ');\n+\n+      // å…ˆæ£€æŸ¥è¡¨ç»“æ„ï¼Œç¡®å®šæ˜¯å¦æœ‰ description å­—æ®µ\n+      try {\n+        const tableStructure = await query('DESCRIBE card_types');\n+        const hasDescription = tableStructure.some(col => col.Field === 'description');\n+\n+        if (hasDescription) {\n+          // å¦‚æœæœ‰ description å­—æ®µ\n+          await query(`\n+            INSERT INTO card_types (name, icon, price, points, description) VALUES\n+            ('ä½“éªŒå¡', 'ğŸ', 0.00, 20, 'å…è´¹ä½“éªŒå¡ï¼Œæ¯å¼ 20ç§¯åˆ†'),\n+            ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300, 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n+            ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000, 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n+            ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000, 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·')\n+          `);\n+        } else {\n+          // å¦‚æœæ²¡æœ‰ description å­—æ®µ\n+          await query(`\n+            INSERT INTO card_types (name, icon, price, points) VALUES\n+            ('ä½“éªŒå¡', 'ğŸ', 0.00, 20),\n+            ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300),\n+            ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000),\n+            ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000)\n+          `);\n+        }\n+        console.log('âœ… åˆå§‹æ•°æ®æ’å…¥æˆåŠŸ');\n+      } catch (insertError) {\n+        console.error('âŒ æ’å…¥åˆå§‹æ•°æ®å¤±è´¥:', insertError);\n+        // å¦‚æœæ’å…¥å¤±è´¥ï¼Œå°è¯•ä¸å¸¦ description å­—æ®µçš„æ’å…¥\n+        try {\n+          await query(`\n+            INSERT INTO card_types (name, icon, price, points) VALUES\n+            ('ä½“éªŒå¡', 'ğŸ', 0.00, 20),\n+            ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300),\n+            ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000),\n+            ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000)\n+          `);\n+          console.log('âœ… åˆå§‹æ•°æ®æ’å…¥æˆåŠŸï¼ˆä¸å«descriptionå­—æ®µï¼‰');\n+        } catch (fallbackError) {\n+          console.error('âŒ å¤‡ç”¨æ’å…¥ä¹Ÿå¤±è´¥:', fallbackError);\n+          throw fallbackError;\n+        }\n+      }\n     }\n \n     // è·å–æ•°æ®\n     console.log('ğŸ“‹ æŸ¥è¯¢ç­‰çº§å¡ç±»å‹è¡¨...');\n"
                },
                {
                    "date": 1752985803917,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1028,8 +1028,31 @@\n     }\n \n     console.log(`ğŸ« å¼€å§‹ç”Ÿæˆ${count}å¼ ç­‰çº§å¡ï¼Œç±»å‹ID: ${cardTypeId}...`);\n \n+    // ç¡®ä¿ level_cards è¡¨å­˜åœ¨\n+    console.log('ğŸ”§ ç¡®ä¿ç­‰çº§å¡è¡¨å­˜åœ¨...');\n+    await query(`\n+      CREATE TABLE IF NOT EXISTS level_cards (\n+        id INT AUTO_INCREMENT PRIMARY KEY,\n+        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT 'å¡å·',\n+        card_password VARCHAR(20) NOT NULL COMMENT 'å¡å¯†',\n+        type_id INT NOT NULL COMMENT 'ç­‰çº§å¡ç±»å‹ID',\n+        remaining_points INT NOT NULL COMMENT 'å‰©ä½™ç§¯åˆ†',\n+        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT 'çŠ¶æ€',\n+        bound_user_id INT NULL COMMENT 'ç»‘å®šçš„ç”¨æˆ·ID',\n+        bound_at DATETIME NULL COMMENT 'ç»‘å®šæ—¶é—´',\n+        expires_at DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´',\n+        created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n+        updated_at DATETIME NULL ON UPDATE CURRENT_TIMESTAMP,\n+        INDEX idx_card_number (card_number),\n+        INDEX idx_bound_user (bound_user_id),\n+        INDEX idx_status (status),\n+        INDEX idx_type (type_id)\n+      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç­‰çº§å¡è¡¨'\n+    `);\n+    console.log('âœ… ç­‰çº§å¡è¡¨ç¡®ä¿å­˜åœ¨');\n+\n     // è·å–å¡ç‰‡ç±»å‹ä¿¡æ¯\n     console.log('ğŸ“‹ æŸ¥è¯¢å¡ç‰‡ç±»å‹ä¿¡æ¯...');\n     const cardTypeResult = await query(`\n       SELECT id, name, points, price\n"
                },
                {
                    "date": 1752985821514,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1082,12 +1082,12 @@\n         const cardPassword = generateCardPassword();\n \n         console.log(`ğŸ“ ç”Ÿæˆç¬¬${i}å¼ å¡: ${cardNumber} - ${cardPassword}`);\n \n-        // æ ¹æ®å®é™…è¡¨ç»“æ„æ’å…¥æ•°æ®ï¼ˆä¸åŒ…å«total_pointså­—æ®µï¼‰\n+        // æ’å…¥ç­‰çº§å¡æ•°æ®\n         await query(`\n-          INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n-          VALUES (?, ?, ?, ?, NOW())\n+          INSERT INTO level_cards (card_number, card_password, type_id, remaining_points)\n+          VALUES (?, ?, ?, ?)\n         `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n \n         generatedCards.push({\n           cardNumber,\n"
                },
                {
                    "date": 1752985851223,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1159,10 +1159,10 @@\n       const cardNumber = generateCardNumber('ä½“éªŒå¡', i);\n       const cardPassword = generateCardPassword();\n \n       await query(`\n-        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n-        VALUES (?, ?, ?, ?, NOW())\n+        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points)\n+        VALUES (?, ?, ?, ?)\n       `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n \n       generatedCards.push({\n         cardNumber,\n"
                },
                {
                    "date": 1753015687250,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1082,14 +1082,51 @@\n         const cardPassword = generateCardPassword();\n \n         console.log(`ğŸ“ ç”Ÿæˆç¬¬${i}å¼ å¡: ${cardNumber} - ${cardPassword}`);\n \n-        // æ’å…¥ç­‰çº§å¡æ•°æ®\n-        await query(`\n-          INSERT INTO level_cards (card_number, card_password, type_id, remaining_points)\n-          VALUES (?, ?, ?, ?)\n-        `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+        // æ’å…¥ç­‰çº§å¡æ•°æ® - ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼\n+        try {\n+          await query(`\n+            INSERT INTO level_cards (card_number, card_password, type_id, remaining_points)\n+            VALUES (?, ?, ?, ?)\n+          `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+        } catch (insertError) {\n+          console.error(`âŒ æ’å…¥ç­‰çº§å¡æ•°æ®å¤±è´¥:`, insertError);\n \n+          // å¦‚æœæ’å…¥å¤±è´¥ï¼Œå¯èƒ½æ˜¯è¡¨ç»“æ„é—®é¢˜ï¼Œå°è¯•æ£€æŸ¥è¡¨ç»“æ„\n+          try {\n+            const tableStructure = await query('DESCRIBE level_cards');\n+            console.log('ğŸ“Š level_cardsè¡¨ç»“æ„:', tableStructure);\n+\n+            // æ£€æŸ¥æ˜¯å¦ç¼ºå°‘æŸäº›å­—æ®µï¼Œå°è¯•ä¸åŒçš„æ’å…¥æ–¹å¼\n+            const hasRemainingPoints = tableStructure.some(col => col.Field === 'remaining_points');\n+            const hasTotalPoints = tableStructure.some(col => col.Field === 'total_points');\n+\n+            if (hasRemainingPoints) {\n+              // å¦‚æœæœ‰ remaining_points å­—æ®µï¼Œé‡è¯•åŸå§‹æ’å…¥\n+              await query(`\n+                INSERT INTO level_cards (card_number, card_password, type_id, remaining_points)\n+                VALUES (?, ?, ?, ?)\n+              `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+            } else if (hasTotalPoints) {\n+              // å¦‚æœåªæœ‰ total_points å­—æ®µ\n+              await query(`\n+                INSERT INTO level_cards (card_number, card_password, type_id, total_points)\n+                VALUES (?, ?, ?, ?)\n+              `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+            } else {\n+              // æœ€åŸºæœ¬çš„æ’å…¥\n+              await query(`\n+                INSERT INTO level_cards (card_number, card_password, type_id)\n+                VALUES (?, ?, ?)\n+              `, [cardNumber, cardPassword, typeInfo.id]);\n+            }\n+          } catch (fallbackError) {\n+            console.error(`âŒ å¤‡ç”¨æ’å…¥ä¹Ÿå¤±è´¥:`, fallbackError);\n+            throw fallbackError;\n+          }\n+        }\n+\n         generatedCards.push({\n           cardNumber,\n           cardPassword,\n           typeName: typeInfo.name,\n"
                },
                {
                    "date": 1753015702520,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1053,14 +1053,31 @@\n     console.log('âœ… ç­‰çº§å¡è¡¨ç¡®ä¿å­˜åœ¨');\n \n     // è·å–å¡ç‰‡ç±»å‹ä¿¡æ¯\n     console.log('ğŸ“‹ æŸ¥è¯¢å¡ç‰‡ç±»å‹ä¿¡æ¯...');\n-    const cardTypeResult = await query(`\n-      SELECT id, name, points, price\n-      FROM card_types\n-      WHERE id = ?\n-    `, [cardTypeId]);\n+    let cardTypeResult;\n+    try {\n+      cardTypeResult = await query(`\n+        SELECT id, name, points, price\n+        FROM card_types\n+        WHERE id = ?\n+      `, [cardTypeId]);\n+    } catch (queryError) {\n+      console.error('âŒ æŸ¥è¯¢å¡ç‰‡ç±»å‹å¤±è´¥:', queryError);\n \n+      // å¦‚æœæŸ¥è¯¢å¤±è´¥ï¼Œå¯èƒ½æ˜¯å­—æ®µä¸å­˜åœ¨ï¼Œå°è¯•åŸºæœ¬æŸ¥è¯¢\n+      try {\n+        cardTypeResult = await query(`\n+          SELECT id, name, points, price\n+          FROM card_types\n+          WHERE id = ?\n+        `, [cardTypeId]);\n+      } catch (fallbackError) {\n+        console.error('âŒ å¤‡ç”¨æŸ¥è¯¢ä¹Ÿå¤±è´¥:', fallbackError);\n+        throw fallbackError;\n+      }\n+    }\n+\n     console.log('ğŸ“‹ å¡ç‰‡ç±»å‹æŸ¥è¯¢ç»“æœ:', cardTypeResult);\n \n     if (cardTypeResult.length === 0) {\n       console.log('âŒ å¡ç‰‡ç±»å‹ä¸å­˜åœ¨:', cardTypeId);\n"
                },
                {
                    "date": 1753015863184,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1006,12 +1006,15 @@\n \n // ç”Ÿæˆç­‰çº§å¡ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\n router.post('/generate-cards', adminAuth, async (req, res, next) => {\n   try {\n-    console.log('ğŸ« æ”¶åˆ°ç”Ÿæˆç­‰çº§å¡è¯·æ±‚ï¼Œè¯·æ±‚ä½“:', req.body);\n+    console.log('ğŸ« æ”¶åˆ°ç”Ÿæˆç­‰çº§å¡è¯·æ±‚');\n+    console.log('ğŸ“‹ è¯·æ±‚ä½“:', JSON.stringify(req.body, null, 2));\n+    console.log('ğŸ‘¤ ç®¡ç†å‘˜ä¿¡æ¯:', req.admin);\n \n     const { cardTypeId, count = 5 } = req.body;\n \n+    // å‚æ•°éªŒè¯\n     if (!cardTypeId) {\n       console.log('âŒ ç¼ºå°‘cardTypeIdå‚æ•°');\n       return res.status(400).json({\n         success: false,\n"
                },
                {
                    "date": 1753016004924,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1044,10 +1044,10 @@\n         status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT 'çŠ¶æ€',\n         bound_user_id INT NULL COMMENT 'ç»‘å®šçš„ç”¨æˆ·ID',\n         bound_at DATETIME NULL COMMENT 'ç»‘å®šæ—¶é—´',\n         expires_at DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´',\n-        created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n-        updated_at DATETIME NULL ON UPDATE CURRENT_TIMESTAMP,\n+        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+        updated_at TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,\n         INDEX idx_card_number (card_number),\n         INDEX idx_bound_user (bound_user_id),\n         INDEX idx_status (status),\n         INDEX idx_type (type_id)\n"
                },
                {
                    "date": 1753016273097,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1045,9 +1045,9 @@\n         bound_user_id INT NULL COMMENT 'ç»‘å®šçš„ç”¨æˆ·ID',\n         bound_at DATETIME NULL COMMENT 'ç»‘å®šæ—¶é—´',\n         expires_at DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´',\n         created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-        updated_at TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,\n+        updated_at DATETIME NULL COMMENT 'æ›´æ–°æ—¶é—´',\n         INDEX idx_card_number (card_number),\n         INDEX idx_bound_user (bound_user_id),\n         INDEX idx_status (status),\n         INDEX idx_type (type_id)\n"
                },
                {
                    "date": 1753016310014,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1105,10 +1105,10 @@\n \n         // æ’å…¥ç­‰çº§å¡æ•°æ® - ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼\n         try {\n           await query(`\n-            INSERT INTO level_cards (card_number, card_password, type_id, remaining_points)\n-            VALUES (?, ?, ?, ?)\n+            INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n+            VALUES (?, ?, ?, ?, NOW())\n           `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n         } catch (insertError) {\n           console.error(`âŒ æ’å…¥ç­‰çº§å¡æ•°æ®å¤±è´¥:`, insertError);\n \n"
                },
                {
                    "date": 1753016326048,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1123,22 +1123,22 @@\n \n             if (hasRemainingPoints) {\n               // å¦‚æœæœ‰ remaining_points å­—æ®µï¼Œé‡è¯•åŸå§‹æ’å…¥\n               await query(`\n-                INSERT INTO level_cards (card_number, card_password, type_id, remaining_points)\n-                VALUES (?, ?, ?, ?)\n+                INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n+                VALUES (?, ?, ?, ?, NOW())\n               `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n             } else if (hasTotalPoints) {\n               // å¦‚æœåªæœ‰ total_points å­—æ®µ\n               await query(`\n-                INSERT INTO level_cards (card_number, card_password, type_id, total_points)\n-                VALUES (?, ?, ?, ?)\n+                INSERT INTO level_cards (card_number, card_password, type_id, total_points, created_at)\n+                VALUES (?, ?, ?, ?, NOW())\n               `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n             } else {\n               // æœ€åŸºæœ¬çš„æ’å…¥\n               await query(`\n-                INSERT INTO level_cards (card_number, card_password, type_id)\n-                VALUES (?, ?, ?)\n+                INSERT INTO level_cards (card_number, card_password, type_id, created_at)\n+                VALUES (?, ?, ?, NOW())\n               `, [cardNumber, cardPassword, typeInfo.id]);\n             }\n           } catch (fallbackError) {\n             console.error(`âŒ å¤‡ç”¨æ’å…¥ä¹Ÿå¤±è´¥:`, fallbackError);\n"
                },
                {
                    "date": 1753016350615,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1031,28 +1031,24 @@\n     }\n \n     console.log(`ğŸ« å¼€å§‹ç”Ÿæˆ${count}å¼ ç­‰çº§å¡ï¼Œç±»å‹ID: ${cardTypeId}...`);\n \n-    // ç¡®ä¿ level_cards è¡¨å­˜åœ¨\n+    // ç¡®ä¿ level_cards è¡¨å­˜åœ¨ - ä½¿ç”¨ç®€å•çš„è¡¨ç»“æ„é¿å…MySQLç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜\n     console.log('ğŸ”§ ç¡®ä¿ç­‰çº§å¡è¡¨å­˜åœ¨...');\n     await query(`\n       CREATE TABLE IF NOT EXISTS level_cards (\n         id INT AUTO_INCREMENT PRIMARY KEY,\n-        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT 'å¡å·',\n-        card_password VARCHAR(20) NOT NULL COMMENT 'å¡å¯†',\n-        type_id INT NOT NULL COMMENT 'ç­‰çº§å¡ç±»å‹ID',\n-        remaining_points INT NOT NULL COMMENT 'å‰©ä½™ç§¯åˆ†',\n-        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT 'çŠ¶æ€',\n-        bound_user_id INT NULL COMMENT 'ç»‘å®šçš„ç”¨æˆ·ID',\n-        bound_at DATETIME NULL COMMENT 'ç»‘å®šæ—¶é—´',\n-        expires_at DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´',\n-        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-        updated_at DATETIME NULL COMMENT 'æ›´æ–°æ—¶é—´',\n-        INDEX idx_card_number (card_number),\n-        INDEX idx_bound_user (bound_user_id),\n-        INDEX idx_status (status),\n-        INDEX idx_type (type_id)\n-      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç­‰çº§å¡è¡¨'\n+        card_number VARCHAR(20) UNIQUE NOT NULL,\n+        card_password VARCHAR(20) NOT NULL,\n+        type_id INT NOT NULL,\n+        remaining_points INT NOT NULL,\n+        status VARCHAR(20) DEFAULT 'active',\n+        bound_user_id INT NULL,\n+        bound_at DATETIME NULL,\n+        expires_at DATETIME NULL,\n+        created_at DATETIME NULL,\n+        updated_at DATETIME NULL\n+      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4\n     `);\n     console.log('âœ… ç­‰çº§å¡è¡¨ç¡®ä¿å­˜åœ¨');\n \n     // è·å–å¡ç‰‡ç±»å‹ä¿¡æ¯\n"
                },
                {
                    "date": 1753016527113,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1031,27 +1031,26 @@\n     }\n \n     console.log(`ğŸ« å¼€å§‹ç”Ÿæˆ${count}å¼ ç­‰çº§å¡ï¼Œç±»å‹ID: ${cardTypeId}...`);\n \n-    // ç¡®ä¿ level_cards è¡¨å­˜åœ¨ - ä½¿ç”¨ç®€å•çš„è¡¨ç»“æ„é¿å…MySQLç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜\n-    console.log('ğŸ”§ ç¡®ä¿ç­‰çº§å¡è¡¨å­˜åœ¨...');\n-    await query(`\n-      CREATE TABLE IF NOT EXISTS level_cards (\n-        id INT AUTO_INCREMENT PRIMARY KEY,\n-        card_number VARCHAR(20) UNIQUE NOT NULL,\n-        card_password VARCHAR(20) NOT NULL,\n-        type_id INT NOT NULL,\n-        remaining_points INT NOT NULL,\n-        status VARCHAR(20) DEFAULT 'active',\n-        bound_user_id INT NULL,\n-        bound_at DATETIME NULL,\n-        expires_at DATETIME NULL,\n-        created_at DATETIME NULL,\n-        updated_at DATETIME NULL\n-      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4\n-    `);\n-    console.log('âœ… ç­‰çº§å¡è¡¨ç¡®ä¿å­˜åœ¨');\n+    // æ£€æŸ¥ level_cards è¡¨æ˜¯å¦å­˜åœ¨\n+    console.log('ğŸ”§ æ£€æŸ¥ç­‰çº§å¡è¡¨æ˜¯å¦å­˜åœ¨...');\n+    const tableExists = await query(\"SHOW TABLES LIKE 'level_cards'\");\n \n+    if (tableExists.length === 0) {\n+      console.log('âŒ level_cards è¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºè¡¨');\n+      return res.status(500).json({\n+        success: false,\n+        message: 'level_cards è¡¨ä¸å­˜åœ¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜'\n+      });\n+    }\n+\n+    console.log('âœ… level_cards è¡¨å­˜åœ¨');\n+\n+    // æ£€æŸ¥è¡¨ç»“æ„\n+    const tableStructure = await query('DESCRIBE level_cards');\n+    console.log('ğŸ“Š è¡¨ç»“æ„:', tableStructure.map(col => col.Field).join(', '));\n+\n     // è·å–å¡ç‰‡ç±»å‹ä¿¡æ¯\n     console.log('ğŸ“‹ æŸ¥è¯¢å¡ç‰‡ç±»å‹ä¿¡æ¯...');\n     let cardTypeResult;\n     try {\n"
                },
                {
                    "date": 1753016554842,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1097,49 +1097,47 @@\n         const cardPassword = generateCardPassword();\n \n         console.log(`ğŸ“ ç”Ÿæˆç¬¬${i}å¼ å¡: ${cardNumber} - ${cardPassword}`);\n \n-        // æ’å…¥ç­‰çº§å¡æ•°æ® - ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼\n+        // æ’å…¥ç­‰çº§å¡æ•°æ® - æ ¹æ®ç°æœ‰è¡¨ç»“æ„\n         try {\n-          await query(`\n-            INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n-            VALUES (?, ?, ?, ?, NOW())\n-          `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n-        } catch (insertError) {\n-          console.error(`âŒ æ’å…¥ç­‰çº§å¡æ•°æ®å¤±è´¥:`, insertError);\n+          // æ ¹æ®è¡¨ç»“æ„åŠ¨æ€æ„å»ºæ’å…¥è¯­å¥\n+          const hasRemainingPoints = tableStructure.some(col => col.Field === 'remaining_points');\n+          const hasTotalPoints = tableStructure.some(col => col.Field === 'total_points');\n+          const hasCreatedAt = tableStructure.some(col => col.Field === 'created_at');\n \n-          // å¦‚æœæ’å…¥å¤±è´¥ï¼Œå¯èƒ½æ˜¯è¡¨ç»“æ„é—®é¢˜ï¼Œå°è¯•æ£€æŸ¥è¡¨ç»“æ„\n-          try {\n-            const tableStructure = await query('DESCRIBE level_cards');\n-            console.log('ğŸ“Š level_cardsè¡¨ç»“æ„:', tableStructure);\n+          let insertSQL;\n+          let insertValues;\n \n-            // æ£€æŸ¥æ˜¯å¦ç¼ºå°‘æŸäº›å­—æ®µï¼Œå°è¯•ä¸åŒçš„æ’å…¥æ–¹å¼\n-            const hasRemainingPoints = tableStructure.some(col => col.Field === 'remaining_points');\n-            const hasTotalPoints = tableStructure.some(col => col.Field === 'total_points');\n-\n-            if (hasRemainingPoints) {\n-              // å¦‚æœæœ‰ remaining_points å­—æ®µï¼Œé‡è¯•åŸå§‹æ’å…¥\n-              await query(`\n-                INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n-                VALUES (?, ?, ?, ?, NOW())\n-              `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n-            } else if (hasTotalPoints) {\n-              // å¦‚æœåªæœ‰ total_points å­—æ®µ\n-              await query(`\n-                INSERT INTO level_cards (card_number, card_password, type_id, total_points, created_at)\n-                VALUES (?, ?, ?, ?, NOW())\n-              `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n+          if (hasRemainingPoints) {\n+            if (hasCreatedAt) {\n+              insertSQL = `INSERT INTO level_cards (card_number, card_password, type_id, remaining_points) VALUES (?, ?, ?, ?)`;\n+              insertValues = [cardNumber, cardPassword, typeInfo.id, typeInfo.points];\n             } else {\n-              // æœ€åŸºæœ¬çš„æ’å…¥\n-              await query(`\n-                INSERT INTO level_cards (card_number, card_password, type_id, created_at)\n-                VALUES (?, ?, ?, NOW())\n-              `, [cardNumber, cardPassword, typeInfo.id]);\n+              insertSQL = `INSERT INTO level_cards (card_number, card_password, type_id, remaining_points) VALUES (?, ?, ?, ?)`;\n+              insertValues = [cardNumber, cardPassword, typeInfo.id, typeInfo.points];\n             }\n-          } catch (fallbackError) {\n-            console.error(`âŒ å¤‡ç”¨æ’å…¥ä¹Ÿå¤±è´¥:`, fallbackError);\n-            throw fallbackError;\n+          } else if (hasTotalPoints) {\n+            insertSQL = `INSERT INTO level_cards (card_number, card_password, type_id, total_points) VALUES (?, ?, ?, ?)`;\n+            insertValues = [cardNumber, cardPassword, typeInfo.id, typeInfo.points];\n+          } else {\n+            insertSQL = `INSERT INTO level_cards (card_number, card_password, type_id) VALUES (?, ?, ?)`;\n+            insertValues = [cardNumber, cardPassword, typeInfo.id];\n           }\n+\n+          console.log(`ğŸ“ æ‰§è¡Œæ’å…¥SQL: ${insertSQL}`);\n+          console.log(`ğŸ“ æ’å…¥å‚æ•°:`, insertValues);\n+\n+          await query(insertSQL, insertValues);\n+\n+        } catch (insertError) {\n+          console.error(`âŒ æ’å…¥ç­‰çº§å¡æ•°æ®å¤±è´¥:`, insertError);\n+          console.error('é”™è¯¯è¯¦æƒ…:', {\n+            message: insertError.message,\n+            code: insertError.code,\n+            sqlState: insertError.sqlState\n+          });\n+          throw insertError;\n         }\n \n         generatedCards.push({\n           cardNumber,\n"
                }
            ],
            "date": 1752319729592,
            "name": "Commit-0",
            "content": "const express = require('express');\nconst router = express.Router();\nconst { query } = require('../config/database');\nconst { createExperienceCardSystem, getAvailableExperienceCards } = require('../scripts/create-experience-cards');\nconst { adminAuth } = require('../middleware/adminAuth');\n\n// ç”Ÿæˆå¡å·çš„è¾…åŠ©å‡½æ•°\nfunction generateCardNumber(cardType, index) {\n  const typePrefix = {\n    'åŸºç¡€å¡': 'BC',\n    'é«˜çº§å¡': 'AC',\n    'è‡³å°Šå¡': 'PC',\n    'ä½“éªŒå¡': 'EXP'\n  };\n\n  const prefix = typePrefix[cardType] || 'CARD';\n  const timestamp = Date.now().toString().slice(-8); // å–æ—¶é—´æˆ³å8ä½\n  const indexStr = String(index).padStart(2, '0'); // åºå·è¡¥é›¶åˆ°2ä½\n\n  return `${prefix}${timestamp}${indexStr}`;\n}\n\n// ç”Ÿæˆå¡å¯†çš„è¾…åŠ©å‡½æ•°\nfunction generateCardPassword() {\n  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n  let password = '';\n  for (let i = 0; i < 8; i++) {\n    password += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  return password;\n}\n\n\n\n// è·å–ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯\nrouter.get('/stats', adminAuth, async (req, res, next) => {\n  try {\n    // ç”¨æˆ·ç»Ÿè®¡\n    const userStats = await query(`\n      SELECT\n        COUNT(*) as total_users,\n        COUNT(CASE WHEN status = 'active' THEN 1 END) as active_users,\n        COUNT(CASE WHEN status = 'inactive' THEN 1 END) as inactive_users,\n        COUNT(CASE WHEN status = 'banned' THEN 1 END) as banned_users,\n        COUNT(CASE WHEN DATE(created_at) = CURDATE() THEN 1 END) as today_new_users\n      FROM users\n    `);\n\n    // ç­‰çº§å¡ç»Ÿè®¡\n    const cardStats = await query(`\n      SELECT\n        COUNT(*) as total_cards,\n        COUNT(CASE WHEN bound_user_id IS NOT NULL THEN 1 END) as bound_cards,\n        COUNT(CASE WHEN bound_user_id IS NULL THEN 1 END) as available_cards,\n        SUM(remaining_points) as total_remaining_points,\n        COUNT(CASE WHEN ct.name = 'ä½“éªŒå¡' THEN 1 END) as experience_cards,\n        COUNT(CASE WHEN ct.name != 'ä½“éªŒå¡' THEN 1 END) as level_cards\n      FROM level_cards lc\n      LEFT JOIN card_types ct ON lc.type_id = ct.id\n    `);\n\n    // ç§¯åˆ†æ¶ˆè´¹ç»Ÿè®¡\n    const pointsStats = await query(`\n      SELECT\n        COUNT(*) as total_transactions,\n        SUM(points_amount) as total_points_consumed,\n        COUNT(CASE WHEN DATE(created_at) = CURDATE() THEN 1 END) as today_transactions,\n        SUM(CASE WHEN DATE(created_at) = CURDATE() THEN points_amount ELSE 0 END) as today_points_consumed\n      FROM point_logs\n      WHERE action_type = 'consume'\n    `);\n\n    // æœ€è¿‘7å¤©çš„ç”¨æˆ·æ³¨å†Œè¶‹åŠ¿\n    const userTrend = await query(`\n      SELECT\n        DATE(created_at) as date,\n        COUNT(*) as count\n      FROM users\n      WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)\n      GROUP BY DATE(created_at)\n      ORDER BY date DESC\n    `);\n\n    // æœ€è¿‘7å¤©çš„ç§¯åˆ†æ¶ˆè´¹è¶‹åŠ¿\n    const pointsTrend = await query(`\n      SELECT\n        DATE(created_at) as date,\n        COUNT(*) as transactions,\n        SUM(points_amount) as points_consumed\n      FROM point_logs\n      WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)\n        AND action_type = 'consume'\n      GROUP BY DATE(created_at)\n      ORDER BY date DESC\n    `);\n\n    res.json({\n      success: true,\n      data: {\n        users: userStats[0],\n        cards: cardStats[0],\n        points: pointsStats[0],\n        trends: {\n          users: userTrend,\n          points: pointsTrend\n        }\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\nrouter.get('/users', adminAuth, async (req, res, next) => {\n  try {\n    const page = parseInt(req.query.page) || 1;\n    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n    const offset = (page - 1) * limit;\n    const status = req.query.status;\n    const search = req.query.search;\n\n    let whereClause = '';\n    let queryParams = [];\n\n    // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n    const conditions = [];\n    if (status) {\n      conditions.push('status = ?');\n      queryParams.push(status);\n    }\n    if (search) {\n      conditions.push('(username LIKE ? OR email LIKE ?)');\n      queryParams.push(`%${search}%`, `%${search}%`);\n    }\n\n    if (conditions.length > 0) {\n      whereClause = 'WHERE ' + conditions.join(' AND ');\n    }\n\n    // è·å–ç”¨æˆ·æ€»æ•°\n    const countQuery = `SELECT COUNT(*) as total FROM users ${whereClause}`;\n    const countResult = await query(countQuery, queryParams);\n    const total = countResult[0].total;\n\n    // è·å–ç”¨æˆ·åˆ—è¡¨\n    const usersQuery = `\n      SELECT u.id, u.username, u.email, u.status, u.created_at, u.last_login,\n             COUNT(lc.id) as bound_cards,\n             COALESCE(SUM(lc.remaining_points), 0) as total_points\n      FROM users u\n      LEFT JOIN level_cards lc ON u.id = lc.bound_user_id\n      ${whereClause}\n      GROUP BY u.id\n      ORDER BY u.created_at DESC\n      LIMIT ? OFFSET ?\n    `;\n\n    const users = await query(usersQuery, [...queryParams, limit, offset]);\n\n    res.json({\n      success: true,\n      data: {\n        items: users,\n        total,\n        page,\n        pageSize: limit,\n        totalPages: Math.ceil(total / limit)\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// è·å–ç”¨æˆ·è¯¦æƒ…ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\nrouter.get('/users/:id', adminAuth, async (req, res, next) => {\n  try {\n    const userId = req.params.id;\n\n    // è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯\n    const userResult = await query(`\n      SELECT id, username, email, status, created_at, updated_at, last_login\n      FROM users\n      WHERE id = ?\n    `, [userId]);\n\n    if (userResult.length === 0) {\n      return res.status(404).json({\n        success: false,\n        message: 'ç”¨æˆ·ä¸å­˜åœ¨'\n      });\n    }\n\n    const user = userResult[0];\n\n    // è·å–ç”¨æˆ·ç»‘å®šçš„ç­‰çº§å¡\n    const cards = await query(`\n      SELECT lc.id, lc.card_number, lc.remaining_points, lc.bound_at,\n             ct.name as type_name, ct.icon, ct.points as total_points\n      FROM level_cards lc\n      JOIN card_types ct ON lc.type_id = ct.id\n      WHERE lc.bound_user_id = ?\n      ORDER BY lc.bound_at DESC\n    `, [userId]);\n\n    // è·å–ç”¨æˆ·ç§¯åˆ†æ¶ˆè´¹è®°å½•\n    const pointsHistory = await query(`\n      SELECT id, action_type, points_amount, description, url, created_at\n      FROM point_logs\n      WHERE user_id = ?\n      ORDER BY created_at DESC\n      LIMIT 20\n    `, [userId]);\n\n    res.json({\n      success: true,\n      data: {\n        user,\n        cards,\n        pointsHistory,\n        summary: {\n          totalCards: cards.length,\n          totalPoints: cards.reduce((sum, card) => sum + card.remaining_points, 0),\n          totalConsumed: pointsHistory\n            .filter(log => log.action_type === 'consume')\n            .reduce((sum, log) => sum + log.points_amount, 0)\n        }\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// æ›´æ–°ç”¨æˆ·çŠ¶æ€ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\nrouter.put('/users/:id/status', adminAuth, async (req, res, next) => {\n  try {\n    const userId = req.params.id;\n    const { status } = req.body;\n\n    if (!['active', 'inactive', 'banned'].includes(status)) {\n      return res.status(400).json({\n        success: false,\n        message: 'æ— æ•ˆçš„ç”¨æˆ·çŠ¶æ€'\n      });\n    }\n\n    await query(`\n      UPDATE users\n      SET status = ?, updated_at = NOW()\n      WHERE id = ?\n    `, [status, userId]);\n\n    res.json({\n      success: true,\n      message: 'ç”¨æˆ·çŠ¶æ€æ›´æ–°æˆåŠŸ'\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// å°ç¦ç”¨æˆ·ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\nrouter.post('/users/:id/ban', adminAuth, async (req, res, next) => {\n  try {\n    const userId = req.params.id;\n\n    await query(`\n      UPDATE users\n      SET status = 'banned', updated_at = NOW()\n      WHERE id = ?\n    `, [userId]);\n\n    res.json({\n      success: true,\n      message: 'ç”¨æˆ·å·²å°ç¦'\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// è§£å°ç”¨æˆ·ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\nrouter.post('/users/:id/unban', adminAuth, async (req, res, next) => {\n  try {\n    const userId = req.params.id;\n\n    await query(`\n      UPDATE users\n      SET status = 'active', updated_at = NOW()\n      WHERE id = ?\n    `, [userId]);\n\n    res.json({\n      success: true,\n      message: 'ç”¨æˆ·å·²è§£å°'\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// åˆå§‹åŒ–ç­‰çº§å¡æ•°æ®åº“è¡¨\nrouter.post('/init-level-cards', async (req, res, next) => {\n  try {\n    console.log('ğŸ—ƒï¸ å¼€å§‹åˆ›å»ºç­‰çº§å¡ç›¸å…³æ•°æ®åº“è¡¨...');\n\n    // 1. åˆ›å»ºç­‰çº§å¡ç±»å‹è¡¨\n    console.log('ğŸ“ åˆ›å»ºç­‰çº§å¡ç±»å‹è¡¨...');\n    await query(`\n      CREATE TABLE IF NOT EXISTS level_card_types (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        name VARCHAR(50) NOT NULL COMMENT 'ç­‰çº§å¡åç§°',\n        icon VARCHAR(10) NOT NULL COMMENT 'ç­‰çº§å¡å›¾æ ‡',\n        price DECIMAL(10,2) NOT NULL COMMENT 'ä»·æ ¼',\n        points INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',\n        description TEXT COMMENT 'æè¿°',\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at DATETIME NULL\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n    `);\n    console.log('âœ… ç­‰çº§å¡ç±»å‹è¡¨åˆ›å»ºæˆåŠŸ');\n\n    // 2. åˆ›å»ºç­‰çº§å¡è¡¨\n    console.log('ğŸ“ åˆ›å»ºç­‰çº§å¡è¡¨...');\n    await query(`\n      CREATE TABLE IF NOT EXISTS level_cards (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT 'å¡å·',\n        card_password VARCHAR(20) NOT NULL COMMENT 'å¡å¯†',\n        type_id INT NOT NULL COMMENT 'ç­‰çº§å¡ç±»å‹ID',\n        total_points INT NOT NULL COMMENT 'æ€»ç§¯åˆ†',\n        remaining_points INT NOT NULL COMMENT 'å‰©ä½™ç§¯åˆ†',\n        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT 'çŠ¶æ€',\n        bound_user_id INT NULL COMMENT 'ç»‘å®šçš„ç”¨æˆ·ID',\n        bound_at DATETIME NULL COMMENT 'ç»‘å®šæ—¶é—´',\n        expires_at DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´',\n        created_at DATETIME NOT NULL,\n        updated_at DATETIME NULL,\n        FOREIGN KEY (type_id) REFERENCES level_card_types(id),\n        FOREIGN KEY (bound_user_id) REFERENCES users(id),\n        INDEX idx_card_number (card_number),\n        INDEX idx_bound_user (bound_user_id),\n        INDEX idx_status (status)\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n    `);\n    console.log('âœ… ç­‰çº§å¡è¡¨åˆ›å»ºæˆåŠŸ');\n\n    // 3. åˆ›å»ºç­‰çº§å¡ä½¿ç”¨è®°å½•è¡¨\n    console.log('ğŸ“ åˆ›å»ºç­‰çº§å¡äº¤æ˜“è®°å½•è¡¨...');\n    await query(`\n      CREATE TABLE IF NOT EXISTS level_card_transactions (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        card_id INT NOT NULL COMMENT 'ç­‰çº§å¡ID',\n        user_id INT NOT NULL COMMENT 'ç”¨æˆ·ID',\n        type ENUM('bind', 'consume') NOT NULL COMMENT 'äº¤æ˜“ç±»å‹',\n        points_amount INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',\n        remaining_points INT NOT NULL COMMENT 'æ“ä½œåå‰©ä½™ç§¯åˆ†',\n        description VARCHAR(255) COMMENT 'æè¿°',\n        created_at DATETIME NOT NULL,\n        FOREIGN KEY (card_id) REFERENCES level_cards(id),\n        FOREIGN KEY (user_id) REFERENCES users(id),\n        INDEX idx_card_user (card_id, user_id),\n        INDEX idx_created_at (created_at)\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n    `);\n    console.log('âœ… ç­‰çº§å¡äº¤æ˜“è®°å½•è¡¨åˆ›å»ºæˆåŠŸ');\n\n    // 4. æ’å…¥ç­‰çº§å¡ç±»å‹æ•°æ®ï¼ˆåŒ…å«ä½“éªŒå¡ï¼‰\n    const existingTypes = await query('SELECT COUNT(*) as count FROM level_card_types');\n    if (existingTypes[0].count === 0) {\n      await query(`\n        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n        ('ä½“éªŒå¡', 'ğŸ', 0.00, 20, 'å…è´¹ä½“éªŒå¡ï¼Œæ¯å¼ 20ç§¯åˆ†'),\n        ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300, 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n        ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000, 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n        ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000, 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·')\n      `);\n    }\n\n    res.json({\n      success: true,\n      message: 'ç­‰çº§å¡æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ'\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n\n// è·å–æ‰€æœ‰ç­‰çº§å¡åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\nrouter.get('/cards', adminAuth, async (req, res, next) => {\n  try {\n    const page = parseInt(req.query.page) || 1;\n    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n    const offset = (page - 1) * limit;\n    const status = req.query.status;\n    const cardType = req.query.type;\n    const search = req.query.search;\n\n    let whereClause = '';\n    let queryParams = [];\n\n    // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n    const conditions = [];\n    if (status) {\n      conditions.push('lc.status = ?');\n      queryParams.push(status);\n    }\n    if (cardType) {\n      conditions.push('ct.name = ?');\n      queryParams.push(cardType);\n    }\n    if (search) {\n      conditions.push('(lc.card_number LIKE ? OR u.username LIKE ?)');\n      queryParams.push(`%${search}%`, `%${search}%`);\n    }\n\n    if (conditions.length > 0) {\n      whereClause = 'WHERE ' + conditions.join(' AND ');\n    }\n\n    // è·å–ç­‰çº§å¡æ€»æ•°\n    const countQuery = `\n      SELECT COUNT(*) as total\n      FROM level_cards lc\n      LEFT JOIN card_types ct ON lc.type_id = ct.id\n      LEFT JOIN users u ON lc.bound_user_id = u.id\n      ${whereClause}\n    `;\n    const countResult = await query(countQuery, queryParams);\n    const total = countResult[0].total;\n\n    // è·å–ç­‰çº§å¡åˆ—è¡¨\n    const cardsQuery = `\n      SELECT lc.id, lc.card_number, lc.card_password, lc.remaining_points,\n             lc.bound_at, lc.created_at,\n             ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n             u.username as bound_username, u.id as bound_user_id\n      FROM level_cards lc\n      LEFT JOIN card_types ct ON lc.type_id = ct.id\n      LEFT JOIN users u ON lc.bound_user_id = u.id\n      ${whereClause}\n      ORDER BY lc.created_at DESC\n      LIMIT ? OFFSET ?\n    `;\n\n    const cards = await query(cardsQuery, [...queryParams, limit, offset]);\n\n    res.json({\n      success: true,\n      data: {\n        items: cards,\n        total,\n        page,\n        pageSize: limit,\n        totalPages: Math.ceil(total / limit)\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// è·å–ç­‰çº§å¡è¯¦æƒ…ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\nrouter.get('/cards/:id', adminAuth, async (req, res, next) => {\n  try {\n    const cardId = req.params.id;\n\n    // è·å–ç­‰çº§å¡åŸºæœ¬ä¿¡æ¯\n    const cardResult = await query(`\n      SELECT lc.id, lc.card_number, lc.card_password, lc.remaining_points,\n             lc.bound_at, lc.created_at,\n             ct.name as type_name, ct.icon, ct.points as total_points, ct.price,\n             u.username as bound_username, u.id as bound_user_id, u.email as bound_user_email\n      FROM level_cards lc\n      LEFT JOIN card_types ct ON lc.type_id = ct.id\n      LEFT JOIN users u ON lc.bound_user_id = u.id\n      WHERE lc.id = ?\n    `, [cardId]);\n\n    if (cardResult.length === 0) {\n      return res.status(404).json({\n        success: false,\n        message: 'ç­‰çº§å¡ä¸å­˜åœ¨'\n      });\n    }\n\n    const card = cardResult[0];\n\n    // è·å–è¯¥å¡çš„ä½¿ç”¨è®°å½•\n    const usageHistory = await query(`\n      SELECT id, action_type, points_amount, description, url, created_at\n      FROM point_logs\n      WHERE user_id = ? AND description LIKE '%${card.card_number}%'\n      ORDER BY created_at DESC\n      LIMIT 20\n    `, [card.bound_user_id]);\n\n    res.json({\n      success: true,\n      data: {\n        card,\n        usageHistory,\n        summary: {\n          totalUsed: card.total_points - card.remaining_points,\n          usageCount: usageHistory.filter(log => log.action_type === 'consume').length\n        }\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ç¦ç”¨/å¯ç”¨ç­‰çº§å¡ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\nrouter.put('/cards/:id/status', adminAuth, async (req, res, next) => {\n  try {\n    const cardId = req.params.id;\n    const { status } = req.body;\n\n    if (!['active', 'disabled', 'expired'].includes(status)) {\n      return res.status(400).json({\n        success: false,\n        message: 'æ— æ•ˆçš„ç­‰çº§å¡çŠ¶æ€'\n      });\n    }\n\n    await query(`\n      UPDATE level_cards\n      SET status = ?, updated_at = NOW()\n      WHERE id = ?\n    `, [status, cardId]);\n\n    res.json({\n      success: true,\n      message: 'ç­‰çº§å¡çŠ¶æ€æ›´æ–°æˆåŠŸ'\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// è§£ç»‘ç­‰çº§å¡ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\nrouter.put('/cards/:id/unbind', adminAuth, async (req, res, next) => {\n  try {\n    const cardId = req.params.id;\n\n    await query(`\n      UPDATE level_cards\n      SET bound_user_id = NULL, bound_at = NULL\n      WHERE id = ?\n    `, [cardId]);\n\n    res.json({\n      success: true,\n      message: 'ç­‰çº§å¡è§£ç»‘æˆåŠŸ'\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// è·å–ç§¯åˆ†è®°å½•åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰- å…¼å®¹æ–°å‰ç«¯è·¯å¾„\nrouter.get('/points-logs', adminAuth, async (req, res, next) => {\n  try {\n    const page = parseInt(req.query.page) || 1;\n    const pageSize = parseInt(req.query.pageSize) || 20;\n    const offset = (page - 1) * pageSize;\n    const actionType = req.query.type;\n    const search = req.query.search;\n\n    let whereClause = '';\n    let queryParams = [];\n\n    // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n    const conditions = [];\n    if (actionType) {\n      conditions.push('pl.action_type = ?');\n      queryParams.push(actionType);\n    }\n    if (search) {\n      conditions.push('u.username LIKE ?');\n      queryParams.push(`%${search}%`);\n    }\n\n    if (conditions.length > 0) {\n      whereClause = 'WHERE ' + conditions.join(' AND ');\n    }\n\n    // è·å–ç§¯åˆ†è®°å½•æ€»æ•°\n    const countQuery = `\n      SELECT COUNT(*) as total\n      FROM point_logs pl\n      LEFT JOIN users u ON pl.user_id = u.id\n      ${whereClause}\n    `;\n    const countResult = await query(countQuery, queryParams);\n    const total = countResult[0].total;\n\n    // è·å–ç§¯åˆ†è®°å½•åˆ—è¡¨\n    const pointsQuery = `\n      SELECT pl.id, pl.action_type, pl.points_amount, pl.description, pl.url, pl.created_at,\n             u.username, u.id as user_id\n      FROM point_logs pl\n      LEFT JOIN users u ON pl.user_id = u.id\n      ${whereClause}\n      ORDER BY pl.created_at DESC\n      LIMIT ? OFFSET ?\n    `;\n\n    const pointsLogs = await query(pointsQuery, [...queryParams, pageSize, offset]);\n\n    res.json({\n      success: true,\n      data: {\n        items: pointsLogs,\n        total,\n        page,\n        pageSize,\n        totalPages: Math.ceil(total / pageSize)\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// è·å–ç§¯åˆ†è®°å½•åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰- ä¿æŒåŸæœ‰æ¥å£å…¼å®¹æ€§\nrouter.get('/points', adminAuth, async (req, res, next) => {\n  try {\n    const page = parseInt(req.query.page) || 1;\n    const limit = parseInt(req.query.pageSize || req.query.limit) || 20;\n    const offset = (page - 1) * limit;\n    const actionType = req.query.type;\n    const search = req.query.search;\n\n    let whereClause = '';\n    let queryParams = [];\n\n    // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n    const conditions = [];\n    if (actionType) {\n      conditions.push('pl.action_type = ?');\n      queryParams.push(actionType);\n    }\n    if (search) {\n      conditions.push('u.username LIKE ?');\n      queryParams.push(`%${search}%`);\n    }\n\n    if (conditions.length > 0) {\n      whereClause = 'WHERE ' + conditions.join(' AND ');\n    }\n\n    // è·å–ç§¯åˆ†è®°å½•æ€»æ•°\n    const countQuery = `\n      SELECT COUNT(*) as total\n      FROM point_logs pl\n      LEFT JOIN users u ON pl.user_id = u.id\n      ${whereClause}\n    `;\n    const countResult = await query(countQuery, queryParams);\n    const total = countResult[0].total;\n\n    // è·å–ç§¯åˆ†è®°å½•åˆ—è¡¨\n    const pointsQuery = `\n      SELECT pl.id, pl.action_type, pl.points_amount, pl.description, pl.url, pl.created_at,\n             u.username, u.id as user_id\n      FROM point_logs pl\n      LEFT JOIN users u ON pl.user_id = u.id\n      ${whereClause}\n      ORDER BY pl.created_at DESC\n      LIMIT ? OFFSET ?\n    `;\n\n    const pointsLogs = await query(pointsQuery, [...queryParams, limit, offset]);\n\n    res.json({\n      success: true,\n      data: {\n        items: pointsLogs,\n        total,\n        page,\n        pageSize: limit,\n        totalPages: Math.ceil(total / limit)\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// è·å–ç³»ç»Ÿé…ç½®ä¿¡æ¯ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\nrouter.get('/config', adminAuth, async (req, res, next) => {\n  try {\n    console.log('ğŸ“¥ ä»æ•°æ®åº“åŠ è½½ç³»ç»Ÿé…ç½®...');\n\n    // ä»æ•°æ®åº“è·å–æ‰€æœ‰é…ç½®\n    const configs = await query(`\n      SELECT config_key, config_value, config_type, config_group, description, is_encrypted\n      FROM system_config\n      ORDER BY config_group, config_key\n    `);\n\n    console.log(`ğŸ“Š ä»æ•°æ®åº“åŠ è½½äº†${configs.length}é¡¹é…ç½®`);\n\n    // æŒ‰åˆ†ç»„ç»„ç»‡é…ç½®\n    const groupedConfigs = {};\n    configs.forEach(config => {\n      const group = config.config_group || 'general';\n\n      if (!groupedConfigs[group]) {\n        groupedConfigs[group] = [];\n      }\n\n      // å¤„ç†æ•æ„Ÿé…ç½®æ˜¾ç¤º\n      let displayValue = config.config_value;\n      if (config.is_encrypted && config.config_value) {\n        // å¯¹äºæ•æ„Ÿé…ç½®ï¼Œæ˜¾ç¤ºæ©ç \n        if (config.config_key.includes('password') || config.config_key.includes('secret')) {\n          displayValue = '***';\n        }\n      }\n\n      groupedConfigs[group].push({\n        config_key: config.config_key,\n        config_value: displayValue,\n        config_type: config.config_type || 'string',\n        description: config.description || '',\n        is_encrypted: config.is_encrypted || 0\n      });\n    });\n\n    // ç¡®ä¿æ‰€æœ‰å¿…è¦çš„åˆ†ç»„éƒ½å­˜åœ¨\n    const requiredGroups = ['server', 'database', 'jwt', 'comfyui', 'ai', 'frontend', 'cors', 'upload', 'log'];\n    requiredGroups.forEach(group => {\n      if (!groupedConfigs[group]) {\n        groupedConfigs[group] = [];\n      }\n    });\n\n    console.log('ğŸ“‹ é…ç½®åˆ†ç»„ç»Ÿè®¡:');\n    Object.keys(groupedConfigs).forEach(group => {\n      console.log(`   ${group}: ${groupedConfigs[group].length} é¡¹é…ç½®`);\n    });\n\n    res.json({\n      success: true,\n      data: groupedConfigs\n    });\n\n  } catch (error) {\n    console.error('âŒ åŠ è½½é…ç½®å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'åŠ è½½é…ç½®å¤±è´¥: ' + error.message\n    });\n  }\n});\n\n// ä¿å­˜ç³»ç»Ÿé…ç½®ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\nrouter.post('/config', adminAuth, async (req, res, next) => {\n  try {\n    const { configs } = req.body;\n\n    if (!configs || !Array.isArray(configs)) {\n      return res.status(400).json({\n        success: false,\n        message: 'é…ç½®æ•°æ®æ ¼å¼é”™è¯¯'\n      });\n    }\n\n    console.log('ğŸ’¾ ä¿å­˜ç³»ç»Ÿé…ç½®åˆ°æ•°æ®åº“ï¼Œå…±', configs.length, 'é¡¹');\n\n    // çœŸæ­£ä¿å­˜é…ç½®åˆ°æ•°æ®åº“\n    const results = [];\n    let successCount = 0;\n    let errorCount = 0;\n\n    for (const config of configs) {\n      const { config_key, config_value } = config;\n\n      try {\n        // æ›´æ–°æ•°æ®åº“ä¸­çš„é…ç½®\n        const result = await query(`\n          UPDATE system_config\n          SET config_value = ?, updated_at = NOW()\n          WHERE config_key = ?\n        `, [config_value, config_key]);\n\n        if (result.affectedRows > 0) {\n          console.log(`  âœ… ä¿å­˜æˆåŠŸ: ${config_key} = ${config_value}`);\n          results.push({\n            config_key,\n            updated: true,\n            message: 'æ›´æ–°æˆåŠŸ'\n          });\n          successCount++;\n        } else {\n          // å¦‚æœæ²¡æœ‰æ‰¾åˆ°é…ç½®é¡¹ï¼Œå°è¯•æ’å…¥æ–°çš„\n          try {\n            await query(`\n              INSERT INTO system_config (config_key, config_value, config_type, config_group, description)\n              VALUES (?, ?, 'string', 'custom', 'ç”¨æˆ·è‡ªå®šä¹‰é…ç½®')\n            `, [config_key, config_value]);\n\n            console.log(`  âœ… æ–°å¢æˆåŠŸ: ${config_key} = ${config_value}`);\n            results.push({\n              config_key,\n              updated: true,\n              message: 'æ–°å¢æˆåŠŸ'\n            });\n            successCount++;\n          } catch (insertError) {\n            console.log(`  âŒ æ–°å¢å¤±è´¥: ${config_key} - ${insertError.message}`);\n            results.push({\n              config_key,\n              updated: false,\n              message: 'æ–°å¢å¤±è´¥: ' + insertError.message\n            });\n            errorCount++;\n          }\n        }\n      } catch (updateError) {\n        console.log(`  âŒ æ›´æ–°å¤±è´¥: ${config_key} - ${updateError.message}`);\n        results.push({\n          config_key,\n          updated: false,\n          message: 'æ›´æ–°å¤±è´¥: ' + updateError.message\n        });\n        errorCount++;\n      }\n    }\n\n    const message = `é…ç½®ä¿å­˜å®Œæˆ: ${successCount}é¡¹æˆåŠŸ, ${errorCount}é¡¹å¤±è´¥`;\n    console.log('ğŸ“Š', message);\n\n    res.json({\n      success: errorCount === 0,\n      message: message,\n      data: {\n        results,\n        summary: {\n          total: configs.length,\n          success: successCount,\n          error: errorCount\n        }\n      }\n    });\n\n  } catch (error) {\n    console.error('âŒ ä¿å­˜é…ç½®å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'ä¿å­˜é…ç½®å¤±è´¥: ' + error.message\n    });\n  }\n});\n\n// æ‰¹é‡æ“ä½œç”¨æˆ·çŠ¶æ€ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\nrouter.put('/users/batch-status', adminAuth, async (req, res, next) => {\n  try {\n    const { userIds, status } = req.body;\n\n    if (!Array.isArray(userIds) || userIds.length === 0) {\n      return res.status(400).json({\n        success: false,\n        message: 'è¯·æä¾›æœ‰æ•ˆçš„ç”¨æˆ·IDåˆ—è¡¨'\n      });\n    }\n\n    if (!['active', 'inactive', 'banned'].includes(status)) {\n      return res.status(400).json({\n        success: false,\n        message: 'æ— æ•ˆçš„ç”¨æˆ·çŠ¶æ€'\n      });\n    }\n\n    const placeholders = userIds.map(() => '?').join(',');\n    await query(`\n      UPDATE users\n      SET status = ?, updated_at = NOW()\n      WHERE id IN (${placeholders})\n    `, [status, ...userIds]);\n\n    res.json({\n      success: true,\n      message: `æˆåŠŸæ›´æ–°${userIds.length}ä¸ªç”¨æˆ·çš„çŠ¶æ€`\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ç”Ÿæˆç­‰çº§å¡ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\nrouter.post('/generate-cards', adminAuth, async (req, res, next) => {\n  try {\n    const { cardType = 'åŸºç¡€å¡', count = 5 } = req.body;\n\n    console.log(`ğŸ« å¼€å§‹ç”Ÿæˆ${count}å¼ ${cardType}...`);\n\n    // è·å–å¡ç‰‡ç±»å‹ä¿¡æ¯ - ä¿®å¤è¡¨åï¼Œéµå¾ªå¼€å‘åŸåˆ™\n    const cardTypeResult = await query(`\n      SELECT id, name, points, price\n      FROM level_card_types\n      WHERE name = ?\n    `, [cardType]);\n\n    if (cardTypeResult.length === 0) {\n      return res.status(400).json({\n        success: false,\n        message: 'æ— æ•ˆçš„å¡ç‰‡ç±»å‹'\n      });\n    }\n\n    const typeInfo = cardTypeResult[0];\n    const generatedCards = [];\n\n    // æ‰¹é‡ç”Ÿæˆç­‰çº§å¡\n    for (let i = 1; i <= count; i++) {\n      const cardNumber = generateCardNumber(cardType, i);\n      const cardPassword = generateCardPassword();\n\n      await query(`\n        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n        VALUES (?, ?, ?, ?, NOW())\n      `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n\n      generatedCards.push({\n        cardNumber,\n        cardPassword,\n        typeName: typeInfo.name,\n        points: typeInfo.points\n      });\n    }\n\n    console.log(`âœ… æˆåŠŸç”Ÿæˆ${count}å¼ ${cardType}`);\n\n    res.json({\n      success: true,\n      message: `æˆåŠŸç”Ÿæˆ${count}å¼ ${cardType}`,\n      data: {\n        cards: generatedCards,\n        cardType: typeInfo.name,\n        totalGenerated: count\n      }\n    });\n\n  } catch (error) {\n    console.error('âŒ ç”Ÿæˆç­‰çº§å¡å¤±è´¥:', error);\n    next(error);\n  }\n});\n\n// ç”Ÿæˆä½“éªŒå¡\nrouter.post('/generate-experience-cards', adminAuth, async (req, res, next) => {\n  try {\n    const { count = 1 } = req.body;\n    console.log(`ğŸ« ç®¡ç†å‘˜è¯·æ±‚ç”Ÿæˆ${count}å¼ ä½“éªŒå¡...`);\n\n    // è·å–ä½“éªŒå¡ç±»å‹ä¿¡æ¯ - ä¿®å¤è¡¨åï¼Œéµå¾ªå¼€å‘åŸåˆ™\n    const cardTypeResult = await query(`\n      SELECT id, name, points, price\n      FROM level_card_types\n      WHERE name = 'ä½“éªŒå¡'\n    `);\n\n    if (cardTypeResult.length === 0) {\n      return res.status(400).json({\n        success: false,\n        message: 'ä½“éªŒå¡ç±»å‹ä¸å­˜åœ¨'\n      });\n    }\n\n    const typeInfo = cardTypeResult[0];\n    const generatedCards = [];\n\n    // æ‰¹é‡ç”Ÿæˆä½“éªŒå¡\n    for (let i = 1; i <= count; i++) {\n      const cardNumber = generateCardNumber('ä½“éªŒå¡', i);\n      const cardPassword = generateCardPassword();\n\n      await query(`\n        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points, created_at)\n        VALUES (?, ?, ?, ?, NOW())\n      `, [cardNumber, cardPassword, typeInfo.id, typeInfo.points]);\n\n      generatedCards.push({\n        cardNumber,\n        cardPassword,\n        typeName: typeInfo.name,\n        points: typeInfo.points\n      });\n    }\n\n    console.log(`âœ… æˆåŠŸç”Ÿæˆ${count}å¼ ä½“éªŒå¡`);\n\n    res.json({\n      success: true,\n      message: `æˆåŠŸç”Ÿæˆ${count}å¼ ä½“éªŒå¡`,\n      data: {\n        cards: generatedCards,\n        cardType: typeInfo.name,\n        totalGenerated: count\n      }\n    });\n\n  } catch (error) {\n    console.error('âŒ ç”Ÿæˆä½“éªŒå¡å¤±è´¥:', error);\n    next(error);\n  }\n});\n\n// è·å–ä½“éªŒå¡ç»Ÿè®¡ä¿¡æ¯\nrouter.get('/experience-cards-stats', adminAuth, async (req, res, next) => {\n  try {\n    // è·å–ä½“éªŒå¡ç»Ÿè®¡\n    const stats = await query(`\n      SELECT\n        COUNT(*) as total_cards,\n        COUNT(CASE WHEN bound_user_id IS NULL THEN 1 END) as available_cards,\n        COUNT(CASE WHEN bound_user_id IS NOT NULL THEN 1 END) as bound_cards,\n        SUM(CASE WHEN bound_user_id IS NULL THEN remaining_points ELSE 0 END) as available_points,\n        SUM(CASE WHEN bound_user_id IS NOT NULL THEN remaining_points ELSE 0 END) as bound_points\n      FROM level_cards lc\n      JOIN card_types ct ON lc.type_id = ct.id\n      WHERE ct.name = 'ä½“éªŒå¡'\n    `);\n\n    // è·å–å¯ç”¨ä½“éªŒå¡åˆ—è¡¨\n    const availableCards = await getAvailableExperienceCards();\n\n    res.json({\n      success: true,\n      data: {\n        stats: stats[0],\n        availableCards: availableCards.slice(0, 10) // åªè¿”å›å‰10å¼ ä½œä¸ºç¤ºä¾‹\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// æµ‹è¯•æ•°æ®åº“è¿æ¥ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\nrouter.post('/test-database', adminAuth, async (req, res, next) => {\n  try {\n    // ç®€å•çš„æ•°æ®åº“è¿æ¥æµ‹è¯•\n    await query('SELECT 1 as test');\n\n    res.json({\n      success: true,\n      message: 'æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ'\n    });\n\n  } catch (error) {\n    console.error('âŒ æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message\n    });\n  }\n});\n\n// æµ‹è¯•ComfyUIè¿æ¥ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\nrouter.post('/test-comfyui', adminAuth, async (req, res, next) => {\n  try {\n    // ä»è¯·æ±‚ä½“è·å–æœåŠ¡å™¨åœ°å€ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤é…ç½®\n    let serverUrl = req.body?.serverUrl;\n\n    // å¦‚æœæ²¡æœ‰æä¾›æœåŠ¡å™¨åœ°å€ï¼Œä»æ•°æ®åº“è·å–é…ç½®\n    if (!serverUrl) {\n      try {\n        const [configRows] = await query(\n          'SELECT config_value FROM system_config WHERE config_key = ?',\n          ['comfyui.server_url']\n        );\n        serverUrl = configRows.length > 0 ? configRows[0].config_value : 'https://your-comfyui-server.com';\n      } catch (dbError) {\n        console.error('è·å–ComfyUIé…ç½®å¤±è´¥:', dbError);\n        serverUrl = 'https://your-comfyui-server.com';\n      }\n    }\n\n    // ç¡®ä¿URLæ ¼å¼æ­£ç¡®\n    if (serverUrl && !serverUrl.startsWith('http')) {\n      serverUrl = 'https://' + serverUrl;\n    }\n\n    // ç§»é™¤æœ«å°¾çš„æ–œæ \n    if (serverUrl && serverUrl.endsWith('/')) {\n      serverUrl = serverUrl.slice(0, -1);\n    }\n\n    console.log('ğŸ§ª æµ‹è¯•ComfyUIè¿æ¥:', serverUrl);\n\n    // æµ‹è¯•ComfyUIè¿æ¥\n    const fetch = require('node-fetch');\n\n    // å°è¯•å¤šä¸ªç«¯ç‚¹æ¥æ£€æµ‹ComfyUIæœåŠ¡å™¨\n    const testEndpoints = [\n      `${serverUrl}/system_stats`,  // ComfyUIç³»ç»ŸçŠ¶æ€ç«¯ç‚¹\n      `${serverUrl}/history`,       // ComfyUIå†å²è®°å½•ç«¯ç‚¹\n      `${serverUrl}/`,              // æ ¹è·¯å¾„\n    ];\n\n    let lastError = null;\n    let response = null;\n\n    // ä¾æ¬¡å°è¯•ä¸åŒçš„ç«¯ç‚¹\n    for (const testUrl of testEndpoints) {\n      try {\n        console.log(`ğŸ” å°è¯•ç«¯ç‚¹: ${testUrl}`);\n\n        response = await fetch(testUrl, {\n          method: 'GET',\n          timeout: 10000,\n          headers: {\n            'User-Agent': 'ComfyUI-Admin-Test/1.0'\n          }\n        });\n\n        console.log(`ğŸ“¡ ç«¯ç‚¹ ${testUrl} å“åº”çŠ¶æ€:`, response.status, response.statusText);\n\n        // å¦‚æœå¾—åˆ°å“åº”ï¼ˆå³ä½¿æ˜¯é”™è¯¯çŠ¶æ€ç ï¼‰ï¼Œè¯´æ˜æœåŠ¡å™¨æ˜¯å¯è¾¾çš„\n        if (response) {\n          break;\n        }\n      } catch (error) {\n        console.log(`âŒ ç«¯ç‚¹ ${testUrl} å¤±è´¥:`, error.message);\n        lastError = error;\n        continue;\n      }\n    }\n\n    // å¦‚æœæ‰€æœ‰ç«¯ç‚¹éƒ½å¤±è´¥äº†\n    if (!response) {\n      throw lastError || new Error('æ‰€æœ‰æµ‹è¯•ç«¯ç‚¹éƒ½æ— æ³•è®¿é—®');\n    }\n\n    if (response.status === 200) {\n      // æœåŠ¡å™¨æ­£å¸¸å“åº”\n      res.json({\n        success: true,\n        message: 'ComfyUIæœåŠ¡å™¨è¿æ¥æˆåŠŸ',\n        data: {\n          serverUrl,\n          status: 'connected',\n          statusCode: response.status,\n          message: 'æœåŠ¡å™¨å¯æ­£å¸¸è®¿é—®'\n        }\n      });\n    } else if (response.status === 401) {\n      // æœåŠ¡å™¨éœ€è¦è®¤è¯ï¼Œä½†å¯ä»¥è¿æ¥\n      res.json({\n        success: true,\n        message: 'ComfyUIæœåŠ¡å™¨è¿æ¥æˆåŠŸï¼ˆéœ€è¦è®¤è¯ï¼‰',\n        data: {\n          serverUrl,\n          status: 'connected_auth_required',\n          statusCode: response.status,\n          message: 'æœåŠ¡å™¨å¯è®¿é—®ï¼Œä½†éœ€è¦è®¤è¯'\n        }\n      });\n    } else if (response.status === 404) {\n      // è·¯å¾„ä¸å­˜åœ¨ï¼Œä½†æœåŠ¡å™¨å¯è¾¾\n      res.json({\n        success: true,\n        message: 'ComfyUIæœåŠ¡å™¨è¿æ¥æˆåŠŸ',\n        data: {\n          serverUrl,\n          status: 'connected',\n          statusCode: response.status,\n          message: 'æœåŠ¡å™¨å¯è®¿é—®ï¼ˆè·¯å¾„ä¸å­˜åœ¨æ˜¯æ­£å¸¸çš„ï¼‰'\n        }\n      });\n    } else {\n      // å…¶ä»–çŠ¶æ€ç \n      res.json({\n        success: false,\n        message: `ComfyUIæœåŠ¡å™¨å“åº”å¼‚å¸¸: ${response.status} ${response.statusText}`,\n        data: {\n          serverUrl,\n          status: 'error',\n          statusCode: response.status\n        }\n      });\n    }\n\n  } catch (error) {\n    console.error('âŒ ComfyUIè¿æ¥æµ‹è¯•å¤±è´¥:', error);\n\n    if (error.code === 'ENOTFOUND') {\n      res.status(500).json({\n        success: false,\n        message: 'ComfyUIæœåŠ¡å™¨åŸŸåæ— æ³•è§£æï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®',\n        data: {\n          serverUrl: serverUrl || 'unknown',\n          status: 'dns_error',\n          error: error.code,\n          message: 'Domain name resolution failed'\n        }\n      });\n    } else if (error.code === 'ECONNREFUSED') {\n      res.status(500).json({\n        success: false,\n        message: 'ComfyUIæœåŠ¡å™¨æ‹’ç»è¿æ¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ',\n        data: {\n          serverUrl: serverUrl || 'unknown',\n          status: 'connection_refused',\n          error: error.code,\n          message: 'Connection refused by server'\n        }\n      });\n    } else if (error.name === 'AbortError' || error.message.includes('timeout')) {\n      res.status(500).json({\n        success: false,\n        message: 'ComfyUIæœåŠ¡å™¨è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',\n        data: {\n          serverUrl: serverUrl || 'unknown',\n          status: 'timeout',\n          error: 'timeout',\n          message: 'Connection timeout'\n        }\n      });\n    } else {\n      res.status(500).json({\n        success: false,\n        message: 'ComfyUIè¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message,\n        data: {\n          serverUrl: serverUrl || 'unknown',\n          status: 'error',\n          error: error.message,\n          message: 'Unknown connection error'\n        }\n      });\n    }\n  }\n});\n\n// ç”Ÿæˆå¡å¯†å‡½æ•°å·²åœ¨æ–‡ä»¶å¼€å¤´å®šä¹‰ï¼Œè¿™é‡Œåˆ é™¤é‡å¤å®šä¹‰\n\nmodule.exports = router;\n"
        }
    ]
}