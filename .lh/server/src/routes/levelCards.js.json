{
    "sourceFile": "server/src/routes/levelCards.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 10,
            "patches": [
                {
                    "date": 1752322119517,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752322136731,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -42,9 +42,9 @@\n     // æŸ¥æ‰¾ç­‰çº§å¡åŠå…¶ç±»åž‹ä¿¡æ¯\n     const cardResult = await query(`\n       SELECT lc.*, ct.name as type_name, ct.icon, ct.points as total_points\n       FROM level_cards lc\n-      JOIN card_types ct ON lc.type_id = ct.id\n+      JOIN level_card_types ct ON lc.type_id = ct.id\n       WHERE lc.card_number = ? AND lc.card_password = ?\n     `, [cardNumber, cardPassword]);\n \n     if (cardResult.length === 0) {\n"
                },
                {
                    "date": 1752322154554,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -134,9 +134,9 @@\n     const cards = await query(`\n       SELECT lc.id, lc.card_number, lc.remaining_points, lc.bound_at,\n              ct.name as type_name, ct.icon, ct.points as total_points, ct.price\n       FROM level_cards lc\n-      JOIN card_types ct ON lc.type_id = ct.id\n+      JOIN level_card_types ct ON lc.type_id = ct.id\n       WHERE lc.bound_user_id = ?\n         AND (\n           ct.name != 'ä½“éªŒå¡' OR\n           (ct.name = 'ä½“éªŒå¡' AND lc.remaining_points > 0)\n"
                },
                {
                    "date": 1752342851558,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -55,8 +55,34 @@\n     }\n \n     const card = cardResult[0];\n \n+    // å¦‚æžœæ˜¯ä½“éªŒå¡ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»ç»‘å®šäº†æœªä½¿ç”¨çš„ä½“éªŒå¡\n+    if (card.type_name === 'ä½“éªŒå¡') {\n+      console.log(`ðŸŽ æ£€æŸ¥ç”¨æˆ·${userId}çš„ä½“éªŒå¡ç»‘å®šçŠ¶æ€...`);\n+\n+      const existingExperienceCards = await query(`\n+        SELECT lc.id, lc.card_number, lc.remaining_points\n+        FROM level_cards lc\n+        JOIN level_card_types ct ON lc.type_id = ct.id\n+        WHERE lc.bound_user_id = ?\n+          AND ct.name = 'ä½“éªŒå¡'\n+          AND lc.remaining_points > 0\n+      `, [userId]);\n+\n+      if (existingExperienceCards.length > 0) {\n+        const existingCard = existingExperienceCards[0];\n+        console.log(`âŒ ç”¨æˆ·${userId}å·²ç»‘å®šæœªä½¿ç”¨çš„ä½“éªŒå¡: ${existingCard.card_number}ï¼Œå‰©ä½™ç§¯åˆ†: ${existingCard.remaining_points}`);\n+\n+        return res.status(400).json({\n+          success: false,\n+          message: `æ‚¨å·²ç»‘å®šä½“éªŒå¡ ${existingCard.card_number}ï¼ˆå‰©ä½™${existingCard.remaining_points}ç§¯åˆ†ï¼‰ï¼Œè¯·å…ˆä½¿ç”¨å®Œå½“å‰ä½“éªŒå¡åŽå†ç»‘å®šæ–°çš„ä½“éªŒå¡`\n+        });\n+      }\n+    }\n+\n+    const card = cardResult[0];\n+\n     // æ£€æŸ¥æ˜¯å¦å·²è¢«ç»‘å®š\n     if (card.bound_user_id) {\n       return res.status(400).json({\n         success: false,\n"
                },
                {
                    "date": 1752342867051,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -55,34 +55,8 @@\n     }\n \n     const card = cardResult[0];\n \n-    // å¦‚æžœæ˜¯ä½“éªŒå¡ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»ç»‘å®šäº†æœªä½¿ç”¨çš„ä½“éªŒå¡\n-    if (card.type_name === 'ä½“éªŒå¡') {\n-      console.log(`ðŸŽ æ£€æŸ¥ç”¨æˆ·${userId}çš„ä½“éªŒå¡ç»‘å®šçŠ¶æ€...`);\n-\n-      const existingExperienceCards = await query(`\n-        SELECT lc.id, lc.card_number, lc.remaining_points\n-        FROM level_cards lc\n-        JOIN level_card_types ct ON lc.type_id = ct.id\n-        WHERE lc.bound_user_id = ?\n-          AND ct.name = 'ä½“éªŒå¡'\n-          AND lc.remaining_points > 0\n-      `, [userId]);\n-\n-      if (existingExperienceCards.length > 0) {\n-        const existingCard = existingExperienceCards[0];\n-        console.log(`âŒ ç”¨æˆ·${userId}å·²ç»‘å®šæœªä½¿ç”¨çš„ä½“éªŒå¡: ${existingCard.card_number}ï¼Œå‰©ä½™ç§¯åˆ†: ${existingCard.remaining_points}`);\n-\n-        return res.status(400).json({\n-          success: false,\n-          message: `æ‚¨å·²ç»‘å®šä½“éªŒå¡ ${existingCard.card_number}ï¼ˆå‰©ä½™${existingCard.remaining_points}ç§¯åˆ†ï¼‰ï¼Œè¯·å…ˆä½¿ç”¨å®Œå½“å‰ä½“éªŒå¡åŽå†ç»‘å®šæ–°çš„ä½“éªŒå¡`\n-        });\n-      }\n-    }\n-\n-    const card = cardResult[0];\n-\n     // æ£€æŸ¥æ˜¯å¦å·²è¢«ç»‘å®š\n     if (card.bound_user_id) {\n       return res.status(400).json({\n         success: false,\n"
                },
                {
                    "date": 1752343609989,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -68,9 +68,9 @@\n     if (card.type_name === 'ä½“éªŒå¡') {\n       const existingExperienceCard = await query(`\n         SELECT COUNT(*) as count\n         FROM level_cards lc\n-        JOIN card_types ct ON lc.type_id = ct.id\n+        JOIN level_card_types ct ON lc.type_id = ct.id\n         WHERE lc.bound_user_id = ? AND ct.name = 'ä½“éªŒå¡' AND lc.remaining_points > 0\n       `, [userId]);\n \n       if (existingExperienceCard[0].count > 0) {\n"
                },
                {
                    "date": 1752346750471,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,9 +8,9 @@\n router.get('/types', async (req, res, next) => {\n   try {\n     const cardTypes = await query(`\n       SELECT id, name, icon, points, price\n-      FROM level_card_types\n+      FROM card_types\n       ORDER BY points ASC\n     `);\n \n     res.json({\n"
                },
                {
                    "date": 1752346767232,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -42,9 +42,9 @@\n     // æŸ¥æ‰¾ç­‰çº§å¡åŠå…¶ç±»åž‹ä¿¡æ¯\n     const cardResult = await query(`\n       SELECT lc.*, ct.name as type_name, ct.icon, ct.points as total_points\n       FROM level_cards lc\n-      JOIN level_card_types ct ON lc.type_id = ct.id\n+      JOIN card_types ct ON lc.type_id = ct.id\n       WHERE lc.card_number = ? AND lc.card_password = ?\n     `, [cardNumber, cardPassword]);\n \n     if (cardResult.length === 0) {\n"
                },
                {
                    "date": 1752346780048,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -68,9 +68,9 @@\n     if (card.type_name === 'ä½“éªŒå¡') {\n       const existingExperienceCard = await query(`\n         SELECT COUNT(*) as count\n         FROM level_cards lc\n-        JOIN level_card_types ct ON lc.type_id = ct.id\n+        JOIN card_types ct ON lc.type_id = ct.id\n         WHERE lc.bound_user_id = ? AND ct.name = 'ä½“éªŒå¡' AND lc.remaining_points > 0\n       `, [userId]);\n \n       if (existingExperienceCard[0].count > 0) {\n"
                },
                {
                    "date": 1752346796968,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -134,9 +134,9 @@\n     const cards = await query(`\n       SELECT lc.id, lc.card_number, lc.remaining_points, lc.bound_at,\n              ct.name as type_name, ct.icon, ct.points as total_points, ct.price\n       FROM level_cards lc\n-      JOIN level_card_types ct ON lc.type_id = ct.id\n+      JOIN card_types ct ON lc.type_id = ct.id\n       WHERE lc.bound_user_id = ?\n         AND (\n           ct.name != 'ä½“éªŒå¡' OR\n           (ct.name = 'ä½“éªŒå¡' AND lc.remaining_points > 0)\n"
                },
                {
                    "date": 1752346834555,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -167,9 +167,9 @@\n       SELECT lct.id, lct.type, lct.points_amount, lct.remaining_points, lct.description, lct.created_at,\n              lc.card_number, lctype.name as card_type_name, lctype.icon\n       FROM level_card_transactions lct\n       JOIN level_cards lc ON lct.card_id = lc.id\n-      JOIN level_card_types lctype ON lc.type_id = lctype.id\n+      JOIN card_types lctype ON lc.type_id = lctype.id\n       WHERE lct.user_id = ?\n       ORDER BY lct.created_at DESC\n       LIMIT ? OFFSET ?\n     `, [userId, parseInt(limit), parseInt(offset)]);\n"
                }
            ],
            "date": 1752322119517,
            "name": "Commit-0",
            "content": "const express = require('express');\nconst router = express.Router();\nconst { query } = require('../config/database');\nconst { authenticateToken } = require('../middleware/auth');\nconst { calculateUserPoints, getUserPointsDetails, consumeUserPoints } = require('../utils/pointsCalculator');\n\n// èŽ·å–ç­‰çº§å¡ç±»åž‹åˆ—è¡¨\nrouter.get('/types', async (req, res, next) => {\n  try {\n    const cardTypes = await query(`\n      SELECT id, name, icon, points, price\n      FROM level_card_types\n      ORDER BY points ASC\n    `);\n\n    res.json({\n      success: true,\n      data: {\n        cardTypes\n      }\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ç»‘å®šç­‰çº§å¡\nrouter.post('/bind', authenticateToken, async (req, res, next) => {\n  try {\n    const userId = req.user.userId;\n    const { cardNumber, cardPassword } = req.body;\n\n    if (!cardNumber || !cardPassword) {\n      return res.status(400).json({\n        success: false,\n        message: 'è¯·è¾“å…¥å¡å·å’Œå¡å¯†'\n      });\n    }\n\n    console.log(`ðŸŽ« ç”¨æˆ·${userId}å°è¯•ç»‘å®šç­‰çº§å¡: ${cardNumber}`);\n\n    // æŸ¥æ‰¾ç­‰çº§å¡åŠå…¶ç±»åž‹ä¿¡æ¯\n    const cardResult = await query(`\n      SELECT lc.*, ct.name as type_name, ct.icon, ct.points as total_points\n      FROM level_cards lc\n      JOIN card_types ct ON lc.type_id = ct.id\n      WHERE lc.card_number = ? AND lc.card_password = ?\n    `, [cardNumber, cardPassword]);\n\n    if (cardResult.length === 0) {\n      return res.status(400).json({\n        success: false,\n        message: 'å¡å·æˆ–å¡å¯†é”™è¯¯ï¼Œè¯·æ£€æŸ¥åŽé‡è¯•'\n      });\n    }\n\n    const card = cardResult[0];\n\n    // æ£€æŸ¥æ˜¯å¦å·²è¢«ç»‘å®š\n    if (card.bound_user_id) {\n      return res.status(400).json({\n        success: false,\n        message: 'è¯¥ç­‰çº§å¡å·²è¢«ç»‘å®šï¼Œè¯·ä½¿ç”¨å…¶ä»–å¡ç‰‡'\n      });\n    }\n\n    // ä½“éªŒå¡ç‰¹æ®Šé€»è¾‘ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰æœ‰ç§¯åˆ†çš„ä½“éªŒå¡\n    if (card.type_name === 'ä½“éªŒå¡') {\n      const existingExperienceCard = await query(`\n        SELECT COUNT(*) as count\n        FROM level_cards lc\n        JOIN card_types ct ON lc.type_id = ct.id\n        WHERE lc.bound_user_id = ? AND ct.name = 'ä½“éªŒå¡' AND lc.remaining_points > 0\n      `, [userId]);\n\n      if (existingExperienceCard[0].count > 0) {\n        return res.status(400).json({\n          success: false,\n          message: 'æ‚¨å·²æœ‰å¯ç”¨çš„ä½“éªŒå¡ï¼Œè¯·å…ˆä½¿ç”¨å®Œå½“å‰ä½“éªŒå¡ç§¯åˆ†'\n        });\n      }\n    }\n\n    try {\n      // 1. ç»‘å®šå¡ç‰‡åˆ°ç”¨æˆ·\n      await query(`\n        UPDATE level_cards\n        SET bound_user_id = ?, bound_at = NOW()\n        WHERE id = ?\n      `, [userId, card.id]);\n\n      // 2. è®°å½•ç»‘å®šæ—¥å¿—\n      await query(`\n        INSERT INTO point_logs (user_id, action_type, points_amount, description)\n        VALUES (?, 'bind', ?, ?)\n      `, [userId, card.remaining_points, `ç»‘å®š${card.type_name}`]);\n\n      console.log(`âœ… ç”¨æˆ·${userId}æˆåŠŸç»‘å®š${card.type_name}${cardNumber}ï¼ŒèŽ·å¾—${card.remaining_points}ç§¯åˆ†`);\n\n      // æ ¹æ®å¡ç‰‡ç±»åž‹è¿”å›žä¸åŒçš„æ¶ˆæ¯\n      const message = card.type_name === 'ä½“éªŒå¡'\n        ? 'ä½“éªŒå¡ç»‘å®šæˆåŠŸï¼æ¯ä¸ªç”¨æˆ·åªèƒ½ç»‘å®šä¸€å¼ ä½“éªŒå¡'\n        : 'ç­‰çº§å¡ç»‘å®šæˆåŠŸ';\n\n      res.json({\n        success: true,\n        message,\n        data: {\n          cardType: card.type_name,\n          cardIcon: card.icon,\n          pointsAdded: card.remaining_points,\n          cardNumber: card.card_number,\n          isExperienceCard: card.type_name === 'ä½“éªŒå¡'\n        }\n      });\n\n    } catch (error) {\n      throw error;\n    }\n\n  } catch (error) {\n    console.error(`âŒ ç”¨æˆ·${req.user?.userId}ç»‘å®šç­‰çº§å¡å¤±è´¥:`, error);\n    next(error);\n  }\n});\n\n// èŽ·å–ç”¨æˆ·ç»‘å®šçš„ç­‰çº§å¡åˆ—è¡¨\nrouter.get('/my-cards', authenticateToken, async (req, res, next) => {\n  try {\n    const userId = req.user.userId;\n\n    // æŸ¥æ‰¾ç”¨æˆ·ç»‘å®šçš„ç­‰çº§å¡åŠå…¶ç±»åž‹ä¿¡æ¯\n    // ä½“éªŒå¡ä¸€æ¬¡æ€§ä½¿ç”¨ï¼Œç§¯åˆ†ä¸º0æ—¶ä¸å†æ˜¾ç¤º\n    const cards = await query(`\n      SELECT lc.id, lc.card_number, lc.remaining_points, lc.bound_at,\n             ct.name as type_name, ct.icon, ct.points as total_points, ct.price\n      FROM level_cards lc\n      JOIN card_types ct ON lc.type_id = ct.id\n      WHERE lc.bound_user_id = ?\n        AND (\n          ct.name != 'ä½“éªŒå¡' OR\n          (ct.name = 'ä½“éªŒå¡' AND lc.remaining_points > 0)\n        )\n      ORDER BY lc.bound_at DESC\n    `, [userId]);\n\n    res.json({\n      success: true,\n      data: {\n        cards\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// èŽ·å–ç­‰çº§å¡ä½¿ç”¨è®°å½•\nrouter.get('/transactions', authenticateToken, async (req, res, next) => {\n  try {\n    const userId = req.user.userId;\n    const { page = 1, limit = 20 } = req.query;\n    const offset = (page - 1) * limit;\n\n    const transactions = await query(`\n      SELECT lct.id, lct.type, lct.points_amount, lct.remaining_points, lct.description, lct.created_at,\n             lc.card_number, lctype.name as card_type_name, lctype.icon\n      FROM level_card_transactions lct\n      JOIN level_cards lc ON lct.card_id = lc.id\n      JOIN level_card_types lctype ON lc.type_id = lctype.id\n      WHERE lct.user_id = ?\n      ORDER BY lct.created_at DESC\n      LIMIT ? OFFSET ?\n    `, [userId, parseInt(limit), parseInt(offset)]);\n\n    // èŽ·å–æ€»è®°å½•æ•°\n    const countResult = await query(\n      'SELECT COUNT(*) as total FROM level_card_transactions WHERE user_id = ?',\n      [userId]\n    );\n\n    res.json({\n      success: true,\n      data: {\n        transactions,\n        pagination: {\n          page: parseInt(page),\n          limit: parseInt(limit),\n          total: countResult[0].total,\n          totalPages: Math.ceil(countResult[0].total / limit)\n        }\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// æ—§çš„consumeæŽ¥å£å·²åˆ é™¤ï¼Œè¯·ä½¿ç”¨consume-pointsæŽ¥å£\n\n// èŽ·å–ç”¨æˆ·æ€»ç§¯åˆ†ï¼ˆåŸºäºŽç»‘å®šçš„ç­‰çº§å¡ï¼‰\nrouter.get('/user-points', authenticateToken, async (req, res, next) => {\n  try {\n    const userId = req.user.userId;\n\n    // ä½¿ç”¨ç§¯åˆ†è®¡ç®—å·¥å…·èŽ·å–è¯¦ç»†ä¿¡æ¯\n    const pointsDetails = await getUserPointsDetails(userId);\n\n    // ç”Ÿæˆå¡ç‰‡æ˜Žç»†\n    const cardsBreakdown = pointsDetails.cards.map(card => ({\n      type: card.type_name,\n      points: card.remaining_points\n    }));\n\n    res.json({\n      success: true,\n      data: {\n        points: 0, // æ²¡æœ‰å…è´¹ç§¯åˆ†æ¦‚å¿µ\n        purchased_points: pointsDetails.totalPoints,\n        total_points: pointsDetails.totalPoints,\n        cards_count: pointsDetails.cardCount,\n        cards_breakdown: cardsBreakdown\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\n// æ¶ˆè´¹ç§¯åˆ†ï¼ˆä»Žç­‰çº§å¡æ‰£é™¤ï¼‰\nrouter.post('/consume-points', authenticateToken, async (req, res, next) => {\n  try {\n    const userId = req.user.userId;\n    const { amount, description = 'ç§¯åˆ†æ¶ˆè´¹', mediaUrl = null } = req.body;\n\n    if (!amount || amount <= 0) {\n      return res.status(400).json({\n        success: false,\n        message: 'æ¶ˆè´¹ç§¯åˆ†æ•°é‡å¿…é¡»å¤§äºŽ0'\n      });\n    }\n\n    console.log(`ðŸ’° ç”¨æˆ·${userId}å°è¯•æ¶ˆè´¹${amount}ç§¯åˆ†: ${description}`);\n    if (mediaUrl) {\n      console.log(`ðŸŽ¬ å…³è”åª’ä½“URL: ${mediaUrl}`);\n    }\n\n    // ä½¿ç”¨ç§¯åˆ†è®¡ç®—å·¥å…·æ¶ˆè´¹ç§¯åˆ†ï¼ˆåŒ…å«åª’ä½“æ–‡ä»¶URLï¼‰\n    const result = await consumeUserPoints(userId, amount, description, mediaUrl);\n\n    if (!result.success) {\n      return res.status(400).json({\n        success: false,\n        message: result.message,\n        data: {\n          available: result.available,\n          required: result.required\n        }\n      });\n    }\n\n    console.log(`âœ… ç”¨æˆ·${userId}æˆåŠŸæ¶ˆè´¹${amount}ç§¯åˆ†`);\n\n    res.json({\n      success: true,\n      message: result.message,\n      data: {\n        consumed_amount: result.totalConsumed,\n        remaining_points: result.remainingPoints,\n        description,\n        mediaUrl: result.mediaUrl\n      }\n    });\n\n  } catch (error) {\n    console.error(`âŒ ç”¨æˆ·${req.user?.userId}æ¶ˆè´¹ç§¯åˆ†å¤±è´¥:`, error);\n    next(error);\n  }\n});\n\n// èŽ·å–ç”¨æˆ·ç§¯åˆ†è®°å½•\nrouter.get('/point-logs', authenticateToken, async (req, res, next) => {\n  try {\n    const userId = req.user.userId;\n    const { page = 1, limit = 20, recent = false } = req.query;\n    const offset = (page - 1) * limit;\n\n    // å¦‚æžœæ˜¯èŽ·å–æœ€è¿‘è®°å½•ï¼Œé™åˆ¶ä¸º3æ¡\n    const actualLimit = recent === 'true' ? 3 : parseInt(limit);\n    const actualOffset = recent === 'true' ? 0 : parseInt(offset);\n\n    // èŽ·å–ç§¯åˆ†è®°å½•ï¼ˆåŒ…å«åª’ä½“æ–‡ä»¶URLï¼‰\n    const logs = await query(`\n      SELECT\n        action_type,\n        points_amount,\n        description,\n        url,\n        created_at\n      FROM point_logs\n      WHERE user_id = ?\n      ORDER BY created_at DESC\n      LIMIT ? OFFSET ?\n    `, [userId, actualLimit, actualOffset]);\n\n    // èŽ·å–æ€»è®°å½•æ•°\n    const totalResult = await query(`\n      SELECT COUNT(*) as total\n      FROM point_logs\n      WHERE user_id = ?\n    `, [userId]);\n\n    const total = totalResult[0].total;\n\n    res.json({\n      success: true,\n      data: {\n        logs,\n        pagination: {\n          page: parseInt(page),\n          limit: actualLimit,\n          total,\n          totalPages: Math.ceil(total / actualLimit),\n          hasMore: total > actualLimit\n        }\n      }\n    });\n\n  } catch (error) {\n    next(error);\n  }\n});\n\nmodule.exports = router;\n"
        }
    ]
}