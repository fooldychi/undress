{
    "sourceFile": "server/src/routes/workflow-config.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 15,
            "patches": [
                {
                    "date": 1752813382472,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752816638855,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -229,9 +229,17 @@\n   try {\n     const { workflows } = req.body;\n \n     console.log('ğŸ“ æ‰¹é‡æ›´æ–°å·¥ä½œæµé…ç½®...');\n+    console.log('ğŸ“Š æ¥æ”¶åˆ°çš„æ•°æ®:', JSON.stringify(workflows, null, 2));\n \n+    if (!workflows || typeof workflows !== 'object') {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'æ— æ•ˆçš„å·¥ä½œæµé…ç½®æ•°æ®'\n+      });\n+    }\n+\n     // å¼€å§‹äº‹åŠ¡\n     await query('START TRANSACTION');\n \n     try {\n"
                },
                {
                    "date": 1752816657272,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -243,18 +243,22 @@\n     await query('START TRANSACTION');\n \n     try {\n       for (const [workflowType, config] of Object.entries(workflows)) {\n+        console.log(`ğŸ”§ å¤„ç†å·¥ä½œæµ: ${workflowType}`, config);\n+\n         // æ›´æ–°å·¥ä½œæµåŸºç¡€ä¿¡æ¯\n         if (config.name || config.description || config.enabled !== undefined) {\n-          await query(`\n+          console.log(`ğŸ“ æ›´æ–°å·¥ä½œæµåŸºç¡€ä¿¡æ¯: ${workflowType}`);\n+          const result = await query(`\n             UPDATE workflow_info\n             SET workflow_name = COALESCE(?, workflow_name),\n                 description = COALESCE(?, description),\n                 is_enabled = COALESCE(?, is_enabled),\n                 updated_at = CURRENT_TIMESTAMP\n             WHERE workflow_type = ?\n           `, [config.name, config.description, config.enabled, workflowType]);\n+          console.log(`âœ… å·¥ä½œæµåŸºç¡€ä¿¡æ¯æ›´æ–°ç»“æœ:`, result);\n         }\n \n         // æ›´æ–°è¾“å…¥èŠ‚ç‚¹\n         if (config.inputNodes) {\n"
                },
                {
                    "date": 1752816675504,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -261,14 +261,17 @@\n         }\n \n         // æ›´æ–°è¾“å…¥èŠ‚ç‚¹\n         if (config.inputNodes) {\n+          console.log(`ğŸ“ æ›´æ–°è¾“å…¥èŠ‚ç‚¹: ${workflowType}`, config.inputNodes);\n           for (const [nodeKey, nodeId] of Object.entries(config.inputNodes)) {\n-            await query(`\n+            console.log(`  - æ›´æ–°è¾“å…¥èŠ‚ç‚¹: ${nodeKey} -> ${nodeId}`);\n+            const result = await query(`\n               UPDATE workflow_configs\n               SET node_id = ?, updated_at = CURRENT_TIMESTAMP\n               WHERE workflow_type = ? AND node_type = 'input' AND node_key = ?\n             `, [nodeId, workflowType, nodeKey]);\n+            console.log(`  âœ… è¾“å…¥èŠ‚ç‚¹æ›´æ–°ç»“æœ:`, result);\n           }\n         }\n \n         // æ›´æ–°è¾“å‡ºèŠ‚ç‚¹\n"
                },
                {
                    "date": 1752816692246,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -275,14 +275,17 @@\n         }\n \n         // æ›´æ–°è¾“å‡ºèŠ‚ç‚¹\n         if (config.outputNodes) {\n+          console.log(`ğŸ“ æ›´æ–°è¾“å‡ºèŠ‚ç‚¹: ${workflowType}`, config.outputNodes);\n           for (const outputNode of config.outputNodes) {\n-            await query(`\n+            console.log(`  - æ›´æ–°è¾“å‡ºèŠ‚ç‚¹: ${outputNode.key} -> ${outputNode.nodeId} (ä¼˜å…ˆçº§: ${outputNode.order})`);\n+            const result = await query(`\n               UPDATE workflow_configs\n               SET node_id = ?, node_order = ?, updated_at = CURRENT_TIMESTAMP\n               WHERE workflow_type = ? AND node_type = 'output' AND node_key = ?\n             `, [outputNode.nodeId, outputNode.order, workflowType, outputNode.key]);\n+            console.log(`  âœ… è¾“å‡ºèŠ‚ç‚¹æ›´æ–°ç»“æœ:`, result);\n           }\n         }\n       }\n \n"
                },
                {
                    "date": 1752816875231,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -238,10 +238,9 @@\n         message: 'æ— æ•ˆçš„å·¥ä½œæµé…ç½®æ•°æ®'\n       });\n     }\n \n-    // å¼€å§‹äº‹åŠ¡\n-    await query('START TRANSACTION');\n+    let updateCount = 0;\n \n     try {\n       for (const [workflowType, config] of Object.entries(workflows)) {\n         console.log(`ğŸ”§ å¤„ç†å·¥ä½œæµ: ${workflowType}`, config);\n"
                },
                {
                    "date": 1752816896343,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -240,25 +240,29 @@\n     }\n \n     let updateCount = 0;\n \n-    try {\n-      for (const [workflowType, config] of Object.entries(workflows)) {\n-        console.log(`ğŸ”§ å¤„ç†å·¥ä½œæµ: ${workflowType}`, config);\n+    for (const [workflowType, config] of Object.entries(workflows)) {\n+      console.log(`ğŸ”§ å¤„ç†å·¥ä½œæµ: ${workflowType}`, config);\n \n-        // æ›´æ–°å·¥ä½œæµåŸºç¡€ä¿¡æ¯\n-        if (config.name || config.description || config.enabled !== undefined) {\n-          console.log(`ğŸ“ æ›´æ–°å·¥ä½œæµåŸºç¡€ä¿¡æ¯: ${workflowType}`);\n+      // æ›´æ–°å·¥ä½œæµåŸºç¡€ä¿¡æ¯\n+      if (config.name || config.description || config.enabled !== undefined) {\n+        console.log(`ğŸ“ æ›´æ–°å·¥ä½œæµåŸºç¡€ä¿¡æ¯: ${workflowType}`);\n+        try {\n           const result = await query(`\n             UPDATE workflow_info\n             SET workflow_name = COALESCE(?, workflow_name),\n                 description = COALESCE(?, description),\n                 is_enabled = COALESCE(?, is_enabled),\n-                updated_at = CURRENT_TIMESTAMP\n+                updated_at = NOW()\n             WHERE workflow_type = ?\n           `, [config.name, config.description, config.enabled, workflowType]);\n           console.log(`âœ… å·¥ä½œæµåŸºç¡€ä¿¡æ¯æ›´æ–°ç»“æœ:`, result);\n+          updateCount++;\n+        } catch (error) {\n+          console.error(`âŒ æ›´æ–°å·¥ä½œæµåŸºç¡€ä¿¡æ¯å¤±è´¥: ${workflowType}`, error);\n         }\n+      }\n \n         // æ›´æ–°è¾“å…¥èŠ‚ç‚¹\n         if (config.inputNodes) {\n           console.log(`ğŸ“ æ›´æ–°è¾“å…¥èŠ‚ç‚¹: ${workflowType}`, config.inputNodes);\n"
                },
                {
                    "date": 1752816915152,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -262,21 +262,26 @@\n           console.error(`âŒ æ›´æ–°å·¥ä½œæµåŸºç¡€ä¿¡æ¯å¤±è´¥: ${workflowType}`, error);\n         }\n       }\n \n-        // æ›´æ–°è¾“å…¥èŠ‚ç‚¹\n-        if (config.inputNodes) {\n-          console.log(`ğŸ“ æ›´æ–°è¾“å…¥èŠ‚ç‚¹: ${workflowType}`, config.inputNodes);\n-          for (const [nodeKey, nodeId] of Object.entries(config.inputNodes)) {\n-            console.log(`  - æ›´æ–°è¾“å…¥èŠ‚ç‚¹: ${nodeKey} -> ${nodeId}`);\n+      // æ›´æ–°è¾“å…¥èŠ‚ç‚¹\n+      if (config.inputNodes) {\n+        console.log(`ğŸ“ æ›´æ–°è¾“å…¥èŠ‚ç‚¹: ${workflowType}`, config.inputNodes);\n+        for (const [nodeKey, nodeId] of Object.entries(config.inputNodes)) {\n+          console.log(`  - æ›´æ–°è¾“å…¥èŠ‚ç‚¹: ${nodeKey} -> ${nodeId}`);\n+          try {\n             const result = await query(`\n               UPDATE workflow_configs\n-              SET node_id = ?, updated_at = CURRENT_TIMESTAMP\n+              SET node_id = ?, updated_at = NOW()\n               WHERE workflow_type = ? AND node_type = 'input' AND node_key = ?\n             `, [nodeId, workflowType, nodeKey]);\n             console.log(`  âœ… è¾“å…¥èŠ‚ç‚¹æ›´æ–°ç»“æœ:`, result);\n+            updateCount++;\n+          } catch (error) {\n+            console.error(`  âŒ æ›´æ–°è¾“å…¥èŠ‚ç‚¹å¤±è´¥: ${nodeKey}`, error);\n           }\n         }\n+      }\n \n         // æ›´æ–°è¾“å‡ºèŠ‚ç‚¹\n         if (config.outputNodes) {\n           console.log(`ğŸ“ æ›´æ–°è¾“å‡ºèŠ‚ç‚¹: ${workflowType}`, config.outputNodes);\n"
                },
                {
                    "date": 1752816936608,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -281,35 +281,36 @@\n           }\n         }\n       }\n \n-        // æ›´æ–°è¾“å‡ºèŠ‚ç‚¹\n-        if (config.outputNodes) {\n-          console.log(`ğŸ“ æ›´æ–°è¾“å‡ºèŠ‚ç‚¹: ${workflowType}`, config.outputNodes);\n-          for (const outputNode of config.outputNodes) {\n-            console.log(`  - æ›´æ–°è¾“å‡ºèŠ‚ç‚¹: ${outputNode.key} -> ${outputNode.nodeId} (ä¼˜å…ˆçº§: ${outputNode.order})`);\n+      // æ›´æ–°è¾“å‡ºèŠ‚ç‚¹\n+      if (config.outputNodes) {\n+        console.log(`ğŸ“ æ›´æ–°è¾“å‡ºèŠ‚ç‚¹: ${workflowType}`, config.outputNodes);\n+        for (const outputNode of config.outputNodes) {\n+          console.log(`  - æ›´æ–°è¾“å‡ºèŠ‚ç‚¹: ${outputNode.key} -> ${outputNode.nodeId} (ä¼˜å…ˆçº§: ${outputNode.order})`);\n+          try {\n             const result = await query(`\n               UPDATE workflow_configs\n-              SET node_id = ?, node_order = ?, updated_at = CURRENT_TIMESTAMP\n+              SET node_id = ?, node_order = ?, updated_at = NOW()\n               WHERE workflow_type = ? AND node_type = 'output' AND node_key = ?\n             `, [outputNode.nodeId, outputNode.order, workflowType, outputNode.key]);\n             console.log(`  âœ… è¾“å‡ºèŠ‚ç‚¹æ›´æ–°ç»“æœ:`, result);\n+            updateCount++;\n+          } catch (error) {\n+            console.error(`  âŒ æ›´æ–°è¾“å‡ºèŠ‚ç‚¹å¤±è´¥: ${outputNode.key}`, error);\n           }\n         }\n       }\n+    }\n \n-      await query('COMMIT');\n+    console.log(`ğŸ‰ æ‰¹é‡æ›´æ–°å®Œæˆï¼Œå…±æ›´æ–° ${updateCount} é¡¹é…ç½®`);\n \n-      res.json({\n-        success: true,\n-        message: 'æ‰¹é‡æ›´æ–°æˆåŠŸ'\n-      });\n+    res.json({\n+      success: true,\n+      message: `æ‰¹é‡æ›´æ–°æˆåŠŸï¼Œå…±æ›´æ–° ${updateCount} é¡¹é…ç½®`,\n+      updateCount\n+    });\n \n-    } catch (error) {\n-      await query('ROLLBACK');\n-      throw error;\n-    }\n-\n   } catch (error) {\n     console.error('âŒ æ‰¹é‡æ›´æ–°å¤±è´¥:', error);\n     res.status(500).json({\n       success: false,\n"
                },
                {
                    "date": 1752820384267,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -274,9 +274,14 @@\n               SET node_id = ?, updated_at = NOW()\n               WHERE workflow_type = ? AND node_type = 'input' AND node_key = ?\n             `, [nodeId, workflowType, nodeKey]);\n             console.log(`  âœ… è¾“å…¥èŠ‚ç‚¹æ›´æ–°ç»“æœ:`, result);\n-            updateCount++;\n+            console.log(`  ğŸ“Š å½±å“è¡Œæ•°: ${result.affectedRows}, æ”¹å˜è¡Œæ•°: ${result.changedRows}`);\n+            if (result.affectedRows > 0) {\n+              updateCount++;\n+            } else {\n+              console.log(`  âš ï¸ æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è®°å½•: ${workflowType}/${nodeKey}`);\n+            }\n           } catch (error) {\n             console.error(`  âŒ æ›´æ–°è¾“å…¥èŠ‚ç‚¹å¤±è´¥: ${nodeKey}`, error);\n           }\n         }\n"
                },
                {
                    "date": 1752820416034,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -298,9 +298,14 @@\n               SET node_id = ?, node_order = ?, updated_at = NOW()\n               WHERE workflow_type = ? AND node_type = 'output' AND node_key = ?\n             `, [outputNode.nodeId, outputNode.order, workflowType, outputNode.key]);\n             console.log(`  âœ… è¾“å‡ºèŠ‚ç‚¹æ›´æ–°ç»“æœ:`, result);\n-            updateCount++;\n+            console.log(`  ğŸ“Š å½±å“è¡Œæ•°: ${result.affectedRows}, æ”¹å˜è¡Œæ•°: ${result.changedRows}`);\n+            if (result.affectedRows > 0) {\n+              updateCount++;\n+            } else {\n+              console.log(`  âš ï¸ æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è®°å½•: ${workflowType}/${outputNode.key}`);\n+            }\n           } catch (error) {\n             console.error(`  âŒ æ›´æ–°è¾“å‡ºèŠ‚ç‚¹å¤±è´¥: ${outputNode.key}`, error);\n           }\n         }\n"
                },
                {
                    "date": 1752820471722,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -256,9 +256,14 @@\n                 updated_at = NOW()\n             WHERE workflow_type = ?\n           `, [config.name, config.description, config.enabled, workflowType]);\n           console.log(`âœ… å·¥ä½œæµåŸºç¡€ä¿¡æ¯æ›´æ–°ç»“æœ:`, result);\n-          updateCount++;\n+          console.log(`ğŸ“Š å½±å“è¡Œæ•°: ${result.affectedRows}, æ”¹å˜è¡Œæ•°: ${result.changedRows}`);\n+          if (result.affectedRows > 0) {\n+            updateCount++;\n+          } else {\n+            console.log(`âš ï¸ æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å·¥ä½œæµ: ${workflowType}`);\n+          }\n         } catch (error) {\n           console.error(`âŒ æ›´æ–°å·¥ä½œæµåŸºç¡€ä¿¡æ¯å¤±è´¥: ${workflowType}`, error);\n         }\n       }\n"
                },
                {
                    "date": 1752823587392,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -247,16 +247,40 @@\n       // æ›´æ–°å·¥ä½œæµåŸºç¡€ä¿¡æ¯\n       if (config.name || config.description || config.enabled !== undefined) {\n         console.log(`ğŸ“ æ›´æ–°å·¥ä½œæµåŸºç¡€ä¿¡æ¯: ${workflowType}`);\n         try {\n-          const result = await query(`\n-            UPDATE workflow_info\n-            SET workflow_name = COALESCE(?, workflow_name),\n-                description = COALESCE(?, description),\n-                is_enabled = COALESCE(?, is_enabled),\n-                updated_at = NOW()\n-            WHERE workflow_type = ?\n-          `, [config.name, config.description, config.enabled, workflowType]);\n+          // æ„å»ºåŠ¨æ€æ›´æ–°è¯­å¥ï¼Œåªæ›´æ–°æä¾›çš„å­—æ®µ\n+          const updateFields = [];\n+          const updateValues = [];\n+\n+          if (config.name !== undefined) {\n+            updateFields.push('workflow_name = ?');\n+            updateValues.push(config.name);\n+          }\n+\n+          if (config.description !== undefined) {\n+            updateFields.push('description = ?');\n+            updateValues.push(config.description);\n+          }\n+\n+          if (config.enabled !== undefined) {\n+            updateFields.push('is_enabled = ?');\n+            updateValues.push(config.enabled);\n+          }\n+\n+          if (updateFields.length === 0) {\n+            console.log(`âš ï¸ æ²¡æœ‰éœ€è¦æ›´æ–°çš„å·¥ä½œæµåŸºç¡€ä¿¡æ¯å­—æ®µ: ${workflowType}`);\n+            continue;\n+          }\n+\n+          updateFields.push('updated_at = NOW()');\n+          updateValues.push(workflowType);\n+\n+          const sql = `UPDATE workflow_info SET ${updateFields.join(', ')} WHERE workflow_type = ?`;\n+          console.log(`ğŸ“ æ‰§è¡ŒSQL: ${sql}`);\n+          console.log(`ğŸ“Š å‚æ•°: [${updateValues.join(', ')}]`);\n+\n+          const result = await query(sql, updateValues);\n           console.log(`âœ… å·¥ä½œæµåŸºç¡€ä¿¡æ¯æ›´æ–°ç»“æœ:`, result);\n           console.log(`ğŸ“Š å½±å“è¡Œæ•°: ${result.affectedRows}, æ”¹å˜è¡Œæ•°: ${result.changedRows}`);\n           if (result.affectedRows > 0) {\n             updateCount++;\n"
                },
                {
                    "date": 1752824215753,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -357,5 +357,96 @@\n     });\n   }\n });\n \n+// è·å–å¯ç”¨çš„åŠŸèƒ½åˆ—è¡¨ï¼ˆç”¨äºé¦–é¡µæ˜¾ç¤ºï¼‰\n+router.get('/features', async (req, res) => {\n+  try {\n+    console.log('ğŸ“¥ è·å–å¯ç”¨çš„åŠŸèƒ½åˆ—è¡¨...');\n+\n+    // è·å–å¯ç”¨çš„å·¥ä½œæµ\n+    const enabledWorkflows = await query(`\n+      SELECT workflow_type, workflow_name, is_enabled\n+      FROM workflow_info\n+      WHERE is_enabled = TRUE\n+      ORDER BY workflow_type\n+    `);\n+\n+    // åŠŸèƒ½æ˜ å°„é…ç½®\n+    const featureMapping = {\n+      'undress': {\n+        id: 'clothes-swap',\n+        title: 'ä¸€é”®è¤ªè¡£',\n+        description: 'æ™ºèƒ½è¯†åˆ«äººç‰©è½®å»“ï¼Œå¿«é€Ÿç§»é™¤ç…§ç‰‡ä¸­çš„æœè£…ï¼Œä½“éªŒå‰æ²¿AIæŠ€æœ¯',\n+        route: '/clothes-swap',\n+        icon: {\n+          type: 'custom',\n+          component: 'UndressWomanIcon',\n+          size: 28,\n+          color: '#667eea'\n+        },\n+        iconClass: 'undress-icon',\n+        tags: [\n+          { text: 'AIè¯†åˆ«', type: 'primary' },\n+          { text: 'å¿«é€Ÿå¤„ç†', type: 'success' }\n+        ],\n+        requireLogin: true,\n+        order: 1,\n+        category: 'image-processing',\n+        pointsCost: 20\n+      },\n+      'faceswap': {\n+        id: 'face-swap',\n+        title: 'æé€Ÿæ¢è„¸',\n+        description: 'ç²¾å‡†é¢éƒ¨è¯†åˆ«æŠ€æœ¯ï¼Œå®ç°è‡ªç„¶çš„äººè„¸æ›¿æ¢æ•ˆæœï¼Œåˆ›é€ æœ‰è¶£å†…å®¹',\n+        route: '/face-swap',\n+        icon: {\n+          type: 'custom',\n+          component: 'FaceSwapIcon',\n+          size: 28,\n+          color: '#f093fb'\n+        },\n+        iconClass: 'faceswap-icon',\n+        tags: [\n+          { text: 'é¢éƒ¨è¯†åˆ«', type: 'warning' },\n+          { text: 'è‡ªç„¶æ•ˆæœ', type: 'primary' }\n+        ],\n+        requireLogin: true,\n+        order: 2,\n+        category: 'image-processing',\n+        pointsCost: 20\n+      }\n+    };\n+\n+    // æ ¹æ®å¯ç”¨çš„å·¥ä½œæµç”ŸæˆåŠŸèƒ½åˆ—è¡¨\n+    const enabledFeatures = enabledWorkflows\n+      .map(workflow => {\n+        const feature = featureMapping[workflow.workflow_type];\n+        if (feature) {\n+          return {\n+            ...feature,\n+            enabled: Boolean(workflow.is_enabled),\n+            workflowName: workflow.workflow_name\n+          };\n+        }\n+        return null;\n+      })\n+      .filter(feature => feature !== null)\n+      .sort((a, b) => a.order - b.order);\n+\n+    console.log(`âœ… è¿”å› ${enabledFeatures.length} ä¸ªå¯ç”¨çš„åŠŸèƒ½`);\n+\n+    res.json({\n+      success: true,\n+      data: enabledFeatures\n+    });\n+\n+  } catch (error) {\n+    console.error('âŒ è·å–åŠŸèƒ½åˆ—è¡¨å¤±è´¥:', error);\n+    res.status(500).json({\n+      success: false,\n+      message: 'è·å–åŠŸèƒ½åˆ—è¡¨å¤±è´¥: ' + error.message\n+    });\n+  }\n+});\n+\n module.exports = router;\n"
                },
                {
                    "date": 1752829434348,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -40,10 +40,13 @@\n       const workflow = result[config.workflow_type];\n       if (!workflow) return;\n \n       if (config.node_type === 'input') {\n-        workflow.inputNodes[config.node_key] = {\n-          nodeId: config.node_id,\n+        // ä¸ºäº†ä¸å…¬å¼€APIä¿æŒä¸€è‡´ï¼Œç›´æ¥ä½¿ç”¨node_idä½œä¸ºå€¼\n+        workflow.inputNodes[config.node_key] = config.node_id;\n+        // é¢å¤–ä¿¡æ¯å­˜å‚¨åœ¨metadataä¸­\n+        if (!workflow.metadata) workflow.metadata = { inputNodes: {}, outputNodes: {} };\n+        workflow.metadata.inputNodes[config.node_key] = {\n           description: config.description,\n           enabled: config.is_enabled\n         };\n       } else if (config.node_type === 'output') {\n"
                },
                {
                    "date": 1752836046760,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -363,9 +363,12 @@\n \n // è·å–å¯ç”¨çš„åŠŸèƒ½åˆ—è¡¨ï¼ˆç”¨äºé¦–é¡µæ˜¾ç¤ºï¼‰\n router.get('/features', async (req, res) => {\n   try {\n-    console.log('ğŸ“¥ è·å–å¯ç”¨çš„åŠŸèƒ½åˆ—è¡¨...');\n+    // ç®€åŒ–æ—¥å¿—è¾“å‡º\n+    if (process.env.NODE_ENV === 'development') {\n+      console.log('ğŸ“¥ è·å–å¯ç”¨çš„åŠŸèƒ½åˆ—è¡¨...');\n+    }\n \n     // è·å–å¯ç”¨çš„å·¥ä½œæµ\n     const enabledWorkflows = await query(`\n       SELECT workflow_type, workflow_name, is_enabled\n"
                }
            ],
            "date": 1752813382472,
            "name": "Commit-0",
            "content": "const express = require('express');\nconst router = express.Router();\nconst { query } = require('../config/database');\nconst { adminAuth } = require('../middleware/adminAuth');\n\n// è·å–æ‰€æœ‰å·¥ä½œæµé…ç½®ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰\nrouter.get('/', adminAuth, async (req, res) => {\n  try {\n    console.log('ğŸ“¥ è·å–å·¥ä½œæµé…ç½®...');\n\n    // è·å–å·¥ä½œæµåŸºç¡€ä¿¡æ¯\n    const workflowInfos = await query(`\n      SELECT workflow_type, workflow_name, description, file_path, is_enabled\n      FROM workflow_info\n      ORDER BY workflow_type\n    `);\n\n    // è·å–èŠ‚ç‚¹é…ç½®\n    const nodeConfigs = await query(`\n      SELECT workflow_type, node_type, node_key, node_id, node_order, description, is_enabled\n      FROM workflow_configs\n      ORDER BY workflow_type, node_type, node_order\n    `);\n\n    // ç»„ç»‡æ•°æ®ç»“æ„\n    const result = {};\n\n    workflowInfos.forEach(info => {\n      result[info.workflow_type] = {\n        name: info.workflow_name,\n        description: info.description,\n        filePath: info.file_path,\n        enabled: info.is_enabled,\n        inputNodes: {},\n        outputNodes: []\n      };\n    });\n\n    nodeConfigs.forEach(config => {\n      const workflow = result[config.workflow_type];\n      if (!workflow) return;\n\n      if (config.node_type === 'input') {\n        workflow.inputNodes[config.node_key] = {\n          nodeId: config.node_id,\n          description: config.description,\n          enabled: config.is_enabled\n        };\n      } else if (config.node_type === 'output') {\n        workflow.outputNodes.push({\n          key: config.node_key,\n          nodeId: config.node_id,\n          order: config.node_order,\n          description: config.description,\n          enabled: config.is_enabled\n        });\n      }\n    });\n\n    console.log(`ğŸ“Š è¿”å› ${Object.keys(result).length} ä¸ªå·¥ä½œæµé…ç½®`);\n\n    res.json({\n      success: true,\n      data: result\n    });\n\n  } catch (error) {\n    console.error('âŒ è·å–å·¥ä½œæµé…ç½®å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'è·å–å·¥ä½œæµé…ç½®å¤±è´¥: ' + error.message\n    });\n  }\n});\n\n// è·å–å…¬å¼€çš„å·¥ä½œæµé…ç½®ï¼ˆå‰ç«¯ç”¨ï¼‰\nrouter.get('/public', async (req, res) => {\n  try {\n    console.log('ğŸ“¥ è·å–å…¬å¼€å·¥ä½œæµé…ç½®...');\n\n    // åªè·å–å¯ç”¨çš„å·¥ä½œæµå’ŒèŠ‚ç‚¹\n    const workflowInfos = await query(`\n      SELECT workflow_type, workflow_name, is_enabled\n      FROM workflow_info\n      WHERE is_enabled = TRUE\n      ORDER BY workflow_type\n    `);\n\n    const nodeConfigs = await query(`\n      SELECT workflow_type, node_type, node_key, node_id, node_order\n      FROM workflow_configs\n      WHERE is_enabled = TRUE\n      ORDER BY workflow_type, node_type, node_order\n    `);\n\n    // ç»„ç»‡æ•°æ®ç»“æ„\n    const result = {};\n\n    workflowInfos.forEach(info => {\n      result[info.workflow_type] = {\n        name: info.workflow_name,\n        enabled: info.is_enabled,\n        inputNodes: {},\n        outputNodes: []\n      };\n    });\n\n    nodeConfigs.forEach(config => {\n      const workflow = result[config.workflow_type];\n      if (!workflow) return;\n\n      if (config.node_type === 'input') {\n        workflow.inputNodes[config.node_key] = config.node_id;\n      } else if (config.node_type === 'output') {\n        workflow.outputNodes.push({\n          key: config.node_key,\n          nodeId: config.node_id,\n          order: config.node_order\n        });\n      }\n    });\n\n    // å¯¹è¾“å‡ºèŠ‚ç‚¹æŒ‰ä¼˜å…ˆçº§æ’åº\n    Object.values(result).forEach(workflow => {\n      workflow.outputNodes.sort((a, b) => a.order - b.order);\n    });\n\n    console.log(`ğŸ“Š è¿”å› ${Object.keys(result).length} ä¸ªå…¬å¼€å·¥ä½œæµé…ç½®`);\n\n    res.json({\n      success: true,\n      data: result\n    });\n\n  } catch (error) {\n    console.error('âŒ è·å–å…¬å¼€å·¥ä½œæµé…ç½®å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'è·å–å…¬å¼€å·¥ä½œæµé…ç½®å¤±è´¥: ' + error.message\n    });\n  }\n});\n\n// æ›´æ–°å·¥ä½œæµåŸºç¡€ä¿¡æ¯\nrouter.put('/info/:workflowType', adminAuth, async (req, res) => {\n  try {\n    const { workflowType } = req.params;\n    const { workflow_name, description, file_path, is_enabled } = req.body;\n\n    console.log(`ğŸ“ æ›´æ–°å·¥ä½œæµä¿¡æ¯: ${workflowType}`);\n\n    await query(`\n      UPDATE workflow_info\n      SET workflow_name = ?, description = ?, file_path = ?, is_enabled = ?, updated_at = CURRENT_TIMESTAMP\n      WHERE workflow_type = ?\n    `, [workflow_name, description, file_path, is_enabled, workflowType]);\n\n    res.json({\n      success: true,\n      message: 'å·¥ä½œæµä¿¡æ¯æ›´æ–°æˆåŠŸ'\n    });\n\n  } catch (error) {\n    console.error('âŒ æ›´æ–°å·¥ä½œæµä¿¡æ¯å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'æ›´æ–°å·¥ä½œæµä¿¡æ¯å¤±è´¥: ' + error.message\n    });\n  }\n});\n\n// æ›´æ–°èŠ‚ç‚¹é…ç½®\nrouter.put('/nodes/:workflowType', adminAuth, async (req, res) => {\n  try {\n    const { workflowType } = req.params;\n    const { inputNodes, outputNodes } = req.body;\n\n    console.log(`ğŸ“ æ›´æ–°èŠ‚ç‚¹é…ç½®: ${workflowType}`);\n\n    // å¼€å§‹äº‹åŠ¡\n    await query('START TRANSACTION');\n\n    try {\n      // æ›´æ–°è¾“å…¥èŠ‚ç‚¹\n      if (inputNodes) {\n        for (const [nodeKey, nodeId] of Object.entries(inputNodes)) {\n          await query(`\n            UPDATE workflow_configs\n            SET node_id = ?, updated_at = CURRENT_TIMESTAMP\n            WHERE workflow_type = ? AND node_type = 'input' AND node_key = ?\n          `, [nodeId, workflowType, nodeKey]);\n        }\n      }\n\n      // æ›´æ–°è¾“å‡ºèŠ‚ç‚¹\n      if (outputNodes) {\n        for (const outputNode of outputNodes) {\n          await query(`\n            UPDATE workflow_configs\n            SET node_id = ?, node_order = ?, updated_at = CURRENT_TIMESTAMP\n            WHERE workflow_type = ? AND node_type = 'output' AND node_key = ?\n          `, [outputNode.nodeId, outputNode.order, workflowType, outputNode.key]);\n        }\n      }\n\n      await query('COMMIT');\n\n      res.json({\n        success: true,\n        message: 'èŠ‚ç‚¹é…ç½®æ›´æ–°æˆåŠŸ'\n      });\n\n    } catch (error) {\n      await query('ROLLBACK');\n      throw error;\n    }\n\n  } catch (error) {\n    console.error('âŒ æ›´æ–°èŠ‚ç‚¹é…ç½®å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'æ›´æ–°èŠ‚ç‚¹é…ç½®å¤±è´¥: ' + error.message\n    });\n  }\n});\n\n// æ‰¹é‡æ›´æ–°å·¥ä½œæµé…ç½®\nrouter.post('/batch-update', adminAuth, async (req, res) => {\n  try {\n    const { workflows } = req.body;\n\n    console.log('ğŸ“ æ‰¹é‡æ›´æ–°å·¥ä½œæµé…ç½®...');\n\n    // å¼€å§‹äº‹åŠ¡\n    await query('START TRANSACTION');\n\n    try {\n      for (const [workflowType, config] of Object.entries(workflows)) {\n        // æ›´æ–°å·¥ä½œæµåŸºç¡€ä¿¡æ¯\n        if (config.name || config.description || config.enabled !== undefined) {\n          await query(`\n            UPDATE workflow_info\n            SET workflow_name = COALESCE(?, workflow_name),\n                description = COALESCE(?, description),\n                is_enabled = COALESCE(?, is_enabled),\n                updated_at = CURRENT_TIMESTAMP\n            WHERE workflow_type = ?\n          `, [config.name, config.description, config.enabled, workflowType]);\n        }\n\n        // æ›´æ–°è¾“å…¥èŠ‚ç‚¹\n        if (config.inputNodes) {\n          for (const [nodeKey, nodeId] of Object.entries(config.inputNodes)) {\n            await query(`\n              UPDATE workflow_configs\n              SET node_id = ?, updated_at = CURRENT_TIMESTAMP\n              WHERE workflow_type = ? AND node_type = 'input' AND node_key = ?\n            `, [nodeId, workflowType, nodeKey]);\n          }\n        }\n\n        // æ›´æ–°è¾“å‡ºèŠ‚ç‚¹\n        if (config.outputNodes) {\n          for (const outputNode of config.outputNodes) {\n            await query(`\n              UPDATE workflow_configs\n              SET node_id = ?, node_order = ?, updated_at = CURRENT_TIMESTAMP\n              WHERE workflow_type = ? AND node_type = 'output' AND node_key = ?\n            `, [outputNode.nodeId, outputNode.order, workflowType, outputNode.key]);\n          }\n        }\n      }\n\n      await query('COMMIT');\n\n      res.json({\n        success: true,\n        message: 'æ‰¹é‡æ›´æ–°æˆåŠŸ'\n      });\n\n    } catch (error) {\n      await query('ROLLBACK');\n      throw error;\n    }\n\n  } catch (error) {\n    console.error('âŒ æ‰¹é‡æ›´æ–°å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'æ‰¹é‡æ›´æ–°å¤±è´¥: ' + error.message\n    });\n  }\n});\n\nmodule.exports = router;\n"
        }
    ]
}