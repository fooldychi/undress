{
    "sourceFile": "server/src/routes/comfyui-status.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1752332138551,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752332174286,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -240,5 +240,238 @@\n     });\n   }\n });\n \n+/**\n+ * ä»£ç†ComfyUIä¸Šä¼ å›¾ç‰‡æ¥å£ï¼ˆä½¿ç”¨è´Ÿè½½å‡è¡¡ï¼‰\n+ */\n+router.post('/upload', upload.single('image'), async (req, res) => {\n+  try {\n+    console.log('ğŸ“¤ ä»£ç†ComfyUIå›¾ç‰‡ä¸Šä¼ è¯·æ±‚...');\n+\n+    if (!req.file) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'è¯·æä¾›å›¾ç‰‡æ–‡ä»¶'\n+      });\n+    }\n+\n+    console.log('ğŸ“‹ ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯:', {\n+      originalname: req.file.originalname,\n+      mimetype: req.file.mimetype,\n+      size: `${(req.file.size / 1024).toFixed(2)} KB`\n+    });\n+\n+    // åˆ›å»ºFormDataç”¨äºè½¬å‘åˆ°ComfyUI\n+    const FormData = require('form-data');\n+    const formData = new FormData();\n+\n+    formData.append('image', req.file.buffer, {\n+      filename: req.file.originalname || 'upload.jpg',\n+      contentType: req.file.mimetype || 'image/jpeg'\n+    });\n+\n+    // æ·»åŠ ComfyUIéœ€è¦çš„å…¶ä»–å‚æ•°\n+    if (req.body.type) formData.append('type', req.body.type);\n+    if (req.body.subfolder) formData.append('subfolder', req.body.subfolder);\n+    if (req.body.overwrite) formData.append('overwrite', req.body.overwrite);\n+\n+    // ä½¿ç”¨è´Ÿè½½å‡è¡¡å‘é€è¯·æ±‚\n+    const result = await comfyUIRequest('/upload/image', {\n+      method: 'POST',\n+      body: formData,\n+      headers: formData.getHeaders()\n+    });\n+\n+    console.log('âœ… ComfyUIå›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', result);\n+\n+    res.json({\n+      success: true,\n+      data: result,\n+      message: 'å›¾ç‰‡ä¸Šä¼ æˆåŠŸ'\n+    });\n+\n+  } catch (error) {\n+    console.error('âŒ ä»£ç†ComfyUIå›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);\n+    res.status(500).json({\n+      success: false,\n+      message: 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥',\n+      error: error.message\n+    });\n+  }\n+});\n+\n+/**\n+ * ä»£ç†ComfyUIæäº¤å·¥ä½œæµæ¥å£ï¼ˆä½¿ç”¨è´Ÿè½½å‡è¡¡ï¼‰\n+ */\n+router.post('/prompt', async (req, res) => {\n+  try {\n+    console.log('ğŸš€ ä»£ç†ComfyUIå·¥ä½œæµæäº¤è¯·æ±‚...');\n+\n+    const { prompt, client_id } = req.body;\n+\n+    if (!prompt) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'è¯·æä¾›å·¥ä½œæµprompt'\n+      });\n+    }\n+\n+    console.log('ğŸ“‹ å·¥ä½œæµä¿¡æ¯:', {\n+      client_id,\n+      prompt_nodes: Object.keys(prompt).length\n+    });\n+\n+    // ä½¿ç”¨è´Ÿè½½å‡è¡¡å‘é€è¯·æ±‚\n+    const result = await comfyUIRequest('/prompt', {\n+      method: 'POST',\n+      body: JSON.stringify({\n+        prompt,\n+        client_id: client_id || `ai-magic-${Date.now()}`\n+      })\n+    });\n+\n+    console.log('âœ… ComfyUIå·¥ä½œæµæäº¤æˆåŠŸ:', result);\n+\n+    res.json({\n+      success: true,\n+      data: result,\n+      message: 'å·¥ä½œæµæäº¤æˆåŠŸ'\n+    });\n+\n+  } catch (error) {\n+    console.error('âŒ ä»£ç†ComfyUIå·¥ä½œæµæäº¤å¤±è´¥:', error);\n+    res.status(500).json({\n+      success: false,\n+      message: 'å·¥ä½œæµæäº¤å¤±è´¥',\n+      error: error.message\n+    });\n+  }\n+});\n+\n+/**\n+ * ä»£ç†ComfyUIé˜Ÿåˆ—æŸ¥è¯¢æ¥å£ï¼ˆä½¿ç”¨è´Ÿè½½å‡è¡¡ï¼‰\n+ */\n+router.get('/queue', async (req, res) => {\n+  try {\n+    console.log('ğŸ“Š ä»£ç†ComfyUIé˜Ÿåˆ—æŸ¥è¯¢è¯·æ±‚...');\n+\n+    // ä½¿ç”¨è´Ÿè½½å‡è¡¡å‘é€è¯·æ±‚\n+    const result = await comfyUIRequest('/queue');\n+\n+    res.json({\n+      success: true,\n+      data: result,\n+      message: 'é˜Ÿåˆ—æŸ¥è¯¢æˆåŠŸ'\n+    });\n+\n+  } catch (error) {\n+    console.error('âŒ ä»£ç†ComfyUIé˜Ÿåˆ—æŸ¥è¯¢å¤±è´¥:', error);\n+    res.status(500).json({\n+      success: false,\n+      message: 'é˜Ÿåˆ—æŸ¥è¯¢å¤±è´¥',\n+      error: error.message\n+    });\n+  }\n+});\n+\n+/**\n+ * ä»£ç†ComfyUIå†å²è®°å½•æŸ¥è¯¢æ¥å£ï¼ˆä½¿ç”¨è´Ÿè½½å‡è¡¡ï¼‰\n+ */\n+router.get('/history/:promptId?', async (req, res) => {\n+  try {\n+    const { promptId } = req.params;\n+    const path = promptId ? `/history/${promptId}` : '/history';\n+\n+    console.log(`ğŸ“œ ä»£ç†ComfyUIå†å²è®°å½•æŸ¥è¯¢è¯·æ±‚: ${path}`);\n+\n+    // ä½¿ç”¨è´Ÿè½½å‡è¡¡å‘é€è¯·æ±‚\n+    const result = await comfyUIRequest(path);\n+\n+    res.json({\n+      success: true,\n+      data: result,\n+      message: 'å†å²è®°å½•æŸ¥è¯¢æˆåŠŸ'\n+    });\n+\n+  } catch (error) {\n+    console.error('âŒ ä»£ç†ComfyUIå†å²è®°å½•æŸ¥è¯¢å¤±è´¥:', error);\n+    res.status(500).json({\n+      success: false,\n+      message: 'å†å²è®°å½•æŸ¥è¯¢å¤±è´¥',\n+      error: error.message\n+    });\n+  }\n+});\n+\n+/**\n+ * ä»£ç†ComfyUIç³»ç»ŸçŠ¶æ€æŸ¥è¯¢æ¥å£ï¼ˆä½¿ç”¨è´Ÿè½½å‡è¡¡ï¼‰\n+ */\n+router.get('/system_stats', async (req, res) => {\n+  try {\n+    console.log('ğŸ’» ä»£ç†ComfyUIç³»ç»ŸçŠ¶æ€æŸ¥è¯¢è¯·æ±‚...');\n+\n+    // ä½¿ç”¨è´Ÿè½½å‡è¡¡å‘é€è¯·æ±‚\n+    const result = await comfyUIRequest('/system_stats');\n+\n+    res.json({\n+      success: true,\n+      data: result,\n+      message: 'ç³»ç»ŸçŠ¶æ€æŸ¥è¯¢æˆåŠŸ'\n+    });\n+\n+  } catch (error) {\n+    console.error('âŒ ä»£ç†ComfyUIç³»ç»ŸçŠ¶æ€æŸ¥è¯¢å¤±è´¥:', error);\n+    res.status(500).json({\n+      success: false,\n+      message: 'ç³»ç»ŸçŠ¶æ€æŸ¥è¯¢å¤±è´¥',\n+      error: error.message\n+    });\n+  }\n+});\n+\n+/**\n+ * ä»£ç†ComfyUIå›¾ç‰‡æŸ¥çœ‹æ¥å£ï¼ˆä½¿ç”¨è´Ÿè½½å‡è¡¡ï¼‰\n+ */\n+router.get('/view', async (req, res) => {\n+  try {\n+    const { filename, subfolder, type } = req.query;\n+\n+    if (!filename) {\n+      return res.status(400).json({\n+        success: false,\n+        message: 'è¯·æä¾›æ–‡ä»¶å'\n+      });\n+    }\n+\n+    console.log(`ğŸ–¼ï¸ ä»£ç†ComfyUIå›¾ç‰‡æŸ¥çœ‹è¯·æ±‚: ${filename}`);\n+\n+    // æ„å»ºæŸ¥è¯¢å‚æ•°\n+    const params = new URLSearchParams();\n+    params.append('filename', filename);\n+    if (subfolder) params.append('subfolder', subfolder);\n+    if (type) params.append('type', type);\n+\n+    // ä½¿ç”¨è´Ÿè½½å‡è¡¡å‘é€è¯·æ±‚\n+    const result = await comfyUIRequest(`/view?${params.toString()}`, {\n+      responseType: 'arraybuffer'\n+    });\n+\n+    // è®¾ç½®å“åº”å¤´\n+    res.set({\n+      'Content-Type': 'image/jpeg',\n+      'Cache-Control': 'public, max-age=3600'\n+    });\n+\n+    res.send(Buffer.from(result));\n+\n+  } catch (error) {\n+    console.error('âŒ ä»£ç†ComfyUIå›¾ç‰‡æŸ¥çœ‹å¤±è´¥:', error);\n+    res.status(500).json({\n+      success: false,\n+      message: 'å›¾ç‰‡æŸ¥çœ‹å¤±è´¥',\n+      error: error.message\n+    });\n+  }\n+});\n+\n module.exports = router;\n"
                }
            ],
            "date": 1752332138551,
            "name": "Commit-0",
            "content": "/**\n * ComfyUIæœåŠ¡å™¨çŠ¶æ€ç®¡ç†è·¯ç”±\n */\nconst express = require('express');\nconst multer = require('multer');\nconst router = express.Router();\nconst {\n  getServerStatus,\n  updateServerLoads,\n  selectBestServer,\n  getServerManager,\n  comfyUIRequest\n} = require('../utils/comfyUIRequest');\n\n// é…ç½®multerç”¨äºæ–‡ä»¶ä¸Šä¼ \nconst upload = multer({\n  storage: multer.memoryStorage(),\n  limits: {\n    fileSize: 10 * 1024 * 1024 // 10MBé™åˆ¶\n  }\n});\n\n/**\n * è·å–æ‰€æœ‰ComfyUIæœåŠ¡å™¨çŠ¶æ€\n */\nrouter.get('/status', async (req, res) => {\n  try {\n    console.log('ğŸ“Š è·å–ComfyUIæœåŠ¡å™¨çŠ¶æ€...');\n\n    const status = await getServerStatus();\n\n    // è®¡ç®—å¥åº·æœåŠ¡å™¨æ•°é‡\n    const healthyServers = Object.values(status.loads).filter(load => load.healthy).length;\n    const totalServers = status.servers.length;\n\n    // è®¡ç®—æ€»é˜Ÿåˆ—æ•°\n    const totalQueue = Object.values(status.loads)\n      .filter(load => load.healthy)\n      .reduce((sum, load) => sum + load.queue.total, 0);\n\n    res.json({\n      success: true,\n      data: {\n        ...status,\n        summary: {\n          totalServers,\n          healthyServers,\n          unhealthyServers: totalServers - healthyServers,\n          totalQueue,\n          isLocked: !!status.lockedServer,\n          lockTimeRemaining: status.lockExpiry ? Math.max(0, status.lockExpiry - Date.now()) : 0\n        }\n      }\n    });\n  } catch (error) {\n    console.error('âŒ è·å–æœåŠ¡å™¨çŠ¶æ€å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'è·å–æœåŠ¡å™¨çŠ¶æ€å¤±è´¥',\n      error: error.message\n    });\n  }\n});\n\n/**\n * æ‰‹åŠ¨æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n */\nrouter.post('/refresh', async (req, res) => {\n  try {\n    console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯...');\n\n    await updateServerLoads();\n\n    const status = await getServerStatus();\n\n    res.json({\n      success: true,\n      message: 'æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯å·²æ›´æ–°',\n      data: status\n    });\n  } catch (error) {\n    console.error('âŒ åˆ·æ–°æœåŠ¡å™¨è´Ÿè½½å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'åˆ·æ–°æœåŠ¡å™¨è´Ÿè½½å¤±è´¥',\n      error: error.message\n    });\n  }\n});\n\n/**\n * é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n */\nrouter.get('/select-best', async (req, res) => {\n  try {\n    console.log('ğŸ¯ é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨...');\n\n    const bestServer = await selectBestServer();\n    const status = await getServerStatus();\n\n    // è·å–é€‰æ‹©çš„æœåŠ¡å™¨ä¿¡æ¯\n    const serverInfo = status.loads[bestServer];\n\n    res.json({\n      success: true,\n      data: {\n        selectedServer: bestServer,\n        serverInfo,\n        reason: serverInfo ?\n          `é˜Ÿåˆ—æœ€å°‘ (${serverInfo.queue.total} ä¸ªä»»åŠ¡)` :\n          'å›é€€é€‰æ‹©',\n        timestamp: new Date().toISOString()\n      }\n    });\n  } catch (error) {\n    console.error('âŒ é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨å¤±è´¥',\n      error: error.message\n    });\n  }\n});\n\n/**\n * é‡ç½®æœåŠ¡å™¨å¤±è´¥è®¡æ•°\n */\nrouter.post('/reset-failures/:serverUrl', async (req, res) => {\n  try {\n    const { serverUrl } = req.params;\n    const decodedUrl = decodeURIComponent(serverUrl);\n\n    console.log(`ğŸ”„ é‡ç½®æœåŠ¡å™¨å¤±è´¥è®¡æ•°: ${decodedUrl}`);\n\n    const serverManager = getServerManager();\n    if (!serverManager) {\n      return res.status(400).json({\n        success: false,\n        message: 'æœåŠ¡å™¨ç®¡ç†å™¨æœªåˆå§‹åŒ–'\n      });\n    }\n\n    serverManager.resetFailureCount(decodedUrl);\n\n    res.json({\n      success: true,\n      message: `æœåŠ¡å™¨ ${decodedUrl} çš„å¤±è´¥è®¡æ•°å·²é‡ç½®`\n    });\n  } catch (error) {\n    console.error('âŒ é‡ç½®å¤±è´¥è®¡æ•°å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'é‡ç½®å¤±è´¥è®¡æ•°å¤±è´¥',\n      error: error.message\n    });\n  }\n});\n\n/**\n * é‡Šæ”¾æœåŠ¡å™¨é”å®š\n */\nrouter.post('/unlock', async (req, res) => {\n  try {\n    console.log('ğŸ”“ é‡Šæ”¾æœåŠ¡å™¨é”å®š...');\n\n    const serverManager = getServerManager();\n    if (!serverManager) {\n      return res.status(400).json({\n        success: false,\n        message: 'æœåŠ¡å™¨ç®¡ç†å™¨æœªåˆå§‹åŒ–'\n      });\n    }\n\n    const previousLock = serverManager.lockedServer;\n    serverManager.lockedServer = null;\n    serverManager.lastLockTime = 0;\n\n    res.json({\n      success: true,\n      message: 'æœåŠ¡å™¨é”å®šå·²é‡Šæ”¾',\n      data: {\n        previousLock,\n        timestamp: new Date().toISOString()\n      }\n    });\n  } catch (error) {\n    console.error('âŒ é‡Šæ”¾æœåŠ¡å™¨é”å®šå¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'é‡Šæ”¾æœåŠ¡å™¨é”å®šå¤±è´¥',\n      error: error.message\n    });\n  }\n});\n\n/**\n * è·å–æœåŠ¡å™¨è¯¦ç»†ä¿¡æ¯\n */\nrouter.get('/server/:serverUrl', async (req, res) => {\n  try {\n    const { serverUrl } = req.params;\n    const decodedUrl = decodeURIComponent(serverUrl);\n\n    console.log(`ğŸ“‹ è·å–æœåŠ¡å™¨è¯¦ç»†ä¿¡æ¯: ${decodedUrl}`);\n\n    const serverManager = getServerManager();\n    if (!serverManager) {\n      return res.status(400).json({\n        success: false,\n        message: 'æœåŠ¡å™¨ç®¡ç†å™¨æœªåˆå§‹åŒ–'\n      });\n    }\n\n    // æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€\n    const health = await serverManager.checkServerHealth(decodedUrl);\n\n    // è·å–é˜Ÿåˆ—ä¿¡æ¯\n    const queueInfo = await serverManager.getServerQueueInfo(decodedUrl);\n\n    // è·å–å¤±è´¥è®¡æ•°\n    const failureCount = serverManager.failureCount.get(decodedUrl) || 0;\n\n    res.json({\n      success: true,\n      data: {\n        url: decodedUrl,\n        health,\n        queue: queueInfo,\n        failureCount,\n        isLocked: serverManager.lockedServer === decodedUrl,\n        lastCheck: Date.now()\n      }\n    });\n  } catch (error) {\n    console.error('âŒ è·å–æœåŠ¡å™¨è¯¦ç»†ä¿¡æ¯å¤±è´¥:', error);\n    res.status(500).json({\n      success: false,\n      message: 'è·å–æœåŠ¡å™¨è¯¦ç»†ä¿¡æ¯å¤±è´¥',\n      error: error.message\n    });\n  }\n});\n\nmodule.exports = router;\n"
        }
    ]
}