{
    "sourceFile": "server/src/config/database.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 6,
            "patches": [
                {
                    "date": 1752377172621,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752377189607,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -23,8 +23,39 @@\n \n // åˆ›å»ºè¿æ¥æ± \n const pool = mysql.createPool(dbConfig);\n \n+// è¿æ¥æ± äº‹ä»¶ç›‘å¬\n+pool.on('connection', (connection) => {\n+  console.log('ğŸ”— æ–°çš„æ•°æ®åº“è¿æ¥å·²å»ºç«‹:', connection.threadId);\n+});\n+\n+pool.on('error', (err) => {\n+  console.error('âŒ æ•°æ®åº“è¿æ¥æ± é”™è¯¯:', err);\n+  if (err.code === 'PROTOCOL_CONNECTION_LOST') {\n+    console.log('ğŸ”„ æ•°æ®åº“è¿æ¥ä¸¢å¤±ï¼Œè¿æ¥æ± å°†è‡ªåŠ¨é‡è¿');\n+  }\n+});\n+\n+// å®šæœŸæ£€æŸ¥è¿æ¥æ± çŠ¶æ€\n+const checkPoolStatus = () => {\n+  const poolInfo = {\n+    allConnections: pool.pool._allConnections.length,\n+    freeConnections: pool.pool._freeConnections.length,\n+    acquiringConnections: pool.pool._acquiringConnections.length\n+  };\n+\n+  console.log('ğŸ“Š æ•°æ®åº“è¿æ¥æ± çŠ¶æ€:', poolInfo);\n+\n+  // å¦‚æœç©ºé—²è¿æ¥è¿‡å°‘ï¼Œå‘å‡ºè­¦å‘Š\n+  if (poolInfo.freeConnections < 2 && poolInfo.allConnections > 15) {\n+    console.warn('âš ï¸ æ•°æ®åº“è¿æ¥æ± å¯èƒ½å­˜åœ¨è¿æ¥æ³„æ¼');\n+  }\n+};\n+\n+// æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡è¿æ¥æ± çŠ¶æ€\n+const poolMonitorInterval = setInterval(checkPoolStatus, 60000);\n+\n // æµ‹è¯•æ•°æ®åº“è¿æ¥\n async function testConnection() {\n   try {\n     const connection = await pool.getConnection();\n"
                },
                {
                    "date": 1752377204151,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -69,14 +69,27 @@\n   }\n }\n \n // æ‰§è¡ŒæŸ¥è¯¢çš„è¾…åŠ©å‡½æ•°\n-async function query(sql, params = []) {\n+async function query(sql, params = [], retryCount = 0) {\n+  const maxRetries = 3;\n+\n   try {\n     const [rows] = await pool.execute(sql, params);\n     return rows;\n   } catch (error) {\n     console.error('æ•°æ®åº“æŸ¥è¯¢é”™è¯¯:', error);\n+\n+    // å¯¹äºè¿æ¥ç›¸å…³é”™è¯¯ï¼Œå°è¯•é‡è¯•\n+    if ((error.code === 'PROTOCOL_CONNECTION_LOST' ||\n+         error.code === 'ECONNRESET' ||\n+         error.code === 'ETIMEDOUT') &&\n+         retryCount < maxRetries) {\n+      console.log(`ğŸ”„ æ•°æ®åº“è¿æ¥é”™è¯¯ï¼Œæ­£åœ¨é‡è¯•... (${retryCount + 1}/${maxRetries})`);\n+      await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1)));\n+      return query(sql, params, retryCount + 1);\n+    }\n+\n     throw error;\n   }\n }\n \n"
                },
                {
                    "date": 1752377217024,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -108,10 +108,24 @@\n     connection.release();\n   }\n }\n \n+// æ¸…ç†è¿æ¥æ± \n+const closePool = async () => {\n+  try {\n+    if (poolMonitorInterval) {\n+      clearInterval(poolMonitorInterval);\n+    }\n+    await pool.end();\n+    console.log('âœ… æ•°æ®åº“è¿æ¥æ± å·²å…³é—­');\n+  } catch (error) {\n+    console.error('âŒ å…³é—­æ•°æ®åº“è¿æ¥æ± å¤±è´¥:', error);\n+  }\n+};\n+\n module.exports = {\n   pool,\n   query,\n   transaction,\n-  testConnection\n+  testConnection,\n+  closePool\n };\n"
                },
                {
                    "date": 1752406500282,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -37,18 +37,19 @@\n });\n \n // å®šæœŸæ£€æŸ¥è¿æ¥æ± çŠ¶æ€\n const checkPoolStatus = () => {\n-  const poolInfo = {\n-    allConnections: pool.pool._allConnections.length,\n-    freeConnections: pool.pool._freeConnections.length,\n-    acquiringConnections: pool.pool._acquiringConnections.length\n-  };\n+  try {\n+    const poolInfo = {\n+      allConnections: pool.pool._allConnections?.length || 0,\n+      freeConnections: pool.pool._freeConnections?.length || 0,\n+      acquiringConnections: pool.pool._acquiringConnections?.length || 0\n+    };\n \n-  console.log('ğŸ“Š æ•°æ®åº“è¿æ¥æ± çŠ¶æ€:', poolInfo);\n+    console.log('ğŸ“Š æ•°æ®åº“è¿æ¥æ± çŠ¶æ€:', poolInfo);\n \n-  // å¦‚æœç©ºé—²è¿æ¥è¿‡å°‘ï¼Œå‘å‡ºè­¦å‘Š\n-  if (poolInfo.freeConnections < 2 && poolInfo.allConnections > 15) {\n+    // å¦‚æœç©ºé—²è¿æ¥è¿‡å°‘ï¼Œå‘å‡ºè­¦å‘Š\n+    if (poolInfo.freeConnections < 2 && poolInfo.allConnections > 15) {\n     console.warn('âš ï¸ æ•°æ®åº“è¿æ¥æ± å¯èƒ½å­˜åœ¨è¿æ¥æ³„æ¼');\n   }\n };\n \n"
                },
                {
                    "date": 1752406524558,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -48,9 +48,12 @@\n     console.log('ğŸ“Š æ•°æ®åº“è¿æ¥æ± çŠ¶æ€:', poolInfo);\n \n     // å¦‚æœç©ºé—²è¿æ¥è¿‡å°‘ï¼Œå‘å‡ºè­¦å‘Š\n     if (poolInfo.freeConnections < 2 && poolInfo.allConnections > 15) {\n-    console.warn('âš ï¸ æ•°æ®åº“è¿æ¥æ± å¯èƒ½å­˜åœ¨è¿æ¥æ³„æ¼');\n+      console.warn('âš ï¸ æ•°æ®åº“è¿æ¥æ± å¯èƒ½å­˜åœ¨è¿æ¥æ³„æ¼');\n+    }\n+  } catch (error) {\n+    console.error('âŒ æ£€æŸ¥è¿æ¥æ± çŠ¶æ€æ—¶å‡ºé”™:', error.message);\n   }\n };\n \n // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡è¿æ¥æ± çŠ¶æ€\n"
                },
                {
                    "date": 1752406875980,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -37,23 +37,19 @@\n });\n \n // å®šæœŸæ£€æŸ¥è¿æ¥æ± çŠ¶æ€\n const checkPoolStatus = () => {\n-  try {\n-    const poolInfo = {\n-      allConnections: pool.pool._allConnections?.length || 0,\n-      freeConnections: pool.pool._freeConnections?.length || 0,\n-      acquiringConnections: pool.pool._acquiringConnections?.length || 0\n-    };\n+  const poolInfo = {\n+    allConnections: pool.pool._allConnections.length,\n+    freeConnections: pool.pool._freeConnections.length,\n+    acquiringConnections: pool.pool._acquiringConnections.length\n+  };\n \n-    console.log('ğŸ“Š æ•°æ®åº“è¿æ¥æ± çŠ¶æ€:', poolInfo);\n+  console.log('ğŸ“Š æ•°æ®åº“è¿æ¥æ± çŠ¶æ€:', poolInfo);\n \n-    // å¦‚æœç©ºé—²è¿æ¥è¿‡å°‘ï¼Œå‘å‡ºè­¦å‘Š\n-    if (poolInfo.freeConnections < 2 && poolInfo.allConnections > 15) {\n-      console.warn('âš ï¸ æ•°æ®åº“è¿æ¥æ± å¯èƒ½å­˜åœ¨è¿æ¥æ³„æ¼');\n-    }\n-  } catch (error) {\n-    console.error('âŒ æ£€æŸ¥è¿æ¥æ± çŠ¶æ€æ—¶å‡ºé”™:', error.message);\n+  // å¦‚æœç©ºé—²è¿æ¥è¿‡å°‘ï¼Œå‘å‡ºè­¦å‘Š\n+  if (poolInfo.freeConnections < 2 && poolInfo.allConnections > 15) {\n+    console.warn('âš ï¸ æ•°æ®åº“è¿æ¥æ± å¯èƒ½å­˜åœ¨è¿æ¥æ³„æ¼');\n   }\n };\n \n // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡è¿æ¥æ± çŠ¶æ€\n"
                }
            ],
            "date": 1752377172621,
            "name": "Commit-0",
            "content": "const mysql = require('mysql2/promise');\nrequire('dotenv').config();\n\n// æ•°æ®åº“è¿æ¥é…ç½®\nconst dbConfig = {\n  host: process.env.DB_HOST,\n  port: process.env.DB_PORT,\n  user: process.env.DB_USER,\n  password: process.env.DB_PASSWORD,\n  database: process.env.DB_NAME,\n  waitForConnections: true,\n  connectionLimit: 20, // å¢åŠ è¿æ¥æ± å¤§å°\n  queueLimit: 0,\n  charset: 'utf8mb4',\n  acquireTimeout: 60000, // è·å–è¿æ¥è¶…æ—¶æ—¶é—´\n  timeout: 60000, // æŸ¥è¯¢è¶…æ—¶æ—¶é—´\n  reconnect: true, // è‡ªåŠ¨é‡è¿\n  idleTimeout: 300000, // ç©ºé—²è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰\n  maxIdle: 10, // æœ€å¤§ç©ºé—²è¿æ¥æ•°\n  enableKeepAlive: true, // å¯ç”¨keep-alive\n  keepAliveInitialDelay: 0\n};\n\n// åˆ›å»ºè¿æ¥æ± \nconst pool = mysql.createPool(dbConfig);\n\n// æµ‹è¯•æ•°æ®åº“è¿æ¥\nasync function testConnection() {\n  try {\n    const connection = await pool.getConnection();\n    console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ');\n    console.log(`ğŸ“ è¿æ¥åˆ°: ${process.env.DB_HOST}:${process.env.DB_PORT}/${process.env.DB_NAME}`);\n    connection.release();\n    return true;\n  } catch (error) {\n    console.error('âŒ æ•°æ®åº“è¿æ¥å¤±è´¥:', error.message);\n    return false;\n  }\n}\n\n// æ‰§è¡ŒæŸ¥è¯¢çš„è¾…åŠ©å‡½æ•°\nasync function query(sql, params = []) {\n  try {\n    const [rows] = await pool.execute(sql, params);\n    return rows;\n  } catch (error) {\n    console.error('æ•°æ®åº“æŸ¥è¯¢é”™è¯¯:', error);\n    throw error;\n  }\n}\n\n// æ‰§è¡Œäº‹åŠ¡\nasync function transaction(callback) {\n  const connection = await pool.getConnection();\n  try {\n    await connection.beginTransaction();\n    const result = await callback(connection);\n    await connection.commit();\n    return result;\n  } catch (error) {\n    await connection.rollback();\n    throw error;\n  } finally {\n    connection.release();\n  }\n}\n\nmodule.exports = {\n  pool,\n  query,\n  transaction,\n  testConnection\n};\n"
        }
    ]
}