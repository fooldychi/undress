{
    "sourceFile": "server/src/middleware/adminAuth.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1752985272341,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752985333322,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -45,8 +45,21 @@\n       });\n     }\n \n     const token = authHeader.substring(7);\n+\n+    // å¼€å‘ç¯å¢ƒä¸‹çš„ç‰¹æ®Šå¤„ç†ï¼šå…è®¸ä½¿ç”¨ admin-token ä½œä¸ºæµ‹è¯•token\n+    if (process.env.NODE_ENV === 'development' && token === 'admin-token') {\n+      console.log('ğŸ”§ ä½¿ç”¨å¼€å‘ç¯å¢ƒæµ‹è¯•token');\n+      req.admin = {\n+        id: 1,\n+        username: 'admin',\n+        role: 'super_admin',\n+        status: 'active'\n+      };\n+      return next();\n+    }\n+\n     const decoded = verifyToken(token);\n \n     // ç¡®ä¿ admins è¡¨å­˜åœ¨\n     try {\n"
                }
            ],
            "date": 1752985272340,
            "name": "Commit-0",
            "content": "const jwt = require('jsonwebtoken');\nconst { query } = require('../config/database');\n\n// JWTå¯†é’¥\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-super-secret-jwt-key-change-this-in-production';\n\n// ç”ŸæˆJWTä»¤ç‰Œ\nfunction generateToken(admin) {\n  const payload = {\n    id: admin.id,\n    username: admin.username,\n    role: admin.role,\n    type: 'admin'\n  };\n\n  return jwt.sign(payload, JWT_SECRET, {\n    expiresIn: '7d',\n    issuer: 'imagic-admin',\n    audience: 'imagic-admin-panel'\n  });\n}\n\n// éªŒè¯JWTä»¤ç‰Œ\nfunction verifyToken(token) {\n  try {\n    return jwt.verify(token, JWT_SECRET, {\n      issuer: 'imagic-admin',\n      audience: 'imagic-admin-panel'\n    });\n  } catch (error) {\n    throw new Error('æ— æ•ˆçš„ä»¤ç‰Œ');\n  }\n}\n\n// ç®¡ç†å‘˜è®¤è¯ä¸­é—´ä»¶\nconst adminAuth = async (req, res, next) => {\n  try {\n    const authHeader = req.headers.authorization;\n\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      return res.status(401).json({\n        success: false,\n        message: 'æœªæä¾›è®¤è¯ä»¤ç‰Œ',\n        code: 'NO_TOKEN'\n      });\n    }\n\n    const token = authHeader.substring(7);\n    const decoded = verifyToken(token);\n\n    // ç¡®ä¿ admins è¡¨å­˜åœ¨\n    try {\n      await query(`\n        CREATE TABLE IF NOT EXISTS admins (\n          id INT AUTO_INCREMENT PRIMARY KEY,\n          username VARCHAR(50) UNIQUE NOT NULL COMMENT 'ç®¡ç†å‘˜ç”¨æˆ·å',\n          password VARCHAR(255) NOT NULL COMMENT 'å¯†ç å“ˆå¸Œ',\n          email VARCHAR(100) UNIQUE NOT NULL COMMENT 'é‚®ç®±',\n          real_name VARCHAR(50) COMMENT 'çœŸå®å§“å',\n          role ENUM('super_admin', 'admin', 'operator') DEFAULT 'admin' COMMENT 'è§’è‰²',\n          status ENUM('active', 'inactive', 'locked') DEFAULT 'active' COMMENT 'çŠ¶æ€',\n          last_login_at DATETIME NULL COMMENT 'æœ€åç™»å½•æ—¶é—´',\n          last_login_ip VARCHAR(45) NULL COMMENT 'æœ€åç™»å½•IP',\n          login_attempts INT DEFAULT 0 COMMENT 'ç™»å½•å°è¯•æ¬¡æ•°',\n          locked_until DATETIME NULL COMMENT 'é”å®šåˆ°æœŸæ—¶é—´',\n          created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',\n          updated_at DATETIME NULL COMMENT 'æ›´æ–°æ—¶é—´',\n          INDEX idx_username (username),\n          INDEX idx_email (email),\n          INDEX idx_status (status)\n        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç®¡ç†å‘˜è¡¨'\n      `);\n\n      // æ£€æŸ¥æ˜¯å¦æœ‰ç®¡ç†å‘˜è´¦å·ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºé»˜è®¤è´¦å·\n      const adminCount = await query('SELECT COUNT(*) as count FROM admins');\n      if (adminCount[0].count === 0) {\n        const bcrypt = require('bcryptjs');\n        const defaultPassword = 'admin123456';\n        const hashedPassword = await bcrypt.hash(defaultPassword, 10);\n\n        await query(`\n          INSERT INTO admins (username, password, email, real_name, role, status, created_at)\n          VALUES (?, ?, ?, ?, ?, ?, NOW())\n        `, ['admin', hashedPassword, 'admin@imagic.com', 'ç³»ç»Ÿç®¡ç†å‘˜', 'super_admin', 'active']);\n\n        console.log('âœ… é»˜è®¤ç®¡ç†å‘˜è´¦å·å·²åˆ›å»º: admin / admin123456');\n      }\n    } catch (tableError) {\n      console.error('âŒ åˆ›å»ºç®¡ç†å‘˜è¡¨å¤±è´¥:', tableError);\n    }\n\n    // éªŒè¯ç®¡ç†å‘˜æ˜¯å¦å­˜åœ¨ä¸”çŠ¶æ€æ­£å¸¸\n    const admins = await query(\n      'SELECT id, username, role, status FROM admins WHERE id = ? AND status = \"active\"',\n      [decoded.id]\n    );\n\n    if (admins.length === 0) {\n      return res.status(401).json({\n        success: false,\n        message: 'ç®¡ç†å‘˜è´¦æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«ç¦ç”¨',\n        code: 'ADMIN_NOT_FOUND'\n      });\n    }\n\n    // å°†ç®¡ç†å‘˜ä¿¡æ¯æ·»åŠ åˆ°è¯·æ±‚å¯¹è±¡\n    req.admin = admins[0];\n    next();\n  } catch (error) {\n    console.error('âŒ ç®¡ç†å‘˜è®¤è¯å¤±è´¥:', error);\n    return res.status(401).json({\n      success: false,\n      message: 'è®¤è¯å¤±è´¥',\n      code: 'AUTH_FAILED'\n    });\n  }\n};\n\n// è§’è‰²æƒé™ä¸­é—´ä»¶\nfunction requireRole(allowedRoles) {\n  return (req, res, next) => {\n    if (!req.admin) {\n      return res.status(401).json({\n        success: false,\n        message: 'æœªè®¤è¯',\n        code: 'NOT_AUTHENTICATED'\n      });\n    }\n\n    const adminRole = req.admin.role;\n\n    // å¦‚æœæ˜¯æ•°ç»„ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«ç®¡ç†å‘˜è§’è‰²\n    if (Array.isArray(allowedRoles)) {\n      if (!allowedRoles.includes(adminRole)) {\n        return res.status(403).json({\n          success: false,\n          message: 'æƒé™ä¸è¶³',\n          code: 'INSUFFICIENT_PERMISSIONS'\n        });\n      }\n    } else {\n      // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥æ¯”è¾ƒ\n      if (adminRole !== allowedRoles) {\n        return res.status(403).json({\n          success: false,\n          message: 'æƒé™ä¸è¶³',\n          code: 'INSUFFICIENT_PERMISSIONS'\n        });\n      }\n    }\n\n    next();\n  };\n}\n\nmodule.exports = {\n  generateToken,\n  verifyToken,\n  adminAuth,\n  requireRole,\n  JWT_SECRET\n};\n"
        }
    ]
}