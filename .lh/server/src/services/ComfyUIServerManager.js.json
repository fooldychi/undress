{
    "sourceFile": "server/src/services/ComfyUIServerManager.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1752331530858,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752332359954,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -306,8 +306,17 @@\n   lockServer(serverUrl) {\n     this.lockedServer = serverUrl;\n     this.lastLockTime = Date.now();\n     console.log(`ğŸ”’ é”å®šæœåŠ¡å™¨: ${serverUrl}, æŒç»­${this.lockDuration / 1000}ç§’`);\n+\n+    // æ˜¾ç¤ºå½“å‰æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€\n+    console.log('ğŸ“Š å½“å‰æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€:');\n+    for (const [url, info] of this.serverLoads.entries()) {\n+      const status = info.healthy ? 'âœ…' : 'âŒ';\n+      const queue = info.healthy ? `é˜Ÿåˆ—:${info.queue.total}` : 'ä¸å¥åº·';\n+      const locked = url === serverUrl ? 'ğŸ”’' : '';\n+      console.log(`   ${status} ${url} ${queue} ${locked}`);\n+    }\n   }\n \n   /**\n    * è·å–å½“å‰é”å®šçš„å¯ç”¨æœåŠ¡å™¨\n"
                }
            ],
            "date": 1752331530858,
            "name": "Commit-0",
            "content": "/**\n * ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨ - è´Ÿè½½å‡è¡¡å®ç°\n * æ ¹æ®æœåŠ¡å™¨é˜Ÿåˆ—è´Ÿè½½é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨\n */\nconst fetch = require('node-fetch');\nconst { AbortController } = require('abort-controller');\nconst { query } = require('../config/database');\n\nclass ComfyUIServerManager {\n  constructor() {\n    this.servers = [];\n    this.serverLoads = new Map();\n    this.lockedServer = null;\n    this.lastLockTime = 0;\n    this.lockDuration = 60000; // æœåŠ¡å™¨é”å®šæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰\n    this.isCheckingServers = false;\n    this.config = null;\n    this.failureCount = new Map();\n  }\n\n  /**\n   * åˆå§‹åŒ–æœåŠ¡å™¨ç®¡ç†å™¨\n   */\n  async initialize() {\n    try {\n      // ä»ç³»ç»Ÿé…ç½®è·å–ComfyUIæœåŠ¡å™¨é…ç½®\n      this.config = await this.getComfyUIConfig();\n\n      // è®¾ç½®æœåŠ¡å™¨åˆ—è¡¨\n      this.servers = [\n        this.config.COMFYUI_SERVER_URL,\n        ...(this.config.BACKUP_SERVERS || [])\n      ].filter(Boolean);\n\n      console.log('ğŸ”§ ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');\n      console.log(`ğŸ“‹ ä¸»æœåŠ¡å™¨: ${this.config.COMFYUI_SERVER_URL}`);\n      console.log(`ğŸ“‹ å¤‡ç”¨æœåŠ¡å™¨: ${this.config.BACKUP_SERVERS?.join(', ') || 'æ— '}`);\n\n      // åˆå§‹åŒ–æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n      await this.updateServerLoads();\n\n      return true;\n    } catch (error) {\n      console.error('âŒ ComfyUIæœåŠ¡å™¨ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error);\n      return false;\n    }\n  }\n\n  /**\n   * è·å–ComfyUIé…ç½®\n   */\n  async getComfyUIConfig() {\n    try {\n      const configs = await query(`\n        SELECT config_key, config_value, config_type\n        FROM system_config\n        WHERE config_group = 'comfyui'\n        ORDER BY config_key\n      `);\n\n      // è½¬æ¢ä¸ºå¯¹è±¡\n      const configMap = {};\n      configs.forEach(config => {\n        let value = config.config_value;\n\n        // æ ¹æ®ç±»å‹è½¬æ¢å€¼\n        if (config.config_type === 'number') {\n          value = parseInt(value);\n        } else if (config.config_type === 'boolean') {\n          value = value === 'true' || value === '1';\n        }\n\n        configMap[config.config_key] = value;\n      });\n\n      return {\n        COMFYUI_SERVER_URL: configMap['comfyui.server_url'] || process.env.COMFYUI_SERVER_URL || 'http://localhost:8188',\n        BACKUP_SERVERS: (configMap['comfyui.backup_servers'] || process.env.COMFYUI_BACKUP_SERVERS || '')\n          .split(',')\n          .map(s => s.trim())\n          .filter(Boolean),\n        AUTO_SWITCH: configMap['comfyui.auto_switch'] === true || configMap['comfyui.auto_switch'] === 'true',\n        HEALTH_CHECK_TIMEOUT: configMap['comfyui.health_check_timeout'] || 5000,\n        TIMEOUT: configMap['comfyui.timeout'] || 30000,\n        SWITCH_THRESHOLD: configMap['comfyui.switch_threshold'] || 3\n      };\n    } catch (error) {\n      console.error('âŒ è·å–ComfyUIé…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error);\n\n      // ä½¿ç”¨é»˜è®¤é…ç½®\n      return {\n        COMFYUI_SERVER_URL: process.env.COMFYUI_SERVER_URL || 'http://localhost:8188',\n        BACKUP_SERVERS: (process.env.COMFYUI_BACKUP_SERVERS || '').split(',').filter(Boolean),\n        AUTO_SWITCH: true,\n        HEALTH_CHECK_TIMEOUT: 5000,\n        TIMEOUT: 30000,\n        SWITCH_THRESHOLD: 3\n      };\n    }\n  }\n\n  /**\n   * æ›´æ–°æ‰€æœ‰æœåŠ¡å™¨çš„è´Ÿè½½ä¿¡æ¯\n   */\n  async updateServerLoads() {\n    if (this.isCheckingServers) {\n      return;\n    }\n\n    this.isCheckingServers = true;\n\n    try {\n      console.log('ğŸ”„ æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯...');\n\n      const promises = this.servers.map(async (serverUrl) => {\n        try {\n          // æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€\n          const health = await this.checkServerHealth(serverUrl);\n\n          if (!health.healthy) {\n            this.serverLoads.set(serverUrl, {\n              healthy: false,\n              queue: { running: 0, pending: 0, total: 999999 },\n              lastCheck: Date.now(),\n              error: health.message\n            });\n            return;\n          }\n\n          // è·å–æœåŠ¡å™¨é˜Ÿåˆ—ä¿¡æ¯\n          const queueInfo = await this.getServerQueueInfo(serverUrl);\n\n          this.serverLoads.set(serverUrl, {\n            healthy: queueInfo.healthy,\n            queue: {\n              running: queueInfo.running || 0,\n              pending: queueInfo.pending || 0,\n              total: queueInfo.total || 0\n            },\n            supportsQueueAPI: queueInfo.supportsQueueAPI,\n            lastCheck: Date.now()\n          });\n\n          console.log(`ğŸ“Š æœåŠ¡å™¨ ${serverUrl} é˜Ÿåˆ—: è¿è¡Œä¸­=${queueInfo.running}, ç­‰å¾…ä¸­=${queueInfo.pending}, æ€»è®¡=${queueInfo.total}`);\n        } catch (error) {\n          console.error(`âŒ è·å–æœåŠ¡å™¨ ${serverUrl} è´Ÿè½½å¤±è´¥:`, error.message);\n          this.serverLoads.set(serverUrl, {\n            healthy: false,\n            queue: { running: 0, pending: 0, total: 999999 },\n            lastCheck: Date.now(),\n            error: error.message\n          });\n        }\n      });\n\n      await Promise.all(promises);\n    } catch (error) {\n      console.error('âŒ æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯å¤±è´¥:', error);\n    } finally {\n      this.isCheckingServers = false;\n    }\n  }\n\n  /**\n   * æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€\n   * @param {string} serverUrl - æœåŠ¡å™¨URL\n   * @returns {Promise<{healthy: boolean, status: number, message: string}>}\n   */\n  async checkServerHealth(serverUrl) {\n    try {\n      const controller = new AbortController();\n      const timeout = setTimeout(() => controller.abort(), this.config.HEALTH_CHECK_TIMEOUT);\n\n      const response = await fetch(`${serverUrl}/system_stats`, {\n        method: 'GET',\n        signal: controller.signal\n      });\n\n      clearTimeout(timeout);\n\n      if (response.ok) {\n        return { healthy: true, status: response.status, message: 'OK' };\n      } else {\n        return { healthy: false, status: response.status, message: response.statusText };\n      }\n    } catch (error) {\n      return { healthy: false, status: 0, message: error.message };\n    }\n  }\n\n  /**\n   * è·å–æœåŠ¡å™¨é˜Ÿåˆ—ä¿¡æ¯\n   * @param {string} serverUrl - æœåŠ¡å™¨URL\n   * @returns {Promise<{running: number, pending: number, total: number, healthy: boolean, supportsQueueAPI: boolean}>}\n   */\n  async getServerQueueInfo(serverUrl) {\n    try {\n      const controller = new AbortController();\n      const timeout = setTimeout(() => controller.abort(), this.config.HEALTH_CHECK_TIMEOUT);\n\n      const response = await fetch(`${serverUrl}/queue`, {\n        method: 'GET',\n        signal: controller.signal\n      });\n\n      clearTimeout(timeout);\n\n      if (response.ok) {\n        const data = await response.json();\n\n        // ComfyUIé˜Ÿåˆ—APIè¿”å›æ ¼å¼: { queue_running: [], queue_pending: [] }\n        const running = data.queue_running?.length || 0;\n        const pending = data.queue_pending?.length || 0;\n\n        return {\n          running,\n          pending,\n          total: running + pending,\n          healthy: true,\n          supportsQueueAPI: true\n        };\n      } else {\n        return {\n          running: 0,\n          pending: 0,\n          total: 0,\n          healthy: false,\n          supportsQueueAPI: false,\n          error: `HTTP ${response.status}: ${response.statusText}`\n        };\n      }\n    } catch (error) {\n      return {\n        running: 0,\n        pending: 0,\n        total: 0,\n        healthy: false,\n        supportsQueueAPI: false,\n        error: error.message\n      };\n    }\n  }\n\n  /**\n   * æ ¹æ®æœ€å°é˜Ÿåˆ—é€‰æ‹©æœåŠ¡å™¨\n   * @returns {Promise<string>} é€‰æ‹©çš„æœåŠ¡å™¨URL\n   */\n  async selectServerByMinQueue() {\n    // å¦‚æœæœ‰é”å®šçš„æœåŠ¡å™¨ä¸”æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›\n    const lockedServer = await this.getLockedAvailableServer();\n    if (lockedServer) {\n      return lockedServer;\n    }\n\n    // æ›´æ–°æœåŠ¡å™¨è´Ÿè½½ä¿¡æ¯\n    await this.updateServerLoads();\n\n    // æŒ‰é˜Ÿåˆ—æ€»æ•°æ’åºï¼Œé€‰æ‹©é˜Ÿåˆ—æœ€å°‘çš„å¥åº·æœåŠ¡å™¨\n    const serverEntries = [...this.serverLoads.entries()]\n      .filter(([_, info]) => info.healthy)\n      .sort(([_, infoA], [_, infoB]) => infoA.queue.total - infoB.queue.total);\n\n    if (serverEntries.length > 0) {\n      const [selectedServer, info] = serverEntries[0];\n      console.log(`âœ… é€‰æ‹©é˜Ÿåˆ—æœ€å°‘çš„æœåŠ¡å™¨: ${selectedServer}, é˜Ÿåˆ—æ•°: ${info.queue.total}`);\n\n      // é”å®šé€‰æ‹©çš„æœåŠ¡å™¨ä¸€æ®µæ—¶é—´\n      this.lockServer(selectedServer);\n\n      return selectedServer;\n    }\n\n    // å¦‚æœæ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨ï¼Œå°è¯•å›é€€ç­–ç•¥\n    return this.fallbackToHealthyServer();\n  }\n\n  /**\n   * å›é€€åˆ°ä»»ä½•å¥åº·çš„æœåŠ¡å™¨\n   * @returns {Promise<string>} å¥åº·çš„æœåŠ¡å™¨URL\n   */\n  async fallbackToHealthyServer() {\n    console.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°é˜Ÿåˆ—ä¿¡æ¯ï¼Œå°è¯•å›é€€åˆ°ä»»ä½•å¥åº·çš„æœåŠ¡å™¨...');\n\n    // é‡æ–°æ£€æŸ¥æ‰€æœ‰æœåŠ¡å™¨å¥åº·çŠ¶æ€\n    for (const serverUrl of this.servers) {\n      const health = await this.checkServerHealth(serverUrl);\n      if (health.healthy) {\n        console.log(`âœ… å›é€€åˆ°å¥åº·çš„æœåŠ¡å™¨: ${serverUrl}`);\n\n        // é”å®šé€‰æ‹©çš„æœåŠ¡å™¨ä¸€æ®µæ—¶é—´\n        this.lockServer(serverUrl);\n\n        return serverUrl;\n      }\n    }\n\n    // å¦‚æœæ‰€æœ‰æœåŠ¡å™¨éƒ½ä¸å¥åº·ï¼Œè¿”å›ä¸»æœåŠ¡å™¨\n    console.warn('âŒ æ‰€æœ‰æœåŠ¡å™¨éƒ½ä¸å¥åº·ï¼Œè¿”å›ä¸»æœåŠ¡å™¨');\n    return this.servers[0];\n  }\n\n  /**\n   * é”å®šæœåŠ¡å™¨ä¸€æ®µæ—¶é—´\n   * @param {string} serverUrl - è¦é”å®šçš„æœåŠ¡å™¨URL\n   */\n  lockServer(serverUrl) {\n    this.lockedServer = serverUrl;\n    this.lastLockTime = Date.now();\n    console.log(`ğŸ”’ é”å®šæœåŠ¡å™¨: ${serverUrl}, æŒç»­${this.lockDuration / 1000}ç§’`);\n  }\n\n  /**\n   * è·å–å½“å‰é”å®šçš„å¯ç”¨æœåŠ¡å™¨\n   * @returns {Promise<string|null>} é”å®šçš„æœåŠ¡å™¨URLæˆ–null\n   */\n  async getLockedAvailableServer() {\n    // å¦‚æœæ²¡æœ‰é”å®šçš„æœåŠ¡å™¨æˆ–é”å·²è¿‡æœŸï¼Œè¿”å›null\n    if (!this.lockedServer || Date.now() - this.lastLockTime > this.lockDuration) {\n      return null;\n    }\n\n    // æ£€æŸ¥é”å®šçš„æœåŠ¡å™¨æ˜¯å¦å¥åº·\n    const health = await this.checkServerHealth(this.lockedServer);\n    if (health.healthy) {\n      console.log(`ğŸ”’ ä½¿ç”¨é”å®šçš„æœåŠ¡å™¨: ${this.lockedServer}`);\n      return this.lockedServer;\n    }\n\n    // é”å®šçš„æœåŠ¡å™¨ä¸å¥åº·ï¼Œé‡Šæ”¾é”\n    console.log(`âš ï¸ é”å®šçš„æœåŠ¡å™¨ä¸å¥åº·ï¼Œé‡Šæ”¾é”: ${this.lockedServer}`);\n    this.lockedServer = null;\n    return null;\n  }\n\n  /**\n   * è®°å½•æœåŠ¡å™¨å¤±è´¥å¹¶å°è¯•åˆ‡æ¢\n   * @param {string} serverUrl - å¤±è´¥çš„æœåŠ¡å™¨URL\n   * @returns {Promise<boolean>} æ˜¯å¦æˆåŠŸåˆ‡æ¢åˆ°æ–°æœåŠ¡å™¨\n   */\n  async recordFailure(serverUrl) {\n    // å¢åŠ å¤±è´¥è®¡æ•°\n    const count = (this.failureCount.get(serverUrl) || 0) + 1;\n    this.failureCount.set(serverUrl, count);\n\n    console.log(`ğŸ“ è®°å½•æœåŠ¡å™¨å¤±è´¥: ${serverUrl}, å¤±è´¥æ¬¡æ•°: ${count}`);\n\n    // å¦‚æœå¤±è´¥æ¬¡æ•°è¶…è¿‡é˜ˆå€¼ï¼Œæ ‡è®°ä¸ºä¸å¥åº·\n    if (count >= this.config.SWITCH_THRESHOLD) {\n      console.log(`âš ï¸ æœåŠ¡å™¨ ${serverUrl} å¤±è´¥æ¬¡æ•°è¶…è¿‡é˜ˆå€¼(${this.config.SWITCH_THRESHOLD})ï¼Œæ ‡è®°ä¸ºä¸å¥åº·`);\n\n      this.serverLoads.set(serverUrl, {\n        healthy: false,\n        queue: { running: 0, pending: 0, total: 999999 },\n        lastCheck: Date.now(),\n        error: 'å¤±è´¥æ¬¡æ•°è¿‡å¤š'\n      });\n\n      // å¦‚æœæ˜¯å½“å‰é”å®šçš„æœåŠ¡å™¨ï¼Œé‡Šæ”¾é”\n      if (this.lockedServer === serverUrl) {\n        this.lockedServer = null;\n      }\n\n      // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨åˆ‡æ¢ï¼Œé€‰æ‹©æ–°çš„æœåŠ¡å™¨\n      if (this.config.AUTO_SWITCH) {\n        console.log('ğŸ”„ å°è¯•åˆ‡æ¢åˆ°æ–°æœåŠ¡å™¨...');\n\n        // é€‰æ‹©æ–°çš„æœåŠ¡å™¨\n        const newServer = await this.selectServerByMinQueue();\n\n        if (newServer && newServer !== serverUrl) {\n          console.log(`âœ… æˆåŠŸåˆ‡æ¢åˆ°æ–°æœåŠ¡å™¨: ${newServer}`);\n          return true;\n        } else {\n          console.log('âŒ æ²¡æœ‰å¯ç”¨çš„å¤‡ç”¨æœåŠ¡å™¨');\n        }\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * é‡ç½®æœåŠ¡å™¨å¤±è´¥è®¡æ•°\n   * @param {string} serverUrl - æœåŠ¡å™¨URL\n   */\n  resetFailureCount(serverUrl) {\n    if (this.failureCount.has(serverUrl)) {\n      this.failureCount.set(serverUrl, 0);\n      console.log(`ğŸ”„ é‡ç½®æœåŠ¡å™¨ ${serverUrl} çš„å¤±è´¥è®¡æ•°`);\n    }\n  }\n\n  /**\n   * è·å–æœåŠ¡å™¨çŠ¶æ€ä¿¡æ¯\n   * @returns {Object} æœåŠ¡å™¨çŠ¶æ€ä¿¡æ¯\n   */\n  getServerStatus() {\n    const status = {\n      servers: this.servers,\n      loads: Object.fromEntries(this.serverLoads),\n      lockedServer: this.lockedServer,\n      lockExpiry: this.lockedServer ? this.lastLockTime + this.lockDuration : null,\n      failures: Object.fromEntries(this.failureCount),\n      config: this.config\n    };\n\n    return status;\n  }\n}\n\nmodule.exports = ComfyUIServerManager;\n"
        }
    ]
}