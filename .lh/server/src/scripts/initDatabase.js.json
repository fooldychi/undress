{
    "sourceFile": "server/src/scripts/initDatabase.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1752436809351,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1752436809351,
            "name": "Commit-0",
            "content": "const { query, testConnection } = require('../config/database');\n\n// æ•°æ®åº“è¡¨ç»“æ„\nconst createTables = async () => {\n  try {\n    console.log('ğŸ”§ å¼€å§‹åˆ›å»ºæ•°æ®åº“è¡¨...');\n\n    // ç”¨æˆ·è¡¨\n    await query(`\n      CREATE TABLE IF NOT EXISTS users (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        username VARCHAR(50) UNIQUE NOT NULL,\n        email VARCHAR(100) UNIQUE NOT NULL,\n        password VARCHAR(255) NOT NULL,\n        avatar VARCHAR(255) DEFAULT NULL,\n        status ENUM('active', 'inactive', 'banned') DEFAULT 'active',\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at DATETIME NULL,\n        last_login DATETIME NULL,\n        INDEX idx_email (email),\n        INDEX idx_username (username),\n        INDEX idx_status (status)\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n    `);\n    console.log('âœ… ç”¨æˆ·è¡¨åˆ›å»ºæˆåŠŸ');\n\n    // å›¾ç‰‡è¡¨\n    await query(`\n      CREATE TABLE IF NOT EXISTS images (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        user_id INT NOT NULL,\n        filename VARCHAR(255) NOT NULL,\n        original_name VARCHAR(255) NOT NULL,\n        file_path VARCHAR(500) NOT NULL,\n        file_size INT NOT NULL,\n        mime_type VARCHAR(100) NOT NULL,\n        width INT DEFAULT NULL,\n        height INT DEFAULT NULL,\n        created_at DATETIME NOT NULL,\n        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\n        INDEX idx_user_id (user_id),\n        INDEX idx_created_at (created_at)\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n    `);\n    console.log('âœ… å›¾ç‰‡è¡¨åˆ›å»ºæˆåŠŸ');\n\n    // å¤„ç†ä»»åŠ¡è¡¨\n    await query(`\n      CREATE TABLE IF NOT EXISTS processing_tasks (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        user_id INT NOT NULL,\n        type ENUM('undress', 'face-swap') NOT NULL,\n        status ENUM('pending', 'processing', 'completed', 'failed') DEFAULT 'pending',\n        prompt TEXT DEFAULT NULL,\n        settings TEXT DEFAULT NULL,\n        progress INT DEFAULT 0,\n        error_message TEXT DEFAULT NULL,\n        created_at DATETIME NOT NULL,\n        updated_at DATETIME NULL,\n        completed_at DATETIME NULL,\n        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\n        INDEX idx_user_id (user_id),\n        INDEX idx_status (status),\n        INDEX idx_type (type),\n        INDEX idx_created_at (created_at)\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n    `);\n    console.log('âœ… å¤„ç†ä»»åŠ¡è¡¨åˆ›å»ºæˆåŠŸ');\n\n    // ä»»åŠ¡å›¾ç‰‡å…³è”è¡¨\n    await query(`\n      CREATE TABLE IF NOT EXISTS task_images (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        task_id INT NOT NULL,\n        image_id INT NOT NULL,\n        type ENUM('input', 'output') NOT NULL,\n        created_at DATETIME NOT NULL,\n        FOREIGN KEY (task_id) REFERENCES processing_tasks(id) ON DELETE CASCADE,\n        FOREIGN KEY (image_id) REFERENCES images(id) ON DELETE CASCADE,\n        INDEX idx_task_id (task_id),\n        INDEX idx_image_id (image_id),\n        INDEX idx_type (type)\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n    `);\n    console.log('âœ… ä»»åŠ¡å›¾ç‰‡å…³è”è¡¨åˆ›å»ºæˆåŠŸ');\n\n    // ç”¨æˆ·ç§¯åˆ†è¡¨\n    await query(`\n      CREATE TABLE IF NOT EXISTS user_points (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        user_id INT NOT NULL,\n        points INT DEFAULT 60,\n        daily_reset_date DATE NOT NULL,\n        purchased_points INT DEFAULT 0,\n        total_used INT DEFAULT 0,\n        created_at DATETIME NOT NULL,\n        updated_at DATETIME NULL,\n        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\n        UNIQUE KEY unique_user (user_id),\n        INDEX idx_daily_reset (daily_reset_date)\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n    `);\n    console.log('âœ… ç”¨æˆ·ç§¯åˆ†è¡¨åˆ›å»ºæˆåŠŸ');\n\n    // ç§¯åˆ†ä½¿ç”¨è®°å½•è¡¨\n    await query(`\n      CREATE TABLE IF NOT EXISTS point_transactions (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        user_id INT NOT NULL,\n        type ENUM('use', 'purchase', 'daily_reset') NOT NULL,\n        amount INT NOT NULL,\n        balance_after INT NOT NULL,\n        description VARCHAR(255) DEFAULT NULL,\n        task_id INT DEFAULT NULL,\n        created_at DATETIME NOT NULL,\n        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\n        FOREIGN KEY (task_id) REFERENCES processing_tasks(id) ON DELETE SET NULL,\n        INDEX idx_user_id (user_id),\n        INDEX idx_type (type),\n        INDEX idx_created_at (created_at)\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n    `);\n    console.log('âœ… ç§¯åˆ†ä½¿ç”¨è®°å½•è¡¨åˆ›å»ºæˆåŠŸ');\n\n    // ç§’æ€æ´»åŠ¨è¡¨\n    await query(`\n      CREATE TABLE IF NOT EXISTS seckill_activities (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        activity_date DATE NOT NULL,\n        total_vouchers INT DEFAULT 100,\n        remaining_vouchers INT DEFAULT 100,\n        voucher_points INT DEFAULT 20,\n        start_time TIME DEFAULT '23:00:00',\n        status ENUM('pending', 'active', 'ended') DEFAULT 'pending',\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at DATETIME NULL,\n        UNIQUE KEY unique_date (activity_date),\n        INDEX idx_status (status),\n        INDEX idx_date (activity_date)\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n    `);\n    console.log('âœ… ç§’æ€æ´»åŠ¨è¡¨åˆ›å»ºæˆåŠŸ');\n\n    // ç§’æ€å‚ä¸è®°å½•è¡¨ï¼ˆæ— éœ€ç”¨æˆ·ç™»å½•ï¼Œè®°å½•æµè§ˆå™¨æŒ‡çº¹ï¼‰\n    await query(`\n      CREATE TABLE IF NOT EXISTS seckill_participations (\n        id INT AUTO_INCREMENT PRIMARY KEY,\n        activity_id INT NOT NULL,\n        browser_fingerprint VARCHAR(255) NOT NULL,\n        ip_address VARCHAR(45) NOT NULL,\n        points_awarded INT DEFAULT 20,\n        participated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        FOREIGN KEY (activity_id) REFERENCES seckill_activities(id) ON DELETE CASCADE,\n        UNIQUE KEY unique_participation (activity_id, browser_fingerprint),\n        INDEX idx_activity (activity_id),\n        INDEX idx_fingerprint (browser_fingerprint)\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n    `);\n    console.log('âœ… ç§’æ€å‚ä¸è®°å½•è¡¨åˆ›å»ºæˆåŠŸ');\n\n    console.log('ğŸ‰ æ‰€æœ‰æ•°æ®åº“è¡¨åˆ›å»ºå®Œæˆï¼');\n  } catch (error) {\n    console.error('âŒ åˆ›å»ºæ•°æ®åº“è¡¨å¤±è´¥:', error);\n    throw error;\n  }\n};\n\n// åˆ›å»ºé»˜è®¤æ•°æ®\nconst createDefaultData = async () => {\n  try {\n    console.log('ğŸ”§ å¼€å§‹åˆ›å»ºé»˜è®¤æ•°æ®...');\n\n    // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç®¡ç†å‘˜ç”¨æˆ·\n    const adminUsers = await query(\n      'SELECT id FROM users WHERE email = ?',\n      ['admin@imagic.com']\n    );\n\n    if (adminUsers.length === 0) {\n      const bcrypt = require('bcryptjs');\n      const hashedPassword = await bcrypt.hash('admin123456', 12);\n\n      await query(\n        'INSERT INTO users (username, email, password, status) VALUES (?, ?, ?, ?)',\n        ['admin', 'admin@imagic.com', hashedPassword, 'active']\n      );\n\n      console.log('âœ… é»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·åˆ›å»ºæˆåŠŸ');\n      console.log('ğŸ“§ é‚®ç®±: admin@imagic.com');\n      console.log('ğŸ”‘ å¯†ç : admin123456');\n    } else {\n      console.log('â„¹ï¸  ç®¡ç†å‘˜ç”¨æˆ·å·²å­˜åœ¨');\n    }\n\n    console.log('ğŸ‰ é»˜è®¤æ•°æ®åˆ›å»ºå®Œæˆï¼');\n  } catch (error) {\n    console.error('âŒ åˆ›å»ºé»˜è®¤æ•°æ®å¤±è´¥:', error);\n    throw error;\n  }\n};\n\n// ä¸»å‡½æ•°\nconst initDatabase = async () => {\n  try {\n    console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–æ•°æ®åº“...');\n\n    // æµ‹è¯•æ•°æ®åº“è¿æ¥\n    const connected = await testConnection();\n    if (!connected) {\n      throw new Error('æ•°æ®åº“è¿æ¥å¤±è´¥');\n    }\n\n    // åˆ›å»ºè¡¨ç»“æ„\n    await createTables();\n\n    // åˆ›å»ºé»˜è®¤æ•°æ®\n    await createDefaultData();\n\n    console.log('ğŸ‰ æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼');\n    process.exit(0);\n  } catch (error) {\n    console.error('âŒ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:', error);\n    process.exit(1);\n  }\n};\n\n// å¦‚æœç›´æ¥è¿è¡Œæ­¤è„šæœ¬\nif (require.main === module) {\n  initDatabase();\n}\n\nmodule.exports = {\n  initDatabase,\n  createTables,\n  createDefaultData\n};\n"
        }
    ]
}