{
    "sourceFile": "server/src/scripts/create-level-cards-tables.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1752460621655,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752460633185,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -34,9 +34,9 @@\n         bound_at TIMESTAMP NULL COMMENT 'ç»‘å®šæ—¶é—´',\n         expires_at TIMESTAMP NULL COMMENT 'è¿‡æœŸæ—¶é—´',\n         created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n         updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-        FOREIGN KEY (type_id) REFERENCES level_card_types(id),\n+        FOREIGN KEY (type_id) REFERENCES card_types(id),\n         FOREIGN KEY (bound_user_id) REFERENCES users(id),\n         INDEX idx_card_number (card_number),\n         INDEX idx_bound_user (bound_user_id),\n         INDEX idx_status (status)\n"
                },
                {
                    "date": 1752460649284,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -66,12 +66,12 @@\n     // 4. æ’å…¥ç­‰çº§å¡ç±»å‹æ•°æ®\n     console.log('ğŸ“ æ’å…¥ç­‰çº§å¡ç±»å‹æ•°æ®...');\n \n     // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®\n-    const existingTypes = await query('SELECT COUNT(*) as count FROM level_card_types');\n+    const existingTypes = await query('SELECT COUNT(*) as count FROM card_types');\n     if (existingTypes[0].count === 0) {\n       await query(`\n-        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n+        INSERT INTO card_types (name, icon, price, points, description) VALUES\n         ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300, 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n         ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000, 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n         ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000, 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·')\n       `);\n"
                },
                {
                    "date": 1752460660174,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -93,9 +93,9 @@\n   try {\n     console.log('ğŸ« å¼€å§‹ç”Ÿæˆç­‰çº§å¡...');\n \n     // è·å–ç­‰çº§å¡ç±»å‹\n-    const cardTypes = await query('SELECT * FROM level_card_types');\n+    const cardTypes = await query('SELECT * FROM card_types');\n \n     for (const cardType of cardTypes) {\n       console.log(`ğŸ“‹ ç”Ÿæˆ${cardType.name}...`);\n \n"
                },
                {
                    "date": 1752460672452,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -154,9 +154,9 @@\n       console.log('\\nğŸ“‹ ç”Ÿæˆçš„ç­‰çº§å¡åˆ—è¡¨:');\n       const cards = await query(`\n         SELECT lc.card_number, lc.card_password, lct.name as type_name, lct.icon, lc.total_points\n         FROM level_cards lc\n-        JOIN level_card_types lct ON lc.type_id = lct.id\n+        JOIN card_types lct ON lc.type_id = lct.id\n         ORDER BY lct.id, lc.card_number\n       `);\n \n       console.log('\\n' + '='.repeat(80));\n"
                }
            ],
            "date": 1752460621655,
            "name": "Commit-0",
            "content": "// åˆ›å»ºç­‰çº§å¡ç›¸å…³æ•°æ®åº“è¡¨\nconst { query } = require('../config/database');\n\nasync function createLevelCardsTables() {\n  try {\n    console.log('ğŸ—ƒï¸ å¼€å§‹åˆ›å»ºç­‰çº§å¡ç›¸å…³æ•°æ®åº“è¡¨...');\n\n    // 1. åˆ›å»ºç­‰çº§å¡ç±»å‹è¡¨\n    await query(`\n      CREATE TABLE IF NOT EXISTS card_types (\n        id INT PRIMARY KEY AUTO_INCREMENT,\n        name VARCHAR(50) NOT NULL COMMENT 'ç­‰çº§å¡åç§°',\n        icon VARCHAR(10) NOT NULL COMMENT 'ç­‰çº§å¡å›¾æ ‡',\n        price DECIMAL(10,2) NOT NULL COMMENT 'ä»·æ ¼',\n        points INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',\n        description TEXT COMMENT 'æè¿°',\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç­‰çº§å¡ç±»å‹è¡¨'\n    `);\n    console.log('âœ… ç­‰çº§å¡ç±»å‹è¡¨åˆ›å»ºæˆåŠŸ');\n\n    // 2. åˆ›å»ºç­‰çº§å¡è¡¨\n    await query(`\n      CREATE TABLE IF NOT EXISTS level_cards (\n        id INT PRIMARY KEY AUTO_INCREMENT,\n        card_number VARCHAR(20) UNIQUE NOT NULL COMMENT 'å¡å·',\n        card_password VARCHAR(20) NOT NULL COMMENT 'å¡å¯†',\n        type_id INT NOT NULL COMMENT 'ç­‰çº§å¡ç±»å‹ID',\n        total_points INT NOT NULL COMMENT 'æ€»ç§¯åˆ†',\n        remaining_points INT NOT NULL COMMENT 'å‰©ä½™ç§¯åˆ†',\n        status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT 'çŠ¶æ€',\n        bound_user_id INT NULL COMMENT 'ç»‘å®šçš„ç”¨æˆ·ID',\n        bound_at TIMESTAMP NULL COMMENT 'ç»‘å®šæ—¶é—´',\n        expires_at TIMESTAMP NULL COMMENT 'è¿‡æœŸæ—¶é—´',\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n        FOREIGN KEY (type_id) REFERENCES level_card_types(id),\n        FOREIGN KEY (bound_user_id) REFERENCES users(id),\n        INDEX idx_card_number (card_number),\n        INDEX idx_bound_user (bound_user_id),\n        INDEX idx_status (status)\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç­‰çº§å¡è¡¨'\n    `);\n    console.log('âœ… ç­‰çº§å¡è¡¨åˆ›å»ºæˆåŠŸ');\n\n    // 3. åˆ›å»ºç­‰çº§å¡ä½¿ç”¨è®°å½•è¡¨\n    await query(`\n      CREATE TABLE IF NOT EXISTS level_card_transactions (\n        id INT PRIMARY KEY AUTO_INCREMENT,\n        card_id INT NOT NULL COMMENT 'ç­‰çº§å¡ID',\n        user_id INT NOT NULL COMMENT 'ç”¨æˆ·ID',\n        type ENUM('bind', 'consume') NOT NULL COMMENT 'äº¤æ˜“ç±»å‹',\n        points_amount INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',\n        remaining_points INT NOT NULL COMMENT 'æ“ä½œåå‰©ä½™ç§¯åˆ†',\n        description VARCHAR(255) COMMENT 'æè¿°',\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        FOREIGN KEY (card_id) REFERENCES level_cards(id),\n        FOREIGN KEY (user_id) REFERENCES users(id),\n        INDEX idx_card_user (card_id, user_id),\n        INDEX idx_created_at (created_at)\n      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç­‰çº§å¡äº¤æ˜“è®°å½•è¡¨'\n    `);\n    console.log('âœ… ç­‰çº§å¡äº¤æ˜“è®°å½•è¡¨åˆ›å»ºæˆåŠŸ');\n\n    // 4. æ’å…¥ç­‰çº§å¡ç±»å‹æ•°æ®\n    console.log('ğŸ“ æ’å…¥ç­‰çº§å¡ç±»å‹æ•°æ®...');\n\n    // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®\n    const existingTypes = await query('SELECT COUNT(*) as count FROM level_card_types');\n    if (existingTypes[0].count === 0) {\n      await query(`\n        INSERT INTO level_card_types (name, icon, price, points, description) VALUES\n        ('åŸºç¡€å¡', 'ğŸ¥‰', 9.90, 300, 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n        ('é«˜çº§å¡', 'ğŸ¥ˆ', 30.00, 1000, 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·'),\n        ('è‡³å°Šå¡', 'ğŸ¥‡', 50.00, 2000, 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·')\n      `);\n      console.log('âœ… ç­‰çº§å¡ç±»å‹æ•°æ®æ’å…¥æˆåŠŸ');\n    } else {\n      console.log('â„¹ï¸ ç­‰çº§å¡ç±»å‹æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥');\n    }\n\n    console.log('ğŸ‰ ç­‰çº§å¡æ•°æ®åº“è¡¨åˆ›å»ºå®Œæˆï¼');\n\n  } catch (error) {\n    console.error('âŒ åˆ›å»ºç­‰çº§å¡æ•°æ®åº“è¡¨å¤±è´¥:', error);\n    throw error;\n  }\n}\n\n// ç”Ÿæˆç­‰çº§å¡çš„å‡½æ•°\nasync function generateLevelCards() {\n  try {\n    console.log('ğŸ« å¼€å§‹ç”Ÿæˆç­‰çº§å¡...');\n\n    // è·å–ç­‰çº§å¡ç±»å‹\n    const cardTypes = await query('SELECT * FROM level_card_types');\n\n    for (const cardType of cardTypes) {\n      console.log(`ğŸ“‹ ç”Ÿæˆ${cardType.name}...`);\n\n      // ä¸ºæ¯ç§ç±»å‹ç”Ÿæˆ5å¼ å¡\n      for (let i = 1; i <= 5; i++) {\n        const cardNumber = generateCardNumber(cardType.name, i);\n        const cardPassword = generateCardPassword();\n\n        await query(`\n          INSERT INTO level_cards (card_number, card_password, type_id, total_points, remaining_points, expires_at)\n          VALUES (?, ?, ?, ?, ?, DATE_ADD(NOW(), INTERVAL 1 YEAR))\n        `, [cardNumber, cardPassword, cardType.id, cardType.points, cardType.points]);\n\n        console.log(`  âœ… ${cardNumber} - ${cardPassword}`);\n      }\n    }\n\n    console.log('ğŸ‰ ç­‰çº§å¡ç”Ÿæˆå®Œæˆï¼');\n\n  } catch (error) {\n    console.error('âŒ ç”Ÿæˆç­‰çº§å¡å¤±è´¥:', error);\n    throw error;\n  }\n}\n\n// ç”Ÿæˆå¡å·\nfunction generateCardNumber(cardName, index) {\n  const prefix = {\n    'åŸºç¡€å¡': 'BC',\n    'é«˜çº§å¡': 'AC',\n    'è‡³å°Šå¡': 'PC'\n  };\n\n  const timestamp = Date.now().toString().slice(-6);\n  return `${prefix[cardName]}${timestamp}${index.toString().padStart(2, '0')}`;\n}\n\n// ç”Ÿæˆå¡å¯†\nfunction generateCardPassword() {\n  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n  let password = '';\n  for (let i = 0; i < 8; i++) {\n    password += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  return password;\n}\n\n// å¦‚æœç›´æ¥è¿è¡Œæ­¤è„šæœ¬\nif (require.main === module) {\n  (async () => {\n    try {\n      await createLevelCardsTables();\n      await generateLevelCards();\n\n      // æ˜¾ç¤ºç”Ÿæˆçš„å¡ç‰‡\n      console.log('\\nğŸ“‹ ç”Ÿæˆçš„ç­‰çº§å¡åˆ—è¡¨:');\n      const cards = await query(`\n        SELECT lc.card_number, lc.card_password, lct.name as type_name, lct.icon, lc.total_points\n        FROM level_cards lc\n        JOIN level_card_types lct ON lc.type_id = lct.id\n        ORDER BY lct.id, lc.card_number\n      `);\n\n      console.log('\\n' + '='.repeat(80));\n      console.log('| å¡å·          | å¡å¯†     | ç±»å‹   | ç§¯åˆ†  |');\n      console.log('='.repeat(80));\n\n      cards.forEach(card => {\n        console.log(`| ${card.card_number.padEnd(12)} | ${card.card_password.padEnd(8)} | ${card.icon}${card.type_name.padEnd(4)} | ${card.total_points.toString().padEnd(4)} |`);\n      });\n\n      console.log('='.repeat(80));\n\n      process.exit(0);\n    } catch (error) {\n      console.error('æ‰§è¡Œå¤±è´¥:', error);\n      process.exit(1);\n    }\n  })();\n}\n\nmodule.exports = {\n  createLevelCardsTables,\n  generateLevelCards\n};\n"
        }
    ]
}