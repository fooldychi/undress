{
    "sourceFile": "server/test-generate-cards.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1753016026978,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1753016026978,
            "name": "Commit-0",
            "content": "// ç›´æ¥æµ‹è¯•ç”Ÿæˆç­‰çº§å¡æ¥å£\nconst { query } = require('./src/config/database');\n\nasync function testGenerateCards() {\n  try {\n    console.log('ğŸ§ª æµ‹è¯•ç”Ÿæˆç­‰çº§å¡åŠŸèƒ½...\\n');\n\n    // 1. æ£€æŸ¥è¡¨ç»“æ„\n    console.log('ğŸ“‹ æ£€æŸ¥è¡¨ç»“æ„...');\n\n    try {\n      const cardTypesStructure = await query('DESCRIBE card_types');\n      console.log('âœ… card_types è¡¨ç»“æ„:');\n      cardTypesStructure.forEach(col => {\n        console.log(`  ${col.Field}: ${col.Type}`);\n      });\n    } catch (error) {\n      console.log('âŒ card_types è¡¨ä¸å­˜åœ¨:', error.message);\n    }\n\n    try {\n      const levelCardsStructure = await query('DESCRIBE level_cards');\n      console.log('âœ… level_cards è¡¨ç»“æ„:');\n      levelCardsStructure.forEach(col => {\n        console.log(`  ${col.Field}: ${col.Type}`);\n      });\n    } catch (error) {\n      console.log('âŒ level_cards è¡¨ä¸å­˜åœ¨:', error.message);\n\n      // åˆ›å»ºè¡¨\n      console.log('ğŸ”§ åˆ›å»º level_cards è¡¨...');\n      await query(`\n        CREATE TABLE IF NOT EXISTS level_cards (\n          id INT AUTO_INCREMENT PRIMARY KEY,\n          card_number VARCHAR(20) UNIQUE NOT NULL COMMENT 'å¡å·',\n          card_password VARCHAR(20) NOT NULL COMMENT 'å¡å¯†',\n          type_id INT NOT NULL COMMENT 'ç­‰çº§å¡ç±»å‹ID',\n          remaining_points INT NOT NULL COMMENT 'å‰©ä½™ç§¯åˆ†',\n          status ENUM('active', 'used', 'expired', 'disabled') DEFAULT 'active' COMMENT 'çŠ¶æ€',\n          bound_user_id INT NULL COMMENT 'ç»‘å®šçš„ç”¨æˆ·ID',\n          bound_at DATETIME NULL COMMENT 'ç»‘å®šæ—¶é—´',\n          expires_at DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´',\n          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n          updated_at TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,\n          INDEX idx_card_number (card_number),\n          INDEX idx_bound_user (bound_user_id),\n          INDEX idx_status (status),\n          INDEX idx_type (type_id)\n        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç­‰çº§å¡è¡¨'\n      `);\n      console.log('âœ… level_cards è¡¨åˆ›å»ºæˆåŠŸ');\n    }\n\n    // 2. è·å–ç­‰çº§å¡ç±»å‹\n    console.log('\\nğŸ“‹ è·å–ç­‰çº§å¡ç±»å‹...');\n    const cardTypes = await query('SELECT * FROM card_types LIMIT 1');\n\n    if (cardTypes.length === 0) {\n      console.log('âŒ æ²¡æœ‰æ‰¾åˆ°ç­‰çº§å¡ç±»å‹');\n      return;\n    }\n\n    const cardType = cardTypes[0];\n    console.log('âœ… æ‰¾åˆ°ç­‰çº§å¡ç±»å‹:', cardType);\n\n    // 3. ç”Ÿæˆæµ‹è¯•å¡å·å’Œå¯†ç \n    console.log('\\nğŸ« ç”Ÿæˆæµ‹è¯•ç­‰çº§å¡...');\n\n    function generateCardNumber(cardTypeName, index) {\n      const typePrefix = {\n        'åŸºç¡€å¡': 'BC',\n        'é«˜çº§å¡': 'AC',\n        'è‡³å°Šå¡': 'PC',\n        'ä½“éªŒå¡': 'EXP'\n      };\n\n      const prefix = typePrefix[cardTypeName] || 'CARD';\n      const timestamp = Date.now().toString().slice(-8);\n      const indexStr = String(index).padStart(2, '0');\n\n      return `${prefix}${timestamp}${indexStr}`;\n    }\n\n    function generateCardPassword() {\n      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n      let password = '';\n      for (let i = 0; i < 8; i++) {\n        password += chars.charAt(Math.floor(Math.random() * chars.length));\n      }\n      return password;\n    }\n\n    const cardNumber = generateCardNumber(cardType.name, 1);\n    const cardPassword = generateCardPassword();\n\n    console.log(`ğŸ“ ç”Ÿæˆå¡å·: ${cardNumber}`);\n    console.log(`ğŸ”‘ ç”Ÿæˆå¡å¯†: ${cardPassword}`);\n\n    // 4. æ’å…¥æ•°æ®åº“\n    console.log('\\nğŸ’¾ æ’å…¥æ•°æ®åº“...');\n\n    try {\n      await query(`\n        INSERT INTO level_cards (card_number, card_password, type_id, remaining_points)\n        VALUES (?, ?, ?, ?)\n      `, [cardNumber, cardPassword, cardType.id, cardType.points]);\n\n      console.log('âœ… ç­‰çº§å¡ç”ŸæˆæˆåŠŸï¼');\n\n      // éªŒè¯æ’å…¥\n      const insertedCard = await query(`\n        SELECT * FROM level_cards WHERE card_number = ?\n      `, [cardNumber]);\n\n      console.log('ğŸ“Š æ’å…¥çš„æ•°æ®:', insertedCard[0]);\n\n    } catch (insertError) {\n      console.error('âŒ æ’å…¥å¤±è´¥:', insertError);\n      console.error('é”™è¯¯è¯¦æƒ…:', {\n        message: insertError.message,\n        code: insertError.code,\n        sqlState: insertError.sqlState\n      });\n    }\n\n  } catch (error) {\n    console.error('âŒ æµ‹è¯•å¤±è´¥:', error);\n  }\n}\n\n// è¿è¡Œæµ‹è¯•\ntestGenerateCards();\n"
        }
    ]
}