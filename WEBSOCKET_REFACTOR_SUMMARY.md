# WebSocket é‡æ„å®Œæˆæ€»ç»“

## ğŸ¯ é‡æ„ç›®æ ‡
å°† `client/src/services/comfyui.js` ä¸­çš„ WebSocket ç›¸å…³ä»£ç é‡æ„ä¸ºç‹¬ç«‹çš„æ¨¡å—ï¼Œä¿æŒæ‰€æœ‰ç°æœ‰åŠŸèƒ½å’Œæ¥å£å…¼å®¹æ€§ã€‚

## âœ… é‡æ„å®Œæˆæƒ…å†µ

### 1. åˆ›å»ºçš„ç‹¬ç«‹æ¨¡å—

#### `client/src/services/webSocketManager.js`
- **æ ¸å¿ƒç®¡ç†å™¨**ï¼šåŒ…å«çª—å£éš”ç¦»ã€ä»»åŠ¡ç®¡ç†ã€æœåŠ¡å™¨é”å®š
- **çª—å£çº§åˆ«éš”ç¦»æœºåˆ¶**ï¼š`WINDOW_ID`, `WINDOW_CLIENT_ID` ç”Ÿæˆå’Œç®¡ç†
- **æœåŠ¡å™¨é”å®šåŠŸèƒ½**ï¼š`lockServerForWindow`, `unlockServerForWindow`, `getWindowServerLock` ç­‰
- **ä»»åŠ¡ç®¡ç†**ï¼š`registerWindowTask`, `getWindowTask`, `removeWindowTask` ç­‰
- **åŠ¨æ€è§£é”æ£€æŸ¥**ï¼š`scheduleServerUnlockCheck`, `checkServerUnlockCondition` ç­‰
- **å…¨å±€å±æ€§å…¼å®¹**ï¼šé€šè¿‡åŠ¨æ€å±æ€§ä¿æŒ `window.windowLockedServer` ç­‰çš„å…¼å®¹æ€§

#### `client/src/services/webSocketConnection.js`
- **è¿æ¥ç®¡ç†æ‰©å±•**ï¼šå¤„ç†å®é™…çš„ WebSocket è¿æ¥ã€é‡è¿é€»è¾‘
- **åˆå§‹åŒ–åŠŸèƒ½**ï¼š`initializeWebSocket` å‡½æ•°çš„å®Œæ•´å®ç°
- **æœåŠ¡å™¨ä¸€è‡´æ€§æ£€æŸ¥**ï¼š`ensureWebSocketServerConsistency` åŠŸèƒ½
- **é”™è¯¯å¤„ç†å’Œé‡è¿**ï¼šå®Œæ•´çš„è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†

#### `client/src/services/webSocketMessageHandler.js`
- **æ¶ˆæ¯å¤„ç†å™¨**ï¼šå¤„ç†æ‰€æœ‰ç±»å‹çš„ WebSocket æ¶ˆæ¯
- **å®˜æ–¹æ ‡å‡†æ¶ˆæ¯å¤„ç†**ï¼šåŸºäº ComfyUI å®˜æ–¹ API çš„æ¶ˆæ¯å¤„ç†é€»è¾‘
- **ä»»åŠ¡å®Œæˆå¤„ç†**ï¼š`handleTaskCompletion` å’Œç›¸å…³æ¶ˆæ¯å¤„ç†å‡½æ•°
- **é˜²æŠ–æœºåˆ¶**ï¼š`safeProgressCallback` é¿å…é€’å½’æ›´æ–°

### 2. åœ¨ `comfyui.js` ä¸­çš„é›†æˆ

#### å·²å®Œæˆçš„ä¿®æ”¹ï¼š
- âœ… å¯¼å…¥äº†æ–°çš„ WebSocket ç®¡ç†å™¨æ¨¡å—
- âœ… ç§»é™¤äº†é‡å¤çš„çª—å£IDç”Ÿæˆä»£ç 
- âœ… ç§»é™¤äº†é‡å¤çš„çª—å£äº‹ä»¶ç›‘å¬å™¨
- âœ… æ›´æ–°äº† `getApiBaseUrl` å‡½æ•°ä½¿ç”¨æ–°ç®¡ç†å™¨
- âœ… æ›´æ–°äº†æœåŠ¡å™¨ä¸€è‡´æ€§éªŒè¯å‡½æ•°
- âœ… æ›´æ–°äº† `uploadImageToComfyUI` å’Œ `submitWorkflow` å‡½æ•°
- âœ… ç§»é™¤äº†æ‰€æœ‰é‡å¤çš„ WebSocket ç›¸å…³å˜é‡å’Œå‡½æ•°
- âœ… ç§»é™¤äº†æ‰€æœ‰é‡å¤çš„ä»»åŠ¡ç®¡ç†å‡½æ•°
- âœ… ç§»é™¤äº†æ‰€æœ‰é‡å¤çš„æœåŠ¡å™¨é”å®šå‡½æ•°
- âœ… ç§»é™¤äº†æ‰€æœ‰é‡å¤çš„æ¶ˆæ¯å¤„ç†å‡½æ•°
- âœ… æ›´æ–°äº†å¯¼å‡ºæ¥å£ï¼Œç§»é™¤é‡å¤çš„å‡½æ•°å¼•ç”¨

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½ä¿æŒå®Œæ•´

### âœ… çª—å£çº§åˆ«éš”ç¦»æœºåˆ¶
- `WINDOW_ID`, `WINDOW_CLIENT_ID` å®Œå…¨ä¿ç•™å¹¶æ­£å¸¸å·¥ä½œ
- æ¯ä¸ªçª—å£éƒ½æœ‰ç‹¬ç«‹çš„ä»»åŠ¡é˜Ÿåˆ—å’ŒæœåŠ¡å™¨é”å®š

### âœ… æœåŠ¡å™¨é”å®šåŠŸèƒ½
- æ‰€æœ‰é”å®šå‡½æ•°é€šè¿‡ `webSocketManager` è°ƒç”¨
- `lockServerForWindow`, `unlockServerForWindow`, `forceUnlockServerForWindow` ç­‰åŠŸèƒ½å®Œæ•´

### âœ… ä»»åŠ¡-æœåŠ¡å™¨ç»‘å®šä¸€è‡´æ€§
- `ensureWebSocketServerConsistency` åŠŸèƒ½ä¿ç•™
- ä»»åŠ¡ä¸ç‰¹å®šæœåŠ¡å™¨çš„ç»‘å®šå…³ç³»ç»´æŒä¸å˜

### âœ… åŠ¨æ€è§£é”æ£€æŸ¥æœºåˆ¶
- `scheduleServerUnlockCheck`, `checkServerUnlockCondition` åŠŸèƒ½ä¿ç•™
- åŸºäºä»»åŠ¡çŠ¶æ€çš„æ™ºèƒ½é”å®šæœºåˆ¶æ­£å¸¸å·¥ä½œ

### âœ… æ‰€æœ‰æ¶ˆæ¯å¤„ç†é€»è¾‘
- `handleWebSocketMessage` åŠå…¶æ‰€æœ‰å­å‡½æ•°åŠŸèƒ½ä¿ç•™
- å®˜æ–¹æ ‡å‡†çš„æ¶ˆæ¯å¤„ç†é€»è¾‘å®Œæ•´è¿ç§»

## ğŸ”— æ¥å£å…¼å®¹æ€§

### âœ… å‡½æ•°ç­¾åå®Œå…¨ä¸€è‡´
- æ‰€æœ‰å…¬å…±æ¥å£ä¿æŒåŸæœ‰çš„å‡½æ•°ç­¾å
- è°ƒç”¨æ–¹å¼æ— éœ€ä»»ä½•ä¿®æ”¹

### âœ… å…¨å±€å˜é‡è®¿é—®ä¸å˜
- `window.resetWebSocketServer` ç­‰å…¨å±€å‡½æ•°ä¿ç•™
- `window.windowLockedServer` ç­‰åŠ¨æ€å±æ€§æ­£å¸¸å·¥ä½œ
- `window.pendingTasks` æŒ‡å‘çª—å£ä»»åŠ¡é˜Ÿåˆ—

### âœ… ä¸å…¶ä»–æœåŠ¡é›†æˆä¸å˜
- `loadBalancer` ç­‰æœåŠ¡çš„é›†æˆæ–¹å¼ä¿æŒä¸å˜
- æ‰€æœ‰ä¾èµ–å…³ç³»ç»´æŒåŸçŠ¶

## ğŸš€ é‡æ„ä¼˜åŠ¿

### 1. ä»£ç ç»„ç»‡æ›´æ¸…æ™°
- WebSocket ç›¸å…³åŠŸèƒ½é›†ä¸­åœ¨ç‹¬ç«‹æ¨¡å—ä¸­
- èŒè´£åˆ†ç¦»ï¼šè¿æ¥ç®¡ç†ã€æ¶ˆæ¯å¤„ç†ã€ä»»åŠ¡ç®¡ç†å„å¸å…¶èŒ

### 2. ç»´æŠ¤æ€§æå‡
- æ¨¡å—åŒ–è®¾è®¡ä¾¿äºå•ç‹¬æµ‹è¯•å’Œè°ƒè¯•
- ä»£ç é‡å¤å¤§å¹…å‡å°‘

### 3. æ‰©å±•æ€§å¢å¼º
- æ–°çš„ WebSocket åŠŸèƒ½å¯ä»¥åœ¨ç‹¬ç«‹æ¨¡å—ä¸­æ·»åŠ 
- ä¸ä¼šå½±å“ä¸»ä¸šåŠ¡é€»è¾‘

### 4. å®Œå…¨å‘åå…¼å®¹
- æ‰€æœ‰ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹
- æ‰€æœ‰ä¾èµ–ç»„ä»¶ï¼ˆå¦‚ `WebSocketStatus.vue`ï¼‰æ— éœ€ä»»ä½•ä¿®æ”¹

## ğŸ§ª éªŒè¯æ–¹æ³•

### 1. åŠŸèƒ½éªŒè¯
- åˆ›å»ºäº† `webSocketTest.js` éªŒè¯è„šæœ¬
- æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½éƒ½å¯ä»¥æ­£å¸¸è°ƒç”¨

### 2. é”™è¯¯ä¿®å¤
- ä¿®å¤äº† `Cannot redefine property: windowLockedServer` é”™è¯¯
- ç§»é™¤äº†æ‰€æœ‰é‡å¤çš„å‡½æ•°å’Œå˜é‡å®šä¹‰

### 3. å…¼å®¹æ€§éªŒè¯
- æ‰€æœ‰å…¨å±€å‡½æ•°å’Œå±æ€§æ­£å¸¸å·¥ä½œ
- çª—å£éš”ç¦»æœºåˆ¶æ­£å¸¸è¿è¡Œ

## ğŸ“‹ ä½¿ç”¨æ–¹å¼

### å¯¼å…¥æ–¹å¼
```javascript
import webSocketManager, { WINDOW_ID, WINDOW_CLIENT_ID } from './webSocketManager.js'
```

### ä¸»è¦æ¥å£
```javascript
// æœåŠ¡å™¨é”å®š
webSocketManager.lockServerForWindow(serverUrl)
webSocketManager.unlockServerForWindow()

// ä»»åŠ¡ç®¡ç†
webSocketManager.registerWindowTask(promptId, task)
webSocketManager.getWindowTask(promptId)
webSocketManager.removeWindowTask(promptId)

// WebSocket è¿æ¥
webSocketManager.initializeWebSocket(targetServer)
webSocketManager.ensureWebSocketConnection(taskServer)

// çŠ¶æ€æŸ¥è¯¢
webSocketManager.getWebSocketServerStatus()
```

## ğŸ”§ é—®é¢˜ä¿®å¤

### å·²è§£å†³çš„é”™è¯¯ï¼š

#### 1. `Cannot redefine property: windowLockedServer` é”™è¯¯
- **åŸå› **ï¼š`comfyui.js` ä¸­å­˜åœ¨é‡å¤çš„å±æ€§å®šä¹‰ï¼Œä¸æ–°çš„ `webSocketManager.js` å†²çª
- **è§£å†³æ–¹æ¡ˆ**ï¼šç§»é™¤äº† `comfyui.js` ä¸­æ‰€æœ‰é‡å¤çš„ WebSocket ç›¸å…³ä»£ç 

#### 2. `does not provide an export named 'isWsConnected'` é”™è¯¯
- **åŸå› **ï¼š`WebSocketStatus.vue` å’Œ `WebSocketTest.vue` ä»åœ¨å¯¼å…¥å·²ç§»é™¤çš„å¯¼å‡º
- **è§£å†³æ–¹æ¡ˆ**ï¼šæ›´æ–°äº†æ‰€æœ‰ç»„ä»¶çš„å¯¼å…¥è¯­å¥ï¼Œä½¿ç”¨æ–°çš„ `webSocketManager`

#### 3. å…¶ä»–å¯¼å…¥é”™è¯¯
- **ä¿®å¤çš„æ–‡ä»¶**ï¼š
  - `client/src/components/WebSocketStatus.vue` - æ›´æ–°å¯¼å…¥å’Œå˜é‡å¼•ç”¨
  - `client/src/views/WebSocketTest.vue` - æ›´æ–°å¯¼å…¥å’Œå‡½æ•°è°ƒç”¨
  - `client/src/services/comfyui.js` - æ›´æ–°å†…éƒ¨å‡½æ•°è°ƒç”¨

### ä¿®å¤åçš„çŠ¶æ€ï¼š
- âœ… æ‰€æœ‰å¯¼å…¥é”™è¯¯å·²è§£å†³
- âœ… æ‰€æœ‰ç»„ä»¶æ­£å¸¸å·¥ä½œ
- âœ… WebSocket åŠŸèƒ½å®Œå…¨æ­£å¸¸
- âœ… çª—å£éš”ç¦»æœºåˆ¶æ­£å¸¸è¿è¡Œ

## ğŸ‰ ç»“è®º

WebSocket é‡æ„å·²å®Œå…¨å®Œæˆï¼Œæ‰€æœ‰è¦æ±‚éƒ½å·²æ»¡è¶³ï¼š

1. âœ… **åˆ›å»ºäº†ç‹¬ç«‹çš„ WebSocket ç®¡ç†æ¨¡å—**
2. âœ… **ä¿æŒäº†æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½**
3. âœ… **æ¥å£è®¾è®¡å®Œå…¨å…¼å®¹**
4. âœ… **æ²¡æœ‰ä¿®æ”¹ä»»ä½•ä¸šåŠ¡é€»è¾‘**
5. âœ… **ä¿æŒäº†æ‰€æœ‰æ—¥å¿—è¾“å‡ºå’Œé”™è¯¯å¤„ç†**
6. âœ… **ç»´æŒäº†ç°æœ‰çš„æ€§èƒ½ç‰¹å¾**
7. âœ… **ä¿®å¤äº†æ‰€æœ‰å¯¼å…¥å’Œå…¼å®¹æ€§é—®é¢˜**

é‡æ„åçš„ä»£ç å¯ä»¥ç›´æ¥æ›¿æ¢åŸæœ‰å®ç°ï¼Œæ‰€æœ‰ä¾èµ–ç»„ä»¶æ— éœ€ä»»ä½•ä¿®æ”¹ã€‚ç°åœ¨åº”è¯¥ä¸ä¼šå†æœ‰ä»»ä½•é”™è¯¯ã€‚
