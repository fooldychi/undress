const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/downloadUtils-D1xL2KIo.js","assets/index-C86wnvRP.js","assets/index-DcStsasH.css"])))=>i.map(i=>d[i]);
import{_ as te,d as N,a as u,y as q,r as d,c as x,o as r,w as n,I as Z,T as L,D as ne,f as s,t as m,g as _,j as J,m as l,i as R,u as le,e as S,b as ie,E as K,G as re,F as $,h as ee,n as ce}from"./index-C86wnvRP.js";import{A as de,M as ue,a as _e}from"./UnifiedImageProcessingTemplate.vue_vue_type_style_index_0_scoped_1007aace_lang-DFlU2A78.js";import{M as ve}from"./MobileActionButton-LKZSR4NQ.js";const me={__name:"ResultModal",props:{show:{type:Boolean,default:!1},resultData:{type:Object,default:()=>({})}},emits:["update:show"],setup(z,{expose:o,emit:f}){o();const e=z,P=f,F=N({get:()=>e.show,set:i=>P("update:show",i)}),h=u(!1),c=u(!1),I=N(()=>{var b;if(!((b=e.resultData)!=null&&b.mediaUrl))return!1;const i=e.resultData.mediaUrl.toLowerCase();return!/\.(mp4|webm|ogg|avi|mov)(\?.*)?$/i.test(i)}),y=N(()=>{var M;if(!((M=e.resultData)!=null&&M.mediaUrl))return!1;const i=e.resultData.mediaUrl.toLowerCase();return/\.(mp4|webm|ogg|avi|mov)(\?.*)?$/i.test(i)}),v=i=>i?new Date(i).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",k=()=>{I.value&&Z({images:[e.resultData.mediaUrl],showIndex:!1,closeable:!0})},p=async()=>{var M;if(!((M=e.resultData)!=null&&M.mediaUrl)){L.fail("文件地址无效");return}const{downloadFile:i}=await ne(async()=>{const{downloadFile:b}=await import("./downloadUtils-D1xL2KIo.js");return{downloadFile:b}},__vite__mapDeps([0,1,2]));await i(e.resultData.mediaUrl,"AI_Magic_result")},w=()=>{var i;navigator.share&&((i=e.resultData)!=null&&i.mediaUrl)?navigator.share({title:"我的AI生成结果",text:e.resultData.description,url:e.resultData.mediaUrl}).catch(()=>{C()}):C()},C=()=>{var i;(i=e.resultData)!=null&&i.mediaUrl&&navigator.clipboard.writeText(e.resultData.mediaUrl).then(()=>{L.success("链接已复制到剪贴板")}).catch(()=>{L.fail("复制失败")})},g=()=>{c.value=!0,L.fail("媒体文件加载失败")},T=()=>{var i;console.log("图片加载成功:",(i=e.resultData)==null?void 0:i.mediaUrl)},E=()=>{var i;console.error("图片加载失败:",(i=e.resultData)==null?void 0:i.mediaUrl),L.fail("图片加载失败")},a=()=>{c.value=!1,h.value=!0,setTimeout(()=>{h.value=!1},1e3)};q(()=>e.show,i=>{i&&(c.value=!1,h.value=!1,console.log("ResultModal 打开，数据:",e.resultData))}),q(()=>e.resultData,i=>{console.log("ResultModal resultData 变化:",i)},{deep:!0});const U={props:e,emit:P,visible:F,loading:h,error:c,isImage:I,isVideo:y,formatDate:v,previewImage:k,downloadFile:p,shareResult:w,copyToClipboard:C,handleMediaError:g,handleImageLoad:T,handleImageError:E,retryLoad:a,ref:u,computed:N,watch:q,get Toast(){return L},get ImagePreview(){return Z}};return Object.defineProperty(U,"__isScriptSetup",{enumerable:!1,value:!0}),U}},fe={class:"result-modal"},he={class:"modal-header"},pe={class:"result-info"},ge={class:"result-desc"},we={class:"result-time"},ye={class:"modal-content"},ke={key:0,class:"loading-state"},Ce={key:1,class:"error-state"},Ie={key:2,class:"result-content"},De={key:0,class:"media-container"},Me={key:0,class:"image-result"},be={class:"image-error"},Le={style:{"font-size":"10px","margin-top":"4px"}},Ue={key:1,class:"video-result"},Re=["src"],Ae={key:2,class:"file-result"},xe={class:"file-info"},ze={key:1,class:"no-result"},Pe={key:3,class:"modal-footer"};function Ee(z,o,f,e,P,F){const h=d("van-loading"),c=d("van-button"),I=d("van-empty"),y=d("van-icon"),v=d("van-image"),k=d("van-popup");return r(),x(k,{show:e.visible,"onUpdate:show":o[0]||(o[0]=p=>e.visible=p),position:"center",style:{width:"95%",maxWidth:"500px"},round:"",closeable:"","close-icon-position":"top-right"},{default:n(()=>{var p,w,C,g;return[s("div",fe,[s("div",he,[o[1]||(o[1]=s("h3",null,"图片预览",-1)),s("div",pe,[s("div",ge,m((p=f.resultData)==null?void 0:p.description),1),s("div",we,m(e.formatDate((w=f.resultData)==null?void 0:w.createdAt)),1)])]),s("div",ye,[e.loading?(r(),_("div",ke,[l(h,{size:"24px",vertical:""},{default:n(()=>o[2]||(o[2]=[R("加载中...")])),_:1,__:[2]})])):e.error?(r(),_("div",Ce,[l(I,{image:"error",description:"加载失败"},{default:n(()=>[l(c,{type:"primary",size:"small",onClick:e.retryLoad},{default:n(()=>o[3]||(o[3]=[R(" 重试 ")])),_:1,__:[3]})]),_:1})])):(r(),_("div",Ie,[(C=f.resultData)!=null&&C.mediaUrl?(r(),_("div",De,[e.isImage?(r(),_("div",Me,[l(v,{src:f.resultData.mediaUrl,fit:"contain","show-loading":!0,"show-error":!0,onClick:e.previewImage,class:"result-image",onLoad:e.handleImageLoad,onError:e.handleImageError},{loading:n(()=>[l(h,{type:"spinner",size:"20"})]),error:n(()=>[s("div",be,[l(y,{name:"photo-fail",size:"32"}),o[4]||(o[4]=s("div",null,"图片加载失败",-1)),s("div",Le,m(f.resultData.mediaUrl),1)])]),_:1},8,["src"])])):e.isVideo?(r(),_("div",Ue,[s("video",{src:f.resultData.mediaUrl,controls:"",preload:"metadata",onError:e.handleMediaError,class:"result-video"}," 您的浏览器不支持视频播放 ",40,Re)])):(r(),_("div",Ae,[s("div",xe,[l(y,{name:"description",size:"48"}),o[5]||(o[5]=s("div",{class:"file-name"},"生成结果文件",-1))])]))])):(r(),_("div",ze,[l(I,{description:"暂无结果数据"})]))])),(g=f.resultData)!=null&&g.mediaUrl?(r(),_("div",Pe,[l(c,{type:"primary",size:"small",onClick:e.downloadFile,icon:"down",block:""},{default:n(()=>o[6]||(o[6]=[R(" 下载 ")])),_:1,__:[6]})])):J("",!0)])])]}),_:1},8,["show"])}const Ve=te(me,[["render",Ee],["__scopeId","data-v-816e0d60"],["__file","D:/workspace/AIMagic/client/src/components/ResultModal.vue"]]),Fe={name:"Profile",components:{MobilePageContainer:_e,MobileCard:ue,MobileActionButton:ve,ResultModal:Ve,AuthModal:de},setup(){const z=le(),o=u(!0),f=u(!1),e=u(!1),P=u(!1),F=u(!1),h=u(null),c=u(!1),I=u(!1),y=u("login"),v=u(null),k=u(null),p=u([]),w=u([]),C=u({}),g=N(()=>S.isLoggedIn()&&v.value),T=t=>t?new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"未知",E=()=>{y.value="login",c.value=!0},a=t=>{v.value=t.user,G()},U=t=>{v.value=t.user,G()},i=()=>{v.value=null,k.value=null,w.value=[],z.push("/")},M=()=>{S.logout(),i(),L.success("退出登录成功"),z.push("/"),setTimeout(()=>{E()},500)},b={userInfo:{data:null,timestamp:0,ttl:5*60*1e3},pointsInfo:{data:null,timestamp:0,ttl:2*60*1e3},levelCards:{data:null,timestamp:0,ttl:10*60*1e3},recentRecords:{data:null,timestamp:0,ttl:3*60*1e3}},B=t=>{const D=b[t];return D.data&&Date.now()-D.timestamp<D.ttl},j=(t,D)=>{b[t]={data:D,timestamp:Date.now(),ttl:b[t].ttl}},O=t=>B(t)?b[t].data:null,Q=async()=>{if(g.value)try{f.value=!0;const t=await S.getCurrentUser();if(t.success)return v.value=t.data.user,j("userInfo",t.data.user),t.data.user;throw new Error(t.message||"获取用户信息失败")}catch(t){throw console.error("刷新用户信息失败:",t),t}finally{f.value=!1}},X=async()=>{if(g.value)try{e.value=!0;const t=await K.getUserPoints();if(t.success)return k.value=t.data,j("pointsInfo",t.data),t.data;throw new Error(t.message||"获取积分信息失败")}catch(t){throw console.error("获取积分信息失败:",t),t}finally{e.value=!1}},Y=async()=>{if(g.value)try{const t=await K.getPointsHistory(1,3,!0);if(t.success)return w.value=t.data.logs||[],j("recentRecords",t.data.logs||[]),t.data.logs||[];throw new Error(t.message||"获取最近记录失败")}catch(t){throw console.error("获取最近记录失败:",t),t}},oe=async()=>{if(g.value)try{const t=await re.getMyCards();if(t.success)return p.value=t.data.cards||[],j("levelCards",t.data.cards||[]),t.data.cards||[];throw new Error(t.message||"获取等级卡失败")}catch(t){throw console.error("获取等级卡失败:",t),t}},se=t=>{console.log("handleViewResult 被调用，数据:",t),C.value=t,I.value=!0},ae=()=>{L.fail("功能未开通，敬请期待")},G=async()=>{if(!g.value){o.value=!1;return}try{o.value=!0;const t=O("userInfo"),D=O("pointsInfo"),H=O("levelCards"),W=O("recentRecords");t&&(v.value=t),D&&(k.value=D),H&&(p.value=H),W&&(w.value=W),t&&D&&H&&W&&(o.value=!1);const V=[];B("userInfo")||V.push(Q().catch(A=>console.warn("刷新用户信息失败:",A))),B("pointsInfo")||V.push(X().catch(A=>console.warn("刷新积分信息失败:",A))),B("levelCards")||V.push(oe().catch(A=>console.warn("加载等级卡失败:",A))),B("recentRecords")||V.push(Y().catch(A=>console.warn("加载最近记录失败:",A))),V.length>0&&await Promise.allSettled(V)}catch(t){console.error("初始化数据失败:",t),L.fail("数据加载失败，请稍后重试")}finally{o.value=!1}};return ie(()=>{S.isLoggedIn()&&(v.value=S.getLocalUserInfo()),G()}),{loading:o,refreshing:f,pointsLoading:e,recordsLoading:P,recordsFinished:F,resultLoading:h,showAuthModal:c,showResultModal:I,authMode:y,userInfo:v,pointsInfo:k,levelCards:p,recentRecords:w,currentResult:C,isLoggedIn:g,formatDate:T,showLoginModal:E,handleAuthSuccess:a,handleUserLogin:U,handleUserLogout:i,handleLogout:M,refreshUserInfo:Q,refreshPoints:X,loadRecentRecords:Y,handleViewResult:se,viewAllRecords:ae,initializeData:G}}},Te={key:0,class:"loading-skeleton"},Be={key:2,class:"not-logged-in"},Se={key:3,class:"profile-content"},Ne={class:"user-section"},je={class:"user-avatar"},Oe={class:"user-info"},Ge={class:"username"},He={class:"user-id"},We={class:"points-display"},qe={class:"points-item-centered"},Je={class:"points-value"},Qe={class:"level-cards-list"},Xe={class:"card-icon"},Ye={class:"card-type-icon"},Ze={class:"card-type"},Ke={class:"card-date"},$e={class:"card-points"},et={class:"points-current"},tt={class:"points-total"},ot={key:0,class:"no-records"},st={key:1},at={class:"record-icon"},nt={class:"record-desc"},lt={class:"record-time"},it={class:"record-value-container"},rt={class:"records-footer"},ct={class:"action-buttons"};function dt(z,o,f,e,P,F){const h=d("van-skeleton"),c=d("MobileCard"),I=d("van-loading"),y=d("MobileActionButton"),v=d("van-empty"),k=d("van-icon"),p=d("van-cell"),w=d("van-cell-group"),C=d("van-button"),g=d("AuthModal"),T=d("ResultModal"),E=d("MobilePageContainer");return r(),x(E,{title:"个人中心",onLogin:e.handleUserLogin,onLogout:e.handleUserLogout},{default:n(()=>[e.loading&&!e.userInfo?(r(),_("div",Te,[l(c,{inset:!0},{default:n(()=>[l(h,{title:"",avatar:"",row:3})]),_:1}),l(c,{inset:!0},{default:n(()=>[l(h,{title:"",row:2})]),_:1}),l(c,{inset:!0},{default:n(()=>[l(h,{title:"",row:3})]),_:1}),l(c,{inset:!0},{default:n(()=>[l(h,{title:"",row:4})]),_:1})])):e.loading?(r(),x(I,{key:1,class:"loading-center",size:"24px",vertical:""},{default:n(()=>o[2]||(o[2]=[R(" 加载中... ")])),_:1,__:[2]})):e.isLoggedIn?(r(),_("div",Se,[l(c,{title:"用户信息",icon:"user-o",inset:!0},{default:n(()=>{var a,U;return[s("div",Ne,[s("div",je,[l(k,{name:"user-o",size:"36",color:"var(--van-primary-color)"})]),s("div",Oe,[s("h2",Ge,m((a=e.userInfo)==null?void 0:a.username),1),s("p",He,"ID: "+m((U=e.userInfo)==null?void 0:U.id),1)])])]}),_:1}),l(c,{title:"我的积分",icon:"diamond-o",inset:!0},{default:n(()=>{var a;return[s("div",We,[s("div",qe,[s("div",Je,m(((a=e.pointsInfo)==null?void 0:a.total_points)||0),1),o[4]||(o[4]=s("div",{class:"points-label"},"总积分",-1))])])]}),_:1}),e.levelCards.length>0?(r(),x(c,{key:0,title:"我的等级卡",icon:"credit-pay",inset:!0},{default:n(()=>[s("div",Qe,[l(w,{class:"transparent-cell-group"},{default:n(()=>[(r(!0),_($,null,ee(e.levelCards,a=>(r(),x(p,{key:a.id,class:"level-card-item transparent-cell"},{icon:n(()=>[s("div",Xe,[s("span",Ye,m(a.icon||"💎"),1)])]),title:n(()=>[s("div",Ze,m(a.type_name),1)]),label:n(()=>[s("div",Ke,m(e.formatDate(a.bound_at)),1)]),value:n(()=>[s("div",$e,[s("span",et,m(a.remaining_points),1),o[5]||(o[5]=s("span",{class:"points-separator"},"/",-1)),s("span",tt,m(a.total_points),1)])]),_:2},1024))),128))]),_:1})])]),_:1})):J("",!0),l(c,{title:"最近记录",icon:"orders-o",inset:!0},{footer:n(()=>[s("div",rt,[l(y,{type:"primary",size:"small",variant:"ghost",onClick:e.viewAllRecords,block:""},{default:n(()=>o[7]||(o[7]=[R(" 查看全部记录 ")])),_:1,__:[7]},8,["onClick"])])]),default:n(()=>[e.recentRecords.length===0?(r(),_("div",ot,[l(v,{description:"暂无记录"})])):(r(),_("div",st,[l(w,{class:"transparent-cell-group"},{default:n(()=>[(r(!0),_($,null,ee(e.recentRecords.slice(0,3),a=>(r(),x(p,{key:a.id,class:"record-item transparent-cell"},{icon:n(()=>[s("div",at,[l(k,{name:"diamond-o",size:"16",color:a.action_type==="consume"?"var(--van-danger-color)":"var(--van-success-color)"},null,8,["color"])])]),title:n(()=>[s("div",nt,m(a.description),1)]),label:n(()=>[s("div",lt,m(e.formatDate(a.created_at)),1)]),value:n(()=>[s("div",it,[s("div",{class:ce(["record-amount",a.action_type])},m(a.action_type==="consume"?"-":"+")+m(a.points_amount),3),a.action_type==="consume"&&a.url?(r(),x(C,{key:0,type:"default",size:"mini",plain:"",class:"view-button",onClick:U=>e.handleViewResult({id:a.id,description:a.description,mediaUrl:a.url,createdAt:a.created_at}),loading:e.resultLoading===a.id},{default:n(()=>[...o[6]||(o[6]=[R(" 查看 ")])]),_:2,__:[6]},1032,["onClick","loading"])):J("",!0)])]),_:2},1024))),128))]),_:1})]))]),_:1}),s("div",ct,[l(y,{type:"danger",block:"",onClick:e.handleLogout,icon:"sign"},{default:n(()=>o[8]||(o[8]=[R(" 退出登录 ")])),_:1,__:[8]},8,["onClick"])])])):(r(),_("div",Be,[l(v,{image:"https://fastly.jsdelivr.net/npm/@vant/assets/custom-empty-image.png",description:"请先登录"},{default:n(()=>[l(y,{type:"primary",onClick:e.showLoginModal},{default:n(()=>o[3]||(o[3]=[R(" 立即登录 ")])),_:1,__:[3]},8,["onClick"])]),_:1})])),l(g,{show:e.showAuthModal,"onUpdate:show":o[0]||(o[0]=a=>e.showAuthModal=a),"default-mode":e.authMode,onSuccess:e.handleAuthSuccess},null,8,["show","default-mode","onSuccess"]),l(T,{show:e.showResultModal,"onUpdate:show":o[1]||(o[1]=a=>e.showResultModal=a),"result-data":e.currentResult},null,8,["show","result-data"])]),_:1},8,["onLogin","onLogout"])}const mt=te(Fe,[["render",dt],["__scopeId","data-v-f32632b7"],["__file","D:/workspace/AIMagic/client/src/views/Profile.vue"]]);export{mt as default};
