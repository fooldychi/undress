const w={4:{inputs:{ckpt_name:"uberRealisticPornMerge_v23FinalSD.safetensors"},class_type:"CheckpointLoaderSimple",_meta:{title:"Checkpoint加载器（简易）"}},20:{inputs:{vae_name:"SD/vae-ft-mse-840000-ema-pruned.safetensors"},class_type:"VAELoader",_meta:{title:"加载VAE"}},49:{inputs:{image:"3094c87b9fe9c00f76146f32f36c3beb4839.jpeg"},class_type:"LoadImage",_meta:{title:"加载图像"}},107:{inputs:{preset:"PLUS (high strength)",model:["664",0]},class_type:"IPAdapterUnifiedLoader",_meta:{title:"IPAdapter加载器"}},115:{inputs:{weight:.8,weight_type:"style transfer",combine_embeds:"concat",start_at:0,end_at:1,embeds_scaling:"V only",model:["107",0],ipadapter:["107",1],image:["319",0],image_negative:["116",0],clip_vision:["194",0]},class_type:"IPAdapterAdvanced",_meta:{title:"应用IPAdapter（高级）"}},116:{inputs:{type:"dissolve",strength:.6,blur:3},class_type:"IPAdapterNoise",_meta:{title:"IPAdapter噪波"}},173:{inputs:{samples:["174",3],vae:["20",0]},class_type:"VAEDecode",_meta:{title:"VAE解码"}},174:{inputs:{add_noise:"enable",noise_seed:815242277936545,steps:35,cfg:3.5,sampler_name:"dpmpp_2m_sde",scheduler:"karras",start_at_step:0,end_at_step:1e4,return_with_leftover_noise:"disable",preview_method:"auto",vae_decode:"false",model:["190",0],positive:["190",1],negative:["190",2],latent_image:["190",3]},class_type:"KSampler Adv. (Efficient)",_meta:{title:"K采样器(高级效率)"}},176:{inputs:{kernel:10,sigma:10,inpaint:["173",0],original:["259",0],mask:["177",0],origin:["264",2]},class_type:"BlendInpaint",_meta:{title:"局部重绘（融合）"}},177:{inputs:{expand:5,tapered_corners:!0,mask:["606",0]},class_type:"GrowMask",_meta:{title:"扩展遮罩"}},186:{inputs:{brushnet:"brushnet_segmentation_mask_fp16.safetensors",dtype:"float16"},class_type:"BrushNetLoader",_meta:{title:"BrushNet（加载）"}},190:{inputs:{scale:.8,start_at:5,end_at:1e4,model:["115",0],vae:["20",0],image:["264",0],mask:["606",0],brushnet:["186",0],positive:["706",0],negative:["706",1]},class_type:"BrushNet",_meta:{title:"BrushNet（应用）"}},194:{inputs:{clip_name:"CLIP-ViT-H-14-laion2B-s32B-b79K.safetensors"},class_type:"CLIPVisionLoader",_meta:{title:"加载CLIP视觉"}},234:{inputs:{mask_opacity:1,mask_color:"255, 255, 255",pass_through:!1,image:["264",0],mask:["606",0]},class_type:"ImageAndMaskPreview",_meta:{title:"图像与遮罩预览"}},257:{inputs:{python_expression:"( (512 + (0 if c > 0 else c)) **2 / (a * b) ) ** 0.5",print_to_console:"True",a:["266",0],b:["266",1],c:["623",0]},class_type:"Evaluate Integers",_meta:{title:"整数运算"}},259:{inputs:{upscale_method:"lanczos",scale_by:["257",1],image:["552",0]},class_type:"ImageScaleBy",_meta:{title:"缩放图像（比例）"}},260:{inputs:{mask:["703",0]},class_type:"MaskToImage",_meta:{title:"遮罩转换为图像"}},261:{inputs:{upscale_method:"lanczos",scale_by:["257",1],image:["260",0]},class_type:"ImageScaleBy",_meta:{title:"缩放图像（比例）"}},262:{inputs:{channel:"red",image:["261",0]},class_type:"ImageToMask",_meta:{title:"图像转换为遮罩"}},264:{inputs:{width:["575",0],height:["576",0],image:["259",0],mask:["262",0]},class_type:"CutForInpaint",_meta:{title:"局部重绘（裁剪）"}},265:{inputs:{image_crop_multi:1,mask_crop_multi:1,bbox_smooth_alpha:1,image:["552",0],mask:["512",0]},class_type:"easy imageCropFromMask",_meta:{title:"遮罩裁剪图像"}},266:{inputs:{image:["265",0]},class_type:"easy imageSize",_meta:{title:"图像尺寸"}},285:{inputs:{text:`completely_nude:1.5,bald_girl, ruanyi0336,
`,token_normalization:"none",weight_interpretation:"A1111",speak_and_recognation:{__value__:[!1,!0]},clip:["664",1]},class_type:"BNK_CLIPTextEncodeAdvanced",_meta:{title:"CLIP文本编码器(BNK)"}},286:{inputs:{text:`clothing,public_hair,navel_piercing

(deformed iris, deformed pupils, semi-realistic, cgi, 3d, render, sketch, cartoon, drawing, anime), text, cropped, out of frame, worst quality, low quality, jpeg artifacts, ugly, duplicate, morbid, mutilated, extra fingers, mutated hands, poorly drawn hands, poorly drawn face, mutation, deformed, blurry, dehydrated, bad anatomy, bad proportions, extra limbs, cloned face, disfigured, gross proportions, malformed limbs, missing arms, missing legs, extra arms, extra legs, fused fingers, too many fingers, long neck,`,token_normalization:"none",weight_interpretation:"A1111",speak_and_recognation:{__value__:[!1,!0]},clip:["664",1]},class_type:"BNK_CLIPTextEncodeAdvanced",_meta:{title:"CLIP文本编码器(BNK)"}},319:{inputs:{interpolation:"LANCZOS",crop_position:"center",sharpening:.15,image:["531",0]},class_type:"PrepImageForClipVision",_meta:{title:"CLIP视觉图像处理"}},481:{inputs:{expand:15,incremental_expandrate:0,tapered_corners:!0,flip_input:!1,blur_radius:5,lerp_alpha:1,decay_factor:1,fill_holes:!0,mask:["545",0]},class_type:"GrowMaskWithBlur",_meta:{title:"遮罩模糊生长"}},492:{inputs:{x:0,y:0,operation:"add",destination:["721",1],source:["556",0]},class_type:"MaskComposite",_meta:{title:"合成遮罩"}},496:{inputs:{directory:"/workspace/input",image_load_cap:1,skip_first_images:54,select_every_nth:1},class_type:"VHS_LoadImagesPath",_meta:{title:"加载图像（路径）"}},512:{inputs:{erode_dilate:0,fill_holes:0,remove_isolated_pixels:10,smooth:0,blur:0,mask:["481",0]},class_type:"MaskFix+",_meta:{title:"遮罩修复"}},531:{inputs:{image_crop_multi:1,mask_crop_multi:1,bbox_smooth_alpha:1,image:["552",0],mask:["719",1]},class_type:"easy imageCropFromMask",_meta:{title:"遮罩裁剪图像"}},545:{inputs:{boolean:["549",0],on_true:["492",0],on_false:["556",0]},class_type:"easy ifElse",_meta:{title:"是否判断"}},549:{inputs:{value:!0},class_type:"easy boolean",_meta:{title:"布尔"}},552:{inputs:{boolean:["553",0],on_true:["496",0],on_false:["49",0]},class_type:"easy ifElse",_meta:{title:"是否判断"}},553:{inputs:{value:!1},class_type:"easy boolean",_meta:{title:"布尔"}},556:{inputs:{boolean:["553",0],on_true:["496",1],on_false:["49",1]},class_type:"easy ifElse",_meta:{title:"是否判断"}},562:{inputs:{mask_opacity:1,mask_color:"255, 255, 255",pass_through:!1,image:["552",0],mask:["492",0]},class_type:"ImageAndMaskPreview",_meta:{title:"图像与遮罩预览"}},563:{inputs:{detect_hand:"enable",detect_body:"enable",detect_face:"enable",resolution:["626",0],bbox_detector:"yolox_l.onnx",pose_estimator:"dw-ll_ucoco_384_bs5.torchscript.pt",scale_stick_for_xinsr_cn:"disable",image:["264",0]},class_type:"DWPreprocessor",_meta:{title:"DW姿态预处理器"}},572:{inputs:{image:["552",0]},class_type:"easy imageSize",_meta:{title:"图像尺寸"}},573:{inputs:{upscale_method:"lanczos",width:["572",0],height:["572",1],crop:"disabled",image:["176",0]},class_type:"ImageScale",_meta:{title:"缩放图像"}},575:{inputs:{expression:`a * b + 10


`,speak_and_recognation:{__value__:[!1,!0]},a:["583",0],b:["257",1]},class_type:"MathExpression|pysssss",_meta:{title:"数学表达式"}},576:{inputs:{expression:`a * b + 10
`,speak_and_recognation:{__value__:[!1,!0]},a:["583",1],b:["257",1]},class_type:"MathExpression|pysssss",_meta:{title:"数学表达式"}},583:{inputs:{image:["594",0]},class_type:"easy imageSize",_meta:{title:"图像尺寸"}},585:{inputs:{x:0,y:0,operation:"add",destination:["722",1],source:["512",0]},class_type:"MaskComposite",_meta:{title:"合成遮罩"}},588:{inputs:{image:["594",0]},class_type:"easy imageSize",_meta:{title:"图像尺寸"}},590:{inputs:{mask_opacity:1,mask_color:"255, 255, 255",pass_through:!1,image:["552",0],mask:["703",0]},class_type:"ImageAndMaskPreview",_meta:{title:"图像与遮罩预览"}},594:{inputs:{image_crop_multi:1,mask_crop_multi:1,bbox_smooth_alpha:1,image:["552",0],mask:["703",0]},class_type:"easy imageCropFromMask",_meta:{title:"遮罩裁剪图像"}},596:{inputs:{width:["588",0],height:["588",1],image:["552",0],mask:["703",0]},class_type:"CutForInpaint",_meta:{title:"局部重绘（裁剪）"}},602:{inputs:{width:["575",0],height:["576",0],image:["604",0],mask:["262",0]},class_type:"CutForInpaint",_meta:{title:"局部重绘（裁剪）"}},603:{inputs:{mask:["512",0]},class_type:"MaskToImage",_meta:{title:"遮罩转换为图像"}},604:{inputs:{upscale_method:"lanczos",scale_by:["257",1],image:["603",0]},class_type:"ImageScaleBy",_meta:{title:"缩放图像（比例）"}},606:{inputs:{channel:"red",image:["602",0]},class_type:"ImageToMask",_meta:{title:"图像转换为遮罩"}},611:{inputs:{mask_opacity:1,mask_color:"255, 255, 255",pass_through:!0,image:["612",0],mask:["612",1]},class_type:"ImageAndMaskPreview",_meta:{title:"图像与遮罩预览"}},612:{inputs:{image_crop_multi:1,mask_crop_multi:1,bbox_smooth_alpha:1,image:["264",0],mask:["606",0]},class_type:"easy imageCropFromMask",_meta:{title:"遮罩裁剪图像"}},619:{inputs:{image:["611",0]},class_type:"easy imageSize",_meta:{title:"图像尺寸"}},623:{inputs:{expression:`((c**2) * b / a)**0.5 - 512



`,speak_and_recognation:{__value__:[!1,!0]},a:["628",0],b:["624",0],c:["630",0]},class_type:"MathExpression|pysssss",_meta:{title:"数学表达式"}},624:{inputs:{expression:`a * b 

`,speak_and_recognation:{__value__:[!1,!0]},a:["266",0],b:["266",1]},class_type:"MathExpression|pysssss",_meta:{title:"数学表达式"}},626:{inputs:{image:["264",0]},class_type:"easy imageSize",_meta:{title:"图像尺寸"}},628:{inputs:{expression:`a * b 

`,speak_and_recognation:{__value__:[!1,!0]},a:["583",0],b:["583",1]},class_type:"MathExpression|pysssss",_meta:{title:"数学表达式"}},630:{inputs:{value:1024},class_type:"easy int",_meta:{title:"整数"}},664:{inputs:{PowerLoraLoaderHeaderWidget:{type:"PowerLoraLoaderHeaderWidget"},lora_1:{on:!0,lora:"0336-One-line-crotch-pantyhose_v1_pony.safetensors",strength:1},"➕ Add Lora":"",model:["4",0],clip:["4",1]},class_type:"Power Lora Loader (rgthree)",_meta:{title:"强力LoRA加载器"}},691:{inputs:{x:0,y:0,operation:"subtract",destination:["492",0],source:["719",1]},class_type:"MaskComposite",_meta:{title:"合成遮罩"}},692:{inputs:{mask_opacity:1,mask_color:"255, 255, 255",pass_through:!1,image:["552",0],mask:["691",0]},class_type:"ImageAndMaskPreview",_meta:{title:"图像与遮罩预览"}},703:{inputs:{x:0,y:0,operation:"add",destination:["721",1],source:["585",0]},class_type:"MaskComposite",_meta:{title:"合成遮罩"}},705:{inputs:{control_net_name:"SD15/control_v11p_sd15_openpose_fp16.safetensors"},class_type:"ControlNetLoader",_meta:{title:"加载ControlNet模型"}},706:{inputs:{strength:1,start_percent:0,end_percent:1,positive:["285",0],negative:["286",0],control_net:["705",0],image:["563",0]},class_type:"ControlNetApplyAdvanced",_meta:{title:"应用ControlNet（旧版高级）"}},710:{inputs:{images:["573",0]},class_type:"PreviewImage",_meta:{title:"预览图像"}},713:{inputs:{rgthree_comparer:{images:[{name:"A",selected:!0,url:"/api/view?filename=rgthree.compare._temp_dgmxs_00001_.png&type=temp&subfolder=&rand=0.18539012641484653"},{name:"B",selected:!0,url:"/api/view?filename=rgthree.compare._temp_dgmxs_00002_.png&type=temp&subfolder=&rand=0.04662468838155842"}]},image_a:["573",0],image_b:["49",0]},class_type:"Image Comparer (rgthree)",_meta:{title:"图像比较器"}},719:{inputs:{prompt:"face",threshold:.3,sam_model:["727",0],grounding_dino_model:["724",0],image:["552",0]},class_type:"GroundingDinoSAMSegment (segment anything)",_meta:{title:"G-DinoSAM语义分割"}},721:{inputs:{prompt:"clothing",threshold:.3,sam_model:["727",0],grounding_dino_model:["724",0],image:["552",0]},class_type:"GroundingDinoSAMSegment (segment anything)",_meta:{title:"G-DinoSAM语义分割"}},722:{inputs:{prompt:"girl",threshold:.3,sam_model:["727",0],grounding_dino_model:["724",0],image:["552",0]},class_type:"GroundingDinoSAMSegment (segment anything)",_meta:{title:"G-DinoSAM语义分割"}},724:{inputs:{model_name:"GroundingDINO_SwinB (938MB)"},class_type:"GroundingDinoModelLoader (segment anything)",_meta:{title:"G-Dino模型加载器"}},727:{inputs:{model_name:"sam_hq_vit_h (2.57GB)"},class_type:"SAMModelLoader (segment anything)",_meta:{title:"SAM模型加载器"}}},f={COMFYUI_SERVER_URL:"https://dzqgp58z0s-8188.cnb.run",USE_PROXY:!0,PROXY_SERVER_URL:"http://localhost:3008/api",CLIENT_ID:"abc1373d4ad648a3a81d0587fbe5534b",TIMEOUT:3e5};function u(){const t=localStorage.getItem("comfyui_config");if(t)try{const e=JSON.parse(t);return{...f,...e}}catch(e){console.warn("解析保存的配置失败，使用默认配置:",e)}return{...f}}function k(t){try{localStorage.setItem("comfyui_config",JSON.stringify(t)),console.log("ComfyUI配置已保存:",t)}catch(e){console.error("保存配置失败:",e)}}function x(t){const n={...u(),...t};return k(n),n}function M(){return u()}function y(){const t=u();return t.USE_PROXY?t.PROXY_SERVER_URL:t.COMFYUI_SERVER_URL}function A(){return localStorage.removeItem("comfyui_config"),{...f}}function P(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}async function b(t){try{const e=u(),n=y();if(console.log("🔄 第一步：上传图片到ComfyUI服务器"),console.log("📡 API地址:",`${n}/upload/image`),console.log("🔧 使用代理:",e.USE_PROXY?"是":"否"),!t||!t.startsWith("data:image/"))throw new Error("无效的base64图片格式");const a=t.split(",")[1],s=t.split(",")[0].split(":")[1].split(";")[0],i=s.split("/")[1]||"jpg",p=`upload_${Date.now()}_${Math.random().toString(36).substring(7)}.${i}`,r=atob(a),_=new Array(r.length);for(let o=0;o<r.length;o++)_[o]=r.charCodeAt(o);const c=new Uint8Array(_),m=new Blob([c],{type:s});console.log("📤 上传文件信息:",{filename:p,type:s,size:`${(m.size/1024).toFixed(2)} KB`});const g=[{name:"标准FormData上传",method:async()=>{const o=new FormData;return o.append("image",m,p),o.append("type","input"),o.append("subfolder",""),o.append("overwrite","false"),fetch(`${n}/upload/image`,{method:"POST",body:o,mode:"cors",credentials:"omit"})}},{name:"简化FormData上传",method:async()=>{const o=new FormData;return o.append("image",m,p),fetch(`${n}/upload/image`,{method:"POST",body:o,mode:"cors",credentials:"omit"})}},{name:"无CORS模式上传",method:async()=>{const o=new FormData;return o.append("image",m,p),o.append("type","input"),fetch(`${e.BASE_URL}/upload/image`,{method:"POST",body:o,mode:"no-cors"})}}];let h=null;for(const o of g)try{console.log(`🔄 尝试: ${o.name}`);const l=await o.method();if(console.log("📥 上传响应状态:",l.status,l.statusText),l.ok){const d=await l.json();if(console.log("✅ 图片上传成功:",d),!d.name)throw new Error("上传响应中缺少文件名");return d.name}else if(l.status!==0){const d=await l.text();console.error(`❌ ${o.name} 失败:`,d),h=new Error(`${o.name} 失败: ${l.status} ${l.statusText} - ${d}`)}}catch(l){console.error(`❌ ${o.name} 错误:`,l),h=l;continue}throw h||new Error("所有上传方法都失败了")}catch(e){throw console.error("❌ 图片上传失败:",e),e.message.includes("CORS")?new Error("图片上传失败: CORS错误 - ComfyUI服务器可能没有设置正确的跨域头"):e.message.includes("network")?new Error("图片上传失败: 网络错误 - 请检查ComfyUI服务器是否运行正常"):new Error(`图片上传失败: ${e.message}`)}}function I(t){try{const e=JSON.parse(JSON.stringify(w));if(e[49]&&e[49].class_type==="LoadImage")e[49].inputs.image=t,console.log("节点49图片设置为:",t);else throw new Error("工作流中未找到节点49或节点类型不正确");if(e[174]&&e[174].inputs){const n=Math.floor(Math.random()*1e15);e[174].inputs.noise_seed=n,console.log("随机种子设置为:",n)}return console.log("工作流配置完成"),e}catch(e){throw console.error("工作流创建失败:",e),new Error(`工作流创建失败: ${e.message}`)}}async function S(t){var e,n;try{const a=u(),s=y();console.log("🔄 第二步：提交工作流到ComfyUI"),console.log("📡 API地址:",`${s}/prompt`),console.log("🔧 使用代理:",a.USE_PROXY?"是":"否");const i={client_id:a.CLIENT_ID,prompt:t};console.log("📋 请求体结构:",{client_id:i.client_id,prompt_keys:Object.keys(i.prompt),node_49_exists:!!i.prompt[49],node_49_image:(n=(e=i.prompt[49])==null?void 0:e.inputs)==null?void 0:n.image});const p=`${s}/prompt`;console.log("🌐 调用工作流API:",p);const r=await fetch(p,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),mode:"cors",credentials:"omit"});if(console.log("📥 工作流响应状态:",r.status,r.statusText),!r.ok){const c=await r.text();throw console.error("❌ 工作流提交失败响应:",c),new Error(`工作流提交失败: ${r.status} ${r.statusText} - ${c}`)}const _=await r.json();if(console.log("✅ 工作流提交成功:",_),!_.prompt_id)throw new Error("工作流响应中缺少prompt_id");return _.prompt_id}catch(a){throw console.error("❌ 工作流提交失败:",a),new Error(`工作流提交失败: ${a.message}`)}}async function C(t){try{const e=u(),n=y();console.log("🔍 查询任务状态:",`${n}/history/${t}`);const a=await fetch(`${n}/history/${t}`);if(!a.ok)throw new Error(`状态查询失败: ${a.status} ${a.statusText}`);return(await a.json())[t]||null}catch(e){throw console.error("状态查询失败:",e),new Error(`状态查询失败: ${e.message}`)}}async function E(t){try{const e=u(),n=y(),a=t.outputs;let s=null;if(a[710]&&a[710].images&&a[710].images.length>0)s=a[710].images[0],console.log("📷 找到节点710的处理结果图片:",s);else{console.log("⚠️ 节点710无输出，查找其他节点...");for(const c in a){const m=a[c];if(m.images&&m.images.length>0){s=m.images[0],console.log(`📷 找到节点${c}的图片:`,s);break}}}if(!s)throw console.error("❌ 所有节点输出:",JSON.stringify(a,null,2)),new Error("未找到生成的图片");console.log("📷 最终选择的图片:",s);const i=new URLSearchParams({filename:s.filename,type:s.type,subfolder:s.subfolder||""}),p=`${n}/view?${i.toString()}`;console.log("🌐 获取图片URL:",p);const r=await fetch(p);if(!r.ok)throw new Error(`图片获取失败: ${r.status}`);const _=await r.blob();return new Promise((c,m)=>{const g=new FileReader;g.onload=()=>c(g.result),g.onerror=m,g.readAsDataURL(_)})}catch(e){throw console.error("图片获取失败:",e),new Error(`图片获取失败: ${e.message}`)}}async function v(t,e=3e5){const n=Date.now(),a=2e3;for(;Date.now()-n<e;){const s=await C(t);if(s){if(s.status&&s.status.completed)return s;if(s.status&&s.status.status_str==="error")throw new Error(`任务执行失败: ${JSON.stringify(s.status)}`)}await new Promise(i=>setTimeout(i,a))}throw new Error("任务执行超时")}async function L(t){try{if(console.log("🚀 开始处理换衣请求..."),console.log("📋 流程：第一步上传图片 → 第二步提交工作流"),console.log("🔍 验证图片数据格式..."),!t||!t.startsWith("data:image/"))throw new Error("无效的图片数据格式");console.log("📤 第一步：上传图片到 /api/upload/image");const e=await b(t);console.log("✅ 第一步完成，获得文件名:",e),console.log("🔧 配置工作流，关联图片到节点49...");const n=I(e);console.log("🚀 第二步：提交工作流到 /api/prompt");const a=await S(n);console.log("✅ 第二步完成，获得任务ID:",a),console.log("⏳ 等待ComfyUI处理任务...");const s=await v(a);console.log("✅ 任务处理完成"),console.log("📥 获取生成的图片...");const i=await E(s);return console.log("🎉 换衣处理完全成功！"),{success:!0,resultImage:i,promptId:a,uploadedImageName:e,message:"换衣处理完成"}}catch(e){return console.error("❌ 换衣处理失败:",e),{success:!1,error:e.message,message:"换衣处理失败"}}}export{P as generateClientId,y as getApiBaseUrl,M as getCurrentConfig,L as processUndressImage,A as resetToDefaultConfig,x as updateComfyUIConfig};
