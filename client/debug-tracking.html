<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComfyUI æœåŠ¡å™¨ä¸€è‡´æ€§å’Œ Prompt ID è·Ÿè¸ªæµ‹è¯•</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background-color: #1a1a1a;
            color: #00ff00;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .log-output {
            background-color: #000;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .button {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background-color: #0052a3;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background-color: #004d00; }
        .status.warning { background-color: #664400; }
        .status.error { background-color: #660000; }
        .tracking-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .info-box {
            background-color: #333;
            padding: 15px;
            border-radius: 4px;
        }
        .info-box h3 {
            margin-top: 0;
            color: #ffff00;
        }
        .info-item {
            margin: 8px 0;
            padding: 5px;
            background-color: #444;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ComfyUI æœåŠ¡å™¨ä¸€è‡´æ€§å’Œ Prompt ID è·Ÿè¸ªæµ‹è¯•</h1>
        
        <div class="section">
            <h2>ğŸ“Š å®æ—¶çŠ¶æ€ç›‘æ§</h2>
            <div class="tracking-info">
                <div class="info-box">
                    <h3>ğŸ”— WebSocket æœåŠ¡å™¨çŠ¶æ€</h3>
                    <div class="info-item">
                        <strong>å½“å‰é”å®šæœåŠ¡å™¨:</strong> <span id="locked-server">æœªçŸ¥</span>
                    </div>
                    <div class="info-item">
                        <strong>è¿æ¥çŠ¶æ€:</strong> <span id="connection-status">æœªçŸ¥</span>
                    </div>
                    <div class="info-item">
                        <strong>é”å®šæ—¶é—´:</strong> <span id="lock-time">æœªçŸ¥</span>
                    </div>
                    <div class="info-item">
                        <strong>å¾…å¤„ç†ä»»åŠ¡æ•°:</strong> <span id="pending-tasks">0</span>
                    </div>
                </div>
                
                <div class="info-box">
                    <h3>ğŸ†” Prompt ID è·Ÿè¸ª</h3>
                    <div class="info-item">
                        <strong>æœ€æ–°ç”Ÿæˆçš„ Prompt ID:</strong> <span id="latest-prompt-id">æ— </span>
                    </div>
                    <div class="info-item">
                        <strong>å½“å‰å¤„ç†çš„ Prompt ID:</strong> <span id="current-prompt-id">æ— </span>
                    </div>
                    <div class="info-item">
                        <strong>Prompt ID ä¸€è‡´æ€§:</strong> <span id="prompt-consistency">âœ… ä¸€è‡´</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ® æµ‹è¯•æ§åˆ¶</h2>
            <button class="button" onclick="startWebSocketConnection()">ğŸ”Œ å¯åŠ¨ WebSocket è¿æ¥</button>
            <button class="button" onclick="testServerConsistency()">ğŸ” æµ‹è¯•æœåŠ¡å™¨ä¸€è‡´æ€§</button>
            <button class="button" onclick="simulateTaskSubmission()">ğŸ“¤ æ¨¡æ‹Ÿä»»åŠ¡æäº¤</button>
            <button class="button" onclick="checkWebSocketStatus()">ğŸ“Š æ£€æŸ¥ WebSocket çŠ¶æ€</button>
            <button class="button" onclick="clearLogs()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
            <button class="button" onclick="resetWebSocketServer()">ğŸ”„ é‡ç½® WebSocket æœåŠ¡å™¨</button>
        </div>

        <div class="section">
            <h2>ğŸ“ å®æ—¶è·Ÿè¸ªæ—¥å¿—</h2>
            <div id="log-output" class="log-output"></div>
        </div>

        <div class="section">
            <h2>âš ï¸ è¯´æ˜</h2>
            <p>æ­¤é¡µé¢ç”¨äºå®æ—¶ç›‘æ§ ComfyUI æœåŠ¡çš„æœåŠ¡å™¨ä¸€è‡´æ€§å’Œ Prompt ID è·Ÿè¸ªã€‚</p>
            <p><strong>ç›‘æ§é‡ç‚¹ï¼š</strong></p>
            <ul>
                <li>ğŸ”— WebSocket è¿æ¥çš„æœåŠ¡å™¨æ˜¯å¦ä¿æŒä¸€è‡´</li>
                <li>ğŸ†” Prompt ID åœ¨æ•´ä¸ªç”Ÿæˆè¿‡ç¨‹ä¸­æ˜¯å¦ä¿æŒä¸€è‡´</li>
                <li>ğŸ“Š ä»»åŠ¡çŠ¶æ€å’ŒæœåŠ¡å™¨é”å®šæœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ</li>
                <li>â±ï¸ å»¶è¿Ÿé—®é¢˜çš„å®šä½å’Œåˆ†æ</li>
            </ul>
        </div>
    </div>

    <script type="module">
        // å¯¼å…¥ ComfyUI æœåŠ¡
        import { 
            initializeWebSocket, 
            getWebSocketServerStatus,
            generatePromptId,
            getApiBaseUrl,
            validateServerConsistency
        } from './src/services/comfyui.js';

        // å…¨å±€å˜é‡
        let latestPromptId = null;
        let currentPromptId = null;
        let logContainer = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('log-output');
            startStatusMonitoring();
            setupConsoleCapture();
            log('ğŸš€ è·Ÿè¸ªç³»ç»Ÿå·²å¯åŠ¨');
        });

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            if (logContainer) {
                logContainer.textContent += logMessage;
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            console.log(logMessage);
        }

        // æ•è·æ§åˆ¶å°è¾“å‡º
        function setupConsoleCapture() {
            const originalLog = console.log;
            console.log = function(...args) {
                const message = args.join(' ');
                if (message.includes('[SERVER_TRACK]') || message.includes('[PROMPT_ID_TRACK]')) {
                    if (logContainer) {
                        logContainer.textContent += message + '\n';
                        logContainer.scrollTop = logContainer.scrollHeight;
                    }
                }
                originalLog.apply(console, args);
            };
        }

        // çŠ¶æ€ç›‘æ§
        function startStatusMonitoring() {
            setInterval(updateStatus, 2000);
            updateStatus();
        }

        function updateStatus() {
            try {
                const status = window.getWebSocketServerStatus ? window.getWebSocketServerStatus() : {};
                
                document.getElementById('locked-server').textContent = status.lockedServer || 'æœªé”å®š';
                document.getElementById('connection-status').textContent = status.isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
                document.getElementById('lock-time').textContent = status.lockTimestamp ? 
                    new Date(status.lockTimestamp).toLocaleTimeString() : 'æ— ';
                document.getElementById('pending-tasks').textContent = status.pendingTasksCount || 0;
                
                document.getElementById('latest-prompt-id').textContent = latestPromptId || 'æ— ';
                document.getElementById('current-prompt-id').textContent = currentPromptId || 'æ— ';
                
                // æ£€æŸ¥ä¸€è‡´æ€§
                const isConsistent = !latestPromptId || !currentPromptId || latestPromptId === currentPromptId;
                document.getElementById('prompt-consistency').textContent = isConsistent ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´';
                document.getElementById('prompt-consistency').style.color = isConsistent ? '#00ff00' : '#ff0000';
                
            } catch (error) {
                log(`âŒ çŠ¶æ€æ›´æ–°å¤±è´¥: ${error.message}`);
            }
        }

        // æµ‹è¯•å‡½æ•°
        window.startWebSocketConnection = async function() {
            try {
                log('ğŸ”Œ å¯åŠ¨ WebSocket è¿æ¥...');
                await initializeWebSocket();
                log('âœ… WebSocket è¿æ¥å¯åŠ¨æˆåŠŸ');
            } catch (error) {
                log(`âŒ WebSocket è¿æ¥å¯åŠ¨å¤±è´¥: ${error.message}`);
            }
        };

        window.testServerConsistency = async function() {
            try {
                log('ğŸ” æµ‹è¯•æœåŠ¡å™¨ä¸€è‡´æ€§...');
                const result = await validateServerConsistency('æµ‹è¯•è°ƒç”¨');
                log(`ğŸ“Š æœåŠ¡å™¨ä¸€è‡´æ€§ç»“æœ: ${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                log(`âŒ æœåŠ¡å™¨ä¸€è‡´æ€§æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        };

        window.simulateTaskSubmission = function() {
            try {
                log('ğŸ“¤ æ¨¡æ‹Ÿä»»åŠ¡æäº¤...');
                latestPromptId = generatePromptId();
                currentPromptId = latestPromptId;
                log(`ğŸ†” ç”Ÿæˆæ–°çš„ Prompt ID: ${latestPromptId}`);
                log('âœ… ä»»åŠ¡æäº¤æ¨¡æ‹Ÿå®Œæˆ');
            } catch (error) {
                log(`âŒ ä»»åŠ¡æäº¤æ¨¡æ‹Ÿå¤±è´¥: ${error.message}`);
            }
        };

        window.checkWebSocketStatus = function() {
            try {
                log('ğŸ“Š æ£€æŸ¥ WebSocket çŠ¶æ€...');
                if (window.debugWebSocketLock) {
                    const result = window.debugWebSocketLock();
                    log(`ğŸ” WebSocket è°ƒè¯•ä¿¡æ¯: ${JSON.stringify(result, null, 2)}`);
                } else {
                    log('âš ï¸ WebSocket è°ƒè¯•å‡½æ•°ä¸å¯ç”¨');
                }
            } catch (error) {
                log(`âŒ WebSocket çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`);
            }
        };

        window.clearLogs = function() {
            if (logContainer) {
                logContainer.textContent = '';
            }
            log('ğŸ§¹ æ—¥å¿—å·²æ¸…ç©º');
        };

        window.resetWebSocketServer = function() {
            try {
                log('ğŸ”„ é‡ç½® WebSocket æœåŠ¡å™¨...');
                if (window.resetWebSocketServer) {
                    const result = window.resetWebSocketServer(true);
                    log(`ğŸ”„ é‡ç½®ç»“æœ: ${result ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
                } else {
                    log('âš ï¸ WebSocket é‡ç½®å‡½æ•°ä¸å¯ç”¨');
                }
                latestPromptId = null;
                currentPromptId = null;
            } catch (error) {
                log(`âŒ WebSocket æœåŠ¡å™¨é‡ç½®å¤±è´¥: ${error.message}`);
            }
        };
    </script>
</body>
</html>
