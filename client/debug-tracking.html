<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComfyUI 服务器一致性和 Prompt ID 跟踪测试</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background-color: #1a1a1a;
            color: #00ff00;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .log-output {
            background-color: #000;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .button {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background-color: #0052a3;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background-color: #004d00; }
        .status.warning { background-color: #664400; }
        .status.error { background-color: #660000; }
        .tracking-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .info-box {
            background-color: #333;
            padding: 15px;
            border-radius: 4px;
        }
        .info-box h3 {
            margin-top: 0;
            color: #ffff00;
        }
        .info-item {
            margin: 8px 0;
            padding: 5px;
            background-color: #444;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 ComfyUI 服务器一致性和 Prompt ID 跟踪测试</h1>
        
        <div class="section">
            <h2>📊 实时状态监控</h2>
            <div class="tracking-info">
                <div class="info-box">
                    <h3>🔗 WebSocket 服务器状态</h3>
                    <div class="info-item">
                        <strong>当前锁定服务器:</strong> <span id="locked-server">未知</span>
                    </div>
                    <div class="info-item">
                        <strong>连接状态:</strong> <span id="connection-status">未知</span>
                    </div>
                    <div class="info-item">
                        <strong>锁定时间:</strong> <span id="lock-time">未知</span>
                    </div>
                    <div class="info-item">
                        <strong>待处理任务数:</strong> <span id="pending-tasks">0</span>
                    </div>
                </div>
                
                <div class="info-box">
                    <h3>🆔 Prompt ID 跟踪</h3>
                    <div class="info-item">
                        <strong>最新生成的 Prompt ID:</strong> <span id="latest-prompt-id">无</span>
                    </div>
                    <div class="info-item">
                        <strong>当前处理的 Prompt ID:</strong> <span id="current-prompt-id">无</span>
                    </div>
                    <div class="info-item">
                        <strong>Prompt ID 一致性:</strong> <span id="prompt-consistency">✅ 一致</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>🎮 测试控制</h2>
            <button class="button" onclick="startWebSocketConnection()">🔌 启动 WebSocket 连接</button>
            <button class="button" onclick="testServerConsistency()">🔍 测试服务器一致性</button>
            <button class="button" onclick="simulateTaskSubmission()">📤 模拟任务提交</button>
            <button class="button" onclick="checkWebSocketStatus()">📊 检查 WebSocket 状态</button>
            <button class="button" onclick="clearLogs()">🧹 清空日志</button>
            <button class="button" onclick="resetWebSocketServer()">🔄 重置 WebSocket 服务器</button>
        </div>

        <div class="section">
            <h2>📝 实时跟踪日志</h2>
            <div id="log-output" class="log-output"></div>
        </div>

        <div class="section">
            <h2>⚠️ 说明</h2>
            <p>此页面用于实时监控 ComfyUI 服务的服务器一致性和 Prompt ID 跟踪。</p>
            <p><strong>监控重点：</strong></p>
            <ul>
                <li>🔗 WebSocket 连接的服务器是否保持一致</li>
                <li>🆔 Prompt ID 在整个生成过程中是否保持一致</li>
                <li>📊 任务状态和服务器锁定机制是否正常工作</li>
                <li>⏱️ 延迟问题的定位和分析</li>
            </ul>
        </div>
    </div>

    <script type="module">
        // 导入 ComfyUI 服务
        import { 
            initializeWebSocket, 
            getWebSocketServerStatus,
            generatePromptId,
            getApiBaseUrl,
            validateServerConsistency
        } from './src/services/comfyui.js';

        // 全局变量
        let latestPromptId = null;
        let currentPromptId = null;
        let logContainer = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('log-output');
            startStatusMonitoring();
            setupConsoleCapture();
            log('🚀 跟踪系统已启动');
        });

        // 日志函数
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            if (logContainer) {
                logContainer.textContent += logMessage;
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            console.log(logMessage);
        }

        // 捕获控制台输出
        function setupConsoleCapture() {
            const originalLog = console.log;
            console.log = function(...args) {
                const message = args.join(' ');
                if (message.includes('[SERVER_TRACK]') || message.includes('[PROMPT_ID_TRACK]')) {
                    if (logContainer) {
                        logContainer.textContent += message + '\n';
                        logContainer.scrollTop = logContainer.scrollHeight;
                    }
                }
                originalLog.apply(console, args);
            };
        }

        // 状态监控
        function startStatusMonitoring() {
            setInterval(updateStatus, 2000);
            updateStatus();
        }

        function updateStatus() {
            try {
                const status = window.getWebSocketServerStatus ? window.getWebSocketServerStatus() : {};
                
                document.getElementById('locked-server').textContent = status.lockedServer || '未锁定';
                document.getElementById('connection-status').textContent = status.isConnected ? '已连接' : '未连接';
                document.getElementById('lock-time').textContent = status.lockTimestamp ? 
                    new Date(status.lockTimestamp).toLocaleTimeString() : '无';
                document.getElementById('pending-tasks').textContent = status.pendingTasksCount || 0;
                
                document.getElementById('latest-prompt-id').textContent = latestPromptId || '无';
                document.getElementById('current-prompt-id').textContent = currentPromptId || '无';
                
                // 检查一致性
                const isConsistent = !latestPromptId || !currentPromptId || latestPromptId === currentPromptId;
                document.getElementById('prompt-consistency').textContent = isConsistent ? '✅ 一致' : '❌ 不一致';
                document.getElementById('prompt-consistency').style.color = isConsistent ? '#00ff00' : '#ff0000';
                
            } catch (error) {
                log(`❌ 状态更新失败: ${error.message}`);
            }
        }

        // 测试函数
        window.startWebSocketConnection = async function() {
            try {
                log('🔌 启动 WebSocket 连接...');
                await initializeWebSocket();
                log('✅ WebSocket 连接启动成功');
            } catch (error) {
                log(`❌ WebSocket 连接启动失败: ${error.message}`);
            }
        };

        window.testServerConsistency = async function() {
            try {
                log('🔍 测试服务器一致性...');
                const result = await validateServerConsistency('测试调用');
                log(`📊 服务器一致性结果: ${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                log(`❌ 服务器一致性测试失败: ${error.message}`);
            }
        };

        window.simulateTaskSubmission = function() {
            try {
                log('📤 模拟任务提交...');
                latestPromptId = generatePromptId();
                currentPromptId = latestPromptId;
                log(`🆔 生成新的 Prompt ID: ${latestPromptId}`);
                log('✅ 任务提交模拟完成');
            } catch (error) {
                log(`❌ 任务提交模拟失败: ${error.message}`);
            }
        };

        window.checkWebSocketStatus = function() {
            try {
                log('📊 检查 WebSocket 状态...');
                if (window.debugWebSocketLock) {
                    const result = window.debugWebSocketLock();
                    log(`🔍 WebSocket 调试信息: ${JSON.stringify(result, null, 2)}`);
                } else {
                    log('⚠️ WebSocket 调试函数不可用');
                }
            } catch (error) {
                log(`❌ WebSocket 状态检查失败: ${error.message}`);
            }
        };

        window.clearLogs = function() {
            if (logContainer) {
                logContainer.textContent = '';
            }
            log('🧹 日志已清空');
        };

        window.resetWebSocketServer = function() {
            try {
                log('🔄 重置 WebSocket 服务器...');
                if (window.resetWebSocketServer) {
                    const result = window.resetWebSocketServer(true);
                    log(`🔄 重置结果: ${result ? '成功' : '失败'}`);
                } else {
                    log('⚠️ WebSocket 重置函数不可用');
                }
                latestPromptId = null;
                currentPromptId = null;
            } catch (error) {
                log(`❌ WebSocket 服务器重置失败: ${error.message}`);
            }
        };
    </script>
</body>
</html>
