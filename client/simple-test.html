<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Manager 修复测试</title>
</head>
<body>
    <h1>WebSocket Manager 修复测试</h1>
    <div id="output"></div>

    <script type="module">
        // 模拟浏览器环境
        window.console = console;
        
        // 模拟任务结果数据
        const mockTaskResult = {
            outputs: {
                '732': {
                    images: [
                        {
                            filename: 'test_image.png',
                            subfolder: '',
                            type: 'output'
                        }
                    ]
                },
                '49': {
                    images: [
                        {
                            filename: 'input_image.png',
                            subfolder: '',
                            type: 'input'
                        }
                    ]
                }
            },
            executionServer: 'https://test-server.com',
            promptId: 'test-prompt-123'
        };

        // 模拟历史数据结构
        const mockHistory = {
            'test-prompt-123': mockTaskResult
        };

        console.log('🧪 开始测试修复后的功能...');
        console.log('📊 模拟任务结果:', mockTaskResult);
        console.log('🔍 节点732存在:', !!mockTaskResult.outputs['732']);
        console.log('🔍 节点732图片数量:', mockTaskResult.outputs['732']?.images?.length || 0);
        
        // 测试结果提取逻辑（模拟 webSocketManager._extractResults）
        function testExtractResults(history, promptId) {
            const taskData = history[promptId];
            if (!taskData || !taskData.outputs) {
                console.warn(`⚠️ 任务 ${promptId} 没有输出数据`);
                return { outputs: {} };
            }

            console.log(`📋 原始历史数据结构:`);
            console.log(`📋 - 任务状态: ${taskData.status?.status_str || '未知'}`);
            console.log(`📋 - 输出节点数量: ${Object.keys(taskData.outputs).length}`);
            console.log(`📋 - 节点列表: [${Object.keys(taskData.outputs).join(', ')}]`);

            const results = {
                outputs: taskData.outputs,
                promptId: promptId,
                status: taskData.status,
                meta: taskData.meta || {}
            };

            // 详细记录每个节点的输出内容和类型
            for (const nodeId in taskData.outputs) {
                const nodeOutput = taskData.outputs[nodeId];
                console.log(`📊 节点 ${nodeId}:`);
                console.log(`   - 输出类型: ${Object.keys(nodeOutput).join(', ')}`);
                
                if (nodeOutput.images && Array.isArray(nodeOutput.images)) {
                    console.log(`   - 图片数量: ${nodeOutput.images.length}`);
                    nodeOutput.images.forEach((img, idx) => {
                        console.log(`   - 图片${idx + 1}: ${img.filename} (${img.type || 'output'})`);
                    });
                }
            }

            console.log(`✅ 结果提取完成，保留所有 ${Object.keys(taskData.outputs).length} 个节点的输出`);
            return results;
        }

        const extractedResult = testExtractResults(mockHistory, 'test-prompt-123');
        console.log('✅ 提取结果:', extractedResult);
        console.log('🎉 测试完成 - 节点732数据应该存在!');

        // 显示结果到页面
        document.getElementById('output').innerHTML = `
            <h2>测试结果</h2>
            <p><strong>节点732存在:</strong> ${!!extractedResult.outputs['732'] ? '✅ 是' : '❌ 否'}</p>
            <p><strong>节点数量:</strong> ${Object.keys(extractedResult.outputs).length}</p>
            <p><strong>执行服务器:</strong> ${extractedResult.executionServer || '未设置'}</p>
            <h3>节点详情</h3>
            <pre>${JSON.stringify(extractedResult.outputs, null, 2)}</pre>
        `;
    </script>
</body>
</html>
