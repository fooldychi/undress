<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Manager ä¿®å¤æµ‹è¯•</title>
</head>
<body>
    <h1>WebSocket Manager ä¿®å¤æµ‹è¯•</h1>
    <div id="output"></div>

    <script type="module">
        // æ¨¡æ‹Ÿæµè§ˆå™¨ç¯å¢ƒ
        window.console = console;
        
        // æ¨¡æ‹Ÿä»»åŠ¡ç»“æœæ•°æ®
        const mockTaskResult = {
            outputs: {
                '732': {
                    images: [
                        {
                            filename: 'test_image.png',
                            subfolder: '',
                            type: 'output'
                        }
                    ]
                },
                '49': {
                    images: [
                        {
                            filename: 'input_image.png',
                            subfolder: '',
                            type: 'input'
                        }
                    ]
                }
            },
            executionServer: 'https://test-server.com',
            promptId: 'test-prompt-123'
        };

        // æ¨¡æ‹Ÿå†å²æ•°æ®ç»“æ„
        const mockHistory = {
            'test-prompt-123': mockTaskResult
        };

        console.log('ğŸ§ª å¼€å§‹æµ‹è¯•ä¿®å¤åçš„åŠŸèƒ½...');
        console.log('ğŸ“Š æ¨¡æ‹Ÿä»»åŠ¡ç»“æœ:', mockTaskResult);
        console.log('ğŸ” èŠ‚ç‚¹732å­˜åœ¨:', !!mockTaskResult.outputs['732']);
        console.log('ğŸ” èŠ‚ç‚¹732å›¾ç‰‡æ•°é‡:', mockTaskResult.outputs['732']?.images?.length || 0);
        
        // æµ‹è¯•ç»“æœæå–é€»è¾‘ï¼ˆæ¨¡æ‹Ÿ webSocketManager._extractResultsï¼‰
        function testExtractResults(history, promptId) {
            const taskData = history[promptId];
            if (!taskData || !taskData.outputs) {
                console.warn(`âš ï¸ ä»»åŠ¡ ${promptId} æ²¡æœ‰è¾“å‡ºæ•°æ®`);
                return { outputs: {} };
            }

            console.log(`ğŸ“‹ åŸå§‹å†å²æ•°æ®ç»“æ„:`);
            console.log(`ğŸ“‹ - ä»»åŠ¡çŠ¶æ€: ${taskData.status?.status_str || 'æœªçŸ¥'}`);
            console.log(`ğŸ“‹ - è¾“å‡ºèŠ‚ç‚¹æ•°é‡: ${Object.keys(taskData.outputs).length}`);
            console.log(`ğŸ“‹ - èŠ‚ç‚¹åˆ—è¡¨: [${Object.keys(taskData.outputs).join(', ')}]`);

            const results = {
                outputs: taskData.outputs,
                promptId: promptId,
                status: taskData.status,
                meta: taskData.meta || {}
            };

            // è¯¦ç»†è®°å½•æ¯ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºå†…å®¹å’Œç±»å‹
            for (const nodeId in taskData.outputs) {
                const nodeOutput = taskData.outputs[nodeId];
                console.log(`ğŸ“Š èŠ‚ç‚¹ ${nodeId}:`);
                console.log(`   - è¾“å‡ºç±»å‹: ${Object.keys(nodeOutput).join(', ')}`);
                
                if (nodeOutput.images && Array.isArray(nodeOutput.images)) {
                    console.log(`   - å›¾ç‰‡æ•°é‡: ${nodeOutput.images.length}`);
                    nodeOutput.images.forEach((img, idx) => {
                        console.log(`   - å›¾ç‰‡${idx + 1}: ${img.filename} (${img.type || 'output'})`);
                    });
                }
            }

            console.log(`âœ… ç»“æœæå–å®Œæˆï¼Œä¿ç•™æ‰€æœ‰ ${Object.keys(taskData.outputs).length} ä¸ªèŠ‚ç‚¹çš„è¾“å‡º`);
            return results;
        }

        const extractedResult = testExtractResults(mockHistory, 'test-prompt-123');
        console.log('âœ… æå–ç»“æœ:', extractedResult);
        console.log('ğŸ‰ æµ‹è¯•å®Œæˆ - èŠ‚ç‚¹732æ•°æ®åº”è¯¥å­˜åœ¨!');

        // æ˜¾ç¤ºç»“æœåˆ°é¡µé¢
        document.getElementById('output').innerHTML = `
            <h2>æµ‹è¯•ç»“æœ</h2>
            <p><strong>èŠ‚ç‚¹732å­˜åœ¨:</strong> ${!!extractedResult.outputs['732'] ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
            <p><strong>èŠ‚ç‚¹æ•°é‡:</strong> ${Object.keys(extractedResult.outputs).length}</p>
            <p><strong>æ‰§è¡ŒæœåŠ¡å™¨:</strong> ${extractedResult.executionServer || 'æœªè®¾ç½®'}</p>
            <h3>èŠ‚ç‚¹è¯¦æƒ…</h3>
            <pre>${JSON.stringify(extractedResult.outputs, null, 2)}</pre>
        `;
    </script>
</body>
</html>
