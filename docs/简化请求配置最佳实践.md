# ç®€åŒ–è¯·æ±‚é…ç½®æœ€ä½³å®è·µ

## æ ¸å¿ƒåŸåˆ™

### ğŸ¯ æœ€å°åŒ–åŸåˆ™
åªä½¿ç”¨ç»å¯¹å¿…è¦çš„é…ç½®ï¼Œé¿å…æ·»åŠ å¯èƒ½å¯¼è‡´CORSé—®é¢˜çš„é¢å¤–è®¾ç½®ã€‚

### ğŸ”„ ä¸€è‡´æ€§åŸåˆ™
æ•´ä¸ªé¡¹ç›®ä½¿ç”¨ç»Ÿä¸€çš„ç®€åŒ–é…ç½®æ¨¡å¼ï¼Œä¾¿äºç»´æŠ¤å’Œè°ƒè¯•ã€‚

### ğŸ›¡ï¸ å…¼å®¹æ€§åŸåˆ™
ç¡®ä¿é…ç½®ä¸å„ç§æœåŠ¡å™¨ç¯å¢ƒå…¼å®¹ï¼Œé¿å…ç‰¹å®šç¯å¢ƒä¸‹çš„é—®é¢˜ã€‚

## æ ‡å‡†é…ç½®æ¨¡æ¿

### 1. GETè¯·æ±‚æ¨¡æ¿

```javascript
// âœ… æ¨èï¼šæœ€ç®€åŒ–GETè¯·æ±‚
const response = await fetch(url, {
  method: 'GET',
  signal: AbortSignal.timeout(10000) // å¯é€‰ï¼šè¶…æ—¶æ§åˆ¶
})

// âŒ é¿å…ï¼šå¤æ‚çš„GETè¯·æ±‚
const response = await fetch(url, {
  method: 'GET',
  headers: {
    'Accept': 'application/json',
    'User-Agent': 'Custom-Agent',
    'Cache-Control': 'no-cache'
  },
  mode: 'cors',
  credentials: 'omit'
})
```

### 2. POST JSONè¯·æ±‚æ¨¡æ¿

```javascript
// âœ… æ¨èï¼šç®€åŒ–çš„JSON POSTè¯·æ±‚
const response = await fetch(url, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(data)
})

// âŒ é¿å…ï¼šå¤æ‚çš„JSON POSTè¯·æ±‚
const response = await fetch(url, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Accept': 'application/json',
    'User-Agent': 'Custom-Agent',
    'comfy-user': 'client-id'
  },
  body: JSON.stringify(data),
  mode: 'cors',
  credentials: 'omit'
})
```

### 3. POST FormDataè¯·æ±‚æ¨¡æ¿

```javascript
// âœ… æ¨èï¼šç®€åŒ–çš„FormData POSTè¯·æ±‚
const response = await fetch(url, {
  method: 'POST',
  body: formData
  // FormDataä¼šè‡ªåŠ¨è®¾ç½®æ­£ç¡®çš„Content-Type
})

// âŒ é¿å…ï¼šæ‰‹åŠ¨è®¾ç½®FormDataå¤´éƒ¨
const response = await fetch(url, {
  method: 'POST',
  headers: {
    'Content-Type': 'multipart/form-data', // é”™è¯¯ï¼ä¼šç ´åboundary
    'Accept': '*/*'
  },
  body: formData
})
```

### 4. å¸¦è¶…æ—¶çš„è¯·æ±‚æ¨¡æ¿

```javascript
// âœ… æ¨èï¼šä½¿ç”¨AbortSignalæ§åˆ¶è¶…æ—¶
const controller = new AbortController()
const timeoutId = setTimeout(() => controller.abort(), 10000)

try {
  const response = await fetch(url, {
    method: 'GET',
    signal: controller.signal
  })
  clearTimeout(timeoutId)
  // å¤„ç†å“åº”
} catch (error) {
  clearTimeout(timeoutId)
  if (error.name === 'AbortError') {
    console.log('è¯·æ±‚è¶…æ—¶')
  }
}

// âœ… æ¨èï¼šä½¿ç”¨AbortSignal.timeout (ç°ä»£æµè§ˆå™¨)
const response = await fetch(url, {
  method: 'GET',
  signal: AbortSignal.timeout(10000)
})
```

## å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

### 1. CORSé¢„æ£€è¯·æ±‚é—®é¢˜

**é—®é¢˜**ï¼šæ·»åŠ è‡ªå®šä¹‰å¤´éƒ¨è§¦å‘OPTIONSé¢„æ£€è¯·æ±‚
```javascript
// âŒ ä¼šè§¦å‘é¢„æ£€è¯·æ±‚
headers: {
  'X-Custom-Header': 'value',
  'comfy-user': 'client-id'
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼šç§»é™¤è‡ªå®šä¹‰å¤´éƒ¨
```javascript
// âœ… é¿å…é¢„æ£€è¯·æ±‚
// ä¸æ·»åŠ è‡ªå®šä¹‰å¤´éƒ¨ï¼Œæˆ–ä½¿ç”¨ç®€å•å¤´éƒ¨
```

### 2. User-Agenté—®é¢˜

**é—®é¢˜**ï¼šå¤æ‚çš„User-Agentå¯èƒ½è¢«æœåŠ¡å™¨æ‹’ç»
```javascript
// âŒ å¤æ‚çš„User-Agent
headers: {
  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36...'
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨æµè§ˆå™¨é»˜è®¤User-Agent
```javascript
// âœ… ä½¿ç”¨æµè§ˆå™¨é»˜è®¤
// ä¸è®¾ç½®User-Agentå¤´éƒ¨
```

### 3. Content-Typeé”™è¯¯

**é—®é¢˜**ï¼šä¸ºFormDataæ‰‹åŠ¨è®¾ç½®Content-Type
```javascript
// âŒ ç ´åFormDataçš„boundary
headers: {
  'Content-Type': 'multipart/form-data'
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼šè®©æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®
```javascript
// âœ… æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®æ­£ç¡®çš„Content-Typeå’Œboundary
// ä¸ä¸ºFormDataè®¾ç½®Content-Type
```

### 4. è¿‡åº¦é…ç½®é—®é¢˜

**é—®é¢˜**ï¼šè®¾ç½®ä¸å¿…è¦çš„modeå’Œcredentials
```javascript
// âŒ ä¸å¿…è¦çš„é…ç½®
mode: 'cors',
credentials: 'omit',
cache: 'no-cache'
```

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨æµè§ˆå™¨é»˜è®¤å€¼
```javascript
// âœ… ä½¿ç”¨æµè§ˆå™¨é»˜è®¤è¡Œä¸º
// ä¸è®¾ç½®modeã€credentialsç­‰
```

## é¡¹ç›®ä¸­çš„åº”ç”¨ç¤ºä¾‹

### 1. ComfyUI APIè°ƒç”¨

```javascript
// ä¸Šä¼ å›¾ç‰‡
const response = await fetch(`${apiBaseUrl}/api/upload/image`, {
  method: 'POST',
  body: formData
})

// æäº¤å·¥ä½œæµ
const response = await fetch(`${apiBaseUrl}/api/prompt`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
})

// æŸ¥è¯¢çŠ¶æ€
const response = await fetch(`${apiBaseUrl}/api/history/${promptId}`)

// è·å–å›¾ç‰‡
const response = await fetch(`${apiBaseUrl}/api/view?${params}`)
```

### 2. å¥åº·æ£€æŸ¥

```javascript
// ç®€åŒ–çš„å¥åº·æ£€æŸ¥
const response = await fetch(`${serverUrl}/api/queue`, {
  method: 'GET',
  signal: AbortSignal.timeout(10000)
})
```

### 3. åŸºç¡€è¿æ¥æµ‹è¯•

```javascript
// HEADè¯·æ±‚æµ‹è¯•
const response = await fetch(url, {
  method: 'HEAD',
  signal: controller.signal
})

// GETè¯·æ±‚æµ‹è¯•
const response = await fetch(url, {
  method: 'GET',
  signal: controller.signal
})
```

## é…ç½®æ£€æŸ¥æ¸…å•

### âœ… æ¨èçš„é…ç½®
- [ ] åªè®¾ç½®å¿…è¦çš„è¯·æ±‚å¤´
- [ ] JSONè¯·æ±‚åªè®¾ç½®`Content-Type: application/json`
- [ ] FormDataè¯·æ±‚ä¸è®¾ç½®Content-Type
- [ ] ä½¿ç”¨AbortSignalæ§åˆ¶è¶…æ—¶
- [ ] ä½¿ç”¨æµè§ˆå™¨é»˜è®¤çš„modeå’Œcredentials

### âŒ é¿å…çš„é…ç½®
- [ ] è‡ªå®šä¹‰User-Agent
- [ ] å¤æ‚çš„Acceptå¤´éƒ¨
- [ ] è‡ªå®šä¹‰çš„comfy-userç­‰å¤´éƒ¨
- [ ] æ‰‹åŠ¨è®¾ç½®mode: 'cors'
- [ ] æ‰‹åŠ¨è®¾ç½®credentials: 'omit'
- [ ] ä¸ºFormDataè®¾ç½®Content-Type
- [ ] æ·»åŠ Cache-Controlå¤´éƒ¨

## è°ƒè¯•æŠ€å·§

### 1. æµè§ˆå™¨å¼€å‘è€…å·¥å…·
- åœ¨Networké¢æ¿æŸ¥çœ‹å®é™…å‘é€çš„è¯·æ±‚å¤´
- æ£€æŸ¥æ˜¯å¦æœ‰OPTIONSé¢„æ£€è¯·æ±‚
- æŸ¥çœ‹å“åº”çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯

### 2. æ§åˆ¶å°æ—¥å¿—
```javascript
// è®°å½•è¯·æ±‚é…ç½®
console.log('å‘é€è¯·æ±‚:', {
  url,
  method: 'POST',
  headers: { 'Content-Type': 'application/json' }
})

// è®°å½•å“åº”çŠ¶æ€
console.log('å“åº”çŠ¶æ€:', response.status, response.statusText)
```

### 3. é”™è¯¯å¤„ç†
```javascript
try {
  const response = await fetch(url, config)
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}: ${response.statusText}`)
  }
} catch (error) {
  if (error.name === 'AbortError') {
    console.log('è¯·æ±‚è¶…æ—¶')
  } else if (error.message.includes('CORS')) {
    console.log('CORSé”™è¯¯ï¼Œæ£€æŸ¥è¯·æ±‚å¤´é…ç½®')
  } else {
    console.log('ç½‘ç»œé”™è¯¯:', error.message)
  }
}
```

## å›¢é˜Ÿåä½œè§„èŒƒ

### 1. ä»£ç å®¡æŸ¥è¦ç‚¹
- æ£€æŸ¥æ–°çš„fetchè¯·æ±‚æ˜¯å¦éµå¾ªç®€åŒ–åŸåˆ™
- ç¡®è®¤æ²¡æœ‰æ·»åŠ ä¸å¿…è¦çš„è¯·æ±‚å¤´
- éªŒè¯é”™è¯¯å¤„ç†æ˜¯å¦å®Œå–„

### 2. æäº¤è§„èŒƒ
- åœ¨æäº¤ä¿¡æ¯ä¸­è¯´æ˜ç½‘ç»œè¯·æ±‚çš„å˜æ›´
- å¯¹å¤æ‚é…ç½®çš„ä¿®æ”¹éœ€è¦è¯¦ç»†è¯´æ˜åŸå› 

### 3. æ–‡æ¡£æ›´æ–°
- æ–°å¢APIè°ƒç”¨éœ€è¦æ›´æ–°æ­¤æœ€ä½³å®è·µæ–‡æ¡£
- è®°å½•ç‰¹æ®Šæƒ…å†µçš„å¤„ç†æ–¹æ¡ˆ

## æ€»ç»“

éµå¾ªè¿™äº›æœ€ä½³å®è·µå¯ä»¥ç¡®ä¿ï¼š

1. **å¯é æ€§**ï¼šé¿å…CORSå’Œå…¼å®¹æ€§é—®é¢˜
2. **ä¸€è‡´æ€§**ï¼šç»Ÿä¸€çš„é…ç½®é£æ ¼
3. **å¯ç»´æŠ¤æ€§**ï¼šç®€åŒ–çš„é…ç½®æ›´æ˜“è°ƒè¯•
4. **æ€§èƒ½**ï¼šå‡å°‘ä¸å¿…è¦çš„é¢„æ£€è¯·æ±‚

è®°ä½ï¼š**ç®€å•å°±æ˜¯æœ€å¥½çš„**ã€‚åœ¨ç½‘ç»œè¯·æ±‚é…ç½®ä¸­ï¼Œå°‘å³æ˜¯å¤šã€‚
