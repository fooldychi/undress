# 简化请求配置最佳实践

## 核心原则

### 🎯 最小化原则
只使用绝对必要的配置，避免添加可能导致CORS问题的额外设置。

### 🔄 一致性原则
整个项目使用统一的简化配置模式，便于维护和调试。

### 🛡️ 兼容性原则
确保配置与各种服务器环境兼容，避免特定环境下的问题。

## 标准配置模板

### 1. GET请求模板

```javascript
// ✅ 推荐：最简化GET请求
const response = await fetch(url, {
  method: 'GET',
  signal: AbortSignal.timeout(10000) // 可选：超时控制
})

// ❌ 避免：复杂的GET请求
const response = await fetch(url, {
  method: 'GET',
  headers: {
    'Accept': 'application/json',
    'User-Agent': 'Custom-Agent',
    'Cache-Control': 'no-cache'
  },
  mode: 'cors',
  credentials: 'omit'
})
```

### 2. POST JSON请求模板

```javascript
// ✅ 推荐：简化的JSON POST请求
const response = await fetch(url, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(data)
})

// ❌ 避免：复杂的JSON POST请求
const response = await fetch(url, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Accept': 'application/json',
    'User-Agent': 'Custom-Agent',
    'comfy-user': 'client-id'
  },
  body: JSON.stringify(data),
  mode: 'cors',
  credentials: 'omit'
})
```

### 3. POST FormData请求模板

```javascript
// ✅ 推荐：简化的FormData POST请求
const response = await fetch(url, {
  method: 'POST',
  body: formData
  // FormData会自动设置正确的Content-Type
})

// ❌ 避免：手动设置FormData头部
const response = await fetch(url, {
  method: 'POST',
  headers: {
    'Content-Type': 'multipart/form-data', // 错误！会破坏boundary
    'Accept': '*/*'
  },
  body: formData
})
```

### 4. 带超时的请求模板

```javascript
// ✅ 推荐：使用AbortSignal控制超时
const controller = new AbortController()
const timeoutId = setTimeout(() => controller.abort(), 10000)

try {
  const response = await fetch(url, {
    method: 'GET',
    signal: controller.signal
  })
  clearTimeout(timeoutId)
  // 处理响应
} catch (error) {
  clearTimeout(timeoutId)
  if (error.name === 'AbortError') {
    console.log('请求超时')
  }
}

// ✅ 推荐：使用AbortSignal.timeout (现代浏览器)
const response = await fetch(url, {
  method: 'GET',
  signal: AbortSignal.timeout(10000)
})
```

## 常见错误和解决方案

### 1. CORS预检请求问题

**问题**：添加自定义头部触发OPTIONS预检请求
```javascript
// ❌ 会触发预检请求
headers: {
  'X-Custom-Header': 'value',
  'comfy-user': 'client-id'
}
```

**解决方案**：移除自定义头部
```javascript
// ✅ 避免预检请求
// 不添加自定义头部，或使用简单头部
```

### 2. User-Agent问题

**问题**：复杂的User-Agent可能被服务器拒绝
```javascript
// ❌ 复杂的User-Agent
headers: {
  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36...'
}
```

**解决方案**：使用浏览器默认User-Agent
```javascript
// ✅ 使用浏览器默认
// 不设置User-Agent头部
```

### 3. Content-Type错误

**问题**：为FormData手动设置Content-Type
```javascript
// ❌ 破坏FormData的boundary
headers: {
  'Content-Type': 'multipart/form-data'
}
```

**解决方案**：让浏览器自动设置
```javascript
// ✅ 浏览器自动设置正确的Content-Type和boundary
// 不为FormData设置Content-Type
```

### 4. 过度配置问题

**问题**：设置不必要的mode和credentials
```javascript
// ❌ 不必要的配置
mode: 'cors',
credentials: 'omit',
cache: 'no-cache'
```

**解决方案**：使用浏览器默认值
```javascript
// ✅ 使用浏览器默认行为
// 不设置mode、credentials等
```

## 项目中的应用示例

### 1. ComfyUI API调用

```javascript
// 上传图片
const response = await fetch(`${apiBaseUrl}/api/upload/image`, {
  method: 'POST',
  body: formData
})

// 提交工作流
const response = await fetch(`${apiBaseUrl}/api/prompt`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
})

// 查询状态
const response = await fetch(`${apiBaseUrl}/api/history/${promptId}`)

// 获取图片
const response = await fetch(`${apiBaseUrl}/api/view?${params}`)
```

### 2. 健康检查

```javascript
// 简化的健康检查
const response = await fetch(`${serverUrl}/api/queue`, {
  method: 'GET',
  signal: AbortSignal.timeout(10000)
})
```

### 3. 基础连接测试

```javascript
// HEAD请求测试
const response = await fetch(url, {
  method: 'HEAD',
  signal: controller.signal
})

// GET请求测试
const response = await fetch(url, {
  method: 'GET',
  signal: controller.signal
})
```

## 配置检查清单

### ✅ 推荐的配置
- [ ] 只设置必要的请求头
- [ ] JSON请求只设置`Content-Type: application/json`
- [ ] FormData请求不设置Content-Type
- [ ] 使用AbortSignal控制超时
- [ ] 使用浏览器默认的mode和credentials

### ❌ 避免的配置
- [ ] 自定义User-Agent
- [ ] 复杂的Accept头部
- [ ] 自定义的comfy-user等头部
- [ ] 手动设置mode: 'cors'
- [ ] 手动设置credentials: 'omit'
- [ ] 为FormData设置Content-Type
- [ ] 添加Cache-Control头部

## 调试技巧

### 1. 浏览器开发者工具
- 在Network面板查看实际发送的请求头
- 检查是否有OPTIONS预检请求
- 查看响应状态和错误信息

### 2. 控制台日志
```javascript
// 记录请求配置
console.log('发送请求:', {
  url,
  method: 'POST',
  headers: { 'Content-Type': 'application/json' }
})

// 记录响应状态
console.log('响应状态:', response.status, response.statusText)
```

### 3. 错误处理
```javascript
try {
  const response = await fetch(url, config)
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}: ${response.statusText}`)
  }
} catch (error) {
  if (error.name === 'AbortError') {
    console.log('请求超时')
  } else if (error.message.includes('CORS')) {
    console.log('CORS错误，检查请求头配置')
  } else {
    console.log('网络错误:', error.message)
  }
}
```

## 团队协作规范

### 1. 代码审查要点
- 检查新的fetch请求是否遵循简化原则
- 确认没有添加不必要的请求头
- 验证错误处理是否完善

### 2. 提交规范
- 在提交信息中说明网络请求的变更
- 对复杂配置的修改需要详细说明原因

### 3. 文档更新
- 新增API调用需要更新此最佳实践文档
- 记录特殊情况的处理方案

## 总结

遵循这些最佳实践可以确保：

1. **可靠性**：避免CORS和兼容性问题
2. **一致性**：统一的配置风格
3. **可维护性**：简化的配置更易调试
4. **性能**：减少不必要的预检请求

记住：**简单就是最好的**。在网络请求配置中，少即是多。
