# APIç«¯ç‚¹ä¿®å¤æ€»ç»“

## é—®é¢˜æè¿°

ç”¨æˆ·å‘ç°ç³»ç»Ÿä½¿ç”¨äº†é”™è¯¯çš„ComfyUI APIç«¯ç‚¹æ ¼å¼ï¼š
- **é”™è¯¯æ ¼å¼**: `https://drzyuzol28-8188.cnb.run/prompt`
- **æ­£ç¡®æ ¼å¼**: `https://drzyuzol28-8188.cnb.run/api/prompt`

æ‰€æœ‰ComfyUI APIç«¯ç‚¹éƒ½åº”è¯¥åŒ…å« `/api` å‰ç¼€ã€‚

## ä¿®å¤èŒƒå›´

### 1. ä¸»è¦APIç«¯ç‚¹
- âŒ `/prompt` â†’ âœ… `/api/prompt` (å·¥ä½œæµæäº¤)
- âŒ `/upload/image` â†’ âœ… `/api/upload/image` (å›¾ç‰‡ä¸Šä¼ )
- âŒ `/history/{promptId}` â†’ âœ… `/api/history/{promptId}` (ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢)
- âŒ `/view` â†’ âœ… `/api/view` (å›¾ç‰‡è·å–)

### 2. å¥åº·æ£€æŸ¥ç«¯ç‚¹
- âŒ `/queue` â†’ âœ… `/api/queue` (é˜Ÿåˆ—çŠ¶æ€)
- âŒ `/system_stats` â†’ âœ… `/api/system_stats` (ç³»ç»ŸçŠ¶æ€)

## ä¿®å¤çš„æ–‡ä»¶

### 1. client/src/services/comfyui.js
**ä¿®å¤å†…å®¹**ï¼š
- `uploadImageToComfyUI()` å‡½æ•°ä¸­çš„ä¸Šä¼ ç«¯ç‚¹
- `submitWorkflow()` å‡½æ•°ä¸­çš„å·¥ä½œæµæäº¤ç«¯ç‚¹
- `checkTaskStatus()` å‡½æ•°ä¸­çš„ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢ç«¯ç‚¹
- `getGeneratedImage()` å‡½æ•°ä¸­çš„å›¾ç‰‡è·å–ç«¯ç‚¹

**å…·ä½“ä¿®æ”¹**ï¼š
```javascript
// ä¿®æ”¹å‰
fetch(`${apiBaseUrl}/upload/image`)
fetch(`${apiBaseUrl}/prompt`)
fetch(`${apiBaseUrl}/history/${promptId}`)
const imageUrl = `${apiBaseUrl}/view?${params.toString()}`

// ä¿®æ”¹å
fetch(`${apiBaseUrl}/api/upload/image`)
fetch(`${apiBaseUrl}/api/prompt`)
fetch(`${apiBaseUrl}/api/history/${promptId}`)
const imageUrl = `${apiBaseUrl}/api/view?${params.toString()}`
```

### 2. client/src/config/comfyui.config.js
**ä¿®å¤å†…å®¹**ï¼š
- å¥åº·æ£€æŸ¥ç«¯ç‚¹é…ç½®

**å…·ä½“ä¿®æ”¹**ï¼š
```javascript
// ä¿®æ”¹å‰
ENDPOINTS: [
  '/queue',        // é˜Ÿåˆ—çŠ¶æ€ç«¯ç‚¹
  '/system_stats', // ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹
],

// ä¿®æ”¹å
ENDPOINTS: [
  '/api/queue',        // é˜Ÿåˆ—çŠ¶æ€ç«¯ç‚¹
  '/api/system_stats', // ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹
],
```

### 3. client/deploy/imagic_production/proxy-server.js
**ä¿®å¤å†…å®¹**ï¼š
- ä»£ç†æœåŠ¡å™¨ä¸­çš„ç«¯ç‚¹è½¬å‘
- è·¯å¾„é‡å†™è§„åˆ™

**å…·ä½“ä¿®æ”¹**ï¼š
```javascript
// ä¿®æ”¹å‰
fetch(`${COMFYUI_BASE_URL}/upload/image`)
fetch(`${COMFYUI_BASE_URL}/prompt`)
pathRewrite: { '^/api': '' }

// ä¿®æ”¹å
fetch(`${COMFYUI_BASE_URL}/api/upload/image`)
fetch(`${COMFYUI_BASE_URL}/api/prompt`)
pathRewrite: { '^/api': '/api' }
```

## å½±å“çš„åŠŸèƒ½

### âœ… å·²ä¿®å¤çš„åŠŸèƒ½
1. **å›¾ç‰‡ä¸Šä¼ ** - ä½¿ç”¨æ­£ç¡®çš„ `/api/upload/image` ç«¯ç‚¹
2. **å·¥ä½œæµæäº¤** - ä½¿ç”¨æ­£ç¡®çš„ `/api/prompt` ç«¯ç‚¹
3. **ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢** - ä½¿ç”¨æ­£ç¡®çš„ `/api/history/{promptId}` ç«¯ç‚¹
4. **å›¾ç‰‡è·å–** - ä½¿ç”¨æ­£ç¡®çš„ `/api/view` ç«¯ç‚¹
5. **å¥åº·æ£€æŸ¥** - ä½¿ç”¨æ­£ç¡®çš„ `/api/queue` å’Œ `/api/system_stats` ç«¯ç‚¹
6. **è´Ÿè½½å‡è¡¡** - æ‰€æœ‰ç«¯ç‚¹éƒ½é€šè¿‡è´Ÿè½½å‡è¡¡å™¨ä½¿ç”¨æ­£ç¡®æ ¼å¼

### ğŸ”„ å®Œæ•´çš„ç”Ÿå›¾æµç¨‹
ç°åœ¨æ•´ä¸ªç”Ÿå›¾æµç¨‹éƒ½ä½¿ç”¨æ­£ç¡®çš„APIç«¯ç‚¹ï¼š
```
1. ä¸Šä¼ å›¾ç‰‡: POST /api/upload/image
2. æäº¤å·¥ä½œæµ: POST /api/prompt  
3. æŸ¥è¯¢çŠ¶æ€: GET /api/history/{promptId}
4. è·å–ç»“æœ: GET /api/view?filename=xxx
```

## éªŒè¯æ–¹æ³•

### 1. ä½¿ç”¨æµ‹è¯•é¡µé¢
æ‰“å¼€ `test-api-endpoints.html` è¿›è¡ŒéªŒè¯ï¼š
- æµ‹è¯•ç«¯ç‚¹ç”Ÿæˆæ˜¯å¦æ­£ç¡®
- éªŒè¯å¥åº·æ£€æŸ¥ç«¯ç‚¹æ ¼å¼
- æ¨¡æ‹ŸAPIè°ƒç”¨URLæ„å»º

### 2. æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥
å‘èµ·ç”Ÿå›¾è¯·æ±‚æ—¶ï¼Œåœ¨æ§åˆ¶å°æŸ¥çœ‹æ—¥å¿—ï¼š
```
ğŸ”„ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ°ComfyUIæœåŠ¡å™¨
ğŸ“¡ APIåœ°å€: https://xxx.cnb.run/api/upload/image

ğŸ”„ ç¬¬äºŒæ­¥ï¼šæäº¤å·¥ä½œæµåˆ°ComfyUI
ğŸ“¡ APIåœ°å€: https://xxx.cnb.run/api/prompt

ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€: https://xxx.cnb.run/api/history/xxx
ğŸŒ è·å–å›¾ç‰‡URL: https://xxx.cnb.run/api/view?filename=xxx
```

### 3. ç½‘ç»œé¢æ¿æ£€æŸ¥
åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„Networké¢æ¿ä¸­ï¼Œç¡®è®¤æ‰€æœ‰è¯·æ±‚éƒ½ä½¿ç”¨äº†æ­£ç¡®çš„ç«¯ç‚¹æ ¼å¼ã€‚

## æ³¨æ„äº‹é¡¹

### 1. WebSocketè¿æ¥
WebSocketè¿æ¥ä½¿ç”¨ `/ws` ç«¯ç‚¹ï¼Œé€šå¸¸ä¸éœ€è¦ `/api` å‰ç¼€ï¼š
```javascript
// WebSocketè¿æ¥ä¿æŒä¸å˜
wss://server.com/ws?clientId=xxx
```

### 2. ä»£ç†æœåŠ¡å™¨é…ç½®
å¦‚æœä½¿ç”¨ä»£ç†æœåŠ¡å™¨ï¼Œç¡®ä¿è·¯å¾„é‡å†™è§„åˆ™æ­£ç¡®ï¼š
```javascript
// æ­£ç¡®çš„é…ç½®
pathRewrite: { '^/api': '/api' }
// è€Œä¸æ˜¯
pathRewrite: { '^/api': '' }
```

### 3. ç¯å¢ƒä¸€è‡´æ€§
ç¡®ä¿å¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒéƒ½ä½¿ç”¨ç›¸åŒçš„ç«¯ç‚¹æ ¼å¼ã€‚

## åç»­å»ºè®®

### 1. ç«¯ç‚¹é…ç½®ç»Ÿä¸€åŒ–
è€ƒè™‘å°†æ‰€æœ‰APIç«¯ç‚¹é…ç½®é›†ä¸­åˆ°ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­ï¼Œé¿å…ç¡¬ç¼–ç ã€‚

### 2. è‡ªåŠ¨åŒ–æµ‹è¯•
æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•æ¥éªŒè¯APIç«¯ç‚¹æ ¼å¼çš„æ­£ç¡®æ€§ã€‚

### 3. æ–‡æ¡£æ›´æ–°
æ›´æ–°ç›¸å…³æ–‡æ¡£ï¼Œç¡®ä¿æ–°çš„å¼€å‘è€…äº†è§£æ­£ç¡®çš„ç«¯ç‚¹æ ¼å¼ã€‚

## æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼Œæ‰€æœ‰ComfyUI APIè°ƒç”¨éƒ½ä½¿ç”¨äº†æ­£ç¡®çš„ç«¯ç‚¹æ ¼å¼ï¼ŒåŒ…å«å¿…è¦çš„ `/api` å‰ç¼€ã€‚è¿™ç¡®ä¿äº†ï¼š

1. **å…¼å®¹æ€§** - ä¸ComfyUIæœåŠ¡å™¨çš„APIè§„èŒƒä¿æŒä¸€è‡´
2. **å¯é æ€§** - é¿å…å› ç«¯ç‚¹é”™è¯¯å¯¼è‡´çš„è¯·æ±‚å¤±è´¥
3. **ä¸€è‡´æ€§** - æ•´ä¸ªç³»ç»Ÿä½¿ç”¨ç»Ÿä¸€çš„ç«¯ç‚¹æ ¼å¼
4. **å¯ç»´æŠ¤æ€§** - ä¾¿äºåç»­çš„ç»´æŠ¤å’Œæ‰©å±•

ä¿®å¤åçš„ç³»ç»Ÿç°åœ¨èƒ½å¤Ÿæ­£ç¡®åœ°ä¸ComfyUIæœåŠ¡å™¨é€šä¿¡ï¼Œç¡®ä¿ç”Ÿå›¾åŠŸèƒ½çš„æ­£å¸¸è¿è¡Œã€‚
