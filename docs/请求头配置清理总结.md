# 请求头配置清理总结

## 清理目标

确保整个项目只使用简化的请求配置，删除过多的自定义请求头，以免后续又被使用，避免CORS问题。

## 清理原则

1. **最小化原则**：只保留必要的请求头
2. **一致性原则**：所有请求使用相同的简化配置
3. **兼容性原则**：避免触发CORS预检请求
4. **可维护性原则**：防止复杂配置重新引入

## 清理的文件和内容

### 1. client/src/config/comfyui.config.js

**清理前**：
```javascript
HEADERS: {
  'Accept': 'application/json'
},
```

**清理后**：
```javascript
HEADERS: {},
```

**说明**：完全移除所有默认请求头，让每个请求自行决定最小必要的头部。

### 2. client/src/services/loadBalancer.js

#### 2.1 基础连接测试
**清理前**：
```javascript
const response = await fetch(cleanUrl, {
  method: 'HEAD',
  signal: controller.signal,
  headers: {
    'Accept': '*/*',
    'Cache-Control': 'no-cache',
    'User-Agent': 'Mozilla/5.0...'
  },
  mode: 'cors',
  credentials: 'omit'
})
```

**清理后**：
```javascript
const response = await fetch(cleanUrl, {
  method: 'HEAD',
  signal: controller.signal
})
```

#### 2.2 GET连接测试
**清理前**：
```javascript
const response = await fetch(cleanUrl, {
  method: 'GET',
  signal: controller.signal,
  headers: comfyUIConfig.HEALTH_CHECK.HEADERS,
  mode: 'cors',
  credentials: 'omit'
})
```

**清理后**：
```javascript
const response = await fetch(cleanUrl, {
  method: 'GET',
  signal: controller.signal
})
```

#### 2.3 ComfyUI端点测试
**清理前**：
```javascript
const response = await fetch(fullUrl, {
  method: 'GET',
  signal: controller.signal,
  headers: comfyUIConfig.HEALTH_CHECK.HEADERS,
  mode: 'cors',
  credentials: 'omit',
  cache: 'no-cache'
})
```

**清理后**：
```javascript
const response = await fetch(fullUrl, {
  method: 'GET',
  signal: controller.signal
})
```

#### 2.4 简化端点测试
**清理前**：
```javascript
await fetch(url, {
  method: 'GET',
  signal: controller.signal,
  mode: 'no-cors',
  cache: 'no-cache'
})
```

**清理后**：
```javascript
await fetch(url, {
  method: 'GET',
  signal: controller.signal
})
```

### 3. client/src/services/comfyui.js

#### 3.1 WebSocket初始化中的HTTP测试
**清理前**：
```javascript
const testResponse = await fetch(`${baseUrl}${endpoint}`, {
  method: 'GET',
  headers: comfyUIConfig.HEALTH_CHECK.HEADERS,
  signal: AbortSignal.timeout(comfyUIConfig.HEALTH_CHECK.TIMEOUT / 2)
})
```

**清理后**：
```javascript
const testResponse = await fetch(`${baseUrl}${endpoint}`, {
  method: 'GET',
  signal: AbortSignal.timeout(comfyUIConfig.HEALTH_CHECK.TIMEOUT / 2)
})
```

#### 3.2 服务器状态检查
**清理前**：
```javascript
const response = await fetch(`${apiBaseUrl}${endpoint}`, {
  method: 'GET',
  headers: comfyUIConfig.HEALTH_CHECK.HEADERS,
  signal: AbortSignal.timeout(comfyUIConfig.HEALTH_CHECK.TIMEOUT)
})
```

**清理后**：
```javascript
const response = await fetch(`${apiBaseUrl}${endpoint}`, {
  method: 'GET',
  signal: AbortSignal.timeout(comfyUIConfig.HEALTH_CHECK.TIMEOUT)
})
```

### 4. client/deploy/imagic_production/proxy-server.js

#### 4.1 图片上传请求
**清理前**：
```javascript
const response = await fetch(`${COMFYUI_BASE_URL}/api/upload/image`, {
  method: 'POST',
  body: formData,
  headers: formData.getHeaders(),
  timeout: 30000,
  agent: false
});
```

**清理后**：
```javascript
const response = await fetch(`${COMFYUI_BASE_URL}/api/upload/image`, {
  method: 'POST',
  body: formData,
  headers: formData.getHeaders(),
  timeout: 30000
});
```

### 5. 删除的测试文件

- **test-comfyui-cors.js**：包含复杂CORS测试配置的文件已删除

## 保留的必要配置

### 1. JSON请求的Content-Type
```javascript
// 仍然保留，因为这是JSON请求的必要头部
headers: {
  'Content-Type': 'application/json'
}
```

### 2. FormData的自动头部
```javascript
// 仍然保留，因为FormData需要正确的boundary
headers: formData.getHeaders()
```

### 3. 超时配置
```javascript
// 仍然保留，因为这是性能和用户体验的必要配置
signal: AbortSignal.timeout(timeout)
timeout: 30000
```

## 清理效果

### ✅ 避免的问题
1. **CORS预检请求**：移除自定义头部避免OPTIONS请求
2. **服务器兼容性**：简化配置提高服务器兼容性
3. **请求失败**：减少因复杂配置导致的请求失败
4. **维护复杂性**：统一简化的配置更易维护

### 📊 清理统计
- **清理的文件**：4个主要文件
- **移除的复杂头部**：User-Agent, Accept, Cache-Control, comfy-user等
- **移除的CORS设置**：mode, credentials等
- **删除的测试文件**：1个

## 防止回退的措施

### 1. 文档记录
- 详细记录清理原因和效果
- 提供简化配置的最佳实践

### 2. 代码注释
```javascript
// 使用最简化配置避免CORS问题
// 不要添加自定义请求头，如User-Agent、Accept等
const response = await fetch(url, {
  method: 'GET',
  signal: controller.signal
})
```

### 3. 配置模板
提供标准的请求配置模板：

```javascript
// GET请求模板
const response = await fetch(url, {
  method: 'GET',
  signal: AbortSignal.timeout(10000)
})

// POST JSON请求模板
const response = await fetch(url, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(data)
})

// POST FormData请求模板
const response = await fetch(url, {
  method: 'POST',
  body: formData
})
```

## 后续建议

### 1. 代码审查
- 在代码审查中检查是否有复杂请求头配置
- 确保新增的fetch请求遵循简化原则

### 2. 自动化检查
- 考虑添加ESLint规则检查复杂的fetch配置
- 在CI/CD中添加配置检查步骤

### 3. 团队培训
- 向团队成员说明简化配置的重要性
- 提供最佳实践指南

## 总结

通过全面清理复杂的请求头配置，我们确保了：

1. **一致性**：所有请求都使用简化配置
2. **可靠性**：避免CORS问题导致的请求失败
3. **可维护性**：统一的配置更易于维护和调试
4. **兼容性**：提高与不同服务器的兼容性

这次清理为项目建立了简洁、可靠的网络请求基础，避免了复杂配置可能带来的各种问题。
