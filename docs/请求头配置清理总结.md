# è¯·æ±‚å¤´é…ç½®æ¸…ç†æ€»ç»“

## æ¸…ç†ç›®æ ‡

ç¡®ä¿æ•´ä¸ªé¡¹ç›®åªä½¿ç”¨ç®€åŒ–çš„è¯·æ±‚é…ç½®ï¼Œåˆ é™¤è¿‡å¤šçš„è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼Œä»¥å…åç»­åˆè¢«ä½¿ç”¨ï¼Œé¿å…CORSé—®é¢˜ã€‚

## æ¸…ç†åŸåˆ™

1. **æœ€å°åŒ–åŸåˆ™**ï¼šåªä¿ç•™å¿…è¦çš„è¯·æ±‚å¤´
2. **ä¸€è‡´æ€§åŸåˆ™**ï¼šæ‰€æœ‰è¯·æ±‚ä½¿ç”¨ç›¸åŒçš„ç®€åŒ–é…ç½®
3. **å…¼å®¹æ€§åŸåˆ™**ï¼šé¿å…è§¦å‘CORSé¢„æ£€è¯·æ±‚
4. **å¯ç»´æŠ¤æ€§åŸåˆ™**ï¼šé˜²æ­¢å¤æ‚é…ç½®é‡æ–°å¼•å…¥

## æ¸…ç†çš„æ–‡ä»¶å’Œå†…å®¹

### 1. client/src/config/comfyui.config.js

**æ¸…ç†å‰**ï¼š
```javascript
HEADERS: {
  'Accept': 'application/json'
},
```

**æ¸…ç†å**ï¼š
```javascript
HEADERS: {},
```

**è¯´æ˜**ï¼šå®Œå…¨ç§»é™¤æ‰€æœ‰é»˜è®¤è¯·æ±‚å¤´ï¼Œè®©æ¯ä¸ªè¯·æ±‚è‡ªè¡Œå†³å®šæœ€å°å¿…è¦çš„å¤´éƒ¨ã€‚

### 2. client/src/services/loadBalancer.js

#### 2.1 åŸºç¡€è¿æ¥æµ‹è¯•
**æ¸…ç†å‰**ï¼š
```javascript
const response = await fetch(cleanUrl, {
  method: 'HEAD',
  signal: controller.signal,
  headers: {
    'Accept': '*/*',
    'Cache-Control': 'no-cache',
    'User-Agent': 'Mozilla/5.0...'
  },
  mode: 'cors',
  credentials: 'omit'
})
```

**æ¸…ç†å**ï¼š
```javascript
const response = await fetch(cleanUrl, {
  method: 'HEAD',
  signal: controller.signal
})
```

#### 2.2 GETè¿æ¥æµ‹è¯•
**æ¸…ç†å‰**ï¼š
```javascript
const response = await fetch(cleanUrl, {
  method: 'GET',
  signal: controller.signal,
  headers: comfyUIConfig.HEALTH_CHECK.HEADERS,
  mode: 'cors',
  credentials: 'omit'
})
```

**æ¸…ç†å**ï¼š
```javascript
const response = await fetch(cleanUrl, {
  method: 'GET',
  signal: controller.signal
})
```

#### 2.3 ComfyUIç«¯ç‚¹æµ‹è¯•
**æ¸…ç†å‰**ï¼š
```javascript
const response = await fetch(fullUrl, {
  method: 'GET',
  signal: controller.signal,
  headers: comfyUIConfig.HEALTH_CHECK.HEADERS,
  mode: 'cors',
  credentials: 'omit',
  cache: 'no-cache'
})
```

**æ¸…ç†å**ï¼š
```javascript
const response = await fetch(fullUrl, {
  method: 'GET',
  signal: controller.signal
})
```

#### 2.4 ç®€åŒ–ç«¯ç‚¹æµ‹è¯•
**æ¸…ç†å‰**ï¼š
```javascript
await fetch(url, {
  method: 'GET',
  signal: controller.signal,
  mode: 'no-cors',
  cache: 'no-cache'
})
```

**æ¸…ç†å**ï¼š
```javascript
await fetch(url, {
  method: 'GET',
  signal: controller.signal
})
```

### 3. client/src/services/comfyui.js

#### 3.1 WebSocketåˆå§‹åŒ–ä¸­çš„HTTPæµ‹è¯•
**æ¸…ç†å‰**ï¼š
```javascript
const testResponse = await fetch(`${baseUrl}${endpoint}`, {
  method: 'GET',
  headers: comfyUIConfig.HEALTH_CHECK.HEADERS,
  signal: AbortSignal.timeout(comfyUIConfig.HEALTH_CHECK.TIMEOUT / 2)
})
```

**æ¸…ç†å**ï¼š
```javascript
const testResponse = await fetch(`${baseUrl}${endpoint}`, {
  method: 'GET',
  signal: AbortSignal.timeout(comfyUIConfig.HEALTH_CHECK.TIMEOUT / 2)
})
```

#### 3.2 æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥
**æ¸…ç†å‰**ï¼š
```javascript
const response = await fetch(`${apiBaseUrl}${endpoint}`, {
  method: 'GET',
  headers: comfyUIConfig.HEALTH_CHECK.HEADERS,
  signal: AbortSignal.timeout(comfyUIConfig.HEALTH_CHECK.TIMEOUT)
})
```

**æ¸…ç†å**ï¼š
```javascript
const response = await fetch(`${apiBaseUrl}${endpoint}`, {
  method: 'GET',
  signal: AbortSignal.timeout(comfyUIConfig.HEALTH_CHECK.TIMEOUT)
})
```

### 4. client/deploy/imagic_production/proxy-server.js

#### 4.1 å›¾ç‰‡ä¸Šä¼ è¯·æ±‚
**æ¸…ç†å‰**ï¼š
```javascript
const response = await fetch(`${COMFYUI_BASE_URL}/api/upload/image`, {
  method: 'POST',
  body: formData,
  headers: formData.getHeaders(),
  timeout: 30000,
  agent: false
});
```

**æ¸…ç†å**ï¼š
```javascript
const response = await fetch(`${COMFYUI_BASE_URL}/api/upload/image`, {
  method: 'POST',
  body: formData,
  headers: formData.getHeaders(),
  timeout: 30000
});
```

### 5. åˆ é™¤çš„æµ‹è¯•æ–‡ä»¶

- **test-comfyui-cors.js**ï¼šåŒ…å«å¤æ‚CORSæµ‹è¯•é…ç½®çš„æ–‡ä»¶å·²åˆ é™¤

## ä¿ç•™çš„å¿…è¦é…ç½®

### 1. JSONè¯·æ±‚çš„Content-Type
```javascript
// ä»ç„¶ä¿ç•™ï¼Œå› ä¸ºè¿™æ˜¯JSONè¯·æ±‚çš„å¿…è¦å¤´éƒ¨
headers: {
  'Content-Type': 'application/json'
}
```

### 2. FormDataçš„è‡ªåŠ¨å¤´éƒ¨
```javascript
// ä»ç„¶ä¿ç•™ï¼Œå› ä¸ºFormDataéœ€è¦æ­£ç¡®çš„boundary
headers: formData.getHeaders()
```

### 3. è¶…æ—¶é…ç½®
```javascript
// ä»ç„¶ä¿ç•™ï¼Œå› ä¸ºè¿™æ˜¯æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒçš„å¿…è¦é…ç½®
signal: AbortSignal.timeout(timeout)
timeout: 30000
```

## æ¸…ç†æ•ˆæœ

### âœ… é¿å…çš„é—®é¢˜
1. **CORSé¢„æ£€è¯·æ±‚**ï¼šç§»é™¤è‡ªå®šä¹‰å¤´éƒ¨é¿å…OPTIONSè¯·æ±‚
2. **æœåŠ¡å™¨å…¼å®¹æ€§**ï¼šç®€åŒ–é…ç½®æé«˜æœåŠ¡å™¨å…¼å®¹æ€§
3. **è¯·æ±‚å¤±è´¥**ï¼šå‡å°‘å› å¤æ‚é…ç½®å¯¼è‡´çš„è¯·æ±‚å¤±è´¥
4. **ç»´æŠ¤å¤æ‚æ€§**ï¼šç»Ÿä¸€ç®€åŒ–çš„é…ç½®æ›´æ˜“ç»´æŠ¤

### ğŸ“Š æ¸…ç†ç»Ÿè®¡
- **æ¸…ç†çš„æ–‡ä»¶**ï¼š4ä¸ªä¸»è¦æ–‡ä»¶
- **ç§»é™¤çš„å¤æ‚å¤´éƒ¨**ï¼šUser-Agent, Accept, Cache-Control, comfy-userç­‰
- **ç§»é™¤çš„CORSè®¾ç½®**ï¼šmode, credentialsç­‰
- **åˆ é™¤çš„æµ‹è¯•æ–‡ä»¶**ï¼š1ä¸ª

## é˜²æ­¢å›é€€çš„æªæ–½

### 1. æ–‡æ¡£è®°å½•
- è¯¦ç»†è®°å½•æ¸…ç†åŸå› å’Œæ•ˆæœ
- æä¾›ç®€åŒ–é…ç½®çš„æœ€ä½³å®è·µ

### 2. ä»£ç æ³¨é‡Š
```javascript
// ä½¿ç”¨æœ€ç®€åŒ–é…ç½®é¿å…CORSé—®é¢˜
// ä¸è¦æ·»åŠ è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼Œå¦‚User-Agentã€Acceptç­‰
const response = await fetch(url, {
  method: 'GET',
  signal: controller.signal
})
```

### 3. é…ç½®æ¨¡æ¿
æä¾›æ ‡å‡†çš„è¯·æ±‚é…ç½®æ¨¡æ¿ï¼š

```javascript
// GETè¯·æ±‚æ¨¡æ¿
const response = await fetch(url, {
  method: 'GET',
  signal: AbortSignal.timeout(10000)
})

// POST JSONè¯·æ±‚æ¨¡æ¿
const response = await fetch(url, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(data)
})

// POST FormDataè¯·æ±‚æ¨¡æ¿
const response = await fetch(url, {
  method: 'POST',
  body: formData
})
```

## åç»­å»ºè®®

### 1. ä»£ç å®¡æŸ¥
- åœ¨ä»£ç å®¡æŸ¥ä¸­æ£€æŸ¥æ˜¯å¦æœ‰å¤æ‚è¯·æ±‚å¤´é…ç½®
- ç¡®ä¿æ–°å¢çš„fetchè¯·æ±‚éµå¾ªç®€åŒ–åŸåˆ™

### 2. è‡ªåŠ¨åŒ–æ£€æŸ¥
- è€ƒè™‘æ·»åŠ ESLintè§„åˆ™æ£€æŸ¥å¤æ‚çš„fetché…ç½®
- åœ¨CI/CDä¸­æ·»åŠ é…ç½®æ£€æŸ¥æ­¥éª¤

### 3. å›¢é˜ŸåŸ¹è®­
- å‘å›¢é˜Ÿæˆå‘˜è¯´æ˜ç®€åŒ–é…ç½®çš„é‡è¦æ€§
- æä¾›æœ€ä½³å®è·µæŒ‡å—

## æ€»ç»“

é€šè¿‡å…¨é¢æ¸…ç†å¤æ‚çš„è¯·æ±‚å¤´é…ç½®ï¼Œæˆ‘ä»¬ç¡®ä¿äº†ï¼š

1. **ä¸€è‡´æ€§**ï¼šæ‰€æœ‰è¯·æ±‚éƒ½ä½¿ç”¨ç®€åŒ–é…ç½®
2. **å¯é æ€§**ï¼šé¿å…CORSé—®é¢˜å¯¼è‡´çš„è¯·æ±‚å¤±è´¥
3. **å¯ç»´æŠ¤æ€§**ï¼šç»Ÿä¸€çš„é…ç½®æ›´æ˜“äºç»´æŠ¤å’Œè°ƒè¯•
4. **å…¼å®¹æ€§**ï¼šæé«˜ä¸ä¸åŒæœåŠ¡å™¨çš„å…¼å®¹æ€§

è¿™æ¬¡æ¸…ç†ä¸ºé¡¹ç›®å»ºç«‹äº†ç®€æ´ã€å¯é çš„ç½‘ç»œè¯·æ±‚åŸºç¡€ï¼Œé¿å…äº†å¤æ‚é…ç½®å¯èƒ½å¸¦æ¥çš„å„ç§é—®é¢˜ã€‚
