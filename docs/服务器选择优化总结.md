# æœåŠ¡å™¨é€‰æ‹©ä¼˜åŒ–æ€»ç»“

## é—®é¢˜æè¿°

ç”¨æˆ·å‘ç°ç³»ç»Ÿç¼“å­˜äº†ä¸€ä¸ªä¸å¯ç”¨çš„æœåŠ¡å™¨åœ°å€ "https://32rmau2534-8188.cnb.run/"ï¼Œå¹¶ä¸”å¤‡ç”¨æœåŠ¡å™¨åœ°å€æ ¼å¼å¤„ç†ä¸ä¸€è‡´çš„é—®é¢˜ã€‚

**ç”¨æˆ·æä¾›çš„å¯ç”¨æœåŠ¡å™¨**:
- https://l9s75ay3rp-8188.cnb.run/
- https://0rv00xh2vg-8188.cnb.run/

**å‘ç°çš„é—®é¢˜**:
1. ç³»ç»Ÿé…ç½®ä¸­ä½¿ç”¨äº†ä¸å¯ç”¨çš„æœåŠ¡å™¨åœ°å€
2. å¥åº·æ£€æŸ¥é€»è¾‘è¿‡äºä¸¥æ ¼ï¼Œå¯¼è‡´å¯ç”¨æœåŠ¡å™¨è¢«è¯¯åˆ¤ä¸ºä¸å¯ç”¨
3. å¤‡ç”¨æœåŠ¡å™¨åœ°å€æ ¼å¼å¤„ç†ä¸ä¸€è‡´

## è§£å†³æ–¹æ¡ˆ

### 1. æ›´æ–°æœåŠ¡å™¨é…ç½®

**ä¿®æ”¹æ–‡ä»¶**:
- `client/src/config/comfyui.config.js`
- `client/.env.production`
- `server/src/routes/public-config.js`

**æ›´æ–°å†…å®¹**:
```javascript
// ä¸»æœåŠ¡å™¨
BASE_URL: 'https://l9s75ay3rp-8188.cnb.run'

// å¤‡ç”¨æœåŠ¡å™¨
'comfyui.backup_servers': 'https://0rv00xh2vg-8188.cnb.run'
```

### 2. ä¿®å¤å¤‡ç”¨æœåŠ¡å™¨åœ°å€æ ¼å¼é—®é¢˜

**é—®é¢˜**: `comfyui.backup_servers` åœ¨ä¸åŒåœ°æ–¹ä½¿ç”¨ä¸åŒçš„åˆ†éš”ç¬¦
- æ•°æ®åº“ä¸­å­˜å‚¨çš„æ˜¯é€—å·åˆ†éš”çš„åœ°å€åˆ—è¡¨
- å‰ç«¯ä»£ç å°è¯•ç”¨æ¢è¡Œç¬¦åˆ†å‰²

**è§£å†³æ–¹æ¡ˆ**: ä¿®æ”¹ `client/src/services/loadBalancer.js`
```javascript
// å¤‡ç”¨æœåŠ¡å™¨ - æ”¯æŒæ¢è¡Œç¬¦å’Œé€—å·ä¸¤ç§åˆ†éš”æ–¹å¼
if (config['comfyui.backup_servers']) {
  const backupServers = config['comfyui.backup_servers']
    .replace(/\s*,\s*/g, '\n') // å°†é€—å·æ›¿æ¢ä¸ºæ¢è¡Œç¬¦
    .split('\n')
    .map(url => url.trim())
    .filter(url => url && url.startsWith('http'))
}
```

### 3. æ”¹è¿›å¥åº·æ£€æŸ¥é€»è¾‘

**é—®é¢˜**: åŸæ¥çš„å¥åº·æ£€æŸ¥åªä½¿ç”¨ `/system_stats` ç«¯ç‚¹ï¼Œå¯èƒ½å¯¼è‡´è¯¯åˆ¤

**è§£å†³æ–¹æ¡ˆ**: ä¿®æ”¹ `checkServerHealth` æ–¹æ³•ï¼Œå°è¯•å¤šä¸ªç«¯ç‚¹
```javascript
const testEndpoints = [
  '/queue',        // ComfyUI é˜Ÿåˆ—ç«¯ç‚¹ï¼Œæœ€å¸¸ç”¨
  '/system_stats', // ComfyUI ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹
  '/history',      // ComfyUI å†å²è®°å½•ç«¯ç‚¹
  '/'              // æ ¹è·¯å¾„ï¼Œæœ€åå°è¯•
]
```

**æ”¹è¿›ç‚¹**:
- æŒ‰ä¼˜å…ˆçº§æµ‹è¯•å¤šä¸ªç«¯ç‚¹
- ä»»ä½•ä¸€ä¸ªç«¯ç‚¹æˆåŠŸå³è®¤ä¸ºæœåŠ¡å™¨å¥åº·
- æ›´è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- æ›´æ™ºèƒ½çš„å¥åº·åˆ¤æ–­é€»è¾‘

### 4. å¢å¼ºæœåŠ¡å™¨é€‰æ‹©åé¦ˆä¿¡æ¯

**æ–°å¢åŠŸèƒ½**: é¡µé¢åŠ è½½æ—¶æä¾›è¯¦ç»†çš„æœåŠ¡å™¨çŠ¶æ€åé¦ˆ

**ä¿®æ”¹æ–‡ä»¶**:
- `client/src/services/loadBalancer.js`
- `client/src/main.js`

**ä¸»è¦æ”¹è¿›**:

1. **è¯¦ç»†çš„æœåŠ¡å™¨æµ‹è¯•æ—¥å¿—**:
   ```javascript
   console.log(`ğŸ“‹ å‘ç° ${servers.length} ä¸ªé…ç½®çš„æœåŠ¡å™¨:`)
   servers.forEach((server, index) => {
     console.log(`   ${index + 1}. ${server.url} (${server.type}, ä¼˜å…ˆçº§: ${server.priority})`)
   })
   ```

2. **å®æ—¶æµ‹è¯•ç»“æœåé¦ˆ**:
   ```javascript
   if (health.healthy) {
     console.log(`âœ… ${server.url} - å¥åº· (å“åº”æ—¶é—´: ${health.responseTime}ms, é˜Ÿåˆ—: ${queue.total || 0})`)
   } else {
     console.log(`âŒ ${server.url} - ä¸å¯ç”¨ (${health.error || 'è¿æ¥å¤±è´¥'})`)
   }
   ```

3. **æœ€ç»ˆé€‰æ‹©ç»“æœè¯¦æƒ…**:
   ```javascript
   console.log(`ğŸ¯ æœ€ç»ˆé€‰æ‹©: ${selectedServer.url}`)
   console.log(`   ç±»å‹: ${selectedServer.type === 'primary' ? 'ä¸»æœåŠ¡å™¨' : 'å¤‡ç”¨æœåŠ¡å™¨'}`)
   console.log(`   é˜Ÿåˆ—æ•°: ${selectedServer.queue.total || 0} (è¿è¡Œä¸­: ${selectedServer.queue.running || 0}, ç­‰å¾…ä¸­: ${selectedServer.queue.pending || 0})`)
   console.log(`   å“åº”æ—¶é—´: ${selectedServer.responseTime}ms`)
   console.log(`   ä¼˜å…ˆçº§: ${selectedServer.priority}`)
   ```

### 3. æ–°å¢é¡µé¢åŠ è½½æ—¶çš„æœåŠ¡å™¨åˆå§‹åŒ–

**æ–°å¢æ–¹æ³•**: `initializeServerConnection()`
- åœ¨é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•æ‰€æœ‰é…ç½®çš„æœåŠ¡å™¨
- æä¾›è¯¦ç»†çš„è¿æ¥æµ‹è¯•åé¦ˆ
- æ¨èæœ€ä¼˜æœåŠ¡å™¨

**é›†æˆåˆ°åº”ç”¨å¯åŠ¨æµç¨‹**:
```javascript
// client/src/main.js
console.log('ğŸ” å¼€å§‹æœåŠ¡å™¨è¿æ¥æµ‹è¯•...')
try {
  await loadBalancer.initializeServerConnection()
} catch (error) {
  console.warn('âš ï¸ æœåŠ¡å™¨è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œå°†åœ¨éœ€è¦æ—¶é‡è¯•:', error.message)
}
```

### 4. å¢å¼ºæœåŠ¡å™¨çŠ¶æ€æŠ¥å‘Š

**æ”¹è¿›çš„çŠ¶æ€æŠ¥å‘Šæ ¼å¼**:
```
ğŸ“Š è¯¦ç»†æœåŠ¡å™¨çŠ¶æ€æŠ¥å‘Š:
   çŠ¶æ€ | ç±»å‹ | æœåŠ¡å™¨URL | é˜Ÿåˆ—(è¿è¡Œ/ç­‰å¾…/æ€»è®¡) | ä¼˜å…ˆçº§ | å“åº”æ—¶é—´ | é”™è¯¯ä¿¡æ¯
   -----|------|-----------|-------------------|--------|----------|----------
   âœ… | ä¸»æœåŠ¡å™¨ | https://server1.com | 0/2/2 | 1 | 150ms |
   âŒ | å¤‡ç”¨ | https://server2.com | N/A | 2 | N/A | Connection failed...
```

### 5. æ›´æ–°é…ç½®æè¿°

**ä¿®æ”¹æ–‡ä»¶**:
- `admin/src/views/Config.vue`
- `server/src/scripts/init-comfyui-config.js`
- `server/scripts/tools/add-backup-servers.js`

**ç»Ÿä¸€æè¿°**: "ComfyUIå¤‡ç”¨æœåŠ¡å™¨åœ°å€åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªæˆ–é€—å·åˆ†éš”ï¼‰"

## ç”¨æˆ·ä½“éªŒæ”¹è¿›

1. **æ¸…æ™°çš„å¯åŠ¨åé¦ˆ**: ç”¨æˆ·å¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ°è¯¦ç»†çš„æœåŠ¡å™¨æµ‹è¯•è¿‡ç¨‹
2. **é€æ˜çš„é€‰æ‹©é€»è¾‘**: æ˜ç¡®æ˜¾ç¤ºä¸ºä»€ä¹ˆé€‰æ‹©æŸä¸ªæœåŠ¡å™¨
3. **é—®é¢˜è¯Šæ–­**: å½“æœåŠ¡å™¨ä¸å¯ç”¨æ—¶ï¼Œæä¾›å…·ä½“çš„é”™è¯¯ä¿¡æ¯
4. **é…ç½®çµæ´»æ€§**: æ”¯æŒå¤šç§å¤‡ç”¨æœåŠ¡å™¨åœ°å€æ ¼å¼

## æµ‹è¯•å·¥å…·

æˆ‘ä»¬åˆ›å»ºäº†å¤šä¸ªæµ‹è¯•å·¥å…·æ¥éªŒè¯ä¿®å¤æ•ˆæœï¼š

1. **quick-test.html**: å¿«é€Ÿæµ‹è¯•æœåŠ¡å™¨è¿æ¥
2. **test-servers.html**: è¯¦ç»†çš„æœåŠ¡å™¨ç«¯ç‚¹æµ‹è¯•
3. **client/test-load-balancer.html**: è´Ÿè½½å‡è¡¡å™¨åŠŸèƒ½æµ‹è¯•
4. **server/scripts/update-server-config.js**: æ•°æ®åº“é…ç½®æ›´æ–°è„šæœ¬

## æµ‹è¯•å»ºè®®

1. è¿è¡Œ `node server/scripts/update-server-config.js` æ›´æ–°æ•°æ®åº“é…ç½®
2. æ‰“å¼€æµ‹è¯•é¡µé¢éªŒè¯æœåŠ¡å™¨è¿æ¥
3. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„æ§åˆ¶å°
4. åˆ·æ–°é¡µé¢è§‚å¯ŸæœåŠ¡å™¨é€‰æ‹©è¿‡ç¨‹
5. æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºäº†è¯¦ç»†çš„æœåŠ¡å™¨æµ‹è¯•ä¿¡æ¯
6. éªŒè¯æœ€ç»ˆé€‰æ‹©çš„æœåŠ¡å™¨æ˜¯å¦ä¸ºå¯ç”¨æœåŠ¡å™¨

## åç»­ä¼˜åŒ–å»ºè®®

1. æ·»åŠ æœåŠ¡å™¨å¥åº·çŠ¶æ€çš„æŒä¹…åŒ–ç¼“å­˜
2. å®ç°æœåŠ¡å™¨æ•…éšœè‡ªåŠ¨åˆ‡æ¢æœºåˆ¶
3. æ·»åŠ æœåŠ¡å™¨æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡
4. æä¾›ç®¡ç†åå°çš„æœåŠ¡å™¨çŠ¶æ€å¯è§†åŒ–ç•Œé¢
