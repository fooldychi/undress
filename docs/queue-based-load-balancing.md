# åŸºäºé˜Ÿåˆ—çš„è´Ÿè½½å‡è¡¡å®ç°

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†åŸºäºComfyUIæœåŠ¡å™¨é˜Ÿåˆ—æ•°é‡çš„æ™ºèƒ½è´Ÿè½½å‡è¡¡æœºåˆ¶ï¼Œä¼˜å…ˆé€‰æ‹©é˜Ÿåˆ—æœ€å°‘çš„å¥åº·æœåŠ¡å™¨ï¼Œç¡®ä¿ä»»åŠ¡åˆ†é…çš„å‡è¡¡æ€§å’Œæ•ˆç‡ã€‚

## ğŸ”§ æ ¸å¿ƒç‰¹æ€§

### 1. é˜Ÿåˆ—ä¿¡æ¯æ”¶é›†
- **å®æ—¶é˜Ÿåˆ—ç›‘æ§** - è·å–æ¯ä¸ªæœåŠ¡å™¨çš„è¿è¡Œé˜Ÿåˆ—å’Œç­‰å¾…é˜Ÿåˆ—æ•°é‡
- **ç³»ç»Ÿä¿¡æ¯æ”¶é›†** - æ”¶é›†ComfyUIç‰ˆæœ¬ã€ç³»ç»Ÿèµ„æºç­‰ä¿¡æ¯
- **å¥åº·çŠ¶æ€è·Ÿè¸ª** - æŒç»­ç›‘æ§æœåŠ¡å™¨å¯ç”¨æ€§

### 2. æ™ºèƒ½è´Ÿè½½å‡è¡¡
- **é˜Ÿåˆ—ä¼˜å…ˆ** - ä»…æ ¹æ®é˜Ÿåˆ—æ•°é‡é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨
- **æœ€å°‘é˜Ÿåˆ—** - å§‹ç»ˆé€‰æ‹©é˜Ÿåˆ—æ•°é‡æœ€å°‘çš„å¥åº·æœåŠ¡å™¨
- **åŠ¨æ€è°ƒæ•´** - æ ¹æ®å®æ—¶é˜Ÿåˆ—çŠ¶å†µè‡ªåŠ¨è°ƒæ•´é€‰æ‹©

### 3. ç®€åŒ–æ—¥å¿—è¾“å‡º
- **é»˜è®¤ç®€æ´æ¨¡å¼** - åªæ˜¾ç¤ºå…³é”®çŠ¶æ€ä¿¡æ¯
- **è¯¦ç»†æ—¥å¿—å¼€å…³** - å¯æŒ‰éœ€å¯ç”¨è¯¦ç»†è°ƒè¯•ä¿¡æ¯
- **çŠ¶æ€æ‘˜è¦** - æ¸…æ™°æ˜¾ç¤ºå¯ç”¨æœåŠ¡å™¨å’Œé˜Ÿåˆ—æƒ…å†µ

## ğŸ“Š è´Ÿè½½å‡è¡¡ç®—æ³•

### æœåŠ¡å™¨é€‰æ‹©é€»è¾‘
```javascript
// 1. ç­›é€‰å¥åº·æœåŠ¡å™¨
const healthyServers = serverList.filter(s => s.healthy === true)

// 2. ä»…æŒ‰é˜Ÿåˆ—æ•°é‡æ’åºï¼ˆä¸è€ƒè™‘ä¼˜å…ˆçº§ï¼‰
const sortedServers = healthyServers.sort((a, b) => {
  // é€‰æ‹©é˜Ÿåˆ—æœ€å°‘çš„æœåŠ¡å™¨
  return a.queueInfo.total - b.queueInfo.total
})

// 3. é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨
return sortedServers[0].url
```

### é˜Ÿåˆ—ä¿¡æ¯è§£æ
```javascript
parseQueueInfo(data) {
  const running = Array.isArray(data.queue_running) ? data.queue_running.length : 0
  const pending = Array.isArray(data.queue_pending) ? data.queue_pending.length : 0

  return {
    running,   // æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡æ•°
    pending,   // ç­‰å¾…ä¸­çš„ä»»åŠ¡æ•°
    total: running + pending  // æ€»é˜Ÿåˆ—æ•°
  }
}
```

## ğŸ” å¥åº·æ£€æµ‹ä¼˜åŒ–

### ç®€åŒ–æ—¥å¿—æ¨¡å¼
- **é»˜è®¤å…³é—­è¯¦ç»†æ—¥å¿—** - å‡å°‘æ§åˆ¶å°å™ªéŸ³
- **å…³é”®ä¿¡æ¯çªå‡º** - åªæ˜¾ç¤ºæœåŠ¡å™¨å¯ç”¨æ€§å’Œé˜Ÿåˆ—çŠ¶æ€
- **çŠ¶æ€æ‘˜è¦æ˜¾ç¤º** - ä¸€ç›®äº†ç„¶çš„æ•´ä½“çŠ¶å†µ

### æ—¥å¿—è¾“å‡ºç¤ºä¾‹
```
ğŸ“Š åŠ è½½äº† 2 ä¸ªæœåŠ¡å™¨
âœ… æœåŠ¡å™¨çŠ¶æ€: 2/2 å¯ç”¨
  ğŸ“Š primary: é˜Ÿåˆ—: 1è¿è¡Œ/2ç­‰å¾…
  ğŸ“Š backup: é˜Ÿåˆ—: ç©ºé—²
ğŸ¯ é€‰æ‹©æœåŠ¡å™¨: https://backup-server.com (é˜Ÿåˆ—: 0)
```

## ğŸ§ª æµ‹è¯•å·¥å…·

### 1. é˜Ÿåˆ—è´Ÿè½½å‡è¡¡æµ‹è¯•é¡µé¢
**è®¿é—®åœ°å€**: `http://localhost:3002/test-queue-balancer.html`

**åŠŸèƒ½ç‰¹æ€§**:
- å¯è§†åŒ–æœåŠ¡å™¨çŠ¶æ€æ˜¾ç¤º
- å®æ—¶é˜Ÿåˆ—ä¿¡æ¯ç›‘æ§
- è´Ÿè½½å‡è¡¡æ•ˆæœæµ‹è¯•
- è¯¦ç»†æ—¥å¿—å¼€å…³æ§åˆ¶

### 2. æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯•
```javascript
// åŸºæœ¬åŠŸèƒ½æµ‹è¯•
testSimpleLoadBalancer()

// è´Ÿè½½å‡è¡¡æ•ˆæœæµ‹è¯•
testLoadBalancing(10)

// å¯ç”¨è¯¦ç»†æ—¥å¿—
loadBalancer.setVerboseLogging(true)
```

### 3. æ¨¡æ‹Ÿå¤šæ¬¡è¯·æ±‚æµ‹è¯•
```javascript
// æ¨¡æ‹Ÿ10æ¬¡è¯·æ±‚ï¼Œè§‚å¯Ÿè´Ÿè½½åˆ†é…
for (let i = 0; i < 10; i++) {
  const server = await loadBalancer.getOptimalServer()
  console.log(`ç¬¬${i+1}æ¬¡é€‰æ‹©: ${server}`)
}
```

## ğŸ“‹ é…ç½®æ›´æ–°

### 1. ComfyUIé…ç½®å¢å¼º
**æ–‡ä»¶**: `client/src/config/comfyui.config.js`

**æ–°å¢åŠŸèƒ½**:
- `parseQueueInfo()` - é˜Ÿåˆ—ä¿¡æ¯è§£æ
- `parseSystemInfo()` - ç³»ç»Ÿä¿¡æ¯è§£æ
- å“åº”éªŒè¯å¢å¼º

### 2. è´Ÿè½½å‡è¡¡å™¨é‡æ„
**æ–‡ä»¶**: `client/src/services/loadBalancer.js`

**ä¸»è¦æ”¹è¿›**:
- é˜Ÿåˆ—ä¿¡æ¯æ”¶é›†å’Œå­˜å‚¨
- åŸºäºé˜Ÿåˆ—çš„æœåŠ¡å™¨é€‰æ‹©ç®—æ³•
- ç®€åŒ–æ—¥å¿—è¾“å‡º
- è¯¦ç»†æ—¥å¿—å¼€å…³æ§åˆ¶

## ğŸ‰ ä½¿ç”¨æ•ˆæœ

### è´Ÿè½½å‡è¡¡æ•ˆæœ
- **æ™ºèƒ½åˆ†é…** - è‡ªåŠ¨é€‰æ‹©é˜Ÿåˆ—æœ€å°‘çš„æœåŠ¡å™¨
- **å…¬å¹³è°ƒåº¦** - ä¸è€ƒè™‘æœåŠ¡å™¨ç±»å‹ï¼Œçº¯ç²¹åŸºäºé˜Ÿåˆ—æ•°é‡é€‰æ‹©
- **å®æ—¶è°ƒæ•´** - æ ¹æ®é˜Ÿåˆ—å˜åŒ–åŠ¨æ€è°ƒæ•´é€‰æ‹©

### æ—¥å¿—è¾“å‡ºä¼˜åŒ–
- **ç®€æ´æ˜äº†** - é»˜è®¤åªæ˜¾ç¤ºå…³é”®ä¿¡æ¯
- **æŒ‰éœ€è¯¦ç»†** - å¯å¯ç”¨è¯¦ç»†æ—¥å¿—è¿›è¡Œè°ƒè¯•
- **çŠ¶æ€æ¸…æ™°** - æœåŠ¡å™¨çŠ¶æ€å’Œé˜Ÿåˆ—æƒ…å†µä¸€ç›®äº†ç„¶

### ç›‘æ§èƒ½åŠ›
- **å®æ—¶é˜Ÿåˆ—ç›‘æ§** - æŒç»­è·Ÿè¸ªæ¯ä¸ªæœåŠ¡å™¨çš„é˜Ÿåˆ—çŠ¶å†µ
- **å¥åº·çŠ¶æ€è·Ÿè¸ª** - è‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†æœåŠ¡å™¨æ•…éšœ
- **æ€§èƒ½æŒ‡æ ‡æ”¶é›†** - æ”¶é›†ç³»ç»Ÿä¿¡æ¯ç”¨äºç›‘æ§åˆ†æ

## ğŸ”„ å·¥ä½œæµç¨‹

1. **åˆå§‹åŒ–** - åŠ è½½æœåŠ¡å™¨åˆ—è¡¨ï¼Œå»ºç«‹è¿æ¥
2. **å¥åº·æ£€æµ‹** - å®šæœŸæ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€å’Œé˜Ÿåˆ—ä¿¡æ¯
3. **è´Ÿè½½å‡è¡¡** - æ ¹æ®é˜Ÿåˆ—æƒ…å†µé€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨
4. **çŠ¶æ€æ›´æ–°** - å®æ—¶æ›´æ–°æœåŠ¡å™¨çŠ¶æ€å’Œé˜Ÿåˆ—ä¿¡æ¯
5. **æ•…éšœå¤„ç†** - è‡ªåŠ¨åˆ‡æ¢åˆ°å¥åº·çš„å¤‡ç”¨æœåŠ¡å™¨

è¿™ä¸ªåŸºäºé˜Ÿåˆ—çš„è´Ÿè½½å‡è¡¡æœºåˆ¶ç¡®ä¿äº†ComfyUIä»»åŠ¡çš„é«˜æ•ˆåˆ†é…å’Œå¤„ç†ï¼Œæä¾›äº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿæ€§èƒ½ã€‚
