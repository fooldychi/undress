<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­‰çº§å¡ç®¡ç†ç³»ç»Ÿ - å®Œæ•´æ¼”ç¤º</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .cards-page {
            max-width: 1400px;
            margin: 0 auto;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .header-actions {
            display: flex;
            gap: 12px;
        }
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #303133;
            margin: 0;
        }
        .cards-table-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .no-action {
            color: #c0c4cc;
            font-size: 12px;
        }
        .cards-table {
            max-height: 400px;
            overflow-y: auto;
        }
        .result-summary {
            margin-bottom: 16px;
        }
        .dialog-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        .status-tag {
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="cards-page">
            <!-- é¡µé¢å¤´éƒ¨ -->
            <div class="page-header">
                <h1 class="page-title">ğŸ« ç­‰çº§å¡ç®¡ç†</h1>
                <div class="header-actions">
                    <el-button type="primary" @click="showBatchGenerateDialog">
                        <el-icon><Plus /></el-icon>
                        æ‰¹é‡ç”Ÿæˆç­‰çº§å¡
                    </el-button>
                </div>
            </div>

            <!-- ç­‰çº§å¡åˆ—è¡¨ -->
            <div class="cards-table-container">
                <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">ç­‰çº§å¡åˆ—è¡¨</h3>
                    <el-button @click="loadCards" :loading="loading">
                        <el-icon><Refresh /></el-icon>
                        åˆ·æ–°
                    </el-button>
                </div>

                <el-table :data="cardList" v-loading="loading" border style="width: 100%">
                    <el-table-column prop="card_number" label="å¡å·" width="180" />
                    <el-table-column label="ç±»å‹" width="120">
                        <template #default="{ row }">
                            <span>{{ row.icon }} {{ row.type_name }}</span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="total_points" label="æ€»ç§¯åˆ†" width="100" />
                    <el-table-column prop="remaining_points" label="å‰©ä½™ç§¯åˆ†" width="100" />
                    <el-table-column prop="price" label="ä»·æ ¼" width="100">
                        <template #default="{ row }">
                            Â¥{{ row.price }}
                        </template>
                    </el-table-column>
                    <el-table-column label="çŠ¶æ€" width="100">
                        <template #default="{ row }">
                            <el-tag
                                :type="row.bound_user_id ? 'success' : 'info'"
                                class="status-tag"
                            >
                                {{ row.bound_user_id ? 'å·²ç»‘å®š' : 'æœªç»‘å®š' }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="bound_username" label="ç»‘å®šç”¨æˆ·" width="120">
                        <template #default="{ row }">
                            {{ row.bound_username || '-' }}
                        </template>
                    </el-table-column>
                    <el-table-column prop="created_at" label="åˆ›å»ºæ—¶é—´" width="180">
                        <template #default="{ row }">
                            {{ formatDate(row.created_at) }}
                        </template>
                    </el-table-column>
                    <el-table-column label="æ“ä½œ" width="150" fixed="right">
                        <template #default="{ row }">
                            <el-button
                                type="text"
                                size="small"
                                @click="copyCardInfo(row)"
                            >
                                <el-icon><DocumentCopy /></el-icon>
                                å¤åˆ¶å¡å¯†
                            </el-button>
                            <el-button
                                v-if="row.bound_user_id"
                                type="text"
                                size="small"
                                @click="handleUnbind(row)"
                            >
                                è§£ç»‘
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>



            <!-- æ‰¹é‡ç”Ÿæˆç­‰çº§å¡å¼¹çª— -->
            <el-dialog
                v-model="batchGenerateDialogVisible"
                title="æ‰¹é‡ç”Ÿæˆç­‰çº§å¡"
                width="500px"
                :close-on-click-modal="false"
            >
                <el-form :model="batchGenerateForm" label-width="100px">
                    <el-form-item label="ç­‰çº§å¡ç±»å‹" required>
                        <el-select
                            v-model="batchGenerateForm.cardTypeId"
                            placeholder="è¯·é€‰æ‹©ç­‰çº§å¡ç±»å‹"
                            style="width: 100%"
                            :loading="cardTypesLoading"
                        >
                            <el-option
                                v-for="cardType in cardTypes"
                                :key="cardType.id"
                                :label="`${cardType.icon} ${cardType.name} (${cardType.points}ç§¯åˆ† - Â¥${cardType.price})`"
                                :value="cardType.id"
                            />
                        </el-select>
                    </el-form-item>
                    <el-form-item label="ç”Ÿæˆæ•°é‡" required>
                        <el-input-number
                            v-model="batchGenerateForm.count"
                            :min="1"
                            :max="100"
                            style="width: 100%"
                        />
                    </el-form-item>
                </el-form>
                <template #footer>
                    <el-button @click="batchGenerateDialogVisible = false">å–æ¶ˆ</el-button>
                    <el-button
                        type="primary"
                        @click="handleBatchGenerate"
                        :loading="batchGenerating"
                    >
                        ç”Ÿæˆ
                    </el-button>
                </template>
            </el-dialog>

            <!-- ç”Ÿæˆç»“æœå¼¹çª— -->
            <el-dialog
                v-model="resultDialogVisible"
                :title="resultDialogTitle"
                width="80%"
                :close-on-click-modal="false"
                class="result-dialog"
            >
                <div class="result-content">
                    <div class="result-summary">
                        <el-alert
                            :title="`æˆåŠŸç”Ÿæˆ ${generatedCards.length} å¼ ${selectedCardTypeName}ï¼`"
                            type="success"
                            :closable="false"
                            show-icon
                        />
                    </div>

                    <div class="cards-table">
                        <el-table :data="generatedCards" border style="width: 100%">
                            <el-table-column prop="cardNumber" label="å¡å·" width="200" />
                            <el-table-column prop="cardPassword" label="å¡å¯†" width="200" />
                            <el-table-column prop="typeName" label="ç±»å‹" width="120" />
                            <el-table-column prop="points" label="ç§¯åˆ†" width="100" />
                            <el-table-column prop="price" label="ä»·æ ¼" width="100">
                                <template #default="{ row }">
                                    Â¥{{ row.price }}
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>
                </div>

                <template #footer>
                    <div class="dialog-footer">
                        <el-button @click="resultDialogVisible = false">å…³é—­</el-button>
                        <el-button type="primary" @click="copyAllCards">
                            <el-icon><DocumentCopy /></el-icon>
                            ä¸€é”®å¤åˆ¶æ‰€æœ‰å¡å·å¡å¯†
                        </el-button>
                    </div>
                </template>
            </el-dialog>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            setup() {
                // å“åº”å¼æ•°æ®
                const loading = ref(false);
                const cardList = ref([]);
                const batchGenerateDialogVisible = ref(false);
                const cardTypes = ref([]);
                const cardTypesLoading = ref(false);
                const batchGenerating = ref(false);
                const resultDialogVisible = ref(false);
                const resultDialogTitle = ref('');
                const generatedCards = ref([]);
                const selectedCardTypeName = ref('');

                const batchGenerateForm = reactive({
                    cardTypeId: null,
                    count: 5
                });

                // æ¨¡æ‹Ÿæ•°æ®
                const mockCardList = [
                    {
                        id: 1,
                        card_number: 'DEMO001',
                        card_password: 'ABC123',
                        type_name: 'ä½“éªŒå¡',
                        icon: 'ğŸ',
                        total_points: 20,
                        remaining_points: 20,
                        price: 0.00,
                        bound_username: null,
                        bound_user_id: null,
                        bound_at: null,
                        created_at: new Date().toISOString()
                    },
                    {
                        id: 2,
                        card_number: 'DEMO002',
                        card_password: 'DEF456',
                        type_name: 'åŸºç¡€å¡',
                        icon: 'ğŸ¥‰',
                        total_points: 300,
                        remaining_points: 300,
                        price: 9.90,
                        bound_username: null,
                        bound_user_id: null,
                        bound_at: null,
                        created_at: new Date().toISOString()
                    },
                    {
                        id: 3,
                        card_number: 'DEMO003',
                        card_password: 'GHI789',
                        type_name: 'é«˜çº§å¡',
                        icon: 'ğŸ¥ˆ',
                        total_points: 1000,
                        remaining_points: 800,
                        price: 30.00,
                        bound_username: 'testuser',
                        bound_user_id: 1,
                        bound_at: new Date().toISOString(),
                        created_at: new Date().toISOString()
                    }
                ];

                const mockCardTypes = [
                    { id: 1, name: 'ä½“éªŒå¡', icon: 'ğŸ', points: 20, price: 0.00, description: 'å…è´¹ä½“éªŒå¡ï¼Œæ¯å¼ 20ç§¯åˆ†' },
                    { id: 2, name: 'åŸºç¡€å¡', icon: 'ğŸ¥‰', points: 300, price: 9.90, description: 'é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·' },
                    { id: 3, name: 'é«˜çº§å¡', icon: 'ğŸ¥ˆ', points: 1000, price: 30.00, description: 'é€‚åˆä¸­åº¦ä½¿ç”¨çš„ç”¨æˆ·' },
                    { id: 4, name: 'è‡³å°Šå¡', icon: 'ğŸ¥‡', points: 2000, price: 50.00, description: 'é€‚åˆé‡åº¦ä½¿ç”¨çš„ç”¨æˆ·' }
                ];

                // æ–¹æ³•
                const formatDate = (date) => {
                    if (!date) return '';
                    return new Date(date).toLocaleString();
                };

                const loadCards = async () => {
                    loading.value = true;
                    try {
                        // æ¨¡æ‹ŸAPIè°ƒç”¨
                        await new Promise(resolve => setTimeout(resolve, 500));
                        cardList.value = mockCardList;
                        ElMessage.success('ç­‰çº§å¡åˆ—è¡¨åŠ è½½æˆåŠŸ');
                    } catch (error) {
                        console.error('åŠ è½½ç­‰çº§å¡åˆ—è¡¨å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½ç­‰çº§å¡åˆ—è¡¨å¤±è´¥');
                    } finally {
                        loading.value = false;
                    }
                };

                // å¤åˆ¶å¡å·å¡å¯†
                const copyCardInfo = async (row) => {
                    try {
                        const copyText = `å¡å·: ${row.card_number}\nå¡å¯†: ${row.card_password}\nç±»å‹: ${row.type_name}\nç§¯åˆ†: ${row.remaining_points}/${row.total_points}\nä»·æ ¼: Â¥${row.price}`;

                        // ä½¿ç”¨ç°ä»£æµè§ˆå™¨çš„ Clipboard API
                        if (navigator.clipboard && window.isSecureContext) {
                            await navigator.clipboard.writeText(copyText);
                        } else {
                            // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿçš„ document.execCommand
                            const textArea = document.createElement('textarea');
                            textArea.value = copyText;
                            textArea.style.position = 'fixed';
                            textArea.style.left = '-999999px';
                            textArea.style.top = '-999999px';
                            document.body.appendChild(textArea);
                            textArea.focus();
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                        }

                        ElMessage.success('å¡å·å¡å¯†å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    } catch (error) {
                        console.error('å¤åˆ¶å¤±è´¥:', error);
                        ElMessage.error('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                    }
                };

                const showBatchGenerateDialog = async () => {
                    await loadCardTypes();
                    batchGenerateDialogVisible.value = true;
                };

                const loadCardTypes = async () => {
                    cardTypesLoading.value = true;
                    try {
                        // æ¨¡æ‹ŸAPIè°ƒç”¨
                        await new Promise(resolve => setTimeout(resolve, 300));
                        cardTypes.value = mockCardTypes;
                    } catch (error) {
                        console.error('åŠ è½½ç­‰çº§å¡ç±»å‹å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½ç­‰çº§å¡ç±»å‹å¤±è´¥');
                    } finally {
                        cardTypesLoading.value = false;
                    }
                };

                const handleBatchGenerate = async () => {
                    if (!batchGenerateForm.cardTypeId) {
                        ElMessage.warning('è¯·é€‰æ‹©ç­‰çº§å¡ç±»å‹');
                        return;
                    }

                    if (!batchGenerateForm.count || batchGenerateForm.count <= 0) {
                        ElMessage.warning('è¯·è¾“å…¥æœ‰æ•ˆçš„ç”Ÿæˆæ•°é‡');
                        return;
                    }

                    batchGenerating.value = true;
                    try {
                        // æ¨¡æ‹Ÿç”Ÿæˆç­‰çº§å¡
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        const selectedCardType = cardTypes.value.find(type => type.id === batchGenerateForm.cardTypeId);
                        selectedCardTypeName.value = selectedCardType?.name || 'ç­‰çº§å¡';

                        // ç”Ÿæˆæ¨¡æ‹Ÿå¡ç‰‡æ•°æ®
                        const cards = [];
                        for (let i = 1; i <= batchGenerateForm.count; i++) {
                            const cardNumber = `DEMO${Date.now().toString().slice(-6)}${i.toString().padStart(3, '0')}`;
                            const cardPassword = Math.random().toString(36).substring(2, 10).toUpperCase();

                            cards.push({
                                cardNumber,
                                cardPassword,
                                typeName: selectedCardType.name,
                                points: selectedCardType.points,
                                price: selectedCardType.price
                            });
                        }

                        generatedCards.value = cards;
                        resultDialogTitle.value = `ç”Ÿæˆç»“æœ - ${selectedCardTypeName.value}`;

                        batchGenerateDialogVisible.value = false;
                        resultDialogVisible.value = true;

                        ElMessage.success(`æˆåŠŸç”Ÿæˆ${batchGenerateForm.count}å¼ ${selectedCardTypeName.value}ï¼`);

                        // åˆ·æ–°åˆ—è¡¨
                        loadCards();
                    } catch (error) {
                        console.error('æ‰¹é‡ç”Ÿæˆç­‰çº§å¡å¤±è´¥:', error);
                        ElMessage.error('æ‰¹é‡ç”Ÿæˆç­‰çº§å¡å¤±è´¥');
                    } finally {
                        batchGenerating.value = false;
                    }
                };

                const copyAllCards = async () => {
                    if (generatedCards.value.length === 0) {
                        ElMessage.warning('æ²¡æœ‰å¯å¤åˆ¶çš„å¡ç‰‡ä¿¡æ¯');
                        return;
                    }

                    try {
                        let copyText = `${selectedCardTypeName.value} - å…±${generatedCards.value.length}å¼ \n\n`;
                        copyText += 'å¡å·\tå¡å¯†\tç±»å‹\tç§¯åˆ†\tä»·æ ¼\n';
                        copyText += '----------------------------------------\n';

                        generatedCards.value.forEach(card => {
                            copyText += `${card.cardNumber}\t${card.cardPassword}\t${card.typeName}\t${card.points}\tÂ¥${card.price}\n`;
                        });

                        copyText += '\nç”Ÿæˆæ—¶é—´: ' + new Date().toLocaleString();

                        await navigator.clipboard.writeText(copyText);
                        ElMessage.success('å¡å·å¡å¯†ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    } catch (error) {
                        console.error('å¤åˆ¶å¤±è´¥:', error);
                        ElMessage.error('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                    }
                };

                const handleUnbind = async (row) => {
                    try {
                        await ElMessageBox.confirm(
                            `ç¡®å®šè¦è§£ç»‘ç­‰çº§å¡ "${row.card_number}" å—ï¼Ÿ`,
                            'ç¡®è®¤æ“ä½œ',
                            {
                                confirmButtonText: 'ç¡®å®š',
                                cancelButtonText: 'å–æ¶ˆ',
                                type: 'warning'
                            }
                        );

                        // æ¨¡æ‹Ÿè§£ç»‘æ“ä½œ
                        await new Promise(resolve => setTimeout(resolve, 500));
                        ElMessage.success('ç­‰çº§å¡è§£ç»‘æˆåŠŸ');
                        loadCards();
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('è§£ç»‘ç­‰çº§å¡å¤±è´¥:', error);
                            ElMessage.error('è§£ç»‘ç­‰çº§å¡å¤±è´¥');
                        }
                    }
                };

                // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
                onMounted(() => {
                    loadCards();
                });

                return {
                    loading,
                    cardList,
                    batchGenerateDialogVisible,
                    cardTypes,
                    cardTypesLoading,
                    batchGenerating,
                    resultDialogVisible,
                    resultDialogTitle,
                    generatedCards,
                    selectedCardTypeName,
                    batchGenerateForm,
                    formatDate,
                    loadCards,
                    copyCardInfo,
                    showBatchGenerateDialog,
                    handleBatchGenerate,
                    copyAllCards,
                    handleUnbind
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
