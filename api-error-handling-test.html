<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIé”™è¯¯å¤„ç†ä¿®å¤æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .demo-container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .title {
            text-align: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
        }

        .test-section {
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            color: white;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .error-demo {
            background: rgba(255, 107, 107, 0.1);
            border: 2px solid rgba(255, 107, 107, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .fixed-demo {
            background: rgba(81, 207, 102, 0.1);
            border: 2px solid rgba(81, 207, 102, 0.3);
            border-radius: 12px;
            padding: 20px;
        }

        .error-stack {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #ff6b6b;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .code-block {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #e0e0e0;
            overflow-x: auto;
        }

        .explanation {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            margin-top: 15px;
        }

        .explanation li {
            margin-bottom: 8px;
        }

        .highlight {
            background: rgba(255, 255, 0, 0.2);
            padding: 2px 4px;
            border-radius: 4px;
        }

        .flow-diagram {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .flow-step {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 15px;
            margin: 5px;
            color: white;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .flow-arrow {
            color: rgba(255, 255, 255, 0.7);
            font-size: 18px;
            margin: 0 10px;
        }

        .error-type {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.4);
            border-radius: 6px;
            padding: 8px 12px;
            margin: 5px 0;
            color: #ff6b6b;
            font-weight: bold;
        }

        .solution-type {
            background: rgba(81, 207, 102, 0.2);
            border: 1px solid rgba(81, 207, 102, 0.4);
            border-radius: 6px;
            padding: 8px 12px;
            margin: 5px 0;
            color: #51cf66;
            font-weight: bold;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }

        .comparison-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }

        .status-before {
            color: #ff6b6b;
        }

        .status-after {
            color: #51cf66;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <h1 class="title">APIé”™è¯¯å¤„ç†ä¿®å¤æµ‹è¯•</h1>

        <!-- é”™è¯¯åˆ†æ -->
        <div class="test-section">
            <h2 class="section-title">ğŸ” é”™è¯¯åˆ†æ</h2>
            
            <div class="error-demo">
                <h3 style="color: #ff6b6b; margin-bottom: 10px;">åŸå§‹é”™è¯¯ä¿¡æ¯</h3>
                <div class="error-stack">levelCardPointsManager.js:164 æ¶ˆè€—ç§¯åˆ†å¤±è´¥: Error: è¯·æ±‚å¤±è´¥: æœåŠ¡å™¨è¿”å›éJSONå“åº”: 
    at makeBackendRequest (api.js:314:11)
    at async Object.consumePoints (api.js:457:24)
    at async LevelCardPointsManager.consumePoints (levelCardPointsManager.js:145:24)
    at async processUndressImage (comfyui.js:616:26)
    at async processImage (ClothesSwap.vue:58:20)</div>
            </div>

            <div class="explanation">
                <strong>é—®é¢˜ç‰¹å¾ï¼š</strong>
                <ul>
                    <li>ğŸš« <span class="highlight">å¶å°”å‘ç”Ÿ</span> - ä¸æ˜¯æ¯æ¬¡éƒ½å‡ºç°</li>
                    <li>ğŸš« <span class="highlight">æœåŠ¡å™¨å¤„ç†æˆåŠŸ</span> - åç«¯å®é™…å®Œæˆäº†å¤„ç†</li>
                    <li>ğŸš« <span class="highlight">å®¢æˆ·ç«¯æŠ¥é”™</span> - å‰ç«¯æ— æ³•è§£æå“åº”</li>
                    <li>ğŸš« <span class="highlight">éJSONå“åº”</span> - æœåŠ¡å™¨è¿”å›äº†HTMLæˆ–å…¶ä»–æ ¼å¼</li>
                </ul>
            </div>
        </div>

        <!-- é—®é¢˜æ ¹æº -->
        <div class="test-section">
            <h2 class="section-title">ğŸ¯ é—®é¢˜æ ¹æº</h2>
            
            <div class="flow-diagram">
                <div class="flow-step">å®¢æˆ·ç«¯å‘é€è¯·æ±‚</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-step">æœåŠ¡å™¨å¤„ç†</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-step error-type">è¿”å›éJSONå“åº”</div>
                <span class="flow-arrow">â†’</span>
                <div class="flow-step">å®¢æˆ·ç«¯è§£æå¤±è´¥</div>
            </div>

            <div class="explanation">
                <strong>å¯èƒ½çš„åŸå› ï¼š</strong>
                <ul>
                    <li>ğŸ” <span class="highlight">æœåŠ¡å™¨è´Ÿè½½é«˜</span> - è¿”å›HTMLé”™è¯¯é¡µé¢</li>
                    <li>ğŸ” <span class="highlight">ä»£ç†æœåŠ¡å™¨é—®é¢˜</span> - ä¸­é—´ä»¶è¿”å›éJSONå“åº”</li>
                    <li>ğŸ” <span class="highlight">æœåŠ¡å™¨é‡å¯</span> - ä¸´æ—¶ä¸å¯ç”¨æ—¶è¿”å›é»˜è®¤é¡µé¢</li>
                    <li>ğŸ” <span class="highlight">Content-Typeç¼ºå¤±</span> - å“åº”å¤´éƒ¨ä¿¡æ¯é”™è¯¯</li>
                    <li>ğŸ” <span class="highlight">ç½‘ç»œæ³¢åŠ¨</span> - è¯·æ±‚è¢«ä¸­æ–­æˆ–é‡å®šå‘</li>
                </ul>
            </div>
        </div>

        <!-- ä¿®å¤æ–¹æ¡ˆ -->
        <div class="test-section">
            <h2 class="section-title">âœ… ä¿®å¤æ–¹æ¡ˆ</h2>
            
            <div class="fixed-demo">
                <h3 style="color: #51cf66; margin-bottom: 10px;">æ”¹è¿›çš„é”™è¯¯å¤„ç†</h3>
                
                <div class="flow-diagram">
                    <div class="flow-step">æ£€æµ‹éJSONå“åº”</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step solution-type">è®°å½•è¯¦ç»†æ—¥å¿—</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step solution-type">è‡ªåŠ¨é‡è¯•æœºåˆ¶</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">å‹å¥½é”™è¯¯æç¤º</div>
                </div>
            </div>

            <div class="code-block">
// ä¿®å¤å‰çš„ä»£ç 
} else {
  const text = await response.text()
  throw new Error(`æœåŠ¡å™¨è¿”å›éJSONå“åº”: ${text}`)
}

// ä¿®å¤åçš„ä»£ç 
} else {
  const text = await response.text()
  console.error('æœåŠ¡å™¨è¿”å›éJSONå“åº”:', {
    url,
    status: response.status,
    contentType,
    responseText: text.substring(0, 500) // åªè®°å½•å‰500å­—ç¬¦
  })
  
  // å¦‚æœæ˜¯HTMLé”™è¯¯é¡µé¢æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œä¸”å¯ä»¥é‡è¯•ï¼Œåˆ™é‡è¯•
  if ((text.includes('&lt;html&gt;') || text.includes('&lt;!DOCTYPE') || 
       response.status >= 500) && retryCount < 2) {
    console.log(`æœåŠ¡å™¨è¿”å›éJSONå“åº”ï¼Œæ­£åœ¨é‡è¯•... (${retryCount + 1}/3)`)
    await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1)))
    return makeBackendRequest(endpoint, options, retryCount + 1)
  }
  
  throw new Error(`æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•`)
}
            </div>

            <div class="explanation">
                <strong>å…³é”®æ”¹è¿›ï¼š</strong>
                <ul>
                    <li>âœ… <span class="highlight">è¯¦ç»†æ—¥å¿—è®°å½•</span> - è®°å½•å“åº”çŠ¶æ€ã€å†…å®¹ç±»å‹ã€éƒ¨åˆ†å“åº”æ–‡æœ¬</li>
                    <li>âœ… <span class="highlight">æ™ºèƒ½é‡è¯•æœºåˆ¶</span> - æ£€æµ‹HTMLé”™è¯¯é¡µé¢å’Œ5xxé”™è¯¯è‡ªåŠ¨é‡è¯•</li>
                    <li>âœ… <span class="highlight">å‹å¥½é”™è¯¯ä¿¡æ¯</span> - å°†æŠ€æœ¯é”™è¯¯è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„æç¤º</li>
                    <li>âœ… <span class="highlight">é˜²æ­¢æ—¥å¿—æº¢å‡º</span> - åªè®°å½•å“åº”æ–‡æœ¬çš„å‰500å­—ç¬¦</li>
                </ul>
            </div>
        </div>

        <!-- ä¿®å¤å¯¹æ¯” -->
        <div class="test-section">
            <h2 class="section-title">ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”</h2>
            
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>æ–¹é¢</th>
                        <th>ä¿®å¤å‰</th>
                        <th>ä¿®å¤å</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>é”™è¯¯æ£€æµ‹</td>
                        <td class="status-before">âŒ ç®€å•æŠ›å‡ºé”™è¯¯</td>
                        <td class="status-after">âœ… è¯¦ç»†åˆ†æå“åº”ç±»å‹</td>
                    </tr>
                    <tr>
                        <td>æ—¥å¿—è®°å½•</td>
                        <td class="status-before">âŒ æ— è¯¦ç»†æ—¥å¿—</td>
                        <td class="status-after">âœ… è®°å½•URLã€çŠ¶æ€ã€å†…å®¹ç±»å‹</td>
                    </tr>
                    <tr>
                        <td>é‡è¯•æœºåˆ¶</td>
                        <td class="status-before">âŒ ä¸é‡è¯•éJSONå“åº”</td>
                        <td class="status-after">âœ… æ™ºèƒ½æ£€æµ‹å¹¶é‡è¯•</td>
                    </tr>
                    <tr>
                        <td>é”™è¯¯ä¿¡æ¯</td>
                        <td class="status-before">âŒ æŠ€æœ¯æ€§é”™è¯¯ä¿¡æ¯</td>
                        <td class="status-after">âœ… ç”¨æˆ·å‹å¥½çš„æç¤º</td>
                    </tr>
                    <tr>
                        <td>ç¨³å®šæ€§</td>
                        <td class="status-before">âŒ å¶å°”å¤±è´¥</td>
                        <td class="status-after">âœ… è‡ªåŠ¨æ¢å¤</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- é‡è¯•ç­–ç•¥ -->
        <div class="test-section">
            <h2 class="section-title">ğŸ”„ é‡è¯•ç­–ç•¥</h2>
            
            <div class="explanation">
                <strong>é‡è¯•æ¡ä»¶ï¼š</strong>
                <ul>
                    <li>ğŸ”„ <span class="highlight">HTMLé”™è¯¯é¡µé¢</span> - å“åº”åŒ…å« &lt;html&gt; æˆ– &lt;!DOCTYPE</li>
                    <li>ğŸ”„ <span class="highlight">æœåŠ¡å™¨é”™è¯¯</span> - HTTPçŠ¶æ€ç  >= 500</li>
                    <li>ğŸ”„ <span class="highlight">ç½‘ç»œé”™è¯¯</span> - Failed to fetch, NetworkErrorç­‰</li>
                    <li>ğŸ”„ <span class="highlight">æœ€å¤§é‡è¯•æ¬¡æ•°</span> - æœ€å¤šé‡è¯•2æ¬¡</li>
                    <li>ğŸ”„ <span class="highlight">é€’å¢å»¶è¿Ÿ</span> - 1ç§’ã€2ç§’ã€3ç§’çš„å»¶è¿Ÿ</li>
                </ul>
            </div>

            <div class="code-block">
// é‡è¯•é€»è¾‘
if ((error.message.includes('Failed to fetch') ||
     error.message.includes('NetworkError') ||
     error.message.includes('fetch') ||
     error.message.includes('è®¤è¯éªŒè¯å¤±è´¥') ||
     error.message.includes('æœåŠ¡å™¨è¿”å›éJSONå“åº”')) &&
     retryCount < 2) {
  console.log(`è¯·æ±‚å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•... (${retryCount + 1}/3)`, error.message)
  await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1)))
  return makeBackendRequest(endpoint, options, retryCount + 1)
}
            </div>
        </div>

        <!-- ç”¨æˆ·ä½“éªŒæ”¹è¿› -->
        <div class="test-section">
            <h2 class="section-title">ğŸ¯ ç”¨æˆ·ä½“éªŒæ”¹è¿›</h2>
            
            <div class="explanation">
                <strong>æ”¹è¿›æ•ˆæœï¼š</strong>
                <ul>
                    <li>ğŸ¯ <span class="highlight">è‡ªåŠ¨æ¢å¤</span> - å¤§éƒ¨åˆ†ä¸´æ—¶é”™è¯¯ä¼šè‡ªåŠ¨é‡è¯•æˆåŠŸ</li>
                    <li>ğŸ¯ <span class="highlight">å‹å¥½æç¤º</span> - "æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"</li>
                    <li>ğŸ¯ <span class="highlight">å‡å°‘å¤±è´¥ç‡</span> - é€šè¿‡é‡è¯•æœºåˆ¶æ˜¾è‘—é™ä½é”™è¯¯å‘ç”Ÿç‡</li>
                    <li>ğŸ¯ <span class="highlight">å¼€å‘è°ƒè¯•</span> - è¯¦ç»†æ—¥å¿—å¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜</li>
                    <li>ğŸ¯ <span class="highlight">ç³»ç»Ÿç¨³å®šæ€§</span> - æé«˜æ•´ä½“ç³»ç»Ÿçš„å®¹é”™èƒ½åŠ›</li>
                </ul>
            </div>
        </div>

        <!-- ç›‘æ§å»ºè®® -->
        <div class="test-section">
            <h2 class="section-title">ğŸ“ˆ ç›‘æ§å»ºè®®</h2>
            
            <div class="explanation">
                <strong>åç»­ç›‘æ§ï¼š</strong>
                <ul>
                    <li>ğŸ“ˆ <span class="highlight">é”™è¯¯é¢‘ç‡</span> - ç›‘æ§éJSONå“åº”é”™è¯¯çš„å‘ç”Ÿé¢‘ç‡</li>
                    <li>ğŸ“ˆ <span class="highlight">é‡è¯•æˆåŠŸç‡</span> - ç»Ÿè®¡é‡è¯•æœºåˆ¶çš„æˆåŠŸç‡</li>
                    <li>ğŸ“ˆ <span class="highlight">æœåŠ¡å™¨çŠ¶æ€</span> - ç›‘æ§æœåŠ¡å™¨è´Ÿè½½å’Œå“åº”æ—¶é—´</li>
                    <li>ğŸ“ˆ <span class="highlight">ç”¨æˆ·åé¦ˆ</span> - æ”¶é›†ç”¨æˆ·å¯¹é”™è¯¯å¤„ç†çš„åé¦ˆ</li>
                    <li>ğŸ“ˆ <span class="highlight">æ—¥å¿—åˆ†æ</span> - å®šæœŸåˆ†æé”™è¯¯æ—¥å¿—æ‰¾å‡ºæ¨¡å¼</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>
